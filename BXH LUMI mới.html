<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bảng Xếp Hạng Lumi</title>
    <meta http-equiv="refresh" content="3600">

    <link rel="icon" type="image/x-icon"
        href="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&amp;tableName=Kho%20%E1%BA%A3nh&amp;fileName=Kho%20%E1%BA%A3nh_Images%2Ff930e667.%E1%BA%A2nh.025539.jpg">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        /* --- 1. CSS GỐC (GIỮ NGUYÊN 100%) --- */
        :root {
            --bg-color: #f0f2f5; --card-bg: #ffffff; --text-primary: #333; --text-secondary: #666;
            --brand-color: #28a745;
            --sale-gradient: linear-gradient(90deg, #2E3192 0%, #1BFFFF 100%);
            --mkt-gradient: linear-gradient(90deg, #FDB931 0%, #F57F17 100%);
            --team-gradient: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            --gold: #FFD700; --gold-glow: rgba(255, 215, 0, 0.6);
            --silver: #C0C0C0; --bronze: #CD7F32;
        }
        html { overflow-x: hidden; font-size: 1.2vw; }
        body {
            font-family: 'Roboto', sans-serif; background-color: var(--bg-color); margin: 0; padding: 0.5vh 0;
            display: flex; flex-direction: column; align-items: stretch; min-height: 100vh; overflow: hidden;
        }
        .app-header { display: flex; justify-content: space-between; align-items: flex-start; padding: 0.5vh 1.5vw; margin-bottom: 0.5vh; }
        .lumi-logo { height: 6vh; width: auto; object-fit: contain; mix-blend-mode: multiply; filter: contrast(1.1); }
        .lumi-brand {
            font-family: 'Montserrat', sans-serif; font-weight: 900; font-size: 2.8vw;
            background: linear-gradient(to right, #11998e, #38ef7d); -webkit-background-clip: text; background-clip: text; color: transparent;
            margin: 0; line-height: 0.85;
        }
        .lumi-subtitle { font-size: 1vw; color: var(--text-secondary); font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; }
        .date-range-display { font-size: 0.9vw; color: #007bff; font-weight: 600; margin-top: 0.5vh; }
        
        .container { display: flex; gap: 1.5vw; padding: 0 1.5vw; flex-wrap: nowrap; align-items: stretch; flex: 1; overflow-y: hidden; }
        
        .board {
            flex: 1; background: var(--card-bg); border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            padding: 1vh 1.2vw; display: flex; flex-direction: column; position: relative; overflow: hidden;
        }
        .board::before {
            content: "LUMI"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-30deg);
            font-size: 8vw; font-weight: 900; color: rgba(0, 0, 0, 0.02); pointer-events: none; z-index: 0;
        }
        .board-header { text-align: center; margin-bottom: 0.8vh; text-transform: uppercase; border-bottom: 2px solid #eee; padding-bottom: 0.8vh; z-index: 1; }
        .board-header h2 { margin: 0; font-size: 1.2vw; color: #333; }
        .board.sale .board-header h2 { color: #007bff; }
        .board.mkt .board-header h2 { color: #ff6b6b; }
        
        .rank-list-container { flex: 1; display: flex; flex-direction: column; width: 100%; z-index: 1; overflow-y: auto; padding-right: 5px; }
        
        /* ITEM CƠ BẢN */
        .rank-item {
            display: flex; align-items: center; margin-bottom: 0.6vh; padding: 0.6vh 0.8vw; border-radius: 12px;
            background: #fff; transition: transform 0.3s; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.03); border: 1px solid transparent; width: 100%; box-sizing: border-box;
        }
        .rank-item.top-1 { border: 1px solid rgba(255, 215, 0, 0.3); background: linear-gradient(to right, #fffff0, #fff); }
        .rank-item.top-2 { border: 1px solid rgba(192, 192, 192, 0.3); background: linear-gradient(to right, #f8f9fa, #fff); }
        .rank-item.top-3 { border: 1px solid rgba(205, 127, 50, 0.3); background: linear-gradient(to right, #fff5ee, #fff); }
        
        .rank-pos { width: 2.5vw; font-weight: 900; font-size: 1.2vw; color: #ccc; text-align: center; margin-right: 0.8vw; flex-shrink: 0; }
        .rank-pos.rank-1 { color: var(--gold); font-size: 1.8vw; text-shadow: 0 0 10px var(--gold-glow); }
        .rank-pos.rank-2 { color: var(--silver); font-size: 1.6vw; }
        .rank-pos.rank-3 { color: var(--bronze); font-size: 1.4vw; }
        
        .user-info-group { display: flex; align-items: center; width: 8vw; flex-shrink: 0; }
        .avatar { width: 3vh; height: 3vh; border-radius: 50%; object-fit: cover; border: 0.15vh solid #fff; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15); margin-right: 0.6vw; position: relative; }
        .avatar-crown { position: absolute; top: -1.5vh; left: 1.5vw; color: var(--gold); font-size: 1.5vw; filter: drop-shadow(0 0 5px var(--gold-glow)); animation: bounce 2s infinite; z-index: 10; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        
        .info-text { flex: 1; overflow: hidden; }
        .name { font-weight: 800; font-size: 1.1vw; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; }
        
        .bar-container { flex: 1; background-color: #f1f3f5; border-radius: 12px; height: 2.2vh; position: relative; overflow: hidden; display: flex; align-items: center; }
        .bar-fill { height: 100%; border-radius: 12px; display: flex; align-items: center; justify-content: flex-end; padding-right: 0.6vw; font-weight: 900; font-size: 0.9vw; color: #fff; width: 0%; transition: width 1.5s cubic-bezier(0.22, 1, 0.36, 1); white-space: nowrap; box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1); }
        .board.sale .bar-fill { background: var(--sale-gradient); }
        .board.mkt .bar-fill { background: var(--mkt-gradient); color: #fff; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2); }
        
        /* --- STYLE TOP 3 (CLASS CŨ) --- */
        .rank-item.week-size { padding: 2.2vh 2.5vw; margin-bottom: 2vh; }
        .rank-item.week-size .rank-pos { width: 4vw; font-size: 2vw; }
        .rank-item.week-size .rank-pos.rank-1 { font-size: 3.2vw; }
        .rank-item.week-size .avatar { width: 7vh; height: 7vh; margin-right: 2vw; }
        .rank-item.week-size .name { font-size: 2vw; }
        .rank-item.week-size .bar-container { height: 4vh; }
        .rank-item.week-size .bar-fill { font-size: 1.4vw; color: #000 !important; font-weight: 900; }
        .rank-item.week-size .avatar-crown { font-size: 2vw; top: -2vh; left: 2vw; }
        .rank-item.week-size .user-info-group { width: 16vw; }

        /* --- 2. CSS THÊM CHO TÍNH NĂNG MỚI --- */
        .scene { display: none; width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; background: var(--bg-color); flex-direction: column; animation: fadeIn 0.5s ease; padding-bottom: 80px; overflow: hidden; }
        .scene.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Danger Board Styles */
        .board.danger .board-header h2 { color: #c0392b; }
        .board.danger .board-header { border-bottom-color: #ffcccc; }
        .board.danger .bar-fill { background: linear-gradient(90deg, #ff9966, #ff5e62); }
        .blink-danger { animation: blinkRed 1.5s infinite; color: #ff0000; font-weight: bold; }
        @keyframes blinkRed { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* Slideshow Styles */
        .slide-wrapper { flex: 1; display: flex; justify-content: center; align-items: center; }
        .slide-card { background: #fff; border-radius: 30px; padding: 3vw; width: 60%; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.15); border: 4px solid var(--gold); position: relative; }
        .slide-avatar { width: 15vw; height: 15vw; border-radius: 50%; object-fit: cover; border: 6px solid var(--gold); margin-bottom: 2vh; }
        .slide-name { font-size: 3vw; font-weight: 900; color: #333; margin-bottom: 0.5vh; }
        .slide-role { font-size: 1.5vw; color: #666; font-weight: 700; text-transform: uppercase; margin-bottom: 3vh; letter-spacing: 2px; }
        .slide-metrics { display: flex; justify-content: center; gap: 3vw; }
        .metric-box { background: #f8f9fa; padding: 1.5vh 2vw; border-radius: 15px; min-width: 12vw; }
        .metric-val { font-size: 2.5vw; font-weight: 900; color: var(--brand-color); }
        .metric-label { font-size: 1vw; text-transform: uppercase; color: #888; font-weight: 600; margin-top: 0.5vh; }

        /* Navbar */
        .nav-bar { position: fixed; bottom: 2vh; left: 50%; transform: translateX(-50%); background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding: 1vh 2vw; border-radius: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); display: flex; gap: 1vw; z-index: 9999; border: 1px solid rgba(0,0,0,0.1); }
        .nav-btn { border: none; background: transparent; padding: 1vh 1.5vw; border-radius: 25px; cursor: pointer; font-family: 'Roboto', sans-serif; font-weight: 700; font-size: 0.9vw; color: #555; transition: all 0.3s ease; display: flex; align-items: center; gap: 0.5vw; }
        .nav-btn:hover { background: rgba(0,0,0,0.05); transform: translateY(-2px); }
        .nav-btn.active { background: var(--team-gradient); color: #fff; box-shadow: 0 4px 15px rgba(118, 75, 162, 0.4); }
        .nav-btn[data-target="scene-warning"].active { background: linear-gradient(90deg, #ff9966, #ff5e62); }
        .play-status { font-size: 0.8vw; font-weight: bold; padding: 0.5vh 1vw; border-radius: 5px; display: flex; align-items: center; }
        .status-playing { color: #28a745; background: #e6f9e9; }
        .status-paused { color: #dc3545; background: #ffe6e6; }
    </style>
</head>

<body>

    <!-- SCENE 1: CẢNH BÁO -->
    <div id="scene-warning" class="scene">
        <div class="app-header">
            <div style="display: flex; align-items: center; gap: 1vw;">
                <img src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&amp;tableName=Kho%20%E1%BA%A3nh&amp;fileName=Kho%20%E1%BA%A3nh_Images%2Ff930e667.%E1%BA%A2nh.025539.jpg" class="lumi-logo">
                <h1 class="lumi-brand" style="background: none; -webkit-text-fill-color: #c0392b; color: #c0392b;">CẢNH BÁO</h1>
            </div>
            <div class="lumi-subtitle blink-danger" style="color: #c0392b;">HIỆU SUẤT THẤP</div>
        </div>
        <div class="container">
            <div class="board danger">
                <div class="board-header"><h2>SALE (CHỐT < 5%)</h2></div>
                <div id="list-warn-sale" class="rank-list-container"></div>
            </div>
            <div class="board danger">
                <div class="board-header"><h2>MKT (ADS > 35%)</h2></div>
                <div id="list-warn-mkt" class="rank-list-container"></div>
            </div>
        </div>
    </div>

    <!-- SCENE 2: DASHBOARD (TOP 3 TO + LIST NHỎ) -->
    <div id="scene-dashboard" class="scene active">
        <div class="app-header">
            <div style="display: flex; align-items: center; gap: 1vw;">
                <img src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&amp;tableName=Kho%20%E1%BA%A3nh&amp;fileName=Kho%20%E1%BA%A3nh_Images%2Ff930e667.%E1%BA%A2nh.025539.jpg" class="lumi-logo">
                <div>
                    <h1 class="lumi-brand">LUMI</h1>
                    <div class="lumi-subtitle">Bảng Vinh Danh Tuần</div>
                </div>
            </div>
            <div id="dashboard-date" class="date-range-display"></div>
        </div>
        <div class="container">
            <div class="board sale">
                <div class="board-header"><h2><i class="fa-solid fa-chart-line"></i> DOANH SỐ - SALE</h2></div>
                <div id="list-dashboard-sale" class="rank-list-container"></div>
            </div>
            <div class="board mkt">
                <div class="board-header"><h2><i class="fa-solid fa-bullhorn"></i> DOANH SỐ - MKT</h2></div>
                <div id="list-dashboard-mkt" class="rank-list-container"></div>
            </div>
        </div>
    </div>

    <!-- SCENE 3: VINH DANH (Slideshow) -->
    <div id="scene-honors" class="scene">
        <div class="app-header">
            <h1 class="lumi-brand" style="flex:1; text-align:center;">VINH DANH XUẤT SẮC</h1>
        </div>
        <div class="slide-wrapper">
            <div class="slide-card">
                <img id="slide-avatar" src="" class="slide-avatar">
                <div id="slide-name" class="slide-name">Tên Nhân Viên</div>
                <div id="slide-role" class="slide-role">TOP 1 SALE</div>
                <div class="slide-metrics">
                    <div class="metric-box">
                        <div id="slide-val1" class="metric-val">0</div>
                        <div class="metric-label">Doanh Số</div>
                    </div>
                    <div class="metric-box">
                        <div id="slide-val2" class="metric-val" style="color: #007bff;">0%</div>
                        <div id="slide-lbl2" class="metric-label">Hiệu Suất</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SCENE 4: TOÀN TEAM -->
    <div id="scene-fullteam" class="scene">
        <div class="app-header">
            <h1 class="lumi-brand">BẢNG XẾP HẠNG TOÀN TEAM</h1>
        </div>
        <div class="container">
            <div class="board sale">
                <div class="board-header"><h2>TEAM SALE</h2></div>
                <div id="full-list-sale" class="rank-list-container"></div>
            </div>
            <div class="board mkt">
                <div class="board-header"><h2>TEAM MKT</h2></div>
                <div id="full-list-mkt" class="rank-list-container"></div>
            </div>
        </div>
    </div>

    <!-- NAVBAR -->
    <div class="nav-bar">
        <button class="nav-btn" data-target="scene-warning" onclick="manualSwitch('scene-warning')"><i class="fa-solid fa-triangle-exclamation"></i> Cảnh Báo</button>
        <button class="nav-btn active" data-target="scene-dashboard" onclick="manualSwitch('scene-dashboard')"><i class="fa-solid fa-trophy"></i> Top 3</button>
        <button class="nav-btn" data-target="scene-honors" onclick="manualSwitch('scene-honors')"><i class="fa-solid fa-crown"></i> Vinh Danh</button>
        <button class="nav-btn" data-target="scene-fullteam" onclick="manualSwitch('scene-fullteam')"><i class="fa-solid fa-users"></i> Toàn Team</button>
        <div style="width:1px; background:#ccc; margin:0 5px;"></div>
        <button class="nav-btn" onclick="toggleAutoPlay()">
            <div id="play-status-icon"><i class="fa-solid fa-pause"></i></div>
            <div id="play-status-text" class="status-playing play-status">ĐANG CHẠY</div>
        </button>
    </div>

    <script>
        // CONFIG
        const API = {
            F3: 'https://n-api-gamma.vercel.app/sheet/F3/data',
            R_SALE: 'https://n-api-gamma.vercel.app/report/generate?tableName=Báo cáo sale',
            R_MKT: 'https://n-api-gamma.vercel.app/report/generate?tableName=Báo cáo MKT',
            HR: 'https://lumi-6dff7-default-rtdb.asia-southeast1.firebasedatabase.app/datasheet/Nh%C3%A2ns%E1%BB%B1.json'
        };
        const TIMES = { warning: 10*60*1000, dashboard: 30*60*1000, honors: 15*60*1000, fullteam: 10*60*1000 };
        const SLIDE_SPEED = 30000;

        const AVATAR_DATA = {
            'Nguyễn Trần Thành Đạt': 'https://drive.google.com/thumbnail?id=1fzxkLW-U6tBrsoeVomSVko8rKHo3WlVc&sz=w800',
            'Trần Văn Tiến': 'https://drive.google.com/thumbnail?id=1iQAphZYehYbD72NWHgD9d4KX5xUcjSx1&sz=w800',
            'Hoàng Tuấn Cường': 'https://drive.google.com/thumbnail?id=1liZeqnJvvsrA_ChdfbjmMJUgqj2DIOLg&sz=w800',
            'Mạnh Cường': 'https://drive.google.com/thumbnail?id=1_nkhhVlm4KOuUA6aoKNAj4mE5MbF-x1d&sz=w800',
            'Đỗ Mạnh Cường': 'https://drive.google.com/thumbnail?id=1_nkhhVlm4KOuUA6aoKNAj4mE5MbF-x1d&sz=w800',
            'Nguyễn Thị Hiếu': 'https://drive.google.com/thumbnail?id=1GmH2VP-DMIhvTm-TG65WlYyXrbS8ygwD&sz=w800',
            'Vũ Viết Anh': 'https://drive.google.com/thumbnail?id=191tir-VO8tOm56eLFBLlYrqD8--P-feY&sz=w800',
            'Lục Trần Minh Trí': 'https://drive.google.com/thumbnail?id=1sKhy1W92Eet7dDNu-HzYiRsGsy0AU7Tm&sz=w800',
            'Nguyễn Hiền Lương': 'https://drive.google.com/thumbnail?id=1TOwTb8o4rAqtKPZmI_Y-8szk1vqwsfK-&sz=w800',
            'Trần Huy Hùng': 'https://drive.google.com/thumbnail?id=1o-Xp4KBa76vsrOqcA9BLL7iTM852w_l_&sz=w800',
            'Phạm Tiến Thành': 'https://drive.google.com/thumbnail?id=1wELVha3c9zpqrauTItzr8Qp0trfhN2TP&sz=w800',
            'Trần Quốc Khải': 'https://drive.google.com/thumbnail?id=1z21zunKRZRO5ffw6KfLXWNTu0LhS_YOX&sz=w800',
            'Nguyễn Thị Thủy Tiên': 'https://drive.google.com/thumbnail?id=1xMEP5-HfCBUEIVu8GSTg3S_x8RRuBQoY&sz=w800',
            'Đoàn Thị Kim Oanh': 'https://drive.google.com/thumbnail?id=1hdAmisoQwBdVMhDXh2ewNw8XXSp5gVLm&sz=w800',
            'Đinh Văn Khải': 'https://drive.google.com/thumbnail?id=18ezyaCwzGOeR-mZSa78QETJuHaYtXulS&sz=w800',
            'Lê Trung Hiếu': 'https://drive.google.com/thumbnail?id=10TE6KIyEcEpBLov_svb_Orn7OYCh_90G&sz=w800',
            'Nguyễn Quang Trường': 'https://drive.google.com/thumbnail?id=1W56nfGDCqbk_XVCLYg1N20_pFkBzcspO&sz=w800',
            'Phạm Tuyết Trinh': 'https://drive.google.com/thumbnail?id=1EnzOdwHdoO4qD9-6eYQjr6gLR-e9qNKo&sz=w800',
            'Trần Thị Ngọc Ánh': 'https://drive.google.com/thumbnail?id=1ah5FMqd1ucXenzgUvdUguOoVMfB_ZE0p&sz=w800',
            'Nguyễn Thị Thảo': 'https://drive.google.com/thumbnail?id=1rJbWkI_PRup9ZzskLq_Iq3zaurpgRp_x&sz=w800',
            'Đặng Thị Nga': 'https://drive.google.com/thumbnail?id=1gPoBL2d8WgsqrZ32vmrHWHdCNAkGx4u_&sz=w800',
            'Phạm Thị Yến': 'https://drive.google.com/thumbnail?id=1qBR5clqVzQbUPgwRudH8BSoPRl04bykF&sz=w800',
            'Phạm Thị Lệ': 'https://drive.google.com/thumbnail?id=1fLAdtsgJqYBn65P3Qc0ShPyix6klzaQN&sz=w800',
            'Nguyễn Mỹ Duyên': 'https://drive.google.com/thumbnail?id=10rC1xNt-Nvns1Xxel7IWquki9y9VaseO&sz=w800',
            'Dương Đức Mạnh': 'https://drive.google.com/thumbnail?id=1gIfuSEwGvGsb4o_HktaHupYGjJjVRqjb&sz=w800',
            'Trần Thị Hồng Nhung': 'https://drive.google.com/thumbnail?id=14hVANI_MT2w0DI3xNMCaht8s5E5FBXaK&sz=w800',
            'Phạm Văn Đạt': 'https://drive.google.com/thumbnail?id=1OpIuH43ybVBeb7HhrVvQQ9_h-NqU8gYg&sz=w800',
            'Nguyễn Anh Điệp': 'https://drive.google.com/thumbnail?id=1Y09ORLQEBIQN-Sad_qZhEV4kPc2VUA-U&sz=w800',
            'Nguyễn Tiến Mạnh': 'https://drive.google.com/thumbnail?id=1zudVOf4mQk4z1iuWyXWVKlzFyZQvxWSZ&sz=w800',
            'Giang Kiều Duyên': 'https://drive.google.com/thumbnail?id=1i0g02w_pv-Liz2MiqaeDzXyNIMfGXjET&sz=w800',
            'Hoàng Thị Uyên': 'https://drive.google.com/thumbnail?id=1Nz__Y9UsL_dDVD_lInd5_85-vk9VIBlo&sz=w800',
            'Phạm Thị Huyền Trang': 'https://drive.google.com/thumbnail?id=1LCDJyhTr-G_kEabC9vZcL-DqN1a7UlwS&sz=w800',
            'Nguyễn Mạnh Tú': 'https://drive.google.com/thumbnail?id=1NahrdJp2wQ2I-OW2CUCViKeqhXuk24Vm&sz=w800',
            'Phan Thu Hương': 'https://drive.google.com/thumbnail?id=1Hyo_yN8Np_lTbzwpb6LzUAWkvdhIjP-t&sz=w800',
            'Trần Uy Vũ': 'https://drive.google.com/thumbnail?id=1tInrkQELxm0Jca-dJsEXstHF0i6DNlMl&sz=w800',
            'Nguyễn Thị Ánh Nguyệt': 'https://drive.google.com/thumbnail?id=1zFyLEdL5SeE74bbfsJ1Wt8AbtH1qSAhQ&sz=w800',
            'Nguyễn Thị Ánh Nguyệt 1': 'https://drive.google.com/thumbnail?id=1zFyLEdL5SeE74bbfsJ1Wt8AbtH1qSAhQ&sz=w800',
            'Bùi Thị Hảo': 'https://drive.google.com/thumbnail?id=1jq8j2GvGaXsQFjnvUoIF9ACUl6t1jg_k&sz=w800',
            'Trần Bùi Lan Phương': 'https://drive.google.com/thumbnail?id=1ZzJ6qPS5kC6bP_kc-gyDJJbChwmoCpgR&sz=w800',
            'Văn Thị Anh': 'https://drive.google.com/thumbnail?id=1uugGRR4u9A12sLwSf4Kp9HQqSnpZObgc&sz=w800',
            'Nguyễn Thị Mỹ Hạnh': 'https://drive.google.com/thumbnail?id=146xx9zPBe_4JNx-AGYcDM68mEQCEi3EP&sz=w800',
            'Đỗ Thị Thanh Huệ': 'https://drive.google.com/thumbnail?id=1rGY7ZjnFZvkcXc-lR5vEJspu6YTCMjol&sz=w800',
            'Nguyễn Thị Thu': 'https://drive.google.com/thumbnail?id=1pkhZ__YRel6C6IEwK29YvNuR39LnQxfj&sz=w800',
            'Đồng Tố Dũng': 'https://drive.google.com/thumbnail?id=1vzshZNQFVZEe8HYJRFZ5oxx6JP9QIdYY&sz=w800',
            'Nguyễn Đức Huy': 'https://drive.google.com/thumbnail?id=1CoWTsxTzfZEp2yLpnuaMAjthdSKV8Y_f&sz=w800',
            'Nguyễn Thị Ngọc Ánh': 'https://drive.google.com/thumbnail?id=1hQ7s_Xg7LZmc_b7BhplrD5I_pMOZjPi1&sz=w800',
            'Đặng Thị Hoa': 'https://drive.google.com/thumbnail?id=1T3kCVcmZ4eoBDraFuv_ucXcRRILOUFV1&sz=w800',
            'Lê Thị Thuý': 'https://drive.google.com/thumbnail?id=1oBCubueLuQOnRa912bd0eQanmmcphux0&sz=w800',
            'Nguyễn Thị Hường': 'https://drive.google.com/thumbnail?id=1gP-HI-V-ig24pDx4n-9ZmhbFdBfI1js4&sz=w800',
            'Mai Thị Lý': 'https://drive.google.com/thumbnail?id=1k_eyFAFWs-5v1aYVLpnegprvJjvYiOYc&sz=w800',
            'Trần Thị Nhung': 'https://drive.google.com/thumbnail?id=1_QfAXZ-ZU7oChppYWiDoRaRxJqwCSr-6&sz=w800',
            'Hoàng Thị Hương Giang': 'https://drive.google.com/thumbnail?id=1YF8Jv_bT5fYY3qV89_EPxKwoKCWYBxUN&sz=w800',
            'Phạm Thị Phương Thảo': 'https://drive.google.com/thumbnail?id=1-3zQ-hLkiWB4LeVKMdZCasEsl8xFuwC_&sz=w800',
            'Đỗ Thị Thu Hằng': 'https://drive.google.com/thumbnail?id=137slyKEqqFZ_ErySbms6CaTIoMCwOzce&sz=w800',
            'Đỗ Thị Thu Uyên': 'https://drive.google.com/thumbnail?id=1Y4VJQlxgBORhVzz8PbPE7wKzew2E5xR9&sz=w800',
            'Nguyễn Văn Tuấn': 'https://drive.google.com/thumbnail?id=1bKhgPV1FTYg0PJZUS3T7087s3H7LSQMG&sz=w800'
        };
        const AVATAR_MAP = new Map(); Object.keys(AVATAR_DATA).forEach(k => AVATAR_MAP.set(normalizeName(k), AVATAR_DATA[k]));

        // UTILS
        function normalizeName(name) { return name ? name.toString().trim().replace(/\s+/g, ' ').toLowerCase() : ''; }
        function abbreviateName(n) { if(!n)return""; const p=n.trim().split(/\s+/); if(p.length===1)return p[0]; return `${p[p.length-1]}-${p.slice(0,p.length-1).map(x=>x.charAt(0).toUpperCase()).join('')}`; }
        function fmtMoney(n) { return n>=1e6 ? (n/1e6).toFixed(1)+' Tr' : n.toLocaleString(); }
        function convertDriveLink(l) { if(!l)return l; let id=l.match(/id=([a-zA-Z0-9_-]+)/)?.[1]||l.match(/\/file\/d\/([a-zA-Z0-9_-]+)/)?.[1]; return id?`https://drive.google.com/thumbnail?id=${id}&sz=w800`:l; }
        function getAvatar(n, hr) {
            if(!n) return 'https://i.pravatar.cc/150?img=1'; const nm = normalizeName(n);
            if(AVATAR_MAP.has(nm)) return AVATAR_MAP.get(nm);
            if(nm.includes('mạnh ca đêm')) return 'https://lumi-6dff7-default-rtdb.asia-southeast1.firebasedatabase.app/datasheet/Nhân_sự/ManhCaDem.jpg';
            if(hr) { const h = hr.find(x => normalizeName(x['Họ Và Tên']||x['Tên']||'')===nm); if(h){ let l=h['Link ảnh']||h['Avatar']||h['Ảnh']; if(l) return convertDriveLink(l); } }
            let h=0; for(let i=0;i<n.length;i++) h=n.charCodeAt(i)+((h<<5)-h); return `https://i.pravatar.cc/150?img=${Math.abs(h%70)}`;
        }
        function getMonday(d) { d=new Date(d); const day=d.getDay(), diff=d.getDate()-day+(day==0?-6:1); const m=new Date(d.setDate(diff)); m.setHours(0,0,0,0); return m; }

        let data = { sale: [], mkt: [], warnSale: [], warnMkt: [], honors: [] };
        let isAutoPlay = true, slideInterval = null, cycleTimeout = null;

        async function init() { await loadData(); startAutoCycle(); }

        async function loadData() {
            try {
                const [f3, rs, rm, hr] = await Promise.all([
                    fetch(API.F3).then(r=>r.json()).catch(()=>({data:[]})),
                    fetch(API.R_SALE).then(r=>r.json()).catch(()=>([])),
                    fetch(API.R_MKT).then(r=>r.json()).catch(()=>([])),
                    fetch(API.HR).then(r=>r.json()).catch(()=>({}))
                ]);
                const rawHr = Array.isArray(hr)?hr:Object.values(hr);
                const rawSaleRep = Array.isArray(rs)?rs:(rs.data||[]);
                const rawMktRep = Array.isArray(rm)?rm:(rm.data||[]);
                const today = new Date(); const start = getMonday(today); const end = new Date(start); end.setDate(end.getDate()+6); end.setHours(23,59,59);
                document.getElementById('dashboard-date').innerText = `${start.getDate()}/${start.getMonth()+1} - ${end.getDate()}/${end.getMonth()+1}`;

                let sMap = {}, mMap = {};
                (Array.isArray(f3.data)?f3.data:(f3||[])).forEach(o => {
                    const dStr = o["Ngày lên đơn"]||o["Date"]; if(!dStr) return;
                    const p = dStr.split('/'); const d = p.length===3?new Date(p[2],p[1]-1,p[0]):new Date(dStr);
                    if(d<start||d>end) return;
                    const money = parseInt(String(o["Tổng tiền VNĐ"]||0).replace(/\D/g,''))||0;
                    const sn=(o["Nhân viên Sale"]||"").trim(), mn=(o["Nhân viên Marketing"]||"").trim();
                    if(sn) sMap[sn]=(sMap[sn]||0)+money;
                    if(mn) mMap[mn]=(mMap[mn]||0)+money;
                });

                const isValid = n => !n.toLowerCase().includes('page') && !n.toLowerCase().includes('mcn') && !n.toLowerCase().includes('lumi');

                data.sale = Object.keys(sMap).map(n => {
                    const mess = rawSaleRep.filter(r=>normalizeName(r["Tên"])===normalizeName(n)).reduce((s,r)=>s+Number(r["Số Mess"]||0),0);
                    const ordersCount = (Array.isArray(f3.data)?f3.data:(f3||[])).filter(o => {
                        const dStr = o["Ngày lên đơn"] || o["Date"]; if(!dStr) return false;
                        const p = dStr.split('/'); const d = p.length===3?new Date(p[2],p[1]-1,p[0]):new Date(dStr);
                        return d>=start && d<=end && (o["Nhân viên Sale"]||"").trim()===n;
                    }).length;
                    const rate = mess>0?(ordersCount/mess*100):0;
                    return { name:n, rev:sMap[n], mess, rate, rateStr:rate.toFixed(1)+'%', avatar:getAvatar(n,rawHr) };
                }).filter(i=>isValid(i.name)).sort((a,b)=>b.rev-a.rev);

                data.mkt = Object.keys(mMap).map(n => {
                    const cost = rawMktRep.filter(r=>normalizeName(r["Tên"])===normalizeName(n)).reduce((s,r)=>s+parseInt(String(r["CPQC"]||r["ADS"]||0).replace(/\D/g,'')||0),0);
                    const rate = mMap[n]>0?(cost/mMap[n]*100):0;
                    return { name:n, rev:mMap[n], cost, rate, rateStr:rate.toFixed(1)+'%', avatar:getAvatar(n,rawHr) };
                }).filter(i=>isValid(i.name)).sort((a,b)=>b.rev-a.rev);

                const maxS = data.sale.length?data.sale[0].rev:1; data.sale.forEach(i=>i.percent=(i.rev/maxS*100));
                const maxM = data.mkt.length?data.mkt[0].rev:1; data.mkt.forEach(i=>i.percent=(i.rev/maxM*100));

                data.warnSale = data.sale.filter(i=>i.rate<5 && i.mess>10);
                data.warnMkt = data.mkt.filter(i=>i.rate>35 && i.rev>0);
                data.honors = [ ...data.sale.slice(0,3).map((i,x)=>({...i,role:`TOP ${x+1} SALE`})), ...data.mkt.slice(0,3).map((i,x)=>({...i,role:`TOP ${x+1} MKT`})) ];

                renderAll();
            } catch(e) { console.error(e); }
        }

        function renderAll() {
            // HÀM RENDER ITEM THÔNG MINH (CHIA 2 LOẠI: TO và NHỎ)
            const renderDashboardItem = (i, idx, type) => {
                const rank = idx + 1;
                const isTop3 = rank <= 3;

                if (isTop3) {
                    // --- CẤU TRÚC HTML CODE GỐC CHO TOP 3 ---
                    return `
                    <div class="rank-item top-${rank} week-size">
                        <div class="rank-pos rank-${rank}">#${rank}</div>
                        <div class="user-info-group">
                            <div style="position:relative;">
                                ${rank===1 ? '<i class="fa-solid fa-crown avatar-crown"></i>' : ''}
                                <img src="${i.avatar}" class="avatar">
                            </div>
                            <div class="info-text">
                                <div class="name">${abbreviateName(i.name)}</div>
                                <!-- Thêm chỉ số phụ nhỏ bên dưới tên để dễ theo dõi (không ảnh hưởng layout cũ) -->
                                <div style="font-size:0.7vw; color:#666;">
                                    ${type === 'sale' ? `Mess: ${i.mess} | Chốt: ${i.rateStr}` : `CP: ${fmtMoney(i.cost)} | Ads: ${i.rateStr}`}
                                </div>
                            </div>
                        </div>
                        <div class="bar-container">
                            <div class="bar-fill" style="width:${i.percent}%">${fmtMoney(i.rev)}</div>
                        </div>
                    </div>`;
                } else {
                    // --- CẤU TRÚC NHỎ CHO RANK 4+ ---
                    return `
                    <div class="rank-item">
                        <div class="rank-pos">#${rank}</div>
                        <img src="${i.avatar}" class="avatar">
                        <div class="info-text">
                            <div class="name">${abbreviateName(i.name)}</div>
                            <div style="font-size:0.7vw; color:#666;">
                                ${type === 'sale' ? `Mess: ${i.mess} | Chốt: ${i.rateStr}` : `CP: ${fmtMoney(i.cost)} | Ads: ${i.rateStr}`}
                            </div>
                        </div>
                        <div style="font-weight:900; font-size:1vw;">${fmtMoney(i.rev)}</div>
                    </div>`;
                }
            };

            // Hàm render cho Cảnh báo (Luôn nhỏ)
            const renderWarningItem = (i, idx, type) => {
                const isBadSale = type === 'bad-sale';
                return `
                <div class="rank-item danger">
                    <div class="rank-pos" style="color:#ff4444;">!</div>
                    <img src="${i.avatar}" class="avatar">
                    <div class="info-text">
                        <div class="name">${abbreviateName(i.name)}</div>
                        <div style="font-size:0.7vw; color:#666; display:flex; gap:1vw;">
                            <span class="blink-danger">${isBadSale ? 'Chốt: '+i.rateStr : 'Ads: '+i.rateStr}</span>
                            <span>${isBadSale ? 'Mess: '+i.mess : 'CP: '+fmtMoney(i.cost)}</span>
                        </div>
                    </div>
                    <div style="font-weight:900; font-size:1vw;">${fmtMoney(i.rev)}</div>
                </div>`;
            };

            // --- RENDER ---
            // 1. Warning
            document.getElementById('list-warn-sale').innerHTML = data.warnSale.length ? data.warnSale.map((i,x)=>renderWarningItem(i,x,'bad-sale')).join('') : '<div style="text-align:center;color:#999;padding:10px">Không có cảnh báo</div>';
            document.getElementById('list-warn-mkt').innerHTML = data.warnMkt.length ? data.warnMkt.map((i,x)=>renderWarningItem(i,x,'bad-mkt')).join('') : '<div style="text-align:center;color:#999;padding:10px">Không có cảnh báo</div>';

            // 2. Dashboard (Top 3 to, 4+ nhỏ)
            document.getElementById('list-dashboard-sale').innerHTML = data.sale.map((i,x)=>renderDashboardItem(i,x,'sale')).join('');
            document.getElementById('list-dashboard-mkt').innerHTML = data.mkt.map((i,x)=>renderDashboardItem(i,x,'mkt')).join('');

            // 3. Full Team (Chỉ hiện tên & tiền, nhỏ gọn)
            const renderFull = (i,x) => `<div style="display:flex; justify-content:space-between; padding:0.5vh 0; border-bottom:1px solid #eee; font-size:0.9vw;"><span><b>#${x+1}</b> ${abbreviateName(i.name)}</span><span>${fmtMoney(i.rev)}</span></div>`;
            document.getElementById('full-list-sale').innerHTML = data.sale.map(renderFull).join('');
            document.getElementById('full-list-mkt').innerHTML = data.mkt.map(renderFull).join('');
        }

        let currentSceneIdx = 1; 
        const SCENES = [ { id:'scene-warning', time:TIMES.warning }, { id:'scene-dashboard', time:TIMES.dashboard }, { id:'scene-honors', time:TIMES.honors }, { id:'scene-fullteam', time:TIMES.fullteam } ];

        function switchView(id) {
            document.querySelectorAll('.scene').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            const btn = document.querySelector(`.nav-btn[data-target="${id}"]`); if(btn) btn.classList.add('active');
            if(slideInterval) clearInterval(slideInterval);
            if(id === 'scene-honors' && data.honors.length) runSlideshow();
        }

        function runSlideshow() {
            let idx = 0;
            const show = () => {
                const i = data.honors[idx];
                document.getElementById('slide-avatar').src = i.avatar;
                document.getElementById('slide-name').innerText = i.name;
                document.getElementById('slide-role').innerText = i.role;
                document.getElementById('slide-val1').innerText = fmtMoney(i.rev);
                if(i.role.includes('SALE')) { document.getElementById('slide-lbl2').innerText='Tỉ Lệ Chốt'; document.getElementById('slide-val2').innerText=i.rateStr; }
                else { document.getElementById('slide-lbl2').innerText='% ADS'; document.getElementById('slide-val2').innerText=i.rateStr; }
                idx = (idx + 1) % data.honors.length;
            };
            show(); slideInterval = setInterval(show, SLIDE_SPEED);
        }

        function startAutoCycle() {
            if(!isAutoPlay) return;
            if(currentSceneIdx === 0 && !data.warnSale.length && !data.warnMkt.length) currentSceneIdx++;
            const scene = SCENES[currentSceneIdx % SCENES.length];
            switchView(scene.id);
            if(scene.id === 'scene-dashboard') loadData();
            clearTimeout(cycleTimeout);
            cycleTimeout = setTimeout(() => { currentSceneIdx++; startAutoCycle(); }, scene.time);
        }

        function manualSwitch(id) { isAutoPlay=false; updatePlayStatus(); clearTimeout(cycleTimeout); switchView(id); currentSceneIdx = SCENES.findIndex(s=>s.id===id); }
        function toggleAutoPlay() { isAutoPlay=!isAutoPlay; updatePlayStatus(); if(isAutoPlay) startAutoCycle(); else clearTimeout(cycleTimeout); }
        function updatePlayStatus() { const i=document.getElementById('play-status-icon'), t=document.getElementById('play-status-text'); if(isAutoPlay){i.innerHTML='<i class="fa-solid fa-pause"></i>';t.innerText='ĐANG CHẠY';t.className='status-playing play-status';}else{i.innerHTML='<i class="fa-solid fa-play"></i>';t.innerText='TẠM DỪNG';t.className='status-paused play-status';} }

        window.onload = init;
    </script>
</body>
</html>

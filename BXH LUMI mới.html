<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bảng Xếp Hạng Lumi - T1/2026</title>
    <meta http-equiv="refresh" content="300">

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&family=Roboto:wght@400;500;700;900&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-primary: #333;
            --text-secondary: #666;
            --brand-color: #28a745;
            --sale-gradient: linear-gradient(90deg, #2E3192 0%, #1BFFFF 100%);
            --mkt-gradient: linear-gradient(90deg, #FDB931 0%, #F57F17 100%);
            --team-gradient: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            --gold: #FFD700;
            --gold-glow: rgba(255, 215, 0, 0.6);
            --silver: #C0C0C0;
            --bronze: #CD7F32;
        }

        html {
            overflow-x: hidden;
            font-size: 1.2vw;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 1vh 0;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 1vh 2vw;
            margin-bottom: 1vh;
            position: relative;
        }

        .lumi-logo {
            height: 8vh;
            width: auto;
            object-fit: contain;
            mix-blend-mode: multiply;
            filter: contrast(1.1);
        }

        .lumi-brand {
            font-family: 'Montserrat', sans-serif;
            font-weight: 900;
            font-size: 3.5vw;
            background: linear-gradient(to right, #11998e, #38ef7d);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin: 0;
            line-height: 0.85;
        }

        .lumi-subtitle {
            font-size: 1.2vw;
            color: var(--text-secondary);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .date-range-display {
            font-size: 0.9vw;
            color: #007bff;
            font-weight: 600;
            margin-top: 0.5vh;
        }

        .toolbar {
            display: flex;
            gap: 1vw;
            background: #fff;
            padding: 1vh 1.5vw;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            position: absolute;
            right: 2vw;
            top: 3vh;
            align-items: center;
        }

        .btn-team {
            background: var(--team-gradient);
            color: white;
            border: none;
            padding: 1vh 1.5vw;
            border-radius: 25px;
            font-weight: 700;
            font-family: 'Roboto', sans-serif;
            font-size: 0.9vw;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5vw;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
        }

        .btn-team:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(102, 126, 234, 0.5);
        }

        .filter-select {
            padding: 1vh 1.5vw;
            border-radius: 25px;
            border: 1px solid #ddd;
            font-weight: 500;
            font-size: 0.9vw;
            outline: none;
            cursor: pointer;
        }

        .container {
            display: flex;
            gap: 2vw;
            padding: 0 2vw;
            flex-wrap: nowrap;
            align-items: stretch;
        }

        .board {
            flex: 1;
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            padding: 1.5vh 1.5vw;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .board::before {
            content: "LUMI";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-30deg);
            font-size: 8vw;
            font-weight: 900;
            color: rgba(0, 0, 0, 0.02);
            pointer-events: none;
            z-index: 0;
        }

        .board-header {
            text-align: center;
            margin-bottom: 1vh;
            text-transform: uppercase;
            border-bottom: 2px solid #eee;
            padding-bottom: 0.8vh;
            z-index: 1;
        }

        .board-header h2 {
            margin: 0;
            font-size: 1.2vw;
            color: #333;
        }

        .board.sale .board-header h2 {
            color: #007bff;
        }

        .board.mkt .board-header h2 {
            color: #ff6b6b;
        }

        .rank-list-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 100%;
            z-index: 1;
        }

        .rank-item {
            display: flex;
            align-items: center;
            margin-bottom: 1vh;
            padding: 0.8vh 1vw;
            border-radius: 15px;
            background: #fff;
            transition: transform 0.3s;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.03);
            border: 1px solid transparent;
            width: 100%;
            box-sizing: border-box;
        }

        .rank-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .rank-item.top-1 {
            border: 1px solid rgba(255, 215, 0, 0.3);
            background: linear-gradient(to right, #fffff0, #fff);
        }

        .rank-item.top-2 {
            border: 1px solid rgba(192, 192, 192, 0.3);
            background: linear-gradient(to right, #f8f9fa, #fff);
        }

        .rank-item.top-3 {
            border: 1px solid rgba(205, 127, 50, 0.3);
            background: linear-gradient(to right, #fff5ee, #fff);
        }

        .rank-pos {
            width: 2.5vw;
            font-weight: 900;
            font-size: 1.2vw;
            color: #ccc;
            text-align: center;
            margin-right: 0.8vw;
            flex-shrink: 0;
        }

        .rank-pos.rank-1 {
            color: var(--gold);
            font-size: 1.8vw;
            text-shadow: 0 0 10px var(--gold-glow);
        }

        .rank-pos.rank-2 {
            color: var(--silver);
            font-size: 1.6vw;
        }

        .rank-pos.rank-3 {
            color: var(--bronze);
            font-size: 1.4vw;
        }

        .user-info-group {
            display: flex;
            align-items: center;
            width: 8vw;
            flex-shrink: 0;
        }

        .avatar {
            width: 3.5vh;
            height: 3.5vh;
            border-radius: 50%;
            object-fit: cover;
            border: 0.2vh solid #fff;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            margin-right: 0.8vw;
            position: relative;
        }

        .avatar-crown {
            position: absolute;
            top: -1.5vh;
            left: 1.5vw;
            color: var(--gold);
            font-size: 1.5vw;
            filter: drop-shadow(0 0 5px var(--gold-glow));
            animation: bounce 2s infinite;
            z-index: 10;
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-5px);
            }
        }

        .rank-item.top-1 .avatar {
            border-color: var(--gold);
        }

        .rank-item.top-2 .avatar {
            border-color: var(--silver);
        }

        .rank-item.top-3 .avatar {
            border-color: var(--bronze);
        }

        .info-text {
            flex: 1;
            overflow: hidden;
        }

        .name {
            font-weight: 800;
            font-size: 1.1vw;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
        }

        .bar-container {
            flex: 1;
            background-color: #f1f3f5;
            border-radius: 12px;
            height: 2.2vh;
            position: relative;
            margin-left: 0;
            overflow: hidden;
            display: flex;
            align-items: center;
        }

        .bar-fill {
            height: 100%;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 0.6vw;
            font-weight: 900;
            font-size: 0.9vw;
            color: #fff;
            width: 0%;
            max-width: 100%;
            transition: width 1.5s cubic-bezier(0.22, 1, 0.36, 1);
            white-space: nowrap;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }

        .board.sale .bar-fill {
            background: var(--sale-gradient);
        }

        .board.mkt .bar-fill {
            background: var(--mkt-gradient);
            color: #fff;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .rank-item.week-size .bar-fill {
            color: #000 !important;
            text-shadow: none !important;
        }

        .board.sale .rank-item.week-size .bar-fill {
            color: #000 !important;
            text-shadow: none !important;
        }

        .board.mkt .rank-item.week-size .bar-fill {
            color: #000 !important;
            text-shadow: none !important;
        }

        .board.team-modal .bar-fill {
            background: var(--team-gradient);
        }

        /* --- MONTHLY SECTION --- */
        .month-section {
            margin-top: 1.5vh;
            padding-top: 1vh;
            border-top: 2px dashed #ddd;
            z-index: 1;
        }

        .month-header {
            text-align: center;
            font-weight: 900;
            text-transform: uppercase;
            font-size: 0.8vw;
            margin-bottom: 1vh;
            color: #555;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1vw;
        }

        /* Kích thước top doanh số tuần */
        .rank-item.week-size {
            padding: 2.2vh 2.5vw;
            margin-bottom: 2vh;
        }

        .rank-item.week-size .rank-pos {
            width: 4vw;
            font-size: 2vw;
        }

        .rank-item.week-size .rank-pos.rank-1 {
            font-size: 3.2vw;
        }

        .rank-item.week-size .rank-pos.rank-2 {
            font-size: 2.6vw;
        }

        .rank-item.week-size .rank-pos.rank-3 {
            font-size: 2.4vw;
        }

        .rank-item.week-size .avatar {
            width: 7vh;
            height: 7vh;
            margin-right: 2vw;
        }

        .rank-item.week-size .name {
            font-size: 2vw;
        }

        .rank-item.week-size .bar-container {
            height: 4vh;
            margin-left: 0;
        }

        .rank-item.week-size .bar-fill {
            font-size: 1.4vw;
            color: #000 !important;
            font-weight: 900;
        }

        .rank-item.week-size .avatar-crown {
            font-size: 2vw;
            top: -2vh;
            left: 2vw;
        }

        .rank-item.week-size .user-info-group {
            width: 16vw;
        }

        /* Top doanh số tháng - container xếp ngang */
        #sale-month-list,
        #mkt-month-list {
            display: flex;
            flex-direction: row;
            gap: 1.5vw;
            justify-content: space-around;
            align-items: center;
        }

        .month-rank-item {
            display: flex;
            align-items: center;
            flex: 1;
            padding: 1vh 1.5vw;
            border-radius: 10px;
            background: #fff;
            transition: transform 0.3s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.03);
            justify-content: center;
        }

        .month-rank-item.top-1 {
            border: 1px solid rgba(255, 215, 0, 0.3);
            background: linear-gradient(to right, #fffff0, #fff);
        }

        .month-rank-item.top-2 {
            border: 1px solid rgba(192, 192, 192, 0.3);
            background: linear-gradient(to right, #f8f9fa, #fff);
        }

        .month-rank-pos {
            width: 2.5vw;
            font-weight: 900;
            font-size: 1.25vw;
            color: #ccc;
            text-align: center;
            margin-right: 1.2vw;
            flex-shrink: 0;
        }

        .month-rank-pos.rank-1 {
            color: var(--gold);
            font-size: 1.5vw;
        }

        .month-rank-pos.rank-2 {
            color: var(--silver);
            font-size: 1.4vw;
        }

        .month-name {
            font-weight: 800;
            font-size: 1.25vw;
            color: var(--text-primary);
            white-space: nowrap;
        }

        .month-value {
            font-weight: 700;
            font-size: 1.1vw;
            color: var(--text-secondary);
            margin-left: 0.8vw;
            white-space: nowrap;
        }

        /* --- DANGER ZONE --- */
        .danger-section {
            margin: 15px 20px;
            background: #fff5f5;
            border: 2px solid #ffcccc;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(255, 0, 0, 0.05);
        }

        .danger-header {
            text-align: center;
            font-weight: 900;
            color: #c0392b;
            text-transform: uppercase;
            margin-bottom: 12px;
            font-size: 1.1rem;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            border-bottom: 2px solid #ffebeb;
            padding-bottom: 8px;
        }

        .danger-container {
            display: flex;
            gap: 20px;
            justify-content: center;
        }

        .danger-col {
            flex: 1;
            background: #fff;
            padding: 12px;
            border-radius: 12px;
            border: 2px solid #ff9999;
            box-shadow: 0 4px 10px rgba(255, 0, 0, 0.08);
        }

        .danger-title {
            text-align: center;
            font-weight: 800;
            margin-bottom: 10px;
            color: #e74c3c;
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        .danger-list {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .danger-name-item {
            font-size: 1.2rem;
            font-weight: 900;
            color: #e74c3c;
            text-align: center;
            white-space: nowrap;
        }

        /* --- MODAL (FULL SCREEN) STYLE --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #fff;
            z-index: 9999;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: #fff;
            width: 100%;
            height: 100%;
            border-radius: 0;
            padding: 25px;
            box-shadow: none;
            display: flex;
            flex-direction: column;
            position: relative;
            animation: fadeIn 0.3s ease;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
            padding-bottom: 15px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 900;
            background: var(--team-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-transform: uppercase;
        }

        .btn-close {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #ddd;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #666;
            cursor: pointer;
            transition: 0.2s;
            flex-shrink: 0;
        }

        .btn-close:hover {
            background: #ff4444;
            color: #fff;
            border-color: #ff4444;
            transform: scale(1.1);
        }

        .modal-body {
            overflow-y: auto;
            flex: 1;
            padding-right: 5px;
        }

        #team-sale-list,
        #team-mkt-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        @media (max-width: 768px) {
            .modal-body {
                grid-template-columns: 1fr !important;
            }

            .modal-content {
                width: 100%;
                height: 100%;
                padding: 15px;
            }

            .container {
                flex-direction: column;
            }

            .danger-container {
                flex-direction: column;
            }

            .toolbar {
                position: relative;
                top: 0;
                right: 0;
                margin-bottom: 20px;
                flex-wrap: wrap;
            }

            .app-header {
                flex-direction: column;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
    </style>
</head>

<body>

    <div class="app-header">
        <div style="display: flex; align-items: center; gap: 5px;">
            <img src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&amp;tableName=Kho%20%E1%BA%A3nh&amp;fileName=Kho%20%E1%BA%A3nh_Images%2Ff930e667.%E1%BA%A2nh.025539.jpg"
                alt="Lumi Logo" class="lumi-logo">
            <h1 class="lumi-brand">LUMI</h1>
            <div>
                <div class="lumi-subtitle">Bảng Vinh Danh</div>
                <div id="date-range-display" class="date-range-display" style="margin-top: 5px;"></div>
            </div>
        </div>

        <div class="toolbar">
            <button class="btn-team" onclick="pourDataToV2()"
                style="background: linear-gradient(90deg, #FFD700 0%, #FF8C00 100%);">
                <i class="fa-solid fa-crown"></i> Vinh Danh Top 3
            </button>
            <button class="btn-team" onclick="openTeamModal()">
                <i class="fa-solid fa-users"></i> BXH Toàn Team
            </button>

            <select class="filter-select" id="period-type" onchange="updateData()">
                <option value="week">Theo Tuần</option>
                <option value="month">Theo Tháng</option>
            </select>
            <!-- ĐÃ CẬP NHẬT: Chọn Tuần của Tháng 1 -->
            <select class="filter-select" id="period-value" onchange="updateData()">
                <option value="w1">Tuần 1 (1-7/1)</option>
                <option value="w2">Tuần 2 (8-14/1)</option>
                <option value="w3">Tuần 3 (15-21/1)</option>
                <option value="w4">Tuần 4 (22-28/1)</option>
                <option value="w5">Tuần 5 (29-End)</option>
            </select>
        </div>
    </div>

    <!-- MAIN BOARDS -->
    <div class="container">
        <!-- SALE BOARD -->
        <div class="board sale">
            <div class="board-header">
                <h2><i class="fa-solid fa-chart-line"></i> TOP DOANH SỐ TUẦN - SALE</h2>
            </div>
            <div id="sale-list" class="rank-list-container"></div>
            <div class="month-section">
                <div class="month-header">
                    <i class="fa-solid fa-calendar-check" style="color: gold;"></i> TOP DOANH SỐ THÁNG SALE
                </div>
                <div id="sale-month-list" class="rank-list-container"></div>
            </div>
        </div>

        <!-- MKT BOARD -->
        <div class="board mkt">
            <div class="board-header">
                <h2><i class="fa-solid fa-bullhorn"></i> TOP DOANH SỐ TUẦN - MKT</h2>
            </div>
            <div id="mkt-list" class="rank-list-container"></div>
            <div class="month-section">
                <div class="month-header">
                    <i class="fa-solid fa-calendar-check" style="color: gold;"></i> TOP DOANH SỐ THÁNG MKT
                </div>
                <div id="mkt-month-list" class="rank-list-container"></div>
            </div>
        </div>
    </div>

    <!-- DANGER ZONE -->
    <div class="danger-section">
        <div class="danger-header">
            <i class="fa-solid fa-triangle-exclamation"></i> Danh Sách Nhân Sự Cần Cải Thiện
        </div>
        <div class="danger-container">
            <div class="danger-col">
                <div class="danger-title"><i class="fa-solid fa-arrow-trend-down"></i> 3 Nhân sự Sale (Doanh số thấp
                    nhất)</div>
                <div class="danger-list" id="danger-sale"></div>
            </div>
            <div class="danger-col">
                <div class="danger-title"><i class="fa-solid fa-arrow-trend-down"></i> 3 Nhân sự MKT (Doanh số thấp
                    nhất)</div>
                <div class="danger-list" id="danger-mkt"></div>
            </div>
        </div>
    </div>

    <!-- MODAL BXH TOÀN TEAM -->
    <div class="modal-overlay" id="teamModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title"><i class="fa-solid fa-trophy"></i> BXH DOANH SỐ TOÀN TEAM</div>
                <button class="btn-close" onclick="closeTeamModal()"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="board team-modal" style="box-shadow: none; padding: 0;">
                <div class="modal-body" style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <div>
                        <div class="team-column-header"
                            style="text-align: center; margin-bottom: 20px; font-weight: 900; font-size: 1.5rem; color: #007bff; text-transform: uppercase;">
                            <i class="fa-solid fa-chart-line"></i> TEAM SALE
                        </div>
                        <div id="team-sale-list"></div>
                    </div>
                    <div>
                        <div class="team-column-header"
                            style="text-align: center; margin-bottom: 20px; font-weight: 900; font-size: 1.5rem; color: #ff6b6b; text-transform: uppercase;">
                            <i class="fa-solid fa-bullhorn"></i> TEAM MKT
                        </div>
                        <div id="team-mkt-list"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const F3_URL = 'https://n-api-gamma.vercel.app/sheet/F3/data';
        const REPORT_URL = 'https://n-api-gamma.vercel.app/report/generate?tableName=Báo cáo sale';
        const MKT_REPORT_URL = 'https://n-api-gamma.vercel.app/report/generate?tableName=Báo cáo MKT';
        const HR_URL = 'https://lumi-6dff7-default-rtdb.asia-southeast1.firebasedatabase.app/datasheet/Nh%C3%A2ns%E1%BB%B1';

        // --- CẤU HÌNH THỜI GIAN ---
        const TARGET_MONTH = 0; // Tháng 1
        const TARGET_YEAR = 2026; // Năm 2026

        let allOrders = [];
        let salesReportData = [];
        let mktReportData = [];
        let hrData = [];

        function abbreviateName(fullName) {
            if (!fullName) return "";
            const parts = fullName.trim().split(/\s+/);
            if (parts.length === 1) return parts[0];

            const firstName = parts[parts.length - 1];
            const others = parts.slice(0, parts.length - 1);
            const initials = others.map(part => part.charAt(0).toUpperCase()).join('');

            return `${firstName}-${initials}`;
        }

        // Danh sách nhân sự cần loại bỏ
        const EXCLUDED_NAMES = [
            'Mai Thị Lý',
            'Phạm Hải Yến',
            'Trần Thị Nhung',
            'Lê Ngọc Đài Trang',
            'Đinh Thị Hoài Thư',
            'Đỗ Thị Thu Hằng'
        ];

        function filterExcludedNames(list) {
            return list.filter(item => {
                const name = item.name.trim();
                // Loại bỏ nếu tên trong danh sách loại trừ
                if (EXCLUDED_NAMES.includes(name)) return false;
                // Loại bỏ nếu tên có chứa "Lumi" (không phân biệt hoa thường)
                if (name.toLowerCase().includes('lumi')) return false;
                return true;
            });
        }

        function formatMoney(num) {
            if (!num) return '0';
            if (num >= 1000000) return Math.round(num / 1000000) + ' Tr';
            return Math.round(num).toLocaleString('vi-VN');
        }

        function formatMoneyForDanger(num) {
            if (!num) return '0tr';
            if (num >= 1000000) {
                const trValue = num / 1000000;
                // Format với 1 chữ số thập phân và dấu phẩy, ví dụ: 3,5tr hoặc 3tr nếu là số nguyên
                if (trValue % 1 === 0) {
                    return Math.round(trValue) + 'tr';
                }
                return trValue.toFixed(1).replace('.', ',') + 'tr';
            }
            return Math.round(num).toLocaleString('vi-VN');
        }

        function parseMoney(moneyStr) {
            if (typeof moneyStr === 'number') return moneyStr;
            return parseInt(String(moneyStr || 0).replace(/\./g, '').replace(/,/g, '').replace(/\D/g, '')) || 0;
        }

        // Helper function để normalize tên (loại bỏ khoảng trắng thừa, chuyển lowercase)
        function normalizeName(name) {
            if (!name) return '';
            return name.toString().trim().replace(/\s+/g, ' ').toLowerCase();
        }

        // Extract FILE_ID từ Google Drive link
        function extractGoogleDriveFileId(link) {
            if (!link) return null;
            const linkStr = link.toString().trim();

            // Thử extract từ nhiều format
            // Format 1: https://drive.google.com/file/d/FILE_ID/view
            let match = linkStr.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
            if (match && match[1]) return match[1];

            // Format 2: https://drive.google.com/uc?export=view&id=FILE_ID
            match = linkStr.match(/[?&]id=([a-zA-Z0-9_-]+)/);
            if (match && match[1]) return match[1];

            // Format 3: https://drive.google.com/open?id=FILE_ID
            match = linkStr.match(/open[?&]id=([a-zA-Z0-9_-]+)/);
            if (match && match[1]) return match[1];

            return null;
        }

        // Chuyển đổi Google Drive link sang direct image link với nhiều format fallback
        function convertGoogleDriveLink(link) {
            if (!link) return link;

            const linkStr = link.toString().trim();
            const fileId = extractGoogleDriveFileId(linkStr);

            if (!fileId) {
                // Nếu không phải Google Drive link, trả về nguyên
                if (!linkStr.includes('drive.google.com')) {
                    return linkStr;
                }
                return linkStr;
            }

            // Thử format thumbnail (thường hoạt động tốt hơn)
            return `https://drive.google.com/thumbnail?id=${fileId}&sz=w800`;
        }

        // Data ảnh từ bảng cung cấp (ưu tiên cao nhất) - sử dụng thumbnail format
        const AVATAR_DATA = {
            'Nguyễn Trần Thành Đạt': 'https://drive.google.com/thumbnail?id=1fzxkLW-U6tBrsoeVomSVko8rKHo3WlVc&sz=w800',
            'Trần Văn Tiến': 'https://drive.google.com/thumbnail?id=1iQAphZYehYbD72NWHgD9d4KX5xUcjSx1&sz=w800',
            'Hoàng Tuấn Cường': 'https://drive.google.com/thumbnail?id=1liZeqnJvvsrA_ChdfbjmMJUgqj2DIOLg&sz=w800',
            'Mạnh Cường': 'https://drive.google.com/thumbnail?id=1_nkhhVlm4KOuUA6aoKNAj4mE5MbF-x1d&sz=w800',
            'Đỗ Mạnh Cường': 'https://drive.google.com/thumbnail?id=1_nkhhVlm4KOuUA6aoKNAj4mE5MbF-x1d&sz=w800',
            'Nguyễn Thị Hiếu': 'https://drive.google.com/thumbnail?id=1GmH2VP-DMIhvTm-TG65WlYyXrbS8ygwD&sz=w800',
            'Vũ Viết Anh': 'https://drive.google.com/thumbnail?id=191tir-VO8tOm56eLFBLlYrqD8--P-feY&sz=w800',
            'Lục Trần Minh Trí': 'https://drive.google.com/thumbnail?id=1sKhy1W92Eet7dDNu-HzYiRsGsy0AU7Tm&sz=w800',
            'Nguyễn Hiền Lương': 'https://drive.google.com/thumbnail?id=1TOwTb8o4rAqtKPZmI_Y-8szk1vqwsfK-&sz=w800',
            'Trần Huy Hùng': 'https://drive.google.com/thumbnail?id=1o-Xp4KBa76vsrOqcA9BLL7iTM852w_l_&sz=w800',
            'Phạm Tiến Thành': 'https://drive.google.com/thumbnail?id=1wELVha3c9zpqrauTItzr8Qp0trfhN2TP&sz=w800',
            'Trần Quốc Khải': 'https://drive.google.com/thumbnail?id=1z21zunKRZRO5ffw6KfLXWNTu0LhS_YOX&sz=w800',
            'Nguyễn Thị Thủy Tiên': 'https://drive.google.com/thumbnail?id=1xMEP5-HfCBUEIVu8GSTg3S_x8RRuBQoY&sz=w800',
            'Đoàn Thị Kim Oanh': 'https://drive.google.com/thumbnail?id=1hdAmisoQwBdVMhDXh2ewNw8XXSp5gVLm&sz=w800',
            'Đinh Văn Khải': 'https://drive.google.com/thumbnail?id=18ezyaCwzGOeR-mZSa78QETJuHaYtXulS&sz=w800',
            'Lê Trung Hiếu': 'https://drive.google.com/thumbnail?id=10TE6KIyEcEpBLov_svb_Orn7OYCh_90G&sz=w800',
            'Nguyễn Quang Trường': 'https://drive.google.com/thumbnail?id=1W56nfGDCqbk_XVCLYg1N20_pFkBzcspO&sz=w800',
            'Phạm Tuyết Trinh': 'https://drive.google.com/thumbnail?id=1EnzOdwHdoO4qD9-6eYQjr6gLR-e9qNKo&sz=w800',
            'Trần Thị Ngọc Ánh': 'https://drive.google.com/thumbnail?id=1ah5FMqd1ucXenzgUvdUguOoVMfB_ZE0p&sz=w800',
            'Nguyễn Thị Thảo': 'https://drive.google.com/thumbnail?id=1rJbWkI_PRup9ZzskLq_Iq3zaurpgRp_x&sz=w800',
            'Đặng Thị Nga': 'https://drive.google.com/thumbnail?id=1gPoBL2d8WgsqrZ32vmrHWHdCNAkGx4u_&sz=w800',
            'Phạm Thị Yến': 'https://drive.google.com/thumbnail?id=1qBR5clqVzQbUPgwRudH8BSoPRl04bykF&sz=w800',
            'Phạm Thị Lệ': 'https://drive.google.com/thumbnail?id=1fLAdtsgJqYBn65P3Qc0ShPyix6klzaQN&sz=w800',
            'Nguyễn Mỹ Duyên': 'https://drive.google.com/thumbnail?id=10rC1xNt-Nvns1Xxel7IWquki9y9VaseO&sz=w800',
            'Dương Đức Mạnh': 'https://drive.google.com/thumbnail?id=1gIfuSEwGvGsb4o_HktaHupYGjJjVRqjb&sz=w800',
            'Trần Thị Hồng Nhung': 'https://drive.google.com/thumbnail?id=14hVANI_MT2w0DI3xNMCaht8s5E5FBXaK&sz=w800',
            'Phạm Văn Đạt': 'https://drive.google.com/thumbnail?id=1OpIuH43ybVBeb7HhrVvQQ9_h-NqU8gYg&sz=w800',
            'Nguyễn Anh Điệp': 'https://drive.google.com/thumbnail?id=1Y09ORLQEBIQN-Sad_qZhEV4kPc2VUA-U&sz=w800',
            'Nguyễn Tiến Mạnh': 'https://drive.google.com/thumbnail?id=1NerKw-Y1d1riNbZJBmzdNZHaZ0lnfEGy&sz=w800',
            'Giang Kiều Duyên': 'https://drive.google.com/thumbnail?id=1i0g02w_pv-Liz2MiqaeDzXyNIMfGXjET&sz=w800',
            'Hoàng Thị Uyên': 'https://drive.google.com/thumbnail?id=1Nz__Y9UsL_dDVD_lInd5_85-vk9VIBlo&sz=w800',
            'Phạm Thị Huyền Trang': 'https://drive.google.com/thumbnail?id=1LCDJyhTr-G_kEabC9vZcL-DqN1a7UlwS&sz=w800',
            'Nguyễn Mạnh Tú': 'https://drive.google.com/thumbnail?id=1NahrdJp2wQ2I-OW2CUCViKeqhXuk24Vm&sz=w800',
            'Phan Thu Hương': 'https://drive.google.com/thumbnail?id=1Hyo_yN8Np_lTbzwpb6LzUAWkvdhIjP-t&sz=w800',
            'Trần Uy Vũ': 'https://drive.google.com/thumbnail?id=1tInrkQELxm0Jca-dJsEXstHF0i6DNlMl&sz=w800',
            'Nguyễn Thị Ánh Nguyệt': 'https://drive.google.com/thumbnail?id=1zFyLEdL5SeE74bbfsJ1Wt8AbtH1qSAhQ&sz=w800',
            'Nguyễn Thị Ánh Nguyệt 1': 'https://drive.google.com/thumbnail?id=1zFyLEdL5SeE74bbfsJ1Wt8AbtH1qSAhQ&sz=w800',
            'Bùi Thị Hảo': 'https://drive.google.com/thumbnail?id=1jq8j2GvGaXsQFjnvUoIF9ACUl6t1jg_k&sz=w800',
            'Trần Bùi Lan Phương': 'https://drive.google.com/thumbnail?id=1ZzJ6qPS5kC6bP_kc-gyDJJbChwmoCpgR&sz=w800',
            'Văn Thị Anh': 'https://drive.google.com/thumbnail?id=1uugGRR4u9A12sLwSf4Kp9HQqSnpZObgc&sz=w800',
            'Nguyễn Thị Mỹ Hạnh': 'https://drive.google.com/thumbnail?id=146xx9zPBe_4JNx-AGYcDM68mEQCEi3EP&sz=w800',
            'Đỗ Thị Thanh Huệ': 'https://drive.google.com/thumbnail?id=1rGY7ZjnFZvkcXc-lR5vEJspu6YTCMjol&sz=w800',
            'Nguyễn Thị Thu': 'https://drive.google.com/thumbnail?id=1pkhZ__YRel6C6IEwK29YvNuR39LnQxfj&sz=w800',
            'Đồng Tố Dũng': 'https://drive.google.com/thumbnail?id=1vzshZNQFVZEe8HYJRFZ5oxx6JP9QIdYY&sz=w800',
            'Nguyễn Đức Huy': 'https://drive.google.com/thumbnail?id=1CoWTsxTzfZEp2yLpnuaMAjthdSKV8Y_f&sz=w800',
            'Nguyễn Thị Ngọc Ánh': 'https://drive.google.com/thumbnail?id=1hQ7s_Xg7LZmc_b7BhplrD5I_pMOZjPi1&sz=w800',
            'Đặng Thị Hoa': 'https://drive.google.com/thumbnail?id=1T3kCVcmZ4eoBDraFuv_ucXcRRILOUFV1&sz=w800',
            'Lê Thị Thuý': 'https://drive.google.com/thumbnail?id=1oBCubueLuQOnRa912bd0eQanmmcphux0&sz=w800',
            'Nguyễn Thị Hường': 'https://drive.google.com/thumbnail?id=1gP-HI-V-ig24pDx4n-9ZmhbFdBfI1js4&sz=w800',
            'Mai Thị Lý': 'https://drive.google.com/thumbnail?id=1k_eyFAFWs-5v1aYVLpnegprvJjvYiOYc&sz=w800',
            'Trần Thị Nhung': 'https://drive.google.com/thumbnail?id=1_QfAXZ-ZU7oChppYWiDoRaRxJqwCSr-6&sz=w800',
            'Hoàng Thị Hương Giang': 'https://drive.google.com/thumbnail?id=1YF8Jv_bT5fYY3qV89_EPxKwoKCWYBxUN&sz=w800',
            'Phạm Thị Phương Thảo': 'https://drive.google.com/thumbnail?id=1-3zQ-hLkiWB4LeVKMdZCasEsl8xFuwC_&sz=w800',
            'Đỗ Thị Thu Hằng': 'https://drive.google.com/thumbnail?id=137slyKEqqFZ_ErySbms6CaTIoMCwOzce&sz=w800',
            'Đỗ Thị Thu Uyên': 'https://drive.google.com/thumbnail?id=1Y4VJQlxgBORhVzz8PbPE7wKzew2E5xR9&sz=w800',
            'Nguyễn Văn Tuấn': 'https://drive.google.com/thumbnail?id=1bKhgPV1FTYg0PJZUS3T7087s3H7LSQMG&sz=w800'
        };

        // Tạo map normalized cho quick lookup
        const AVATAR_DATA_MAP = new Map();
        Object.keys(AVATAR_DATA).forEach(name => {
            AVATAR_DATA_MAP.set(normalizeName(name), AVATAR_DATA[name]);
        });

        // Cache Map để lookup nhanh: tên normalized -> HR record
        let hrDataMap = null;

        function buildHRDataMap() {
            if (!hrData || hrData.length === 0) {
                hrDataMap = null;
                return;
            }

            hrDataMap = new Map();
            hrData.forEach(record => {
                // Thử nhiều tên cột khác nhau
                const recordName = (record['Họ Và Tên'] || record['Tên'] || record['Name'] ||
                    record['Họ và tên'] || record['Họ_và_tên'] || '').toString().trim();

                if (recordName) {
                    const normalized = normalizeName(recordName);
                    // Lưu record với key normalized
                    if (!hrDataMap.has(normalized)) {
                        hrDataMap.set(normalized, record);
                    }
                }
            });
        }

        function getAvatar(name) {
            if (!name) {
                let hash = 0;
                return `https://i.pravatar.cc/150?img=${Math.abs(hash % 70)}`;
            }

            const nameTrim = name.trim();
            const nameNormalized = normalizeName(nameTrim);

            // Ưu tiên 1: Tìm trong AVATAR_DATA (data tĩnh từ bảng) - đã là direct link format
            if (AVATAR_DATA_MAP.has(nameNormalized)) {
                const imageLink = AVATAR_DATA_MAP.get(nameNormalized);
                return imageLink;
            }

            // Ưu tiên 2: Tìm exact match (không normalize) trong AVATAR_DATA - đã là direct link format
            if (AVATAR_DATA[nameTrim]) {
                const imageLink = AVATAR_DATA[nameTrim];
                return imageLink;
            }

            // Ưu tiên 3: Tìm trong HR data từ API
            if (!hrDataMap && hrData && hrData.length > 0) {
                buildHRDataMap();
            }

            if (hrDataMap) {
                const hrRecord = hrDataMap.get(nameNormalized);

                if (hrRecord) {
                    // Thử nhiều tên cột khác nhau cho link ảnh
                    let imageLink = hrRecord['Link ảnh'] || hrRecord['link ảnh'] || hrRecord['Link_ảnh'] ||
                        hrRecord['Link anh'] || hrRecord['link anh'] || hrRecord['Link_anh'] ||
                        hrRecord['Ảnh'] || hrRecord['anh'] || hrRecord['Image'] || hrRecord['image'] ||
                        hrRecord['Avatar'] || hrRecord['avatar'] || hrRecord['Ảnh đại diện'] ||
                        hrRecord['Anh dai dien'] || hrRecord['Anh_dai_dien'] ||
                        hrRecord['LINK ẢNH'] || hrRecord['LINK_ẢNH'];

                    // Nếu không có link ảnh, thử lấy từ link vận đơn
                    if (!imageLink) {
                        imageLink = hrRecord['Link vận đơn'] || hrRecord['link vận đơn'] || hrRecord['Link_vận_đơn'] ||
                            hrRecord['Link van don'] || hrRecord['link van don'] || hrRecord['Link_van_don'] ||
                            hrRecord['Link vận đơn cũ'] || hrRecord['link vận đơn cũ'] || hrRecord['Link_vận_đơn_cũ'];
                    }

                    if (imageLink && imageLink.trim()) {
                        const convertedLink = convertGoogleDriveLink(imageLink.trim());
                        return convertedLink;
                    }
                }
            }

            // Fallback: dùng pravatar nếu không tìm thấy
            let hash = 0;
            for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
            return `https://i.pravatar.cc/150?img=${Math.abs(hash % 70)}`;
        }

        function pourDataToV2() {
            // Lấy top 3 Sale và MKT hiện tại
            const type = document.getElementById('period-type').value;
            const value = document.getElementById('period-value').value;
            const { start, end } = getDateRange(type, value);
            const stats = calculateStats(start, end);

            // Lọc MKT: loại bỏ những người có ADS > 27%
            const filteredMktList = stats.mktList.filter(item => {
                // adsRate đã được tính trong calculateStats
                return item.adsRate <= 27;
            });

            const vinhDanhList = [
                ...stats.saleList.slice(0, 3).map(i => ({ ...i, name: i.name, dept: 'SALE' })),
                ...filteredMktList.slice(0, 3).map(i => ({ ...i, name: i.name, dept: 'MKT' }))
            ];

            if (vinhDanhList.length === 0) {
                alert("Không có dữ liệu để vinh danh!");
                return;
            }

            localStorage.setItem('vinhDanhTop3', JSON.stringify(vinhDanhList));
            window.location.href = 'BXH V2.html?mode=slideshow';
        }

        function loadDemoData() {
            // Dữ liệu demo cho đơn hàng THÁNG 1/2026
            const year = TARGET_YEAR;
            const month = TARGET_MONTH; // Tháng 1

            allOrders = [
                { "Ngày lên đơn": new Date(year, month, 1), "Team": "Hà Nội", "Nhân viên Sale": "Nguyễn Thị Ánh", "Nhân viên Marketing": "Trần Quốc Khải", "Tổng tiền VNĐ": "167000000" },
                { "Ngày lên đơn": new Date(year, month, 2), "Team": "Hà Nội", "Nhân viên Sale": "Nguyễn Mạnh", "Nhân viên Marketing": "Phạm Thành", "Tổng tiền VNĐ": "132000000" },
                { "Ngày lên đơn": new Date(year, month, 3), "Team": "Hà Nội", "Nhân viên Sale": "Nguyễn Minh Tú", "Nhân viên Marketing": "Nguyễn Quốc Trường", "Tổng tiền VNĐ": "113000000" },
                { "Ngày lên đơn": new Date(year, month, 4), "Team": "Hà Nội", "Nhân viên Sale": "Lê Văn A", "Nhân viên Marketing": "Trần Quốc Khải", "Tổng tiền VNĐ": "98000000" },
                { "Ngày lên đơn": new Date(year, month, 5), "Team": "Hà Nội", "Nhân viên Sale": "Phạm Văn B", "Nhân viên Marketing": "Phạm Thành", "Tổng tiền VNĐ": "85000000" },
                { "Ngày lên đơn": new Date(year, month, 6), "Team": "Hà Nội", "Nhân viên Sale": "Nguyễn Thị Ánh", "Nhân viên Marketing": "Nguyễn Quốc Trường", "Tổng tiền VNĐ": "120000000" },
                { "Ngày lên đơn": new Date(year, month, 7), "Team": "Hà Nội", "Nhân viên Sale": "Nguyễn Mạnh", "Nhân viên Marketing": "Trần Quốc Khải", "Tổng tiền VNĐ": "145000000" },
                { "Ngày lên đơn": new Date(year, month, 8), "Team": "Hà Nội", "Nhân viên Sale": "Nguyễn Minh Tú", "Nhân viên Marketing": "Phạm Thành", "Tổng tiền VNĐ": "110000000" },
                { "Ngày lên đơn": new Date(year, month, 9), "Team": "Hà Nội", "Nhân viên Sale": "Lê Văn A", "Nhân viên Marketing": "Nguyễn Quốc Trường", "Tổng tiền VNĐ": "75000000" },
                { "Ngày lên đơn": new Date(year, month, 10), "Team": "Hà Nội", "Nhân viên Sale": "Phạm Văn B", "Nhân viên Marketing": "Trần Quốc Khải", "Tổng tiền VNĐ": "65000000" }
            ];

            // Dữ liệu demo cho báo cáo Sale
            salesReportData = [
                { "Tên": "Nguyễn Thị Ánh", "Team": "Sale Ca ngày", "Ngày": new Date(year, month, 1), "Số Mess": 200, "Số đơn thực tế": 19 },
                { "Tên": "Nguyễn Mạnh", "Team": "Sale Ca ngày", "Ngày": new Date(year, month, 2), "Số Mess": 180, "Số đơn thực tế": 15 },
                { "Tên": "Nguyễn Minh Tú", "Team": "Sale Ca ngày", "Ngày": new Date(year, month, 3), "Số Mess": 150, "Số đơn thực tế": 12 },
                { "Tên": "Lê Văn A", "Team": "Sale Ca ngày", "Ngày": new Date(year, month, 4), "Số Mess": 100, "Số đơn thực tế": 8 },
                { "Tên": "Phạm Văn B", "Team": "Sale Ca ngày", "Ngày": new Date(year, month, 5), "Số Mess": 90, "Số đơn thực tế": 6 }
            ];

            // Dữ liệu demo cho báo cáo MKT
            mktReportData = [
                { "Tên": "Trần Quốc Khải", "Doanh số": 200000000, "CPQC": 35000000 },
                { "Tên": "Phạm Thành", "Doanh số": 180000000, "CPQC": 50000000 },
                { "Tên": "Nguyễn Quốc Trường", "Doanh số": 150000000, "CPQC": 48000000 }
            ];
        }

        async function loadData() {
            try {
                const [resF3, resReport, resMkt, resHr] = await Promise.all([
                    fetch(F3_URL).catch(() => null),
                    fetch(REPORT_URL).catch(() => null),
                    fetch(MKT_REPORT_URL).catch(() => null),
                    fetch(HR_URL + '.json').catch(() => null)
                ]);

                let hasData = false;

                if (resF3 && resF3.ok) {
                    const json = await resF3.json();
                    if (json.success && json.data && Array.isArray(json.data)) {
                        allOrders = json.data;
                    } else if (Array.isArray(json)) {
                        allOrders = json;
                    } else if (json.data && Array.isArray(json.data)) {
                        allOrders = json.data;
                    } else {
                        allOrders = Object.values(json);
                    }
                    if (allOrders.length > 0) hasData = true;
                }
                if (resReport && resReport.ok) {
                    const json = await resReport.json();
                    salesReportData = json.data || [];
                    if (salesReportData.length > 0) hasData = true;
                }
                if (resMkt && resMkt.ok) {
                    const json = await resMkt.json();
                    mktReportData = json.data || [];
                    if (mktReportData.length > 0) hasData = true;
                }
                if (resHr && resHr.ok) {
                    const data = await resHr.json();
                    hrData = Array.isArray(data) ? data : Object.values(data);
                    buildHRDataMap();
                }

                if (!hasData || allOrders.length === 0) {
                    console.log("Using demo data");
                    loadDemoData();
                }

                updateData();
            } catch (e) {
                console.error("Error loading data", e);
                console.log("Error occurred, using demo data");
                loadDemoData();
                updateData();
            }
        }

        // --- HÀM TÍNH TUẦN MỚI: DỰA TRÊN NGÀY TRONG THÁNG ---
        // Tuần 1: 1-7, Tuần 2: 8-14,...
        function getCurrentWeek() {
            const now = new Date();
            const date = now.getDate();
            
            // Chia cho 7 và làm tròn lên
            // 1/7 = 0.14 -> 1
            // 7/7 = 1 -> 1
            // 8/7 = 1.14 -> 2
            const week = Math.ceil(date / 7);
            
            if (week > 5) return 'w5';
            return 'w' + week;
        }

        // --- HÀM LẤY KHOẢNG THỜI GIAN MỚI ---
        function getDateRange(type, value) {
            const year = TARGET_YEAR;
            const month = TARGET_MONTH;

            let start, end;
            if (type === 'week') {
                // Xác định ngày bắt đầu của tuần dựa vào value (w1, w2...)
                let startDay = 1;
                if (value === 'w1') startDay = 1;
                else if (value === 'w2') startDay = 8;
                else if (value === 'w3') startDay = 15;
                else if (value === 'w4') startDay = 22;
                else if (value === 'w5') startDay = 29;
                
                start = new Date(year, month, startDay);
                
                if (value === 'w5') {
                     // Tuần 5 lấy đến hết tháng
                     end = new Date(year, month + 1, 0, 23, 59, 59);
                } else {
                     // Các tuần khác cộng thêm 6 ngày (tổng 7 ngày)
                     end = new Date(start);
                     end.setDate(end.getDate() + 6);
                     end.setHours(23, 59, 59, 999);
                }
            } else {
                // Month
                start = new Date(year, month, 1);
                end = new Date(year, month + 1, 0, 23, 59, 59);
            }
            return { start, end };
        }

        function getCurrentShift() {
            const now = new Date();
            const hour = now.getHours();
            if (hour >= 7 && hour < 19) {
                return 'Ca ngày';
            } else {
                return 'Ca Đêm';
            }
        }

        function getStaffShift(staffName) {
            if (!staffName) return null;
            if (hrDataMap) {
                const normalizedName = normalizeName(staffName);
                const hrRecord = hrDataMap.get(normalizedName);
                if (hrRecord) {
                    const ca = hrRecord['Ca'] || hrRecord['ca'] || hrRecord['CA'] ||
                        hrRecord['Ca làm việc'] || hrRecord['Ca_lam_viec'] || '';
                    const caStr = ca.toString().trim();
                    if (caStr) {
                        const caLower = caStr.toLowerCase();
                        if (caLower.includes('ca ngày') || caLower.includes('ca ngay')) {
                            return 'Ca ngày';
                        } else if (caLower.includes('ca đêm') || caLower.includes('ca dem')) {
                            return 'Ca Đêm';
                        }
                    }
                }
            }
            return null;
        }

        function isStaffInShift(staffName, targetShift) {
            if (!staffName || !targetShift) return true; 

            let hasCaInfo = false; 
            let foundShift = null; 

            if (hrDataMap) {
                const normalizedName = normalizeName(staffName);
                const hrRecord = hrDataMap.get(normalizedName);
                if (hrRecord) {
                    const ca = hrRecord['Ca'] || hrRecord['ca'] || hrRecord['CA'] ||
                        hrRecord['Ca làm việc'] || hrRecord['Ca_lam_viec'] || '';
                    const caStr = ca.toString().trim();
                    if (caStr) {
                        hasCaInfo = true;
                        const caLower = caStr.toLowerCase();
                        if (caLower.includes('ca ngày') || caLower.includes('ca ngay')) {
                            foundShift = 'Ca ngày';
                        } else if (caLower.includes('ca đêm') || caLower.includes('ca dem')) {
                            foundShift = 'Ca Đêm';
                        }
                    }
                }
            }

            if (hasCaInfo && foundShift) {
                return foundShift === targetShift;
            }
            return true;
        }

        function calculateStats(startDate, endDate) {
            const periodOrders = allOrders.filter(o => {
                const d = new Date(o["Ngày lên đơn"] || o["Ngày_lên_đơn"]);
                const team = o["Team"] || "";
                return team.trim() === "Hà Nội" && d >= startDate && d <= endDate;
            });

            const currentShift = getCurrentShift();

            // 1. Sale
            const saleMap = {};
            periodOrders.forEach(o => {
                const name = (o["Nhân_viên_Sale"] || o["Nhân viên Sale"] || "").trim();
                if (!name) return;
                const money = parseMoney(o["Tổng tiền VNĐ"] || o["Tổng_tiền_VNĐ"]);
                if (!saleMap[name]) saleMap[name] = 0;
                saleMap[name] += money;
            });

            let saleList = Object.keys(saleMap).map(name => ({
                name,
                rawVal: saleMap[name],
                value: formatMoney(saleMap[name]),
                avatar: getAvatar(name)
            })).sort((a, b) => b.rawVal - a.rawVal);

            saleList = filterExcludedNames(saleList);

            saleList = saleList.filter(item => {
                return isStaffInShift(item.name, currentShift);
            });

            if (saleList.length > 0) {
                const max = saleList[0].rawVal;
                saleList.forEach(i => i.percent = max > 0 ? (i.rawVal / max) * 100 : 0);
            }

            saleList.forEach(item => {
                const reports = salesReportData.filter(r => {
                    if (!r["Tên"] || r["Tên"].trim() !== item.name) return false;
                    
                    if (r["Ngày"] || r["Ngay"] || r["Date"]) {
                        const dateField = r["Ngày"] || r["Ngay"] || r["Date"];
                        const rDate = new Date(dateField);
                        return rDate >= startDate && rDate <= endDate;
                    }
                    return true;
                });

                if (reports.length > 0) {
                    let totalMess = 0;
                    let totalOrders = 0;
                    let teamName = "";

                    reports.forEach(r => {
                        totalMess += Number(r["Số Mess"] || 0);
                        totalOrders += Number(r["Số đơn thực tế"] || 0);
                        if (r["Team"]) teamName = r["Team"];
                    });

                    const rate = totalMess > 0 ? (totalOrders / totalMess) * 100 : 0;
                    item.closeRate = rate.toFixed(1) + "%";
                    item.totalMess = totalMess; 
                    item.doanhthu = item.rawVal;
                    item.teamName = teamName || "Bộ phận Sale";
                } else {
                    item.closeRate = "0%";
                    item.totalMess = 0;
                    item.doanhthu = item.rawVal;
                    item.teamName = "Bộ phận Sale";
                }
                item.shift = getStaffShift(item.name);
            });

            // 2. MKT
            const mktMap = {};
            periodOrders.forEach(o => {
                const name = (o["Nhân_viên_Marketing"] || o["Nhân viên Marketing"] || "").trim();
                if (!name) return;
                const money = parseMoney(o["Tổng tiền VNĐ"] || o["Tổng_tiền_VNĐ"]);
                if (!mktMap[name]) mktMap[name] = 0;
                mktMap[name] += money;
            });

            let mktList = Object.keys(mktMap).map(name => ({
                name,
                rawVal: mktMap[name],
                value: formatMoney(mktMap[name]),
                avatar: getAvatar(name)
            })).sort((a, b) => b.rawVal - a.rawVal);

            mktList = filterExcludedNames(mktList);

            if (mktList.length > 0) {
                const max = mktList[0].rawVal;
                mktList.forEach(i => i.percent = max > 0 ? (i.rawVal / max) * 100 : 0);
            }

            mktList.forEach(item => {
                const doanhthuPeriod = item.rawVal;
                const itemNameNormalized = normalizeName(item.name);

                const reports = mktReportData.filter(r => {
                    const reportName = r["Tên"] || r["Ten"] || r["Name"] || r["name"] || r["Họ và tên"] || r["Họ_và_tên"] || "";
                    if (!reportName) return false;

                    const reportNameNormalized = normalizeName(reportName.toString().trim());
                    if (reportNameNormalized !== itemNameNormalized) return false;

                    const caField = r["Ca"] || r["ca"] || r["CA"] || r["Ca làm việc"] || r["Ca_lam_viec"] || "";
                    const caStr = caField.toString().trim().toLowerCase();
                    if (!caStr.includes("hết ca") && !caStr.includes("het ca")) return false;

                    if (r["Ngày"] || r["Ngay"] || r["Date"]) {
                        const dateField = r["Ngày"] || r["Ngay"] || r["Date"];
                        const rDate = new Date(dateField);
                        return rDate >= startDate && rDate <= endDate;
                    }
                    return true;
                });

                if (reports.length > 0) {
                    let cpqcPeriod = 0;
                    reports.forEach(r => {
                        const cpqcValue = r["CPQC"] || r["cpqc"] || r["Chi phí QC"] || r["Chi_phi_QC"] ||
                            r["Chi phí quảng cáo"] || r["Chi_phi_quang_cao"] ||
                            r["ADS"] || r["ads"] || 0;
                        const parsedCPQC = parseMoney(cpqcValue);
                        cpqcPeriod += parsedCPQC;
                    });

                    item.adsRate = doanhthuPeriod > 0 ? (cpqcPeriod / doanhthuPeriod) * 100 : 0;
                    item.cpqc = cpqcPeriod; 
                    item.doanhthu = doanhthuPeriod; 
                    item.teamName = "Bộ phận Marketing";
                } else {
                    item.adsRate = 0;
                    item.cpqc = 0;
                    item.doanhthu = doanhthuPeriod; 
                    item.teamName = "Bộ phận Marketing";
                }
                item.displayRate = item.adsRate.toFixed(1) + '%';
                item.formulaDisplay = `${formatMoney(item.doanhthu)} / ${formatMoney(item.cpqc)}`;
                item.shift = getStaffShift(item.name);
            });

            return { saleList, mktList };
        }

        function updateData() {
            const type = document.getElementById('period-type').value;
            const value = document.getElementById('period-value').value;

            const { start: wStart, end: wEnd } = getDateRange(type, value);
            const weekStats = calculateStats(wStart, wEnd);

            // Tháng 1 (value là '0')
            const { start: mStart, end: mEnd } = getDateRange('month', '0');
            const monthStats = calculateStats(mStart, mEnd);

            document.getElementById('date-range-display').innerText =
                `${wStart.getDate()}/${wStart.getMonth() + 1} - ${wEnd.getDate()}/${wEnd.getMonth() + 1}/${wEnd.getFullYear()}`;

            const filteredWeekMkt = weekStats.mktList.filter(item => item.adsRate <= 27);
            const filteredMonthMkt = monthStats.mktList.filter(item => item.adsRate <= 27);

            renderList('sale-list', weekStats.saleList.slice(0, 3), false);
            renderList('mkt-list', filteredWeekMkt.slice(0, 3), false);

            renderList('sale-month-list', monthStats.saleList.slice(0, 2), true);
            renderList('mkt-month-list', filteredMonthMkt.slice(0, 2), true);

            const bottomSale = [...weekStats.saleList]
                .sort((a, b) => a.rawVal - b.rawVal)
                .slice(0, 3);

            renderDangerList('danger-sale', bottomSale.map(x => ({
                displayText: `${abbreviateName(x.name)}(${formatMoneyForDanger(x.rawVal)})`
            })));

            const bottomMkt = [...weekStats.mktList]
                .filter(item => {
                    if (!hrDataMap || hrDataMap.size === 0) return true; 
                    const normalizedName = normalizeName(item.name);
                    return hrDataMap.has(normalizedName);
                })
                .sort((a, b) => a.rawVal - b.rawVal)
                .slice(0, 3);

            renderDangerList('danger-mkt', bottomMkt.map(x => ({
                displayText: `${abbreviateName(x.name)}(${formatMoneyForDanger(x.rawVal)})`
            })));

            setTimeout(() => {
                document.querySelectorAll('.bar-fill').forEach(bar => bar.style.width = bar.getAttribute('data-width'));
            }, 100);
        }

        function openTeamModal() {
            const type = document.getElementById('period-type').value;
            const value = document.getElementById('period-value').value;

            const { start, end } = getDateRange(type, value);
            const stats = calculateStats(start, end);

            let saleList = [...stats.saleList];
            let mktList = [...stats.mktList].filter(item => item.adsRate <= 27);

            if (saleList.length > 0) {
                const maxSale = saleList[0].rawVal;
                saleList.forEach(i => i.percent = maxSale > 0 ? (i.rawVal / maxSale) * 100 : 0);
            }

            if (mktList.length > 0) {
                const maxMkt = mktList[0].rawVal;
                mktList.forEach(i => i.percent = maxMkt > 0 ? (i.rawVal / maxMkt) * 100 : 0);
            }

            renderList('team-sale-list', saleList, false);
            renderList('team-mkt-list', mktList, false);

            const modal = document.getElementById('teamModal');
            modal.style.display = 'block';
            setTimeout(() => {
                modal.querySelectorAll('.bar-fill').forEach(bar => bar.style.width = bar.getAttribute('data-width'));
            }, 100);
        }

        function closeTeamModal() {
            document.getElementById('teamModal').style.display = 'none';
        }

        window.onclick = function (event) {
            const modal = document.getElementById('teamModal');
            if (event.target == modal) {
                closeTeamModal();
            }
        }

        function renderList(containerId, data, isSmall) {
            const container = document.getElementById(containerId);
            if (!data.length) {
                container.innerHTML = '<div style="text-align:center;color:#999;padding:10px;grid-column: 1 / -1;">Chưa có dữ liệu</div>';
                return;
            }

            if (isSmall) {
                renderMonthList(containerId, data);
                return;
            }

            const isSaleBoard = containerId.includes('sale');
            const isMktBoard = containerId.includes('mkt');

            let html = '';
            data.forEach((item, index) => {
                const rank = index + 1;
                const smallClass = 'week-size';
                const crownHtml = rank === 1 ? '<i class="fa-solid fa-crown avatar-crown"></i>' : '';
                const shortName = abbreviateName(item.name);

                let rateHtml = '';
                if (isSaleBoard && item.closeRate) {
                    rateHtml = `<div style="font-size: 0.65vw; color: #666; margin-top: 0.2vh; line-height: 1.4;">
                        <div style="font-weight: 600; color: #007bff;">Tỉ lệ chốt: ${item.closeRate}</div>
                        <div style="font-size: 0.6vw; color: #28a745;">DS: ${formatMoney(item.doanhthu || 0)}</div>
                        <div style="font-size: 0.6vw; color: #ff9800;">Mess: ${(item.totalMess || 0).toLocaleString()}</div>
                    </div>`;
                } else if (isMktBoard && item.displayRate) {
                    rateHtml = `<div style="font-size: 0.65vw; color: #666; margin-top: 0.2vh; line-height: 1.4;">
                        <div style="font-weight: 600; color: #ff6b6b;">ADS: ${item.displayRate}</div>
                        <div style="font-size: 0.6vw; color: #28a745;">DS: ${formatMoney(item.doanhthu || 0)}</div>
                        <div style="font-size: 0.6vw; color: #dc3545;">CPQC: ${formatMoney(item.cpqc || 0)}</div>
                    </div>`;
                }

                let hash = 0;
                for (let i = 0; i < item.name.length; i++) hash = item.name.charCodeAt(i) + ((hash << 5) - hash);
                const fallbackAvatar = `https://i.pravatar.cc/150?img=${Math.abs(hash % 70)}`;

                html += `
                    <div class="rank-item top-${rank} ${smallClass}">
                        <div class="rank-pos rank-${rank}">#${rank}</div>
                        <div class="user-info-group">
                            <div style="position:relative;">
                                ${crownHtml}
                                <img src="${item.avatar}" class="avatar" onerror="this.onerror=null; this.src='${fallbackAvatar}';">
                            </div>
                            <div class="info-text">
                                <div class="name">${shortName}</div>
                                ${rateHtml}
                            </div>
                        </div>
                        <div class="bar-container">
                            <div class="bar-fill" style="width: 0%" data-width="${item.percent}%">
                                ${item.value}
                            </div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
            setTimeout(() => {
                container.querySelectorAll('.bar-fill').forEach(bar => {
                    bar.style.width = bar.getAttribute('data-width');
                });
            }, 100);
        }

        function renderMonthList(containerId, data) {
            const container = document.getElementById(containerId);
            if (!data.length) {
                container.innerHTML = '<div style="text-align:center;color:#999;padding:10px;">Chưa có dữ liệu</div>';
                return;
            }

            let html = '';
            data.forEach((item, index) => {
                const rank = index + 1;
                const shortName = abbreviateName(item.name);

                html += `
                    <div class="month-rank-item top-${rank}">
                        <div class="month-rank-pos rank-${rank}">#${rank}</div>
                        <div class="month-name">${shortName}</div>
                        <div class="month-value">(${item.value})</div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function renderDangerList(containerId, list) {
            const container = document.getElementById(containerId);
            if (!list.length) {
                container.innerHTML = '<div style="width:100%;text-align:center;color:#aaa;font-size:0.9rem;">Không có ai</div>';
                return;
            }

            let html = '';
            list.forEach((item, index) => {
                const displayText = item.displayText || (item.name + (item.value ? `(${item.value})` : ''));
                html += `<div class="danger-name-item">${displayText}</div>`;
            });
            container.innerHTML = html;
        }

        function initWeekFilter() {
            const currentWeek = getCurrentWeek();
            const periodValueSelect = document.getElementById('period-value');
            if (periodValueSelect) {
                periodValueSelect.value = currentWeek;
            }
        }

        initWeekFilter();
        loadData();

        setTimeout(function () {
            location.reload();
        }, 300000);

    </script>
</body>

</html>

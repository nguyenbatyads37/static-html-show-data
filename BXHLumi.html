<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bảng Xếp Hạng Lumi</title>
    <!-- Font Awesome cho Icon Cúp -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Font -->
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&family=Roboto:wght@400;500;700;900&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-primary: #333;
            --text-secondary: #666;
            --brand-color: #28a745;
            --sale-gradient: linear-gradient(90deg, #2E3192 0%, #1BFFFF 100%);
            /* Blue đậm hơn chút cho rõ */
            --mkt-gradient: linear-gradient(90deg, #FDB931 0%, #F57F17 100%);
            /* Cam nhạt -> Cam đậm */
            /* Màu sắc Top 3 rực rỡ hơn */
            --gold: #FFD700;
            --gold-glow: rgba(255, 215, 0, 0.6);
            --silver: #C0C0C0;
            --silver-glow: rgba(192, 192, 192, 0.6);
            --bronze: #CD7F32;
            --bronze-glow: rgba(205, 127, 50, 0.6);
            --dark-bg: #1a1a2e;
            /* Màu nền cho phần Best Month */
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px 0;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            min-height: 100vh;
        }

        /* --- HEADER CONTAINER --- */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            width: 100%;
            max-width: 100%;
            margin-bottom: 20px;
            padding: 10px 20px;
            padding-bottom: 0;
            position: relative;
        }

        /* --- Header Branding LUMI --- */
        .brand-section {
            text-align: left;
            animation: fadeInLeft 0.8s ease-out;
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            gap: 0;
        }

        .lumi-text-wrapper {
            display: flex;
            flex-direction: column;
            gap: 0;
            line-height: 0;
        }

        .brand-row {
            display: flex;
            align-items: center;
            gap: 0;
        }

        .lumi-logo {
            width: auto;
            height: calc(4.5rem * 0.9 * 3);
            flex-shrink: 0;
            object-fit: contain;
            object-position: left center;
            display: block;
            mix-blend-mode: multiply;
            margin-left: -35px;
            margin-right: 0;
        }

        .lumi-brand {
            font-family: 'Montserrat', sans-serif;
            font-weight: 900;
            font-size: 5.5rem;
            letter-spacing: 5px;
            margin: 0;
            margin-right: -20px;
            padding: 0;
            background: linear-gradient(to right, #11998e, #38ef7d);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
            line-height: 0.85;
            white-space: nowrap;
            display: block;
            text-align: left;
        }

        .lumi-subtitle {
            font-size: 1.8rem;
            color: var(--text-secondary);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin: 0;
            margin-top: -30px;
            margin-left: 0;
            padding-left: 0;
            line-height: 1;
            padding-top: 0;
            padding-bottom: 0;
            text-align: left;
            display: block;
        }

        /* --- TOOLBAR (Thanh công cụ) --- */
        .toolbar {
            display: flex;
            gap: 15px;
            background: #fff;
            padding: 10px 20px;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            animation: fadeInRight 0.8s ease-out;
            height: fit-content;
            margin-top: 0;
            margin-bottom: 0;
            align-self: flex-start;
            position: absolute;
            right: 0;
            top: calc(4.5rem * 0.85 + 1rem - 30px + 60px);
        }

        .filter-select {
            padding: 10px 20px;
            border-radius: 25px;
            border: 1px solid #ddd;
            font-family: 'Roboto', sans-serif;
            font-weight: 500;
            color: var(--text-primary);
            outline: none;
            cursor: pointer;
            transition: all 0.3s;
            background-color: #f9f9f9;
        }

        .filter-select:hover,
        .filter-select:focus {
            border-color: var(--brand-color);
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
            background-color: #fff;
        }

        /* --- Container Layout --- */
        .container {
            display: flex;
            gap: 30px;
            width: 100%;
            max-width: 100%;
            flex-wrap: nowrap;
            justify-content: stretch;
            margin-bottom: 10px;
            padding: 0 20px;
            box-sizing: border-box;
        }

        .board {
            flex: 1;
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            padding: 25px;
            min-width: 350px;
            overflow: hidden;
            position: relative;
        }

        .board::before {
            content: "LUMI";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-30deg);
            font-size: 100px;
            font-weight: 900;
            color: rgba(0, 0, 0, 0.02);
            z-index: 0;
            pointer-events: none;
        }

        .board-header {
            text-align: center;
            margin-bottom: 25px;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 2px solid #eee;
            padding-bottom: 15px;
            position: relative;
            z-index: 1;
        }

        .board-header h2 {
            margin: 0;
            font-size: 24px;
            color: var(--text-primary);
        }

        .board.sale .board-header h2 {
            color: #007bff;
        }

        .board.mkt .board-header h2 {
            color: #ff6b6b;
        }

        /* Item Row Styling */
        .rank-item {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            padding: 15px;
            border-radius: 15px;
            transition: transform 0.3s, box-shadow 0.3s;
            background: #fff;
            position: relative;
            z-index: 1;
            border: 1px solid transparent;
            width: 100%;
            box-sizing: border-box;
            gap: 0;
        }

        /* Đảm bảo các rank-item trong cùng container có cùng layout */
        #sale-list .rank-item,
        #mkt-list .rank-item,
        #sale-month-top3-list .rank-item,
        #mkt-month-top3-list .rank-item {
            display: flex;
            align-items: center;
            width: 100%;
        }

        .rank-item:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .rank-item.top-1 {
            border: 1px solid rgba(255, 215, 0, 0.3);
            background: linear-gradient(to right, #fffff0, #fff);
            overflow: visible;
        }

        .rank-item.top-2 {
            border: 1px solid rgba(192, 192, 192, 0.3);
            background: linear-gradient(to right, #f8f9fa, #fff);
        }

        .rank-item.top-3 {
            border: 1px solid rgba(205, 127, 50, 0.3);
            background: linear-gradient(to right, #fff5ee, #fff);
        }

        .rank-pos {
            width: 50px;
            /* Có thể thu nhỏ nếu cần, nhưng 50px là ổn */
            font-weight: 900;
            font-size: 24px;
            color: #999;
            text-align: center;
            margin-right: 5px;
            /* Giảm margin để dồn chỗ cho avatar */
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
        }

        /* Ẩn hẳn Trophy Icon */
        .fa-trophy {
            display: none !important;

        }

        .trophy-gold {
            color: var(--gold);
            font-size: 42px;
            filter: drop-shadow(0 0 8px var(--gold-glow));
            animation: trophyPulseTop1 2s infinite ease-in-out;
        }

        .trophy-silver {
            color: var(--silver);
            font-size: 38px;
            filter: drop-shadow(0 0 6px rgba(192, 192, 192, 0.6));
        }

        .trophy-bronze {
            color: var(--bronze);
            font-size: 36px;
            filter: drop-shadow(0 0 4px rgba(205, 127, 50, 0.5));
        }

        .rank-1 {
            color: var(--gold);
            font-size: 42px;
            font-weight: 900;
            filter: drop-shadow(0 0 8px var(--gold-glow));
        }

        .rank-2 {
            color: var(--silver);
            font-size: 32px;
            font-weight: 700;
        }

        .rank-3 {
            color: var(--bronze);
            font-size: 32px;
            font-weight: 700;
        }

        .user-info {
            display: flex;
            align-items: center;
            width: 240px;
            flex-shrink: 0;
            margin-left: 20px;
        }

        /* User info với avatar bên trái */
        .user-info-with-avatar {
            display: flex;
            align-items: center;
            flex-shrink: 0;
            flex: 1;
        }

        .avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #fff;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            margin-right: 15px;
            position: relative;
        }

        .avatar-crown {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            color: var(--gold);
            font-size: 24px;
            filter: drop-shadow(0 0 10px var(--gold-glow));
            z-index: 10;
            animation: crownBounce 2s infinite ease-in-out;
        }

        @keyframes crownBounce {

            0%,
            100% {
                transform: translateX(-50%) translateY(0);
            }

            50% {
                transform: translateX(-50%) translateY(-5px);
            }
        }

        .rank-1+.user-info .avatar {
            border-color: var(--gold);
        }

        /* Tùy chỉnh màu số thứ hạng Top 3 thay cho cúp */
        .rank-pos.rank-1 {
            color: var(--gold);
            font-size: 40px;
            text-shadow: 0 0 10px var(--gold-glow);
        }

        .rank-pos.rank-2 {
            color: var(--silver);
            font-size: 35px;
        }

        .rank-pos.rank-3 {
            color: var(--bronze);
            font-size: 30px;
        }

        .rank-2+.user-info .avatar {
            border-color: var(--silver);
        }

        .rank-3+.user-info .avatar {
            border-color: var(--bronze);
        }

        /* Avatar ở đầu thanh bar - border màu theo rank */
        .rank-item.top-1 .avatar-at-start {
            border-color: var(--gold);
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
        }

        .rank-item.top-2 .avatar-at-start {
            border-color: var(--silver);
            box-shadow: 0 4px 15px rgba(192, 192, 192, 0.4);
        }

        .rank-item.top-3 .avatar-at-start {
            border-color: var(--bronze);
            box-shadow: 0 4px 15px rgba(205, 127, 50, 0.4);
        }

        .name {
            font-weight: 700;
            font-size: 18px;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .role {
            font-size: 13px;
            color: #888;
            font-weight: 400;
            margin-top: 4px;
        }

        .bar-container {
            flex: 1;
            background-color: #e9ecef;
            border-radius: 20px;
            height: 50px;
            /* Giảm chiều cao thanh bar */
            position: relative;
            overflow: visible;
            /* Để hiển thị số tiền to ra ngoài nếu cần, hoặc hidden tùy layout */
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05);
            margin-left: 10px;
            margin-right: 0;
            display: flex;
            align-items: center;
            padding: 0;
        }

        .avatar-on-bar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #fff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            display: block;
        }

        .avatar-on-bar-wrapper {
            position: relative;
            flex-shrink: 0;
            z-index: 20;
            pointer-events: none;
        }

        /* Avatar to ra */
        .avatar-at-start {
            width: 110px;
            height: 110px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #fff;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            flex-shrink: 0;
            position: relative;
            z-index: 10;
        }

        .avatar-at-start-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            flex-shrink: 0;
            margin-right: 15px;
        }

        /* Wrapper cho avatar + user info để đảm bảo thanh bar thẳng hàng */
        .user-avatar-group {
            display: flex;
            align-items: center;
            width: 330px;
            /* Tăng width container chứa avatar + tên */
            min-width: 330px;
            flex-shrink: 0;
        }

        .bar-fill {
            height: 100%;
            width: 100%;
            border-radius: 20px;
            position: absolute;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            z-index: 1;
            margin: 0;
            padding: 0;
            overflow: visible;
        }

        .bar-fill-colored {
            height: 100%;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 15px;
            font-weight: 900;
            font-size: 26px;
            /* To tiền lên */
            width: 0%;
            transition: width 1.5s cubic-bezier(0.22, 1, 0.36, 1);
            white-space: nowrap;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .bar-fill-colored span {
            z-index: 2;
            position: relative;
            flex-shrink: 0;
        }

        #sale-month-top3-list .rank-item:last-child,
        #mkt-month-top3-list .rank-item:last-child {
            margin-bottom: 0;
        }

        .board.sale .bar-fill-colored {
            background: var(--sale-gradient);
            color: #003e80;
            text-shadow: 0px 1px 0px rgba(255, 255, 255, 0.4);
        }

        .board.mkt .bar-fill-colored {
            background: var(--mkt-gradient);
            color: #a01a2a;
            text-shadow: 0px 1px 0px rgba(255, 255, 255, 0.4);
        }

        /* --- BEST OF THE MONTH SECTION --- */
        .best-month-section {
            width: 100%;
            max-width: 1100px;
            margin-top: 10px;
            padding-top: 30px;
            border-top: 2px dashed #ccc;
            text-align: center;
        }

        .best-header {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.2rem;
            font-weight: 900;
            text-transform: uppercase;
            margin-bottom: 30px;
            color: #2c3e50;
            text-shadow: 2px 2px 0px rgba(0, 0, 0, 0.1);
        }

        .best-header span {
            color: #d35400;
        }

        .month-summary-container {
            display: flex;
            justify-content: center;
            gap: 40px;
            flex-wrap: wrap;
        }

        /* Khung chung cho mỗi bộ phận */
        .dept-card {
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
            width: 420px;
            padding: 20px;
            position: relative;
            border: 1px solid #eee;
            transition: transform 0.3s;
        }

        .dept-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
        }

        .dept-card.sale-dept {
            border-top: 5px solid #007bff;
        }

        .dept-card.mkt-dept {
            border-top: 5px solid #ff6b6b;
        }

        .dept-title {
            text-transform: uppercase;
            font-weight: 800;
            font-size: 1.2rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .sale-dept .dept-title {
            color: #007bff;
        }

        .mkt-dept .dept-title {
            color: #ff6b6b;
        }

        /* Layout Grid 2 cột cho các items trong tháng */
        .month-items-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        /* Style cho item nhỏ trong bảng tháng - DẠNG DỌC (Compact) */
        .mini-item {
            display: flex;
            flex-direction: column;
            /* Xếp dọc */
            align-items: center;
            text-align: center;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 8px 6px;
            border: 1px solid transparent;
            position: relative;
        }

        .mini-item.rank-1-mini {
            background: linear-gradient(to bottom, #fffdf0, #fff);
            border: 1px solid rgba(255, 215, 0, 0.4);
        }

        .mini-item.rank-2-mini {
            background: linear-gradient(to bottom, #fbfbfb, #fff);
            border: 1px solid rgba(192, 192, 192, 0.4);
        }

        .mini-item.rank-3-mini {
            background: linear-gradient(to bottom, #fef9f5, #fff);
            border: 1px solid rgba(205, 127, 50, 0.4);
        }


        .mini-avatar-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 4px;
            position: relative;
        }

        .mini-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .rank-1-mini .mini-avatar-wrapper .mini-avatar {
            border-color: var(--gold);
        }

        .rank-2-mini .mini-avatar-wrapper .mini-avatar {
            border-color: var(--silver);
        }

        .rank-3-mini .mini-avatar-wrapper .mini-avatar {
            border-color: var(--bronze);
        }

        .mini-rank-top {
            font-weight: bold;
            font-size: 1.2rem;
            margin-bottom: 8px;
            color: #666;
        }

        .rank-1-mini .mini-rank-top {
            color: #ff8c00;
        }

        .rank-2-mini .mini-rank-top {
            color: #999;
        }

        .mini-info {
            width: 100%;
        }

        .mini-name {
            font-weight: 600;
            font-size: 11px;
            color: #333;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .mini-value {
            font-size: 10px;
            font-weight: 600;
            color: #666;
        }

        .sale-dept .mini-value {
            color: #0056b3;
        }

        .mkt-dept .mini-value {
            color: #c0392b;
        }

        /* Huy chương bên trái avatar */
        .mini-medal {
            font-size: 14px;
            margin-right: 4px;
            z-index: 2;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        }

        .medal-gold {
            color: var(--gold);
            filter: drop-shadow(0 0 8px var(--gold-glow));
        }

        .medal-silver {
            color: var(--silver);
            filter: drop-shadow(0 0 6px var(--silver-glow));
        }

        /* --- DANGER ZONE (SPLIT INTO 2) --- */
        .danger-section {
            width: 100%;
            max-width: 100%;
            margin-top: 10px;
            margin-bottom: 30px;
            margin-left: 20px;
            margin-right: 20px;
            background: #fff5f5;
            border: 1px solid #ffebeb;
            border-radius: 20px;
            padding: 25px;
            box-sizing: border-box;
        }

        .danger-header {
            font-family: 'Montserrat', sans-serif;
            font-size: 1rem;
            font-weight: 700;
            color: #c0392b;
            text-transform: uppercase;
            margin-bottom: 25px;
            text-align: center;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        /* Chia cột cho Danger Zone */
        .danger-split-container {
            display: flex;
            gap: 30px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .danger-col {
            flex: 1;
            min-width: 300px;
            background: rgba(255, 255, 255, 0.6);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid #ffcccc;
        }

        .danger-col-title {
            text-align: center;
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 15px;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .col-sale-title {
            color: #007bff;
        }

        .col-mkt-title {
            color: #ff6b6b;
        }

        .danger-list {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }

        .name-tag {
            background: #fff;
            color: #555;
            padding: 8px 15px;
            border-radius: 50px;
            font-weight: 500;
            font-size: 13px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border: 1px solid #eee;
            transition: all 0.2s;
            display: flex;
            align-items: center;
        }

        .name-tag:hover {
            border-color: #e74c3c;
            color: #e74c3c;
            transform: translateY(-2px);
        }

        .name-tag i {
            margin-right: 8px;
            color: #e74c3c;
            font-size: 12px;
        }

        /* --- BẢNG THỐNG KÊ SỐ MESS VÀ SỐ ĐƠN F3 --- */
        .staff-stats-section {
            width: 100%;
            max-width: 100%;
            margin-top: 30px;
            margin-bottom: 30px;
            margin-left: 20px;
            margin-right: 20px;
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            padding: 25px;
            box-sizing: border-box;
        }

        .stats-header {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.2rem;
            font-weight: 900;
            color: #2c3e50;
            text-transform: uppercase;
            margin-bottom: 25px;
            text-align: center;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .stats-table-container {
            overflow-x: auto;
        }

        .stats-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .stats-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .stats-table th {
            padding: 15px;
            text-align: left;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 13px;
        }

        .stats-table th:first-child {
            border-top-left-radius: 10px;
        }

        .stats-table th:last-child {
            border-top-right-radius: 10px;
        }

        .stats-table tbody tr {
            border-bottom: 1px solid #e9ecef;
            transition: background-color 0.2s;
        }

        .stats-table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .stats-table tbody tr:last-child {
            border-bottom: none;
        }

        .stats-table td {
            padding: 12px 15px;
            color: #333;
        }

        .stats-table td:first-child {
            font-weight: 600;
            color: #2c3e50;
        }

        .stats-table .number-cell {
            text-align: right;
            font-weight: 600;
            font-family: 'Roboto', monospace;
        }

        .stats-table .mess-cell {
            color: #007bff;
        }

        .stats-table .order-cell {
            color: #28a745;
        }

        @keyframes bounce {

            0%,
            20%,
            50%,
            80%,
            100% {
                transform: translateY(0);
            }

            40% {
                transform: translateY(-5px);
            }

            60% {
                transform: translateY(-3px);
            }
        }

        @keyframes fadeInLeft {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes trophyPulse {
            0% {
                transform: scale(1);
                filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0));
            }

            50% {
                transform: scale(1.15);
            }

            100% {
                transform: scale(1);
                filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0));
            }
        }

        .rank-1 .fa-trophy {
            animation: trophyPulseTop1 2s infinite ease-in-out;
        }

        @keyframes trophyPulseTop1 {
            0% {
                transform: scale(1) rotate(0deg);
                filter: drop-shadow(0 0 10px var(--gold-glow));
            }

            50% {
                transform: scale(1.2) rotate(5deg);
                filter: drop-shadow(0 0 20px var(--gold));
            }

            100% {
                transform: scale(1) rotate(0deg);
                filter: drop-shadow(0 0 10px var(--gold-glow));
            }
        }

        @media (max-width: 768px) {
            .app-header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }

            .brand-section {
                text-align: center;
                flex-direction: column;
                align-items: center;
            }

            .lumi-text-wrapper {
                align-items: center;
            }

            .brand-row {
                flex-direction: column;
                gap: 15px;
            }

            .lumi-logo {
                width: 350px;
                height: 8rem;
            }

            .lumi-brand {
                font-size: 4.5rem;
            }

            .container {
                flex-direction: column;
            }

            .user-info {
                width: 150px;
            }

            .avatar {
                width: 60px;
                height: 60px;
            }

            .name {
                font-size: 15px;
            }

            .bar-fill {
                font-size: 13px;
            }

            .fa-trophy {
                font-size: 24px;
            }

            .rank-1 .fa-trophy {
                font-size: 30px;
            }

            .month-summary-container {
                flex-direction: column;
                align-items: center;
            }

            .dept-card {
                width: 100%;
                max-width: 350px;
            }

            .danger-split-container {
                flex-direction: column;
            }
        }
    </style>
</head>

<body>

    <!-- HEADER CONTAINER -->
    <div class="app-header">
        <div class="brand-section">
            <div class="lumi-text-wrapper">
                <div class="brand-row">
                    <h1 class="lumi-brand">LUMI</h1>
                    <img src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Ff930e667.%E1%BA%A2nh.025539.jpg"
                        alt="LUMI GLOBAL Logo" class="lumi-logo">
                </div>
                <div class="lumi-subtitle">Bảng Vinh Danh Tuần</div>
            </div>
        </div>

        <!-- TOOLBAR -->
        <div class="toolbar">
            <select class="filter-select" id="period-type" onchange="updateData()">
                <option value="week">Theo Tuần</option>
                <option value="month">Theo Tháng</option>
            </select>

            <select class="filter-select" id="period-value" onchange="updateData()">
                <option value="w1">Tuần 1 (T12)</option>
                <option value="w2">Tuần 2 (T12)</option>
                <option value="w3">Tuần 3 (T12)</option>
            </select>
        </div>
    </div>

    <!-- TOP 3 BOARDS (BEST OF WEEK) -->
    <div class="container">

        <!-- BẢNG SALES -->
        <div class="board sale" style="display: flex; flex-direction: column;">
            <div class="board-header">
                <h2><i class="fa-solid fa-chart-line"></i> TOP DOANH SỐ TUẦN - SALE</h2>
            </div>
            <div id="sale-list" style="display: flex; flex-direction: column; width: 100%;">
                <!-- Data sẽ được render ở đây -->
            </div>



            <!-- BEST OF THE MONTH HEADER -->
            <div style="display: flex; align-items: center; justify-content: center; margin: 15px 0 0 0;">
                <div class="best-header" style="margin: 0;">
                    <i class="fa-solid fa-calendar-check" style="color: gold;"></i> Best of <span>The Month</span>
                </div>
            </div>

            <!-- TOP 2 DƯỚI "BEST OF THE MONTH" -->
            <div class="dept-card sale-dept"
                style="width: 100%; margin-top: 20px; box-shadow: none; border: none; padding: 0; border-radius: 0;">
                <div id="sale-month-list" class="month-items-grid">
                    <!-- Top 2 sẽ được render ở đây -->
                </div>
            </div>

        </div>

        <!-- BẢNG MARKETING -->
        <div class="board mkt" style="display: flex; flex-direction: column;">
            <div class="board-header">
                <h2><i class="fa-solid fa-bullhorn"></i> TOP DOANH SỐ TUẦN - MKT</h2>
            </div>
            <div id="mkt-list" style="display: flex; flex-direction: column; width: 100%;">
                <!-- Data sẽ được render ở đây -->
            </div>

            <!-- BEST OF THE MONTH HEADER -->
            <div style="display: flex; align-items: center; justify-content: center; margin: 20px 0;">
                <div class="best-header" style="margin: 0;">
                    <i class="fa-solid fa-calendar-check" style="color: gold;"></i> Best of <span>The Month</span>
                </div>
            </div>

            <!-- TOP 2 DƯỚI "BEST OF THE MONTH" -->
            <div class="dept-card mkt-dept"
                style="width: 100%; margin-top: 20px; box-shadow: none; border: none; padding: 0; border-radius: 0;">
                <div id="mkt-month-list" class="month-items-grid">
                    <!-- Top 2 sẽ được render ở đây -->
                </div>
            </div>
        </div>

    </div>

    <!-- DANH SÁCH NHÂN SỰ CHƯA ĐẠT CHỈ TIÊU (SPLIT INTO 2) -->
    <div class="danger-section">
        <div class="danger-header">
            <i class="fa-solid fa-triangle-exclamation"></i> Danh Sách Nhân Sự Chưa Đạt Chỉ Tiêu
        </div>

        <div class="danger-split-container">

            <!-- Cột Sale K Đạt -->
            <div class="danger-col">
                <div class="danger-col-title col-sale-title">
                    <i class="fa-solid fa-chart-line"></i> Sale có tỷ lệ chốt < 7% </div>
                        <div class="danger-list" id="underperform-sale">
                            <!-- Sale data -->
                        </div>
                </div>

                <!-- Cột MKT K Đạt -->
                <div class="danger-col">
                    <div class="danger-col-title col-mkt-title">
                        <i class="fa-solid fa-bullhorn"></i> MKT có Ads/DS > 32%
                    </div>
                    <div class="danger-list" id="underperform-mkt">
                        <!-- MKT data -->
                    </div>
                </div>

            </div>
        </div>

        <!-- CONTAINER CHO 2 BẢNG THỐNG KÊ (CẠNH NHAU) -->
        <!-- ẨN 2 BẢNG THỐNG KÊ -->
        <div style="display: none; gap: 30px; width: 100%; max-width: 100%; margin: 30px 20px; flex-wrap: wrap;">
            <!-- BẢNG THỐNG KÊ SỐ MESS VÀ SỐ ĐƠN F3 -->
            <div class="staff-stats-section" style="flex: 1; min-width: 400px;">
                <div class="stats-header">
                    <i class="fa-solid fa-table"></i> Thống Kê Số Mess và Số Đơn F3
                </div>
                <div class="stats-table-container">
                    <table class="stats-table">
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>Tên Nhân Sự</th>
                                <th class="number-cell">Số Mess</th>
                                <th class="number-cell">Số Đơn F3</th>
                            </tr>
                        </thead>
                        <tbody id="staff-stats-body">
                            <!-- Data sẽ được render ở đây -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- BẢNG THỐNG KÊ MKT -->
            <div class="staff-stats-section" style="flex: 1; min-width: 400px;">
                <div class="stats-header" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
                    <i class="fa-solid fa-bullhorn"></i> Thống Kê MKT
                </div>
                <div class="stats-table-container">
                    <table class="stats-table">
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>Tên Nhân Sự</th>
                                <th class="number-cell">CPQC</th>
                                <th class="number-cell">Doanh Số</th>
                                <th class="number-cell">ADS/DS</th>
                            </tr>
                        </thead>
                        <tbody id="staff-mkt-body">
                            <!-- Data sẽ được render ở đây -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <script>
            // URL dữ liệu
            const F3_URL = 'https://lumi-6dff7-default-rtdb.asia-southeast1.firebasedatabase.app/datasheet/F3.json';
            const HR_URL = 'https://lumi-6dff7-default-rtdb.asia-southeast1.firebasedatabase.app/datasheet/Nh%C3%A2ns%E1%BB%B1';
            const SALE_REPORT_URL = 'https://n-api-gamma.vercel.app/report/generate?tableName=Báo cáo sale';
            const MKT_REPORT_URL = 'https://n-api-gamma.vercel.app/report/generate?tableName=Báo cáo MKT';

            // Fallback sample (tương tự KPIsale.html) phòng khi lỗi mạng/CORS
            const F3_SAMPLE = {
                "0": {
                    "Add": "3 Seneca Court",
                    "Ca": "Giữa ca",
                    "City": "Streamwood",
                    "Giá bán": 179,
                    "Giá gốc": 179,
                    "Hình thức thanh toán": "Zelle",
                    "Khu vực": "US",
                    "Kết quả Check": "Vận đơn XL",
                    "Loại tiền thanh toán": "USD",
                    "Màu backlist": "Khách mới",
                    "Mã đơn hàng": "Keme1f8aba6",
                    "Mặt hàng": "Kem Body",
                    "NV Vận đơn": "test",
                    "Name*": "Luz Adaya",
                    "Ngày lên đơn": "2025-12-05T17:00:00.000Z",
                    "Nhân viên Marketing": "Nguyễn Quang Trường",
                    "Nhân viên Sale": "Hoàng Thị Uyên",
                    "Phone*": 6302443988,
                    "Phí ship": 0,
                    "State": "Illinois",
                    "Số lượng mặt hàng 1": 5,
                    "Số tiền thực thu": 0,
                    "Team": "Hà Nội",
                    "Thời gian lên đơn": "2025-07-25T23:01:51.000Z",
                    "Tiền Việt đã đối soát": 0,
                    "Tiền chiết khấu": 0,
                    "Trạng thái đơn": "Đơn hợp lệ",
                    "Tên lên đơn": "Luz Adaya",
                    "Tên mặt hàng 1": "Kem Body",
                    "Tên mặt hàng 2": "Kem Body",
                    "Tên page": "Venature Glutathione Body Lotion 50x Tone Up US - Beauty & Health",
                    "Tổng số tiền từ FFM": 0,
                    "Tổng tiền VNĐ": 4296000,
                    "Xác nhận đơn": "Đã xác nhận TT khách , Đã Xác nhận TT đơn , Đã xác nhận TT giao hàng , Đã xác nhận TT thanh toán",
                    "Zipcode": 60107,
                    "in": 7
                }
            };

            // Biến toàn cục lưu dữ liệu gốc
            let allOrders = [];
            let hrData = []; // Data nhân sự
            let salesReportData = []; // Data báo cáo sale từ API mới
            let mktReportData = []; // Data báo cáo MKT từ API (CPQC, Doanh số)

            // Khởi tạo các biến data hiển thị
            let mktData = [];
            let saleMonthData = [];
            let saleMonthDataBottom = [];
            let mktMonthData = [];
            let mktMonthDataBottom = [];
            let underperformSale = [];
            let underperformMkt = [];



            // Map tên nhân viên sang Avatar (Hardcode tạm hoặc dùng placeholder)
            // Trong thực tế có thể lấy từ HR Data nếu có ảnh
            const avatarMap = {
                "Nguyễn Văn A": "https://i.pravatar.cc/150?img=11",
                "Trần Thị B": "https://i.pravatar.cc/150?img=5",
                "Lê Văn C": "https://i.pravatar.cc/150?img=3",
                // Thêm các mapping khác nếu cần, default sẽ random hoặc cố định
            };

            function getAvatar(name) {
                // 1. Check Hardcode Map
                if (avatarMap[name]) return avatarMap[name];

                if (hrData.length > 0) {
                    const staff = hrData.find(r =>
                        (r['Tên'] && r['Tên'].trim() === name.trim()) ||
                        (r['Họ và tên'] && r['Họ và tên'].trim() === name.trim()) ||
                        (r['Họ Và Tên'] && r['Họ Và Tên'].trim() === name.trim()) ||
                        (r['Name'] && r['Name'].trim() === name.trim())
                    );
                    // Giả định cột ảnh tên là "Avatar", "Ảnh", "Image", hoặc "Link ảnh"
                    if (staff) {
                        const imgUrl = staff['Avatar'] || staff['Ảnh'] || staff['Image'] || staff['Link ảnh'] || staff['Link_ảnh'];
                        if (imgUrl) return imgUrl;
                    }
                }

                // 3. Fallback: Generate avatar dựa trên tên
                let hash = 0;
                for (let i = 0; i < name.length; i++) {
                    hash = name.charCodeAt(i) + ((hash << 5) - hash);
                }
                const imgId = Math.abs(hash % 70); // 70 ảnh mẫu
                return `https://i.pravatar.cc/150?img=${imgId}`;
            }

            // Hàm chuẩn hóa dữ liệu F3 (tương tự file KPIsale.html)
            function normalizeF3(data) {
                if (Array.isArray(data)) return data;
                if (data && typeof data === 'object') {
                    try {
                        return Object.values(data).filter(r => r && typeof r === 'object');
                    } catch (_) { return []; }
                }
                return [];
            }

            // Hàm parse chuỗi tiền tệ (VD: "500.000" -> 500000)
            function parseMoney(moneyStr) {
                if (typeof moneyStr === 'number') return moneyStr;
                if (!moneyStr) return 0;
                return parseInt(String(moneyStr).replace(/\./g, '').replace(/,/g, '').replace(/\D/g, '')) || 0;
            }

            // Hàm tính độ tương đồng giữa 2 tên (0-1)
            function calculateNameSimilarity(name1, name2) {
                if (name1 === name2) return 1.0;
                if (!name1 || !name2) return 0;
                
                // Chuyển sang lowercase và normalize
                const n1 = name1.trim().toLowerCase().replace(/\s+/g, ' ');
                const n2 = name2.trim().toLowerCase().replace(/\s+/g, ' ');
                
                // Kiểm tra contains
                if (n1.includes(n2) || n2.includes(n1)) {
                    const shorter = Math.min(n1.length, n2.length);
                    const longer = Math.max(n1.length, n2.length);
                    return longer > 0 ? shorter / longer : 0;
                }
                
                // Tính độ tương đồng bằng cách đếm từ khớp
                const words1 = n1.split(/\s+/).filter(w => w.length > 0);
                const words2 = n2.split(/\s+/).filter(w => w.length > 0);
                let matchCount = 0;
                let totalWords = Math.max(words1.length, words2.length);
                
                if (totalWords === 0) return 0;
                
                words1.forEach(w1 => {
                    if (words2.some(w2 => w1 === w2 || w1.includes(w2) || w2.includes(w1))) {
                        matchCount++;
                    }
                });
                
                return matchCount / totalWords;
            }

            // Hàm format tiền tệ (Đã chỉnh sửa làm tròn số nguyên)
            function formatMoney(num) {
                // Nếu không có dữ liệu trả về 0
                if (!num) return '0';
                
                // Nếu >= 1 triệu
                if (num >= 1000000) {
                    // Chia cho 1 triệu và làm tròn (Math.round) để lấy số nguyên
                    // Ví dụ: 166,7 -> 167
                    let millions = Math.round(num / 1000000);
                    return millions + ' Tr';
                }
                
                // Với số nhỏ hơn 1 triệu, cũng làm tròn thành số nguyên và thêm dấu phẩn cách
                return Math.round(num).toLocaleString('vi-VN');
            }

            // Load dữ liệu từ F3 + HR + Sale Report + MKT Report
            async function loadData() {
                try {
                    // Fetch song song 4 nguồn
                    const [resF3, resHR, resReport, resMktReport] = await Promise.all([
                        fetch(F3_URL),
                        fetch(HR_URL + '.json').catch(() => null),
                        fetch(SALE_REPORT_URL).catch(() => null),
                        fetch(MKT_REPORT_URL).catch(() => null)
                    ]);

                    if (!resF3.ok) throw new Error("HTTP " + resF3.status);
                    const dataF3 = await resF3.json();
                    allOrders = normalizeF3(dataF3);
                    console.log("Đã tải " + allOrders.length + " đơn hàng từ F3.");

                    if (resHR && resHR.ok) {
                        const dataHR = await resHR.json();
                        hrData = normalizeF3(dataHR);
                        console.log("Đã tải " + hrData.length + " nhân sự từ HR.");
                    }

                    if (resReport && resReport.ok) {
                        const reportJson = await resReport.json();
                        // API trả về { data: [...] }
                        salesReportData = reportJson.data || [];
                        console.log("Đã tải " + salesReportData.length + " dòng báo cáo sale từ API mới.");
                        
                        // Debug: Log mẫu dữ liệu để kiểm tra cấu trúc
                        if (salesReportData.length > 0) {
                            console.log("Mẫu dữ liệu Sales Report (dòng đầu tiên):", salesReportData[0]);
                            console.log("Các key có trong dữ liệu:", Object.keys(salesReportData[0]));
                        }
                    } else {
                        console.warn("Lỗi tải Sale Report API hoặc không có data.");
                        console.warn("Response status:", resReport ? resReport.status : 'No response');
                    }
                    
                    // Xử lý MKT Report API (CPQC, Doanh số)
                    if (resMktReport && resMktReport.ok) {
                        const mktJson = await resMktReport.json();
                        mktReportData = mktJson.data || [];
                        console.log("Đã tải " + mktReportData.length + " dòng báo cáo MKT từ API.");
                        
                        // Debug: Log mẫu dữ liệu
                        if (mktReportData.length > 0) {
                            console.log("Mẫu dữ liệu MKT Report (dòng đầu tiên):", mktReportData[0]);
                            console.log("Các key MKT Report:", Object.keys(mktReportData[0]));
                        }
                    } else {
                        console.warn("Lỗi tải MKT Report API hoặc không có data.");
                    }

                } catch (error) {
                    console.warn("Lỗi tải dữ liệu F3 (có thể do CORS hoặc mạng). Sử dụng dữ liệu mẫu.", error);
                    allOrders = normalizeF3(F3_SAMPLE);
                }
                updateData();
            }

            // Hàm lấy khoảng thời gian dựa trên Dropdown
            function getDateRange() {
                const type = document.getElementById('period-type').value;
                const value = document.getElementById('period-value').value;

                let startDate, endDate;
                const now = new Date(); // Lấy ngày hiện tại thực tế
                const currentYear = now.getFullYear();

                if (type === 'week') {
                    // Xử lý Logic Tuần (Giả sử: w1=1-7, w2=8-14, w3=15-21...)
                    // Cần logic chính xác hơn nếu có definition cụ thể về "Tuần" trong dự án
                    // Ở đây demo logic đơn giản theo ngày trong tháng hiện tại
                    const month = 11; // Tháng 12 (Javascript tháng 0-11) -> Demo đang hardcode T12

                    if (value === 'w1') {
                        startDate = new Date(currentYear, month, 1);
                        endDate = new Date(currentYear, month, 7, 23, 59, 59);
                    } else if (value === 'w2') {
                        startDate = new Date(currentYear, month, 8);
                        endDate = new Date(currentYear, month, 14, 23, 59, 59);
                    } else if (value === 'w3') {
                        startDate = new Date(currentYear, month, 15);
                        endDate = new Date(currentYear, month, 21, 23, 59, 59);
                    } else {
                        // Default hoặc Tuần 4
                        startDate = new Date(currentYear, month, 22);
                        endDate = new Date(currentYear, month + 1, 0, 23, 59, 59);
                    }
                } else {
                    // Logic Theo Tháng
                    let monthIndex = parseInt(value) - 1; // value là "12" -> index 11
                    // Nếu value chưa có (do UI update chậm), fallback về tháng hiện tại
                    if (isNaN(monthIndex)) monthIndex = now.getMonth();

                    startDate = new Date(currentYear, monthIndex, 1);
                    endDate = new Date(currentYear, monthIndex + 1, 0, 23, 59, 59);
                }

                return { start: startDate, end: endDate };
            }

            // Hàm parse ngày từ chuỗi dữ liệu (Hỗ trợ nhiều định dạng nếu cần)
            function parseDate(dateStr) {
                if (!dateStr) return null;
                // Giả sử định dạng chuẩn ISO hoặc YYYY-MM-DD
                // Nếu dữ liệu F3 có định dạng khác (VD DD/MM/YYYY), cần xử lý thêm
                return new Date(dateStr);
            }

            // Hàm tính toán Tỷ lệ chốt cho nhân viên Sale
            function calculateCloseRate(orders, staffName, roleColumn) {
                const staffOrders = orders.filter(order => order[roleColumn] === staffName);
                if (staffOrders.length === 0) return 0;

                const closedOrders = staffOrders.filter(order => {
                    const checkResult = order["Kết quả Check"] || order["Kết_quả_Check"] || "";
                    const checkResultLower = String(checkResult).toLowerCase();
                    // Đơn chốt: không phải "Hủy" hoặc các biến thể của hủy
                    return checkResultLower !== "hủy" &&
                        checkResultLower !== "huỷ" &&
                        checkResultLower !== "huy" &&
                        checkResultLower !== "cancel" &&
                        checkResult && checkResult.trim() !== "";
                });

                const closeRate = (closedOrders.length / staffOrders.length) * 100;
                return Math.round(closeRate * 100) / 100; // Làm tròn 2 chữ số thập phân
            }

            // Hàm tính tỷ lệ Chi phí Ads / Doanh số chốt cho MKT
            function calculateAdsRate(orders, staffName, roleColumn) {
                const staffOrders = orders.filter(order => order[roleColumn] === staffName);
                if (staffOrders.length === 0) return 0;

                // Lọc các đơn chốt (không hủy)
                const closedOrders = staffOrders.filter(order => {
                    const checkResult = order["Kết quả Check"] || order["Kết_quả_Check"] || "";
                    const checkResultLower = String(checkResult).toLowerCase();
                    return checkResultLower !== "hủy" &&
                        checkResultLower !== "huỷ" &&
                        checkResultLower !== "huy" &&
                        checkResultLower !== "cancel" &&
                        checkResult && checkResult.trim() !== "";
                });

                if (closedOrders.length === 0) return 0;

                // Tính tổng doanh số chốt
                let totalRevenue = 0;
                let totalAdsCost = 0;

                closedOrders.forEach(order => {
                    const revenue = parseMoney(order["Tổng tiền VNĐ"] || order["Tổng_tiền_VNĐ"] || 0);
                    totalRevenue += revenue;

                    // Tìm cột chi phí Ads (có thể có nhiều tên khác nhau)
                    const adsCost = parseMoney(
                        order["Chi phí Ads"] ||
                        order["Chi_phí_Ads"] ||
                        order["Chi phí ads"] ||
                        order["Chi_phí_ads"] ||
                        order["Ads"] ||
                        order["ads"] ||
                        0
                    );
                    totalAdsCost += adsCost;
                });

                if (totalRevenue === 0) return 0;

                const adsRate = (totalAdsCost / totalRevenue) * 100;
                return Math.round(adsRate * 100) / 100; // Làm tròn 2 chữ số thập phân
            }

            // Hàm tính toán Doanh số theo Nhân viên
            function calculateSales(orders, roleColumn) {
                const salesMap = {};

                orders.forEach(order => {
                    const staffName = order[roleColumn] ? order[roleColumn].trim() : null; // "Nhân viên Sale" hoặc "Nhân viên Marketing"
                    // Bỏ qua nếu không có tên nhân viên
                    if (!staffName) return;

                    const money = parseMoney(order["Tổng tiền VNĐ"] || order["Tổng_tiền_VNĐ"]);

                    if (!salesMap[staffName]) {
                        salesMap[staffName] = 0;
                    }
                    salesMap[staffName] += money;
                });

                // Chuyển Map thành Array và sort
                let result = Object.keys(salesMap).map(name => {
                    return {
                        name: name,
                        avatar: getAvatar(name),
                        rawVal: salesMap[name],
                        value: formatMoney(salesMap[name]),
                        percent: 0, // Sẽ tính lại sau khi có max
                        closeRate: roleColumn === "Nhân viên Sale" || roleColumn === "Nhân_viên_Sale" ? calculateCloseRate(orders, name, roleColumn) : 0,
                        adsRate: roleColumn === "Nhân viên Marketing" || roleColumn === "Nhân_viên_Marketing" ? calculateAdsRate(orders, name, roleColumn) : 0
                    };
                });

                // Sắp xếp giảm dần theo doanh số
                result.sort((a, b) => b.rawVal - a.rawVal);

                // Tính phần trăm hiển thị thanh Bar (so với người cao nhất)
                if (result.length > 0) {
                    const maxVal = result[0].rawVal;
                    result.forEach(item => {
                        item.percent = maxVal > 0 ? (item.rawVal / maxVal) * 100 : 0;
                    });
                }

                return result;
            }

            // Logic chính: Cập nhật dữ liệu
            function updateData() {
                const type = document.getElementById('period-type').value;
                const valueSelect = document.getElementById('period-value');

                // --- 1. Update UI Dropdown Options (Giữ logic cũ) ---
                if (type === 'week' && !valueSelect.innerHTML.includes('Tuần')) {
                    valueSelect.innerHTML = `
                <option value="w1">Tuần 1 (T12)</option>
                <option value="w2">Tuần 2 (T12)</option>
                <option value="w3">Tuần 3 (T12)</option>
            `;
                    document.querySelector('.board.sale h2').innerHTML = '<i class="fa-solid fa-chart-line"></i> TOP DOANH SỐ TUẦN - SALE';
                    document.querySelector('.board.mkt h2').innerHTML = '<i class="fa-solid fa-bullhorn"></i> TOP DOANH SỐ TUẦN - MKT';
                } else if (type === 'month' && !valueSelect.innerHTML.includes('Tháng')) {
                    valueSelect.innerHTML = `
                <option value="12" selected>Tháng 12/2025</option>
                <option value="11">Tháng 11/2025</option>
                <option value="10">Tháng 10/2025</option>
            `;
                    document.querySelector('.board.sale h2').innerHTML = '<i class="fa-solid fa-chart-line"></i> Top Doanh Số (Tháng)';
                    document.querySelector('.board.mkt h2').innerHTML = '<i class="fa-solid fa-bullhorn"></i> Top Doanh Số MKT (Tháng)';
                }

                // --- 2. Filter Data theo ngày ---
                // Lấy lại value mới set nếu cần
                // const currentValue = valueSelect.value; 

                const { start, end } = getDateRange();

                // Filter orders trong khoảng thời gian (Dựa vào "Ngày lên đơn") và Team Hà Nội
                const filteredOrders = allOrders.filter(order => {
                    // Check Team = Hà Nội
                    const team = order["Team"] || "";
                    if (team.trim() !== "Hà Nội") return false;

                    const dateStr = order["Ngày lên đơn"] || order["Ngày_lên_đơn"];
                    if (!dateStr) return false;
                    const d = parseDate(dateStr);
                    return d >= start && d <= end;
                });

                console.log(`Lọc từ ${start.toLocaleDateString()} đến ${end.toLocaleDateString()}: ${filteredOrders.length} đơn.`);

                // --- 2b. Filter & Aggregate Sales Report Data (Số Mess, Số đơn đi, DS đi) ---
                // Tham khảo logic từ nhanSuSaleLumiMoi.html: tổng hợp theo tên từ cột "Tên"
                const reportMap = {}; // Key: tên từ cột "Tên", Value: tổng số Mess
                const reportDiDiMap = {}; // Key: tên từ cột "Tên", Value: {soDonDi, dsDi}
                
                if (!salesReportData || salesReportData.length === 0) {
                    console.warn('⚠️ salesReportData rỗng hoặc không có dữ liệu');
                } else {
                    console.log('📊 Bắt đầu xử lý Sales Report Data, tổng số dòng:', salesReportData.length);
                    console.log('📅 Bộ lọc ngày:', start, '-', end);
                    // Log dòng đầu tiên để kiểm tra cấu trúc
                    if (salesReportData[0]) {
                        console.log('🔑 Tất cả các key trong Sales Report:', Object.keys(salesReportData[0]));
                        console.log('📄 Dòng đầu tiên:', salesReportData[0]);
                    }
                }
                
                // Đếm số dòng được xử lý
                let processedCount = 0;
                let skippedDate = 0;
                let skippedName = 0;
                
                salesReportData.forEach((r, index) => {
                    // Lấy tên từ cột "Tên" (giống nhanSuSaleLumiMoi.html)
                    const name = (r['Tên'] || "").trim();
                    if (!name) {
                        skippedName++;
                        return;
                    }
                    
                    // Filter theo ngày (theo bộ lọc)
                    const dateStr = r['Ngày'];
                    if (!dateStr) {
                        skippedDate++;
                        return;
                    }
                    const d = parseDate(dateStr);
                    if (d < start || d > end) {
                        skippedDate++;
                        return;
                    }
                    
                    // Lấy Số Mess từ cột "Số Mess" (giống nhanSuSaleLumiMoi.html: Number(r['Số Mess']) || 0)
                    const soMess = Number(r['Số Mess']) || 0;
                    
                    // Lấy Số đơn đi và DS đi từ Sales Report API (tham khảo nhanSuSaleLumiMoi.html)
                    const soDonDi = Number(
                        r['Số đơn đi'] || 
                        r['Số đơn đi thực tế'] || 
                        r['Số_đơn_đi'] ||
                        r['Số_đơn_đi_thực_tế'] ||
                        0
                    ) || 0;
                    
                    // Lấy DS đi (Doanh số đi) - tham khảo nhanSuSaleLumiMoi.html: Number(r['Doanh số đi']) || 0
                    const dsDi = Number(
                        r['Doanh số đi'] || 
                        r['Doanh số đi thực tế'] ||
                        r['Doanh_số_đi'] ||
                        r['Doanh_số_đi_thực_tế'] ||
                        0
                    ) || 0;
                    
                    // Tổng hợp số Mess theo tên (đã filter theo ngày)
                    if (!reportMap[name]) {
                        reportMap[name] = 0;
                    }
                    reportMap[name] += soMess;
                    
                    // Tổng hợp số đơn đi và DS đi theo tên
                    if (!reportDiDiMap[name]) {
                        reportDiDiMap[name] = { soDonDi: 0, dsDi: 0 };
                    }
                    reportDiDiMap[name].soDonDi += soDonDi;
                    reportDiDiMap[name].dsDi += dsDi;
                    
                    processedCount++;
                    
                    // Log mẫu cho 3 dòng đầu tiên khớp filter
                    if (processedCount <= 3) {
                        console.log(`🔍 Dữ liệu khớp filter (${processedCount}):`, {
                            'Tên': name,
                            'Ngày': dateStr,
                            'Số Mess': soMess,
                            'Số đơn đi': soDonDi,
                            'DS đi': dsDi
                        });
                    }
                });
                
                console.log(`📊 Đã xử lý ${processedCount} dòng từ Sales Report API (trong khoảng ngày đã chọn)`);
                console.log(`⏭️ Bỏ qua: ${skippedDate} dòng ngoài khoảng ngày, ${skippedName} dòng không có tên`);
                
                // Debug: Log reportMap để kiểm tra
                console.log('✅ ReportMap (Số Mess theo nhân sự):', reportMap);
                console.log('📈 Số lượng nhân sự trong reportMap:', Object.keys(reportMap).length);
                console.log('📋 Danh sách tên từ Sales Report API (cột "Tên"):', Object.keys(reportMap));
                
                // Log tổng số Mess
                const totalMess = Object.values(reportMap).reduce((sum, val) => sum + val, 0);
                console.log('📊 Tổng số Mess:', totalMess);
                
                // Log chi tiết từng nhân sự và số Mess tương ứng
                Object.entries(reportMap).forEach(([name, mess]) => {
                    console.log(`  - "${name}": ${mess} mess`);
                });

                // --- 2c. Tổng hợp CPQC và Doanh số từ MKT Report API ---
                const mktCpqcMap = {}; // Key: tên MKT, Value: {cpqc, doanhSo}
                
                if (!mktReportData || mktReportData.length === 0) {
                    console.warn('⚠️ mktReportData rỗng hoặc không có dữ liệu');
                } else {
                    console.log('📊 Bắt đầu xử lý MKT Report Data, tổng số dòng:', mktReportData.length);
                    if (mktReportData[0]) {
                        console.log('🔑 Các key trong MKT Report:', Object.keys(mktReportData[0]));
                    }
                }
                
                let mktProcessedCount = 0;
                mktReportData.forEach((r, index) => {
                    // Lấy tên nhân viên MKT từ cột "Tên"
                    const name = (r['Tên'] || "").trim();
                    if (!name) return;
                    
                    // Filter theo ngày (theo bộ lọc)
                    const dateStr = r['Ngày'];
                    if (!dateStr) return;
                    const d = parseDate(dateStr);
                    if (d < start || d > end) return;
                    
                    // Lấy CPQC và Doanh số
                    const cpqc = Number(r['CPQC']) || 0;
                    const doanhSo = Number(r['Doanh số']) || Number(r['Doanh_số']) || 0;
                    
                    // Tổng hợp theo tên
                    if (!mktCpqcMap[name]) {
                        mktCpqcMap[name] = { cpqc: 0, doanhSo: 0 };
                    }
                    mktCpqcMap[name].cpqc += cpqc;
                    mktCpqcMap[name].doanhSo += doanhSo;
                    
                    mktProcessedCount++;
                    
                    // Log mẫu cho 3 dòng đầu tiên
                    if (mktProcessedCount <= 3) {
                        console.log(`🎯 MKT Data (${mktProcessedCount}):`, {
                            'Tên': name,
                            'CPQC': cpqc,
                            'Doanh số': doanhSo
                        });
                    }
                });
                
                console.log(`📊 Đã xử lý ${mktProcessedCount} dòng từ MKT Report API`);
                console.log('✅ MKT CPQC Map:', mktCpqcMap);


                // --- 3. Tính toán Sale & MKT ---
                // Sale Team: cột "Nhân_viên_Sale" (Check key cẩn thận)
                saleData = calculateSales(filteredOrders, "Nhân_viên_Sale");
                if (saleData.length === 0) {
                    // Fallback check "Nhân viên Sale" nếu dữ liệu không thống nhất
                    saleData = calculateSales(filteredOrders, "Nhân viên Sale");
                }

                // Update Close Rate logic for ALL saleData items based on Report API (if available)
                // Formula: Tỉ lệ chốt = Số đơn đếm được (F3) / Số Mess (Report API)
                saleData.forEach(item => {
                    const soMess = reportMap[item.name] || 0;
                    // item.count is the order count from calculateSales
                    // Let's assume I need to fix calculateSales first?
                    // Or I can calculate count here since I have filteredOrders.
                    const staffOrders = filteredOrders.filter(o => {
                        const n = o["Nhân_viên_Sale"] || o["Nhân viên Sale"];
                        return n && n.trim() === item.name;
                    });
                    // Filter valid orders "Số đơn đếm được" (Usually implies non-cancelled)
                    const validOrders = staffOrders.filter(order => {
                        const checkResult = order["Kết quả Check"] || order["Kết_quả_Check"] || "";
                        const checkLower = String(checkResult).toLowerCase();
                        return checkLower !== "hủy" && checkLower !== "huỷ" && checkLower !== "huy" && checkLower !== "cancel";
                    });

                    if (soMess > 0) {
                        item.closeRate = (validOrders.length / soMess) * 100;
                        item.closeRate = Math.round(item.closeRate * 100) / 100;
                    } else {
                        // If no mess data, keep 0 or old logic? 
                        item.closeRate = 0;
                    }
                });
                // --- Calculate Danger Zone BEFORE slicing ---
                // Danh sách nhân sự cần ẩn (0% hoặc không có dữ liệu)
                const hiddenStaff = ["Trần Thị Nhung", "Mai Thị Lý", "Đỗ Thị Thu Hằng", "Lê Ngọc Đài Trang"];
                
                // Danger Zone Sale: Những người có Tỷ lệ chốt < 7% (loại bỏ 3 người ẩn)
                // (Lấy từ toàn bộ danh sách đã tính toán, chưa cắt Top 3)
                underperformSale = saleData
                    .filter(x => x.closeRate < 7 && !hiddenStaff.includes(x.name))
                    .map(x => ({ name: x.name, val: x.closeRate }));

                // USER REQUEST: Nếu <7% thì sẽ k dc có mặt trong top 3 BXH
                // Filter qualified candidates logic
                let qualifiedSaleData = saleData.filter(x => x.closeRate >= 7);

                // USER REQUEST: Lấy 3 người thôi (từ danh sách đã đạt chuẩn)
                saleData = qualifiedSaleData.slice(0, 3);

                // MKT Team: cột "Nhân_viên_Marketing"
                mktData = calculateSales(filteredOrders, "Nhân_viên_Marketing");
                if (mktData.length === 0) {
                    mktData = calculateSales(filteredOrders, "Nhân viên Marketing");
                }
                
                // Thêm CPQC và ADS/DS cho MKT từ MKT Report API
                mktData.forEach(item => {
                    const itemName = item.name.trim();
                    let cpqc = 0;
                    let doanhSo = 0;
                    
                    // Tìm trong mktCpqcMap (tham khảo logic matching của reportMap)
                    if (mktCpqcMap[itemName]) {
                        cpqc = mktCpqcMap[itemName].cpqc;
                        doanhSo = mktCpqcMap[itemName].doanhSo;
                    } else {
                        // Thử match case-insensitive
                        const itemNameLower = itemName.toLowerCase();
                        for (const key in mktCpqcMap) {
                            if (key.trim().toLowerCase() === itemNameLower) {
                                cpqc = mktCpqcMap[key].cpqc;
                                doanhSo = mktCpqcMap[key].doanhSo;
                                break;
                            }
                        }
                        
                        // Thử match bỏ số cuối
                        if (cpqc === 0 && doanhSo === 0) {
                            const nameWithoutNumber = itemName.replace(/\s+\d+$/, '').trim();
                            if (nameWithoutNumber !== itemName) {
                                for (const key in mktCpqcMap) {
                                    const keyWithoutNumber = key.replace(/\s+\d+$/, '').trim();
                                    if (keyWithoutNumber.toLowerCase() === nameWithoutNumber.toLowerCase()) {
                                        cpqc = mktCpqcMap[key].cpqc;
                                        doanhSo = mktCpqcMap[key].doanhSo;
                                        break;
                                    }
                                }
                            }
                        }
                    }
                    
                    item.cpqc = cpqc;
                    item.doanhSoMkt = doanhSo;
                    // ADS/DS = CPQC / Doanh số (tính theo %)
                    item.adsRate = doanhSo > 0 ? (cpqc / doanhSo) * 100 : 0;
                    item.adsRate = Math.round(item.adsRate * 100) / 100;
                    
                    console.log(`🎯 MKT "${itemName}": CPQC=${cpqc}, DS=${doanhSo}, ADS/DS=${item.adsRate}%`);
                });
                
                // Danger Zone MKT: Những người có ADS/DS > 32%
                underperformMkt = mktData
                    .filter(x => x.adsRate > 32)
                    .map(x => x.name);
                
                // Lưu toàn bộ MKT data trước khi filter để dùng cho Top Month
                let allMktDataForMonth = [...mktData];
                
                // USER REQUEST: Chỉ những người có ADS/DS <= 32% mới được vào top 3 vinh danh
                let qualifiedMktData = mktData.filter(x => x.adsRate <= 32);
                mktData = qualifiedMktData.slice(0, 3);


                // --- 4. Tạo dữ liệu cho phần "Best Of Month" (THEO BỘ LỌC THÁNG) ---
                // Lấy top 2 từ danh sách đã tính theo bộ lọc hiện tại
                
                // Top 2 Sale (nhất và nhì) - từ danh sách đạt chuẩn (>= 7%)
                saleMonthDataBottom = qualifiedSaleData
                    .sort((a, b) => b.rawVal - a.rawVal)
                    .slice(0, 2);
                
                // Top 2 MKT (nhất và nhì) - từ danh sách đạt chuẩn (ADS/DS <= 32%)
                mktMonthDataBottom = qualifiedMktData
                    .sort((a, b) => b.rawVal - a.rawVal)
                    .slice(0, 2);
                
                console.log('🏆 Top 2 Sale:', saleMonthDataBottom.map(x => ({ name: x.name, value: x.value })));
                console.log('🏆 Top 2 MKT:', mktMonthDataBottom.map(x => ({ name: x.name, value: x.value })));

                // Danger Zone Sale: Những người có Tỷ lệ chốt < 7%
                // Đã được tính ở dòng 1919-1922 từ toàn bộ saleData TRƯỚC KHI lọc >= 7%
                // Không cần tính lại vì đã đúng

                // Danger Zone MKT: Những người có Ads/DS > 32%
                // Đã được tính ở trên (dòng 1984-1987) từ toàn bộ mktData TRƯỚC KHI slice top 3
                // Không cần tính lại

                // --- 4b. Tính toán số đơn F3 cho tất cả nhân sự Sale (để hiển thị bảng stats) ---
                // Lấy toàn bộ danh sách nhân sự Sale (không chỉ top 3)
                let allSaleStaffData = calculateSales(filteredOrders, "Nhân_viên_Sale");
                if (allSaleStaffData.length === 0) {
                    allSaleStaffData = calculateSales(filteredOrders, "Nhân viên Sale");
                }

                console.log('👥 Tổng số nhân sự Sale:', allSaleStaffData.length);
                console.log('📋 Danh sách tên nhân sự Sale:', allSaleStaffData.map(s => s.name));
                console.log('🗺️ ReportMap hiện tại:', reportMap);
                console.log('🔑 Keys trong reportMap:', Object.keys(reportMap));

                // Tính số đơn F3 hợp lệ (không hủy) cho mỗi nhân sự
                const staffStatsData = allSaleStaffData.map(item => {
                    const staffOrders = filteredOrders.filter(o => {
                        const n = o["Nhân_viên_Sale"] || o["Nhân viên Sale"];
                        return n && n.trim() === item.name;
                    });

                    // Đếm số đơn hợp lệ (không hủy)
                    const validOrdersCount = staffOrders.filter(order => {
                        const checkResult = order["Kết quả Check"] || order["Kết_quả_Check"] || "";
                        const checkLower = String(checkResult).toLowerCase();
                        return checkLower !== "hủy" && 
                               checkLower !== "huỷ" && 
                               checkLower !== "huy" && 
                               checkLower !== "cancel" &&
                               checkResult && checkResult.trim() !== "";
                    }).length;

                    // Lấy số Mess từ reportMap - đơn giản hóa logic matching
                    let soMess = 0;
                    const itemName = item.name.trim();
                    
                    // 1. Thử match chính xác (tên gốc)
                    if (reportMap[itemName] !== undefined) {
                        soMess = reportMap[itemName];
                    } else {
                        // 2. Thử match case-insensitive (trim và lowercase)
                        const itemNameLower = itemName.toLowerCase();
                        for (const key in reportMap) {
                            if (key.trim().toLowerCase() === itemNameLower) {
                                soMess = reportMap[key];
                                console.log(`✅ Found match (case-insensitive): "${itemName}" matches "${key}" with soMess = ${soMess}`);
                                break;
                            }
                        }
                        
                        // 3. Nếu vẫn không tìm thấy, thử match bằng cách bỏ số cuối (ví dụ: "Nguyễn Thị Ánh Nguyệt 1" vs "Nguyễn Thị Ánh Nguyệt")
                        if (soMess === 0) {
                            // Bỏ số cuối cùng trong tên
                            const nameWithoutNumber = itemName.replace(/\s+\d+$/, '').trim();
                            if (nameWithoutNumber !== itemName) {
                                // Thử match với tên đã bỏ số
                                const nameWithoutNumberLower = nameWithoutNumber.toLowerCase();
                                for (const key in reportMap) {
                                    const keyWithoutNumber = key.replace(/\s+\d+$/, '').trim();
                                    if (keyWithoutNumber.toLowerCase() === nameWithoutNumberLower) {
                                        soMess = reportMap[key];
                                        console.log(`✅ Found match (bỏ số cuối): "${itemName}" matches "${key}" with soMess = ${soMess}`);
                                        break;
                                    }
                                }
                            }
                        }
                        
                        // 4. Log để debug nếu không tìm thấy
                        if (soMess === 0 && reportMap && Object.keys(reportMap).length > 0) {
                            console.warn(`⚠️ Không tìm thấy số Mess cho nhân sự: "${itemName}"`);
                            // Chỉ log top 5 tên tương tự để không spam console
                            const allNames = Object.keys(reportMap);
                            if (allNames.length <= 10) {
                                console.warn('📋 Tất cả tên trong reportMap:', allNames);
                            } else {
                                console.warn('📋 Một số tên trong reportMap (10 đầu tiên):', allNames.slice(0, 10));
                            }
                        }
                    }

                    return {
                        name: item.name,
                        soMess: soMess,
                        soDonF3: validOrdersCount
                    };
                });

                // Sắp xếp theo tên để dễ xem
                staffStatsData.sort((a, b) => {
                    // Sắp xếp theo số Mess giảm dần, nếu bằng nhau thì theo số đơn F3
                    if (b.soMess !== a.soMess) return b.soMess - a.soMess;
                    return b.soDonF3 - a.soDonF3;
                });

                // --- 4c. Tạo bảng Thống Kê MKT từ MKT Report API ---
                // Lấy trực tiếp từ mktCpqcMap (CPQC, Doanh số, ADS/DS)
                const mktStatsData = Object.keys(mktCpqcMap).map(name => {
                    const cpqc = mktCpqcMap[name].cpqc || 0;
                    const doanhSo = mktCpqcMap[name].doanhSo || 0;
                    const adsRate = doanhSo > 0 ? (cpqc / doanhSo) * 100 : 0;
                    
                    return {
                        name: name,
                        cpqc: cpqc,
                        doanhSo: doanhSo,
                        adsRate: Math.round(adsRate * 100) / 100
                    };
                });

                // Sắp xếp theo Doanh số giảm dần
                mktStatsData.sort((a, b) => {
                    if (b.doanhSo !== a.doanhSo) return b.doanhSo - a.doanhSo;
                    return b.cpqc - a.cpqc;
                });
                
                console.log('📊 Bảng MKT - Dữ liệu từ MKT Report API:', mktStatsData.slice(0, 5));

                // --- 5. Render lại giao diện ---
                // Clear bars width to 0 for animation effect
                document.querySelectorAll('.bar-fill-colored').forEach(bar => bar.style.width = '0%');

                // Render Functions
                // Render Functions
                renderMainBoard('sale-list', saleData, false);
                renderMainBoard('mkt-list', mktData, true); // isMkt = true để hiển thị ADS/DS

                // Render top 2 ở dưới "Best of the Month" (thứ 4, 5)
                renderMonthSummary('sale-month-list', saleMonthDataBottom, 2);
                renderMonthSummary('mkt-month-list', mktMonthDataBottom, 2);

                renderUnderperformList('underperform-sale', underperformSale);
                renderUnderperformList('underperform-mkt', underperformMkt);

                // Render bảng thống kê số Mess và số đơn F3
                renderStaffStatsTable(staffStatsData);
                
                // Render bảng thống kê MKT (CPQC, Doanh số, ADS/DS)
                renderMktStatsTable(mktStatsData);

                // Trigger Animation
                setTimeout(() => {
                    animateBars();
                    animateNumbers();
                }, 100);
            }

            // Render Bảng Chính (Top 3)
            function renderMainBoard(elementId, data, isMkt = false) {
                const container = document.getElementById(elementId);
                let html = '';

                // Hiển thị tối đa 5 người
                data.slice(0, 5).forEach((item, index) => {
                    const rank = index + 1;
                    let rankClass = '';
                    let itemClass = '';

                    if (rank === 1) { rankClass = 'rank-1'; itemClass = 'top-1'; }
                    else if (rank === 2) { rankClass = 'rank-2'; itemClass = 'top-2'; }
                    else if (rank === 3) { rankClass = 'rank-3'; itemClass = 'top-3'; }

                    let rankDisplay = `#${rank}`;

                    html += `
                <div class="rank-item ${itemClass}">
                    <div class="rank-pos ${rankClass}">${rankDisplay}</div>
                    <div class="user-avatar-group">
                        <div class="avatar-at-start-wrapper">
                            <img src="${item.avatar}" alt="${item.name}" class="avatar-at-start">
                            ${rank === 1 ? '<i class="fa-solid fa-crown avatar-crown" style="position: absolute; top: -8px; left: 50%; transform: translateX(-50%); color: var(--gold); font-size: 24px; z-index: 11;"></i>' : ''}
                        </div>
                        <div class="user-info-with-avatar">
                            <div>
                                <div class="name">${item.name}</div>
                                <div class="role">Lumi Staff</div>
                            </div>
                        </div>
                    </div>
                    <div class="bar-container">
                        <div class="bar-fill" style="width: 100%;">
                            <div class="bar-fill-colored" style="width: ${item.percent}%" data-width="${item.percent}%">
                                <span style="padding-right: 15px;">${item.value}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
                });

                if (data.length === 0) {
                    html = '';
                }

                container.innerHTML = html;
            }

            // Render Bảng Tháng (Top 3 Compact cho Sale, Top 2 cho MKT)
            function renderMonthSummary(elementId, data, maxItems) {
                const container = document.getElementById(elementId);
                if (!container) {
                    console.error('Container not found:', elementId);
                    return;
                }
                let html = '';

                // Nếu không có maxItems, tự động xác định dựa trên elementId
                if (typeof maxItems === 'undefined') {
                    maxItems = elementId === 'sale-month-top3-list' ? 3 : (elementId === 'sale-month-list' ? 2 : 2);
                }

                // (Đã xóa đoạn fallback demo data cho sale-month-list)


                if (!data || data.length === 0) {
                    html = '<div style="text-align: center; padding: 20px; color: #999; font-size: 12px;">Chưa có dữ liệu tháng</div>';
                } else {
                    console.log(`🎨 Rendering ${elementId} với ${data.length} items:`, data.map(x => ({ name: x.name, value: x.value })));
                    
                    data.slice(0, maxItems).forEach((item, index) => {
                        const rank = index + 1;
                        let rankClass = rank === 1 ? 'rank-1-mini' : (rank === 2 ? 'rank-2-mini' : 'rank-3-mini');
                        let medal = '';
                        if (rank === 1) {
                            medal = '<i class="fa-solid fa-medal mini-medal medal-gold"></i>';
                        } else if (rank === 2) {
                            medal = '<i class="fa-solid fa-medal mini-medal medal-silver"></i>';
                        }
                        
                        // Đảm bảo value luôn có giá trị
                        const displayValue = item.value || formatMoney(item.rawVal) || '0';

                        html += `
                    <div class="mini-item ${rankClass}">
                        <div class="mini-rank-top">#${rank}</div>
                        <div class="mini-avatar-wrapper">
                            ${medal}
                            <img src="${item.avatar || 'https://i.pravatar.cc/150?img=' + (index + 1)}" class="mini-avatar">
                        </div>
                        <div class="mini-info">
                            <div class="mini-name">${item.name || 'N/A'}</div>
                            <div class="mini-value">${displayValue}</div>
                        </div>
                    </div>
                `;
                    });
                }

                container.innerHTML = html;
            }

            // Render Bảng Không Đạt (Tách 2 list)
            function renderUnderperformList(containerId, data) {
                const container = document.getElementById(containerId);
                let html = '';
                data.forEach(item => {
                    let displayHtml = '';
                    if (typeof item === 'object') {
                        displayHtml = `${item.name} <span style="color: red; font-weight: bold; margin-left: 5px;">(${item.val}%)</span>`;
                    } else {
                        displayHtml = item;
                    }
                    html += `<div class="name-tag"><i class="fa-solid fa-user-xmark"></i> ${displayHtml}</div>`;
                });
                if (data.length === 0) html = '<div style="width:100%; text-align:center; color:#aaa; font-size:13px;">Không có ai</div>';
                container.innerHTML = html;
            }

            // Render Bảng Thống Kê Số Mess và Số Đơn F3
            function renderStaffStatsTable(data) {
                const container = document.getElementById('staff-stats-body');
                if (!container) {
                    console.error('Container not found: staff-stats-body');
                    return;
                }

                let html = '';

                if (!data || data.length === 0) {
                    html = '<tr><td colspan="4" style="text-align: center; padding: 30px; color: #999;">Không có dữ liệu</td></tr>';
                } else {
                    console.log('🎨 Rendering bảng stats với', data.length, 'nhân sự');
                    console.log('📊 Dữ liệu mẫu (3 dòng đầu):', data.slice(0, 3));
                    
                    data.forEach((item, index) => {
                        // Đảm bảo soMess là số hợp lệ
                        const soMess = Number(item.soMess) || 0;
                        const soDonF3 = Number(item.soDonF3) || 0;
                        
                        // Log nếu số Mess = 0
                        if (soMess === 0) {
                            console.warn(`⚠️ Nhân sự "${item.name}" có số Mess = 0`);
                        }
                        
                        html += `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${item.name || 'N/A'}</td>
                                <td class="number-cell mess-cell">${soMess.toLocaleString('vi-VN')}</td>
                                <td class="number-cell order-cell">${soDonF3.toLocaleString('vi-VN')}</td>
                            </tr>
                        `;
                    });
                }

                container.innerHTML = html;
                console.log('✅ Đã render xong bảng stats');
            }

            // Render Bảng Thống Kê MKT (CPQC, Doanh số, ADS/DS)
            function renderMktStatsTable(data) {
                const container = document.getElementById('staff-mkt-body');
                if (!container) {
                    console.error('Container not found: staff-mkt-body');
                    return;
                }

                let html = '';

                if (!data || data.length === 0) {
                    html = '<tr><td colspan="5" style="text-align: center; padding: 30px; color: #999;">Không có dữ liệu</td></tr>';
                } else {
                    console.log('🎨 Rendering bảng MKT với', data.length, 'nhân sự');
                    
                    data.forEach((item, index) => {
                        const cpqc = Number(item.cpqc) || 0;
                        const doanhSo = Number(item.doanhSo) || 0;
                        const adsRate = Number(item.adsRate) || 0;
                        
                        // Màu ADS/DS: đỏ nếu > 32%, xanh nếu <= 32%
                        const adsColor = adsRate > 32 ? '#e74c3c' : '#27ae60';
                        
                        html += `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${item.name || 'N/A'}</td>
                                <td class="number-cell">${formatMoney(cpqc)}</td>
                                <td class="number-cell">${formatMoney(doanhSo)}</td>
                                <td class="number-cell" style="color: ${adsColor}; font-weight: 600;">${adsRate.toFixed(2)}%</td>
                            </tr>
                        `;
                    });
                }

                container.innerHTML = html;
                console.log('✅ Đã render xong bảng MKT');
            }

            function animateNumbers() {
                // Hàm cũ logic hơi phức tạp với replace, giờ sửa lại đơn giản hơn vì value đã format sẵn
                // Ở đây mình set text trực tiếp trong render rồi, chỉ cần effect nếu muốn
                // Để đơn giản, ta giữ nguyên hiển thị tĩnh hoặc logic cũ nếu text là số raw
                // Hiện tại renderMainBoard đã gán text là 500.000, không phải số raw để count up dễ dàng
                // Nên ta bỏ qua effect count up phức tạp hoặc chỉ chạy effect nhẹ
            }

            function animateBars() {
                const bars = document.querySelectorAll('.bar-fill-colored');
                bars.forEach(bar => {
                    bar.style.width = bar.getAttribute('data-width');
                });
            }

            // Init Calls
            loadData(); // Gọi hàm loadData để bắt đầu fetch và render
        </script>

</body>

</html>

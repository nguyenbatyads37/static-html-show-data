<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PHIẾU BÀN GIAO ĐƠN HÀNG</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.5;
      font-size: 14px;
      max-width: 210mm;
      color: #000;
      background: #fff;
      text-align: center;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #ddd;
      width: 100%;
    }
    .logo {
      max-width: 240px;
      height: auto;
    }
    .company-info {
      flex: 1;
      text-align: center;
      padding-left: 20px;
    }
    .company-name {
      font-size: 28px;
      font-weight: bold;
      text-transform: uppercase;
      margin: 0;
      line-height: 1.2;
    }
    .company-details {
      font-size: 16px;
      line-height: 1.4;
      font-weight: bold;
      margin-top: 5px;
    }
    .product-list {
      display: block;
      margin: 0 auto;
    }
    h1 {
      margin: 15px 0;
      font-size: 18px;
      font-weight: bold;
      text-transform: uppercase;
    }
    .document-info {
      margin-bottom: 15px;
      font-size: 13px;
    }
    .summary {
      margin-bottom: 15px;
      padding: 8px;
      border: 1px solid #ddd;
      font-weight: bold;
      display: inline-block;
      text-align: center;
    }
    .summary div {
      margin: 3px 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
      font-size: 13px;
    }
    th, td {
      border: 1px solid #000;
      padding: 6px;
    }
    th {
      font-weight: bold;
      text-align: center;
    }
    td {
      text-align: left;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .driver-cell {
      white-space: normal; /* Allow wrapping for driver names */
      line-height: 1.4;
    }
    .signature-section {
      display: flex;
      justify-content: center;
      gap: 40px;
      margin-top: 40px;
    }
    .signature-box {
      width: 40%;
      text-align: center;
    }
    @media print {
      body {
        padding: 10px;
        font-size: 13px;
      }
      .header {
        border-bottom: 1px solid #000;
      }
      .product-list {
        white-space: nowrap;
      }
      td {
        white-space: nowrap !important;
      }
      .driver-cell {
        white-space: normal !important; /* Keep driver names wrapped for printing */
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <img
      src="https://www.appsheet.com/template/gettablefileurl?appName=B%C3%A1ogi%C3%A1s%E1%BA%A3nph%E1%BA%A9m-325045268&tableName=c%C3%A0i%20%C4%91%E1%BA%B7t%20APP&fileName=C%C3%A0i%20%C4%91%E1%BA%B7t%20APP_Images%2F79ab1bb2.%E1%BA%A2nh.040547.jpg"
      alt="Logo"
      class="logo">
    <div class="company-info">
      <div class="company-name">NPP HÀ HÒA</div>
      <div class="company-details">
        Phân phối các mặt hàng đồ dùng 1 lần: Nilon, Cốc nhựa<br>
        <div class="product-list">
          Cốc giấy, Khay xốp các loại, Chai nhựa, Màng bọc thực phẩm, …
        </div>
        ĐC: Tiên Phong, Ba Vì, Hà Nội<br>
        Góp ý chất lượng sản phẩm & dịch vụ: 0973.905.992<br>
        Liên hệ nhà phân phối: 0969.250.323
      </div>
    </div>
  </div>

  <h1>PHIẾU BÀN GIAO ĐƠN HÀNG</h1>

  <div class="document-info">
    Ngày bàn giao: <span id="delivery-date"></span> | Giờ bàn giao: <span id="delivery-time"></span>
  </div>

  <div class="summary">
    <div>Tổng Đơn: <span id="total-orders">00</span> Đơn</div>
    <div>Tổng tiền hàng phải thu: <span id="total-receivable">0</span> VNĐ</div>
  </div>

  <table>
    <thead>
      <tr>
        <th style="width:15%">Ngày</th>
        <th style="width:35%">Khách hàng</th>
        <th style="width:30%">NV giao hàng</th>
        <th style="width:20%">Tổng tiền</th>
      </tr>
    </thead>
    <tbody id="data-container">
      <!-- Dữ liệu sẽ được thêm vào đây bằng JavaScript -->
    </tbody>
  </table>

  <div class="signature-section">
    <div class="signature-box">
      <div>Người bàn giao</div>
      <div>(Ký và ghi rõ họ tên)</div>
    </div>
    <div class="signature-box">
      <div>NV giao hàng</div>
      <div>(Ký và ghi rõ họ tên)</div>
    </div>
  </div>

  <script>
  (function() {
    const spreadsheetId = '1WpNbn9DRdRtRwV6uZge-KuzhWw1NVG65FBl2S4eC08Q';
    const sheetIdMain = '449675231'; // Sheet Check kho
    const sheetIdLookup = '2007395895'; // Sheet tra cứu
    let originalData = [];

    // Hàm lấy tham số từ URL
    function getUrlParameter(name) {
      name = name.replace(/[[\]]/g, '\\$&');
      const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
      const results = regex.exec(window.location.href);
      if (!results) return null;
      return results[2] ? decodeURIComponent(results[2].replace(/\+/g, ' ')) : '';
    }

    // Hiển thị ngày giờ hiện tại
    function showDateTime() {
      const now = new Date();
      const dd = String(now.getDate()).padStart(2,'0');
      const mm = String(now.getMonth()+1).padStart(2,'0');
      const yyyy = now.getFullYear();
      const hh = String(now.getHours()).padStart(2,'0');
      const min = String(now.getMinutes()).padStart(2,'0');
      document.getElementById('delivery-date').textContent = `${dd}/${mm}/${yyyy}`;
      document.getElementById('delivery-time').textContent = `${hh}:${min}`;
    }

    // Định dạng tiền tệ
    function formatCurrency(amount) {
      return amount ? parseInt(amount).toLocaleString('vi-VN') : '0';
    }

    // Viết hoa chữ cái đầu
    function capitalizeFirstLetter(str) {
      if (!str) return '';
      return str.toLowerCase().split(' ').map(word => 
        word.charAt(0).toUpperCase() + word.slice(1)
      ).join(' ');
    }

    // Lọc dữ liệu theo ngày và tên tài xế
    function filterData(data, driverMap) {
      const ngay = getUrlParameter('ngay'); // e.g., 10/5/2025
      const ten = getUrlParameter('ten');   // e.g., Phùng Như Quang

      return data.filter(item => {
        // Kiểm tra ngày nếu có tham số
        const ngayTrung = ngay ? item.AP === ngay : true;
        
        // Kiểm tra tài xế tồn tại trong danh sách NV giao hàng
        let tenTrung = true;
        if (ten) {
          const driverNames = item.AN.map(code => driverMap[code] || code);
          tenTrung = driverNames.some(name => name.includes(ten));
        }
        
        return ngayTrung && tenTrung;
      });
    }

    // Nhóm dữ liệu theo khách hàng
    function groupData(filteredData) {
      return filteredData.reduce((acc, item) => {
        if (!acc[item.H]) {
          acc[item.H] = { ...item, AN: new Set(item.AN), Q: item.Q };
        } else {
          acc[item.H].Q += item.Q;
          item.AN.forEach(a => acc[item.H].AN.add(a));
        }
        return acc;
      }, {});
    }

    // Hiển thị dữ liệu ra bảng
    function displayData(data, driverMap) {
      const totalOrders = data.length;
      const totalOrdersStr = totalOrders < 10 ? '0' + totalOrders : totalOrders;
      document.getElementById('total-orders').textContent = totalOrdersStr;
      document.getElementById('total-receivable').textContent = formatCurrency(
        data.reduce((s, i) => s + i.Q, 0)
      );

      let html = '';
      if (data.length === 0) {
        html = '<tr><td colspan="4">Không có dữ liệu phù hợp</td></tr>';
      } else {
        data.forEach(item => {
          // Split driver names for display (one per line)
          const drivers = item.AN.map(a => driverMap[a] || a).join('<br>');
          html += `
            <tr>
              <td>${item.AP}</td>
              <td style="text-align:left">${item.H}</td>
              <td style="text-align:left" class="driver-cell">${drivers}</td>
              <td style="text-align:right">${formatCurrency(item.Q)}</td>
            </tr>`;
        });
      }
      document.getElementById('data-container').innerHTML = html;
    }

    // Tải dữ liệu từ Google Sheets
    function loadData() {
      showDateTime();

      // 1. Tải dữ liệu tra cứu tài xế
      fetch(`https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?gid=${sheetIdLookup}`)
        .then(res => res.text())
        .then(txt => {
          const lookupRows = JSON.parse(txt.substring(47).slice(0,-2)).table.rows;
          const driverMap = lookupRows.reduce((map,row) => {
            const key = row.c[0]?.v, val = row.c[2]?.v;
            if (key && val) map[key] = val;
            return map;
          }, {});

          // 2. Tải dữ liệu chính từ sheet Check kho
          return fetch(`https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?gid=${sheetIdMain}`)
            .then(res => res.text())
            .then(txt2 => {
              const rows = JSON.parse(txt2.substring(47).slice(0,-2)).table.rows;
              
              // 3. Xử lý dữ liệu từ sheet Check kho
              originalData = rows.map(row => {
                const dateText = row.c[11]?.f || row.c[11]?.v; // Column L (index 11) - Ngày
                const customer = row.c[3]?.f || row.c[3]?.v || ''; // Column D (index 3) - Khách hàng
                const driver = row.c[9]?.v || ''; // Column J (index 9) - Mã tài xế
                const amount = parseInt(row.c[5]?.v) || 0; // Cột F (index 5) - Tổng tiền
                
                return dateText && customer.trim() ? {
                  AP: dateText.toString().trim(), // Ngày
                  H: customer.toString().trim(),  // Khách hàng
                  AN: [driver],                  // Mã tài xế (chuyển thành mảng)
                  Q: amount                     // Tổng tiền (từ cột F)
                } : null;
              }).filter(x => x);

              // 4. Lọc dữ liệu theo ngày và tên tài xế
              const filtered = filterData(originalData, driverMap);
              
              // 5. Nhóm dữ liệu theo khách hàng
              const grouped = groupData(filtered);
              
              // 6. Chuẩn bị dữ liệu để hiển thị
              const displayData = Object.entries(grouped).map(([_, v]) => ({
                AP: v.AP, 
                H: capitalizeFirstLetter(v.H), 
                AN: Array.from(v.AN), 
                Q: v.Q
              })).sort((a, b) => {
                return a.AP.split('/').reverse().join('').localeCompare(b.AP.split('/').reverse().join(''));
              });

              // 7. Hiển thị kết quả
              displayData(displayData, driverMap);
            });
        })
        .catch(err => {
          console.error('Lỗi tải dữ liệu:', err);
          document.getElementById('data-container').innerHTML =
            '<tr><td colspan="4" style="padding:10px;">Không thể tải dữ liệu</td></tr>';
        });
    }

    // Khởi chạy khi trang được tải
    window.addEventListener('load', loadData);
  })();
  </script>
</body>
</html>

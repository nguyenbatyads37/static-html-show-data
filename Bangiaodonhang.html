<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PHIẾU BÀN GIAO ĐƠN HÀNG</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        h1 {
            color: #1a73e8;
            text-align: center;
            margin-bottom: 5px;
        }
        .sub-title {
            text-align: center;
            font-weight: bold;
            margin-bottom: 20px;
        }
        .logo {
            display: block;
            margin: 0 auto 20px;
            max-width: 200px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .loading {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #666;
        }
        .error {
            color: #d32f2f;
            padding: 10px;
            background-color: #ffebee;
            border-radius: 4px;
        }
        .refresh-btn {
            margin: 10px 0;
            padding: 8px 16px;
            background-color: #1a73e8;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .refresh-btn:hover {
            background-color: #0d5bba;
        }
        .filter-container {
            margin: 15px 0;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 4px;
        }
        .filter-control {
            margin: 5px 0;
            display: flex;
            align-items: center;
        }
        label {
            margin-right: 10px;
            font-weight: bold;
        }
        input, select {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .total-amount {
            font-weight: bold;
            margin-top: 10px;
            text-align: right;
            font-size: 16px;
        }
        .signature-section {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
        }
        .signature-box {
            text-align: center;
            width: 200px;
        }
        .signature-line {
            border-top: 1px solid #000;
            margin-top: 50px;
            width: 100%;
        }
    </style>
</head>
<body>
    <img src="https://www.appsheet.com/template/gettablefileurl?appName=B%C3%A1ogi%C3%A1s%E1%BA%A3nph%E1%BA%A9m-325045268&tableName=c%C3%A0i%20%C4%91%E1%BA%B7t%20APP&fileName=C%C3%A0i%20%C4%91%E1%BA%B7t%20APP_Images%2F79ab1bb2.%E1%BA%A2nh.040547.jpg" alt="Logo" class="logo">
    <h1>PHIẾU BÀN GIAO ĐƠN HÀNG</h1>
    <div class="sub-title">Ngày bàn giao: <span id="delivery-date"></span></div>
    
    <button class="refresh-btn" onclick="loadData()">Làm mới dữ liệu</button>
    
    <div class="filter-container">
        <h3>Bộ lọc</h3>
        <div class="filter-control">
            <label for="anFilter">Lọc theo tài xế:</label>
            <select id="anFilter" onchange="filterData()">
                <option value="">Tất cả</option>
            </select>
        </div>
    </div>
    
    <div id="loading" class="loading">Đang tải dữ liệu...</div>
    <div id="error" class="error" style="display: none;"></div>
    <div id="data-container" style="overflow-x: auto;"></div>
    <div id="total-amount" class="total-amount"></div>
    
    <div class="signature-section">
        <div class="signature-box">
            <div>Người bàn giao</div>
            <div class="signature-line"></div>
        </div>
        <div class="signature-box">
            <div>Tài xế</div>
            <div class="signature-line"></div>
        </div>
    </div>

    <script>
        // Cấu hình Google Sheets
        const spreadsheetId = '1WpNbn9DRdRtRwV6uZge-KuzhWw1NVG65FBl2S4eC08Q';
        const sheetIdMain = '116599712';
        const sheetIdLookup = '2007395895';
        
        // Biến toàn cục
        let originalData = [];
        let filteredData = [];
        let uniqueANValues = [];
        let anToCMap = {};
        let selectedDateIso = '';
        
        // Hàm lấy tham số từ URL
        function getUrlParameter(name) {
            name = name.replace(/[[\]]/g, '\\$&');
            const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
            const results = regex.exec(window.location.href);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }
        
        // Hiển thị ngày bàn giao (URL param hoặc hôm nay)
        function showDeliveryDate() {
            const param = getUrlParameter('ngay');
            const el = document.getElementById('delivery-date');
            if (param) {
                el.textContent = param;
                // Chuyển sang định dạng ISO để lọc
                const parts = param.split('/');
                if (parts.length === 3) selectedDateIso = `${parts[2]}-${parts[1]}-${parts[0]}`;
            } else {
                const today = new Date();
                const day = String(today.getDate()).padStart(2, '0');
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const year = today.getFullYear();
                el.textContent = `${day}/${month}/${year}`;
                selectedDateIso = '';
            }
        }
        
        // Định dạng DD/MM/YYYY -> YYYY-MM-DD
        function formatToIso(dd_mm_yyyy) {
            const parts = dd_mm_yyyy.split('/');
            return parts.length === 3 ? `${parts[2]}-${parts[1]}-${parts[0]}` : '';
        }
        
        // Định dạng số tiền
        function formatCurrency(amount) {
            return amount ? parseInt(amount).toLocaleString('vi-VN') : '0';
        }
        
        // Hàm chính tải dữ liệu
        function loadData() {
            showDeliveryDate();
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('data-container').innerHTML = '';
            document.getElementById('total-amount').textContent = '';
            
            // Tải dữ liệu từ sheet phụ (ánh xạ tài xế)
            fetch(`https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?gid=${sheetIdLookup}`)
                .then(res => res.text())
                .then(txt => {
                    const json = JSON.parse(txt.substring(47).slice(0, -2));
                    anToCMap = {};
                    json.table.rows.forEach(r => {
                        const an = r.c[0]?.v?.toString().trim() || '';
                        const c = r.c[2]?.v?.toString().trim() || '';
                        if (an && c) anToCMap[an] = c;
                    });
                    loadMainSheet();
                })
                .catch(err => handleError('Lỗi tải dữ liệu phụ', err));
        }
        
        // Tải dữ liệu chính
        function loadMainSheet() {
            fetch(`https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?gid=${sheetIdMain}`)
                .then(res => res.text())
                .then(txt => {
                    document.getElementById('loading').style.display = 'none';
                    const json = JSON.parse(txt.substring(47).slice(0, -2));
                    originalData = json.table.rows.map(r => {
                        let dateIso = '';
                        const raw = r.c[4]?.v;
                        if (raw) {
                            const dateObj = new Date(raw);
                            if (!isNaN(dateObj)) dateIso = dateObj.toISOString().split('T')[0];
                        }
                        const anRaw = r.c[39]?.v?.toString().trim() || '';
                        const anArr = anRaw.split(',').map(v => v.trim()).filter(v => v);
                        return {
                            E: dateIso,
                            H: r.c[7]?.f || r.c[7]?.v || '',
                            AE: r.c[30]?.f || r.c[30]?.v || '',
                            AN: anArr,
                            AN_Display: anArr.map(v => anToCMap[v] || v).join(', '),
                            Q: r.c[16]?.v || 0
                        };
                    });
                    uniqueANValues = [...new Set(originalData.flatMap(i => i.AN).filter(Boolean))].sort();
                    updateDriverFilter();
                })
                .catch(err => handleError('Lỗi tải dữ liệu chính', err));
        }
        
        // Cập nhật bộ lọc tài xế
        function updateDriverFilter() {
            const sel = document.getElementById('anFilter');
            sel.innerHTML = '<option value="">Tất cả</option>';
            uniqueANValues.forEach(v => {
                const opt = document.createElement('option');
                opt.value = v;
                opt.textContent = anToCMap[v] || v;
                sel.appendChild(opt);
            });
            filterData();
        }
        
        // Lọc và hiển thị dữ liệu
        function filterData() {
            const driver = document.getElementById('anFilter').value;
            filteredData = originalData.filter(item => {
                if (selectedDateIso && item.E !== selectedDateIso) return false;
                if (driver && !item.AN.includes(driver)) return false;
                return true;
            });
            displayData();
        }
        
        // Hiển thị dữ liệu
        function displayData() {
            const cont = document.getElementById('data-container');
            const totalDiv = document.getElementById('total-amount');
            if (!filteredData.length) {
                cont.innerHTML = '<p>Không có dữ liệu phù hợp với bộ lọc</p>';
                totalDiv.textContent = '';
                return;
            }
            const total = filteredData.reduce((s, i) => s + (parseInt(i.Q) || 0), 0);
            totalDiv.textContent = `Tổng tiền bàn giao: ${formatCurrency(total)} VNĐ`;
            let html = '<table><thead><tr>' +
                '<th>Ngày</th><th>Tên khách hàng</th><th>Tên SP</th><th>Tài xế</th><th>Tổng hóa đơn</th>' +
                '</tr></thead><tbody>';
            filteredData.forEach(i => {
                html += `<tr><td>${i.E.split('-').reverse().join('/')}</td>` +
                        `<td>${i.H}</td><td>${i.AE}</td><td>${i.AN_Display}</td>` +
                        `<td>${formatCurrency(i.Q)}</td></tr>`;
            });
            html += '</tbody></table>';
            cont.innerHTML = html;
        }
        
        // Xử lý lỗi
        function handleError(ctx, err) {
            document.getElementById('loading').style.display = 'none';
            const e = document.getElementById('error');
            e.style.display = 'block';
            e.textContent = `${ctx}: ${err.message}`;
            console.error(ctx, err);
        }
        
        window.onload = loadData;
    </script>
</body>
</html>


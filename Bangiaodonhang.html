<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PHIẾU BÀN GIAO ĐƠN HÀNG</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.5;
            font-size: 14px;
            max-width: 210mm;
            color: #000;
            background: #fff;
        }
        .header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
            text-align: center;
        }
        .logo {
            max-width: 100px;
            height: auto;
            margin-right: 15px;
        }
        .company-info {
            flex-grow: 1;
        }
        .company-name {
            font-size: 24px; /* Tăng kích thước chữ */
            font-weight: bold; /* In đậm */
            margin-bottom: 3px;
            text-transform: uppercase; /* Viết hoa */
        }
        .company-details {
            font-size: 12px;
            line-height: 1.3;
            font-weight: bold; /* In đậm toàn bộ */
        }
        h1 {
            text-align: center;
            margin: 15px 0;
            font-size: 18px;
            font-weight: bold;
            text-transform: uppercase;
        }
        .document-info {
            text-align: center;
            margin-bottom: 15px;
            font-size: 13px;
        }
        .summary {
            margin-bottom: 15px;
            padding: 8px;
            border: 1px solid #ddd;
            font-weight: bold; /* In đậm */
        }
        .summary div {
            margin: 3px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 13px;
        }
        th, td {
            border: 1px solid #000;
            padding: 6px;
            text-align: left;
        }
        th {
            font-weight: bold;
            text-align: center;
        }
        .signature-section {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
        }
        .signature-box {
            text-align: center;
            width: 40%;
        }
        .signature-line {
            border-top: 1px solid #000;
            margin: 30px auto 0;
            width: 80%;
        }
        @media print {
            body { 
                padding: 10px;
                font-size: 13px;
            }
            .header {
                border-bottom: 1px solid #000;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <img src="https://www.appsheet.com/template/gettablefileurl?appName=B%C3%A1ogi%C3%A1s%E1%BA%A3nph%E1%BA%A9m-325045268&tableName=c%C3%A0i%20%C4%91%E1%BA%B7t%20APP&fileName=C%C3%A0i%20%C4%91%E1%BA%B7t%20APP_Images%2F79ab1bb2.%E1%BA%A2nh.040547.jpg" alt="Logo" class="logo">
        <div class="company-info">
            <div class="company-name">NPP HÀ HÒA</div>
            <div class="company-details">
                Phân phối các mặt hàng đồ dùng 1 lần: Nilon, Cốc nhựa, Cốc giấy, Khay xốp các loại, Chai nhựa, Màng bọc thực phẩm, ...<br>
                ĐC: Tiên Phong, Ba Vì, Hà Nội | ĐT: 0969.250.323
            </div>
        </div>
    </div>
    
    <!-- Phần còn lại giữ nguyên như trước -->
    <h1>PHIẾU BÀN GIAO ĐƠN HÀNG</h1>
    
    <div class="document-info">
        <span>Ngày bàn giao: <span id="delivery-date"></span></span> | 
        <span>Giờ bàn giao: <span id="delivery-time"></span></span>
    </div>
    
    <div class="summary">
        <div>Tổng Đơn: <span id="total-orders">0</span></div>
        <div>Tổng tiền hàng phải thu: <span id="total-receivable">0</span> VNĐ</div>
    </div>
    
    <table>
        <thead>
            <tr>
                <th style="width:15%">Ngày</th>
                <th style="width:35%">Khách hàng</th>
                <th style="width:30%">NV giao hàng</th>
                <th style="width:20%">Tổng tiền</th>
            </tr>
        </thead>
        <tbody id="data-container">
            <!-- Dữ liệu sẽ được thêm vào đây bằng JavaScript -->
        </tbody>
    </table>
    
    <div class="signature-section">
        <div class="signature-box">
            <div class="signature-line"></div>
            <div>Người bàn giao</div>
        </div>
        <div class="signature-box">
            <div class="signature-line"></div>
            <div>NV giao hàng</div>
        </div>
    </div>

    <script>
    (function() {
        const spreadsheetId = '1WpNbn9DRdRtRwV6uZge-KuzhWw1NVG65FBl2S4eC08Q';
        const sheetIdMain = '116599712';
        const sheetIdLookup = '2007395895';
        let originalData = [];
        
        function getUrlParameter(name) {
            name = name.replace(/[[\]]/g, '\\$&');
            const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
            const results = regex.exec(window.location.href);
            if (!results) return null;
            return results[2] ? decodeURIComponent(results[2].replace(/\+/g, ' ')) : '';
        }
        
        function showDateTime() {
            const now = new Date();
            const dd = String(now.getDate()).padStart(2,'0');
            const mm = String(now.getMonth()+1).padStart(2,'0');
            const yyyy = now.getFullYear();
            const hh = String(now.getHours()).padStart(2,'0');
            const min = String(now.getMinutes()).padStart(2,'0');
            document.getElementById('delivery-date').textContent = `${dd}/${mm}/${yyyy}`;
            document.getElementById('delivery-time').textContent = `${hh}:${min}`;
        }
        
        function formatCurrency(amount) {
            return amount ? parseInt(amount).toLocaleString('vi-VN') : '0';
        }
        
        function loadData() {
            showDateTime();
            
            fetch(`https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?gid=${sheetIdLookup}`)
                .then(res => res.text())
                .then(txt => {
                    const lookupRows = JSON.parse(txt.substring(47).slice(0,-2)).table.rows;
                    const driverMap = lookupRows.reduce((map,row) => {
                        const key = row.c[0]?.v, val = row.c[2]?.v;
                        if (key && val) map[key] = val;
                        return map;
                    }, {});
                    return fetch(`https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?gid=${sheetIdMain}`)
                        .then(res => res.text())
                        .then(txt2 => ({ driverMap, txt2 }));
                })
                .then(({ driverMap, txt2 }) => {
                    const rows = JSON.parse(txt2.substring(47).slice(0,-2)).table.rows;
                    originalData = rows.map(row => {
                        const dateText = row.c[41]?.f || row.c[41]?.v;
                        const customer = row.c[7]?.f || row.c[7]?.v || '';
                        const drivers = (row.c[39]?.v || '').split(',').map(v => v.trim());
                        const amount = parseInt(row.c[16]?.v) || 0;
                        return dateText && customer.trim() ? { 
                            AP: dateText.toString().trim(), 
                            H: customer.toString().trim(), 
                            AN: drivers, 
                            Q: amount 
                        } : null;
                    }).filter(x => x);
                    
                    displayFilteredData(driverMap);
                })
                .catch(err => {
                    console.error('Lỗi tải dữ liệu:', err);
                    document.getElementById('data-container').innerHTML = 
                        '<tr><td colspan="4" style="text-align: center; padding: 10px;">Không thể tải dữ liệu. Vui lòng thử lại sau.</td></tr>';
                });
        }
        
        function displayFilteredData(driverMap) {
            const ngay = getUrlParameter('ngay');
            const ten = getUrlParameter('ten');
            
            const filtered = originalData.filter(item => {
                if (ngay && item.AP !== ngay) return false;
                if (ten) {
                    const names = item.AN.map(a => driverMap[a] || a);
                    return names.includes(ten);
                }
                return true;
            });
            
            const grouped = filtered.reduce((acc, item) => {
                if (!acc[item.H]) {
                    acc[item.H] = { 
                        ...item, 
                        AN: new Set(item.AN), 
                        Q: item.Q 
                    };
                } else { 
                    acc[item.H].Q += item.Q; 
                    item.AN.forEach(a => acc[item.H].AN.add(a)); 
                }
                return acc;
            }, {});
            
            const data = Object.entries(grouped).map(([_, v]) => ({ 
                AP: v.AP, 
                H: v.H, 
                AN: Array.from(v.AN), 
                Q: v.Q 
            }));
            
            // Sắp xếp dữ liệu theo ngày
            data.sort((a, b) => {
                const dateA = a.AP.split('/').reverse().join('');
                const dateB = b.AP.split('/').reverse().join('');
                return dateA.localeCompare(dateB);
            });
            
            document.getElementById('total-orders').textContent = data.length;
            document.getElementById('total-receivable').textContent = formatCurrency(
                data.reduce((s, i) => s + i.Q, 0)
            );
            
            let html = '';
            if (data.length === 0) {
                html = '<tr><td colspan="4" style="text-align: center; padding: 10px;">Không có dữ liệu phù hợp</td></tr>';
            } else {
                data.forEach(item => {
                    const drivers = item.AN.map(a => driverMap[a] || a).join(', ');
                    html += `
                        <tr>
                            <td style="text-align: center">${item.AP}</td>
                            <td>${item.H}</td>
                            <td>${drivers}</td>
                            <td style="text-align: right">${formatCurrency(item.Q)}</td>
                        </tr>
                    `;
                });
            }
            
            document.getElementById('data-container').innerHTML = html;
        }
        
        window.addEventListener('load', loadData);
    })();
    </script>
</body>
</html>















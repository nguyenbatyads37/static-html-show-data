<!DOCTYPE html>
<html lang="vi">
<head>
    <!-- Phần head giữ nguyên như trước -->
</head>
<body>
    <!-- Phần HTML giữ nguyên như trước -->

    <script>
        // ... (Các hàm phụ trợ giữ nguyên)

        // Hàm chuẩn hóa ngày từ Google Sheets
        function normalizeSheetDate(dateValue) {
            if (!dateValue) return null;
            
            try {
                // Xử lý trường hợp là đối tượng Date
                if (typeof dateValue === 'object' && dateValue.getTime) {
                    return dateValue.toISOString().split('T')[0]; // YYYY-MM-DD
                }
                
                // Xử lý trường hợp là chuỗi
                const strValue = dateValue.toString().trim();
                
                // Thử phân tích các định dạng khác nhau
                const formats = [
                    // Định dạng Google Sheets (Date(2024,4,30))
                    { regex: /Date\((\d+),(\d+),(\d+)\)/, handler: (m) => new Date(m[1], m[2], m[3]) },
                    
                    // Định dạng dd/mm/yyyy hoặc d/m/yyyy
                    { regex: /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/, handler: (m) => new Date(m[3], m[2]-1, m[1]) },
                    
                    // Định dạng dd/mm hoặc d/m (tự động thêm năm hiện tại)
                    { regex: /^(\d{1,2})\/(\d{1,2})$/, handler: (m) => {
                        const now = new Date();
                        return new Date(now.getFullYear(), m[2]-1, m[1]);
                    }},
                    
                    // Định dạng yyyy-mm-dd
                    { regex: /^(\d{4})-(\d{1,2})-(\d{1,2})$/, handler: (m) => new Date(m[1], m[2]-1, m[3]) }
                ];
                
                for (const format of formats) {
                    const match = strValue.match(format.regex);
                    if (match) {
                        const date = format.handler(match);
                        if (!isNaN(date.getTime())) {
                            return date.toISOString().split('T')[0];
                        }
                    }
                }
                
                return null;
            } catch (e) {
                console.warn('Lỗi xử lý ngày:', e);
                return null;
            }
        }

        // Trong hàm loadMainSheet():
        originalData = jsonData.table.rows
            .map(row => {
                // Lấy và chuẩn hóa ngày từ cột AP (index 41)
                const dateAP = normalizeSheetDate(row.c[41]?.v);
                
                // Lấy tên khách hàng từ cột H (index 7)
                const customerName = (row.c[7]?.f || row.c[7]?.v || '').toString().trim();
                
                // Chỉ giữ lại các bản ghi có ngày và tên khách hợp lệ
                if (!dateAP || !customerName) return null;
                
                return {
                    AP: dateAP,
                    H: customerName,
                    AN: (row.c[39]?.v?.toString().trim() || '').split(',').map(v => v.trim()).filter(v => v),
                    Q: parseInt(row.c[16]?.v) || 0
                };
            })
            .filter(item => item !== null); // Lọc bỏ các bản ghi không hợp lệ

        // Hàm lọc theo ngày từ URL
        function filterByDate(data, dateParam) {
            if (!dateParam) return data;
            
            // Chuẩn hóa ngày từ URL (định dạng d/m hoặc dd/mm)
            const urlDate = normalizeSheetDate(dateParam);
            if (!urlDate) return data;
            
            console.log('Lọc theo ngày:', urlDate); // Debug
            return data.filter(item => item.AP === urlDate);
        }

        // Trong hàm loadData():
        const urlDateParam = getUrlParameter('ngay');
        originalData = filterByDate(originalData, urlDateParam);

        // ... (Phần còn lại giữ nguyên)
    </script>
</body>
</html>


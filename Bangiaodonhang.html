<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PHIẾU BÀN GIAO ĐƠN HÀNG</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0 auto;
            padding: 10px;
            line-height: 1.5;
            font-size: 18px;
            max-width: 210mm;
            box-sizing: border-box;
        }
        .header {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
        }
        .logo {
            max-width: 200px;
            margin-right: 20px;
        }
        .ad-content {
            flex: 1;
            text-align: center;
        }
        .ad-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 4px;
        }
        .ad-info {
            font-size: 16px;
            font-weight: bold;
            margin: 2px 0;
        }
        h1 {
            color: #1a73e8;
            text-align: center;
            margin-bottom: 5px;
            font-size: 24px;
        }
        .datetime {
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .datetime span {
            display: inline-block;
            margin: 0 10px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 15px;
            font-size: 18px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 6px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        #summary-info {
            background-color: #f5f5f5;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-weight: bold;
            font-size: 18px;
        }
        #summary-info div {
            margin: 4px 0;
        }
        .signature-section {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
        }
        .signature-box {
            text-align: center;
            width: 45%;
            font-size: 18px;
        }
        .signature-line {
            border-top: 2px solid #000;
            margin-top: 30px;
            width: 100%;
        }
        .refresh-btn,
        #loading,
        #error {
            display: none !important;
        }
        @page {
            size: A4 portrait;
            margin: 15mm;
        }
        @media print {
            body { margin: 0; padding: 0; }
            thead { display: table-header-group; }
            tr { page-break-inside: avoid; }
            th { -webkit-print-color-adjust: exact; }
        }
    </style>
</head>
<body>
    <div class="header">
        <img src="https://www.appsheet.com/template/gettablefileurl?appName=B%C3%A1ogi%C3%A1s%E1%BA%A3nph%E1%BA%A9m-325045268&tableName=c%C3%A0i%20%C4%91%E1%BA%B7t%20APP&fileName=C%C3%A0i%20%C4%91%E1%BA%B7t%20APP_Images%2F79ab1bb2.%E1%BA%A2nh.040547.jpg" alt="Logo" class="logo">
        <div class="ad-content">
            <div class="ad-title">NPP HÀ HÒA</div>
            <div class="ad-info">Phân phối các mặt hàng đồ dùng 1 lần: Nilon, Cốc nhựa, Cốc giấy, Khay xốp các loại, Chai nhựa, Màng bọc thực phẩm, …</div>
            <div class="ad-info">ĐC: Tiên Phong, Ba Vì, Hà Nội</div>
            <div class="ad-info">Góp ý chất lượng sản phẩm & dịch vụ: 0973.905.992</div>
            <div class="ad-info">Liên hệ nhà phân phối: 0969.250.323</div>
        </div>
    </div>
    <h1>PHIẾU BÀN GIAO ĐƠN HÀNG</h1>
    <div class="datetime">
        <span>Ngày bàn giao: <span id="delivery-date"></span></span>
        <span>Giờ bàn giao: <span id="delivery-time"></span></span>
    </div>
    <div id="summary-info">
        <div>Tổng Đơn: <span id="total-orders">0</span></div>
        <div>Tổng tiền hàng phải thu: <span id="total-receivable">0</span> VNĐ</div>
    </div>
    <div id="data-container" style="overflow-x:auto;"></div>
    <div class="signature-section">
        <div class="signature-box">
            <div>Người bàn giao</div>
            <div class="signature-line"></div>
        </div>
        <div class="signature-box">
            <div>NV giao hàng</div>
            <div class="signature-line"></div>
        </div>
    </div>
    <script>
    (function() {
        const spreadsheetId = '1WpNbn9DRdRtRwV6uZge-KuzhWw1NVG65FBl2S4eC08Q';
        const sheetIdMain = '116599712';
        const sheetIdLookup = '2007395895';
        let originalData = [];
        function getUrlParameter(name) {
            name = name.replace(/[[\]]/g, '\\$&');
            const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
            const results = regex.exec(window.location.href);
            if (!results) return null;
            return results[2] ? decodeURIComponent(results[2].replace(/\+/g, ' ')) : '';
        }
        function showDateTime() {
            const now = new Date();
            const dd = String(now.getDate()).padStart(2,'0');
            const mm = String(now.getMonth()+1).padStart(2,'0');
            const yyyy = now.getFullYear();
            const hh = String(now.getHours()).padStart(2,'0');
            const min = String(now.getMinutes()).padStart(2,'0');
            document.getElementById('delivery-date').textContent = `${dd}/${mm}/${yyyy}`;
            document.getElementById('delivery-time').textContent = `${hh}:${min}`;
        }
        function formatCurrency(amount) {
            return amount ? parseInt(amount).toLocaleString('vi-VN') : '0';
        }
        function loadData() {
            showDateTime();
            fetch(`https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?gid=${sheetIdLookup}`)
                .then(res => res.text())
                .then(txt => {
                    const lookupRows = JSON.parse(txt.substring(47).slice(0,-2)).table.rows;
                    const driverMap = lookupRows.reduce((map,row) => {
                        const key = row.c[0]?.v, val = row.c[2]?.v;
                        if (key && val) map[key] = val;
                        return map;
                    }, {});
                    return fetch(`https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?gid=${sheetIdMain}`)
                        .then(res => res.text())
                        .then(txt2 => ({ driverMap, txt2 }));
                })
                .then(({ driverMap, txt2 }) => {
                    const rows = JSON.parse(txt2.substring(47).slice(0,-2)).table.rows;
                    originalData = rows.map(row => {
                        const dateText = row.c[41]?.f || row.c[41]?.v;
                        const customer = row.c[7]?.f || row.c[7]?.v || '';
                        const drivers = (row.c[39]?.v || '').split(',').map(v => v.trim());
                        const amount = parseInt(row.c[16]?.v) || 0;
                        return dateText && customer.trim() ? { AP: dateText.toString().trim(), H: customer.toString().trim(), AN: drivers, Q: amount } : null;
                    }).filter(x => x);
                    displayFilteredData(driverMap);
                })
                .catch(err => console.error('Lỗi tải dữ liệu:', err));
        }
        function displayFilteredData(driverMap) {
            const ngay = getUrlParameter('ngay');
            const ten = getUrlParameter('ten');
            const filtered = originalData.filter(item => {
                if (ngay && item.AP !== ngay) return false;
                if (ten) {
                    const names = item.AN.map(a => driverMap[a] || a);
                    return names.includes(ten);
                }
                return true;
            });
            const grouped = filtered.reduce((acc, item) => {
                if (!acc[item.H]) acc[item.H] = { ...item, AN: new Set(item.AN), Q: item.Q };
                else { acc[item.H].Q += item.Q; item.AN.forEach(a => acc[item.H].AN.add(a)); }
                return acc;
            }, {});
            const data = Object.entries(grouped).map(([_, v]) => ({ AP: v.AP, H: v.H, AN: Array.from(v.AN), Q: v.Q }));
            document.getElementById('total-orders').textContent = data.length;
            document.getElementById('total-receivable').textContent = formatCurrency(data.reduce((s,i)=>s+i.Q,0));
            let html = '<table><thead><tr><th>Ngày</th><th>Tên khách hàng</th><th>NV giao hàng</th><th>Tổng hóa đơn</th></tr></thead><tbody>';
            data.forEach(item => {
                const drivers = item.AN.map(a => driverMap[a] || a).join(', ');
                html += `<tr><td>${item.AP}</td><td>${item.H}</td><td>${drivers}</td><td>${formatCurrency(item.Q)}</td></tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('data-container').innerHTML = html;
        }
        window.addEventListener('load', loadData);
    })();
    </script>
</body>
</html>















<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PHIẾU BÀN GIAO ĐƠN HÀNG</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        h1 {
            color: #1a73e8;
            text-align: center;
            margin-bottom: 5px;
        }
        .sub-title {
            text-align: center;
            font-weight: bold;
            margin-bottom: 20px;
        }
        .logo {
            display: block;
            margin: 0 auto 20px;
            max-width: 200px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .loading {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #666;
        }
        .error {
            color: #d32f2f;
            padding: 10px;
            background-color: #ffebee;
            border-radius: 4px;
        }
        .refresh-btn {
            margin: 10px 0;
            padding: 8px 16px;
            background-color: #1a73e8;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .refresh-btn:hover {
            background-color: #0d5bba;
        }
        .filter-container {
            margin: 15px 0;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 4px;
        }
        .filter-control {
            margin: 5px 0;
            display: flex;
            align-items: center;
        }
        label {
            margin-right: 10px;
            font-weight: bold;
        }
        input, select {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .selected-date {
            margin-left: 10px;
            font-style: italic;
            font-weight: bold;
            font-size: 16px;
        }
        .signature-section {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
        }
        .signature-box {
            text-align: center;
            width: 200px;
        }
        .signature-line {
            border-top: 1px solid #000;
            margin-top: 50px;
            width: 100%;
        }
        .date-display {
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
        }
        #summary-info {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-weight: bold;
            font-size: 16px;
        }
        #summary-info div {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <img src="https://www.appsheet.com/template/gettablefileurl?appName=B%C3%A1ogi%C3%A1s%E1%BA%A3nph%E1%BA%A9m-325045268&tableName=c%C3%A0i%20%C4%91%E1%BA%B7t%20APP&fileName=C%C3%A0i%20%C4%91%E1%BA%B7t%20APP_Images%2F79ab1bb2.%E1%BA%A2nh.040547.jpg" alt="Logo" class="logo">
    <h1>PHIẾU BÀN GIAO ĐƠN HÀNG</h1>
    <div class="sub-title">Ngày bàn giao: <span id="delivery-date"></span></div>
    
    <div class="date-display" id="filtered-date-display"></div>
    
    <button class="refresh-btn" onclick="loadData()">Làm mới dữ liệu</button>
    
    <div class="filter-container">
        <h3>Bộ lọc</h3>
        <div class="filter-control">
            <label>Tài xế:</label>
            <select id="anFilter" onchange="filterData()">
                <option value="">Tất cả</option>
            </select>
        </div>
    </div>
    
    <div id="loading" class="loading">Đang tải dữ liệu...</div>
    <div id="error" class="error" style="display: none;"></div>
    
    <!-- Phần tổng hợp thông tin -->
    <div id="summary-info">
        <div>Tổng Đơn: <span id="total-orders">0</span></div>
        <div>Tổng tiền hàng phải thu: <span id="total-receivable">0</span> VNĐ</div>
    </div>
    
    <div id="data-container" style="overflow-x: auto;"></div>
    
    <div class="signature-section">
        <div class="signature-box">
            <div>Người bàn giao</div>
            <div class="signature-line"></div>
        </div>
        <div class="signature-box">
            <div>Tài xế</div>
            <div class="signature-line"></div>
        </div>
    </div>

    <script>
        // Cấu hình Google Sheets
        const spreadsheetId = '1WpNbn9DRdRtRwV6uZge-KuzhWw1NVG65FBl2S4eC08Q';
        const sheetIdMain = '116599712';
        const sheetIdLookup = '2007395895';
        
        // Biến toàn cục
        let originalData = [];
        let filteredData = [];
        let uniqueANValues = [];
        let anToCMap = {};
        let currentFilterDate = '';
        
        // Hàm lấy tham số từ URL
        function getUrlParameter(name) {
            name = name.replace(/[\[\]]/g, '\\$&');
            const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
            const results = regex.exec(window.location.href);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }
        
        // Hiển thị ngày hôm nay
        function showTodayDate() {
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const year = today.getFullYear();
            document.getElementById('delivery-date').textContent = `${day}/${month}/${year}`;
        }
        
        // Chuyển DD/MM/YYYY sang YYYY-MM-DD
        function convertToIsoDate(dd_mm_yyyy) {
            if (!dd_mm_yyyy) return '';
            const parts = dd_mm_yyyy.split('/');
            if (parts.length !== 3) return '';
            return `${parts[2]}-${parts[1]}-${parts[0]}`;
        }
        
        // Chuyển YYYY-MM-DD sang DD/MM/YYYY
        function formatToDisplayDate(isoDate) {
            if (!isoDate) return '';
            const parts = isoDate.split('-');
            if (parts.length !== 3) return isoDate;
            return `${parts[2]}/${parts[1]}/${parts[0]}`;
        }
        
        // Định dạng số tiền
        function formatCurrency(amount) {
            if (!amount) return '0';
            return parseInt(amount).toLocaleString('vi-VN');
        }
        
        // Hàm chính tải dữ liệu
        function loadData() {
            showTodayDate();
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('data-container').innerHTML = '';
            document.getElementById('total-orders').textContent = '0';
            document.getElementById('total-receivable').textContent = '0';
            
            // Lấy ngày từ URL (nếu có)
            const urlDateParam = getUrlParameter('ngay');
            currentFilterDate = urlDateParam ? convertToIsoDate(urlDateParam) : '';
            
            if (currentFilterDate) {
                document.getElementById('filtered-date-display').textContent = 
                    `Dữ liệu ngày: ${formatToDisplayDate(currentFilterDate)}`;
            } else {
                document.getElementById('filtered-date-display').textContent = '';
            }
            
            // Tải dữ liệu từ sheet phụ (ánh xạ tài xế)
            fetch(`https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?gid=${sheetIdLookup}`)
                .then(response => response.text())
                .then(data => {
                    try {
                        const jsonData = JSON.parse(data.substring(47).slice(0, -2));
                        anToCMap = {};
                        jsonData.table.rows.forEach(row => {
                            const anValue = row.c[0]?.v?.toString().trim() || '';
                            const cValue = row.c[2]?.v?.toString().trim() || '';
                            if (anValue && cValue) anToCMap[anValue] = cValue;
                        });
                        loadMainSheet();
                    } catch (e) {
                        handleError('Lỗi xử lý dữ liệu phụ', e);
                    }
                })
                .catch(error => {
                    handleError('Lỗi tải dữ liệu phụ', error);
                });
        }
        
        // Tải dữ liệu chính (LẤY NGÀY TỪ CỘT AP - INDEX 41)
        function loadMainSheet() {
            fetch(`https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?gid=${sheetIdMain}`)
                .then(response => response.text())
                .then(data => {
                    document.getElementById('loading').style.display = 'none';
                    
                    try {
                        const jsonData = JSON.parse(data.substring(47).slice(0, -2));
                        if (!jsonData.table.rows.length) {
                            showError('Không có dữ liệu trong bảng tính');
                            return;
                        }
                        
                        // Xử lý dữ liệu - LẤY NGÀY TỪ CỘT AP (INDEX 41)
                        originalData = jsonData.table.rows.map(row => {
                            let dateAP = '';
                            if (row.c[41]?.v) {
                                try {
                                    const dateValue = row.c[41].v;
                                    let rawDate;
                                    
                                    if (typeof dateValue === 'string') {
                                        if (dateValue.startsWith('Date')) {
                                            const match = dateValue.match(/Date\((\d+),(\d+),(\d+)\)/);
                                            if (match) rawDate = new Date(match[1], match[2], match[3]);
                                        } else {
                                            rawDate = new Date(dateValue.includes('/') 
                                                ? dateValue.replace(/(\d+)\/(\d+)\/(\d+)/, '$3-$2-$1')
                                                : dateValue);
                                        }
                                    } else {
                                        rawDate = new Date(dateValue);
                                    }
                                    
                                    if (rawDate && !isNaN(rawDate)) {
                                        dateAP = rawDate.toISOString().split('T')[0];
                                    }
                                } catch (e) {
                                    console.warn('Lỗi xử lý ngày (cột AP):', e);
                                }
                            }
                            
                            const anRaw = row.c[39]?.v?.toString().trim() || '';
                            const anValues = anRaw.split(',').map(v => v.trim()).filter(v => v);
                            const totalAmount = row.c[16]?.v || 0;
                            
                            return {
                                AP: dateAP,  // Sử dụng cột AP thay vì E
                                H: row.c[7]?.f || row.c[7]?.v || '',
                                AN: anValues,
                                AN_Display: anValues.map(v => anToCMap[v] || v).join(', '),
                                Q: totalAmount
                            };
                        });
                        
                        // Lọc theo ngày từ URL
                        if (currentFilterDate) {
                            originalData = originalData.filter(item => item.AP === currentFilterDate);
                        }
                        
                        // Lấy danh sách tài xế duy nhất
                        uniqueANValues = [...new Set(originalData.flatMap(item => item.AN).filter(Boolean))].sort();
                        
                        // Cập nhật bộ lọc tài xế
                        updateDriverFilter();
                        
                        filterData();
                        
                    } catch (e) {
                        handleError('Lỗi xử lý dữ liệu chính', e);
                    }
                })
                .catch(error => {
                    handleError('Lỗi tải dữ liệu chính', error);
                });
        }
        
        // Cập nhật bộ lọc tài xế
        function updateDriverFilter() {
            const anFilter = document.getElementById('anFilter');
            anFilter.innerHTML = '<option value="">Tất cả</option>';
            uniqueANValues.forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = anToCMap[value] || value;
                anFilter.appendChild(option);
            });
        }
        
        // Lọc dữ liệu
        function filterData() {
            const anFilter = document.getElementById('anFilter').value;
            
            filteredData = originalData.filter(item => {
                if (anFilter && !item.AN.includes(anFilter)) return false;
                return true;
            });
            
            displayFilteredData();
        }
        
        // Hiển thị dữ liệu đã lọc
        function displayFilteredData() {
            const container = document.getElementById('data-container');
            const totalOrdersSpan = document.getElementById('total-orders');
            const totalReceivableSpan = document.getElementById('total-receivable');
            
            if (filteredData.length === 0) {
                container.innerHTML = '<p>Không có dữ liệu phù hợp với bộ lọc</p>';
                totalOrdersSpan.textContent = '0';
                totalReceivableSpan.textContent = '0';
                return;
            }

            // Tính tổng tiền phải thu
            const totalReceivable = filteredData.reduce((sum, item) => sum + (parseInt(item.Q) || 0), 0);
            
            // Đếm số khách hàng không trùng
            const uniqueCustomers = new Set(filteredData.map(item => item.H).filter(Boolean));
            const totalOrders = uniqueCustomers.size;

            // Hiển thị tổng
            totalOrdersSpan.textContent = totalOrders;
            totalReceivableSpan.textContent = formatCurrency(totalReceivable);

            // Tạo bảng dữ liệu
            let html = '<table><thead><tr>';
            html += '<th>Ngày</th>';
            html += '<th>Tên khách hàng</th>';
            html += '<th>Tài xế</th>';
            html += '<th>Tổng hóa đơn</th>';
            html += '</tr></thead><tbody>';

            let lastCustomerName = null;
            filteredData.forEach(item => {
                html += '<tr>';
                html += `<td>${formatToDisplayDate(item.AP)}</td>`;
                
                // Chỉ hiển thị tên khách hàng nếu khác dòng trước
                if (item.H === lastCustomerName) {
                    html += '<td></td>';
                } else {
                    html += `<td>${item.H}</td>`;
                    lastCustomerName = item.H;
                }
                
                html += `<td>${item.AN_Display}</td>`;
                html += `<td>${formatCurrency(item.Q)}</td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        // Xử lý lỗi
        function handleError(context, error) {
            document.getElementById('loading').style.display = 'none';
            showError(`${context}: ${error.message}`);
            console.error(context, error);
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.style.display = 'block';
            errorDiv.textContent = message;
        }
        
        // Khởi chạy khi tải trang
        window.onload = loadData;
    </script>
</body>
</html>


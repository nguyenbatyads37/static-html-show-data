// Hàm lấy ngày hôm nay ở định dạng YYYY-MM-DD (khớp với dữ liệu)
function getTodayDate() {
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0'); // Tháng bắt đầu từ 0
    const day = String(today.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`; // Định dạng YYYY-MM-DD
}

// Hàm chuyển đổi YYYY-MM-DD sang DD/MM/YYYY
function formatToDisplayDate(isoDate) {
    if (!isoDate) return '';
    const [year, month, day] = isoDate.split('-');
    return `${day}/${month}/${year}`;
}

function loadData() {
    document.getElementById('loading').style.display = 'block';
    document.getElementById('error').style.display = 'none';
    document.getElementById('data-container').innerHTML = '';
    document.getElementById('selectedDate').textContent = '';

    // Load lookup sheet first (for column C)
    const lookupUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?gid=${sheetIdLookup}`;
    fetch(lookupUrl)
        .then(response => response.text())
        .then(data => {
            try {
                const jsonData = JSON.parse(data.substring(47).slice(0, -2));
                const rows = jsonData.table.rows;
                
                anToCMap = {};
                rows.forEach(row => {
                    const anValue = row.c[0] ? String(row.c[0].v).trim() : '';
                    const cValue = row.c[2] ? String(row.c[2].v).trim() : '';
                    if (anValue && cValue) {
                        anToCMap[anValue] = cValue;
                    }
                });
                
                loadMainSheet();
            } catch (e) {
                document.getElementById('loading').style.display = 'none';
                showError('Lỗi khi phân tích dữ liệu lookup: ' + e.message);
            }
        })
        .catch(error => {
            document.getElementById('loading').style.display = 'none';
            showError('Lỗi khi tải dữ liệu lookup: ' + error.message);
        });
}

function loadMainSheet() {
    const url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?gid=${sheetIdMain}`;
    
    fetch(url)
        .then(response => response.text())
        .then(data => {
            document.getElementById('loading').style.display = 'none';
            
            try {
                const jsonData = JSON.parse(data.substring(47).slice(0, -2));
                const columns = jsonData.table.cols.map(col => col.label);
                const rows = jsonData.table.rows;
                
                if (rows.length === 0) {
                    showError('Không có dữ liệu trong bảng tính');
                    return;
                }
                
                originalData = rows.map(row => {
                    let dateE = '';
                    if (row.c[4] && row.c[4].v) {
                        try {
                            let rawDate;
                            if (typeof row.c[4].v === 'string' && row.c[4].v.startsWith('Date')) {
                                const dateMatch = row.c[4].v.match(/Date\((\d+),(\d+),(\d+)\)/);
                                if (dateMatch) {
                                    rawDate = new Date(
                                        parseInt(dateMatch[1]),
                                        parseInt(dateMatch[2]),
                                        parseInt(dateMatch[3])
                                    );
                                }
                            } else if (typeof row.c[4].v === 'string') {
                                rawDate = new Date(row.c[4].v.replace(/(\d{2})\/(\d{2})\/(\d{4})/, '$3-$2-$1'));
                            } else {
                                rawDate = new Date(row.c[4].v);
                            }
                            
                            if (rawDate && !isNaN(rawDate)) {
                                dateE = rawDate.toISOString().split('T')[0];
                            } else {
                                console.warn('Invalid date in column E:', row.c[4]);
                            }
                        } catch (e) {
                            console.warn('Error parsing date in column E:', row.c[4], e);
                        }
                    } else {
                        console.warn('Empty or missing date in column E:', row.c[4]);
                    }
                    
                    const anRaw = row.c[39] ? String(row.c[39].v).trim() : '';
                    const anValues = anRaw ? anRaw.split(',').map(v => v.trim()).filter(v => v) : [];
                    
                    return {
                        E: dateE,
                        H: row.c[7] ? (row.c[7].f || row.c[7].v) : '',
                        I: row.c[8] ? (row.c[8].f || row.c[8].v) : '',
                        AE: row.c[30] ? (row.c[30].f || row.c[30].v) : '',
                        AN: anValues,
                        AN_Display: anValues.map(v => anToCMap[v] || v).join(', ')
                    };
                });
                
                uniqueDateValues = [...new Set(
                    originalData.map(item => item.E).filter(date => date)
                )].sort();
                
                uniqueANValues = [...new Set(
                    originalData.flatMap(item => item.AN).filter(v => v)
                )].sort();
                
                updateDateFilterOptions();
                updateANFilterOptions();
                
                // Đặt ngày hôm nay làm mặc định
                const today = getTodayDate();
                if (uniqueDateValues.includes(today)) {
                    document.getElementById('dateFilter').value = today;
                    document.getElementById('selectedDate').textContent = `Đã chọn: ${formatToDisplayDate(today)}`;
                }
                
                filterData();
            } catch (e) {
                showError('Lỗi khi phân tích dữ liệu: ' + e.message);
            }
        })
        .catch(error => {
            document.getElementById('loading').style.display = 'none';
            showError('Lỗi khi tải dữ liệu: ' + error.message);
        });
}

function updateDateFilterOptions() {
    const dateFilter = document.getElementById('dateFilter');
    dateFilter.innerHTML = '<option value="">Tất cả</option>';
    
    uniqueDateValues.forEach(date => {
        const option = document.createElement('option');
        option.value = date;
        option.textContent = formatToDisplayDate(date);
        dateFilter.appendChild(option);
    });
}

function updateANFilterOptions() {
    const anFilter = document.getElementById('anFilter');
    anFilter.innerHTML = '<option value="">Tất cả</option>';
    
    uniqueANValues.forEach(value => {
        const option = document.createElement('option');
        option.value = value;
        option.textContent = anToCMap[value] || value;
        anFilter.appendChild(option);
    });
}

function filterData() {
    const dateFilter = document.getElementById('dateFilter').value || getTodayDate(); // Mặc định là hôm nay nếu không chọn
    const anFilter = document.getElementById('anFilter').value;
    
    document.getElementById('selectedDate').textContent = dateFilter ? `Đã chọn: ${formatToDisplayDate(dateFilter)}` : '';
    
    filteredData = originalData.filter(item => {
        if (dateFilter && item.E !== dateFilter) {
            return false;
        }
        
        if (anFilter && !item.AN.includes(anFilter)) {
            return false;
        }
        
        return true;
    });
    
    displayFilteredData();
}

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PHIẾU BÀN GIAO ĐƠN HÀNG</title>
    <style>
        /* Giảm font chung về ~18px */
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
            font-size: 18px;
        }

        /* Tiêu đề chính và phụ */
        h1 {
            color: #1a73e8;
            text-align: center;
            margin-bottom: 10px;
            font-size: 24px;
        }
        .sub-title,
        .time-title {
            text-align: center;
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 20px;
        }

        /* Logo */
        .logo {
            display: block;
            margin: 0 auto 20px;
            max-width: 200px;
        }

        /* Bảng */
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            font-size: 18px;
        }
        th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        /* Tổng hợp thông tin */
        #summary-info {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-weight: bold;
            font-size: 18px;
        }
        #summary-info div {
            margin: 6px 0;
        }

        /* Chữ ký */
        .signature-section {
            display: flex;
            justify-content: space-between;
            margin-top: 50px;
        }
        .signature-box {
            text-align: center;
            width: 300px;
            font-size: 18px;
        }
        .signature-line {
            border-top: 2px solid #000;
            margin-top: 40px;
            width: 100%;
        }

        /* Ẩn nút và trạng thái khi in */
        @media print {
            .refresh-btn,
            #loading,
            #error {
                display: none !important;
            }
            body {
                margin: 1.5cm;
            }
            table {
                page-break-after: auto;
            }
            tr {
                page-break-inside: avoid;
            }
            thead {
                display: table-header-group;
            }
            tfoot {
                display: table-footer-group;
            }
            th {
                -webkit-print-color-adjust: exact;
            }
        }
    </style>
</head>
<body>
    <img src="https://www.appsheet.com/template/gettablefileurl?appName=B%C3%A1ogi%C3%A1s%E1%BA%A3nph%E1%BA%A9m-325045268&tableName=c%C3%A0i%20%C4%91%E1%BA%B7t%20APP&fileName=C%C3%A0i%20%C4%91%E1%BA%B7t%20APP_Images%2F79ab1bb2.%E1%BA%A2nh.040547.jpg" alt="Logo" class="logo">
    <h1>PHIẾU BÀN GIAO ĐƠN HÀNG</h1>
    <div class="sub-title">Ngày bàn giao: <span id="delivery-date"></span></div>
    <div class="time-title">Giờ bàn giao: <span id="delivery-time"></span></div>
    <button class="refresh-btn" onclick="loadData()">Làm mới dữ liệu</button>
    <div id="loading" class="loading">Đang tải dữ liệu...</div>
    <div id="error" class="error"></div>
    <div id="summary-info">
        <div>Tổng Đơn: <span id="total-orders">0</span></div>
        <div>Tổng tiền hàng phải thu: <span id="total-receivable">0</span> VNĐ</div>
    </div>
    <div id="data-container" style="overflow-x:auto;"></div>
    <div class="signature-section">
        <div class="signature-box">
            <div>Người bàn giao</div>
            <div class="signature-line"></div>
        </div>
        <div class="signature-box">
            <div>Tài xế</div>
            <div class="signature-line"></div>
        </div>
    </div>
<script>
(function() {
    const spreadsheetId = '1WpNbn9DRdRtRwV6uZge-KuzhWw1NVG65FBl2S4eC08Q';
    const sheetIdMain = '116599712';
    const sheetIdLookup = '2007395895';
    let originalData = [];

    function getUrlParameter(name) {
        name = name.replace(/[[\]]/g, '\\$&');
        const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
        const results = regex.exec(window.location.href);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, ' '));
    }

    function showDateTime() {
        const now = new Date();
        const dd = String(now.getDate()).padStart(2,'0');
        const mm = String(now.getMonth()+1).padStart(2,'0');
        const yyyy = now.getFullYear();
        const hh = String(now.getHours()).padStart(2,'0');
        const min = String(now.getMinutes()).padStart(2,'0');
        document.getElementById('delivery-date').textContent = `${dd}/${mm}/${yyyy}`;
        document.getElementById('delivery-time').textContent = `${hh}:${min}`;
    }

    function formatCurrency(amount) {
        return amount ? parseInt(amount).toLocaleString('vi-VN') : '0';
    }

    function loadData() {
        showDateTime();
        document.getElementById('loading').style.display = 'block';
        document.getElementById('error').style.display = 'none';
        document.getElementById('data-container').innerHTML = '';
        document.getElementById('total-orders').textContent = '0';
        document.getElementById('total-receivable').textContent = '0';

        fetch(`https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?gid=${sheetIdLookup}`)
            .then(res => res.text())
            .then(txt => {
                const lookupRows = JSON.parse(txt.substring(47).slice(0,-2)).table.rows;
                const driverMap = lookupRows.reduce((map,row) => {
                    const key = row.c[0]?.v, val = row.c[2]?.v;
                    if (key && val) map[key] = val;
                    return map;
                }, {});
                loadMain(driverMap);
            })
            .catch(err => showError('Lỗi tải dữ liệu phụ', err));
    }

    function loadMain(driverMap) {
        fetch(`https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?gid=${sheetIdMain}`)
            .then(res => res.text())
            .then(txt => {
                document.getElementById('loading').style.display = 'none';
                const rows = JSON.parse(txt.substring(47).slice(0,-2)).table.rows;
                originalData = rows.map(row => {
                    const dateText = row.c[41]?.f?.toString().trim() || row.c[41]?.v?.toString().trim();
                    const customer = (row.c[7]?.f || row.c[7]?.v || '').toString().trim();
                    const drivers = (row.c[39]?.v || '').toString().split(',').map(v => v.trim());
                    const amount = parseInt(row.c[16]?.v) || 0;
                    if (!dateText || !customer) return null;
                    return { AP: dateText, H: customer, AN: drivers, Q: amount };
                }).filter(x => x);
                displayFilteredData(driverMap);
            })
            .catch(err => showError('Lỗi tải dữ liệu chính', err));
    }

    function displayFilteredData(driverMap) {
        const ngay = getUrlParameter('ngay');
        const ten = getUrlParameter('ten');

        let filtered = originalData.filter(item => {
            if (ngay && item.AP !== ngay) return false;
            if (ten) {
                const displayNames = item.AN.map(a => driverMap[a] || a);
                if (!displayNames.includes(ten)) return false;
            }
            return true;
        });

        const grouped = filtered.reduce((acc, item) => {
            if (!acc[item.H]) acc[item.H] = { ...item, AN: Array.from(new Set(item.AN)), Q: item.Q };
            else {
                acc[item.H].Q += item.Q;
                acc[item.H].AN = Array.from(new Set(acc[item.H].AN.concat(item.AN)));
            }
            return acc;
        }, {});
        const data = Object.values(grouped);

        document.getElementById('total-orders').textContent = data.length;
        document.getElementById('total-receivable').textContent = formatCurrency(data.reduce((s, i) => s + i.Q, 0));

        let html = '<table><thead><tr>' +
                   '<th>Ngày</th><th>Tên khách hàng</th><th>Tài xế</th><th>Tổng hóa đơn</th>' +
                   '</tr></thead><tbody>';
        data.forEach(item => {
            html += '<tr>' +
                    `<td>${item.AP}</td>` +
                    `<td>${item.H}</td>` +
                    `<td>${item.AN.map(a => driverMap[a] || a).join(', ')}</td>` +
                    `<td>${formatCurrency(item.Q)}</td>` +
                    '</tr>';
        });
        html += '</tbody></table>';
        document.getElementById('data-container').innerHTML = html;
    }

    function showError(msg, err) {
        document.getElementById('loading').style.display = 'none';
        const e = document.getElementById('error');
        e.style.display = 'block';
        e.textContent = `${msg}: ${err.message || err}`;
    }

    window.addEventListener('load', loadData);
    window.loadData = loadData;
})();
</script>
</body>
</html>









<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PHIẾU BÀN GIAO ĐƠN HÀNG</title>
    <style>
        /* Giữ nguyên phần CSS như trước */
    </style>
</head>
<body>
    <!-- Giữ nguyên phần HTML như trước -->

    <script>
        const spreadsheetId = '1WpNbn9DRdRtRwV6uZge-KuzhWw1NVG65FBl2S4eC08Q';
        const sheetIdMain = '116599712';
        const sheetIdLookup = '2007395895';
        
        let originalData = [];
        let filteredData = [];
        let uniqueANValues = [];
        let uniqueDateValues = [];
        let anToCMap = {};
        
        // Hàm lấy tham số từ URL
        function getUrlParameter(name) {
            name = name.replace(/[\[\]]/g, '\\$&');
            const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
            const results = regex.exec(window.location.href);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }
        
        // Chuyển DD/MM/YYYY sang YYYY-MM-DD
        function convertToIsoDate(dd_mm_yyyy) {
            if (!dd_mm_yyyy) return '';
            const [day, month, year] = dd_mm_yyyy.split('/');
            return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
        }
        
        // Chuyển YYYY-MM-DD sang DD/MM/YYYY
        function formatToDisplayDate(isoDate) {
            if (!isoDate) return '';
            const [year, month, day] = isoDate.split('-');
            return `${day}/${month}/${year}`;
        }
        
        function loadData() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('data-container').innerHTML = '';
            document.getElementById('selectedDate').textContent = '';
            
            // Load dữ liệu từ sheet phụ trước
            const lookupUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?gid=${sheetIdLookup}`;
            fetch(lookupUrl)
                .then(response => response.text())
                .then(data => {
                    try {
                        const jsonData = JSON.parse(data.substring(47).slice(0, -2));
                        const rows = jsonData.table.rows;
                        
                        anToCMap = {};
                        rows.forEach(row => {
                            const anValue = row.c[0] ? String(row.c[0].v).trim() : '';
                            const cValue = row.c[2] ? String(row.c[2].v).trim() : '';
                            if (anValue && cValue) {
                                anToCMap[anValue] = cValue;
                            }
                        });
                        
                        loadMainSheet();
                    } catch (e) {
                        document.getElementById('loading').style.display = 'none';
                        showError('Lỗi khi xử lý dữ liệu phụ: ' + e.message);
                    }
                })
                .catch(error => {
                    document.getElementById('loading').style.display = 'none';
                    showError('Lỗi khi tải dữ liệu phụ: ' + error.message);
                });
        }
        
        function loadMainSheet() {
            const url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?gid=${sheetIdMain}`;
            
            fetch(url)
                .then(response => response.text())
                .then(data => {
                    document.getElementById('loading').style.display = 'none';
                    
                    try {
                        const jsonData = JSON.parse(data.substring(47).slice(0, -2));
                        const rows = jsonData.table.rows;
                        
                        if (rows.length === 0) {
                            showError('Không có dữ liệu trong bảng tính');
                            return;
                        }
                        
                        // Xử lý dữ liệu từ Google Sheets
                        originalData = rows.map(row => {
                            let dateE = '';
                            if (row.c[4] && row.c[4].v) {
                                try {
                                    const dateValue = row.c[4].v;
                                    let rawDate;
                                    
                                    if (typeof dateValue === 'string' && dateValue.startsWith('Date')) {
                                        const dateMatch = dateValue.match(/Date\((\d+),(\d+),(\d+)\)/);
                                        if (dateMatch) {
                                            rawDate = new Date(
                                                parseInt(dateMatch[1]),
                                                parseInt(dateMatch[2]),
                                                parseInt(dateMatch[3])
                                            );
                                        }
                                    } else if (typeof dateValue === 'string') {
                                        rawDate = new Date(dateValue.includes('/') 
                                            ? dateValue.replace(/(\d{2})\/(\d{2})\/(\d{4})/, '$3-$2-$1')
                                            : dateValue);
                                    } else {
                                        rawDate = new Date(dateValue);
                                    }
                                    
                                    if (rawDate && !isNaN(rawDate.getTime())) {
                                        dateE = rawDate.toISOString().split('T')[0];
                                    }
                                } catch (e) {
                                    console.warn('Lỗi xử lý ngày:', e);
                                }
                            }
                            
                            const anRaw = row.c[39] ? String(row.c[39].v).trim() : '';
                            const anValues = anRaw ? anRaw.split(',').map(v => v.trim()).filter(v => v) : [];
                            
                            return {
                                E: dateE,
                                H: row.c[7] ? (row.c[7].f || row.c[7].v) : '',
                                I: row.c[8] ? (row.c[8].f || row.c[8].v) : '',
                                AE: row.c[30] ? (row.c[30].f || row.c[30].v) : '',
                                AN: anValues,
                                AN_Display: anValues.map(v => anToCMap[v] || v).join(', ')
                            };
                        });
                        
                        // Lấy danh sách ngày duy nhất
                        uniqueDateValues = [...new Set(
                            originalData.map(item => item.E).filter(date => date)
                        )].sort();
                        
                        // Lấy danh sách tài xế duy nhất
                        uniqueANValues = [...new Set(
                            originalData.flatMap(item => item.AN).filter(v => v)
                        )].sort();
                        
                        // Cập nhật bộ lọc
                        updateDateFilterOptions();
                        updateANFilterOptions();
                        
                        // Lấy ngày từ tham số URL (nếu có)
                        const urlDate = getUrlParameter('ngay');
                        let selectedDate = '';
                        
                        if (urlDate) {
                            // Chuyển đổi ngày từ URL sang định dạng ISO
                            selectedDate = convertToIsoDate(urlDate);
                            
                            // Kiểm tra nếu ngày tồn tại trong dữ liệu
                            if (uniqueDateValues.includes(selectedDate)) {
                                document.getElementById('dateFilter').value = selectedDate;
                                document.getElementById('selectedDate').textContent = `Đã chọn: ${urlDate}`;
                            } else {
                                document.getElementById('selectedDate').textContent = `Không có dữ liệu cho ngày ${urlDate}`;
                            }
                        }
                        
                        filterData();
                    } catch (e) {
                        showError('Lỗi khi xử lý dữ liệu chính: ' + e.message);
                    }
                })
                .catch(error => {
                    document.getElementById('loading').style.display = 'none';
                    showError('Lỗi khi tải dữ liệu chính: ' + error.message);
                });
        }
        
        function updateDateFilterOptions() {
            const dateFilter = document.getElementById('dateFilter');
            dateFilter.innerHTML = '<option value="">Tất cả</option>';
            
            uniqueDateValues.forEach(date => {
                const option = document.createElement('option');
                option.value = date;
                option.textContent = formatToDisplayDate(date);
                dateFilter.appendChild(option);
            });
        }
        
        function updateANFilterOptions() {
            const anFilter = document.getElementById('anFilter');
            anFilter.innerHTML = '<option value="">Tất cả</option>';
            
            uniqueANValues.forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = anToCMap[value] || value;
                anFilter.appendChild(option);
            });
        }
        
        function filterData() {
            const dateFilter = document.getElementById('dateFilter').value;
            const anFilter = document.getElementById('anFilter').value;
            
            filteredData = originalData.filter(item => {
                if (dateFilter && item.E !== dateFilter) return false;
                if (anFilter && !item.AN.includes(anFilter)) return false;
                return true;
            });
            
            displayFilteredData();
        }
        
        function displayFilteredData() {
            const container = document.getElementById('data-container');
            
            if (filteredData.length === 0) {
                container.innerHTML = '<p>Không có dữ liệu phù hợp với bộ lọc</p>';
                return;
            }
            
            let html = '<table><thead><tr>';
            html += '<th>Ngày</th>';
            html += '<th>Tên khách hàng</th>';
            html += '<th>SĐT</th>';
            html += '<th>Tên SP</th>';
            html += '<th>Tài xế</th>';
            html += '</tr></thead><tbody>';
            
            filteredData.forEach(item => {
                html += '<tr>';
                html += `<td>${formatToDisplayDate(item.E) || ''}</td>`;
                html += `<td>${item.H || ''}</td>`;
                html += `<td>${item.I || ''}</td>`;
                html += `<td>${item.AE || ''}</td>`;
                html += `<td>${item.AN_Display || ''}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.style.display = 'block';
            errorDiv.textContent = message;
        }
        
        // Tự động tải dữ liệu khi trang được load
        window.onload = loadData;
    </script>
</body>
</html>

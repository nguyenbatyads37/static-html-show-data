<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Báo cáo tổng hợp</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    /* --- CÀI ĐẶT CHUNG & TABS --- */
    :root {
        --primary-color: #2d7c2d;
        --primary-light: #4CAF50;
        --primary-dark: #1b4b1b;
        --secondary-color: #FFC107;
        --accent-color: #2196F3;
        --text-dark: #333;
        --text-medium: #555;
        --bg-light: #f4f4f4;
        --border-color: #e0e0e0;
        --font-main: 'Roboto', Arial, sans-serif;
        --gold: #FFD700;
        --silver: #C0C0C0;
        --bronze: #CD7F32;
    }
    
    body { 
        font-family: var(--font-main); 
        padding: 20px; 
        background-color: var(--bg-light); 
        color: var(--text-dark);
        line-height: 1.6;
    }
    
    .tab-container { 
        overflow: hidden; 
        border-bottom: 2px solid var(--border-color); 
        margin-bottom: 30px; 
        background-color: #fff;
        padding: 0 10px;
        border-radius: 8px 8px 0 0;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .tab-container button {
      background-color: transparent; 
      float: left; 
      border: none; 
      outline: none; 
      cursor: pointer;
      padding: 14px 20px; 
      transition: all 0.3s ease; 
      font-size: 17px; 
      font-weight: 500;
      color: var(--text-medium);
      border-bottom: 3px solid transparent;
      margin-right: 5px;
    }
    .tab-container button:hover { 
        background-color: #f9f9f9;
        color: var(--primary-dark);
    }
    .tab-container button.active { 
        color: var(--primary-color); 
        font-weight: 700;
        border-bottom-color: var(--primary-color);
    }
    .tab-content { 
        display: none; 
        padding: 6px 12px; 
        border-top: none; 
        animation: fadeIn 0.5s;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* --- STYLES CHUNG CHO BẢNG & CĂN LỀ --- */
    .table-responsive-container { overflow-x: auto; }
    table { 
        width: 100%; 
        border-collapse: collapse; 
        table-layout: auto; 
        margin-top: 20px; 
        background: #fff; 
        border-radius: 8px; 
        overflow: hidden; 
        box-shadow: 0 4px 8px rgba(0,0,0,0.07);
    }
    th, td { 
        border: 1px solid var(--border-color); 
        padding: 12px 15px;
        white-space: nowrap; 
        vertical-align: middle; 
    }
    
    th { text-align: center !important; font-weight: 500; }
    td { text-align: right !important; }
    .text-left { text-align: left !important; }
    .text-center { text-align: center !important; }

    tbody tr:nth-child(even) { background-color: #f9f9f9; }
    
    /* --- DÒNG TỔNG CỘNG --- */
    tr.total-row, tr.total-row:hover { 
      background: #fffde7; 
      font-weight: 700; 
      font-size: 1.05em;
      color: #333;
      border-top: 3px solid var(--primary-color);
    }
    .total-label { text-align: left !important; }

    /* === TAB 1: BÁO CÁO CHI PHÍ === */
    #CostReport th.green-header { background: var(--primary-light); color: white; }
    #CostReport th.yellow-header { background: var(--secondary-color); color: var(--text-dark); }
    #CostReport .report-container { display: flex; gap: 20px; }
    #CostReport .sidebar { width: 260px; flex-shrink: 0; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    #CostReport .sidebar h3 { background: var(--primary-color); color: #fff; padding: 10px; margin-top: 10px; font-size: 16px; border-radius: 4px; }
    #CostReport .sidebar label { display: block; margin: 8px 0; font-size: 14px; }
    #CostReport .sidebar .indent { margin-left: 16px; }
    #CostReport .sidebar input[type="date"] { width: 100%; box-sizing: border-box; padding: 6px; margin: 4px 0 10px; border: 1px solid #ccc; border-radius: 4px;}
    #CostReport .main-detailed { flex-grow: 1; }
    #CostReport .header { display: flex; align-items: center; margin-bottom: 10px; }
    #CostReport .header img { height: 60px; margin-right: 15px; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    #CostReport .header h2 { margin: 0; color: var(--primary-color); font-weight: 700; }
    #CostReport .daily-breakdown h3 { margin-top: 30px; background: #f0f0f0; padding: 10px; border-left: 5px solid var(--primary-color); border-radius: 4px; }
    #CostReport .charts-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    #CostReport .chart-wrapper { background: #fff; padding: 15px; border-radius: 12px; box-shadow: 0 6px 12px rgba(0,0,0,0.1); transition: opacity 0.4s ease-in-out; }
    #CostReport .chart-wrapper canvas { width: 100% !important; height: 400px !important; }
    #CostReport .chart-toggle-controls { margin: 20px 0; padding: 10px; background: #eee; border-radius: 8px; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }

    /* === TAB 2: BÁO CÁO SALE === */
    #SaleReport .report-container { display: flex; flex-wrap: wrap; gap: 20px; align-items: flex-start; max-width: 1800px; margin: 0 auto; }
    #SaleReport th { background: var(--primary-light); color: white; font-weight: 700; font-size: 1.05em; text-transform: uppercase; }
    #SaleReport tbody tr { cursor: pointer; }
    #SaleReport tbody tr:not(.row-selected):hover { background-color: rgba(139, 195, 74, 0.08); }
    #SaleReport tbody tr.row-selected, #SaleReport tbody tr.row-selected:hover { background-color: #FFF59D !important; color: var(--text-dark) !important; font-weight: 600; }
    #SaleReport .sidebar { width: 280px; flex-shrink: 0; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 15px rgba(0,0,0,0.05); position: sticky; top: 20px; max-height: calc(100vh - 40px); overflow-y: auto; }
    #SaleReport .main-detailed { flex-grow: 1; min-width: 0; width: calc(100% - 300px); }
    #SaleReport .sidebar h3 { background: var(--primary-color); color: #fff; padding: 12px 15px; margin: 20px 0 10px; border-radius: 6px; font-size: 1.1em; }
    #SaleReport .sidebar label { display: block; margin: 12px 0; font-size: 0.95em; color: var(--text-medium); }
    #SaleReport .sidebar .indent { margin-left: 20px; }
    #SaleReport .sidebar input[type="date"] { width: 100%; box-sizing: border-box; padding: 10px 12px; margin: 6px 0 12px; border: 1px solid var(--border-color); border-radius: 6px; }
    #SaleReport .header { display: flex; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
    #SaleReport .header img { height: 70px; width: 70px; margin-right: 20px; border-radius: 8px; object-fit: cover; }
    #SaleReport .header h2 { margin: 0; color: var(--primary-color); font-size: 1.8em; font-weight: 700; }
    #SaleReport .daily-breakdown h3 { margin: 30px 0 15px; background: #f8f9fa; padding: 12px 15px; border-left: 4px solid var(--primary-color); border-radius: 0 6px 6px 0; }
    @media (max-width: 1200px) { #SaleReport .report-container { flex-direction: column; } #SaleReport .sidebar, #SaleReport .main-detailed { width: 100%; position: static; max-height: none; } }

    /* --- HIỆU ỨNG CHUNG --- */
    .bg-green { background-color: var(--primary-light) !important; color: white; }
    .bg-yellow { background-color: var(--secondary-color) !important; color: var(--text-dark); }
    .top-1, .top-2, .top-3 { border-left: 5px solid; font-weight: 700 !important; }
    .top-1 { background-color: #fffbeb; border-color: var(--gold); }
    .top-2 { background-color: #f5f7fa; border-color: var(--silver); }
    .top-3 { background-color: #fff5eb; border-color: var(--bronze); }
    
    /* --- CHỈ BÁO ĐANG TẢI --- */
    #loading-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255, 255, 255, 0.85); display: flex; justify-content: center; align-items: center;
      z-index: 9999; font-size: 1.2em; color: var(--primary-color);
      transition: all 0.3s ease; visibility: hidden; opacity: 0; backdrop-filter: blur(3px);
    }
    #loading-overlay.visible { visibility: visible; opacity: 1; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
</head>
<body>
  
  <div id="loading-overlay">Đang tải dữ liệu...</div>

  <div class="tab-container">
    <button class="tablinks" onclick="openTab(event, 'CostReport')" id="defaultOpen">Báo cáo chi phí</button>
    <button class="tablinks" onclick="openTab(event, 'SaleReport')">Báo cáo Sale</button>
  </div>
  
  <!-- ======================= TAB 1: BÁO CÁO CHI PHÍ ======================= -->
  <div id="CostReport" class="tab-content">
     <div class="report-container">
        <div class="sidebar">
          <h3>Ngày</h3> <label>Từ ngày:<input type="date" id="start-date-tab1"></label> <label>Đến ngày:<input type="date" id="end-date-tab1"></label>
          <h3>Sản phẩm</h3> <label><input type="checkbox" id="product-all-tab1" checked> Tất cả</label> <div id="product-options-tab1"></div>
          <h3>Ca</h3> <label><input type="checkbox" id="ca-all-tab1" checked> Tất cả</label> <div id="ca-options-tab1"></div>
          <h3>Team</h3> <label><input type="checkbox" id="team-all-tab1" checked> Tất cả</label> <div id="team-options-tab1"></div>
          <h3>Thị trường</h3> <label><input type="checkbox" id="market-all-tab1" checked> Tất cả</label> <div id="market-options-tab1"></div>
        </div>
        <div class="main-detailed">
          <div class="header"> <img src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Ff930e667.%E1%BA%A2nh.025539.jpg" alt="Logo"> <h2>DỮ LIỆU CHI PHÍ ADS</h2> </div>
          <div class="table-responsive-container">
            <table id="summary-table-cost">
              <thead>
                <tr>
                  <th class="green-header">STT</th> <th class="green-header">Team</th> <th class="green-header">Marketing</th>
                  <th class="green-header">Số Mess</th> <th class="green-header">CPQC</th> <th class="green-header">Số Đơn</th>
                  <th class="green-header">DS Chốt</th> <th class="yellow-header">Tỉ lệ chốt</th> <th class="yellow-header">Giá Mess</th>
                  <th class="yellow-header">CPS</th> <th class="yellow-header">%CP/DS</th> <th class="yellow-header">Giá TB Đơn</th>
                </tr>
              </thead>
              <tbody id="summary-body-cost"></tbody>
              <tfoot id="summary-foot-cost"></tfoot>
            </table>
          </div>
          <div class="table-responsive-container">
            <table id="kpi-summary-table">
                <thead>
                  <tr>
                    <th class="green-header">STT</th><th class="green-header">Team</th><th class="green-header">Marketing</th>
                    <th class="green-header">CPQC</th><th class="green-header">DS Chốt</th><th class="green-header">DS Đi</th>
                    <th class="green-header">DS Sau Ship</th><th class="green-header">DS Thành Công</th>
                    <th class="yellow-header">%CP/DS</th><th class="yellow-header">% KPI</th>
                  </tr>
                </thead>
                <tbody id="kpi-summary-body"></tbody>
                <tfoot id="kpi-summary-foot"></tfoot>
            </table>
          </div>
          <div id="daily-breakdown-cost"></div>
        </div>
    </div>
  </div>

  <!-- ======================= TAB 2: BÁO CÁO SALE ======================= -->
  <div id="SaleReport" class="tab-content">
      <div class="report-container">
          <div class="sidebar">
            <h3>Bộ lọc</h3>
            <label>Từ ngày:<input type="date" id="start-date-sale"></label> 
            <label>Đến ngày:<input type="date" id="end-date-sale"></label>
            
            <h3>Sản phẩm</h3> 
            <label><input type="checkbox" id="product-all-sale" checked> Tất cả</label> 
            <div id="product-options-sale" class="indent"></div>
            
            <h3>Ca</h3> 
            <label><input type="checkbox" id="ca-all-sale" checked> Tất cả</label> 
            <div id="ca-options-sale" class="indent"></div>
            
            <h3>Team</h3> 
            <label><input type="checkbox" id="team-all-sale" checked> Tất cả</label> 
            <div id="team-options-sale" class="indent"></div>
            
            <h3>Thị trường</h3> 
            <label><input type="checkbox" id="market-all-sale" checked> Tất cả</label> 
            <div id="market-options-sale" class="indent"></div>
          </div>
          
          <div class="main-detailed">
            <div class="header"> 
                <img src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Ff930e667.%E1%BA%A2nh.025539.jpg" alt="Logo"> 
                <h2 id="report-title-sale">DỮ LIỆU TỔNG HỢP SALE</h2> 
            </div>
            
            <div class="table-responsive-container">
              <table id="summary-table-sale">
                <thead>
                  <tr>
                    <th>STT</th> <th>Team</th> <th>Sale</th> <th>Số Mess</th>
                    <th>Số Đơn</th> <th>Phản hồi</th> <th>DS Chốt</th> <th>Tỉ lệ chốt</th>
                  </tr>
                </thead>
                <tbody id="summary-body-sale"></tbody>
                <tfoot id="summary-foot-sale"></tfoot>
              </table>
            </div>
            
            <div id="daily-breakdown-sale"></div>
          </div>
      </div>
  </div>

<script>
    // --- BỘ ĐIỀU KHIỂN CHUNG VÀ TABS ---
    const loader = document.getElementById('loading-overlay');
    const showLoader = () => loader.classList.add('visible');
    const hideLoader = () => loader.classList.remove('visible');

    function openTab(evt, tabName) {
      document.querySelectorAll(".tab-content").forEach(tc => tc.style.display = "none");
      document.querySelectorAll(".tablinks").forEach(tl => tl.classList.remove("active"));
      document.getElementById(tabName).style.display = "block";
      evt.currentTarget.classList.add("active");

      // Tải dữ liệu cho tab khi mở lần đầu
      if (tabName === 'CostReport' && !costReportApp.isInitialized) {
          costReportApp.init();
      } else if (tabName === 'SaleReport' && !saleReportApp.isInitialized) {
          saleReportApp.init();
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById("defaultOpen").click();
    });
    
    // --- CÁC HÀM TIỆN ÍCH CHUNG ---
    const formatUtils = {
        formatDate: function(v) {
            const d = new Date(v);
            if (isNaN(d.getTime())) return v;
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = d.getFullYear();
            return `${day}/${month}/${year}`;
        },
        formatCurrency: function(v) { return Number(v||0).toLocaleString('vi-VN',{style:'currency',currency:'VND'}); },
        formatNumber: function(v) { return Number(v||0).toLocaleString('vi-VN'); },
        formatPercent: function(v) { if (v === null || v === undefined || !isFinite(v)) return '0.00%'; return `${(Number(v||0) * 100).toFixed(2)}%`; },
        formatPriceShort: function(v) { const num = Number(v || 0); if (v === null || v === undefined) return ''; if (num >= 1000000) return (num / 1000000).toFixed(1) + 'tr'; if (num >= 1000) return (num / 1000).toFixed(0) + 'k'; return num.toLocaleString('vi-VN'); }
    };
    
    function handleCheckbox(masterId, childClass, target) {
        if (target.id === masterId) {
            document.querySelectorAll(`.${childClass}`).forEach(cb => cb.checked = target.checked);
        } else if (target.classList.contains(childClass)) {
            document.getElementById(masterId).checked = [...document.querySelectorAll(`.${childClass}`)].every(cb => cb.checked);
        }
    }
    
    // ===================================================================
    // =========== MODULE CHO BÁO CÁO CHI PHÍ (TAB 1) ====================
    // ===================================================================
    const costReportApp = {
        isInitialized: false,
        rawData: [],
        charts: {},
        groupChildren: { 'Châu Á': ['Hàn Quốc','Nhật Bản','VN'], 'Ngoài Châu Á': ['Úc','US', 'Canada'] },
        
        init: function() {
            showLoader();
            this.addEventListeners();
            this.setDefaultDates();
            this.fetchData();
            this.isInitialized = true;
        },
        
        addEventListeners: function() {
            document.getElementById('CostReport').addEventListener('change', (e) => {
                if (e.target.matches('input[type="checkbox"], input[type="date"]')) {
                    this.handleFilters(e.target);
                }
            });
        },

        setDefaultDates: function() {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            const formatDateForInput = (date) => date.toISOString().split('T')[0];
            document.getElementById('start-date-tab1').value = formatDateForInput(firstDay);
            document.getElementById('end-date-tab1').value = formatDateForInput(lastDay);
        },

        fetchData: function() {
            fetch('https://script.google.com/macros/s/AKfycbwGwSBxeXplEzAM-jJDPaXPkiWjNyKmpR70o6nCY5_ynqoF-3WA1gvF91RIQQfDZ9fvAQ/exec')
                .then(res => res.json())
                .then(data => {
                    this.rawData = data.map(r => ({
                        ...r, team: r.team || 'Khác', ten: r.ten || 'N/A', dsChot: +r.dsChot || 0, cpqc: +r.cpqc || 0, soDon: +r.soDon || 0, 
                        soMessCmt: +r.soMessCmt || 0, doanhsoTC: +r.doanhsoTC || 0, tienShip: +r.tienShip || 0,
                        doanhSo: +r.doanhSo || 0, doanhSoSauShip: +r.doanhSoSauShip || 0, kpis: +r.kpis || 0 
                    }));
                    this.populateAllFilters(this.rawData);
                    this.applyFilters();
                }).catch(err => { 
                    console.error("Lỗi tải dữ liệu chi phí:", err); 
                    alert('Không thể tải dữ liệu chi phí.'); 
                }).finally(() => {
                    hideLoader();
                });
        },
        
        populateAllFilters: function(data) {
            const prodSet=new Set(), caSet=new Set(), teamSet=new Set(), mktSet=new Set();
            data.forEach(r=>{ if(r.sanPham) prodSet.add(r.sanPham); if(r.ca) caSet.add(r.ca); if(r.team) teamSet.add(r.team); if(r.thiTruong) mktSet.add(r.thiTruong); });
            document.getElementById('product-options-tab1').innerHTML = Array.from(prodSet).sort().map(p => `<label class='indent'><input type='checkbox' class='filter-product-tab1' value='${p}' checked> ${p}</label>`).join('');
            const marketHtml = Object.keys(this.groupChildren).map(grp => `<label><input type='checkbox' class='filter-market-tab1' value='${grp}' checked> ${grp}</label>` + this.groupChildren[grp].map(ch => `<label class='indent'><input type='checkbox' class='filter-market-tab1' value='${ch}' checked> ${ch}</label>`).join('')).join('');
            const otherMarkets = Array.from(mktSet).filter(m => !Object.values(this.groupChildren).flat().map(c => c.toLowerCase()).includes((m||'').toLowerCase())).sort().map(m => `<label><input type='checkbox' class='filter-market-tab1' value='${m}' checked> ${m}</label>`).join('');
            document.getElementById('market-options-tab1').innerHTML = marketHtml + otherMarkets;
            document.getElementById('ca-options-tab1').innerHTML = Array.from(caSet).sort().map(c => `<label class='indent'><input type='checkbox' class='filter-ca-tab1' value='${c}' checked> ${c}</label>`).join('');
            document.getElementById('team-options-tab1').innerHTML = Array.from(teamSet).sort().map(t => `<label class='indent'><input type='checkbox' class='filter-team-tab1' value='${t}' checked> ${t}</label>`).join('');
        },

        getFilteredData: function() {
            const startDateValue = document.getElementById('start-date-tab1').value;
            const endDateValue = document.getElementById('end-date-tab1').value;
            const pAll = document.getElementById('product-all-tab1').checked, selP = pAll ? null : [...document.querySelectorAll(`.filter-product-tab1:checked`)].map(cb => cb.value);
            const mAll = document.getElementById('market-all-tab1').checked, selM = mAll ? null : [...document.querySelectorAll(`.filter-market-tab1:checked`)].map(cb => cb.value);
            const cAll = document.getElementById('ca-all-tab1').checked, selCa = !cAll ? [...document.querySelectorAll(`.filter-ca-tab1:checked`)].map(cb => cb.value) : null;
            const tAll = document.getElementById('team-all-tab1').checked, selT = !tAll ? [...document.querySelectorAll(`.filter-team-tab1:checked`)].map(cb => cb.value) : null;
            
            return this.rawData.filter(r => {
                if (!r.ngay) return false;
                const d = new Date(r.ngay);
                if (isNaN(d.getTime())) return false;
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                const dataDateStr = `${year}-${month}-${day}`;
                const isDateOk = (!startDateValue || dataDateStr >= startDateValue) && (!endDateValue || dataDateStr <= endDateValue);
                const isProductOk = !selP || selP.includes(r.sanPham);
                const marketGroup = this.getGroup((r.thiTruong||'').trim().toLowerCase());
                const isMarketOk = !selM || selM.includes(marketGroup) || selM.includes(r.thiTruong);
                const isCaOk = !selCa || selCa.includes(r.ca);
                const isTeamOk = !selT || selT.includes(r.team);
                return isDateOk && isProductOk && isMarketOk && isCaOk && isTeamOk;
            });
        },
        
        getGroup: function(norm) { 
            for (let g in this.groupChildren) { if (this.groupChildren[g].map(c=>(c||'').toLowerCase()).includes(norm)) return g; } 
            return norm.charAt(0).toUpperCase()+norm.slice(1); 
        },

        handleFilters: function(target) { 
            showLoader(); 
            setTimeout(() => { 
                handleCheckbox('product-all-tab1', 'filter-product-tab1', target); 
                handleCheckbox('ca-all-tab1', 'filter-ca-tab1', target); 
                handleCheckbox('team-all-tab1', 'filter-team-tab1', target); 
                handleCheckbox('market-all-tab1', 'filter-market-tab1', target); 
                this.applyFilters(); 
                hideLoader(); 
            }, 10); 
        },

        applyFilters: function() {
            const filtered = this.getFilteredData();
            this.renderSummaryCost(filtered); 
            this.renderKpiSummary(filtered); 
            this.renderDailyBreakdownCost(filtered);
        },
        
        renderSummaryCost: function(data) {
            const summaryData = {};
            data.forEach(r => {
                const name = r.ten;
                if (!summaryData[name]) {
                    summaryData[name] = { team: r.team, mess: 0, don: 0, chot: 0, cpqc: 0 };
                }
                summaryData[name].mess += r.soMessCmt;
                summaryData[name].don += r.soDon;
                summaryData[name].chot += r.dsChot;
                summaryData[name].cpqc += r.cpqc;
            });

            const flatList = Object.keys(summaryData).map(name => ({ name, team: summaryData[name].team, data: summaryData[name] }))
                .sort((a, b) => {
                    const teamCompare = (a.team || 'zzz').localeCompare(b.team || 'zzz');
                    if (teamCompare !== 0) return teamCompare;
                    return b.data.chot - a.data.chot;
                });
            
            let total = { mess: 0, don: 0, chot: 0, cpqc: 0 };
            let bodyHtml = flatList.map((item, index) => {
                const s = item.data;
                total.mess += s.mess; total.don += s.don; total.chot += s.chot; total.cpqc += s.cpqc;
                const rate = s.mess ? s.don / s.mess : 0; const pm = s.mess ? s.cpqc / s.mess : 0;
                const pd = s.don ? s.cpqc / s.don : 0; const pc = s.chot ? s.cpqc / s.chot : 0;
                const pdt = s.don ? s.chot / s.don : 0;
                const rateClass = rate > 0.1 ? 'bg-green' : 'bg-yellow';
                let rowClass = index === 0 ? 'top-1' : (index === 1 ? 'top-2' : (index === 2 ? 'top-3' : ''));
                return `<tr class="${rowClass}">
                    <td class="text-center">${index + 1}</td> <td class="text-left">${item.team}</td> <td class="text-left">${item.name}</td>
                    <td>${formatUtils.formatNumber(s.mess)}</td> <td>${formatUtils.formatCurrency(s.cpqc)}</td> <td>${formatUtils.formatNumber(s.don)}</td>
                    <td>${formatUtils.formatCurrency(s.chot)}</td> <td class="${rateClass}">${formatUtils.formatPercent(rate)}</td> <td>${formatUtils.formatCurrency(pm)}</td>
                    <td>${formatUtils.formatCurrency(pd)}</td> <td>${formatUtils.formatPercent(pc)}</td> <td>${formatUtils.formatCurrency(pdt)}</td>
                </tr>`;
            }).join('');
            
            const totalRate = total.mess ? total.don / total.mess : 0; const totalPm = total.mess ? total.cpqc / total.mess : 0;
            const totalPd = total.don ? total.cpqc / total.don : 0; const totalPc = total.chot ? total.cpqc / total.chot : 0;
            const totalPdt = total.don ? total.chot / total.don : 0;
            const footerHtml = `<tr class="total-row"><td class="total-label" colspan="3">TỔNG CỘNG</td>
                    <td>${formatUtils.formatNumber(total.mess)}</td> <td>${formatUtils.formatCurrency(total.cpqc)}</td> <td>${formatUtils.formatNumber(total.don)}</td>
                    <td>${formatUtils.formatCurrency(total.chot)}</td> <td>${formatUtils.formatPercent(totalRate)}</td> <td>${formatUtils.formatCurrency(totalPm)}</td>
                    <td>${formatUtils.formatCurrency(totalPd)}</td> <td>${formatUtils.formatPercent(totalPc)}</td> <td>${formatUtils.formatCurrency(totalPdt)}</td></tr>`;
            
            document.getElementById('summary-body-cost').innerHTML = bodyHtml;
            document.getElementById('summary-foot-cost').innerHTML = footerHtml;
        },

        renderKpiSummary: function(data) { 
            const summaryByMkt = {}; 
            data.forEach(r => { 
                const mktName = r.ten;
                if (!summaryByMkt[mktName]) {
                    summaryByMkt[mktName] = { cpqc: 0, dsChot: 0, dsDi: 0, dsSauShip: 0, dsThanhCong: 0, kpiValue: r.kpis, team: r.team }; 
                }
                summaryByMkt[mktName].cpqc += r.cpqc; summaryByMkt[mktName].dsChot += r.dsChot;
                summaryByMkt[mktName].dsDi += r.doanhSo; summaryByMkt[mktName].dsSauShip += r.doanhSoSauShip;
                summaryByMkt[mktName].dsThanhCong += r.doanhsoTC;
            });
            const sortedMktKeys = Object.keys(summaryByMkt).sort((a, b) => {
                const sA = summaryByMkt[a], sB = summaryByMkt[b];
                const teamCompare = (sA.team || 'zzz').localeCompare(sB.team || 'zzz');
                if (teamCompare !== 0) return teamCompare;
                return sB.dsChot - sA.dsChot;
            });
            let total = { cpqc: 0, dsChot: 0, dsDi: 0, dsSauShip: 0, dsThanhCong: 0, kpis: 0 };
            let bodyHtml = sortedMktKeys.map((mkt, i) => { 
                const s = summaryByMkt[mkt]; 
                total.cpqc += s.cpqc; total.dsChot += s.dsChot; total.dsDi += s.dsDi;
                total.dsSauShip += s.dsSauShip; total.dsThanhCong += s.dsThanhCong; total.kpis += s.kpiValue;
                const cp_ds = s.dsSauShip ? s.cpqc / s.dsSauShip : 0;
                const kpiPercentage = s.kpiValue ? s.dsSauShip / s.kpiValue : 0; 
                let rowClass = i === 0 ? 'top-1' : (i === 1 ? 'top-2' : (i === 2 ? 'top-3' : ''));
                return `<tr class="${rowClass}">
                    <td class="text-center">${i+1}</td> <td class="text-left">${s.team}</td><td class="text-left">${mkt}</td>
                    <td>${formatUtils.formatCurrency(s.cpqc)}</td><td>${formatUtils.formatCurrency(s.dsChot)}</td>
                    <td>${formatUtils.formatCurrency(s.dsDi)}</td><td>${formatUtils.formatCurrency(s.dsSauShip)}</td>
                    <td>${formatUtils.formatCurrency(s.dsThanhCong)}</td><td>${formatUtils.formatPercent(cp_ds)}</td>
                    <td>${formatUtils.formatPercent(kpiPercentage)}</td></tr>`;
            }).join(''); 
            const totalCpds = total.dsSauShip ? total.cpqc / total.dsSauShip : 0;
            const totalKpiPercentage = total.kpis ? total.dsSauShip / total.kpis : 0;
            const footerHtml = `<tr class="total-row"><td class="total-label" colspan="3">TỔNG CỘNG</td>
                    <td>${formatUtils.formatCurrency(total.cpqc)}</td> <td>${formatUtils.formatCurrency(total.dsChot)}</td>
                    <td>${formatUtils.formatCurrency(total.dsDi)}</td> <td>${formatUtils.formatCurrency(total.dsSauShip)}</td>
                    <td>${formatUtils.formatCurrency(total.dsThanhCong)}</td> <td>${formatUtils.formatPercent(totalCpds)}</td>
                    <td>${formatUtils.formatPercent(totalKpiPercentage)}</td></tr>`;
            document.getElementById('kpi-summary-body').innerHTML = bodyHtml;
            document.getElementById('kpi-summary-foot').innerHTML = footerHtml;
        },
        
        renderDailyBreakdownCost: function(data) { 
            const c=document.getElementById('daily-breakdown-cost'); c.innerHTML='';
            const grpObj={};
            data.forEach(r=>{const d=formatUtils.formatDate(r.ngay);(grpObj[d]||(grpObj[d]=[])).push(r);});
            Object.keys(grpObj).sort((a,b)=>new Date(b.split('/').reverse().join('-'))-new Date(a.split('/').reverse().join('-'))).forEach(date=>{
                let m=0,d=0,ch=0,pc=0;
                const sortedDailyData = grpObj[date].sort((a, b) => ((a.ten || '').localeCompare(b.ten || '')) || (b.dsChot - a.dsChot));
                const rowsHtml = sortedDailyData.map(r=>{
                    m+=r.soMessCmt;d+=r.soDon;ch+=r.dsChot;pc+=r.cpqc;
                    return`<tr>
                        <td class="text-center">${r.id}</td><td class="text-left">${r.ten}</td><td class="text-left">${r.ca}</td>
                        <td class="text-left">${r.page}</td><td class="text-left">${r.sanPham}</td><td class="text-left">${r.thiTruong}</td>
                        <td>${formatUtils.formatNumber(r.soMessCmt)}</td><td>${formatUtils.formatNumber(r.soDon)}</td>
                        <td>${formatUtils.formatCurrency(r.dsChot)}</td><td>${formatUtils.formatCurrency(r.cpqc)}</td><td class="text-left">${r.team}</td></tr>`
                }).join('');
                const footHtml=`<tr class='total-row'><td colspan='6' class='total-label'>Tổng</td>
                                <td>${formatUtils.formatNumber(m)}</td><td>${formatUtils.formatNumber(d)}</td>
                                <td>${formatUtils.formatCurrency(ch)}</td><td>${formatUtils.formatCurrency(pc)}</td><td></td></tr>`;
                const tableHtml = `<div class="table-responsive-container"><table><thead><tr><th>ID</th><th>Tên</th><th>Ca</th><th>Page</th><th>Sản phẩm</th><th>Thị trường</th><th>Mess</th><th>Đơn</th><th>DS Chốt</th><th>CPQC</th><th>Team</th></tr></thead><tbody>${rowsHtml}</tbody><tfoot>${footHtml}</tfoot></table></div>`;
                c.innerHTML+=`<h3>Chi tiết ngày: ${date}</h3>${tableHtml}`;
            }); 
        }
    };

    // ===================================================================
    // =========== MODULE CHO BÁO CÁO SALE (TAB 2) =======================
    // ===================================================================
    const saleReportApp = {
        isInitialized: false,
        rawData: [],

        init: function() {
            showLoader();
            this.addEventListeners();
            this.setDefaultDates();
            this.fetchAndProcessData();
            this.isInitialized = true;
        },

        addEventListeners: function() {
          document.getElementById('SaleReport').addEventListener('change', (e) => {
            if (e.target.matches('input[type="checkbox"], input[type="date"]')) {
              this.handleFilters(e.target);
            }
          });
          document.getElementById('SaleReport').addEventListener('click', function(e) {
              const row = e.target.closest('tbody tr');
              if (!row || row.classList.contains('total-row')) return;
              const isAlreadySelected = row.classList.contains('row-selected');
              document.querySelectorAll('#SaleReport tbody tr.row-selected').forEach(selectedRow => {
                  selectedRow.classList.remove('row-selected');
              });
              if (!isAlreadySelected) {
                  row.classList.add('row-selected');
              }
          });
        },

        setDefaultDates: function() {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            const formatDateForInput = (date) => date.toISOString().split('T')[0];
            document.getElementById('start-date-sale').value = formatDateForInput(firstDay);
            document.getElementById('end-date-sale').value = formatDateForInput(lastDay);
        },

        fetchAndProcessData: function() {
            fetch('https://script.google.com/macros/s/AKfycbzd8KdWC7PVuv7ttnQLV7oIxmAgWWdLfs3laMDoL7w5GhvCWd_71_Xc33e-GaUSiG_3/exec')
                .then(res => res.json())
                .then(salesResult => {
                    this.rawData = salesResult
                        .filter(r => r.trangThai && String(r.trangThai).trim() !== '' && r.ten && String(r.ten).trim() !== '' && r.team && String(r.team).trim() !== '')
                        .map(r => ({ ...r, ten: (r.ten || '').trim(), team: (r.team || '').trim(), soMessCmt: +r.soMess || 0, soDon: +r.donMess || 0, dsChot: +r.doanhSoMess || 0, phanHoi: +r.phanHoi || 0 }));
                    this.populateAllFilters(this.rawData); 
                    this.applyFilters();
                }).catch(err => { 
                    console.error("Lỗi khi tải dữ liệu Sale:", err); 
                    alert('Không thể tải dữ liệu Sale.'); 
                }).finally(() => {
                    hideLoader();
                });
        },
        
        populateAllFilters: function(data) {
            const populate = (key, containerId, className) => {
                const container = document.getElementById(containerId);
                const uniqueValues = [...new Set(data.map(r => r[key]).filter(val => val != null && val !== ''))].sort();
                container.innerHTML = uniqueValues.map(val => `<label><input type='checkbox' class='${className}' value='${val}' checked> ${val}</label>`).join('');
            };
            populate('sanPham', 'product-options-sale', 'filter-product-sale');
            populate('thiTruong', 'market-options-sale', 'filter-market-sale');
            populate('ca', 'ca-options-sale', 'filter-ca-sale');
            populate('team', 'team-options-sale', 'filter-team-sale');
        },

        getFilteredData: function() {
            const sdVal = document.getElementById('start-date-sale').value;
            const edVal = document.getElementById('end-date-sale').value;
            const sd = sdVal ? new Date(sdVal + 'T00:00:00') : null; 
            const ed = edVal ? new Date(edVal + 'T23:59:59') : null;
            const getSelected = (masterId, childClass) => document.getElementById(masterId).checked ? null : [...document.querySelectorAll(`.${childClass}:checked`)].map(cb => cb.value);
            const selP = getSelected('product-all-sale', 'filter-product-sale');
            const selM = getSelected('market-all-sale', 'filter-market-sale');
            const selCa = getSelected('ca-all-sale', 'filter-ca-sale');
            const selT = getSelected('team-all-sale', 'filter-team-sale');

            return this.rawData.filter(r => {
                const d = new Date(r.ngay); 
                return ((!sd || d >= sd) && (!ed || d <= ed)) && (!selP || selP.includes(r.sanPham)) && (!selM || selM.includes(r.thiTruong)) &&
                       (!selCa || selCa.includes(String(r.ca))) && (!selT || selT.includes(String(r.team)));
            });
        },

        handleFilters: function(target) { 
            showLoader(); 
            setTimeout(() => { 
                handleCheckbox('product-all-sale', 'filter-product-sale', target); 
                handleCheckbox('ca-all-sale', 'filter-ca-sale', target); 
                handleCheckbox('team-all-sale', 'filter-team-sale', target); 
                handleCheckbox('market-all-sale', 'filter-market-sale', target); 
                this.applyFilters(); 
                hideLoader(); 
            }, 10); 
        },

        applyFilters: function() {
            const filtered = this.getFilteredData();
            this.renderSummarySale(filtered); 
            this.renderDailyBreakdownSale(filtered);
        },
        
        renderSummarySale: function(data) {
            const summaryData = {};
            data.forEach(r => {
                const name = r.ten;
                if (!summaryData[name]) {
                    summaryData[name] = { team: r.team, mess: 0, don: 0, chot: 0, phanHoi: 0 };
                }
                summaryData[name].mess += r.soMessCmt; summaryData[name].don += r.soDon;
                summaryData[name].chot += r.dsChot; summaryData[name].phanHoi += r.phanHoi;
            });
            const flatList = Object.keys(summaryData).map(name => ({ name, team: summaryData[name].team, data: summaryData[name] }))
                .sort((a, b) => b.data.chot - a.data.chot || a.name.localeCompare(b.name));
            
            let bodyHtml = flatList.map((item, index) => {
                const s = item.data;
                const rate = s.mess ? s.don / s.mess : 0;
                let rowClass = index === 0 ? 'top-1' : (index === 1 ? 'top-2' : (index === 2 ? 'top-3' : ''));
                return `<tr class="${rowClass}" style="--row-index: ${index}">
                    <td class="text-center">${index + 1}</td> <td class="text-left">${item.team}</td> <td class="text-left">${item.name}</td>
                    <td>${formatUtils.formatNumber(s.mess)}</td> <td>${formatUtils.formatNumber(s.don)}</td>
                    <td>${formatUtils.formatNumber(s.phanHoi)}</td> <td>${formatUtils.formatCurrency(s.chot)}</td>
                    <td class="${rate >= 0.1 ? 'bg-green' : (rate > 0.05 ? 'bg-yellow' : '')}">${formatUtils.formatPercent(rate)}</td>
                </tr>`;
            }).join('');
            
            const total = flatList.reduce((acc, item) => ({ mess: acc.mess + item.data.mess, don: acc.don + item.data.don, chot: acc.chot + item.data.chot, phanHoi: acc.phanHoi + item.data.phanHoi }), { mess: 0, don: 0, chot: 0, phanHoi: 0 });
            const totalRate = total.mess ? total.don / total.mess : 0;
            const footerHtml = `<tr class="total-row">
                    <td class="total-label" colspan="3">TỔNG CỘNG</td>
                    <td>${formatUtils.formatNumber(total.mess)}</td> <td>${formatUtils.formatNumber(total.don)}</td>
                    <td>${formatUtils.formatNumber(total.phanHoi)}</td> <td>${formatUtils.formatCurrency(total.chot)}</td>
                    <td>${formatUtils.formatPercent(totalRate)}</td></tr>`;
            
            document.getElementById('summary-body-sale').innerHTML = bodyHtml;
            document.getElementById('summary-foot-sale').innerHTML = footerHtml;
        },
        
        renderDailyBreakdownSale: function(data) { 
            const container = document.getElementById('daily-breakdown-sale'); 
            container.innerHTML = '';
            if (data.length === 0) return;
            const groupedByDate = {};
            data.forEach(r => { const dateKey = formatUtils.formatDate(r.ngay); (groupedByDate[dateKey] = groupedByDate[dateKey] || []).push(r); });
            const sortedDates = Object.keys(groupedByDate).sort((a,b)=>new Date(b.split('/').reverse().join('-')) - new Date(a.split('/').reverse().join('-')));
            sortedDates.forEach(date => {
                let total = { mess: 0, don: 0, chot: 0, phanHoi: 0 };
                const sortedDailyData = groupedByDate[date].sort((a, b) => a.ten.localeCompare(b.ten) || (b.dsChot - a.dsChot));
                const rowsHtml = sortedDailyData.map(r=>{
                    total.mess += r.soMessCmt; total.don += r.soDon; total.chot += r.dsChot; total.phanHoi += r.phanHoi;
                    return`<tr>
                        <td class="text-left">${r.ten}</td><td class="text-left">${r.ca}</td><td class="text-left">${r.sanPham}</td>
                        <td class="text-left">${r.thiTruong}</td><td>${formatUtils.formatNumber(r.soMessCmt)}</td>
                        <td>${formatUtils.formatNumber(r.soDon)}</td><td>${formatUtils.formatNumber(r.phanHoi)}</td>
                        <td>${formatUtils.formatCurrency(r.dsChot)}</td><td class="text-left">${r.team}</td></tr>`
                }).join('');
                const footHtml=`<tr class='total-row'> <td colspan='4' class='total-label'>Tổng</td>
                                <td>${formatUtils.formatNumber(total.mess)}</td><td>${formatUtils.formatNumber(total.don)}</td>
                                <td>${formatUtils.formatNumber(total.phanHoi)}</td><td>${formatUtils.formatCurrency(total.chot)}</td>
                                <td></td></tr>`;
                const tableHtml = `<div class="table-responsive-container"><table><thead><tr>
                                   <th>Tên</th><th>Ca</th><th>Sản phẩm</th><th>Thị trường</th>
                                   <th>Mess</th><th>Đơn</th><th>Phản hồi</th><th>DS Chốt</th><th>Team</th>
                                   </tr></thead><tbody>${rowsHtml}</tbody><tfoot>${footHtml}</tfoot></table></div>`;
                container.innerHTML += `<h3>Chi tiết ngày: ${date}</h3>${tableHtml}`;
            }); 
        }
    };
</script>
</body>
</html>

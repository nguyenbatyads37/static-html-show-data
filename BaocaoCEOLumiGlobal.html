<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Báo cáo tổng hợp chi tiết</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    /* --- CÁC STYLE CHUNG --- */
    body { 
      font-family: 'Roboto', Arial, sans-serif; 
      padding: 20px; 
      background-color: #f4f4f4; 
    }
    .table-responsive-container { overflow-x: auto; }
    table { 
      width: 100%; border-collapse: collapse; table-layout: auto; 
      margin-top: 20px; background: #fff; border-radius: 8px; 
      overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
    }
    th, td { 
      border: 1px solid #e0e0e0; padding: 11px 12px; 
      white-space: nowrap; vertical-align: middle; 
      transition: background-color 0.2s; 
    }
    th { 
      text-align: center !important; background: #4CAF50; 
      color: white; font-weight: 500;
    }
    td { text-align: right !important; }
    .text-left { text-align: left !important; }
    .text-center { text-align: center !important; }
    tbody tr:nth-child(even) { background-color: #f9f9f9; }
    tbody tr:hover { background-color: #eff5fb; }
    tr.total-row, tr.total-row:hover { 
      background: #fffde7; font-weight: 700; font-size: 1.05em;
      color: #333; border-top: 2px solid #4CAF50;
    }
    .total-label { text-align: left !important; }
    .total-value { text-align: right !important; }
    .bg-green { background-color: #4CAF50 !important; color: white; }
    .bg-yellow { background-color: #FFEB3B !important; color: #424242; }
    
    /* --- STYLES BỐ CỤC SIDEBAR --- */
    .report-container { 
      display: flex; flex-wrap: nowrap;
      gap: 20px; align-items: flex-start;
    }
    .sidebar { 
      width: 260px; flex-shrink: 0; background: #fff; 
      padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      position: sticky; top: 20px; height: calc(100vh - 110px); overflow-y: auto;
    }
    .main-detailed { 
      flex-grow: 1; min-width: 0; width: calc(100% - 280px);
    }
    .sidebar h3 { 
      background: #2d7c2d; color: #fff; padding: 8px; margin-top: 10px; 
      font-size: 16px; border-radius: 4px; 
    }
    .sidebar label { display: block; margin: 8px 0; font-size: 14px; }
    .sidebar .indent { margin-left: 16px; }
    .sidebar input[type="date"] { 
      width: 100%; box-sizing: border-box; padding: 6px; 
      margin: 4px 0 10px; border: 1px solid #ccc; border-radius: 4px;
    }
    .header { display: flex; align-items: center; margin-bottom: 10px; }
    .header img { height: 60px; margin-right: 15px; border-radius: 50%; }
    .header h2 { margin: 0; color: #2d7c2d; font-weight: 700; }
    .daily-breakdown h3 { 
      margin-top: 30px; background: #f0f0f0; padding: 10px; 
      border: 1px solid #ccc; border-radius: 4px; 
    }
    #loading-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255, 255, 255, 0.7); display: flex; 
      justify-content: center; align-items: center; z-index: 9999;
      font-size: 1.5em; font-weight: bold; color: #2d7c2d;
      transition: opacity 0.3s; visibility: hidden; opacity: 0;
    }
    #loading-overlay.visible { visibility: visible; opacity: 1; }

    /* --- STYLES CHO TAB ĐIỀU HƯỚNG --- */
    .nav-tabs {
      border-bottom: 2px solid #ccc;
      margin-bottom: 20px;
    }
    .nav-button {
      background-color: #f1f1f1;
      border: 1px solid #ccc;
      border-bottom: none;
      padding: 10px 20px;
      cursor: pointer;
      font-size: 16px;
      margin-right: 5px;
      border-radius: 5px 5px 0 0;
      transition: background-color 0.3s;
    }
    .nav-button:hover { background-color: #ddd; }
    .nav-button.active {
      background-color: #4CAF50;
      color: white;
      border-color: #4CAF50;
    }
    .page-content { display: none; }
    .page-content.active { display: block; }
  </style>
</head>
<body>

  <div id="loading-overlay">Đang tải dữ liệu...</div>

  <!-- THANH ĐIỀU HƯỚNG GIỮA CÁC BẢNG -->
  <div class="nav-tabs">
    <button class="nav-button" id="btn-page1">Báo cáo phân quyền</button>
    <button class="nav-button" id="btn-page2">Báo cáo (trống)</button>
    <button class="nav-button" id="btn-page3">Báo cáo tổng hợp</button>
  </div>

  <!-- NỘI DUNG CHO BẢNG 1 (CÓ PHÂN QUYỀN) -->
  <div id="page1-content" class="page-content">
    <div class="report-container">
        <div class="sidebar">
          <h3>Ngày</h3> <label>Từ ngày:<input type="date" id="start-date-1"></label> <label>Đến ngày:<input type="date" id="end-date-1"></label>
          <h3>Sản phẩm</h3> <label><input type="checkbox" id="product-all-1" checked> Tất cả</label> <div id="product-options-1"></div>
          <h3>Ca</h3> <label><input type="checkbox" id="ca-all-1" checked> Tất cả</label> <div id="ca-options-1"></div>
          <h3>Team</h3> <label><input type="checkbox" id="team-all-1" checked> Tất cả</label> <div id="team-options-1"></div>
          <h3>Thị trường</h3> <label><input type="checkbox" id="market-all-1" checked> Tất cả</label> <div id="market-options-1"></div>
        </div>
        <div class="main-detailed">
          <div class="header"> <img src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Ff930e667.%E1%BA%A2nh.025539.jpg" alt="Logo"> <h2 id="report-title-1">DỮ LIỆU TỔNG HỢP</h2> </div>
          <div class="table-responsive-container">
            <table id="summary-table-1">
              <thead><tr><th>STT</th><th>Team</th><th>Sale</th><th>Số Mess</th><th>Số Đơn</th><th>Phản hồi</th><th>DS Chốt</th><th>Tỉ lệ chốt</th></tr></thead>
              <tbody id="summary-body-1"></tbody>
              <tfoot id="summary-foot-1"></tfoot>
            </table>
          </div>
          <div id="daily-breakdown-1"></div>
        </div>
    </div>
  </div>

  <!-- NỘI DUNG CHO BẢNG 2 (TRỐNG, CHỜ THÊM) -->
  <div id="page2-content" class="page-content">
      <h2 style="text-align: center; color: #555;">Nội dung cho báo cáo thứ hai sẽ được thêm ở đây.</h2>
      <p style="text-align: center; color: #777;">Bạn có thể thêm cấu trúc HTML và logic JavaScript tương tự như các báo cáo khác.</p>
  </div>

  <!-- NỘI DUNG CHO BẢNG 3 (KHÔNG PHÂN QUYỀN) -->
  <div id="page3-content" class="page-content">
      <div class="report-container">
        <div class="sidebar">
          <h3>Ngày</h3> <label>Từ ngày:<input type="date" id="start-date-3"></label> <label>Đến ngày:<input type="date" id="end-date-3"></label>
          <h3>Sản phẩm</h3> <label><input type="checkbox" id="product-all-3" checked> Tất cả</label> <div id="product-options-3"></div>
          <h3>Ca</h3> <label><input type="checkbox" id="ca-all-3" checked> Tất cả</label> <div id="ca-options-3"></div>
          <h3>Team</h3> <label><input type="checkbox" id="team-all-3" checked> Tất cả</label> <div id="team-options-3"></div>
          <h3>Thị trường</h3> <label><input type="checkbox" id="market-all-3" checked> Tất cả</label> <div id="market-options-3"></div>
        </div>
        <div class="main-detailed">
          <div class="header"> <img src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Ff930e667.%E1%BA%A2nh.025539.jpg" alt="Logo"> <h2 id="report-title-3">DỮ LIỆU TỔNG HỢP</h2> </div>
          <div class="table-responsive-container">
            <table id="summary-table-3">
              <thead><tr><th>STT</th><th>Team</th><th>Sale</th><th>Số Mess</th><th>Số Đơn</th><th>Phản hồi</th><th>DS Chốt</th><th>Tỉ lệ chốt</th></tr></thead>
              <tbody id="summary-body-3"></tbody>
              <tfoot id="summary-foot-3"></tfoot>
            </table>
          </div>
          <div id="daily-breakdown-3"></div>
        </div>
    </div>
  </div>

<script>
// --- LOGIC CHUNG ---
const loader = document.getElementById('loading-overlay');
const showLoader = () => loader.classList.add('visible');
const hideLoader = () => loader.classList.remove('visible');

// Các hàm định dạng dùng chung
function formatDate(v) {
    const d = new Date(v);
    if (isNaN(d.getTime())) return v;
    const day = String(d.getDate()).padStart(2, '0');
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const year = d.getFullYear();
    return `${day}/${month}/${year}`;
}
function formatCurrency(v) { return Number(v||0).toLocaleString('vi-VN',{style:'currency',currency:'VND'}); }
function formatNumber(v) { return Number(v||0).toLocaleString('vi-VN'); }
function formatPercent(v) { if (v === null || v === undefined || !isFinite(v)) return '0.00%'; return `${(Number(v||0) * 100).toFixed(2)}%`; }

// --- LOGIC ĐIỀU HƯỚNG TAB ---
let page1DataLoaded = false;
let page3DataLoaded = false;

document.addEventListener('DOMContentLoaded', () => {
    const pageButtons = document.querySelectorAll('.nav-button');
    pageButtons.forEach(button => {
        button.addEventListener('click', () => {
            const pageId = button.id.replace('btn-', '');
            showPage(pageId);
        });
    });
    // Hiển thị trang 1 làm mặc định
    showPage('page1');
});

function showPage(pageId) {
    document.querySelectorAll('.page-content').forEach(page => page.classList.remove('active'));
    document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
    
    document.getElementById(pageId + '-content').classList.add('active');
    document.getElementById('btn-' + pageId).classList.add('active');
    
    // Tải dữ liệu cho trang tương ứng nếu chưa tải
    if (pageId === 'page1' && !page1DataLoaded) {
        loadDataForPage1();
    } else if (pageId === 'page3' && !page3DataLoaded) {
        loadDataForPage3();
    }
}

// =========================================================================
// SCRIPT CHO BẢNG 1: BÁO CÁO PHÂN QUYỀN
// =========================================================================
function loadDataForPage1() {
    showLoader();
    let rawData1 = [];
    let employeeData1 = [];

    const salesDataUrl = 'https://script.google.com/macros/s/AKfycbzd8KdWC7PVuv7ttnQLV7oIxmAgWWdLfs3laMDoL7w5GhvCWd_71_Xc33e-GaUSiG_3/exec';
    const employeeDataUrl = 'https://script.google.com/macros/s/AKfycbzwOv7UFwrqzf88QJL1QrxLKcnnnSIQ_PSmF0SO8LboqWI5li3vF3W8_-8s-A8lNGaR/exec';

    function getUrlParameter(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
    }
    
    setDefaultDates1();
    addEventListeners1();

    Promise.all([
        fetch(salesDataUrl).then(res => res.json()),
        fetch(employeeDataUrl).then(res => res.json())
    ])
    .then(([salesResult, employeeResult]) => {
        rawData1 = salesResult.filter(r => r.trangThai && r.ten && r.team)
            .map(r => ({
                ...r,
                ten: (r.ten || '').trim(),
                team: (r.team || '').trim(),
                soMessCmt: +r.soMess || 0,
                soDon: +r.donMess || 0,
                dsChot: +r.doanhSoMess || 0,
                phanHoi: +r.phanHoi || 0,
            }));
        
        employeeData1 = employeeResult;
        let isRestrictedView = false;
        let allowedNames = [];
        const idFromUrl = getUrlParameter('id');
        let restrictedTeamName = null;

        if (idFromUrl) {
            const currentUser = employeeData1.find(emp => emp.idnv === idFromUrl);
            if (currentUser) {
                isRestrictedView = true;
                if (currentUser.vi_tri === "Leader") {
                    restrictedTeamName = currentUser.team;
                    document.getElementById('report-title-1').textContent = `DỮ LIỆU TEAM ${restrictedTeamName}`;
                    allowedNames = employeeData1.filter(emp => emp.team === restrictedTeamName).map(emp => (emp.ho_va_ten || '').trim());
                } else {
                    const cleanName = (currentUser.ho_va_ten || '').trim();
                    document.getElementById('report-title-1').textContent = `DỮ LIỆU CÁ NHÂN - ${cleanName}`;
                    allowedNames = [cleanName];
                }
            } else {
                isRestrictedView = true;
                allowedNames = [];
                alert(`ID "${idFromUrl}" không hợp lệ hoặc không tồn tại.`);
            }
        } else {
            isRestrictedView = false;
            allowedNames = [];
            document.getElementById('report-title-1').textContent = 'DỮ LIỆU TỔNG HỢP';
        }
        
        let dataForFilters = isRestrictedView ? rawData1.filter(r => allowedNames.includes(r.ten)) : rawData1;
        
        populateAllFilters1(dataForFilters, restrictedTeamName);
        applyFilters1();
        page1DataLoaded = true;
    }).catch(err => {
        console.error("Lỗi khi tải dữ liệu Bảng 1:", err);
        alert('Không thể tải dữ liệu Bảng 1.');
    }).finally(() => {
        hideLoader();
    });

    function setDefaultDates1() {
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        const formatDateForInput = (date) => date.toISOString().split('T')[0];
        document.getElementById('start-date-1').value = formatDateForInput(firstDay);
        document.getElementById('end-date-1').value = formatDateForInput(lastDay);
    }
    
    function addEventListeners1() {
        document.getElementById('page1-content').addEventListener('change', (e) => {
            if (e.target.matches('input[type="checkbox"], input[type="date"]')) {
                handleFilters1(e.target);
            }
        });
    }
    
    function handleCheckbox1(masterId, childClass, target) {
        if (target.id === masterId) {
            document.querySelectorAll(`#page1-content .${childClass}`).forEach(cb => cb.checked = target.checked);
        } else if (target.classList.contains(childClass)) {
            const allChecked = [...document.querySelectorAll(`#page1-content .${childClass}`)].every(cb => cb.checked);
            document.getElementById(masterId).checked = allChecked;
        }
    }

    function handleFilters1(target) {
        showLoader();
        setTimeout(() => {
            handleCheckbox1('product-all-1', 'filter-product-1', target);
            handleCheckbox1('ca-all-1', 'filter-ca-1', target);
            handleCheckbox1('team-all-1', 'filter-team-1', target);
            handleCheckbox1('market-all-1', 'filter-market-1', target);
            applyFilters1();
            hideLoader();
        }, 10);
    }

    function applyFilters1() {
        const filtered = getFilteredData1();
        renderSummary1(filtered);
        renderDailyBreakdown1(filtered);
    }
    
    function getFilteredData1() {
        let isRestrictedView = false;
        let allowedNames = [];
        const idFromUrl = getUrlParameter('id');
        if (idFromUrl) {
            const currentUser = employeeData1.find(emp => emp.idnv === idFromUrl);
            if (currentUser) {
                isRestrictedView = true;
                if (currentUser.vi_tri === "Leader") {
                    allowedNames = employeeData1.filter(emp => emp.team === currentUser.team).map(emp => (emp.ho_va_ten || '').trim());
                } else {
                    allowedNames = [(currentUser.ho_va_ten || '').trim()];
                }
            }
        }

        const sdVal = document.getElementById('start-date-1').value;
        const edVal = document.getElementById('end-date-1').value;
        const sd = sdVal ? new Date(sdVal + 'T00:00:00.000Z') : null;
        const ed = edVal ? new Date(edVal + 'T23:59:59.999Z') : null;
        const getSelectedOptions = (masterId, childClass) => {
            if (document.getElementById(masterId).checked) return null;
            return [...document.querySelectorAll(`#page1-content .${childClass}:checked`)].map(cb => cb.value);
        };
        const selP = getSelectedOptions('product-all-1', 'filter-product-1');
        const selM = getSelectedOptions('market-all-1', 'filter-market-1');
        const selCa = getSelectedOptions('ca-all-1', 'filter-ca-1');
        const selT = getSelectedOptions('team-all-1', 'filter-team-1');

        return rawData1.filter(r => {
            const isUserAllowed = !isRestrictedView || allowedNames.includes(r.ten);
            if (!isUserAllowed) return false;
            const d = new Date(r.ngay);
            const isDateOk = (!sd || d >= sd) && (!ed || d <= ed);
            const isProductOk = !selP || selP.includes(r.sanPham);
            const isMarketOk = !selM || selM.includes(r.thiTruong);
            const isCaOk = !selCa || selCa.includes(String(r.ca));
            const isTeamOk = !selT || selT.includes(String(r.team));
            return isDateOk && isProductOk && isMarketOk && isCaOk && isTeamOk;
        });
    }
    
    function populateAllFilters1(data, restrictedTeamName) {
        const populate = (key, containerId, className) => {
            const container = document.getElementById(containerId);
            let uniqueValues = (key === 'team' && restrictedTeamName) ? [restrictedTeamName] : [...new Set(data.map(r => r[key]).filter(Boolean).sort())];
            container.innerHTML = uniqueValues.map(val => `<label class='indent'><input type='checkbox' class='${className}' value='${val}' checked> ${val}</label>`).join('');
        };
        populate('sanPham', 'product-options-1', 'filter-product-1');
        populate('thiTruong', 'market-options-1', 'filter-market-1');
        populate('ca', 'ca-options-1', 'filter-ca-1');
        populate('team', 'team-options-1', 'filter-team-1');
    }

    function renderSummary1(data) {
        const summaryData = {};
        data.forEach(r => {
            if (!summaryData[r.ten]) summaryData[r.ten] = { team: r.team, mess: 0, don: 0, chot: 0, phanHoi: 0 };
            summaryData[r.ten].mess += r.soMessCmt;
            summaryData[r.ten].don += r.soDon;
            summaryData[r.ten].chot += r.dsChot;
            summaryData[r.ten].phanHoi += r.phanHoi;
        });
        const flatList = Object.keys(summaryData).map(name => ({ name, team: summaryData[name].team, data: summaryData[name] })).sort((a,b) => (a.team || '').localeCompare(b.team || '') || a.name.localeCompare(b.name));
        let bodyHtml = flatList.map((item, index) => {
            const s = item.data;
            const rate = s.mess ? s.don / s.mess : 0;
            const rateClass = rate >= 0.1 ? 'bg-green' : (rate > 0 ? 'bg-yellow' : '');
            return `<tr><td class="text-center">${index + 1}</td><td class="text-left">${item.team}</td><td class="text-left">${item.name}</td><td>${formatNumber(s.mess)}</td><td>${formatNumber(s.don)}</td><td>${formatNumber(s.phanHoi)}</td><td>${formatCurrency(s.chot)}</td><td class="${rateClass}">${formatPercent(rate)}</td></tr>`;
        }).join('');
        const total = flatList.reduce((acc, item) => ({ mess: acc.mess + item.data.mess, don: acc.don + item.data.don, chot: acc.chot + item.data.chot, phanHoi: acc.phanHoi + item.data.phanHoi }), { mess: 0, don: 0, chot: 0, phanHoi: 0 });
        const totalRate = total.mess ? total.don / total.mess : 0;
        const footerHtml = `<tr class="total-row"><td class="total-label" colspan="3">TỔNG CỘNG</td><td class="total-value">${formatNumber(total.mess)}</td><td class="total-value">${formatNumber(total.don)}</td><td class="total-value">${formatNumber(total.phanHoi)}</td><td class="total-value">${formatCurrency(total.chot)}</td><td class="total-value">${formatPercent(totalRate)}</td></tr>`;
        document.getElementById('summary-body-1').innerHTML = bodyHtml;
        document.getElementById('summary-foot-1').innerHTML = footerHtml;
    }

    function renderDailyBreakdown1(data) {
        const container = document.getElementById('daily-breakdown-1');
        container.innerHTML = '';
        if (data.length === 0) { container.innerHTML = '<h3>Không có dữ liệu chi tiết.</h3>'; return; }
        const grouped = {};
        data.forEach(r => {
            const dateKey = formatDate(r.ngay);
            if (!grouped[dateKey]) grouped[dateKey] = [];
            grouped[dateKey].push(r);
        });
        const sortedDates = Object.keys(grouped).sort((a,b) => new Date(b.split('/').reverse().join('-')) - new Date(a.split('/').reverse().join('-')));
        sortedDates.forEach(date => {
            let total = { mess: 0, don: 0, chot: 0, phanHoi: 0 };
            const rowsHtml = grouped[date].sort((a, b) => (a.team || '').localeCompare(b.team || '') || a.ten.localeCompare(b.ten)).map(r => {
                total.mess += r.soMessCmt; total.don += r.soDon; total.chot += r.dsChot; total.phanHoi += r.phanHoi;
                return `<tr><td class="text-left">${r.ten}</td><td class="text-left">${r.ca}</td><td class="text-left">${r.sanPham}</td><td class="text-left">${r.thiTruong}</td><td>${formatNumber(r.soMessCmt)}</td><td>${formatNumber(r.soDon)}</td><td>${formatNumber(r.phanHoi)}</td><td>${formatCurrency(r.dsChot)}</td><td class="text-left">${r.team}</td></tr>`;
            }).join('');
            const footHtml = `<tr class='total-row'><td colspan='4' class='total-label'>Tổng</td><td class='total-value'>${formatNumber(total.mess)}</td><td class='total-value'>${formatNumber(total.don)}</td><td class='total-value'>${formatNumber(total.phanHoi)}</td><td class='total-value'>${formatCurrency(total.chot)}</td><td></td></tr>`;
            container.innerHTML += `<h3>${date}</h3><div class="table-responsive-container"><table><thead><tr><th>Tên</th><th>Ca</th><th>Sản phẩm</th><th>Thị trường</th><th>Mess</th><th>Đơn</th><th>Phản hồi</th><th>DS Chốt</th><th>Team</th></tr></thead><tbody>${rowsHtml}</tbody><tfoot>${footHtml}</tfoot></table></div>`;
        });
    }
}

// =========================================================================
// SCRIPT CHO BẢNG 3: BÁO CÁO TỔNG HỢP (KHÔNG PHÂN QUYỀN)
// =========================================================================
function loadDataForPage3() {
    showLoader();
    let rawData3 = [];

    const salesDataUrl = 'https://script.google.com/macros/s/AKfycbzd8KdWC7PVuv7ttnQLV7oIxmAgWWdLfs3laMDoL7w5GhvCWd_71_Xc33e-GaUSiG_3/exec';
    
    setDefaultDates3();
    addEventListeners3();
    
    fetch(salesDataUrl).then(res => res.json())
    .then(salesResult => {
        rawData3 = salesResult.filter(r => r.trangThai && r.ten && r.team)
            .map(r => ({
                ...r,
                ten: (r.ten || '').trim(),
                team: (r.team || '').trim(),
                soMessCmt: +r.soMess || 0,
                soDon: +r.donMess || 0,
                dsChot: +r.doanhSoMess || 0,
                phanHoi: +r.phanHoi || 0,
            }));

        document.getElementById('report-title-3').textContent = 'DỮ LIỆU TỔNG HỢP';
        populateAllFilters3(rawData3); 
        applyFilters3();
        page3DataLoaded = true;
    }).catch(err => { 
        console.error("Lỗi khi tải dữ liệu Bảng 3:", err); 
        alert('Không thể tải dữ liệu Bảng 3.'); 
    }).finally(() => {
        hideLoader();
    });

    function setDefaultDates3() {
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        const formatDateForInput = (date) => date.toISOString().split('T')[0];
        document.getElementById('start-date-3').value = formatDateForInput(firstDay);
        document.getElementById('end-date-3').value = formatDateForInput(lastDay);
    }
    
    function addEventListeners3() {
        document.getElementById('page3-content').addEventListener('change', (e) => {
            if (e.target.matches('input[type="checkbox"], input[type="date"]')) {
                handleFilters3(e.target);
            }
        });
    }

    function handleCheckbox3(masterId, childClass, target) {
        if (target.id === masterId) {
            document.querySelectorAll(`#page3-content .${childClass}`).forEach(cb => cb.checked = target.checked);
        } else if (target.classList.contains(childClass)) {
            const allChecked = [...document.querySelectorAll(`#page3-content .${childClass}`)].every(cb => cb.checked);
            document.getElementById(masterId).checked = allChecked;
        }
    }
    
    function handleFilters3(target) { 
        showLoader(); 
        setTimeout(() => { 
            handleCheckbox3('product-all-3', 'filter-product-3', target); 
            handleCheckbox3('ca-all-3', 'filter-ca-3', target); 
            handleCheckbox3('team-all-3', 'filter-team-3', target); 
            handleCheckbox3('market-all-3', 'filter-market-3', target); 
            applyFilters3(); 
            hideLoader(); 
        }, 10); 
    }
    
    function applyFilters3() {
        const filtered = getFilteredData3();
        renderSummary3(filtered); 
        renderDailyBreakdown3(filtered);
    }
    
    function getFilteredData3() {
        const sdVal = document.getElementById('start-date-3').value;
        const edVal = document.getElementById('end-date-3').value;
        const sd = sdVal ? new Date(sdVal + 'T00:00:00.000Z') : null;
        const ed = edVal ? new Date(edVal + 'T23:59:59.999Z') : null;
        const getSelectedOptions = (masterId, childClass) => {
          if (document.getElementById(masterId).checked) return null;
          return [...document.querySelectorAll(`#page3-content .${childClass}:checked`)].map(cb => cb.value);
        };
        const selP = getSelectedOptions('product-all-3', 'filter-product-3');
        const selM = getSelectedOptions('market-all-3', 'filter-market-3');
        const selCa = getSelectedOptions('ca-all-3', 'filter-ca-3');
        const selT = getSelectedOptions('team-all-3', 'filter-team-3');
        return rawData3.filter(r => {
            const d = new Date(r.ngay);
            const isDateOk = (!sd || d >= sd) && (!ed || d <= ed);
            const isProductOk = !selP || selP.includes(r.sanPham);
            const isMarketOk = !selM || selM.includes(r.thiTruong);
            const isCaOk = !selCa || selCa.includes(String(r.ca));
            const isTeamOk = !selT || selT.includes(String(r.team));
            return isDateOk && isProductOk && isMarketOk && isCaOk && isTeamOk;
        });
    }

    function populateAllFilters3(data) {
        const populate = (key, containerId, className) => {
            const container = document.getElementById(containerId);
            const uniqueValues = [...new Set(data.map(r => r[key]).filter(Boolean).sort())];
            container.innerHTML = uniqueValues.map(val => `<label class='indent'><input type='checkbox' class='${className}' value='${val}' checked> ${val}</label>`).join('');
        };
        populate('sanPham', 'product-options-3', 'filter-product-3');
        populate('thiTruong', 'market-options-3', 'filter-market-3');
        populate('ca', 'ca-options-3', 'filter-ca-3');
        populate('team', 'team-options-3', 'filter-team-3');
    }

    function renderSummary3(data) {
        const summaryData = {};
        data.forEach(r => {
            if (!summaryData[r.ten]) summaryData[r.ten] = { team: r.team, mess: 0, don: 0, chot: 0, phanHoi: 0 };
            summaryData[r.ten].mess += r.soMessCmt;
            summaryData[r.ten].don += r.soDon;
            summaryData[r.ten].chot += r.dsChot;
            summaryData[r.ten].phanHoi += r.phanHoi;
        });
        const flatList = Object.keys(summaryData).map(name => ({ name, team: summaryData[name].team, data: summaryData[name] })).sort((a,b) => (a.team || '').localeCompare(b.team || '') || a.name.localeCompare(b.name));
        let bodyHtml = flatList.map((item, index) => {
            const s = item.data;
            const rate = s.mess ? s.don / s.mess : 0;
            const rateClass = rate >= 0.1 ? 'bg-green' : (rate > 0 ? 'bg-yellow' : '');
            return `<tr><td class="text-center">${index + 1}</td><td class="text-left">${item.team}</td><td class="text-left">${item.name}</td><td>${formatNumber(s.mess)}</td><td>${formatNumber(s.don)}</td><td>${formatNumber(s.phanHoi)}</td><td>${formatCurrency(s.chot)}</td><td class="${rateClass}">${formatPercent(rate)}</td></tr>`;
        }).join('');
        const total = flatList.reduce((acc, item) => ({ mess: acc.mess + item.data.mess, don: acc.don + item.data.don, chot: acc.chot + item.data.chot, phanHoi: acc.phanHoi + item.data.phanHoi }), { mess: 0, don: 0, chot: 0, phanHoi: 0 });
        const totalRate = total.mess ? total.don / total.mess : 0;
        const footerHtml = `<tr class="total-row"><td class="total-label" colspan="3">TỔNG CỘNG</td><td class="total-value">${formatNumber(total.mess)}</td><td class="total-value">${formatNumber(total.don)}</td><td class="total-value">${formatNumber(total.phanHoi)}</td><td class="total-value">${formatCurrency(total.chot)}</td><td class="total-value">${formatPercent(totalRate)}</td></tr>`;
        document.getElementById('summary-body-3').innerHTML = bodyHtml;
        document.getElementById('summary-foot-3').innerHTML = footerHtml;
    }
    
    function renderDailyBreakdown3(data) {
        const container = document.getElementById('daily-breakdown-3');
        container.innerHTML = '';
        if (data.length === 0) { container.innerHTML = '<h3>Không có dữ liệu chi tiết.</h3>'; return; }
        const grouped = {};
        data.forEach(r => {
            const dateKey = formatDate(r.ngay);
            if (!grouped[dateKey]) grouped[dateKey] = [];
            grouped[dateKey].push(r);
        });
        const sortedDates = Object.keys(grouped).sort((a,b) => new Date(b.split('/').reverse().join('-')) - new Date(a.split('/').reverse().join('-')));
        sortedDates.forEach(date => {
            let total = { mess: 0, don: 0, chot: 0, phanHoi: 0 };
            const rowsHtml = grouped[date].sort((a, b) => (a.team || '').localeCompare(b.team || '') || a.ten.localeCompare(b.ten)).map(r => {
                total.mess += r.soMessCmt; total.don += r.soDon; total.chot += r.dsChot; total.phanHoi += r.phanHoi;
                return `<tr><td class="text-left">${r.ten}</td><td class="text-left">${r.ca}</td><td class="text-left">${r.sanPham}</td><td class="text-left">${r.thiTruong}</td><td>${formatNumber(r.soMessCmt)}</td><td>${formatNumber(r.soDon)}</td><td>${formatNumber(r.phanHoi)}</td><td>${formatCurrency(r.dsChot)}</td><td class="text-left">${r.team}</td></tr>`;
            }).join('');
            const footHtml = `<tr class='total-row'><td colspan='4' class='total-label'>Tổng</td><td class='total-value'>${formatNumber(total.mess)}</td><td class='total-value'>${formatNumber(total.don)}</td><td class='total-value'>${formatNumber(total.phanHoi)}</td><td class='total-value'>${formatCurrency(total.chot)}</td><td></td></tr>`;
            container.innerHTML += `<h3>${date}</h3><div class="table-responsive-container"><table><thead><tr><th>Tên</th><th>Ca</th><th>Sản phẩm</th><th>Thị trường</th><th>Mess</th><th>Đơn</th><th>Phản hồi</th><th>DS Chốt</th><th>Team</th></tr></thead><tbody>${rowsHtml}</tbody><tfoot>${footHtml}</tfoot></table></div>`;
        });
    }
}
</script>
</body>
</html>

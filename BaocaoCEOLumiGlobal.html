<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>T·ªïng h·ª£p B√°o C√°o LumiGlobal</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  
  <style>
    /* --- CSS CHUNG CHO C·∫¢ TRANG & H·ªÜ TH·ªêNG TABS --- */
    body {
      font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f4f4f4;
    }
    .tab-container {
      overflow: hidden;
      border-bottom: 2px solid #0056b3;
      margin-bottom: 20px;
      background-color: #fff;
      padding: 5px 10px 0 10px;
      border-radius: 8px 8px 0 0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .tab-container button {
      background-color: #f1f1f1;
      float: left;
      border: none;
      outline: none;
      cursor: pointer;
      padding: 14px 20px;
      transition: background-color 0.3s, color 0.3s;
      font-size: 17px;
      font-weight: 500;
      border-radius: 8px 8px 0 0;
      margin-right: 5px;
    }
    .tab-container button:hover { background-color: #e2e6ea; }
    .tab-container button.active { background-color: #0056b3; color: white; }
    .tab-content { display: none; padding: 6px 12px; border-top: none; animation: fadeIn 0.5s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    #loading-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255, 255, 255, 0.8);
      display: flex; justify-content: center; align-items: center;
      z-index: 9999;
      font-size: 1.5em; font-weight: bold; color: #0056b3;
      transition: opacity 0.3s;
      visibility: hidden; opacity: 0;
    }
    #loading-overlay.visible { visibility: visible; opacity: 1; }
    
    /* --- ============================================ --- */
    /* --- CSS D√ÄNH RI√äNG CHO TAB 1 (B√ÅO C√ÅO SALE) --- */
    /* --- ============================================ --- */
    #SaleReportContainer {
        line-height: 1.6;
    }
    #SaleReportContainer .container {
      max-width: 95vw;
      margin: 1rem auto;
      background-color: white;
      border-radius: 6px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      padding: 2rem;
    }
    #SaleReportContainer .header {
      display: flex;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1.5rem;
      border-bottom: 2px solid #0056b3;
    }
    #SaleReportContainer .logo {
      height: 60px;
      margin-right: 1.5rem;
    }
    #SaleReportContainer h1 {
      color: #0056b3;
      margin: 0;
      font-weight: 600;
      font-size: 2rem;
    }
    #SaleReportContainer .table-wrapper {
      overflow-x: auto;
      border: 1px solid #ddd;
      border-radius: 6px;
    }
    #SaleReportContainer table {
      width: 100%;
      border-collapse: collapse;
      background-color: white;
      table-layout: fixed;
    }
    #SaleReportContainer th, #SaleReportContainer td {
      border: 1px solid #ddd;
      padding: 0.8rem 1rem;
      text-align: left;
      vertical-align: middle;
      white-space: nowrap;
      word-wrap: break-word;
    }
    #SaleReportContainer th {
      background-color: #0056b3;
      color: white;
      font-weight: 500;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    #SaleReportContainer tr:nth-child(even) { background-color: #f8f9fa; }
    #SaleReportContainer tr:hover { background-color: #e9ecef; }
    #SaleReportContainer input, #SaleReportContainer textarea, #SaleReportContainer button, #SaleReportContainer select {
      box-sizing: border-box;
      padding: 0.5rem 0.75rem;
      border: 1px solid #ddd;
      border-radius: 6px;
      width: 100%;
      font-family: inherit;
      font-size: 0.95rem;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    #SaleReportContainer td input, #SaleReportContainer td select {
        white-space: normal;
        height: auto;
        min-height: 38px;
    }
    #SaleReportContainer input:focus, #SaleReportContainer select:focus {
        border-color: #0056b3;
        box-shadow: 0 0 0 3px rgba(0, 86, 179, 0.2);
        outline: none;
    }
    #SaleReportContainer button {
      background-color: #0056b3;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 500;
    }
    #SaleReportContainer button:hover { background-color: #003d82; }
    #SaleReportContainer .action-buttons { display: flex; gap: 0.5rem; justify-content: center; }
    #SaleReportContainer .action-buttons button { padding: 0.4rem 0.6rem; }
    #SaleReportContainer .add-row-btn {
      background-color: #28a745; margin-bottom: 1.5rem; padding: 0.75rem 1.5rem; font-size: 1.1rem;
    }
    #SaleReportContainer .add-row-btn:hover { background-color: #218838; }
    #SaleReportContainer .submit-btn {
      background-color: #dc3545; margin-top: 1.5rem; padding: 0.75rem 1.5rem; font-size: 1.1rem;
    }
    #SaleReportContainer .submit-btn:hover { background-color: #c82333; }
    #SaleReportContainer #responseMessage {
      margin-top: 1.5rem; padding: 1rem; border-radius: 6px; text-align: center; font-weight: bold;
    }
    #SaleReportContainer .success { background-color: #d4edda; color: #155724; }
    #SaleReportContainer .error { background-color: #f8d7da; color: #721c24; }
    #SaleReportContainer .error-cell { background-color: #f8d7da !important; border: 1px solid #dc3545 !important; }
    #SaleReportContainer .hidden { display: none; }
    #SaleReportContainer .addSimilar { background-color: #17a2b8; }
    #SaleReportContainer .addSimilar:hover { background-color: #138496; }
    #SaleReportContainer .removeRow { background-color: #6c757d; }
    #SaleReportContainer .removeRow:hover { background-color: #5a6268; }
    #SaleReportContainer .input-container { display: flex; align-items: center; gap: 0.5rem; }
    #SaleReportContainer .input-container input, #SaleReportContainer .input-container select { flex-grow: 1; }
    #SaleReportContainer .input-container .addSimilar { flex-shrink: 0; width: 38px; height: 38px; padding: 0; font-size: 1.2rem; }
    #SaleReportContainer .status {
      background: #e9ecef; padding: 10px; margin: 10px 0; border-radius: 4px; font-size: 14px; color: #495057;
    }
    #SaleReportContainer #dataTable th:nth-child(1) { width: 80px; }
    #SaleReportContainer #dataTable th:nth-child(2), #SaleReportContainer #dataTable th:nth-child(5) { width: 250px; }
    #SaleReportContainer #dataTable th:nth-child(3), #SaleReportContainer #dataTable th:child(4), #SaleReportContainer #dataTable th:nth-child(6), #SaleReportContainer #dataTable th:nth-child(7), #SaleReportContainer #dataTable th:nth-child(8) { width: 150px; }

    /* --- =================================================== --- */
    /* --- CSS D√ÄNH RI√äNG CHO TAB 2 & 3 (B√ÅO C√ÅO CHI PH√ç) --- */
    /* --- =================================================== --- */
    #CostReportsContainer .table-responsive-container { overflow-x: auto; }
    #CostReportsContainer table { width: 100%; border-collapse: collapse; table-layout: auto; margin-top: 20px; background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    #CostReportsContainer th, #CostReportsContainer td { border: 1px solid #e0e0e0; padding: 11px 12px; white-space: nowrap; vertical-align: middle; transition: background-color 0.2s; }
    #CostReportsContainer th { text-align: center !important; }
    #CostReportsContainer td { text-align: right !important; }
    #CostReportsContainer .text-left { text-align: left !important; }
    #CostReportsContainer .text-center { text-align: center !important; }
    #CostReportsContainer tbody tr:nth-child(even) { background-color: #f9f9f9; }
    #CostReportsContainer tbody tr:not(.team-header-row):hover { background-color: #eff5fb; }
    #CostReportsContainer th.green-header { background: #4CAF50; color: white; font-weight: 500; }
    #CostReportsContainer th.yellow-header { background: #FFC107; color: #424242; font-weight: 500; }
    #CostReportsContainer tr.total-row, #CostReportsContainer tr.total-row:hover { background: #fffde7; font-weight: 700; font-size: 1.05em; color: #333; border-top: 2px solid #4CAF50; }
    #CostReportsContainer .total-label { text-align: left !important; }
    #CostReportsContainer .total-value { text-align: right !important; }
    #CostReportsContainer .bg-green { background-color: #4CAF50 !important; color: white; }
    #CostReportsContainer .bg-yellow { background-color: #FFEB3B !important; color: #424242; }
    #CostReportsContainer .bg-lightred { background-color: #F44336 !important; color: white; }
    #CostReportsContainer .bg-lightblue { background-color: #2196F3 !important; color: white; }
    #CostReportsContainer .report-container { display: flex; gap: 20px; }
    #CostReportsContainer .sidebar { width: 260px; flex-shrink: 0; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    #CostReportsContainer .sidebar h3 { background: #2d7c2d; color: #fff; padding: 8px; margin-top: 10px; font-size: 16px; border-radius: 4px; }
    #CostReportsContainer .sidebar label { display: block; margin: 8px 0; font-size: 14px; }
    #CostReportsContainer .sidebar .indent { margin-left: 16px; }
    #CostReportsContainer .sidebar input[type="date"] { width: 100%; box-sizing: border-box; padding: 6px; margin: 4px 0 10px; border: 1px solid #ccc; border-radius: 4px;}
    #CostReportsContainer .main-detailed { flex-grow: 1; }
    #CostReportsContainer .header { display: flex; align-items: center; margin-bottom: 10px; }
    #CostReportsContainer .header img { height: 60px; margin-right: 15px; border-radius: 50%; }
    #CostReportsContainer .header h2 { margin: 0; color: #2d7c2d; font-weight: 700; }
    #CostReportsContainer #kpi-summary-table { margin-top: 30px; }
    #CostReportsContainer .daily-breakdown h3 { margin-top: 30px; background: #f0f0f0; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
    #CostReportsContainer .daily-report-layout { display: flex; gap: 20px; }
    #CostReportsContainer .daily-report-layout .sidebar { width: 260px; }
    #CostReportsContainer .daily-report-layout .main-content { flex-grow: 1; }
    #CostReportsContainer .main-daily h2 { color: #2d7c2d; text-align: center; margin-bottom: 20px; font-weight: 700; }
    #CostReportsContainer .chart-toggle-controls { margin: 20px 0; padding: 10px; background: #eee; border-radius: 8px; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }
    #CostReportsContainer .chart-toggle-controls label { font-size: 14px; cursor: pointer;}
    #CostReportsContainer .chart-toggle-controls .toggle-all { font-weight: bold; }
    #CostReportsContainer .charts-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    #CostReportsContainer .chart-wrapper { background: #fff; padding: 15px; border-radius: 12px; box-shadow: 0 6px 12px rgba(0,0,0,0.1); transition: opacity 0.4s ease-in-out; }
    #CostReportsContainer .chart-wrapper canvas { width: 100% !important; height: 400px !important; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
</head>
<body>
  
  <div id="loading-overlay">ƒêang t·∫£i d·ªØ li·ªáu...</div>

  <!-- THANH ƒêI·ªÄU H∆Ø·ªöNG CHUNG CHO 3 TAB -->
  <div class="tab-container">
    <button class="tablinks" onclick="openTab(event, 'SaleReport')" id="defaultOpen">B√°o C√°o Sale</button>
    <button class="tablinks" onclick="openTab(event, 'DetailedReport')">B√°o c√°o chi ti·∫øt</button>
    <button class="tablinks" onclick="openTab(event, 'DailyReport')">B√°o c√°o theo ng√†y</button>
  </div>

  <!-- N·ªòI DUNG TAB 1: B√ÅO C√ÅO SALE -->
  <div id="SaleReport" class="tab-content">
    <div id="SaleReportContainer">
      <div class="container">
        <div class="header">
          <img src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Ff930e667.%E1%BA%A2nh.025539.jpg" alt="LumiGlobal Logo" class="logo">
          <h1>B√°o C√°o Sale LumiGlobal</h1>
        </div>
        <div class="status" id="status">ƒêang t·∫£i d·ªØ li·ªáu, vui l√≤ng ch·ªù...</div>
        <button id="addRowBtn" type="button" class="add-row-btn" disabled>‚ûï Th√™m d√≤ng tr·ªëng</button>
        <form id="dataForm" novalidate>
          <div class="table-wrapper">
            <table id="dataTable">
              <thead>
                <tr>
                  <th>H√†nh ƒë·ªông</th>
                  <th>T√™n</th>
                  <th>Ng√†y</th>
                  <th>Ca</th>
                  <th>S·∫£n ph·∫©m</th>
                  <th>Th·ªã tr∆∞·ªùng</th>
                  <th>S·ªë Mess</th>
                  <th>Ph·∫£n h·ªìi</th>
                </tr>
              </thead>
              <tbody id="tableBody"></tbody>
            </table>
          </div>
          <button type="submit" id="submitBtn" class="submit-btn" disabled>üöÄ G·ª≠i b√°o c√°o</button>
        </form>
        <div id="responseMessage"></div>
        <datalist id="employee-datalist"></datalist>
      </div>
    </div>
  </div>

  <!-- N·ªòI DUNG TAB 2: B√ÅO C√ÅO CHI TI·∫æT -->
  <div id="DetailedReport" class="tab-content">
    <div id="CostReportsContainer">
      <div class="report-container">
          <div class="sidebar">
            <h3>Ng√†y</h3> <label>T·ª´ ng√†y:<input type="date" id="start-date-tab1"></label> <label>ƒê·∫øn ng√†y:<input type="date" id="end-date-tab1"></label>
            <h3>S·∫£n ph·∫©m</h3> <label><input type="checkbox" id="product-all-tab1" checked> T·∫•t c·∫£</label> <div id="product-options-tab1"></div>
            <h3>Ca</h3> <label><input type="checkbox" id="ca-all-tab1" checked> T·∫•t c·∫£</label> <div id="ca-options-tab1"></div>
            <h3>Team</h3> <label><input type="checkbox" id="team-all-tab1" checked> T·∫•t c·∫£</label> <div id="team-options-tab1"></div>
            <h3>Th·ªã tr∆∞·ªùng</h3> <label><input type="checkbox" id="market-all-tab1" checked> T·∫•t c·∫£</label> <div id="market-options-tab1"></div>
          </div>
          <div class="main-detailed">
            <div class="header"> <img src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Ff930e667.%E1%BA%A2nh.025539.jpg" alt="Logo"> <h2>D·ªÆ LI·ªÜU CHI PH√ç ADS</h2> </div>
            <div class="table-responsive-container">
              <table id="summary-table">
                <thead>
                  <tr>
                    <th class="green-header">STT</th>
                    <th class="green-header">Team</th>
                    <th class="green-header">Marketing</th>
                    <th class="green-header">S·ªë Mess</th>
                    <th class="green-header">CPQC</th>
                    <th class="green-header">S·ªë ƒê∆°n</th>
                    <th class="green-header">DS Ch·ªët</th>
                    <th class="yellow-header">T·ªâ l·ªá ch·ªët</th>
                    <th class="yellow-header">Gi√° Mess</th>
                    <th class="yellow-header">CPS</th>
                    <th class="yellow-header">%CP/DS</th>
                    <th class="yellow-header">Gi√° TB ƒê∆°n</th>
                  </tr>
                </thead>
                <tbody id="summary-body"></tbody>
                <tfoot id="summary-foot"></tfoot>
              </table>
            </div>
            <div class="table-responsive-container">
              <table id="kpi-summary-table">
                  <thead>
                    <tr>
                      <th class="green-header">STT</th>
                      <th class="green-header">Team</th>
                      <th class="green-header">Marketing</th>
                      <th class="green-header">CPQC</th>
                      <th class="green-header">DS Ch·ªët</th>
                      <th class="green-header">DS ƒêi</th>
                      <th class="green-header">DS Sau Ship</th>
                      <th class="green-header">DS Th√†nh C√¥ng</th>
                      <th class="yellow-header">%CP/DS</th>
                      <th class="yellow-header">% KPI</th>
                    </tr>
                  </thead>
                  <tbody id="kpi-summary-body"></tbody>
                  <tfoot id="kpi-summary-foot"></tfoot>
              </table>
            </div>
            <div id="daily-breakdown"></div>
          </div>
      </div>
    </div>
  </div>

  <!-- N·ªòI DUNG TAB 3: B√ÅO C√ÅO THEO NG√ÄY -->
  <div id="DailyReport" class="tab-content">
    <div id="CostReportsContainer">
        <div class="main-daily">
        <h2>B√°o c√°o hi·ªáu su·∫•t theo ng√†y</h2>
        <div class="daily-report-layout">
            <div class="sidebar">
            <h3>Ng√†y</h3> <label>T·ª´ ng√†y:<input type="date" id="start-date-tab2"></label> <label>ƒê·∫øn ng√†y:<input type="date" id="end-date-tab2"></label>
            <h3>S·∫£n ph·∫©m</h3> <label><input type="checkbox" id="product-all-tab2" checked> T·∫•t c·∫£</label> <div id="product-options-tab2"></div>
            <h3>Th·ªã tr∆∞·ªùng</h3> <label><input type="checkbox" id="market-all-tab2" checked> T·∫•t c·∫£</label> <div id="market-options-tab2"></div>
            </div>
            <div class="main-content">
            <div class="table-responsive-container">
                <table id="date-summary-table">
                <thead> <tr> <th>Ng√†y</th><th>T·ªïng CPQC</th><th>DS Ch·ªët</th><th>T·ªâ l·ªá ch·ªët TB</th> <th>Gi√° Mess</th><th>CPS</th><th>%CP/DS</th> </tr> </thead>
                <tbody id="date-summary-body"></tbody>
                </table>
            </div>
            <div class="chart-toggle-controls">
                <label class="toggle-all"><input type="checkbox" id="toggle-all-charts" checked> Ch·ªçn/B·ªè ch·ªçn t·∫•t c·∫£</label>
                <label><input type="checkbox" class="chart-toggle" data-chart="cpqcChart" checked> CPQC</label>
                <label><input type="checkbox" class="chart-toggle" data-chart="dsChotChart" checked> DS Ch·ªët</label>
                <label><input type="checkbox" class="chart-toggle" data-chart="rateChart" checked> T·ªâ l·ªá ch·ªët</label>
                <label><input type="checkbox" class="chart-toggle" data-chart="messChart" checked> Gi√° Mess</label>
                <label><input type="checkbox" class="chart-toggle" data-chart="cpsChart" checked> CPS</label>
                <label><input type="checkbox" class="chart-toggle" data-chart="cpDsRatioChart" checked> %CP/DS</label>
                <label><input type="checkbox" class="chart-toggle" data-chart="productSalesChart" checked> DS theo S·∫£n ph·∫©m</label>
                <label><input type="checkbox" class="chart-toggle" data-chart="marketSalesChart" checked> DS theo Th·ªã tr∆∞·ªùng</label>
            </div>
            <div class="charts-container">
                <div class="chart-wrapper" data-chart="cpqcChart"><canvas id="cpqcChart"></canvas></div>
                <div class="chart-wrapper" data-chart="dsChotChart"><canvas id="dsChotChart"></canvas></div>
                <div class="chart-wrapper" data-chart="rateChart"><canvas id="rateChart"></canvas></div>
                <div class="chart-wrapper" data-chart="messChart"><canvas id="messChart"></canvas></div>
                <div class="chart-wrapper" data-chart="cpsChart"><canvas id="cpsChart"></canvas></div>
                <div class="chart-wrapper" data-chart="cpDsRatioChart"><canvas id="cpDsRatioChart"></canvas></div>
                <div class="chart-wrapper" data-chart="productSalesChart"><canvas id="productSalesChart"></canvas></div>
                <div class="chart-wrapper" data-chart="marketSalesChart"><canvas id="marketSalesChart"></canvas></div>
            </div>
            </div>
        </div>
        </div>
    </div>
  </div>

<script>
// --- ================================== ---
// --- PH·∫¶N SCRIPT CHUNG & QU·∫¢N L√ù TAB ---
// --- ================================== ---
const loader = document.getElementById('loading-overlay');
const showLoader = () => loader.classList.add('visible');
const hideLoader = () => loader.classList.remove('visible');
let charts = {}; // Khai b√°o charts ·ªü scope to√†n c·ª•c

function openTab(evt, tabName) {
  document.querySelectorAll(".tab-content").forEach(tc => tc.style.display = "none");
  document.querySelectorAll(".tablinks").forEach(tl => tl.classList.remove("active"));
  document.getElementById(tabName).style.display = "block";
  evt.currentTarget.classList.add("active");
  
  // Logic ƒë·∫∑c bi·ªát: kh·ªüi t·∫°o bi·ªÉu ƒë·ªì khi l·∫ßn ƒë·∫ßu m·ªü tab "B√°o c√°o theo ng√†y"
  if (tabName === 'DailyReport' && !charts.cpqcChart) { 
      initAllCharts(); 
      applyDailyFilters(); 
  }
}

document.addEventListener('DOMContentLoaded', () => {
    // G·ªçi h√†m kh·ªüi t·∫°o cho c·∫£ hai ph·∫ßn c·ªßa trang
    initializeAppSaleReport();
    initializeAppCostReport();
    
    // M·ªü tab ƒë·∫ßu ti√™n m·∫∑c ƒë·ªãnh
    document.getElementById("defaultOpen").click();
});

// --- =============================== ---
// --- SCRIPT CHO TAB 1 (B√ÅO C√ÅO SALE) ---
// --- =============================== ---
(function() {
    let appData = {
      employeeList: [
        "Tr·∫ßn Th·ªã Ng·ªçc √Ånh", "D∆∞∆°ng Th·ªã H·∫°nh", "D∆∞∆°ng ƒê·ª©c M·∫°nh", "Tr·∫ßn Th·ªã H·ªìng Nhung",
        "B√πi Th·ªã Thu Huy·ªÅn", "Nguy·ªÖn Duy ƒê·ª©c", "Nguy·ªÖn Th·ªã Th·∫£o", "ƒê·∫∑ng Th·ªã Nga", "Ph·∫°m Th·ªã Y·∫øn",
        "Ph·∫°m Th·ªã L·ªá", "Nguy·ªÖn Th·ªã √Ånh Nguy·ªát", "ƒêinh Th·ªã Ho√†i Th∆∞", "Nguy·ªÖn M·ªπ Duy√™n",
        "Ph·∫°m VƒÉn ƒê·∫°t", "Nguy·ªÖn Anh ƒêi·ªáp", "Nguy·ªÖn Ti·∫øn M·∫°nh", "Giang Ki·ªÅu Duy√™n",
        "Ho√†ng Th·ªã Uy√™n", "Ho√†ng Th·∫£o Nguy√™n", "Ph·∫°m Th·ªã Huy·ªÅn Trang", "Nguy·ªÖn M·∫°nh T√∫",
        "Phan Thu H∆∞∆°ng", "Tr·∫ßn Uy V≈©", "Nguy·ªÖn Th·ªã √Ånh Nguy·ªát 1","H·ªì Thanh Ti·ªán", "L√™ Nguy·ªÖn Mai Khanh",
        "Tr·∫ßn Th·ªã M·ªπ V√¢n", "L√™ Th·ªã Di·ªÖm H·∫±ng", "Nguy·ªÖn Trung Lu·∫≠n", "L√™ H·∫£i Huy·ªÅn Vy",
        "Tr·ªãnh Ng·ªçc Thanh Ph∆∞∆°ng", "Nguy·ªÖn Th·ªã Lan Anh", "Nguy·ªÖn Th·ªã Thanh Tuy·ªÅn", "Nguy·ªÖn Th·ªã Lan Anh 2",
        "Th√°i Th·ªã Kim Chi", "ƒê·ªó Th√∫y Hi·ªÅn", "Nguy·ªÖn Th·ªã M·ªπ Uy√™n", "M√£ Tuy·∫øt Nhi",
        "Nguy·ªÖn Th·ªã D∆∞∆°ng", "Tr·∫ßn Ng·ªçc Kim Th√πy", "Nguy·ªÖn Th√πy Trang", "V≈© Th·ªã Ph∆∞∆°ng Thanh",
        "Phan Nh√¢n", "Trang Tr·ªçng T√≠n", "Nguy·ªÖn Th·ªã Thu Trang", "Nguy·ªÖn Tuy·∫øt Nhi", "Tr·∫ßn Th·ªã Kim Anh",
        "Ph·∫°m H·∫£i Y·∫øn", "Tr·∫ßn Th·ªã Nhung", "L√™ Ng·ªçc ƒê√†i Trang", "ƒê·ªó Th·ªã Thu H·∫±ng", "Mai Th·ªã L√Ω"
      ],
      shiftList: ["H·∫øt ca", "Cu·ªëi ca"],
      productList:["Fitgum CAFE 20X","Kem Body","Bakuchiol Retinol","Serum s√¢m","Glutathione Collagen","Glutathione Collagen NEW","DG"],
      marketList: ["Nh·∫≠t B·∫£n","H√†n Qu·ªëc","Canada","US","√öc","Anh"],
    };

    const tableBody = document.getElementById('tableBody');
    const addRowBtn = document.getElementById('addRowBtn');
    const submitBtn = document.getElementById('submitBtn');
    const form = document.getElementById('dataForm');
    const statusDiv = document.getElementById('status');
    const respMsg = document.getElementById('responseMessage');
    const employeeDatalist = document.getElementById('employee-datalist');
    let rowCounter = 0;

    function updateStatus(message, isError = false) {
      statusDiv.textContent = new Date().toLocaleTimeString() + ': ' + message;
      statusDiv.style.color = isError ? '#721c24' : '#495057';
      statusDiv.style.backgroundColor = isError ? '#f8d7da' : '#e9ecef';
    }

    function getToday() { return new Date().toISOString().split('T')[0]; }
    function escapeHtml(str) { const div = document.createElement('div'); div.textContent = str || ''; return div.innerHTML; }
    function createOptions(list, selectedValue = '') { return list.map(item => `<option value="${escapeHtml(item)}" ${item === selectedValue ? 'selected' : ''}>${escapeHtml(item)}</option>`).join(''); }
    
    function populateEmployeeDatalist() {
        appData.employeeList.sort((a, b) => a.localeCompare(b, 'vi'));
        employeeDatalist.innerHTML = appData.employeeList.map(item => `<option value="${escapeHtml(item)}"></option>`).join('');
    }

    function formatNumberInput(input) {
        let value = input.value;
        if (!value) return;
        const cursorPosition = input.selectionStart;
        const originalLength = value.length;
        const numericValue = value.replace(/[^0-9]/g, '');
        if (numericValue === "") { input.value = ""; return; }
        input.value = new Intl.NumberFormat('de-DE').format(numericValue);
        const newLength = input.value.length;
        const newCursorPosition = cursorPosition + (newLength - originalLength);
        input.setSelectionRange(newCursorPosition, newCursorPosition);
    }

    function addNewRow(data = {}, insertAfterElement = null) {
      rowCounter++;
      const rowId = `row${rowCounter}`;
      const row = document.createElement('tr');
      row.dataset.rowId = rowId;
      row.innerHTML = `
        <td class="action-buttons"><button type="button" class="removeRow">‚ùå</button></td>
        <td><input name="T√™n" list="employee-datalist" placeholder="-- Ch·ªçn ho·∫∑c nh·∫≠p t√™n --" value="${escapeHtml(data.T√™n || '')}" autocomplete="off"></td>
        <td><input name="Ng√†y" type="date" value="${data.Ng√†y || getToday()}"></td>
        <td><select name="Ca"><option value="">-- Ch·ªçn ca --</option>${createOptions(appData.shiftList, data.Ca)}</select></td>
        <td><select name="S·∫£n ph·∫©m"><option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>${createOptions(appData.productList, data['S·∫£n ph·∫©m'])}</select></td>
        <td><div class="input-container"><select name="Th·ªã tr∆∞·ªùng"><option value="">-- Ch·ªçn th·ªã tr∆∞·ªùng --</option>${createOptions(appData.marketList, data['Th·ªã tr∆∞·ªùng'])}</select><button type="button" class="addSimilar">‚ûï</button></div></td>
        <td><input name="S·ªë Mess" type="text" inputmode="numeric" value="${data['S·ªë Mess'] || ''}"></td>
        <td><input name="Ph·∫£n h·ªìi" type="text" inputmode="numeric" value="${data['Ph·∫£n h·ªìi'] || ''}"></td>
        <td class="hidden"><input name="id" value="${data.id || 'id_' + Date.now() + rowCounter}" readonly></td>`;
      
      if (insertAfterElement) insertAfterElement.after(row); else tableBody.appendChild(row);

      const soMessInput = row.querySelector('[name="S·ªë Mess"]');
      const phanHoiInput = row.querySelector('[name="Ph·∫£n h·ªìi"]');
      if (soMessInput) formatNumberInput(soMessInput);
      if (phanHoiInput) formatNumberInput(phanHoiInput);
      updateStatus(`ƒê√£ th√™m d√≤ng ${rowCounter}`);
      return row;
    }

    function removeRow(button) { button.closest('tr').remove(); updateStatus('ƒê√£ x√≥a d√≤ng'); }
    function addSimilarRow(button) {
      const currentRow = button.closest('tr'); const data = {};
      currentRow.querySelectorAll('input, select').forEach(input => {
        if (input.name && input.value) {
           let value = input.value;
           if (input.name === 'S·ªë Mess' || input.name === 'Ph·∫£n h·ªìi') { value = value.replace(/\./g, ''); }
           data[input.name] = value;
        }
      });
      delete data.id; delete data['S·ªë Mess']; delete data['Ph·∫£n h·ªìi'];
      addNewRow(data, currentRow);
    }

    tableBody.addEventListener('click', function(e) {
        if (e.target.classList.contains('removeRow')) removeRow(e.target);
        if (e.target.classList.contains('addSimilar')) addSimilarRow(e.target);
    });

    function validateForm() {
      document.querySelectorAll('#SaleReportContainer .error-cell').forEach(cell => cell.classList.remove('error-cell'));
      let isValid = true;
      const rows = tableBody.querySelectorAll('tr');
      if (rows.length === 0) { respMsg.className = 'error'; respMsg.textContent = 'Ch∆∞a c√≥ d√≤ng n√†o ƒë·ªÉ g·ª≠i!'; return false; }
      const requiredFields = ['T√™n', 'Ng√†y', 'Ca', 'S·∫£n ph·∫©m', 'Th·ªã tr∆∞·ªùng', 'S·ªë Mess', 'Ph·∫£n h·ªìi'];
      rows.forEach(row => {
        requiredFields.forEach(fieldName => {
          const input = row.querySelector(`[name="${fieldName}"]`);
          if (input && !input.value.trim()) { isValid = false; input.closest('td').classList.add('error-cell'); }
        });
      });
      if (!isValid) { respMsg.className = 'error'; respMsg.textContent = 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin v√†o c√°c √¥ ƒë∆∞·ª£c ƒë√°nh d·∫•u m√†u ƒë·ªè'; }
      return isValid;
    }

    function handleSubmit(e) {
      e.preventDefault();
      if (!validateForm()) return;
      submitBtn.disabled = true; submitBtn.textContent = 'ƒêang g·ª≠i...';
      const allRows = [];
      tableBody.querySelectorAll('tr').forEach(row => {
        const rowData = {};
        row.querySelectorAll('input, select').forEach(input => {
          if (input.name) {
             let value = input.value;
             if (input.name === 'S·ªë Mess' || input.name === 'Ph·∫£n h·ªìi') { value = value.replace(/\./g, ''); }
             rowData[input.name] = value;
          }
        });
        if (Object.keys(rowData).length > 0) allRows.push(rowData);
      });
      const formData = new FormData(); formData.append('rows', JSON.stringify(allRows));
      const SUBMIT_URL = 'https://script.google.com/macros/s/AKfycbzMRj7bLP_2DvcXTiRw5M4IzbuLpz_RHZy7UPB9ASZSfkWMxE2I1kwW3yQ-ugzbeq3i/exec';
      fetch(SUBMIT_URL, { method: 'POST', body: formData }).then(response => response.json())
      .then(result => {
        if (result.error) { respMsg.className = 'error'; respMsg.textContent = 'L·ªói: ' + result.error; updateStatus('G·ª≠i b√°o c√°o th·∫•t b·∫°i', true);
        } else {
          respMsg.className = 'success'; respMsg.textContent = result.message || `ƒê√£ g·ª≠i th√†nh c√¥ng ${allRows.length} d√≤ng d·ªØ li·ªáu!`;
          tableBody.innerHTML = ''; rowCounter = 0;
          const urlParams = new URLSearchParams(window.location.search);
          addNewRow({ T√™n: urlParams.get('hoten') });
          updateStatus('Ho√†n th√†nh g·ª≠i b√°o c√°o');
        }
      })
      .catch(error => { respMsg.className = 'error'; respMsg.textContent = 'L·ªói khi g·ª≠i d·ªØ li·ªáu: ' + error.message; updateStatus('G·ª≠i b√°o c√°o th·∫•t b·∫°i: L·ªói m·∫°ng ho·∫∑c server', true); })
      .finally(() => { submitBtn.disabled = false; submitBtn.textContent = 'üöÄ G·ª≠i b√°o c√°o'; });
    }

    window.initializeAppSaleReport = async function() {
        const urlParams = new URLSearchParams(window.location.search);
        const employeeNameFromUrl = urlParams.get('hoten');
        const DATA_URL = 'https://script.google.com/macros/s/AKfycbwUAOe09h3bKgaqdAae64a1WSFHkiksKWTnri0TqxuckwX41nQXnLPwJDS3UVGFk3Va/exec';
        try {
            updateStatus('ƒêang t·∫£i d·ªØ li·ªáu...');
            const response = await fetch(DATA_URL);
            if (!response.ok) throw new Error(`L·ªói m·∫°ng: ${response.status} ${response.statusText}`);
            const loadedData = await response.json();
            if(loadedData.marketList && loadedData.marketList.length > 0) appData.marketList = loadedData.marketList;
            populateEmployeeDatalist();
            addRowBtn.disabled = false; submitBtn.disabled = false;
            updateStatus('T·∫£i d·ªØ li·ªáu th√†nh c√¥ng. ·ª®ng d·ª•ng ƒë√£ s·∫µn s√†ng!');
            addNewRow({ T√™n: employeeNameFromUrl });
        } catch(error) {
            console.error("L·ªói nghi√™m tr·ªçng khi t·∫£i d·ªØ li·ªáu Sale:", error);
            updateStatus(`Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu t·ª´ server. S·ª≠ d·ª•ng d·ªØ li·ªáu d·ª± ph√≤ng. L·ªói: ${error.message}`, true);
            respMsg.className = 'error';
            respMsg.textContent = 'L·ªói: Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu m·ªõi, ƒëang s·ª≠ d·ª•ng danh s√°ch d·ª± ph√≤ng.';
            populateEmployeeDatalist(); addRowBtn.disabled = false; submitBtn.disabled = false;
            addNewRow({ T√™n: employeeNameFromUrl });
        }
    }

    form.addEventListener('submit', handleSubmit);
    addRowBtn.addEventListener('click', () => addNewRow());
    tableBody.addEventListener('input', e => { if (e.target.tagName === 'INPUT' && (e.target.name === 'S·ªë Mess' || e.target.name === 'Ph·∫£n h·ªìi')) { formatNumberInput(e.target); } });
})();


// --- ================================== ---
// --- SCRIPT CHO TAB 2 & 3 (B√ÅO C√ÅO CHI PH√ç) ---
// --- ================================== ---
(function() {
    let rawData = [];
    const groupChildren = { 'Ch√¢u √Å': ['H√†n Qu·ªëc','Nh·∫≠t B·∫£n','VN'], 'Ngo√†i Ch√¢u √Å': ['√öc','US', 'Canada'] };
    
    function setDefaultDates() {
        const today = new Date(), firstDay = new Date(today.getFullYear(), today.getMonth(), 1), lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        const formatDateForInput = (date) => date.toISOString().split('T')[0];
        document.getElementById('start-date-tab1').value = formatDateForInput(firstDay);
        document.getElementById('end-date-tab1').value = formatDateForInput(lastDay);
        document.getElementById('start-date-tab2').value = formatDateForInput(firstDay);
        document.getElementById('end-date-tab2').value = formatDateForInput(lastDay);
    }

    function addEventListeners() {
      document.querySelector('#CostReportsContainer').addEventListener('change', (e) => {
        if (e.target.closest('#DetailedReport')) { handleTab1Filters(e.target); }
        else if (e.target.closest('#DailyReport')) { handleTab2Filters(e.target); }
      });
    }
    
    function fetchData() {
        showLoader();
        fetch('https://script.google.com/macros/s/AKfycbwGwSBxeXplEzAM-jJDPaXPkiWjNyKmpR70o6nCY5_ynqoF-3WA1gvF91RIQQfDZ9fvAQ/exec')
        .then(res => res.json())
        .then(data => {
          rawData = data.map(r => ({ ...r, team: r.team || 'Kh√°c', ten: r.ten || 'N/A', dsChot: +r.dsChot || 0, cpqc: +r.cpqc || 0, soDon: +r.soDon || 0, soMessCmt: +r.soMessCmt || 0, doanhsoTC: +r.doanhsoTC || 0, tienShip: +r.tienShip || 0, doanhSo: +r.doanhSo || 0, doanhSoSauShip: +r.doanhSoSauShip || 0, kpis: +r.kpis || 0 }));
          populateAllFilters(rawData);
          applyTab1Filters();
          if (document.getElementById('DailyReport').style.display === 'block') { applyDailyFilters(); }
        }).catch(err => { console.error("L·ªói khi t·∫£i d·ªØ li·ªáu chi ph√≠:", err); alert('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu chi ph√≠.'); }).finally(() => hideLoader());
    }

    function getFilteredData(filterIds) {
        const { startDateId, endDateId, productCbId, productOptionsClass, marketCbId, marketOptionsClass, caCbId, caOptionsClass, teamCbId, teamOptionsClass } = filterIds;
        const startDateValue = document.getElementById(startDateId).value, endDateValue = document.getElementById(endDateId).value;
        const pAll = document.getElementById(productCbId).checked, selP = pAll ? null : [...document.querySelectorAll(`.${productOptionsClass}:checked`)].map(cb => cb.value);
        const mAll = document.getElementById(marketCbId).checked, selM = mAll ? null : [...document.querySelectorAll(`.${marketOptionsClass}:checked`)].map(cb => cb.value);
        const cAll = caCbId ? document.getElementById(caCbId).checked : true, selCa = caCbId && !cAll ? [...document.querySelectorAll(`.${caOptionsClass}:checked`)].map(cb => cb.value) : null;
        const tAll = teamCbId ? document.getElementById(teamCbId).checked : true, selT = tAll ? null : [...document.querySelectorAll(`.${teamOptionsClass}:checked`)].map(cb => cb.value);
        
        return rawData.filter(r => {
            if (!r.ngay) return false;
            const d = new Date(r.ngay); if (isNaN(d.getTime())) return false;
            const year = d.getFullYear(), month = String(d.getMonth() + 1).padStart(2, '0'), day = String(d.getDate()).padStart(2, '0');
            const dataDateStr = `${year}-${month}-${day}`;
            const isDateOk = (!startDateValue || dataDateStr >= startDateValue) && (!endDateValue || dataDateStr <= endDateValue);
            const isProductOk = !selP || selP.includes(r.sanPham);
            const marketGroup = getGroup(normalize(r.thiTruong));
            const isMarketOk = !selM || selM.includes(marketGroup) || selM.includes(r.thiTruong);
            const isCaOk = !selCa || selCa.includes(r.ca);
            const isTeamOk = !selT || selT.includes(r.team);
            return isDateOk && isProductOk && isMarketOk && isCaOk && isTeamOk;
        });
    }

    function populateAllFilters(data) {
        const prodSet=new Set(), caSet=new Set(), teamSet=new Set(), mktSet=new Set();
        data.forEach(r=>{ if(r.sanPham) prodSet.add(r.sanPham); if(r.ca) caSet.add(r.ca); if(r.team) teamSet.add(r.team); if(r.thiTruong) mktSet.add(r.thiTruong); });
        const productHtml = Array.from(prodSet).sort().map(p => `<label class='indent'><input type='checkbox' class='filter-product-tab1' value='${p}' checked> ${p}</label>`).join('');
        document.getElementById('product-options-tab1').innerHTML = productHtml;
        document.getElementById('product-options-tab2').innerHTML = productHtml.replaceAll('filter-product-tab1', 'filter-product-tab2');
        const marketHtml = Object.keys(groupChildren).map(grp => `<label><input type='checkbox' class='filter-market-tab1' value='${grp}' checked> ${grp}</label>` + groupChildren[grp].map(ch => `<label class='indent'><input type='checkbox' class='filter-market-tab1' value='${ch}' checked> ${ch}</label>`).join('')).join('');
        const otherMarkets = Array.from(mktSet).filter(m => !Object.values(groupChildren).flat().map(c => c.toLowerCase()).includes(m.toLowerCase())).sort().map(m => `<label><input type='checkbox' class='filter-market-tab1' value='${m}' checked> ${m}</label>`).join('');
        document.getElementById('market-options-tab1').innerHTML = marketHtml + otherMarkets;
        document.getElementById('market-options-tab2').innerHTML = (marketHtml + otherMarkets).replaceAll('filter-market-tab1', 'filter-market-tab2');
        document.getElementById('ca-options-tab1').innerHTML = Array.from(caSet).sort().map(c => `<label class='indent'><input type='checkbox' class='filter-ca-tab1' value='${c}' checked> ${c}</label>`).join('');
        document.getElementById('team-options-tab1').innerHTML = Array.from(teamSet).sort().map(t => `<label class='indent'><input type='checkbox' class='filter-team-tab1' value='${t}' checked> ${t}</label>`).join('');
    }
    
    function normalize(s) { return (s||'').trim().toLowerCase(); }
    function capitalize(s) { return s.charAt(0).toUpperCase()+s.slice(1); }
    function getGroup(norm) { for (let g in groupChildren) { if (groupChildren[g].map(normalize).includes(norm)) return g; } return capitalize(norm); }
    function formatDate(v) { const d = new Date(v); if (isNaN(d)) return v; return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`; }
    function formatCurrency(v) { return Number(v||0).toLocaleString('vi-VN',{style:'currency',currency:'VND'}); }
    function formatPriceShort(v) { const num = Number(v || 0); if (v === null || v === undefined) return ''; if (num >= 1000000) return (num / 1000000).toFixed(1) + 'tr'; if (num >= 1000) return (num / 1000).toFixed(0) + 'k'; return num.toLocaleString('vi-VN'); }
    function formatPercent(v) { if (v === null || v === undefined || !isFinite(v)) return '0.00%'; return `${(Number(v||0) * 100).toFixed(2)}%`; }
    function handleCheckbox(masterId, childClass, target) { if (target.id === masterId) { document.querySelectorAll(`.${childClass}`).forEach(cb => cb.checked = target.checked); } else if (target.classList.contains(childClass)) { document.getElementById(masterId).checked = [...document.querySelectorAll(`.${childClass}`)].every(cb => cb.checked); } }

    function handleTab1Filters(target) { showLoader(); setTimeout(() => { handleCheckbox('product-all-tab1', 'filter-product-tab1', target); handleCheckbox('ca-all-tab1', 'filter-ca-tab1', target); handleCheckbox('team-all-tab1', 'filter-team-tab1', target); handleCheckbox('market-all-tab1', 'filter-market-tab1', target); applyTab1Filters(); hideLoader(); }, 10); }
    function applyTab1Filters() {
        const filterIds = { startDateId: 'start-date-tab1', endDateId: 'end-date-tab1', productCbId: 'product-all-tab1', productOptionsClass: 'filter-product-tab1', marketCbId: 'market-all-tab1', marketOptionsClass: 'filter-market-tab1', caCbId: 'ca-all-tab1', caOptionsClass: 'filter-ca-tab1', teamCbId: 'team-all-tab1', teamOptionsClass: 'filter-team-tab1' };
        const filtered = getFilteredData(filterIds);
        const selectedMarkets = [...document.querySelectorAll('.filter-market-tab1:checked')].map(cb => cb.value);
        renderSummary(filtered, selectedMarkets); renderKpiSummary(filtered); renderDailyBreakdown(filtered);
    }

    function getCpsCellStyle(cps, selectedMarkets) { const hasChauA = selectedMarkets.some(m => m === 'Ch√¢u √Å' || groupChildren['Ch√¢u √Å'].includes(m)); const hasNgoaiChauA = selectedMarkets.some(m => m === 'Ngo√†i Ch√¢u √Å' || groupChildren['Ngo√†i Ch√¢u √Å'].includes(m)); const isChauAOnly = hasChauA && !hasNgoaiChauA && selectedMarkets.length > 0; if (isChauAOnly) { if (cps > 1000000) return 'bg-lightred'; if (cps > 700000) return 'bg-yellow'; } else { if (cps > 1500000) return 'bg-lightred'; if (cps > 1000000) return 'bg-yellow'; } return ''; }
    
    function renderSummary(data, selectedMarkets) {
        const summaryData = {}; let total = { mess: 0, don: 0, chot: 0, cpqc: 0 };
        data.forEach(r => {
            const name = r.ten;
            if (!summaryData[name]) summaryData[name] = { team: r.team, mess: 0, don: 0, chot: 0, cpqc: 0 };
            summaryData[name].mess += r.soMessCmt; summaryData[name].don += r.soDon; summaryData[name].chot += r.dsChot; summaryData[name].cpqc += r.cpqc;
        });
        const flatList = Object.keys(summaryData).map(name => ({ name, team: summaryData[name].team, data: summaryData[name] })).sort((a,b) => a.team.localeCompare(b.team) || a.name.localeCompare(b.name));
        let bodyHtml = flatList.map((item, index) => {
            const s = item.data; total.mess += s.mess; total.don += s.don; total.chot += s.chot; total.cpqc += s.cpqc;
            const rate = s.mess ? s.don / s.mess : 0, pm = s.mess ? s.cpqc / s.mess : 0, pd = s.don ? s.cpqc / s.don : 0, pc = s.chot ? s.cpqc / s.chot : 0, pdt = s.don ? s.chot / s.don : 0;
            const rateClass = rate > 0.1 ? 'bg-green' : 'bg-yellow', cpsClass = getCpsCellStyle(pd, selectedMarkets), cpdsClass = pc > 0.33 ? 'bg-yellow' : '';
            return `<tr><td class="text-center">${index + 1}</td><td class="text-left">${item.team}</td><td class="text-left">${item.name}</td><td>${s.mess.toLocaleString('vi-VN')}</td><td>${formatCurrency(s.cpqc)}</td><td>${s.don.toLocaleString('vi-VN')}</td><td>${formatCurrency(s.chot)}</td><td class="${rateClass}">${formatPercent(rate)}</td><td>${formatCurrency(pm)}</td><td class="${cpsClass}">${formatCurrency(pd)}</td><td class="${cpdsClass}">${formatPercent(pc)}</td><td>${formatCurrency(pdt)}</td></tr>`;
        }).join('');
        document.getElementById('summary-body').innerHTML = bodyHtml;
        const totalRate = total.mess ? total.don / total.mess : 0, totalPm = total.mess ? total.cpqc / total.mess : 0, totalPd = total.don ? total.cpqc / total.don : 0, totalPc = total.chot ? total.cpqc / total.chot : 0, totalPdt = total.don ? total.chot / total.don : 0;
        const footerHtml = `<tr class="total-row"><td class="total-label" colspan="3">T·ªîNG C·ªòNG</td><td class="total-value">${total.mess.toLocaleString('vi-VN')}</td><td class="total-value">${formatCurrency(total.cpqc)}</td><td class="total-value">${total.don.toLocaleString('vi-VN')}</td><td class="total-value">${formatCurrency(total.chot)}</td><td class="total-value">${formatPercent(totalRate)}</td><td class="total-value">${formatCurrency(totalPm)}</td><td class="total-value">${formatCurrency(totalPd)}</td><td class="total-value">${formatPercent(totalPc)}</td><td class="total-value">${formatCurrency(totalPdt)}</td></tr>`;
        document.getElementById('summary-foot').innerHTML = footerHtml;
    }

    function renderKpiSummary(data) { 
        const summaryByMkt = {}; 
        data.forEach(r => { 
            const mktName = r.ten;
            if (!summaryByMkt[mktName]) summaryByMkt[mktName] = { cpqc: 0, dsChot: 0, dsDi: 0, dsSauShip: 0, dsThanhCong: 0, kpiValue: r.kpis, team: r.team }; 
            summaryByMkt[mktName].cpqc += r.cpqc; summaryByMkt[mktName].dsChot += r.dsChot; summaryByMkt[mktName].dsDi += r.doanhSo; summaryByMkt[mktName].dsSauShip += r.doanhSoSauShip; summaryByMkt[mktName].dsThanhCong += r.doanhsoTC;
        });
        const sortedMktKeys = Object.keys(summaryByMkt).sort((a, b) => (summaryByMkt[a].team || 'zzz').localeCompare(summaryByMkt[b].team || 'zzz') || a.localeCompare(b));
        let total = { cpqc: 0, dsChot: 0, dsDi: 0, dsSauShip: 0, dsThanhCong: 0, kpis: 0 };
        let bodyHtml = sortedMktKeys.map((mkt, i) => { 
            const s = summaryByMkt[mkt]; total.cpqc += s.cpqc; total.dsChot += s.dsChot; total.dsDi += s.dsDi; total.dsSauShip += s.dsSauShip; total.dsThanhCong += s.dsThanhCong; total.kpis += s.kpiValue;
            const cp_ds = s.dsSauShip ? s.cpqc / s.dsSauShip : 0, kpiPercentage = s.kpiValue ? s.dsSauShip / s.kpiValue : 0, cpdsClass = cp_ds > 0.33 ? 'bg-yellow' : ''; 
            return `<tr><td class="text-center">${i+1}</td><td class="text-left">${s.team}</td><td class="text-left">${mkt}</td><td>${formatCurrency(s.cpqc)}</td><td>${formatCurrency(s.dsChot)}</td><td>${formatCurrency(s.dsDi)}</td><td>${formatCurrency(s.dsSauShip)}</td><td>${formatCurrency(s.dsThanhCong)}</td><td class="${cpdsClass}">${formatPercent(cp_ds)}</td><td>${formatPercent(kpiPercentage)}</td></tr>`;
        }).join(''); 
        document.getElementById('kpi-summary-body').innerHTML = bodyHtml;
        const totalCpds = total.dsSauShip ? total.cpqc / total.dsSauShip : 0, totalKpiPercentage = total.kpis ? total.dsSauShip / total.kpis : 0;
        const footerHtml = `<tr class="total-row"><td class="total-label" colspan="3">T·ªîNG C·ªòNG</td><td class="total-value">${formatCurrency(total.cpqc)}</td><td class="total-value">${formatCurrency(total.dsChot)}</td><td class="total-value">${formatCurrency(total.dsDi)}</td><td class="total-value">${formatCurrency(total.dsSauShip)}</td><td class="total-value">${formatCurrency(total.dsThanhCong)}</td><td class="total-value">${formatPercent(totalCpds)}</td><td class="total-value">${formatPercent(totalKpiPercentage)}</td></tr>`;
        document.getElementById('kpi-summary-foot').innerHTML = footerHtml;
    }
    
    function renderDailyBreakdown(data) { 
        const c=document.getElementById('daily-breakdown'); c.innerHTML=''; const grpObj={};
        data.forEach(r=>{const d=formatDate(r.ngay);(grpObj[d]||(grpObj[d]=[])).push(r);});
        Object.keys(grpObj).sort((a,b)=>new Date(b.split('/').reverse().join('-'))-new Date(a.split('/').reverse().join('-'))).forEach(date=>{
            let m=0,d=0,ch=0,pc=0;
            const sortedDailyData = grpObj[date].sort((a, b) => (a.team || 'zzz').localeCompare(b.team || 'zzz'));
            const rowsHtml = sortedDailyData.map(r=>{ m+=r.soMessCmt;d+=r.soDon;ch+=r.dsChot;pc+=r.cpqc; return`<tr><td class="text-center">${r.id}</td><td class="text-left">${r.ten}</td><td class="text-left">${r.ca}</td><td class="text-left">${r.page}</td><td class="text-left">${r.sanPham}</td><td class="text-left">${r.thiTruong}</td><td>${r.soMessCmt.toLocaleString('vi-VN')}</td><td>${r.soDon.toLocaleString('vi-VN')}</td><td>${formatCurrency(r.dsChot)}</td><td>${formatCurrency(r.cpqc)}</td><td class="text-left">${r.team}</td></tr>` }).join('');
            const footHtml=`<tr class='total-row'><td colspan='6' class='total-label'>T·ªïng</td><td class='total-value'>${m.toLocaleString('vi-VN')}</td><td class='total-value'>${d.toLocaleString('vi-VN')}</td><td class='total-value'>${formatCurrency(ch)}</td><td class='total-value'>${formatCurrency(pc)}</td><td></td></tr>`;
            const tableHtml = `<div class="table-responsive-container"><table><thead><tr><th>ID</th><th>T√™n</th><th>Ca</th><th>Page</th><th>S·∫£n ph·∫©m</th><th>Th·ªã tr∆∞·ªùng</th><th>Mess</th><th>ƒê∆°n</th><th>DS Ch·ªët</th><th>CPQC</th><th>Team</th></tr></thead><tbody>${rowsHtml}</tbody><tfoot>${footHtml}</tfoot></table></div>`;
            c.innerHTML+=`<h3>${date}</h3>${tableHtml}`;
        }); 
    }

    function handleTab2Filters(target) { showLoader(); setTimeout(() => { if (target.id === 'toggle-all-charts' || target.classList.contains('chart-toggle')) { if (target.id === 'toggle-all-charts') document.querySelectorAll('.chart-toggle').forEach(cb => cb.checked = target.checked); else document.getElementById('toggle-all-charts').checked = [...document.querySelectorAll('.chart-toggle')].every(cb => cb.checked); toggleChartVisibility(); hideLoader(); return; } handleCheckbox('product-all-tab2', 'filter-product-tab2', target); handleCheckbox('market-all-tab2', 'filter-market-tab2', target); applyDailyFilters(); hideLoader(); }, 10); }
    window.applyDailyFilters = function() { if (!rawData.length) return; const filterIds = { startDateId: 'start-date-tab2', endDateId: 'end-date-tab2', productCbId: 'product-all-tab2', productOptionsClass: 'filter-product-tab2', marketCbId: 'market-all-tab2', marketOptionsClass: 'filter-market-tab2' }; const filtered = getFilteredData(filterIds); renderDailyTable(filtered); renderAllDailyCharts(filtered); }
    function renderDailyTable(data) { const daily = {}; data.forEach(r => { const dateKey = formatDate(r.ngay); if (!daily[dateKey]) daily[dateKey] = { cpqc: 0, don: 0, mess: 0, chot: 0 }; daily[dateKey].cpqc += r.cpqc; daily[dateKey].don += r.soDon; daily[dateKey].mess += r.soMessCmt; daily[dateKey].chot += r.dsChot; }); let tbodyHtml = Object.keys(daily).sort((a,b) => new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-'))).map(d => { const day = daily[d]; const avg = day.mess ? day.don / day.mess : 0, giaMess = day.mess ? day.cpqc / day.mess : 0, cps = day.don ? day.cpqc / day.don : 0, cpqcRatio = day.chot ? day.cpqc / day.chot : 0; return `<tr><td class="text-left"><b>${d}</b></td><td>${formatPriceShort(day.cpqc)}</td><td>${formatPriceShort(day.chot)}</td><td>${formatPercent(avg)}</td><td>${formatPriceShort(giaMess)}</td><td>${formatPriceShort(cps)}</td><td>${formatPercent(cpqcRatio)}</td></tr>`; }).join(''); document.getElementById('date-summary-body').innerHTML = tbodyHtml; }
    function toggleChartVisibility() { document.querySelectorAll('.chart-toggle').forEach(checkbox => { const chartName = checkbox.dataset.chart, wrapper = document.querySelector(`.chart-wrapper[data-chart="${chartName}"]`); if (wrapper) { wrapper.style.display = checkbox.checked ? 'block' : 'none'; wrapper.style.opacity = checkbox.checked ? '0' : '1'; setTimeout(() => { wrapper.style.opacity = checkbox.checked ? '1' : '0'; }, 10); } }); }
    
    window.initAllCharts = function() {
        const createChart = (ctxId, config) => new Chart(document.getElementById(ctxId).getContext('2d'), config);
        charts.cpqcChart = createChart('cpqcChart', getLineChartConfig('CPQC (VND)')); charts.dsChotChart = createChart('dsChotChart', getLineChartConfig('DS Ch·ªët (VND)')); charts.rateChart = createChart('rateChart', getLineChartConfig('T·ªâ l·ªá ch·ªët (%)', v => formatPercent(v))); charts.messChart = createChart('messChart', getLineChartConfig('Gi√° Mess (VND)')); charts.cpsChart = createChart('cpsChart', getLineChartConfig('CPS (VND)')); charts.cpDsRatioChart = createChart('cpDsRatioChart', getLineChartConfig('%CP/DS', v => formatPercent(v))); charts.productSalesChart = createChart('productSalesChart', getBarChartConfig()); charts.marketSalesChart = createChart('marketSalesChart', getBarChartConfig());
        toggleChartVisibility();
    }
    
    function renderAllDailyCharts(data) {
        if (!Object.keys(charts).length) return;
        const daily = {}; data.forEach(r => { const dateKey = formatDate(r.ngay); if (!daily[dateKey]) daily[dateKey] = { cpqc: 0, don: 0, mess: 0, chot: 0 }; daily[dateKey].cpqc += r.cpqc; daily[dateKey].don += r.soDon; daily[dateKey].mess += r.soMessCmt; daily[dateKey].chot += r.dsChot; });
        const labels = Object.keys(daily).sort((a,b) => new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-')));
        const getChartColors = () => ({ cpqc: { border: '#3F51B5', fill: 'rgba(63, 81, 181, 0.2)' }, dsChot: { border: '#4CAF50', fill: 'rgba(76, 175, 80, 0.2)' }, rate: { border: '#F44336', fill: 'rgba(244, 67, 54, 0.2)' }, mess: { border: '#FF9800', fill: 'rgba(255, 152, 0, 0.2)' }, cps: { border: '#009688', fill: 'rgba(0, 150, 136, 0.2)' }, cpDsRatio: { border: '#9C27B0', fill: 'rgba(156, 39, 176, 0.2)' }, product: { border: '#607D8B', fill: '#607D8B' }, market: { border: '#795548', fill: '#795548' } });
        updateChart(charts.cpqcChart, 'CPQC', labels, labels.map(d => daily[d].cpqc), getChartColors().cpqc);
        updateChart(charts.dsChotChart, 'DS Ch·ªët', labels, labels.map(d => daily[d].chot), getChartColors().dsChot);
        updateChart(charts.rateChart, 'T·ªâ l·ªá ch·ªët', labels, labels.map(d => daily[d].mess ? (daily[d].don / daily[d].mess) : 0), getChartColors().rate);
        updateChart(charts.messChart, 'Gi√° Mess', labels, labels.map(d => daily[d].mess ? (daily[d].cpqc / daily[d].mess) : 0), getChartColors().mess);
        updateChart(charts.cpsChart, 'CPS', labels, labels.map(d => daily[d].don ? (daily[d].cpqc / daily[d].don) : 0), getChartColors().cps);
        updateChart(charts.cpDsRatioChart, '%CP/DS', labels, labels.map(d => daily[d].chot ? (daily[d].cpqc / daily[d].chot) : 0), getChartColors().cpDsRatio);
        const productSales = {}, marketSales = {}; data.forEach(r => { if (r.sanPham) productSales[r.sanPham] = (productSales[r.sanPham] || 0) + r.dsChot; if (r.thiTruong) marketSales[r.thiTruong] = (marketSales[r.thiTruong] || 0) + r.dsChot; });
        const sortedProducts = Object.entries(productSales).sort((a,b) => b[1] - a[1]), sortedMarkets = Object.entries(marketSales).sort((a,b) => b[1] - a[1]);
        updateChart(charts.productSalesChart, 'DS theo SP', sortedProducts.map(p=>p[0]), sortedProducts.map(p=>p[1]), getChartColors().product, 'bar');
        updateChart(charts.marketSalesChart, 'DS theo TT', sortedMarkets.map(m=>m[0]), sortedMarkets.map(m=>m[1]), getChartColors().market, 'bar');
    }

    function getLineChartConfig(yTitle, formatter = v => formatPriceShort(v)) { return { type: 'line', options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { font: { size: 14, weight: '500' }, padding: 20, usePointStyle: true, pointStyle: 'circle' } }, tooltip: { backgroundColor: 'rgba(0,0,0,0.9)', titleFont: { size: 16, weight: 'bold' }, bodyFont: { size: 14 }, padding: 12, cornerRadius: 8, displayColors: true, boxPadding: 6, callbacks: { label: (ctx) => `${ctx.dataset.label}: ${formatter(ctx.raw)}` } }, datalabels: { display: true, align: 'top', anchor: 'end', backgroundColor: (ctx) => ctx.dataset.borderColor, borderColor: '#fff', borderWidth: 1, borderRadius: 12, color: '#fff', font: { weight: 'bold', size: 10 }, formatter: formatter, padding: 6, offset: 4 } }, interaction: { intersect: false, mode: 'index' }, scales: { x: { grid: { display: false, drawBorder: false }, ticks: { font: { size: 12 }, maxRotation: 45, minRotation: 45 } }, y: { title: { display: true, text: yTitle, font: { size: 14, weight: '500' }, padding: {top: 10, bottom: 20} }, ticks: { callback: formatter, font: { size: 12 } }, grid: { color: 'rgba(0,0,0,0.05)', drawBorder: false } } }, elements: { line: { borderWidth: 3, tension: 0.3 }, point: { radius: 5, hoverRadius: 8, hitRadius: 10, backgroundColor: '#fff' } }, layout: { padding: 20 } } }; }
    function getBarChartConfig() { return { type: 'bar', options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false }, tooltip: { backgroundColor: 'rgba(0,0,0,0.9)', titleFont: { size: 16, weight: 'bold' }, bodyFont: { size: 14 }, padding: 12, cornerRadius: 8, displayColors: false, callbacks: { label: (ctx) => `${ctx.parsed.x.toLocaleString()} VND` } }, datalabels: { display: true, anchor: 'end', align: 'right', offset: 8, color: '#333', font: { weight: '600', size: 12 }, formatter: v => formatPriceShort(v) } }, scales: { x: { display: false, grid: { display: false } }, y: { grid: { display: false }, ticks: { font: { size: 13, weight: 'bold' } } } }, layout: { padding: { left: 120, right: 50, top: 20, bottom: 20 } }, barPercentage: 0.8, categoryPercentage: 0.9 } }; }
    function updateChart(chart, label, labels, data, colors, type = 'line') { chart.data.labels = labels; chart.data.datasets = [{ label, data, backgroundColor: type === 'line' ? colors.fill : colors.border, borderColor: colors.border, type, fill: type === 'line', tension: 0.4, borderWidth: type === 'line' ? 3 : 1, pointRadius: type === 'line' ? 5 : undefined, pointBackgroundColor: '#fff', pointBorderWidth: 2, borderRadius: type === 'line' ? 0 : 4 }]; chart.update('none'); }
    
    // H√†m kh·ªüi t·∫°o ri√™ng cho ph·∫ßn b√°o c√°o chi ph√≠
    window.initializeAppCostReport = function() {
        setDefaultDates();
        addEventListeners();
        fetchData();
    }
})();
</script>

</body>
</html>

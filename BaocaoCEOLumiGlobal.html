<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Báo cáo tổng hợp</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
  <style>
    /* --- BẢNG MÀU VÀ BIẾN TOÀN CỤC --- */
    :root {
      --primary-green: #059669; /* Xanh ngọc đậm cho nền */
      --primary-green-light: #10B981; /* Xanh ngọc sáng cho điểm nhấn */
      --accent-yellow: #FFC107; /* Vàng hổ phách */
      --accent-red: #EF4444; /* Đỏ */
      --neutral-border: #e5e7eb; /* Xám nhạt cho viền */
      --neutral-bg-alt: #f9fafb; /* Xám rất nhạt cho nền xen kẽ */
      --text-dark: #1f2937; /* Đen-Xám cho chữ chính */
      --text-light: #ffffff; /* Trắng */
    }

    /* --- CÀI ĐẶT CHUNG & TABS --- */
    html {
      font-size: 21px; /* TĂNG KÍCH THƯỚC CHỮ GỐC LẦN 2 */
    }
    body { 
      font-family: 'Roboto', Arial, sans-serif; 
      padding: 25px; 
      background-color: #f4f4f4; 
      color: var(--text-dark);
      font-weight: 500; /* TĂNG ĐỘ ĐẬM MẶC ĐỊNH */
    }
    .tab-container { 
      overflow: hidden; 
      border-bottom: 2px solid #ccc; 
      margin-bottom: 30px; 
    }
    .tab-container button {
      background-color: #f1f1f1; 
      float: left; 
      border: none; 
      outline: none; 
      cursor: pointer;
      padding: 15px 25px; 
      transition: all 0.3s ease; 
      font-size: 1rem; 
      font-weight: 700;
      border-radius: 10px 10px 0 0; 
      margin-right: 8px;
      color: #555;
    }
    .tab-container button:hover { 
      background-color: #e0e0e0; 
      color: var(--primary-green);
    }
    .tab-container button.active { 
      background-color: var(--primary-green); 
      color: var(--text-light); 
    }
    .tab-content { 
      display: none; 
      padding: 6px 12px; 
      border-top: none; 
      animation: fadeEffect 0.5s; 
    }
    @keyframes fadeEffect { from {opacity: 0;} to {opacity: 1;} }

    /* --- STYLES CHUNG CHO BẢNG & CĂN LỀ --- */
    .table-responsive-container { overflow-x: auto; }
    table { 
      width: 100%; 
      border-collapse: collapse; 
      table-layout: auto; 
      margin-top: 25px; 
      background: #fff; 
      border-radius: 12px; 
      overflow: hidden; 
      box-shadow: 0 4px 15px rgba(0,0,0,0.07);
    }
    th, td { 
      border: 1px solid var(--neutral-border); 
      padding: 16px 18px; 
      white-space: nowrap; 
      vertical-align: middle; 
      transition: background-color 0.2s;
      font-size: 0.95rem;
    }
    
    th { 
      text-align: center !important; 
      font-weight: 900; /* Tăng độ đậm tiêu đề bảng */
      font-size: 1rem;
    }
    td { text-align: right !important; }
    .text-left { text-align: left !important; }
    .text-center { text-align: center !important; }

    tbody tr:nth-child(even) { background-color: var(--neutral-bg-alt); }
    tbody tr:not(.team-header-row):hover { background-color: rgba(16, 185, 129, 0.1); }
    
    th.green-header { background: var(--primary-green); color: var(--text-light); }
    th.yellow-header { background: var(--accent-yellow); color: var(--text-dark); }
    
    tr.total-row, tr.total-row:hover { 
      background: #fffbeb; 
      font-weight: 900; /* Tăng độ đậm dòng tổng */
      font-size: 1.05rem;
      color: #713f12;
      border-top: 3px solid var(--primary-green-light);
    }
    .total-label { text-align: left !important; }
    .total-value { text-align: right !important; }
    
    .bg-green { background-color: var(--primary-green-light) !important; color: white; }
    .bg-yellow { background-color: #FEF08A !important; color: #713f12; }
    .bg-lightred { background-color: var(--accent-red) !important; color: white; }
    
    /* --- STYLES BỐ CỤC SIDEBAR TRÁI --- */
    .report-container { display: flex; flex-wrap: nowrap; gap: 25px; align-items: flex-start; }
    .sidebar { 
        width: 280px; 
        flex-shrink: 0; 
        background: #fff; 
        padding: 20px; 
        border-radius: 12px; 
        box-shadow: 0 4px 15px rgba(0,0,0,0.07);
        position: sticky; 
        top: 25px;
        height: calc(100vh - 80px); 
        overflow-y: auto;
    }
    .main-detailed { flex-grow: 1; min-width: 0; width: calc(100% - 305px); }
    .sidebar h3 { 
      background: var(--primary-green); 
      color: var(--text-light); 
      padding: 12px; 
      margin-top: 15px; 
      font-size: 1.1rem; 
      border-radius: 8px; 
      font-weight: 700;
    }
    .sidebar label { 
      display: block; 
      margin: 10px 0; 
      font-size: 0.9rem; 
      font-weight: 700;
    }
    .sidebar .indent { margin-left: 20px; }
    .sidebar input[type="date"] { 
      width: 100%; 
      box-sizing: border-box; 
      padding: 8px; 
      margin: 6px 0 12px; 
      border: 1px solid #ccc; 
      border-radius: 6px;
      font-size: 0.9rem;
    }
    .header { display: flex; align-items: center; margin-bottom: 20px; }
    .header img { height: 70px; margin-right: 20px; border-radius: 50%; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .header h2 { 
      margin: 0; 
      color: var(--primary-green); 
      font-weight: 900; /* Tăng độ đậm tiêu đề chính */
      font-size: 2rem;
    }
    #kpi-summary-table { margin-top: 30px; }
    .daily-breakdown h3, #sales-daily-breakdown h3 { 
      margin-top: 40px; 
      background: #f0f0f0; 
      padding: 12px 15px; 
      border-left: 5px solid var(--primary-green-light);
      border-radius: 6px;
      font-size: 1.25rem;
      font-weight: 900;
    }

    /* --- STYLES TAB 2: BÁO CÁO THEO NGÀY (BIỂU ĐỒ) --- */
    .daily-report-layout { display: flex; gap: 25px; }
    .main-daily h2 { color: var(--primary-green); text-align: center; margin-bottom: 25px; font-weight: 900; font-size: 1.8rem; }
    .chart-toggle-controls { margin: 25px 0; padding: 15px; background: #eee; border-radius: 10px; display: flex; flex-wrap: wrap; gap: 20px; align-items: center; }
    .charts-container { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
    .chart-wrapper {
        background: #fff; padding: 20px; border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.07);
        transition: opacity 0.4s ease-in-out;
    }
    .chart-wrapper canvas { width: 100% !important; height: 450px !important; }

    /* --- CHỈ BÁO ĐANG TẢI --- */
    #loading-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255, 255, 255, 0.8);
      display: flex; justify-content: center; align-items: center;
      z-index: 9999;
      font-size: 1.5em; font-weight: bold; color: var(--primary-green);
      transition: opacity 0.3s;
      visibility: hidden; opacity: 0;
    }
    #loading-overlay.visible { visibility: visible; opacity: 1; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
</head>
<body>
  
  <div id="loading-overlay">Đang tải dữ liệu...</div>

  <div class="tab-container">
    <button class="tablinks" onclick="openTab(event, 'CostDetailedReport')" id="defaultOpen">Báo cáo chi phí</button>
    <button class="tablinks" onclick="openTab(event, 'CostDailyReport')">Báo cáo theo ngày (Biểu đồ)</button>
    <button class="tablinks" onclick="openTab(event, 'SalesDetailedReport')">Báo cáo tổng hợp</button>
  </div>

  <div id="CostDetailedReport" class="tab-content">
    <div class="report-container">
        <div class="sidebar">
          <h3>Bộ lọc Chi phí</h3> 
          <label>Từ ngày:<input type="date" id="start-date-tab1"></label> 
          <label>Đến ngày:<input type="date" id="end-date-tab1"></label>
          <h3>Sản phẩm</h3> <label><input type="checkbox" id="product-all-tab1" checked> Tất cả</label> <div id="product-options-tab1"></div>
          <h3>Ca</h3> <label><input type="checkbox" id="ca-all-tab1" checked> Tất cả</label> <div id="ca-options-tab1"></div>
          <h3>Team</h3> <label><input type="checkbox" id="team-all-tab1" checked> Tất cả</label> <div id="team-options-tab1"></div>
          <h3>Thị trường</h3> <label><input type="checkbox" id="market-all-tab1" checked> Tất cả</label> <div id="market-options-tab1"></div>
        </div>
        <div class="main-detailed">
          <div class="header"> <img src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Ff930e667.%E1%BA%A2nh.025539.jpg" alt="Logo"> <h2>DỮ LIỆU CHI PHÍ ADS</h2> </div>
          <div class="table-responsive-container">
            <table id="summary-table">
              <thead>
                <tr>
                  <th class="green-header">STT</th> <th class="green-header">Team</th> <th class="green-header">Marketing</th> <th class="green-header">Số Mess</th> <th class="green-header">CPQC</th> <th class="green-header">Số Đơn</th> <th class="green-header">DS Chốt</th>
                  <th class="yellow-header">Tỉ lệ chốt</th> <th class="yellow-header">Giá Mess</th> <th class="yellow-header">CPS</th> <th class="yellow-header">%CP/DS</th> <th class="yellow-header">Giá TB Đơn</th>
                </tr>
              </thead>
              <tbody id="summary-body"></tbody>
              <tfoot id="summary-foot"></tfoot>
            </table>
          </div>
          <div class="table-responsive-container">
            <table id="kpi-summary-table">
                <thead>
                  <tr>
                    <th class="green-header">STT</th> <th class="green-header">Team</th> <th class="green-header">Marketing</th> <th class="green-header">CPQC</th> <th class="green-header">DS Chốt</th> <th class="green-header">DS Đi</th> <th class="green-header">DS Sau Ship</th> <th class="green-header">DS Thành Công</th>
                    <th class="yellow-header">%CP/DS</th> <th class="yellow-header">% KPI</th>
                  </tr>
                </thead>
                <tbody id="kpi-summary-body"></tbody>
                <tfoot id="kpi-summary-foot"></tfoot>
            </table>
          </div>
          <div id="daily-breakdown"></div>
        </div>
    </div>
  </div>

  <div id="CostDailyReport" class="tab-content">
    <div class="main-daily">
      <h2>Báo cáo hiệu suất theo ngày</h2>
      <div class="daily-report-layout">
        <div class="sidebar">
          <h3>Bộ lọc Biểu đồ</h3>
          <label>Từ ngày:<input type="date" id="start-date-tab2"></label> 
          <label>Đến ngày:<input type="date" id="end-date-tab2"></label>
          <h3>Sản phẩm</h3> <label><input type="checkbox" id="product-all-tab2" checked> Tất cả</label> <div id="product-options-tab2"></div>
          <h3>Thị trường</h3> <label><input type="checkbox" id="market-all-tab2" checked> Tất cả</label> <div id="market-options-tab2"></div>
        </div>
        <div class="main-content">
          <div class="table-responsive-container">
            <table id="date-summary-table">
              <thead> <tr> <th>Ngày</th><th>Tổng CPQC</th><th>DS Chốt</th><th>Tỉ lệ chốt TB</th> <th>Giá Mess</th><th>CPS</th><th>%CP/DS</th> </tr> </thead>
              <tbody id="date-summary-body"></tbody>
            </table>
          </div>
          <div class="chart-toggle-controls">
              <label class="toggle-all"><input type="checkbox" id="toggle-all-charts" checked> Hiện/Ẩn tất cả</label>
              <label><input type="checkbox" class="chart-toggle" data-chart="cpqcChart" checked> CPQC</label>
              <label><input type="checkbox" class="chart-toggle" data-chart="dsChotChart" checked> DS Chốt</label>
              <label><input type="checkbox" class="chart-toggle" data-chart="rateChart" checked> Tỉ lệ chốt</label>
              <label><input type="checkbox" class="chart-toggle" data-chart="messChart" checked> Giá Mess</label>
              <label><input type="checkbox" class="chart-toggle" data-chart="cpsChart" checked> CPS</label>
              <label><input type="checkbox" class="chart-toggle" data-chart="cpDsRatioChart" checked> %CP/DS</label>
              <label><input type="checkbox" class="chart-toggle" data-chart="productSalesChart" checked> DS theo Sản phẩm</label>
              <label><input type="checkbox" class="chart-toggle" data-chart="marketSalesChart" checked> DS theo Thị trường</label>
          </div>
          <div class="charts-container">
            <div class="chart-wrapper" data-chart="cpqcChart"><canvas id="cpqcChart"></canvas></div>
            <div class="chart-wrapper" data-chart="dsChotChart"><canvas id="dsChotChart"></canvas></div>
            <div class="chart-wrapper" data-chart="rateChart"><canvas id="rateChart"></canvas></div>
            <div class="chart-wrapper" data-chart="messChart"><canvas id="messChart"></canvas></div>
            <div class="chart-wrapper" data-chart="cpsChart"><canvas id="cpsChart"></canvas></div>
            <div class="chart-wrapper" data-chart="cpDsRatioChart"><canvas id="cpDsRatioChart"></canvas></div>
            <div class="chart-wrapper" data-chart="productSalesChart"><canvas id="productSalesChart"></canvas></div>
            <div class="chart-wrapper" data-chart="marketSalesChart"><canvas id="marketSalesChart"></canvas></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="SalesDetailedReport" class="tab-content">
     <div class="report-container">
      <div class="sidebar">
        <h3>Bộ lọc Tổng hợp</h3>
        <label>Từ ngày:<input type="date" id="start-date-tab3"></label> 
        <label>Đến ngày:<input type="date" id="end-date-tab3"></label>
        <h3>Sản phẩm</h3> <label><input type="checkbox" id="product-all-tab3" checked> Tất cả</label> <div id="product-options-tab3"></div>
        <h3>Ca</h3> <label><input type="checkbox" id="ca-all-tab3" checked> Tất cả</label> <div id="ca-options-tab3"></div>
        <h3>Team</h3> <label><input type="checkbox" id="team-all-tab3" checked> Tất cả</label> <div id="team-options-tab3"></div>
        <h3>Thị trường</h3> <label><input type="checkbox" id="market-all-tab3" checked> Tất cả</label> <div id="market-options-tab3"></div>
      </div>
      <div class="main-detailed">
        <div class="header"> <img src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Ff930e667.%E1%BA%A2nh.025539.jpg" alt="Logo"> <h2 id="sales-report-title">DỮ LIỆU TỔNG HỢP</h2> </div>
        <div class="table-responsive-container">
          <table id="sales-summary-table">
            <thead>
              <tr>
                <th class="green-header">STT</th>
                <th class="green-header">Team</th>
                <th class="green-header">Sale</th>
                <th class="green-header">Số Mess</th>
                <th class="green-header">Số Đơn</th>
                <th class="green-header">Phản hồi</th>
                <th class="green-header">DS Chốt</th>
                <th class="green-header">Tỉ lệ chốt</th>
              </tr>
            </thead>
            <tbody id="sales-summary-body"></tbody>
            <tfoot id="sales-summary-foot"></tfoot>
          </table>
        </div>
        <div id="sales-daily-breakdown"></div>
      </div>
  </div>
  </div>

<script>
    // ====================================================================================================
    // --- KHAI BÁO BIẾN TOÀN CỤC & HÀM CHUNG ---
    // ====================================================================================================

    let costRawData = [], salesRawData = [], employeeData = [], charts = {};
    let isRestrictedView = false, allowedNames = [];
    
    const loader = document.getElementById('loading-overlay');
    const showLoader = () => loader.classList.add('visible');
    const hideLoader = () => loader.classList.remove('visible');
    const groupChildren = { 'Châu Á': ['Hàn Quốc','Nhật Bản','VN'], 'Ngoài Châu Á': ['Úc','US', 'Canada'] };

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById("defaultOpen").click();
      addMasterEventListeners();
      setAllDefaultDates();
      fetchCostData();
      fetchSalesData();
    });

    function openTab(evt, tabName) {
      document.querySelectorAll(".tab-content").forEach(tc => tc.style.display = "none");
      document.querySelectorAll(".tablinks").forEach(tl => tl.classList.remove("active"));
      document.getElementById(tabName).style.display = "block";
      evt.currentTarget.classList.add("active");
      if (tabName === 'CostDailyReport' && !charts.cpqcChart) { 
          initAllCharts(); 
          applyDailyCostFilters(); 
      }
    }

    function addMasterEventListeners() {
      document.body.addEventListener('change', (e) => {
        if (e.target.closest('#CostDetailedReport')) { handleCostTabFilters(e.target); }
        else if (e.target.closest('#CostDailyReport')) { handleCostChartTabFilters(e.target); }
        else if (e.target.closest('#SalesDetailedReport')) { handleSalesTabFilters(e.target); }
      });
    }

    function setAllDefaultDates() {
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        const formatDateForInput = (date) => date.toISOString().split('T')[0];
        const firstDayStr = formatDateForInput(firstDay);
        const lastDayStr = formatDateForInput(lastDay);
        
        ['start-date-tab1', 'start-date-tab2', 'start-date-tab3'].forEach(id => document.getElementById(id).value = firstDayStr);
        ['end-date-tab1', 'end-date-tab2', 'end-date-tab3'].forEach(id => document.getElementById(id).value = lastDayStr);
    }

    // --- HÀM TIỆN ÍCH CHUNG ---
    // ====================================================================================================
    // SỬA LỖI HIỂN THỊ NGÀY: Dùng getUTCDate, getUTCMonth, getUTCFullYear để đảm bảo ngày hiển thị là ngày gốc từ API
    // ====================================================================================================
    function formatDate(v) { 
      const d = new Date(v); 
      if (isNaN(d.getTime())) return v; 
      // SỬA LỖI: Luôn sử dụng phương thức UTC để lấy ngày tháng năm chính xác
      const day = String(d.getUTCDate()).padStart(2, '0');
      const month = String(d.getUTCMonth() + 1).padStart(2, '0');
      const year = d.getUTCFullYear();
      return `${day}/${month}/${year}`;
    }
    
    function formatCurrency(v) { return Number(v||0).toLocaleString('vi-VN',{style:'currency',currency:'VND'}); }
    function formatNumber(v) { return Number(v||0).toLocaleString('vi-VN'); }
    function formatPriceShort(v) { const num = Number(v || 0); if (v === null || v === undefined) return ''; if (num >= 1000000) return (num / 1000000).toFixed(1) + 'tr'; if (num >= 1000) return (num / 1000).toFixed(0) + 'k'; return num.toLocaleString('vi-VN'); }
    function formatPercent(v) { if (v === null || v === undefined || !isFinite(v)) return '0.00%'; return `${(Number(v||0) * 100).toFixed(2)}%`; }
    function getUrlParameter(name) { return new URLSearchParams(window.location.search).get(name); }
    function handleCheckbox(masterId, childClass, target) { if (target.id === masterId) { document.querySelectorAll(`.${childClass}`).forEach(cb => cb.checked = target.checked); } else if (target.classList.contains(childClass)) { document.getElementById(masterId).checked = [...document.querySelectorAll(`.${childClass}`)].every(cb => cb.checked); } }
    
    // HÀM MỚI: Chuyển đổi ngày tháng có 'Z' thành chuỗi YYYY-MM-DD để so sánh chính xác
    function getUTCDateString(dateValue) {
        if (!dateValue) return null;
        const d = new Date(dateValue);
        if (isNaN(d.getTime())) return null; 
        const year = d.getUTCFullYear();
        const month = String(d.getUTCMonth() + 1).padStart(2, '0');
        const day = String(d.getUTCDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // ====================================================================================================
    // --- LOGIC CHO BÁO CÁO CHI PHÍ (TAB 1 & 2) ---
    // ====================================================================================================
    function fetchCostData() {
        showLoader();
        fetch('https://script.google.com/macros/s/AKfycbwGwSBxeXplEzAM-jJDPaXPkiWjNyKmpR70o6nCY5_ynqoF-3WA1gvF91RIQQfDZ9fvAQ/exec')
        .then(res => res.json())
        .then(data => {
          costRawData = data.map(r => ({ ...r, team: r.team || 'Khác', ten: r.ten || 'N/A', dsChot: +r.dsChot || 0, cpqc: +r.cpqc || 0, soDon: +r.soDon || 0, soMessCmt: +r.soMessCmt || 0, doanhsoTC: +r.doanhsoTC || 0, tienShip: +r.tienShip || 0, doanhSo: +r.doanhSo || 0, doanhSoSauShip: +r.doanhSoSauShip || 0, kpis: +r.kpis || 0 }));
          populateCostFilters(costRawData);
          applyCostTabFilters();
          if (document.getElementById('CostDailyReport').style.display === 'block') { applyDailyCostFilters(); }
        }).catch(err => { 
          console.error("Lỗi khi tải dữ liệu chi phí:", err); 
          alert('Không thể tải dữ liệu Chi phí. Vui lòng kiểm tra lại đường link hoặc kết nối mạng.'); 
        }).finally(() => { hideLoader(); });
    }

    function populateCostFilters(data) {
        const prodSet=new Set(), caSet=new Set(), teamSet=new Set(), mktSet=new Set();
        data.forEach(r=>{ if(r.sanPham) prodSet.add(r.sanPham); if(r.ca) caSet.add(r.ca); if(r.team) teamSet.add(r.team); if(r.thiTruong) mktSet.add(r.thiTruong); });
        const productHtml = Array.from(prodSet).sort().map(p => `<label class='indent'><input type='checkbox' class='filter-product-tab1' value='${p}' checked> ${p}</label>`).join('');
        document.getElementById('product-options-tab1').innerHTML = productHtml;
        document.getElementById('product-options-tab2').innerHTML = productHtml.replaceAll('filter-product-tab1', 'filter-product-tab2');
        const normalize = (s) => (s||'').trim().toLowerCase();
        const marketHtml = Object.keys(groupChildren).map(grp => `<label><input type='checkbox' class='filter-market-tab1' value='${grp}' checked> ${grp}</label>` + groupChildren[grp].map(ch => `<label class='indent'><input type='checkbox' class='filter-market-tab1' value='${ch}' checked> ${ch}</label>`).join('')).join('');
        const otherMarkets = Array.from(mktSet).filter(m => !Object.values(groupChildren).flat().map(c => c.toLowerCase()).includes(m.toLowerCase())).sort().map(m => `<label><input type='checkbox' class='filter-market-tab1' value='${m}' checked> ${m}</label>`).join('');
        document.getElementById('market-options-tab1').innerHTML = marketHtml + otherMarkets;
        document.getElementById('market-options-tab2').innerHTML = (marketHtml + otherMarkets).replaceAll('filter-market-tab1', 'filter-market-tab2');
        document.getElementById('ca-options-tab1').innerHTML = Array.from(caSet).sort().map(c => `<label class='indent'><input type='checkbox' class='filter-ca-tab1' value='${c}' checked> ${c}</label>`).join('');
        document.getElementById('team-options-tab1').innerHTML = Array.from(teamSet).sort().map(t => `<label class='indent'><input type='checkbox' class='filter-team-tab1' value='${t}' checked> ${t}</label>`).join('');
    }

    function getFilteredCostData(filterIds) {
        const { startDateId, endDateId, productCbId, productOptionsClass, marketCbId, marketOptionsClass, caCbId, caOptionsClass, teamCbId, teamOptionsClass } = filterIds;
        const startDateValue = document.getElementById(startDateId).value, endDateValue = document.getElementById(endDateId).value;
        const pAll = document.getElementById(productCbId).checked, selP = pAll ? null : [...document.querySelectorAll(`.${productOptionsClass}:checked`)].map(cb => cb.value);
        const mAll = document.getElementById(marketCbId).checked, selM = mAll ? null : [...document.querySelectorAll(`.${marketOptionsClass}:checked`)].map(cb => cb.value);
        const cAll = caCbId ? document.getElementById(caCbId).checked : true, selCa = caCbId && !cAll ? [...document.querySelectorAll(`.${caOptionsClass}:checked`)].map(cb => cb.value) : null;
        const tAll = teamCbId ? document.getElementById(teamCbId).checked : true, selT = tAll ? null : [...document.querySelectorAll(`.${teamOptionsClass}:checked`)].map(cb => cb.value) : null;
        const normalize = (s) => (s||'').trim().toLowerCase(), capitalize = (s) => s.charAt(0).toUpperCase()+s.slice(1);
        const getGroup = (norm) => { for (let g in groupChildren) { if (groupChildren[g].map(normalize).includes(norm)) return g; } return capitalize(norm); };

        return costRawData.filter(r => {
            // SỬA LỖI: Chuyển đổi ngày của dữ liệu sang YYYY-MM-DD để so sánh chuỗi
            const dataDateStr = getUTCDateString(r.ngay);
            if (!dataDateStr) return false; // Bỏ qua nếu ngày không hợp lệ

            // So sánh chuỗi YYYY-MM-DD, đảm bảo chính xác
            const isDateOk = (!startDateValue || dataDateStr >= startDateValue) && (!endDateValue || dataDateStr <= endDateValue);
            
            const isProductOk = !selP || selP.includes(r.sanPham), marketGroup = getGroup(normalize(r.thiTruong));
            const isMarketOk = !selM || selM.includes(marketGroup) || selM.includes(r.thiTruong);
            const isCaOk = !selCa || selCa.includes(r.ca), isTeamOk = !selT || selT.includes(r.team);
            return isDateOk && isProductOk && isMarketOk && isCaOk && isTeamOk;
        });
    }

    function handleCostTabFilters(target) { showLoader(); setTimeout(() => { handleCheckbox('product-all-tab1', 'filter-product-tab1', target); handleCheckbox('ca-all-tab1', 'filter-ca-tab1', target); handleCheckbox('team-all-tab1', 'filter-team-tab1', target); handleCheckbox('market-all-tab1', 'filter-market-tab1', target); applyCostTabFilters(); hideLoader(); }, 10); }
    function applyCostTabFilters() {
        const filterIds = { startDateId: 'start-date-tab1', endDateId: 'end-date-tab1', productCbId: 'product-all-tab1', productOptionsClass: 'filter-product-tab1', marketCbId: 'market-all-tab1', marketOptionsClass: 'filter-market-tab1', caCbId: 'ca-all-tab1', caOptionsClass: 'filter-ca-tab1', teamCbId: 'team-all-tab1', teamOptionsClass: 'filter-team-tab1' };
        const filtered = getFilteredCostData(filterIds);
        const selectedMarkets = [...document.querySelectorAll('.filter-market-tab1:checked')].map(cb => cb.value);
        renderCostSummary(filtered, selectedMarkets); renderKpiSummary(filtered); renderCostDailyBreakdown(filtered);
    }
    
    function renderCostSummary(data, selectedMarkets) {
        const getCpsCellStyle = (cps, markets) => { const hasChauA = markets.some(m => m === 'Châu Á' || groupChildren['Châu Á'].includes(m)); const hasNgoaiChauA = markets.some(m => m === 'Ngoài Châu Á' || groupChildren['Ngoài Châu Á'].includes(m)); const isChauAOnly = hasChauA && !hasNgoaiChauA && markets.length > 0; if (isChauAOnly) { if (cps > 1000000) return 'bg-lightred'; if (cps > 700000) return 'bg-yellow'; } else { if (cps > 1500000) return 'bg-lightred'; if (cps > 1000000) return 'bg-yellow'; } return ''; };
        const summaryData = {}; data.forEach(r => { const name = r.ten; if (!summaryData[name]) summaryData[name] = { team: r.team, mess: 0, don: 0, chot: 0, cpqc: 0 }; summaryData[name].mess += r.soMessCmt; summaryData[name].don += r.soDon; summaryData[name].chot += r.dsChot; summaryData[name].cpqc += r.cpqc; });
        const flatList = Object.keys(summaryData).map(name => ({ name, team: summaryData[name].team, data: summaryData[name] })).sort((a,b) => a.team.localeCompare(b.team) || a.name.localeCompare(b.name));
        let total = { mess: 0, don: 0, chot: 0, cpqc: 0 };
        document.getElementById('summary-body').innerHTML = flatList.map((item, index) => {
            const s = item.data; total.mess += s.mess; total.don += s.don; total.chot += s.chot; total.cpqc += s.cpqc;
            const rate = s.mess ? s.don / s.mess : 0, pm = s.mess ? s.cpqc / s.mess : 0, pd = s.don ? s.cpqc / s.don : 0, pc = s.chot ? s.cpqc / s.chot : 0, pdt = s.don ? s.chot / s.don : 0;
            return `<tr><td class="text-center">${index + 1}</td><td class="text-left">${item.team}</td><td class="text-left">${item.name}</td><td>${formatNumber(s.mess)}</td><td>${formatCurrency(s.cpqc)}</td><td>${formatNumber(s.don)}</td><td>${formatCurrency(s.chot)}</td><td class="${rate > 0.1 ? 'bg-green' : 'bg-yellow'}">${formatPercent(rate)}</td><td>${formatCurrency(pm)}</td><td class="${getCpsCellStyle(pd, selectedMarkets)}">${formatCurrency(pd)}</td><td class="${pc > 0.33 ? 'bg-yellow' : ''}">${formatPercent(pc)}</td><td>${formatCurrency(pdt)}</td></tr>`;
        }).join('');
        const totalRate = total.mess ? total.don / total.mess : 0, totalPm = total.mess ? total.cpqc / total.mess : 0, totalPd = total.don ? total.cpqc / total.don : 0, totalPc = total.chot ? total.cpqc / total.chot : 0, totalPdt = total.don ? total.chot / total.don : 0;
        document.getElementById('summary-foot').innerHTML = `<tr class="total-row"><td class="total-label" colspan="3">TỔNG CỘNG</td><td class="total-value">${formatNumber(total.mess)}</td><td class="total-value">${formatCurrency(total.cpqc)}</td><td class="total-value">${formatNumber(total.don)}</td><td class="total-value">${formatCurrency(total.chot)}</td><td class="total-value">${formatPercent(totalRate)}</td><td class="total-value">${formatCurrency(totalPm)}</td><td class="total-value">${formatCurrency(totalPd)}</td><td class="total-value">${formatPercent(totalPc)}</td><td class="total-value">${formatCurrency(totalPdt)}</td></tr>`;
    }

    function renderKpiSummary(data) { 
        const summaryByMkt = {}; data.forEach(r => { const mktName = r.ten; if (!summaryByMkt[mktName]) summaryByMkt[mktName] = { cpqc: 0, dsChot: 0, dsDi: 0, dsSauShip: 0, dsThanhCong: 0, kpiValue: r.kpis, team: r.team }; summaryByMkt[mktName].cpqc += r.cpqc; summaryByMkt[mktName].dsChot += r.dsChot; summaryByMkt[mktName].dsDi += r.doanhSo; summaryByMkt[mktName].dsSauShip += r.doanhSoSauShip; summaryByMkt[mktName].dsThanhCong += r.doanhsoTC; });
        const sortedMktKeys = Object.keys(summaryByMkt).sort((a, b) => (summaryByMkt[a].team || 'zzz').localeCompare(summaryByMkt[b].team || 'zzz') || a.localeCompare(b));
        let total = { cpqc: 0, dsChot: 0, dsDi: 0, dsSauShip: 0, dsThanhCong: 0, kpis: 0 };
        document.getElementById('kpi-summary-body').innerHTML = sortedMktKeys.map((mkt, i) => { 
            const s = summaryByMkt[mkt]; total.cpqc += s.cpqc; total.dsChot += s.dsChot; total.dsDi += s.dsDi; total.dsSauShip += s.dsSauShip; total.dsThanhCong += s.dsThanhCong; total.kpis += s.kpiValue;
            const cp_ds = s.dsSauShip ? s.cpqc / s.dsSauShip : 0; const kpiPercentage = s.kpiValue ? s.dsSauShip / s.kpiValue : 0; 
            return `<tr><td class="text-center">${i+1}</td><td class="text-left">${s.team}</td><td class="text-left">${mkt}</td><td>${formatCurrency(s.cpqc)}</td><td>${formatCurrency(s.dsChot)}</td><td>${formatCurrency(s.dsDi)}</td><td>${formatCurrency(s.dsSauShip)}</td><td>${formatCurrency(s.dsThanhCong)}</td><td class="${cp_ds > 0.33 ? 'bg-yellow' : ''}">${formatPercent(cp_ds)}</td><td>${formatPercent(kpiPercentage)}</td></tr>`;
        }).join(''); 
        const totalCpds = total.dsSauShip ? total.cpqc / total.dsSauShip : 0; const totalKpiPercentage = total.kpis ? total.dsSauShip / total.kpis : 0;
        document.getElementById('kpi-summary-foot').innerHTML = `<tr class="total-row"><td class="total-label" colspan="3">TỔNG CỘNG</td><td class="total-value">${formatCurrency(total.cpqc)}</td><td class="total-value">${formatCurrency(total.dsChot)}</td><td class="total-value">${formatCurrency(total.dsDi)}</td><td class="total-value">${formatCurrency(total.dsSauShip)}</td><td class="total-value">${formatCurrency(total.dsThanhCong)}</td><td class="total-value">${formatPercent(totalCpds)}</td><td class="total-value">${formatPercent(totalKpiPercentage)}</td></tr>`;
    }
    
    function renderCostDailyBreakdown(data) { 
        const c=document.getElementById('daily-breakdown'); c.innerHTML=''; const grpObj={}; data.forEach(r=>{const d=formatDate(r.ngay);(grpObj[d]||(grpObj[d]=[])).push(r);});
        Object.keys(grpObj).sort((a,b)=>new Date(b.split('/').reverse().join('-'))-new Date(a.split('/').reverse().join('-'))).forEach(date=>{
            let m=0,d=0,ch=0,pc=0;
            const rowsHtml = grpObj[date].sort((a, b) => (a.team || 'zzz').localeCompare(b.team || 'zzz')).map(r=>{ m+=r.soMessCmt;d+=r.soDon;ch+=r.dsChot;pc+=r.cpqc; return`<tr><td class="text-center">${r.id}</td><td class="text-left">${r.ten}</td><td class="text-left">${r.ca}</td><td class="text-left">${r.page}</td><td class="text-left">${r.sanPham}</td><td class="text-left">${r.thiTruong}</td><td>${formatNumber(r.soMessCmt)}</td><td>${formatNumber(r.soDon)}</td><td>${formatCurrency(r.dsChot)}</td><td>${formatCurrency(r.cpqc)}</td><td class="text-left">${r.team}</td></tr>`}).join('');
            c.innerHTML+=`<h3>${date}</h3><div class="table-responsive-container"><table><thead><tr><th>ID</th><th>Tên</th><th>Ca</th><th>Page</th><th>Sản phẩm</th><th>Thị trường</th><th>Mess</th><th>Đơn</th><th>DS Chốt</th><th>CPQC</th><th>Team</th></tr></thead><tbody>${rowsHtml}</tbody><tfoot><tr class='total-row'><td colspan='6' class='total-label'>Tổng</td><td class='total-value'>${formatNumber(m)}</td><td class='total-value'>${formatNumber(d)}</td><td class='total-value'>${formatCurrency(ch)}</td><td class='total-value'>${formatCurrency(pc)}</td><td></td></tr></tfoot></table></div>`;
        }); 
    }

    function handleCostChartTabFilters(target) { showLoader(); setTimeout(() => { if (target.id === 'toggle-all-charts' || target.classList.contains('chart-toggle')) { if (target.id === 'toggle-all-charts') document.querySelectorAll('.chart-toggle').forEach(cb => cb.checked = target.checked); else document.getElementById('toggle-all-charts').checked = [...document.querySelectorAll('.chart-toggle')].every(cb => cb.checked); toggleChartVisibility(); hideLoader(); return; } handleCheckbox('product-all-tab2', 'filter-product-tab2', target); handleCheckbox('market-all-tab2', 'filter-market-tab2', target); applyDailyCostFilters(); hideLoader(); }, 10); }
    function applyDailyCostFilters() { if (!costRawData.length) return; const filterIds = { startDateId: 'start-date-tab2', endDateId: 'end-date-tab2', productCbId: 'product-all-tab2', productOptionsClass: 'filter-product-tab2', marketCbId: 'market-all-tab2', marketOptionsClass: 'filter-market-tab2' }; const filtered = getFilteredCostData(filterIds); renderDailyCostTable(filtered); renderAllDailyCharts(filtered); }
    function renderDailyCostTable(data) { const daily = {}; data.forEach(r => { const dateKey = formatDate(r.ngay); if (!daily[dateKey]) daily[dateKey] = { cpqc: 0, don: 0, mess: 0, chot: 0 }; daily[dateKey].cpqc += r.cpqc; daily[dateKey].don += r.soDon; daily[dateKey].mess += r.soMessCmt; daily[dateKey].chot += r.dsChot; }); document.getElementById('date-summary-body').innerHTML = Object.keys(daily).sort((a,b) => new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-'))).map(d => { const day = daily[d]; const avg = day.mess ? day.don / day.mess : 0; const giaMess = day.mess ? day.cpqc / day.mess : 0; const cps = day.don ? day.cpqc / day.don : 0; const cpqcRatio = day.chot ? day.cpqc / day.chot : 0; return `<tr><td class="text-left"><b>${d}</b></td><td>${formatPriceShort(day.cpqc)}</td><td>${formatPriceShort(day.chot)}</td><td>${formatPercent(avg)}</td><td>${formatPriceShort(giaMess)}</td><td>${formatPriceShort(cps)}</td><td>${formatPercent(cpqcRatio)}</td></tr>`; }).join(''); }
    function toggleChartVisibility() { document.querySelectorAll('.chart-toggle').forEach(checkbox => { const chartName = checkbox.dataset.chart; const wrapper = document.querySelector(`.chart-wrapper[data-chart="${chartName}"]`); if (wrapper) { wrapper.style.display = checkbox.checked ? 'block' : 'none'; wrapper.style.opacity = checkbox.checked ? '0' : '1'; setTimeout(() => { wrapper.style.opacity = checkbox.checked ? '1' : '0'; }, 10); } }); }
    function initAllCharts() { const createChart = (ctxId, config) => new Chart(document.getElementById(ctxId).getContext('2d'), config); charts.cpqcChart = createChart('cpqcChart', getLineChartConfig('CPQC (VND)')); charts.dsChotChart = createChart('dsChotChart', getLineChartConfig('DS Chốt (VND)')); charts.rateChart = createChart('rateChart', getLineChartConfig('Tỉ lệ chốt (%)', v => formatPercent(v))); charts.messChart = createChart('messChart', getLineChartConfig('Giá Mess (VND)')); charts.cpsChart = createChart('cpsChart', getLineChartConfig('CPS (VND)')); charts.cpDsRatioChart = createChart('cpDsRatioChart', getLineChartConfig('%CP/DS', v => formatPercent(v))); charts.productSalesChart = createChart('productSalesChart', getBarChartConfig()); charts.marketSalesChart = createChart('marketSalesChart', getBarChartConfig()); toggleChartVisibility(); }
    function renderAllDailyCharts(data) { if (!Object.keys(charts).length) return; const daily = {}; data.forEach(r => { const dateKey = formatDate(r.ngay); if (!daily[dateKey]) daily[dateKey] = { cpqc: 0, don: 0, mess: 0, chot: 0 }; daily[dateKey].cpqc += r.cpqc; daily[dateKey].don += r.soDon; daily[dateKey].mess += r.soMessCmt; daily[dateKey].chot += r.dsChot; }); const labels = Object.keys(daily).sort((a,b) => new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-'))); updateChart(charts.cpqcChart, 'CPQC', labels, labels.map(d => daily[d].cpqc), getChartColors().cpqc); updateChart(charts.dsChotChart, 'DS Chốt', labels, labels.map(d => daily[d].chot), getChartColors().dsChot); updateChart(charts.rateChart, 'Tỉ lệ chốt', labels, labels.map(d => daily[d].mess ? (daily[d].don / daily[d].mess) : 0), getChartColors().rate); updateChart(charts.messChart, 'Giá Mess', labels, labels.map(d => daily[d].mess ? (daily[d].cpqc / daily[d].mess) : 0), getChartColors().mess); updateChart(charts.cpsChart, 'CPS', labels, labels.map(d => daily[d].don ? (daily[d].cpqc / daily[d].don) : 0), getChartColors().cps); updateChart(charts.cpDsRatioChart, '%CP/DS', labels, labels.map(d => daily[d].chot ? (daily[d].cpqc / daily[d].chot) : 0), getChartColors().cpDsRatio); const productSales = {}, marketSales = {}; data.forEach(r => { if (r.sanPham) productSales[r.sanPham] = (productSales[r.sanPham] || 0) + r.dsChot; if (r.thiTruong) marketSales[r.thiTruong] = (marketSales[r.thiTruong] || 0) + r.dsChot; }); const sortedProducts = Object.entries(productSales).sort((a,b) => b[1] - a[1]); const sortedMarkets = Object.entries(marketSales).sort((a,b) => b[1] - a[1]); updateChart(charts.productSalesChart, 'DS theo SP', sortedProducts.map(p=>p[0]), sortedProducts.map(p=>p[1]), getChartColors().product, 'bar'); updateChart(charts.marketSalesChart, 'DS theo TT', sortedMarkets.map(m=>m[0]), sortedMarkets.map(m=>m[1]), getChartColors().market, 'bar'); }
    function getChartColors() { return { cpqc: { border: '#3F51B5', fill: 'rgba(63, 81, 181, 0.2)' }, dsChot: { border: '#4CAF50', fill: 'rgba(76, 175, 80, 0.2)' }, rate: { border: '#F44336', fill: 'rgba(244, 67, 54, 0.2)' }, mess: { border: '#FF9800', fill: 'rgba(255, 152, 0, 0.2)' }, cps: { border: '#009688', fill: 'rgba(0, 150, 136, 0.2)' }, cpDsRatio: { border: '#9C27B0', fill: 'rgba(156, 39, 176, 0.2)' }, product: { border: '#607D8B', fill: '#607D8B' }, market: { border: '#795548', fill: '#795548' } }; }
    function getLineChartConfig(yTitle, formatter = v => formatPriceShort(v)) { return { type: 'line', options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { font: { size: 14, weight: '500' }, padding: 20, usePointStyle: true, pointStyle: 'circle' } }, tooltip: { backgroundColor: 'rgba(0,0,0,0.9)', titleFont: { size: 16, weight: 'bold' }, bodyFont: { size: 14 }, padding: 12, cornerRadius: 8, displayColors: true, boxPadding: 6, callbacks: { label: (ctx) => `${ctx.dataset.label}: ${formatter(ctx.raw)}` } }, datalabels: { display: true, align: 'top', anchor: 'end', backgroundColor: (ctx) => ctx.dataset.borderColor, borderColor: '#fff', borderWidth: 1, borderRadius: 12, color: '#fff', font: { weight: 'bold', size: 10 }, formatter: formatter, padding: 6, offset: 4 } }, interaction: { intersect: false, mode: 'index' }, scales: { x: { grid: { display: false, drawBorder: false }, ticks: { font: { size: 12 }, maxRotation: 45, minRotation: 45 } }, y: { title: { display: true, text: yTitle, font: { size: 14, weight: '500' }, padding: {top: 10, bottom: 20} }, ticks: { callback: formatter, font: { size: 12 } }, grid: { color: 'rgba(0,0,0,0.05)', drawBorder: false } } }, elements: { line: { borderWidth: 3, tension: 0.3 }, point: { radius: 5, hoverRadius: 8, hitRadius: 10, backgroundColor: '#fff' } }, layout: { padding: 20 } } }; }
    function getBarChartConfig() { return { type: 'bar', options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false }, tooltip: { backgroundColor: 'rgba(0,0,0,0.9)', titleFont: { size: 16, weight: 'bold' }, bodyFont: { size: 14 }, padding: 12, cornerRadius: 8, displayColors: false, callbacks: { label: (ctx) => `${ctx.parsed.x.toLocaleString()} VND` } }, datalabels: { display: true, anchor: 'end', align: 'right', offset: 8, color: '#333', font: { weight: '600', size: 12 }, formatter: v => formatPriceShort(v) } }, scales: { x: { display: false, grid: { display: false } }, y: { grid: { display: false }, ticks: { font: { size: 13, weight: 'bold' } } } }, layout: { padding: { left: 120, right: 50, top: 20, bottom: 20 } }, barPercentage: 0.8, categoryPercentage: 0.9 } }; }
    function updateChart(chart, label, labels, data, colors, type = 'line') { chart.data.labels = labels; chart.data.datasets = [{ label, data, backgroundColor: type === 'line' ? colors.fill : colors.border, borderColor: colors.border, type, fill: type === 'line', tension: 0.4, borderWidth: type === 'line' ? 3 : 1, pointRadius: type === 'line' ? 5 : undefined, pointBackgroundColor: '#fff', pointBorderWidth: 2, borderRadius: type === 'line' ? 0 : 4 }]; chart.update('none'); }

    // ====================================================================================================
    // --- LOGIC CHO BÁO CÁO TỔNG HỢP (TAB 3) ---
    // ====================================================================================================
    function fetchSalesData() {
        showLoader();
        const salesDataUrl = 'https://script.google.com/macros/s/AKfycbzd8KdWC7PVuv7ttnQLV7oIxmAgWWdLfs3laMDoL7w5GhvCWd_71_Xc33e-GaUSiG_3/exec';
        const employeeDataUrl = 'https://script.google.com/macros/s/AKfycbzwOv7UFwrqzf88QJL1QrxLKcnnnSIQ_PSmF0SO8LboqWI5li3vF3W8_-8s-A8lNGaR/exec';

        Promise.all([ fetch(salesDataUrl).then(res => res.json()), fetch(employeeDataUrl).then(res => res.json()) ])
        .then(([salesResult, employeeResult]) => {
            salesRawData = salesResult.filter(r => r.trangThai && String(r.trangThai).trim() !== '' && r.ten && String(r.ten).trim() !== '' && r.team && String(r.team).trim() !== '')
                .map(r => ({ ...r, ten: (r.ten || '').trim(), team: (r.team || '').trim(), soMessCmt: +r.soMess || 0, soDon: +r.donMess || 0, dsChot: +r.doanhSoMess || 0, phanHoi: +r.phanHoi || 0, }));
            employeeData = employeeResult;
            
            const idFromUrl = getUrlParameter('id');
            let restrictedTeamName = null;
            if (idFromUrl) {
                const currentUser = employeeData.find(emp => emp.idnv === idFromUrl);
                if (currentUser) {
                    isRestrictedView = true; 
                    if (currentUser.vi_tri === "Leader") {
                        restrictedTeamName = currentUser.team;
                        document.getElementById('sales-report-title').textContent = `DỮ LIỆU TEAM ${restrictedTeamName}`;
                        allowedNames = employeeData.filter(emp => emp.team === restrictedTeamName).map(emp => (emp.ho_va_ten || '').trim());
                    } else {
                        const cleanName = (currentUser.ho_va_ten || '').trim();
                        document.getElementById('sales-report-title').textContent = `DỮ LIỆU CÁ NHÂN - ${cleanName}`;
                        allowedNames = [cleanName];
                    }
                } else { isRestrictedView = true; allowedNames = []; alert(`ID "${idFromUrl}" không hợp lệ.`); }
            } else { isRestrictedView = false; allowedNames = []; document.getElementById('sales-report-title').textContent = 'DỮ LIỆU TỔNG HỢP'; }
            
            const dataForFilters = isRestrictedView ? salesRawData.filter(r => allowedNames.includes(r.ten)) : salesRawData;
            populateSalesFilters(dataForFilters, restrictedTeamName); 
            applySalesTabFilters();

        }).catch(err => { 
            console.error("Lỗi khi tải dữ liệu Sales:", err); 
            alert('Không thể tải dữ liệu Sales.'); 
        }).finally(() => { hideLoader(); });
    }

    function populateSalesFilters(data, restrictedTeamName = null) {
        const populate = (key, containerId, className) => {
            const container = document.getElementById(containerId);
            let uniqueValues = (key === 'team' && restrictedTeamName) ? [restrictedTeamName] : [...new Set(data.map(r => r[key]).filter(val => val != null && val !== ''))].sort();
            container.innerHTML = uniqueValues.map(val => `<label class='indent'><input type='checkbox' class='${className}' value='${val}' checked> ${val}</label>`).join('');
        };
        populate('sanPham', 'product-options-tab3', 'filter-product-tab3');
        populate('thiTruong', 'market-options-tab3', 'filter-market-tab3');
        populate('ca', 'ca-options-tab3', 'filter-ca-tab3');
        populate('team', 'team-options-tab3', 'filter-team-tab3');
    }
    
    function getFilteredSalesData() {
        const sdVal = document.getElementById('start-date-tab3').value, edVal = document.getElementById('end-date-tab3').value;
        const getSelectedOptions = (masterId, childClass) => document.getElementById(masterId).checked ? null : [...document.querySelectorAll(`.${childClass}:checked`)].map(cb => cb.value);
        const selP = getSelectedOptions('product-all-tab3', 'filter-product-tab3'), selM = getSelectedOptions('market-all-tab3', 'filter-market-tab3');
        const selCa = getSelectedOptions('ca-all-tab3', 'filter-ca-tab3'), selT = getSelectedOptions('team-all-tab3', 'filter-team-tab3');

        return salesRawData.filter(r => {
            if (isRestrictedView && !allowedNames.includes(r.ten)) { return false; }
            
            // SỬA LỖI: Chuyển đổi ngày của dữ liệu sang YYYY-MM-DD để so sánh chuỗi
            const dataDateStr = getUTCDateString(r.ngay);
            if (!dataDateStr) return false; // Bỏ qua nếu ngày không hợp lệ

            // So sánh chuỗi YYYY-MM-DD, đảm bảo chính xác
            const isDateOk = (!sdVal || dataDateStr >= sdVal) && (!edVal || dataDateStr <= edVal);

            const isProductOk = !selP || selP.includes(r.sanPham), isMarketOk = !selM || selM.includes(r.thiTruong);
            const isCaOk = !selCa || selCa.includes(String(r.ca)), isTeamOk = !selT || selT.includes(String(r.team));
            return isDateOk && isProductOk && isMarketOk && isCaOk && isTeamOk;
        });
    }

    function handleSalesTabFilters(target) { 
        showLoader(); 
        setTimeout(() => { 
            handleCheckbox('product-all-tab3', 'filter-product-tab3', target); 
            handleCheckbox('ca-all-tab3', 'filter-ca-tab3', target); 
            handleCheckbox('team-all-tab3', 'filter-team-tab3', target); 
            handleCheckbox('market-all-tab3', 'filter-market-tab3', target); 
            applySalesTabFilters(); 
            hideLoader(); 
        }, 10); 
    }
    
    function applySalesTabFilters() {
        const filtered = getFilteredSalesData();
        renderSalesSummary(filtered); 
        renderSalesDailyBreakdown(filtered);
    }

    function renderSalesSummary(data) {
        const summaryData = {};
        data.forEach(r => {
            const name = r.ten;
            if (!summaryData[name]) summaryData[name] = { team: r.team, mess: 0, don: 0, chot: 0, phanHoi: 0 };
            summaryData[name].mess += r.soMessCmt; summaryData[name].don += r.soDon;
            summaryData[name].chot += r.dsChot; summaryData[name].phanHoi += r.phanHoi;
        });
        const flatList = Object.keys(summaryData).map(name => ({ name, team: summaryData[name].team, data: summaryData[name] })).sort((a,b) => (a.team || 'zzz').localeCompare(b.team || 'zzz') || a.name.localeCompare(b.name));
        document.getElementById('sales-summary-body').innerHTML = flatList.map((item, index) => {
            const s = item.data, rate = s.mess ? s.don / s.mess : 0;
            return `<tr><td class="text-center">${index + 1}</td><td class="text-left">${item.team}</td><td class="text-left">${item.name}</td><td>${formatNumber(s.mess)}</td><td>${formatNumber(s.don)}</td><td>${formatNumber(s.phanHoi)}</td><td>${formatCurrency(s.chot)}</td><td class="${rate >= 0.1 ? 'bg-green' : (rate > 0 ? 'bg-yellow' : '')}">${formatPercent(rate)}</td></tr>`;
        }).join('');
        const total = flatList.reduce((acc, item) => { acc.mess += item.data.mess; acc.don += item.data.don; acc.chot += item.data.chot; acc.phanHoi += item.data.phanHoi; return acc; }, { mess: 0, don: 0, chot: 0, phanHoi: 0 });
        const totalRate = total.mess ? total.don / total.mess : 0;
        document.getElementById('sales-summary-foot').innerHTML = `<tr class="total-row"><td class="total-label" colspan="3">TỔNG CỘNG</td><td class="total-value">${formatNumber(total.mess)}</td><td class="total-value">${formatNumber(total.don)}</td><td class="total-value">${formatNumber(total.phanHoi)}</td><td class="total-value">${formatCurrency(total.chot)}</td><td class="total-value">${formatPercent(totalRate)}</td></tr>`;
    }
    
    function renderSalesDailyBreakdown(data) { 
        const container = document.getElementById('sales-daily-breakdown'); container.innerHTML = '';
        if (data.length === 0) { container.innerHTML = '<h3 style="text-align: center; color: #777; margin-top: 40px;">Không có dữ liệu chi tiết để hiển thị.</h3>'; return; }
        const groupedByDate = {};
        data.forEach(r => { const dateKey = formatDate(r.ngay); (groupedByDate[dateKey]||(groupedByDate[dateKey]=[])).push(r); });
        Object.keys(groupedByDate).sort((a,b)=>new Date(b.split('/').reverse().join('-'))-new Date(a.split('/').reverse().join('-'))).forEach(date => {
            let total = { mess: 0, don: 0, chot: 0, phanHoi: 0 };
            const rowsHtml = groupedByDate[date].sort((a, b) => (a.team || 'zzz').localeCompare(b.team || 'zzz') || a.ten.localeCompare(b.ten)).map(r=>{
                total.mess += r.soMessCmt; total.don += r.soDon; total.chot += r.dsChot; total.phanHoi += r.phanHoi;
                return`<tr><td class="text-left">${r.ten}</td><td class="text-left">${r.ca}</td><td class="text-left">${r.sanPham}</td><td class="text-left">${r.thiTruong}</td><td>${formatNumber(r.soMessCmt)}</td><td>${formatNumber(r.soDon)}</td><td>${formatNumber(r.phanHoi)}</td><td>${formatCurrency(r.dsChot)}</td><td class="text-left">${r.team}</td></tr>`
            }).join('');
            container.innerHTML += `<h3>${date}</h3><div class="table-responsive-container"><table><thead><tr><th class="green-header">Tên</th><th class="green-header">Ca</th><th class="green-header">Sản phẩm</th><th class="green-header">Thị trường</th><th class="green-header">Mess</th><th class="green-header">Đơn</th><th class="green-header">Phản hồi</th><th class="green-header">DS Chốt</th><th class="green-header">Team</th></tr></thead><tbody>${rowsHtml}</tbody><tfoot><tr class='total-row'><td colspan='4' class='total-label'>Tổng</td><td class='total-value'>${formatNumber(total.mess)}</td><td class='total-value'>${formatNumber(total.don)}</td><td class='total-value'>${formatNumber(total.phanHoi)}</td><td class='total-value'>${formatCurrency(total.chot)}</td><td></td></tr></tfoot></table></div>`;
        }); 
    }
</script>
</body>
</html>

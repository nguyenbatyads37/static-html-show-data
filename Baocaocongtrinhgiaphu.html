<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nhật ký Thi công</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@400;500;700&family=Merriweather:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">

    <style>
        /* --- General & Theme Styles --- */
        :root {
            --bg-color: #6d5f50;
            --page-bg-color: #fdfaf4;
            --text-color: #3d352e;
            --primary-color: #8a6f4d;
            --primary-text-color: #ffffff;
            --border-color: #dcd1c3;
            --placeholder-color: #999;
            --input-text-color: #2c2620;
        }

        body {
            font-family: 'Merriweather', 'Times New Roman', Times, serif;
            font-size: 14px;
            line-height: 1.6;
            margin: 0;
            background-color: var(--bg-color);
            background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 15px 15px;
            color: var(--text-color);
        }

        .container {
            width: 210mm;
            min-height: 297mm;
            margin: 30px auto;
            padding: 20mm;
            box-sizing: border-box;
            background-color: var(--page-bg-color);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .content-wrapper {
            position: relative;
            z-index: 1;
        }

        .watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 0;
            opacity: 0.08;
            pointer-events: none;
            width: 70%;
            max-width: 500px;
        }

        h2, h3 {
            font-family: 'Roboto Slab', serif;
            text-align: center;
            font-weight: bold;
            margin: 5px 0;
            color: #4a3f35;
        }

        h2 { font-size: 20px; text-transform: uppercase; }
        h3 { font-size: 16px; font-weight: 400; }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 15px;
        }

        .logo { width: 80px; height: auto; }
        .title-container { flex-grow: 1; }
        .header-placeholder { width: 80px; }
        
        /* Make input text more prominent */
        input[type="text"],
        textarea {
            border: none;
            border-bottom: 1px dotted #555;
            width: 100%;
            padding: 2px 0;
            background-color: transparent;
            font-family: 'Roboto Slab', serif; /* Use header font for emphasis */
            font-size: 14.5px; /* Slightly larger */
            font-weight: 500; /* Bolder */
            color: var(--input-text-color); /* Darker text */
            transition: border-color 0.3s;
        }
        
        input[type="text"]::placeholder,
        textarea::placeholder {
             color: #9a8f83; /* Softer, matching placeholder color */
             font-weight: 400; /* Placeholder should not be bold */
             font-family: 'Merriweather', serif; /* Use body font for placeholder */
        }

        input[type="text"]:focus,
        textarea:focus {
            outline: none;
            border-bottom: 1px solid var(--primary-color);
        }
        
        textarea {
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 10px;
            min-height: 80px;
            resize: vertical;
            background-color: rgba(243, 237, 229, 0.3);
        }

        .form-group, .form-section {
            margin-bottom: 15px;
        }

        .form-group>label, .form-section>label, .main-label {
            font-weight: bold;
            font-family: 'Roboto Slab', serif;
            color: #5c4e42;
        }

        .page-number {
            position: absolute;
            bottom: 15mm;
            right: 20mm;
            font-size: 12px;
            color: #888;
        }

        /* --- Page 1 (Daily Log) --- */
        .page-1 .date-section { text-align: center; margin-bottom: 20px; font-style: italic; color: #666; }
        .page-1 .weather-section { display: flex; align-items: center; gap: 20px; margin-top: 10px; }
        .page-1 .temp-inputs { display: flex; gap: 10px; align-items: center; }
        .page-1 .weather-section input[type="text"] { width: 50px; text-align: center; }
        .page-1 .weather-section label { font-weight: normal; }
        .page-1 .weather-section input[type="checkbox"] { margin-right: 5px; }
        .page-1 .sub-label { display: block; margin-top: 10px; margin-bottom: 5px; font-weight: bold; }

        /* --- Page 2 (Cover) --- */
        .page-2 h3 { margin-bottom: 0; }
        .page-2 .inline-input { display: flex; align-items: baseline; }
        .page-2 .inline-input label { white-space: nowrap; margin-right: 10px; font-weight: bold; }
        .page-2 .sub-item { padding-left: 20px; }
        .page-2 .contractor-title { font-size: 16px; text-align: center; font-weight: bold; font-family: 'Roboto Slab', serif; margin: 20px 0 15px; }
        .page-2 .two-col { display: flex; justify-content: space-between; gap: 40px; margin: 20px 0; }
        .page-2 .col { width: 50%; }
        .page-2 .signature-block { margin-top: 30px; }
        .page-2 .final-signature { margin-top: 20px; float: right; text-align: center; width: 300px; }
        .page-2 .final-signature .date { font-style: italic; }
        .page-2 .final-signature .role, .page-2 .final-signature .name { font-weight: bold; font-family: 'Roboto Slab', serif; }
        
        /* --- Image Page --- */
        .page-images .date-section { text-align: center; margin-bottom: 20px; font-style: italic; }
        .image-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 20px; }
        .image-item { display: flex; flex-direction: column; }
        .image-item .image-placeholder { width: 100%; height: 240px; background-color: #f0f0f0; border: 2px dashed var(--border-color); display: flex; justify-content: center; align-items: center; color: var(--placeholder-color); font-style: italic; margin-bottom: 10px; transition: background-color 0.3s; overflow: hidden; }
        .image-item .image-placeholder:hover { background-color: #e9e9e9; border-color: #aaa; }
        .image-item .image-placeholder img { width: 100%; height: 100%; object-fit: cover; }
        .image-item textarea { min-height: 60px; }

        /* --- Left Filter Panel --- */
        .filter-panel { position: fixed; inset: 16px auto auto 16px; width: 260px; padding: 20px; box-sizing: border-box; background: #4a3f35; border-radius: 12px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3); font-family: 'Roboto Slab', sans-serif; z-index: 9999; color: #f0e9e1; }
        .filter-panel h4 { margin: 0 0 15px; font-size: 18px; text-align: center; text-transform: uppercase; }
        .filter-panel .row { display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; }
        .filter-panel label { font-weight: 600; font-size: 13px; opacity: 0.9; }
        .filter-panel input, .filter-panel select { border: 1px solid #7a6c5d; border-radius: 8px; padding: 10px 12px; font-size: 14px; background: #6d5f50; outline: none; color: #fdfaf4; font-family: 'Merriweather', serif; }
        .filter-panel input::placeholder { color: #bcaea0; }
        .filter-panel input:focus { border-color: var(--primary-color); }
        .filter-panel .actions { display: flex; gap: 10px; margin-top: 10px; }
        .filter-panel button { flex: 1; padding: 12px 10px; border: 0; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 14px; font-family: 'Roboto Slab', sans-serif; text-transform: uppercase; transition: all 0.2s ease; }
        .btn-primary { background: var(--primary-color); color: var(--primary-text-color); }
        .btn-primary:hover { background: #a48661; }
        .btn-ghost { background: #6d5f50; color: #f0e9e1; border: 1px solid #8a6f4d;}
        .btn-ghost:hover { background: #7a6c5d; }
        .filter-panel small { display: block; opacity: .7; margin-top: 12px; font-size: 12px; text-align: center; }

        /* --- Results table --- */
        .results { margin: 16px; }
        .results .table-wrap { max-height: 420px; overflow: auto; border-radius: 12px; box-shadow: 0 6px 18px rgba(0, 0, 0, .2); border: 1px solid #4a3f35; }
        .results table { width: 100%; border-collapse: collapse; background: var(--page-bg-color); }
        .results th, .results td { padding: 12px 15px; border-bottom: 1px solid var(--border-color); font-size: 14px; text-align: left; }
        .results th { background: #e9e2d9; font-weight: 700; font-family: 'Roboto Slab', serif; position: sticky; top: 0; }
        .results tbody tr:hover { background-color: #f5f0e9; }

        /* --- Loader --- */
        #loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 10000; backdrop-filter: blur(5px); }
        .loader-spinner { width: 50px; height: 50px; border: 5px solid rgba(255, 255, 255, 0.3); border-top: 5px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- Layout & Visibility --- */
        body { margin-left: 292px; }
        body.doc-hidden .container { display: none !important; }
        body:not(.doc-hidden) #results { display: none; }

        @media (max-width: 900px) {
            body { margin-left: 0; }
            .filter-panel { position: static; width: auto; margin: 12px; border-radius: 8px; }
            .container { margin: 12px; width: auto; padding: 15mm; }
        }

        /* --- Print Styles --- */
        /* Control print margins for A4 paper */
        @page {
            size: A4;
            margin: 20mm;
        }

        @media print {
            body { background-color: white; margin: 0 !important; }
            .container {
                margin: 0;
                padding: 0; /* Remove padding for print, as @page handles margins */
                box-shadow: none;
                page-break-after: always;
                border: none;
                width: 100%;
                min-height: 0;
            }
            .container:last-child { page-break-after: auto; }
            .watermark { opacity: 0.1 !important; }
            .filter-panel, #results, #loader-overlay { display: none !important; }
        }
    </style>
</head>

<body class="doc-hidden">
    <!-- LOADER -->
    <div id="loader-overlay">
        <div class="loader-spinner"></div>
    </div>

    <!-- FILTER PANEL (bên trái) -->
    <div class="filter-panel">
        <h4>Nhật ký Công trình</h4>
        <div class="row">
            <label for="fProject">Công trình (ID/Tên)</label>
            <input id="fProject" type="text" placeholder="Nhập ID hoặc tên công trình...">
        </div>
        <div class="row">
            <label>Khoảng thời gian</label>
            <input id="fFrom" type="date">
            <input id="fTo" type="date">
        </div>
        <div class="actions">
            <button class="btn-primary" id="btnFetch" type="button">Tải dữ liệu</button>
            <button class="btn-ghost" id="btnPrint" type="button">In</button>
        </div>
        <small>Nhập ID/Tên để xem chi tiết, hoặc để trống để xem danh sách.</small>
    </div>

    <!-- RESULTS LIST -->
    <div id="results" class="results"></div>

    <!-- PAGE 2: COVER -->
    <div class="container page-2">
        <img src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2F61cc680f.%E1%BA%A2nh.053502.png" alt="Watermark" class="watermark">
        <div class="content-wrapper">
            <div class="header">
                <img src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2F87f535c0.%E1%BA%A2nh.054502.png" alt="Logo" class="logo">
                <div class="title-container">
                    <h2>Nhật ký Thi công Xây dựng Công trình</h2>
                    <h3>QUYỂN SỐ: ..../NKCT-NV</h3>
                </div>
                <div class="header-placeholder"></div>
            </div>
            
            <form>
                <div class="form-section inline-input">
                    <label>1. Tên công trình/Mã công trình (hạng mục công trình):</label>
                    <input type="text" name="ten_cong_trinh" id="inputIdOrName">
                </div>
                <div class="form-section inline-input">
                    <label>2. Địa điểm xây dựng:</label>
                    <input type="text" name="dia_diem">
                </div>
                <div class="form-section inline-input">
                    <label>3. Chủ đầu tư:</label>
                    <input type="text" name="chu_dau_tu">
                </div>
                <div class="form-section inline-input sub-item">
                    <label>Điện thoại:</label>
                    <input type="text" name="dien_thoai">
                </div>
                <div class="form-section inline-input">
                    <label>4. Nhà thầu tư vấn giám sát thi công xây dựng công trình:</label>
                    <input type="text" name="nha_thau_tu_van">
                </div>
                <div class="form-section inline-input sub-item">
                    <label>Họ và tên kỹ sư giám sát:</label>
                    <input type="text" name="ky_su_giam_sat">
                </div>
                <div class="form-section inline-input sub-item">
                    <label>Điện thoại:</label>
                    <input type="text" name="dien_thoai_ky_su_giam_sat">
                </div>
                <div class="form-section inline-input">
                    <label>5. Nhà thầu thi công xây dựng công trình:</label>
                    <input type="text" name="nha_thau_thi_cong">
                </div>
                <p class="contractor-title">ĐƠN VỊ THI CÔNG</p>
                <div class="form-section inline-input sub-item">
                    <label>Họ và tên chỉ huy trưởng công trường:</label>
                    <input type="text" name="chi_huy_truong">
                </div>
                <div class="form-section inline-input sub-item">
                    <label>Điện thoại:</label>
                    <input type="text" name="dien_thoai_chi_huy_truong">
                </div>

                <div class="form-section inline-input">
                    <label>6. Tên nhà thầu thiết kế kỹ thuật, thiết kế bản vẽ thi công:</label>
                    <input type="text" name="nha_thau_thiet_ke">
                </div>
                <div class="form-section inline-input">
                    <label>Họ và tên kiến trúc sư chủ trì:</label>
                    <input type="text" name="kts_chu_tri">
                </div>
                <div class="form-section inline-input">
                    <label>Họ và tên kỹ sư chủ trì:</label>
                    <input type="text" name="ky_su_chu_tri">
                </div>

                <div class="two-col">
                    <div class="col inline-input">
                        <label>Khởi công theo hợp đồng ngày</label>
                        <input type="text" name="khoi_cong_hop_dong">
                    </div>
                    <div class="col inline-input">
                        <label>Thực tế</label>
                        <input type="text" name="khoi_cong_thuc_te">
                    </div>
                </div>
                <div class="two-col" style="margin-top: -15px;">
                    <div class="col inline-input">
                        <label>Bàn giao theo hợp đồng ngày</label>
                        <input type="text" name="ban_giao_hop_dong">
                    </div>
                    <div class="col inline-input">
                        <label>Thực tế</label>
                        <input type="text" name="ban_giao_thuc_te">
                    </div>
                </div>

                <p style="line-height: 1.8;">Sổ này gồm: 33 trang, đánh số thứ tự từ 01 đến số 33<br>đóng dấu giáp lai và chữ ký của ông:</p>

                <div class="signature-block">
                    <label class="main-label">Họ tên, chữ ký người phụ trách thi công công trình và quản lý quyển nhật ký:</label>
                    <div class="two-col">
                        <div class="col inline-input"><label>Họ tên:</label><input type="text" name="chu_ky_thi_cong"></div>
                        <div class="col inline-input"><label>CHỮ KÝ:</label></div>
                    </div>
                </div>

                <div class="signature-block">
                    <label class="main-label">Họ tên, chữ ký người phụ trách giám sát thi công của Chủ đầu tư:</label>
                    <div class="two-col">
                        <div class="col inline-input"><label>Họ tên:</label><input type="text" name="chu_ky_giam_sat"></div>
                        <div class="col inline-input"><label>CHỮ KÝ:</label></div>
                    </div>
                </div>

                <div class="final-signature">
                    <p class="date">Ngày ...... tháng ...... năm ......</p>
                    <p class="role">ĐƠN VỊ THI CÔNG</p>
                    <p class="name">Giám đốc</p>
                </div>
                <div class="page-number"><p>Trang 1</p></div>
            </form>
        </div>
    </div>
    
    <!-- PAGE: IMAGES -->
    <div class="container page-images">
        <img src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2F61cc680f.%E1%BA%A2nh.053502.png" alt="Watermark" class="watermark">
        <div class="content-wrapper">
            <div class="header">
                <img src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2F87f535c0.%E1%BA%A2nh.054502.png" alt="Logo" class="logo">
                <div class="title-container">
                    <h2>Hình ảnh thi công</h2>
                </div>
                <div class="header-placeholder"></div>
            </div>

            <div class="date-section">
                <label>Ngày ...... tháng ...... năm 20......</label>
            </div>

            <div class="image-grid">
                <div class="image-item">
                    <div class="image-placeholder"></div>
                    <textarea name="mota_anh1" placeholder="Mô tả hình ảnh..."></textarea>
                </div>
                <div class="image-item">
                    <div class="image-placeholder"></div>
                    <textarea name="mota_anh2" placeholder="Mô tả hình ảnh..."></textarea>
                </div>
                <div class="image-item">
                    <div class="image-placeholder"></div>
                    <textarea name="mota_anh3" placeholder="Mô tả hình ảnh..."></textarea>
                </div>
                <div class="image-item">
                    <div class="image-placeholder"></div>
                    <textarea name="mota_anh4" placeholder="Mô tả hình ảnh..."></textarea>
                </div>
            </div>

            <div class="page-number"><p>Trang 2</p></div>
        </div>
    </div>
    
    <!-- PAGE 1: DAILY LOG -->
    <div class="container page-1">
        <img src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2F61cc680f.%E1%BA%A2nh.053502.png" alt="Watermark" class="watermark">
        <div class="content-wrapper">
            <div class="header">
                <img src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2F87f535c0.%E1%BA%A2nh.054502.png" alt="Logo" class="logo">
                <div class="title-container">
                    <h2>Tình hình thi công hàng ngày</h2>
                </div>
                <div class="header-placeholder"></div>
            </div>

            <div class="date-section">
                <label>Ngày ...... tháng ...... năm 20......</label>
            </div>

            <form>
                <div class="form-group">
                    <label class="main-label">1. Thời tiết</label>
                    <div class="weather-section">
                        <div><input type="checkbox" id="binhthuong" name="weather" value="binhthuong"><label for="binhthuong">Bình thường</label></div>
                        <div><input type="checkbox" id="mua" name="weather" value="mua"><label for="mua">Mưa</label></div>
                        <div><input type="checkbox" id="nang" name="weather" value="nang"><label for="nang">Nắng</label></div>
                    </div>
                    <div class="weather-section temp-inputs">
                        <label>Nhiệt độ:</label>
                        <label for="sang">Sáng</label><input type="text" id="sang" name="temp_sang">
                        <label for="trua">Trưa</label><input type="text" id="trua" name="temp_trua">
                        <label for="chieu">Chiều</label><input type="text" id="chieu" name="temp_chieu">
                        <label for="toi">Tối</label><input type="text" id="toi" name="temp_toi">
                    </div>
                </div>

                <div class="form-group">
                    <label class="main-label">2. Tình hình nhân lực, thiết bị thi công:</label>
                    <div>
                        <label class="sub-label" for="nhanluc">2.1. Nhân lực:</label>
                        <textarea id="nhanluc" name="nhanluc"></textarea>
                    </div>
                    <div>
                        <label class="sub-label" for="thietbi">2.2. Thiết bị:</label>
                        <textarea id="thietbi" name="thietbi"></textarea>
                    </div>
                </div>

                <div class="form-group">
                    <label class="main-label">3. Tình hình thi công:</label>
                    <div>
                        <label class="sub-label" for="noidung_khoiluong">3.1. Nội dung, khối lượng công việc và tiến độ thực hiện:</label>
                        <textarea id="noidung_khoiluong" name="noidung_khoiluong"></textarea>
                    </div>
                    <div>
                        <label class="sub-label" for="nghiemthu">3.2. Nghiệm thu công việc xây dựng hàng ngày:</label>
                        <textarea id="nghiemthu" name="nghiemthu"></textarea>
                    </div>
                </div>

                <div class="form-group">
                    <label class="main-label" for="suco">4. Mô tả chi tiết các sự cố, hư hỏng và các vấn đề phát sinh khác:</label>
                    <textarea id="suco" name="suco"></textarea>
                </div>

                <div class="form-group">
                    <label class="main-label" for="kiennghi">5. Các kiến nghị và ý kiến chỉ đạo:</label>
                    <textarea id="kiennghi" name="kiennghi"></textarea>
                </div>

                <div class="form-group">
                    <label class="main-label" for="nhanxet_kysu">6. Nhận xét của kỹ sư giám sát:</label>
                    <textarea id="nhanxet_kysu" name="nhanxet_kysu"></textarea>
                </div>

                <div class="form-group">
                    <label class="main-label" for="chihuy">7. Chỉ huy trưởng công trường tiếp thu:</label>
                    <textarea id="chihuy" name="chihuy"></textarea>
                </div>
                <div class="page-number"><p>Trang 3</p></div>
            </form>
        </div>
    </div>
    
    <script>
        (function () {
            // === CONFIG ===
            const BASE = 'https://script.google.com/macros/s/AKfycbw1kszJxQWhR2vrwioSiZqFVjszJioLYF3oOAa7tysfwVj2xkNGsYTKa77ZVBTicR89cw/exec';
            const SHEET = 'Báo cáo chi tiết';
            const LOADER = document.getElementById('loader-overlay');

            // === UTILS ===
            const formatDateDisplay = (dateStr) => {
                if (!dateStr) return '';
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) {
                    return dateStr;
                }
                const dd = String(date.getDate()).padStart(2, '0');
                const mm = String(date.getMonth() + 1).padStart(2, '0');
                const yyyy = date.getFullYear();
                return `${dd}/${mm}/${yyyy}`;
            };
            
            const fmtVN = d => {
                const dd = String(d.getDate()).padStart(2, '0');
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                const yyyy = d.getFullYear();
                return `Ngày ${dd} tháng ${mm} năm ${yyyy}`;
            };
            
            function applyDatesToPages(from, to) {
                const labelText = from && to ?
                    `${fmtVN(from)}  –  ${fmtVN(to)}` :
                    (from ? fmtVN(from) : (to ? fmtVN(to) : 'Ngày ...... tháng ...... năm 20......'));
                document.querySelectorAll('.date-section label').forEach(el => el.textContent = labelText);
            }

            function applyProjectToForm(project) {
                const el = document.getElementById('inputIdOrName');
                if (el) el.value = project || '';
            }
            
            function fillFormByHeaders(rowObj) {
                if (!rowObj) return;
                const map = {
                    'Địa điểm xây dựng': 'dia_diem',
                    'Chủ đầu tư': 'chu_dau_tu',
                    'Họ và tên kỹ sư giám sát': 'ky_su_giam_sat',
                    'Họ và tên chỉ huy trưởng công trường': 'chi_huy_truong',
                    'Tên công trình': 'ten_cong_trinh',
                    'Mã công trình': 'ten_cong_trinh'
                };
                Object.keys(map).forEach(h => {
                    const name = map[h];
                    const el = document.querySelector(`[name="${name}"]`);
                    if (el && rowObj[h] !== undefined) el.value = rowObj[h];
                });
            }

            function pick(obj, keys) {
                for (const k of keys) {
                    if (obj[k] !== undefined && obj[k] !== null && obj[k] !== '') return obj[k];
                }
                return '';
            }

            function renderList(rows) {
                const container = document.getElementById('results');
                if (!rows || rows.length === 0) {
                    container.innerHTML = '<div class="results" style="text-align:center; padding: 20px; color: white;"><em>Không có dữ liệu.</em></div>';
                    return;
                }
                const cols = [
                    { label: 'ID', keys: ['ID', 'Id', 'id', 'Mã', 'Mã công trình'] },
                    { label: 'Ngày', keys: ['Ngày', 'Date', 'date'] },
                    { label: 'Công trình', keys: ['Công trình', 'Tên công trình', 'Name', 'name'] },
                    { label: 'Địa chỉ', keys: ['Địa chỉ', 'Address', 'address', 'Địa điểm xây dựng'] },
                    { label: 'Phụ trách', keys: ['Người phụ trách', 'Phụ trách', 'Supervisor', 'Manager'] },
                ];
                let html = '<div class="table-wrap"><table><thead><tr>';
                cols.forEach(c => html += `<th>${c.label}</th>`);
                html += '</tr></thead><tbody>';
                rows.forEach(r => {
                    html += '<tr>';
                    cols.forEach(c => {
                        const rawValue = pick(r, c.keys);
                        const displayValue = c.label === 'Ngày' ? formatDateDisplay(rawValue) : rawValue;
                        html += `<td>${displayValue}</td>`;
                    });
                    html += '</tr>';
                });
                html += '</tbody></table></div>';
                container.innerHTML = html;
            }

            function showDocument(visible) {
                document.body.classList.toggle('doc-hidden', !visible);
            }
            
            // === API CALLS ===
            async function fetchSheet(sheetName, idOrName) {
                const url = `${BASE}?sheet=${encodeURIComponent(sheetName)}&id=${encodeURIComponent(idOrName)}`;
                const resp = await fetch(url);
                if (!resp.ok) throw new Error(`Network error fetching ${sheetName}`);
                const data = await resp.json();
                return data.length > 0 ? data[0] : null;
            }

            async function fetchAll(sheetName, idOrName) {
                const url = `${BASE}?sheet=${encodeURIComponent(sheetName)}&id=${encodeURIComponent(idOrName)}`;
                const resp = await fetch(url);
                if (!resp.ok) throw new Error(`Network error fetching all from ${sheetName}`);
                const data = await resp.json();
                return Array.isArray(data) ? data : (data.data || []);
            }
            
            // === MAIN LOGIC ===
            async function loadProjectDetails() {
                const idOrName = document.getElementById("inputIdOrName").value.trim();
                if (!idOrName) {
                    // Use the value from the filter input if the cover page input is empty
                    const filterProject = document.getElementById('fProject').value.trim();
                    if (!filterProject) {
                        alert("Vui lòng nhập ID hoặc Tên công trình trong bộ lọc.");
                        return;
                    }
                    document.getElementById("inputIdOrName").value = filterProject;
                    return loadProjectDetails(); // Re-run with the new value
                }


                // Fetch data from both sheets
                const bcPromise = fetchSheet("Báo cáo chi tiết", idOrName);
                const imgsPromise = fetchAll("Hình ảnh chi tiết", idOrName);
                const [bc, imgs] = await Promise.all([bcPromise, imgsPromise]);

                if (!bc) return alert("Không tìm thấy bản ghi trong 'Báo cáo chi tiết'!");

                // Fill form from "Báo cáo chi tiết" sheet
                document.querySelector("input[name='ten_cong_trinh']").value = bc["Công trình"] || "";
                document.querySelector("input[name='dia_diem']").value = bc["Địa chỉ"] || "";
                document.querySelector("input[name='dien_thoai']").value = bc["SĐT"] || "";
                document.querySelector("input[name='ky_su_giam_sat']").value = bc["Người phụ trách"] || "";

                document.querySelector("textarea[name='nhanluc']").value = bc["Nhân lực"] || "";
                document.querySelector("textarea[name='thietbi']").value = bc["Thiết bị"] || "";
                document.querySelector("textarea[name='noidung_khoiluong']").value = bc["Nội dung CV"] || "";
                document.querySelector("textarea[name='nghiemthu']").value = bc["Nhân sự thi công"] || "";
                document.querySelector("textarea[name='suco']").value = bc["Sự cố"] || "";
                document.querySelector("textarea[name='kiennghi']").value = bc["Kiến nghị"] || "";
                document.querySelector("textarea[name='nhanxet_kysu']").value = bc["Nhận xét"] || "";
                
                const wt = (bc["Thời tiết"] || "").toLowerCase();
                document.getElementById('binhthuong').checked = wt.includes('bình thường');
                document.getElementById('mua').checked = wt.includes('mưa');
                document.getElementById('nang').checked = wt.includes('nắng');
                
                // Fill images from "Hình ảnh chi tiết" sheet
                for (let i = 1; i <= 4; i++) {
                    const row = imgs[i - 1];
                    const ta = document.querySelector(`textarea[name='mota_anh${i}']`);
                    const ph = ta?.closest(".image-item")?.querySelector(".image-placeholder");
                    if (!ta || !ph) continue;

                    ta.value = row ? (row["Ghi chú"] || row["Hạng mục"] || "") : "";
                    const src = row ? (row["Link ảnh"] || row["Hình ảnh"] || "") : "";
                    ph.innerHTML = src ? `<img src="${src}">` : `<span style="color:#999">Chưa có ảnh</span>`;
                }
            }

            // === EVENT LISTENERS ===
            document.getElementById('btnPrint').addEventListener('click', () => {
                // Check if the document pages are hidden
                if (document.body.classList.contains('doc-hidden')) {
                    // If hidden, alert the user to select a project first.
                    alert('Vui lòng tải dữ liệu của một công trình để xem chi tiết trước khi có thể in.');
                    return; // Stop further execution
                }
                // If the document is visible, proceed with printing.
                window.print();
            });

            document.getElementById('btnFetch').addEventListener('click', async () => {
                LOADER.style.display = 'flex';
                try {
                    const project = (document.getElementById('fProject').value || '').trim();
                    const fromStr = document.getElementById('fFrom').value;
                    const toStr = document.getElementById('fTo').value;

                    const from = fromStr ? new Date(fromStr) : null;
                    const to = toStr ? new Date(toStr) : null;
                    applyDatesToPages(from, to);
                    applyProjectToForm(project);
                    
                    // If no project specified, fetch and render the list
                    if (!project) {
                        const res = await fetch(`${BASE}?sheet=${encodeURIComponent(SHEET)}`);
                        if (!res.ok) throw new Error('Failed to fetch project list.');
                        const json = await res.json();
                        let rows = Array.isArray(json) ? json : (json.data || []);
                        const dateKeys = ['Ngày', 'Date', 'date'];

                        // 1. Client-side Filtering based on date range
                        if (fromStr || toStr) {
                            const fromDate = fromStr ? new Date(fromStr) : null;
                            if (fromDate) fromDate.setHours(0, 0, 0, 0); // Start of the day

                            const toDate = toStr ? new Date(toStr) : null;
                            if (toDate) toDate.setHours(23, 59, 59, 999); // End of the day

                            rows = rows.filter(row => {
                                const rowDateStr = pick(row, dateKeys);
                                if (!rowDateStr) return false; // Exclude rows without a date if filter is active
                                const rowDate = new Date(rowDateStr);
                                if (isNaN(rowDate.getTime())) return false; // Exclude invalid dates

                                if (fromDate && rowDate < fromDate) return false;
                                if (toDate && rowDate > toDate) return false;
                                return true;
                            });
                        }

                        // 2. Sorting by date, descending
                        rows.sort((a, b) => {
                            const dateA = new Date(pick(a, dateKeys));
                            const dateB = new Date(pick(b, dateKeys));
                            // Handle cases where dates might be invalid by pushing them to the bottom
                            if (isNaN(dateB.getTime())) return -1;
                            if (isNaN(dateA.getTime())) return 1;
                            return dateB - dateA;
                        });

                        renderList(rows);
                        showDocument(false);
                        return;
                    }
                    
                    // If project is specified, load its details
                    await loadProjectDetails();
                    showDocument(true);

                } catch (err) {
                    console.error(err);
                    alert('Lỗi tải dữ liệu. Kiểm tra URL Web App, tên Sheet hoặc quyền truy cập.');
                    showDocument(false); // Hide A4 and show list view on error
                    renderList([]); // Clear any existing list
                } finally {
                    LOADER.style.display = 'none';
                }
            });

            // Enter key triggers fetch
            document.getElementById('fProject').addEventListener('keypress', e => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    document.getElementById('btnFetch').click();
                }
            });
            
            // --- INITIALIZATION ---
            // Set default date range to today
            const today = new Date();
            document.getElementById('fTo').value = today.toISOString().slice(0, 10);
            
            // Trigger initial fetch on page load to show the list
            document.getElementById('btnFetch').click();

        })();
    </script>
</body>
</html>



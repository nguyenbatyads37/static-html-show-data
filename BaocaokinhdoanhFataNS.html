<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <title>Báo cáo kinh doanh Kama</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    /* --- CÀI ĐẶT CHUNG & TABS --- */
    body {
      font-family: 'Roboto', Arial, sans-serif;
      padding: 20px;
      background-color: #f4f4f4;
      color: #333;
      font-size: 16px;
      font-weight: 500;
      /* Chữ in đậm vừa phải cho toàn bộ trang */
    }

    .tab-container {
      overflow: hidden;
      border-bottom: 2px solid #ccc;
      margin-bottom: 20px;
    }

    .tab-container button {
      background-color: #f1f1f1;
      float: left;
      border: none;
      outline: none;
      cursor: pointer;
      padding: 14px 20px;
      transition: 0.3s;
      font-size: 17px;
      font-weight: 500;
      border-radius: 8px 8px 0 0;
      margin-right: 5px;
    }

    .tab-container button:hover {
      background-color: #ddd;
    }

    .tab-container button.active {
      background-color: #2d7c2d;
      color: white;
    }

    .tab-content {
      display: none;
      padding: 6px 12px;
      border-top: none;
      animation: fadeIn 0.5s;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    /* --- STYLES CHUNG CHO BẢNG & CĂN LỀ --- */
    .table-responsive-container {
      overflow-x: auto;
      margin-bottom: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: auto;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    th,
    td {
      border: 1px solid #e0e0e0;
      padding: 12px 14px;
      white-space: nowrap;
      vertical-align: middle;
      transition: background-color 0.2s;
      font-size: 15px;
    }

    th {
      text-align: center !important;
      font-size: 16px;
    }

    td {
      text-align: right !important;
    }

    .text-left {
      text-align: left !important;
    }

    .text-center {
      text-align: center !important;
    }

    /* Style cho cột Marketing/Sale */
    .marketing-name, .sale-name {
      font-weight: 700;
      /* In đậm hơn */
      color: #00008B;
      /* Màu xanh đậm (Dark Blue) */
    }

    /* CẢI THIỆN KHẢ NĂNG ĐỌC BẢNG */
    tbody tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    tbody tr:not(.team-header-row):not(.total-row):not(.highlight):hover {
      background-color: #eff5fb;
    }

    th.green-header {
      background: #4CAF50;
      color: white;
      font-weight: 700;
    }

    th.blue-header {
      background: #4CAF50;
      color: white;
      font-weight: 700;
    }

    th.yellow-header {
      background: #FFC107;
      color: #424242;
      font-weight: 700;
    }

    tr.total-row,
    tr.total-row:hover {
      background: #2d7c2d;
      color: white;
      font-weight: 700;
      font-size: 1.2em;
      border-bottom: 3px solid #FFC107;
    }

    .total-row .total-label {
      text-transform: uppercase;
      text-align: left !important;
    }

    .total-row .total-value {
      text-align: right !important;
    }

    /* --- STYLES CHO TABS & LAYOUT CHUNG --- */
    .report-container {
      display: flex;
      gap: 20px;
    }

    .sidebar {
      width: 260px;
      flex-shrink: 0;
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .sidebar h3 {
      background: #2d7c2d;
      color: #fff;
      padding: 10px;
      margin-top: 10px;
      font-size: 18px;
      border-radius: 4px;
      font-weight: 700;
    }

    .sidebar label {
      display: block;
      margin: 8px 0;
      font-size: 15px;
      cursor: pointer;
    }

    .sidebar input[type="date"],
    .sidebar input[type="text"] {
      width: 100%;
      box-sizing: border-box;
      padding: 8px;
      margin: 4px 0 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 15px;
    }

    /* --- NEW: STYLES FOR FILTER BUTTONS --- */
    .filter-buttons {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-bottom: 15px;
    }
    .filter-buttons button {
        background-color: #e7e7e7;
        border: 1px solid #ccc;
        color: #333;
        padding: 8px;
        cursor: pointer;
        border-radius: 4px;
        font-size: 14px;
        font-weight: 500;
        transition: background-color 0.2s, color 0.2s;
    }
    .filter-buttons button:hover {
        background-color: #d4d4d4;
    }
    .filter-buttons button.active {
        background-color: #2d7c2d;
        color: white;
        border-color: #2d7c2d;
    }

    .main-content-area {
      flex-grow: 1;
    }

    .header {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .header img {
      height: 80px;
      /* Tăng kích thước logo */
      margin-right: 20px;
      /* Bỏ khung tròn và bóng */
    }

    .header h2 {
      margin: 0;
      color: #2d7c2d;
      font-weight: 700;
      font-size: 28px;
    }

    /* --- CHỈ BÁO ĐANG TẢI --- */
    #loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      font-size: 1.5em;
      font-weight: bold;
      color: #2d7c2d;
      transition: opacity 0.3s, visibility 0.3s;
      visibility: hidden;
      opacity: 0;
    }

    #loading-overlay.visible {
      visibility: visible;
      opacity: 1;
    }

    /* --- CSS CHO SẮP XẾP BẢNG --- */
    .sortable-table th {
      cursor: pointer;
      position: relative;
    }

    .sortable-table th .sort-icon {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.8em;
      opacity: 0.4;
      transition: opacity 0.2s;
    }

    .sortable-table th:hover .sort-icon {
      opacity: 0.8;
    }

    .sortable-table th.sorted .sort-icon {
      opacity: 1;
    }

    .sortable-table th .sort-icon.asc::after {
      content: " ▲";
    }

    .sortable-table th .sort-icon.desc::after {
      content: " ▼";
    }

    .daily-breakdown h3,
    .grouped-report-section h3 {
      margin-top: 30px;
      background: #f0f0f0;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 18px;
      font-weight: 700;
    }
    .grouped-report-section {
        margin-bottom: 40px;
        padding: 20px;
        background-color: #ffffff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
  </style>
</head>

<body>
  <div id="loading-overlay">Đang tải dữ liệu...</div>
  <div class="tab-container">
    <button class="tablinks active" onclick="openTab(event, 'DetailedReport')" id="defaultOpen">Báo cáo chi tiết</button>
  </div>
  <!-- TAB 1: BÁO CÁO CHI TIẾT -->
  <div id="DetailedReport" class="tab-content" style="display: block;">
    <div class="report-container">
      <div class="sidebar">
        <h3>Bộ lọc</h3>
        <!-- NEW: Filter buttons added here -->
        <div class="filter-buttons" id="filter-buttons-container">
            <button data-period="today">Hôm nay</button>
            <button data-period="yesterday">Hôm qua</button>
            <button data-period="this_week">Tuần này</button>
            <button data-period="this_month">Tháng này</button>
            <button data-period="last_month">Tháng trước</button>
        </div>
        <label for="start-date-tab1">Từ ngày:</label><input type="date" id="start-date-tab1">
        <label for="end-date-tab1">Đến ngày:</label><input type="date" id="end-date-tab1">
      </div>
      <div class="main-content-area">
        <div class="header">
          <img
            src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Fd3e93e8d.%E1%BA%A2nh.121830.png"
            alt="Logo">
          <h2 id="report-title-tab1">Báo cáo kinh doanh Kama</h2>
        </div>
        <div class="table-responsive-container">
          <table id="summary-table" class="sortable-table">
            <thead>
              <!-- REVERTED: Table headers restored to original -->
              <tr>
                <th class="green-header">STT<span class="sort-icon"></span></th>
                <th class="green-header">Marketing<span class="sort-icon"></span></th>
                <th class="green-header">Số data<span class="sort-icon"></span></th>
                <th class="green-header">Đơn chốt<span class="sort-icon"></span></th>
                <th class="green-header">Khách cũ<span class="sort-icon"></span></th>
                <th class="blue-header">Doanh số<span class="sort-icon"></span></th>
                <th class="blue-header">Doanh số cũ<span class="sort-icon"></span></th>
                <th class="yellow-header">Tỉ lệ chốt %<span class="sort-icon"></span></th>
                <th class="yellow-header">Đơn trung bình<span class="sort-icon"></span></th>
              </tr>
            </thead>
            <tbody id="summary-body"></tbody>
          </table>
        </div>
        <div id="daily-breakdown"></div>
      </div>
    </div>
  </div>

  <script>
    // =================================================================================
    // --- I. KHAI BÁO BIẾN TOÀN CỤC & CẤU HÌNH ---
    // =================================================================================
    const API_URL_REVENUE = 'https://script.google.com/macros/s/AKfycbzq298F76ScFgSvb-FIVpH6DL3vZLwHfbc75h1xyUM6Dt-Dl6PdGiJDbNnakt5c5xx4/exec';
    const API_URL_DATA_COUNT = 'https://script.google.com/macros/s/AKfycbwVZXMmGDTrrfsiqQ8la1IEN4IhZyNgAahQasr2rLRL2cOaZSUiOK98ZnPfIRh45Yal/exec';

    let masterData = [];
    const sortStates = {
      summary: { column: null, direction: 'asc' },
      daily: {}
    };

    // REVERTED: Sort keys restored to original configuration
    const summaryColumnSortKeys = {
      1: { prop: 'name', type: 'string' }, // Marketing
      2: { prop: 'soData', type: 'number' }, // Số data
      3: { prop: 'donChot', type: 'number' }, // Đơn chốt
      4: { prop: 'khachCu', type: 'number' }, // Khách cũ
      5: { prop: 'doanhThu', type: 'number' }, // Doanh số
      6: { prop: 'doanhThuKhachCu', type: 'number' }, // Doanh số cũ
      7: { prop: (s) => s.soData ? s.donChot / s.soData : 0, type: 'number' }, // Tỉ lệ chốt %
      8: { prop: (s) => s.donChot ? s.doanhThu / s.donChot : 0, type: 'number' } // Đơn trung bình
    };


    // =================================================================================
    // --- II. KHỞI TẠO ỨNG DỤNG ---
    // =================================================================================

    document.addEventListener('DOMContentLoaded', () => {
      setupEventListeners();
      setDefaultDates();
      fetchAndProcessData();
    });

    function setDefaultDates() {
      const today = new Date();
      const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
      const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
      const formatDateForInput = (date) => date.toISOString().split('T')[0];

      const startDateFormatted = formatDateForInput(firstDay);
      const endDateFormatted = formatDateForInput(lastDay);

      document.getElementById('start-date-tab1').value = startDateFormatted;
      document.getElementById('end-date-tab1').value = endDateFormatted;
      
      // NEW: Highlight the 'This Month' button by default
      updateActiveButton('this_month');
    }

    function setupEventListeners() {
      // Event listeners for filters on Tab 1
      document.getElementById('start-date-tab1').addEventListener('change', () => {
        updateActiveButton(null); // Clear active button on manual date change
        handleFilterChange();
      });
      document.getElementById('end-date-tab1').addEventListener('change', () => {
        updateActiveButton(null); // Clear active button on manual date change
        handleFilterChange();
      });
      
      // Event listeners for sorting on Tab 1 summary table
      document.getElementById('summary-table').querySelector('thead').addEventListener('click', (e) => sortTable(e, 'summary'));
      // Event listeners for sorting on Tab 1 daily breakdown tables
      document.getElementById('daily-breakdown').addEventListener('click', (e) => {
        if (e.target.closest('th')) {
          sortTable(e, 'daily');
        }
      });

      // NEW: Event listener for the filter buttons container
      document.getElementById('filter-buttons-container').addEventListener('click', (e) => {
          if (e.target.tagName === 'BUTTON') {
              const period = e.target.dataset.period;
              if (period) {
                  setDateRange(period);
                  updateActiveButton(period);
              }
          }
      });
    }

    // =================================================================================
    // --- NEW: LOGIC FOR FILTER BUTTONS ---
    // =================================================================================
    function setDateRange(period) {
        const today = new Date();
        let startDate, endDate;

        // Set hours to 0 to avoid timezone issues with comparisons
        today.setHours(0, 0, 0, 0);

        switch (period) {
            case 'today':
                startDate = new Date(today);
                endDate = new Date(today);
                break;
            case 'yesterday':
                startDate = new Date(today);
                startDate.setDate(today.getDate() - 1);
                endDate = new Date(startDate);
                break;
            case 'this_week':
                startDate = new Date(today);
                const day = today.getDay(); // Sunday = 0, Monday = 1, ...
                const diff = today.getDate() - day + (day === 0 ? -6 : 1); // Adjust for Sunday
                startDate.setDate(diff);
                endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 6);
                break;
            case 'this_month':
                startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                break;
            case 'last_month':
                const prevMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                startDate = prevMonth;
                endDate = new Date(prevMonth.getFullYear(), prevMonth.getMonth() + 1, 0);
                break;
        }

        const formatDateForInput = (date) => date.toISOString().split('T')[0];
        document.getElementById('start-date-tab1').value = formatDateForInput(startDate);
        document.getElementById('end-date-tab1').value = formatDateForInput(endDate);

        handleFilterChange();
    }
    
    function updateActiveButton(activePeriod) {
        const buttons = document.querySelectorAll('#filter-buttons-container button');
        buttons.forEach(button => {
            if (button.dataset.period === activePeriod) {
                button.classList.add('active');
            } else {
                button.classList.remove('active');
            }
        });
    }

    // =================================================================================
    // --- III. TẢI VÀ XỬ LÝ DỮ LIỆU ---
    // =================================================================================
    async function fetchAndProcessData() {
        showLoader();
        try {
            const [revenueResponse, dataCountResponse] = await Promise.all([
                fetch(API_URL_REVENUE),
                fetch(API_URL_DATA_COUNT)
            ]);

            const revenueResult = await revenueResponse.json();
            const dataCountResult = await dataCountResponse.json();

            const revenueData = (revenueResult.data || []).map(r => {
                const isSuccessfulOrder = (r["TRẠNG THÁI"] === "Success" && r["TRẠNG THÁI VẬN ĐƠN"] !== "Hủy");
                const isOldCustomerOrder = (r["TRẠNG THÁI"] === "Success (old customer)" && r["TRẠNG THÁI VẬN ĐƠN"] !== "Hủy");
                return {
                    name: (r["MKT PT"] || 'N/A').trim(),
                    ngay: new Date(r["NGÀY GIỜ"]),
                    donChot: isSuccessfulOrder ? 1 : 0,
                    doanhThu: isSuccessfulOrder ? (Number(r["GIÁ"]) || 0) : 0,
                    soData: 0, 
                    khachCu: isOldCustomerOrder ? 1 : 0,
                    doanhThuKhachCu: isOldCustomerOrder ? (Number(r["GIÁ"]) || 0) : 0 
                };
            });

            const dataCountData = (dataCountResult.data || []).map(r => ({
                name: (r["MKT PT"] || 'N/A').trim(),
                ngay: new Date(r["NGÀY"]), 
                donChot: 0,
                doanhThu: 0,
                soData: 1, 
                khachCu: 0,
                doanhThuKhachCu: 0 
            }));
            
            masterData = [...revenueData, ...dataCountData].filter(r =>
                r.name !== 'N/A' && r.ngay instanceof Date && !isNaN(r.ngay)
            );

            applyTab1Filters();
        } catch (err) {
            console.error("Lỗi tải dữ liệu:", err);
            alert('Không thể tải dữ liệu từ API. Vui lòng kiểm tra lại.');
            document.getElementById('report-title-tab1').textContent = `LỖI TẢI DỮ LIỆU`;
        } finally {
            hideLoader();
        }
    }


    // =================================================================================
    // --- IV. XỬ LÝ SỰ KIỆN VÀ BỘ LỌC ---
    // =================================================================================

    function handleFilterChange() {
      showLoader();
      setTimeout(() => {
        applyTab1Filters();
        hideLoader();
      }, 50);
    }

    function getFilteredData(startDateId, endDateId) {
      const startDateVal = document.getElementById(startDateId).value;
      const endDateVal = document.getElementById(endDateId).value;
      
      const startDate = startDateVal ? new Date(startDateVal) : null;
      if (startDate) startDate.setHours(0, 0, 0, 0);

      const endDate = endDateVal ? new Date(endDateVal) : null;
      if (endDate) endDate.setHours(23, 59, 59, 999);

      if ((startDate && isNaN(startDate)) || (endDate && isNaN(endDate))) return [];
      
      return masterData.filter(r => {
        const recordDate = r.ngay;
        return (!startDate || recordDate >= startDate) && (!endDate || recordDate <= endDate);
      });
    }

    // =================================================================================
    // --- V. CÁC HÀM ÁP DỤNG BỘ LỌC ---
    // =================================================================================

    function applyTab1Filters() {
      const filteredData = getFilteredData('start-date-tab1', 'end-date-tab1');
      const summaryList = generateSummaryTableData(filteredData);

      sortList(summaryList, sortStates.summary, summaryColumnSortKeys, { prop: 'name', type: 'string' });

      renderSummary(summaryList);
      updateSortIcons(document.getElementById('summary-table'), sortStates.summary);
      renderDailyBreakdown(filteredData);
    }

    // =================================================================================
    // --- VI. CÁC HÀM TÍNH TOÁN VÀ TỔNG HỢP DỮ LIỆU ---
    // =================================================================================

    function generateSummaryTableData(data) {
      const summary = {};
      data.forEach(r => {
        const key = r.name;
        if (!summary[key]) {
          summary[key] = {
            name: r.name,
            soData: 0,
            donChot: 0,
            doanhThu: 0,
            khachCu: 0, 
            doanhThuKhachCu: 0 
          };
        }
        const S = summary[key];
        S.soData += r.soData;
        S.donChot += r.donChot;
        S.doanhThu += r.doanhThu;
        S.khachCu += r.khachCu; 
        S.doanhThuKhachCu += r.doanhThuKhachCu; 
      });
      return Object.values(summary);
    }

    // =================================================================================
    // --- VII. CÁC HÀM HIỂN THỊ DỮ LIỆU (RENDERING) ---
    // =================================================================================

    function renderSummary(dataList) {
      const { bodyHtml } = generateSummaryTableHTML(dataList);
      document.getElementById('summary-body').innerHTML = bodyHtml;
    }

    function renderDailyBreakdown(filteredData) {
      const container = document.getElementById('daily-breakdown');
      container.innerHTML = '';
      if (filteredData.length === 0) {
        container.innerHTML = '<p style="text-align:center; margin-top: 20px;">Không có dữ liệu chi tiết.</p>';
        return;
      }

      const groupedByDate = {};
      filteredData.forEach(r => {
        const d = formatDate(r.ngay);
        if (!groupedByDate[d]) groupedByDate[d] = [];
        groupedByDate[d].push(r);
      });

      const sortedDates = Object.keys(groupedByDate).sort((a, b) => new Date(b.split('/').reverse().join('-')) - new Date(a.split('/').reverse().join('-')));

      let finalHtml = sortedDates.map(date => {
        let dailyList = generateSummaryTableData(groupedByDate[date]);
        sortList(dailyList, { column: null, direction: 'asc' }, summaryColumnSortKeys, { prop: 'name', type: 'string' });
        const { bodyHtml } = generateSummaryTableHTML(dailyList);
        // REVERTED: Daily breakdown headers restored to original
        return `<h3>${date}</h3><div class="table-responsive-container"><table class="sortable-table daily-summary-table" data-date="${date}">
            <thead><tr>
                <th class="green-header">STT<span class="sort-icon"></span></th>
                <th class="green-header">Marketing<span class="sort-icon"></span></th>
                <th class="green-header">Số data<span class="sort-icon"></span></th>
                <th class="green-header">Đơn chốt<span class="sort-icon"></span></th>
                <th class="green-header">Khách cũ<span class="sort-icon"></span></th>
                <th class="blue-header">Doanh số<span class="sort-icon"></span></th>
                <th class="blue-header">Doanh số cũ<span class="sort-icon"></span></th>
                <th class="yellow-header">Tỉ lệ chốt %<span class="sort-icon"></span></th>
                <th class="yellow-header">Đơn trung bình<span class="sort-icon"></span></th>
            </tr></thead><tbody>${bodyHtml}</tbody></table></div>`;
      }).join('');
      container.innerHTML = finalHtml;
      sortStates.daily = {}; // Reset daily sort states when re-rendering
    }

    // REVERTED: HTML generation logic restored to original
    function generateSummaryTableHTML(dataList, reportType = 'default') {
      let total = { soData: 0, donChot: 0, doanhThu: 0, khachCu: 0, doanhThuKhachCu: 0 }; 
      const bodyRowsHtml = dataList.map((s, index) => {
        Object.keys(total).forEach(key => total[key] += s[key] || 0);
        
        const tiLeChot = s.soData ? s.donChot / s.soData : 0;
        const donTrungBinh = s.donChot ? s.doanhThu / s.donChot : 0;
        
        const nameColumnClass = 'text-left marketing-name';

        return `<tr>
                    <td class="text-center">${index + 1}</td>
                    <td class="${nameColumnClass}">${s.name}</td> 
                    <td>${formatNumber(s.soData)}</td>
                    <td>${formatNumber(s.donChot)}</td>
                    <td>${formatNumber(s.khachCu)}</td> 
                    <td>${formatCurrency(s.doanhThu)}</td>
                    <td>${formatCurrency(s.doanhThuKhachCu)}</td> 
                    <td>${formatPercent(tiLeChot)}</td>
                    <td>${formatCurrency(donTrungBinh)}</td> 
                </tr>`;
      }).join('');

      const totalTiLeChot = total.soData ? total.donChot / total.soData : 0;
      const totalDonTrungBinh = total.donChot ? total.doanhThu / total.donChot : 0;

      const totalRowHtml = `<tr class="total-row">
                <td class="total-label" colspan="2">TỔNG CỘNG</td>
                <td class="total-value">${formatNumber(total.soData)}</td>
                <td class="total-value">${formatNumber(total.donChot)}</td>
                <td class="total-value">${formatNumber(total.khachCu)}</td>
                <td class="total-value">${formatCurrency(total.doanhThu)}</td>
                <td class="total-value">${formatCurrency(total.doanhThuKhachCu)}</td>
                <td class="total-value">${formatPercent(totalTiLeChot)}</td>
                <td class="total-value">${formatCurrency(totalDonTrungBinh)}</td>
            </tr>`;
      return { bodyHtml: totalRowHtml + bodyRowsHtml };
    }


    // =================================================================================
    // --- VIII. LOGIC SẮP XẾP BẢNG ---
    // =================================================================================

    function sortTable(event, tableType) {
        const th = event.target.closest('th');
        if (!th || th.cellIndex === 0) return;

        let columnIndex = th.cellIndex;
        let sortState;
        let tableElement = th.closest('table');

        if (tableType === 'daily') {
            const date = tableElement.dataset.date;
            if (!sortStates.daily[date]) sortStates.daily[date] = { column: null, direction: 'asc' };
            sortState = sortStates.daily[date];
        } else {
            sortState = sortStates[tableType];
        }
        
        if (!sortState) return;

        if (sortState.column === columnIndex) {
            sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
        } else {
            sortState.column = columnIndex;
            sortState.direction = 'asc';
        }
        
        if (tableType === 'daily') {
            sortAndRenderDailyTable(tableElement, sortState);
        } else if (tableType === 'summary') {
            applyTab1Filters();
        }
    }

    function sortAndRenderDailyTable(table, sortState) {
        const date = table.dataset.date;
        const filteredData = getFilteredData('start-date-tab1', 'end-date-tab1');
        const dailyData = filteredData.filter(r => formatDate(r.ngay) === date);
        let dailyList = generateSummaryTableData(dailyData);
        
        sortList(dailyList, sortState, summaryColumnSortKeys);
        
        const { bodyHtml } = generateSummaryTableHTML(dailyList);
        table.querySelector('tbody').innerHTML = bodyHtml;
        updateSortIcons(table, sortState);
    }

    function sortList(list, sortState, columnKeys, defaultSortKey) {
        const { column, direction } = sortState;
        const sortInfo = column ? columnKeys[column] : defaultSortKey;

        if (!sortInfo) return;

        list.sort((a, b) => {
            let valA = typeof sortInfo.prop === 'function' ? sortInfo.prop(a) : a[sortInfo.prop];
            let valB = typeof sortInfo.prop === 'function' ? sortInfo.prop(b) : b[sortInfo.prop];

            if (valA == null) valA = sortInfo.type === 'string' ? '' : -Infinity;
            if (valB == null) valB = sortInfo.type === 'string' ? '' : -Infinity;

            let comparison = 0;
            if (sortInfo.type === 'string') {
                comparison = String(valA).localeCompare(String(valB));
            } else {
                comparison = valA - valB;
            }
            
            if (column) {
                return direction === 'asc' ? comparison : -comparison;
            }
            return comparison;
        });
    }


    function updateSortIcons(tableElement, sortState) {
      if (!tableElement) return;
      tableElement.querySelectorAll('thead th').forEach((th, index) => {
        const icon = th.querySelector('.sort-icon');
        if (!icon) return;
        icon.className = 'sort-icon'; // Reset class
        th.classList.remove('sorted');
        if (index === sortState.column) {
          th.classList.add('sorted');
          icon.classList.add(sortState.direction);
        }
      });
    }

    // =================================================================================
    // --- IX. LOGIC TAB ---
    // =================================================================================

    function openTab(evt, tabName) {
      document.getElementById(tabName).style.display = "block";
    }


    // =================================================================================
    // --- X. CÁC HÀM TIỆN ÍCH (UTILITIES) ---
    // =================================================================================
    const loader = document.getElementById('loading-overlay');
    const showLoader = () => loader.classList.add('visible');
    const hideLoader = () => loader.classList.remove('visible');

    function formatDate(dateObj) {
      if (!(dateObj instanceof Date) || isNaN(dateObj)) return '';
      return `${String(dateObj.getDate()).padStart(2, '0')}/${String(dateObj.getMonth() + 1).padStart(2, '0')}/${dateObj.getFullYear()}`;
    }

    function formatCurrency(v) {
      return Number(v || 0).toLocaleString('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 });
    }

    function formatNumber(v) { return Number(v || 0).toLocaleString('vi-VN'); }

    function formatPercent(v) {
      if (!isFinite(v)) return '0.00%';
      return `${(Number(v || 0) * 100).toFixed(2)}%`;
    }
  </script>
</body>

</html>


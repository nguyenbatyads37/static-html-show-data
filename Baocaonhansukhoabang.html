<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phiếu Bảng Lương</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .header-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .footer {
            margin-top: 30px;
            display: flex;
            justify-content: space-between;
        }
        .signature {
            text-align: center;
        }
    </style>
</head>
<body>
    <h1>PHIẾU BẢNG LƯƠNG</h1>
    
    <div class="header-info">
        <div>
            <p><strong>Đơn vị:</strong> <span id="don-vi">Công ty Giáo Dục Khoa bảng</span></p>
            <p><strong>Tháng:</strong> <span id="thang">04/2025</span></p>
        </div>
        <div>
            <p><strong>Mã phiếu:</strong> <span id="ma-phieu">PL-001</span></p>
            <p><strong>Ngày lập:</strong> <span id="ngay-lap">30/04/2025</span></p>
        </div>
    </div>
    
    <table id="bang-luong">
        <thead>
            <tr>
                <th>STT</th>
                <th>Ngày</th>
                <th>Tên Nhân sự</th>
                <th>Lớp phụ trách</th>
                <th>Chuyên cần</th>
                <th>Số giờ làm</th>
                <th>% Hoàn thành CV</th>
                <th>Tổng công việc</th>
                <th>Việc Đạt</th>
                <th>BTVN</th>
                <th>Số HS được nhận xét</th>
            </tr>
        </thead>
        <tbody id="noi-dung-bang">
            <!-- Nội dung sẽ được thêm bằng JavaScript -->
        </tbody>
    </table>
    
    <div class="footer">
        <div>
            <p><strong>Tổng số giờ làm:</strong> <span id="tong-gio">0</span></p>
        </div>
        <div class="signature">
            <p><strong>Người lập</strong></p>
            <p>(Ký, ghi rõ họ tên)</p>
            <p>........................................</p>
        </div>
    </div>

    <script>
        // Hàm chuyển đổi ngày từ MM/DD/YYYY sang đối tượng Date
        function parseCustomDate(dateStr) {
            const parts = dateStr.split('/');
            if (parts.length === 3) {
                return new Date(parts[2], parts[0] - 1, parts[1]);
            }
            return new Date(0); // Trả về ngày mặc định nếu không parse được
        }

        // Hàm lấy dữ liệu từ URL
        function getTableDataFromURL() {
            const params = new URLSearchParams(window.location.search);
            const dataParam = params.get('data');
            
            if (!dataParam) return null;
            
            try {
                // Giải mã URL và chia dữ liệu thành mảng các hàng
                const decodedData = decodeURIComponent(dataParam);
                const rows = decodedData.split('_b_')
                    .map(row => row.split('_a_'))
                    .filter(row => row.length > 1); // Lọc các hàng trống
                
                // Sắp xếp theo ngày tăng dần
                rows.sort((a, b) => {
                    const dateA = parseCustomDate(a[0].trim());
                    const dateB = parseCustomDate(b[0].trim());
                    return dateA - dateB;
                });
                
                return rows;
            } catch (e) {
                console.error("Lỗi khi parse dữ liệu:", e);
                return null;
            }
        }

        // Hàm điền dữ liệu vào bảng
        function populateTable() {
            const tableData = getTableDataFromURL();
            if (!tableData || !Array.isArray(tableData)) return;

            const tableBody = document.getElementById('noi-dung-bang');
            let totalHours = 0;

            tableData.forEach((rowData, index) => {
                const row = document.createElement('tr');
                
                // STT
                const sttCell = document.createElement('td');
                sttCell.textContent = index + 1;
                row.appendChild(sttCell);
                
                // Ánh xạ dữ liệu vào các cột
                // Cấu trúc dữ liệu mong đợi:
                // 0: Ngày, 1: Tên Nhân sự, 2: Lớp phụ trách, 3: Chuyên cần, 
                // 4: Số giờ làm, 5: % Hoàn thành CV, 6: Tổng công việc, 
                // 7: Việc Đạt, 8: BTVN, 9: Số HS được nhận xét
                const columns = [
                    rowData[0] || '', // Ngày
                    rowData[1] || '', // Tên Nhân sự
                    rowData[2] || '', // Lớp phụ trách
                    rowData[3] || '', // Chuyên cần
                    rowData[4] || '', // Số giờ làm
                    rowData[5] || '', // % Hoàn thành CV (mới thêm)
                    rowData[6] || '', // Tổng công việc
                    rowData[7] || '', // Việc Đạt
                    rowData[8] || '', // BTVN
                    rowData[9] || ''  // Số HS được nhận xét
                ];

                columns.forEach(colData => {
                    const cell = document.createElement('td');
                    cell.textContent = colData.trim();
                    
                    // Thêm ký hiệu % cho cột % Hoàn thành CV nếu có giá trị
                    if (columns.indexOf(colData) === 5 && colData.trim() !== '') {
                        cell.textContent += '%';
                    }
                    
                    row.appendChild(cell);
                });
                
                tableBody.appendChild(row);
                
                // Tính tổng giờ làm (cột Số giờ làm là rowData[4])
                const hours = parseFloat(rowData[4]) || 0;
                totalHours += hours;
            });

            // Cập nhật tổng số giờ (làm tròn 2 chữ số thập phân)
            document.getElementById('tong-gio').textContent = Math.round(totalHours * 100) / 100;
        }

        // Gọi hàm khi trang tải xong
        window.onload = populateTable;
    </script>
</body>
</html>

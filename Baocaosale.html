<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Báo cáo tổng hợp</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    /* --- CÀI ĐẶT CHUNG & TABS --- */
    body { font-family: 'Roboto', Arial, sans-serif; padding: 20px; background-color: #f4f4f4; }
    .tab-container { overflow: hidden; border-bottom: 2px solid #ccc; margin-bottom: 20px; }
    .tab-container button {
      background-color: #f1f1f1; float: left; border: none; outline: none; cursor: pointer;
      padding: 14px 20px; transition: 0.3s; font-size: 17px; font-weight: 500;
      border-radius: 8px 8px 0 0; margin-right: 5px;
    }
    .tab-container button:hover { background-color: #ddd; }
    .tab-container button.active { background-color: #2d7c2d; color: white; }
    .tab-content { display: none; padding: 6px 12px; border-top: none; }

    /* --- STYLES CHUNG CHO BẢNG & CĂN LỀ --- */
    .table-responsive-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; table-layout: auto; margin-top: 20px; background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    th, td { border: 1px solid #e0e0e0; padding: 11px 12px; white-space: nowrap; vertical-align: middle; transition: background-color 0.2s; }
    
    /* QUY TẮC CĂN LỀ: CHỮ TRÁI, SỐ PHẢI */
    th { text-align: center !important; background: #4CAF50; color: white; font-weight: 500;}
    td { text-align: right !important; }
    .text-left { text-align: left !important; }
    .text-center { text-align: center !important; }

    /* CẢI THIỆN KHẢ NĂNG ĐỌC BẢNG */
    tbody tr:nth-child(even) { background-color: #f9f9f9; }
    tbody tr:hover { background-color: #eff5fb; }
        
    /* --- STYLE CHO DÒNG TỔNG CỘNG --- */
    tr.total-row, tr.total-row:hover { 
      background: #fffde7; 
      font-weight: 700; 
      font-size: 1.05em;
      color: #333;
      border-top: 2px solid #4CAF50;
    }
    .total-label { text-align: left !important; }
    .total-value { text-align: right !important; }
    
    /* --- ĐỊNH DẠNG CÓ ĐIỀU KIỆN (MÀU ĐẬM) --- */
    .bg-green { background-color: #4CAF50 !important; color: white; }
    .bg-yellow { background-color: #FFEB3B !important; color: #424242; }
    
    /* --- STYLES BỐ CỤC SIDEBAR TRÁI --- */
    .report-container, .daily-report-layout { display: flex; flex-wrap: wrap; gap: 20px; }
    .sidebar { width: 260px; flex-shrink: 0; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .sidebar h3 { background: #2d7c2d; color: #fff; padding: 8px; margin-top: 10px; font-size: 16px; border-radius: 4px; }
    .sidebar label { display: block; margin: 8px 0; font-size: 14px; }
    .sidebar .indent { margin-left: 16px; }
    .sidebar input[type="date"] { width: 100%; box-sizing: border-box; padding: 6px; margin: 4px 0 10px; border: 1px solid #ccc; border-radius: 4px;}
    .main-detailed, .main-content { flex-grow: 1; min-width: calc(100% - 280px); }
    
    /* --- STYLES TAB 1: BÁO CÁO CHI TIẾT --- */
    .header { display: flex; align-items: center; margin-bottom: 10px; }
    .header img { height: 60px; margin-right: 15px; border-radius: 50%; }
    .header h2 { margin: 0; color: #2d7c2d; font-weight: 700; }
    .daily-breakdown h3 { margin-top: 30px; background: #f0f0f0; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }

    /* --- STYLES TAB 2: BÁO CÁO THEO NGÀY (BIỂU ĐỒ) --- */
    .main-daily h2 { color: #2d7c2d; text-align: center; margin-bottom: 20px; font-weight: 700; }
    .chart-toggle-controls { margin: 20px 0; padding: 10px; background: #eee; border-radius: 8px; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }
    .chart-toggle-controls label { font-size: 14px; cursor: pointer;}
    .chart-toggle-controls .toggle-all { font-weight: bold; }
    .charts-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 20px; }
    .chart-wrapper {
        background: #fff; padding: 15px; border-radius: 12px;
        box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        transition: opacity 0.4s ease-in-out;
    }
    .chart-wrapper canvas { width: 100% !important; height: 350px !important; }

    /* --- CHỈ BÁO ĐANG TẢI --- */
    #loading-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255, 255, 255, 0.7);
      display: flex; justify-content: center; align-items: center;
      z-index: 9999;
      font-size: 1.5em; font-weight: bold; color: #2d7c2d;
      transition: opacity 0.3s;
      visibility: hidden; opacity: 0;
    }
    #loading-overlay.visible { visibility: visible; opacity: 1; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
</head>
<body>
  
  <div id="loading-overlay">Đang tải dữ liệu...</div>

  <div class="tab-container">
    <button class="tablinks" onclick="openTab(event, 'DetailedReport')" id="defaultOpen">Báo cáo chi tiết</button>
    <button class="tablinks" onclick="openTab(event, 'DailyReport')">Báo cáo theo ngày</button>
  </div>

  <!-- TAB 1: BÁO CÁO CHI TIẾT -->
  <div id="DetailedReport" class="tab-content">
    <div class="report-container">
        <!-- Sidebar lọc bên trái -->
        <div class="sidebar">
          <h3>Ngày</h3> <label>Từ ngày:<input type="date" id="start-date-tab1"></label> <label>Đến ngày:<input type="date" id="end-date-tab1"></label>
          <h3>Sản phẩm</h3> <label><input type="checkbox" id="product-all-tab1" checked> Tất cả</label> <div id="product-options-tab1"></div>
          <h3>Ca</h3> <label><input type="checkbox" id="ca-all-tab1" checked> Tất cả</label> <div id="ca-options-tab1"></div>
          <h3>Team</h3> <label><input type="checkbox" id="team-all-tab1" checked> Tất cả</label> <div id="team-options-tab1"></div>
          <h3>Thị trường</h3> <label><input type="checkbox" id="market-all-tab1" checked> Tất cả</label> <div id="market-options-tab1"></div>
        </div>
        <!-- Nội dung chính bên phải -->
        <div class="main-detailed">
          <div class="header"> <img src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Ff930e667.%E1%BA%A2nh.025539.jpg" alt="Logo"> <h2>DỮ LIỆU TỔNG HỢP</h2> </div>
          <div class="table-responsive-container">
            <table id="summary-table">
              <thead>
                <tr>
                  <th>STT</th>
                  <th>Team</th>
                  <th>Marketing</th>
                  <th>Số Mess</th>
                  <th>Số Đơn</th>
                  <th>Phản hồi</th>
                  <th>DS Chốt</th>
                  <th>Tỉ lệ chốt</th>
                </tr>
              </thead>
              <tbody id="summary-body"></tbody>
              <tfoot id="summary-foot"></tfoot>
            </table>
          </div>
          <div id="daily-breakdown"></div>
        </div>
    </div>
  </div>

  <!-- TAB 2: BÁO CÁO THEO NGÀY -->
  <div id="DailyReport" class="tab-content">
    <div class="main-daily">
      <h2>Báo cáo hiệu suất theo ngày</h2>
      <div class="daily-report-layout">
        <!-- Sidebar lọc bên trái -->
        <div class="sidebar">
          <h3>Ngày</h3> <label>Từ ngày:<input type="date" id="start-date-tab2"></label> <label>Đến ngày:<input type="date" id="end-date-tab2"></label>
          <h3>Sản phẩm</h3> <label><input type="checkbox" id="product-all-tab2" checked> Tất cả</label> <div id="product-options-tab2"></div>
          <h3>Thị trường</h3> <label><input type="checkbox" id="market-all-tab2" checked> Tất cả</label> <div id="market-options-tab2"></div>
        </div>
        <!-- Nội dung chính bên phải -->
        <div class="main-content">
          <div class="table-responsive-container">
            <table id="date-summary-table">
              <thead> <tr> <th>Ngày</th><th>Số Mess</th><th>Số Đơn</th><th>Phản hồi</th><th>DS Chốt</th><th>Tỉ lệ chốt TB</th> </tr> </thead>
              <tbody id="date-summary-body"></tbody>
            </table>
          </div>
          <div class="chart-toggle-controls">
              <label class="toggle-all"><input type="checkbox" id="toggle-all-charts" checked> Chọn/Bỏ chọn tất cả</label>
              <label><input type="checkbox" class="chart-toggle" data-chart="soDonChart" checked> Số Đơn</label>
              <label><input type="checkbox" class="chart-toggle" data-chart="soMessChart" checked> Số Mess</label>
              <label><input type="checkbox" class="chart-toggle" data-chart="dsChotChart" checked> DS Chốt</label>
              <label><input type="checkbox" class="chart-toggle" data-chart="rateChart" checked> Tỉ lệ chốt</label>
          </div>
          <div class="charts-container">
            <div class="chart-wrapper" data-chart="soDonChart"><canvas id="soDonChart"></canvas></div>
            <div class="chart-wrapper" data-chart="soMessChart"><canvas id="soMessChart"></canvas></div>
            <div class="chart-wrapper" data-chart="dsChotChart"><canvas id="dsChotChart"></canvas></div>
            <div class="chart-wrapper" data-chart="rateChart"><canvas id="rateChart"></canvas></div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
    let rawData = [];
    let charts = {};
    const loader = document.getElementById('loading-overlay');

    const showLoader = () => loader.classList.add('visible');
    const hideLoader = () => loader.classList.remove('visible');
    
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById("defaultOpen").click();
      addEventListeners();
      setDefaultDates();
      fetchData();
    });

    function setDefaultDates() {
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        const formatDateForInput = (date) => date.toISOString().split('T')[0];
        document.getElementById('start-date-tab1').value = formatDateForInput(firstDay);
        document.getElementById('end-date-tab1').value = formatDateForInput(lastDay);
        document.getElementById('start-date-tab2').value = formatDateForInput(firstDay);
        document.getElementById('end-date-tab2').value = formatDateForInput(lastDay);
    }

    function openTab(evt, tabName) {
      document.querySelectorAll(".tab-content").forEach(tc => tc.style.display = "none");
      document.querySelectorAll(".tablinks").forEach(tl => tl.classList.remove("active"));
      document.getElementById(tabName).style.display = "block";
      evt.currentTarget.classList.add("active");
      if (tabName === 'DailyReport' && !charts.dsChotChart) { 
          initAllCharts(); 
          applyDailyFilters(); 
      }
    }

    function addEventListeners() {
      document.body.addEventListener('change', (e) => {
        if (e.target.closest('#DetailedReport')) { handleTab1Filters(e.target); }
        else if (e.target.closest('#DailyReport')) { handleTab2Filters(e.target); }
      });
    }
    
    function fetchData() {
        showLoader();
        fetch('https://script.google.com/macros/s/AKfycbzd8KdWC7PVuv7ttnQLV7oIxmAgWWdLfs3laMDoL7w5GhvCWd_71_Xc33e-GaUSiG_3/exec')
        .then(res => res.json())
        .then(data => {
          // 1. LỌC BỎ DỮ LIỆU CÓ TRANGTHAI TRỐNG
          const filteredByStatus = data.filter(r => r.trangThai && String(r.trangThai).trim() !== '');

          // 2. ÁNH XẠ DỮ LIỆU TỪ NGUỒN VÀO BIẾN NỘI BỘ
          rawData = filteredByStatus.map(r => ({
              ...r, 
              
              // Ánh xạ các trường số liệu theo yêu cầu
              soMessCmt: +r.soMess || 0,
              soDon: +r.donMess || 0,
              dsChot: +r.doanhSoMess || 0,
              phanHoi: +r.phanHoi || 0,
              
              // *** GIẢI PHÁP CHO VẤN ĐỀ `team` ***
              // Thử lấy `r.team`, nếu không có thì thử `r.Team`, nếu vẫn không có thì gán là 'Khác'
              team: r.team || r.Team || 'Khác',
              
              ten: r.ten || 'N/A'
            }));

          populateAllFilters(rawData);
          applyTab1Filters();
          if (document.getElementById('DailyReport').style.display === 'block') { 
            applyDailyFilters(); 
          }
        }).catch(err => { 
          console.error("Lỗi khi tải dữ liệu:", err); 
          alert('Không thể tải dữ liệu. Vui lòng kiểm tra lại đường link hoặc kết nối mạng.'); 
        }).finally(() => {
          hideLoader();
        });
    }
    
    function getFilteredData(filterIds) {
        const { startDateId, endDateId, productCbId, productOptionsClass, marketCbId, marketOptionsClass, caCbId, caOptionsClass, teamCbId, teamOptionsClass } = filterIds;
        const sdVal = document.getElementById(startDateId).value, edVal = document.getElementById(endDateId).value;
        const sd = sdVal ? new Date(sdVal) : null, ed = edVal ? new Date(edVal) : null;
        if (ed) ed.setHours(23, 59, 59, 999);
        const pAll = document.getElementById(productCbId).checked, selP = pAll ? null : [...document.querySelectorAll(`.${productOptionsClass}:checked`)].map(cb => cb.value);
        const mAll = document.getElementById(marketCbId).checked, selM = mAll ? null : [...document.querySelectorAll(`.${marketOptionsClass}:checked`)].map(cb => cb.value);
        const cAll = caCbId ? document.getElementById(caCbId).checked : true, selCa = caCbId && !cAll ? [...document.querySelectorAll(`.${caOptionsClass}:checked`)].map(cb => cb.value) : null;
        const tAll = teamCbId ? document.getElementById(teamCbId).checked : true, selT = tAll ? null : [...document.querySelectorAll(`.${teamOptionsClass}:checked`)].map(cb => cb.value);
        return rawData.filter(r => {
            const d = new Date(r.ngay);
            const isDateOk = (!sd || d >= sd) && (!ed || d <= ed);
            const isProductOk = !selP || selP.includes(r.sanPham);
            const isMarketOk = !selM || selM.includes(r.thiTruong);
            const isCaOk = !selCa || selCa.includes(r.ca);
            const isTeamOk = !selT || selT.includes(r.team);
            return isDateOk && isProductOk && isMarketOk && isCaOk && isTeamOk;
        });
    }

    function populateAllFilters(data) {
        const prodSet=new Set(), caSet=new Set(), teamSet=new Set(), mktSet=new Set();
        data.forEach(r=>{ 
            if(r.sanPham) prodSet.add(r.sanPham); 
            if(r.ca) caSet.add(r.ca); 
            if(r.team) teamSet.add(r.team);
            if(r.thiTruong) mktSet.add(r.thiTruong); 
        });
        
        document.getElementById('product-options-tab1').innerHTML = Array.from(prodSet).sort().map(p => `<label class='indent'><input type='checkbox' class='filter-product-tab1' value='${p}' checked> ${p}</label>`).join('');
        document.getElementById('product-options-tab2').innerHTML = document.getElementById('product-options-tab1').innerHTML.replaceAll('filter-product-tab1', 'filter-product-tab2');
        
        document.getElementById('market-options-tab1').innerHTML = Array.from(mktSet).sort().map(m => `<label class='indent'><input type='checkbox' class='filter-market-tab1' value='${m}' checked> ${m}</label>`).join('');
        document.getElementById('market-options-tab2').innerHTML = document.getElementById('market-options-tab1').innerHTML.replaceAll('filter-market-tab1', 'filter-market-tab2');

        document.getElementById('ca-options-tab1').innerHTML = Array.from(caSet).sort().map(c => `<label class='indent'><input type='checkbox' class='filter-ca-tab1' value='${c}' checked> ${c}</label>`).join('');
        document.getElementById('team-options-tab1').innerHTML = Array.from(teamSet).sort().map(t => `<label class='indent'><input type='checkbox' class='filter-team-tab1' value='${t}' checked> ${t}</label>`).join('');
    }
    
    // --- Các hàm tiện ích ---
    function formatDate(v) { const d = new Date(v); if (isNaN(d)) return v; return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`; }
    function formatCurrency(v) { return Number(v||0).toLocaleString('vi-VN',{style:'currency',currency:'VND'}); }
    function formatNumber(v) { return Number(v||0).toLocaleString('vi-VN'); }
    function formatPercent(v) { if (v === null || v === undefined || !isFinite(v)) return '0.00%'; return `${(Number(v||0) * 100).toFixed(2)}%`; }
    function handleCheckbox(masterId, childClass, target) { if (target.id === masterId) { document.querySelectorAll(`.${childClass}`).forEach(cb => cb.checked = target.checked); } else if (target.classList.contains(childClass)) { document.getElementById(masterId).checked = [...document.querySelectorAll(`.${childClass}`)].every(cb => cb.checked); } }

    function handleTab1Filters(target) { showLoader(); setTimeout(() => { handleCheckbox('product-all-tab1', 'filter-product-tab1', target); handleCheckbox('ca-all-tab1', 'filter-ca-tab1', target); handleCheckbox('team-all-tab1', 'filter-team-tab1', target); handleCheckbox('market-all-tab1', 'filter-market-tab1', target); applyTab1Filters(); hideLoader(); }, 10); }
    
    function applyTab1Filters() {
        const filterIds = { startDateId: 'start-date-tab1', endDateId: 'end-date-tab1', productCbId: 'product-all-tab1', productOptionsClass: 'filter-product-tab1', marketCbId: 'market-all-tab1', marketOptionsClass: 'filter-market-tab1', caCbId: 'ca-all-tab1', caOptionsClass: 'filter-ca-tab1', teamCbId: 'team-all-tab1', teamOptionsClass: 'filter-team-tab1' };
        const filtered = getFilteredData(filterIds);
        renderSummary(filtered); 
        renderDailyBreakdown(filtered);
    }

    function renderSummary(data) {
        const summaryData = {};
        let total = { mess: 0, don: 0, chot: 0, phanHoi: 0 };
        data.forEach(r => {
            const name = r.ten;
            if (!summaryData[name]) {
                summaryData[name] = { team: r.team, mess: 0, don: 0, chot: 0, phanHoi: 0 };
            }
            summaryData[name].mess += r.soMessCmt;
            summaryData[name].don += r.soDon;
            summaryData[name].chot += r.dsChot;
            summaryData[name].phanHoi += r.phanHoi;
        });

        const flatList = Object.keys(summaryData).map(name => ({ name, team: summaryData[name].team, data: summaryData[name] }))
            .sort((a,b) => (a.team || 'zzz').localeCompare(b.team || 'zzz') || a.name.localeCompare(b.name));
        
        let bodyHtml = flatList.map((item, index) => {
            const s = item.data;
            Object.keys(total).forEach(key => total[key] += s[key]);
            const rate = s.mess ? s.don / s.mess : 0;
            const rateClass = rate > 0.1 ? 'bg-green' : (rate > 0 ? 'bg-yellow' : '');

            return `<tr><td class="text-center">${index + 1}</td>
                <td class="text-left">${item.team}</td>
                <td class="text-left">${item.name}</td>
                <td>${formatNumber(s.mess)}</td>
                <td>${formatNumber(s.don)}</td>
                <td>${formatNumber(s.phanHoi)}</td>
                <td>${formatCurrency(s.chot)}</td>
                <td class="${rateClass}">${formatPercent(rate)}</td></tr>`;
        }).join('');
        document.getElementById('summary-body').innerHTML = bodyHtml;

        const totalRate = total.mess ? total.don / total.mess : 0;
        
        const footerHtml = `<tr class="total-row">
                <td class="total-label" colspan="3">TỔNG CỘNG</td>
                <td class="total-value">${formatNumber(total.mess)}</td>
                <td class="total-value">${formatNumber(total.don)}</td>
                <td class="total-value">${formatNumber(total.phanHoi)}</td>
                <td class="total-value">${formatCurrency(total.chot)}</td>
                <td class="total-value">${formatPercent(totalRate)}</td></tr>`;
        document.getElementById('summary-foot').innerHTML = footerHtml;
    }
    
    function renderDailyBreakdown(data) { 
        const container = document.getElementById('daily-breakdown'); 
        container.innerHTML = '';
        const groupedByDate = {};
        data.forEach(r => {
            const dateKey = formatDate(r.ngay);
            if (!groupedByDate[dateKey]) groupedByDate[dateKey] = [];
            groupedByDate[dateKey].push(r);
        });
        
        Object.keys(groupedByDate).sort((a,b)=>new Date(b.split('/').reverse().join('-'))-new Date(a.split('/').reverse().join('-'))).forEach(date=>{
            let total = { mess: 0, don: 0, chot: 0, phanHoi: 0 };
            const sortedDailyData = groupedByDate[date].sort((a, b) => (a.team || 'zzz').localeCompare(b.team || 'zzz'));
            
            const rowsHtml = sortedDailyData.map(r=>{
                total.mess += r.soMessCmt;
                total.don += r.soDon;
                total.chot += r.dsChot;
                total.phanHoi += r.phanHoi;
                return`<tr>
                        <td class="text-center">${r.id}</td><td class="text-left">${r.ten}</td>
                        <td class="text-left">${r.ca}</td><td class="text-left">${r.page}</td>
                        <td class="text-left">${r.sanPham}</td><td class="text-left">${r.thiTruong}</td>
                        <td>${formatNumber(r.soMessCmt)}</td><td>${formatNumber(r.soDon)}</td>
                        <td>${formatNumber(r.phanHoi)}</td><td>${formatCurrency(r.dsChot)}</td>
                        <td class="text-left">${r.team}</td></tr>`
            }).join('');

            const footHtml=`<tr class='total-row'>
                            <td colspan='6' class='total-label'>Tổng</td>
                            <td class='total-value'>${formatNumber(total.mess)}</td>
                            <td class='total-value'>${formatNumber(total.don)}</td>
                            <td class='total-value'>${formatNumber(total.phanHoi)}</td>
                            <td class='total-value'>${formatCurrency(total.chot)}</td>
                            <td></td></tr>`;
            const tableHtml = `<div class="table-responsive-container"><table><thead><tr><th>ID</th><th>Tên</th><th>Ca</th><th>Page</th><th>Sản phẩm</th><th>Thị trường</th><th>Mess</th><th>Đơn</th><th>Phản hồi</th><th>DS Chốt</th><th>Team</th></tr></thead><tbody>${rowsHtml}</tbody><tfoot>${footHtml}</tfoot></table></div>`;
            container.innerHTML += `<h3>${date}</h3>${tableHtml}`;
        }); 
    }

    function handleTab2Filters(target) { 
        showLoader(); 
        setTimeout(() => { 
            if (target.id === 'toggle-all-charts' || target.classList.contains('chart-toggle')) { 
                if (target.id === 'toggle-all-charts') document.querySelectorAll('.chart-toggle').forEach(cb => cb.checked = target.checked);
                else document.getElementById('toggle-all-charts').checked = [...document.querySelectorAll('.chart-toggle')].every(cb => cb.checked); 
                toggleChartVisibility(); 
                hideLoader(); 
                return; 
            } 
            handleCheckbox('product-all-tab2', 'filter-product-tab2', target); 
            handleCheckbox('market-all-tab2', 'filter-market-tab2', target); 
            applyDailyFilters(); 
            hideLoader(); 
        }, 10); 
    }

    function applyDailyFilters() { 
        if (!rawData.length) return; 
        const filterIds = { startDateId: 'start-date-tab2', endDateId: 'end-date-tab2', productCbId: 'product-all-tab2', productOptionsClass: 'filter-product-tab2', marketCbId: 'market-all-tab2', marketOptionsClass: 'filter-market-tab2' }; 
        const filtered = getFilteredData(filterIds); 
        renderDailyTable(filtered); 
        renderAllDailyCharts(filtered); 
    }

    function renderDailyTable(data) { 
        const daily = {}; 
        data.forEach(r => { 
            const dateKey = formatDate(r.ngay); 
            if (!daily[dateKey]) daily[dateKey] = { phanHoi: 0, don: 0, mess: 0, chot: 0 }; 
            daily[dateKey].phanHoi += r.phanHoi; 
            daily[dateKey].don += r.soDon; 
            daily[dateKey].mess += r.soMessCmt; 
            daily[dateKey].chot += r.dsChot; 
        }); 
        
        let tbodyHtml = Object.keys(daily).sort((a,b) => new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-'))).map(d => { 
            const day = daily[d]; 
            const avgRate = day.mess ? day.don / day.mess : 0; 
            return `<tr>
                        <td class="text-left"><b>${d}</b></td>
                        <td>${formatNumber(day.mess)}</td>
                        <td>${formatNumber(day.don)}</td>
                        <td>${formatNumber(day.phanHoi)}</td>
                        <td>${formatCurrency(day.chot)}</td>
                        <td>${formatPercent(avgRate)}</td>
                    </tr>`; 
        }).join(''); 
        document.getElementById('date-summary-body').innerHTML = tbodyHtml; 
    }

    function toggleChartVisibility() { 
        document.querySelectorAll('.chart-toggle').forEach(checkbox => { 
            const chartName = checkbox.dataset.chart; 
            const wrapper = document.querySelector(`.chart-wrapper[data-chart="${chartName}"]`); 
            if (wrapper) { 
                wrapper.style.display = checkbox.checked ? 'block' : 'none'; 
            } 
        }); 
    }
    
    // --- Các hàm khởi tạo và cập nhật biểu đồ ---
    function initAllCharts() {
        const createChart = (ctxId, config) => new Chart(document.getElementById(ctxId).getContext('2d'), config);
        charts.soDonChart = createChart('soDonChart', getLineChartConfig('Số Đơn', v => formatNumber(v))); 
        charts.soMessChart = createChart('soMessChart', getLineChartConfig('Số Mess', v => formatNumber(v))); 
        charts.dsChotChart = createChart('dsChotChart', getLineChartConfig('DS Chốt (VND)', v => formatCurrency(v))); 
        charts.rateChart = createChart('rateChart', getLineChartConfig('Tỉ lệ chốt (%)', v => formatPercent(v))); 
        toggleChartVisibility();
    }
    
    function renderAllDailyCharts(data) {
        if (!Object.keys(charts).length) return;
        const daily = {}; 
        data.forEach(r => { 
            const dateKey = formatDate(r.ngay); 
            if (!daily[dateKey]) daily[dateKey] = { don: 0, mess: 0, chot: 0 }; 
            daily[dateKey].don += r.soDon; 
            daily[dateKey].mess += r.soMessCmt; 
            daily[dateKey].chot += r.dsChot; 
        });
        const labels = Object.keys(daily).sort((a,b) => new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-')));
        
        updateChart(charts.soDonChart, 'Số Đơn', labels, labels.map(d => daily[d].don), '#3F51B5');
        updateChart(charts.soMessChart, 'Số Mess', labels, labels.map(d => daily[d].mess), '#009688');
        updateChart(charts.dsChotChart, 'DS Chốt', labels, labels.map(d => daily[d].chot), '#4CAF50');
        updateChart(charts.rateChart, 'Tỉ lệ chốt', labels, labels.map(d => daily[d].mess ? (daily[d].don / daily[d].mess) : 0), '#F44336');
    }

    function getLineChartConfig(yTitle, formatter) { 
        return { 
            type: 'line', 
            options: { 
                responsive: true, maintainAspectRatio: false, 
                plugins: { 
                    legend: { display: false }, 
                    tooltip: { callbacks: { label: (ctx) => `${yTitle}: ${formatter(ctx.raw)}` } }, 
                    datalabels: { display: false } 
                }, 
                scales: { 
                    y: { 
                        title: { display: true, text: yTitle }, 
                        ticks: { callback: formatter } 
                    } 
                } 
            } 
        }; 
    }
    
    function updateChart(chart, label, labels, data, color) { 
        chart.data.labels = labels; 
        chart.data.datasets = [{ 
            label: label, 
            data: data, 
            borderColor: color,
            backgroundColor: color + '33', // Add alpha for fill
            fill: true, 
            tension: 0.3,
            borderWidth: 2,
            pointRadius: 3,
            pointBackgroundColor: color
        }]; 
        chart.update('none'); 
    }
</script>
</body>
</html>

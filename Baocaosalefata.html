<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Kama Business Report</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    /* --- GENERAL SETUP & TABS --- */
    body {
      font-family: 'Roboto', Arial, sans-serif;
      padding: 20px;
      background-color: #f4f4f4;
      color: #333;
      /* --- CHANGE: Larger and bolder font --- */
      font-size: 17px;
      font-weight: 700;
    }
    /* .tab-container CSS REMOVED AS IT'S NO LONGER IN HTML */
    .tab-content {
      display: block !important; /* Ensure content is displayed immediately */
      padding: 6px 12px;
      border-top: none;
      animation: fadeIn 0.5s;
    }
    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }
    /* --- GENERAL TABLE & ALIGNMENT STYLES --- */
    .table-responsive-container {
      overflow-x: auto;
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: auto;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    th,
    td {
      border: 1px solid #e0e0e0;
      padding: 14px 16px; /* Increase padding */
      white-space: nowrap;
      vertical-align: middle;
      transition: background-color 0.2s;
       /* --- CHANGE: Larger font size --- */
      font-size: 16px;
    }
    th {
      text-align: center !important;
      font-size: 17px; /* Increase size */
    }
    .text-left {
      text-align: left !important;
    }
    .text-center {
      text-align: center !important;
    }
    .marketing-name, .sale-name {
      font-weight: 700;
      color: #00008B;
    }
    .department-name {
      font-weight: 500;
      color: #555;
    }
    tbody tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    tbody tr:not(.team-header-row):not(.total-row):not(.highlight):hover {
      background-color: #eff5fb;
    }
    th.green-header, th.blue-header {
      background: #4CAF50;
      color: white;
      font-weight: 700;
    }
    th.yellow-header {
      background: #FFC107;
      color: #424242;
      font-weight: 700;
    }
    tr.total-row,
    tr.total-row:hover {
      background: #2d7c2d;
      color: white;
      font-weight: 700;
      font-size: 1.25em; /* Increase size */
      border-bottom: 3px solid #FFC107;
    }
    .total-row .total-label {
      text-transform: uppercase;
      text-align: left !important;
    }
    .total-row .total-value {
      text-align: right !important;
    }
    /* --- STYLES FOR TABS & GENERAL LAYOUT --- */
    .report-container {
      display: flex;
      gap: 20px;
    }
    .sidebar {
      width: 260px;
      flex-shrink: 0;
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    .sidebar h3 {
      background: #2d7c2d;
      color: #fff;
      padding: 12px;
      margin-top: 10px;
      font-size: 20px; /* Increase size */
      border-radius: 4px;
      font-weight: 700;
    }
    .sidebar label {
      display: block;
      margin: 10px 0; /* Increase margin */
      font-size: 16px; /* Increase size */
      cursor: pointer;
    }
    .sidebar input[type="date"],
    .sidebar input[type="text"] {
      width: 100%;
      box-sizing: border-box;
      padding: 10px;
      margin: 4px 0 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 16px; /* Increase size */
    }
    /* --- NEW: Quick filter CSS --- */
    .quick-filters {
        margin-top: 20px;
        border-top: 1px solid #eee;
        padding-top: 15px;
    }
    .quick-filters button {
        width: 100%;
        padding: 10px;
        margin-bottom: 8px;
        background-color: #f0f0f0;
        border: 1px solid #ccc;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 700;
        font-size: 15px;
        transition: background-color 0.2s, color 0.2s;
    }
    .quick-filters button:hover {
        background-color: #2d7c2d;
        color: white;
    }
    .main-content-area {
      flex-grow: 1;
    }
    .header {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    .header img {
      height: 80px;
      margin-right: 20px;
    }
    .header h2 {
      margin: 0;
      color: #2d7c2d;
      font-weight: 700;
      font-size: 30px; /* Increase size */
    }
    /* --- LOADING INDICATOR --- */
    #loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      font-size: 1.8em; /* Increase size */
      font-weight: bold;
      color: #2d7c2d;
      transition: opacity 0.3s, visibility 0.3s;
      visibility: hidden;
      opacity: 0;
    }
    #loading-overlay.visible {
      visibility: visible;
      opacity: 1;
    }
    /* --- TABLE SORTING CSS --- */
    .sortable-table th {
      cursor: pointer;
      position: relative;
    }
    .sortable-table th .sort-icon {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.8em;
      opacity: 0.4;
      transition: opacity 0.2s;
    }
    .sortable-table th:hover .sort-icon {
      opacity: 0.8;
    }
    .sortable-table th.sorted .sort-icon {
      opacity: 1;
    }
    .sortable-table th .sort-icon.asc::after { content: " ▲"; }
    .sortable-table th .sort-icon.desc::after { content: " ▼"; }
    .daily-breakdown h3 {
      margin-top: 30px;
      background: #f0f0f0;
      padding: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 20px; /* Increase size */
      font-weight: 700;
    }
  </style>
</head>
<body>
  <div id="loading-overlay">Loading data...</div>
  <!-- TAB 1: DETAILED REPORT -->
  <div id="DetailedReport" class="tab-content">
    <div class="report-container">
      <div class="sidebar">
        <h3>Filters</h3>
        <label for="start-date-tab1">Start Date:</label><input type="date" id="start-date-tab1">
        <label for="end-date-tab1">End Date:</label><input type="date" id="end-date-tab1">

        <!-- NEW: Quick filters -->
        <div class="quick-filters">
            <button id="btn-today">Today</button>
            <button id="btn-yesterday">Yesterday</button>
            <button id="btn-this-week">This Week</button>
            <button id="btn-last-week">Last Week</button>
        </div>
      </div>
      <div class="main-content-area">
        <div class="header">
          <img
            src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Fd3e93e8d.%E1%BA%A2nh.121830.png"
            alt="Logo">
          <h2 id="report-title-tab1">Kama Business Report</h2>
        </div>
        <div class="table-responsive-container">
          <table id="summary-table" class="sortable-table">
            <thead>
              <tr>
                <th class="green-header">No.<span class="sort-icon"></span></th>
                <th class="green-header">Sale<span class="sort-icon"></span></th>
                <th class="green-header">Department<span class="sort-icon"></span></th>
                <th class="green-header">Data Count<span class="sort-icon"></span></th>
                <th class="green-header">Closed Orders<span class="sort-icon"></span></th>
                <th class="green-header">Old Customers<span class="sort-icon"></span></th>
                <th class="green-header">Total Customers<span class="sort-icon"></span></th>
                <th class="blue-header">New Revenue<span class="sort-icon"></span></th>
                <th class="blue-header">Old Revenue<span class="sort-icon"></span></th>
                <!-- NEW: Other Revenue -->
                <th class="blue-header">Other Revenue<span class="sort-icon"></span></th> 
                <th class="blue-header">Total Revenue<span class="sort-icon"></span></th>
                <!-- Moved: Paid Amount -->
                <th class="blue-header">Paid Amount<span class="sort-icon"></span></th> 
                <th class="yellow-header">Close Rate %<span class="sort-icon"></span></th>
                <th class="yellow-header">Avg. Order Value<span class="sort-icon"></span></th>
              </tr>
            </thead>
            <tbody id="summary-body"></tbody>
          </table>
        </div>
        <div id="daily-breakdown"></div>
      </div>
    </div>
  </div>
  <script>
    // =================================================================================
    // --- I. GLOBAL VARIABLES & CONFIGURATION ---
    // =================================================================================
    const API_URL_REVENUE = 'https://script.google.com/macros/s/AKfycbzq298F76ScFgSvb-FIVpH6DL3vZLwHfbc75h1xyUM6Dt-Dl6PdGiJDbNnakt5c5xx4/exec';
    const API_URL_DATA_COUNT = 'https://script.google.com/macros/s/AKfycbys7V-NQdQhTLwnbU95FKvxZV4CXr4wql0uNwG2KoYLi-jrNBTUN6-s0t4_7kGKg3tl/exec';
    const API_URL_STAFF = 'https://script.google.com/macros/s/AKfycbxffPZlYiyRsoIyz82McL8-fsvaSv6OVVZnKmyeP-IJpswodOP58n8g_V7ZD2XLIBI-/exec?table=nhan-su';

    let masterData = [];
    let staffDataMap = {}; 
    let allowedSalesNames = []; // List of Sale names allowed (after filtering by URL ID)
    
    const sortStates = {
      summary: { column: 2, direction: 'asc' }, // Default: Department (index 2)
      daily: {}
    };
    // UPDATED column indices and formulas to include doanhSoBanCheo (index 9)
    const summaryColumnSortKeys = {
      1: { prop: 'name', type: 'string' }, // Sale
      2: { prop: 'department', type: 'string' }, // Department
      3: { prop: 'soData', type: 'number' },
      4: { prop: 'donChot', type: 'number' },
      5: { prop: 'khachCu', type: 'number' },
      6: { prop: (s) => s.donChot + s.khachCu, type: 'number' }, // Total Customers
      7: { prop: 'doanhThu', type: 'number' }, // New Revenue
      8: { prop: 'doanhThuKhachCu', type: 'number' }, // Old Revenue
      9: { prop: 'doanhSoBanCheo', type: 'number' }, // NEW: Other Revenue
      10: { prop: (s) => s.doanhThu + s.doanhThuKhachCu + s.doanhSoBanCheo, type: 'number' }, // Total Revenue (UPDATED FORMULA, MOVED)
      11: { prop: 'paidAmount', type: 'number' }, // Paid Amount (MOVED)
      12: { prop: (s) => s.soData ? s.donChot / s.soData : 0, type: 'number' }, // Close Rate (MOVED)
      13: { prop: (s) => (s.donChot + s.khachCu) > 0 ? (s.doanhThu + s.doanhThuKhachCu + s.doanhSoBanCheo) / (s.donChot + s.khachCu) : 0, type: 'number' } // Avg. Order Value (UPDATED FORMULA, MOVED)
    };
    // =================================================================================
    // --- II. APPLICATION INITIALIZATION ---
    // =================================================================================
    document.addEventListener('DOMContentLoaded', () => {
      setupEventListeners();
      setDefaultDates();
      fetchAndProcessData();
    });
    function setDefaultDates() {
      const today = new Date();
      const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
      const formatDateForInput = (date) => date.toISOString().split('T')[0];
      document.getElementById('start-date-tab1').value = formatDateForInput(firstDay);
      document.getElementById('end-date-tab1').value = formatDateForInput(today); 
    }
    function setupEventListeners() {
      document.getElementById('start-date-tab1').addEventListener('change', handleFilterChange);
      document.getElementById('end-date-tab1').addEventListener('change', handleFilterChange);
      document.getElementById('summary-table').querySelector('thead').addEventListener('click', (e) => sortTable(e, 'summary'));
      document.getElementById('daily-breakdown').addEventListener('click', (e) => {
        if (e.target.closest('th')) {
          sortTable(e, 'daily');
        }
      });

      // --- NEW: Event listeners for quick filters ---
      document.getElementById('btn-today').addEventListener('click', () => setQuickFilterDates('today'));
      document.getElementById('btn-yesterday').addEventListener('click', () => setQuickFilterDates('yesterday'));
      document.getElementById('btn-this-week').addEventListener('click', () => setQuickFilterDates('this-week'));
      document.getElementById('btn-last-week').addEventListener('click', () => setQuickFilterDates('last-week'));
    }
    // =================================================================================
    // --- III. DATA FETCHING AND PROCESSING ---
    // =================================================================================
    async function fetchAndProcessData() {
        showLoader();
        try {
            const [revenueResponse, dataCountResponse, staffResponse] = await Promise.all([
                fetch(API_URL_REVENUE),
                fetch(API_URL_DATA_COUNT),
                fetch(API_URL_STAFF) 
            ]);
            const revenueResult = await revenueResponse.json();
            const dataCountResult = await dataCountResponse.json();
            const staffResult = await staffResponse.json(); 

            // GET ID FROM URL
            const userIdFilter = getUrlParameter('id'); 
            let filteredStaffData = staffResult.data || [];

            // FILTER STAFF DATA BY ID (If ID is present in URL)
            if (userIdFilter) {
                // ASSUMING: the ID column in the nhan-su data is "ID"
                filteredStaffData = filteredStaffData.filter(r => (r["ID"] || '').toString() === userIdFilter);
            }

            // Process staff data to create staffDataMap AND allowedSalesNames
            // NOTE: Using "Họ và Tên" (Full Name) from the staff list to match the "Sale" column in revenue/data
            allowedSalesNames = filteredStaffData.map(r => (r["Họ và Tên"] || '').trim()).filter(name => name); 
            
            staffDataMap = filteredStaffData.reduce((map, r) => {
                const name = (r["Họ và Tên"] || '').trim();
                const department = (r["Phòng ban"] || 'N/A').trim();
                if (name) {
                    map[name] = department;
                }
                return map;
            }, {});

            const revenueData = (revenueResult.data || []).map(r => {
                const isSuccessfulOrder = (r["TRẠNG THÁI"] === "Success" && r["TRẠNG THÁI VẬN ĐƠN"] !== "Hủy");
                const isOldCustomerOrder = (r["TRẠNG THÁI"] === "Success (old customer)" && r["TRẠNG THÁI VẬN ĐƠN"] !== "Hủy");
                
                const paidAmount = Number(r["Đã thanh toán"]) || 0; 
                // NEW: Get cross-sell price value (ASSUMING KEY IS "GIÁ BÁN CHÉO")
                const doanhSoBanCheo = Number(r["GIÁ BÁN CHÉO"]) || 0; 

                return {
                    name: (r["Sale"] || 'N/A').trim(), 
                    ngay: new Date(r["NGÀY GIỜ"]),
                    donChot: isSuccessfulOrder ? 1 : 0,
                    doanhThu: isSuccessfulOrder ? (Number(r["GIÁ"]) || 0) : 0,
                    soData: 0, 
                    khachCu: isOldCustomerOrder ? 1 : 0,
                    doanhThuKhachCu: isOldCustomerOrder ? (Number(r["GIÁ"]) || 0) : 0,
                    paidAmount: paidAmount, 
                    doanhSoBanCheo: doanhSoBanCheo 
                };
            });
            const dataCountData = (dataCountResult.data || []).map(r => ({
                name: (r["Sale"] || 'N/A').trim(), 
                ngay: new Date(r["NGÀY"]), 
                donChot: 0,
                doanhThu: 0,
                soData: 1, 
                khachCu: 0,
                doanhThuKhachCu: 0,
                paidAmount: 0, 
                doanhSoBanCheo: 0 
            }));
            
            masterData = [...revenueData, ...dataCountData].filter(r =>
                r.name !== 'N/A' && r.ngay instanceof Date && !isNaN(r.ngay)
            );

            // Assign Department to master data
            masterData.forEach(r => {
                r.department = staffDataMap[r.name] || 'N/A';
            });

            // FILTER MASTER DATA BASED ON allowedSalesNames (if ID was in URL)
            if (userIdFilter) {
                masterData = masterData.filter(r => allowedSalesNames.includes(r.name));
            }
            
            applyTab1Filters();
        } catch (err) {
            console.error("Error loading data:", err);
            alert('Could not load data from API. Please check the connection.');
            document.getElementById('report-title-tab1').textContent = 'ERROR LOADING DATA';
        } finally {
            hideLoader();
        }
    }
    // =================================================================================
    // --- IV. EVENT HANDLING AND FILTERS ---
    // =================================================================================
    function handleFilterChange() {
      showLoader();
      setTimeout(() => {
        applyTab1Filters();
        hideLoader();
      }, 50);
    }
    function getFilteredData(startDateId, endDateId) {
      const startDateVal = document.getElementById(startDateId).value;
      const endDateVal = document.getElementById(endDateId).value;
      
      const startDate = startDateVal ? new Date(startDateVal) : null;
      if (startDate) startDate.setHours(0, 0, 0, 0);
      const endDate = endDateVal ? new Date(endDateVal) : null;
      if (endDate) endDate.setHours(23, 59, 59, 999);
      if ((startDate && isNaN(startDate)) || (endDate && isNaN(endDate))) return [];
      
      return masterData.filter(r => {
        const recordDate = r.ngay;
        return (!startDate || recordDate >= startDate) && (!endDate || recordDate <= endDate);
      });
    }

    // --- NEW: Quick filter handler ---
    function setQuickFilterDates(period) {
        const today = new Date();
        let startDate, endDate;

        switch (period) {
            case 'today':
                startDate = today;
                endDate = today;
                break;
            case 'yesterday':
                startDate = new Date();
                startDate.setDate(today.getDate() - 1);
                endDate = startDate;
                break;
            case 'this-week':
                startDate = new Date();
                const dayOfWeek = today.getDay(); // 0 = Sunday, 1 = Monday, ...
                const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); // adjust when day is sunday
                startDate.setDate(diff);
                endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 6);
                break;
            case 'last-week':
                startDate = new Date();
                startDate.setDate(today.getDate() - today.getDay() - 6);
                endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 6);
                break;
        }

        const formatDateForInput = (date) => date.toISOString().split('T')[0];
        document.getElementById('start-date-tab1').value = formatDateForInput(startDate);
        document.getElementById('end-date-tab1').value = formatDateForInput(endDate);
        
        // Trigger filter
        handleFilterChange();
    }
    // =================================================================================
    // --- V. FILTER APPLICATION FUNCTIONS ---
    // =================================================================================
    function applyTab1Filters() {
      const filteredData = getFilteredData('start-date-tab1', 'end-date-tab1');
      const summaryList = generateSummaryTableData(filteredData);
      
      // Default sort: Column 2 (Department), then Name (Column 1)
      const defaultSortInfo = { column: 2, direction: 'asc' };
      sortList(summaryList, sortStates.summary, summaryColumnSortKeys, defaultSortInfo); 
      
      renderSummary(summaryList);
      updateSortIcons(document.getElementById('summary-table'), sortStates.summary);
      renderDailyBreakdown(filteredData);
    }
    // =================================================================================
    // --- VI. DATA AGGREGATION AND CALCULATION FUNCTIONS ---
    // =================================================================================
    function generateSummaryTableData(data) {
      const summary = {};
      data.forEach(r => {
        const key = r.name;
        if (!summary[key]) {
          summary[key] = { 
            name: r.name, 
            department: r.department, 
            soData: 0, 
            donChot: 0, 
            doanhThu: 0, 
            khachCu: 0, 
            doanhThuKhachCu: 0,
            paidAmount: 0, 
            doanhSoBanCheo: 0 
          };
        }
        const S = summary[key];
        S.soData += r.soData;
        S.donChot += r.donChot;
        S.doanhThu += r.doanhThu;
        S.khachCu += r.khachCu; 
        S.doanhThuKhachCu += r.doanhThuKhachCu; 
        S.paidAmount += r.paidAmount; 
        S.doanhSoBanCheo += r.doanhSoBanCheo; 
      });
      return Object.values(summary);
    }
    // =================================================================================
    // --- VII. DATA RENDERING FUNCTIONS ---
    // =================================================================================
    function renderSummary(dataList) {
      const { bodyHtml } = generateSummaryTableHTML(dataList);
      document.getElementById('summary-body').innerHTML = bodyHtml;
    }
    function renderDailyBreakdown(filteredData) {
      const container = document.getElementById('daily-breakdown');
      container.innerHTML = '';
      if (filteredData.length === 0) {
        container.innerHTML = '<p style="text-align:center; margin-top: 20px;">No detailed data available.</p>';
        return;
      }
      const groupedByDate = {};
      filteredData.forEach(r => {
        const d = formatDate(r.ngay);
        if (!groupedByDate[d]) groupedByDate[d] = [];
        groupedByDate[d].push(r);
      });
      const sortedDates = Object.keys(groupedByDate).sort((a, b) => new Date(b.split('/').reverse().join('-')) - new Date(a.split('/').reverse().join('-')));
      let finalHtml = sortedDates.map(date => {
        let dailyList = generateSummaryTableData(groupedByDate[date]);
        // Keep default sort by Department for daily breakdown table
        sortList(dailyList, { column: 2, direction: 'asc' }, summaryColumnSortKeys, { prop: 'department', type: 'string' }); 
        const { bodyHtml } = generateSummaryTableHTML(dailyList); 
        return `
          <h3>${date}</h3>
          <div class="table-responsive-container">
            <table class="sortable-table daily-summary-table" data-date="${date}">
              <thead>
                <tr>
                  <th class="green-header">No.<span class="sort-icon"></span></th>
                  <th class="green-header">Sale<span class="sort-icon"></span></th>
                  <th class="green-header">Department<span class="sort-icon"></span></th> 
                  <th class="green-header">Data Count<span class="sort-icon"></span></th>
                  <th class="green-header">Closed Orders<span class="sort-icon"></span></th>
                  <th class="green-header">Old Customers<span class="sort-icon"></span></th>
                  <th class="green-header">Total Customers<span class="sort-icon"></span></th>
                  <th class="blue-header">New Revenue<span class="sort-icon"></span></th>
                  <th class="blue-header">Old Revenue<span class="sort-icon"></span></th>
                  <th class="blue-header">Other Revenue<span class="sort-icon"></span></th> 
                  <th class="blue-header">Total Revenue<span class="sort-icon"></span></th>
                  <th class="blue-header">Paid Amount<span class="sort-icon"></span></th>
                  <th class="yellow-header">Close Rate %<span class="sort-icon"></span></th>
                  <th class="yellow-header">Avg. Order Value<span class="sort-icon"></span></th>
                </tr>
              </thead>
              <tbody>${bodyHtml}</tbody>
            </table>
          </div>`;
      }).join('');
      container.innerHTML = finalHtml;
      sortStates.daily = {};
    }
    function generateSummaryTableHTML(dataList) {
      // UPDATED: Added doanhSoBanCheo to total
      let total = { soData: 0, donChot: 0, doanhThu: 0, khachCu: 0, doanhThuKhachCu: 0, paidAmount: 0, doanhSoBanCheo: 0 }; 
      const bodyRowsHtml = dataList.map((s, index) => {
        Object.keys(total).forEach(key => total[key] += s[key] || 0);
        
        const tongKhach = s.donChot + s.khachCu;
        // UPDATED: Total Revenue = New Revenue + Old Revenue + Other Revenue
        const tongDoanhSo = s.doanhThu + s.doanhThuKhachCu + s.doanhSoBanCheo;
        const tiLeChot = s.soData ? s.donChot / s.soData : 0;
        // UPDATED: Avg. Order Value = Total Revenue / Total Customers
        const donTrungBinh = tongKhach > 0 ? tongDoanhSo / tongKhach : 0;
        
        return `
          <tr>
            <td class="text-center">${index + 1}</td>
            <td class="text-left sale-name">${s.name}</td> 
            <td class="text-left department-name">${s.department || 'N/A'}</td>
            <td>${formatNumber(s.soData)}</td>
            <td>${formatNumber(s.donChot)}</td>
            <td>${formatNumber(s.khachCu)}</td>
            <td>${formatNumber(tongKhach)}</td>
            <td>${formatCurrency(s.doanhThu)}</td>
            <td>${formatCurrency(s.doanhThuKhachCu)}</td>
            <td>${formatCurrency(s.doanhSoBanCheo)}</td> <!-- DISPLAY OTHER REVENUE (NEW) -->
            <td>${formatCurrency(tongDoanhSo)}</td> <!-- TOTAL REVENUE (UPDATED) -->
            <td>${formatCurrency(s.paidAmount)}</td> <!-- DISPLAY PAID AMOUNT (MOVED) -->
            <td>${formatPercent(tiLeChot)}</td>
            <td>${formatCurrency(donTrungBinh)}</td>
          </tr>`;
      }).join('');

      const totalTongKhach = total.donChot + total.khachCu;
      // UPDATED: Total Revenue = Total New Revenue + Total Old Revenue + Total Other Revenue
      const totalTongDoanhSo = total.doanhThu + total.doanhThuKhachCu + total.doanhSoBanCheo;
      const totalTiLeChot = total.soData ? total.donChot / total.soData : 0;
      // UPDATED: Avg. Order Value = Total Revenue / Total Customers
      const totalDonTrungBinh = totalTongKhach > 0 ? totalTongDoanhSo / totalTongKhach : 0;

      // Colspan is 3
      const totalRowHtml = `
        <tr class="total-row">
          <td class="total-label" colspan="3">TOTAL</td>
          <td class="total-value">${formatNumber(total.soData)}</td>
          <td class="total-value">${formatNumber(total.donChot)}</td>
          <td class="total-value">${formatNumber(total.khachCu)}</td>
          <td class="total-value">${formatNumber(totalTongKhach)}</td>
          <td class="total-value">${formatCurrency(total.doanhThu)}</td>
          <td class="total-value">${formatCurrency(total.doanhThuKhachCu)}</td>
          <td class="total-value">${formatCurrency(total.doanhSoBanCheo)}</td> <!-- TOTAL OTHER REVENUE (NEW) -->
          <td class="total-value">${formatCurrency(totalTongDoanhSo)}</td> <!-- TOTAL REVENUE (UPDATED) -->
          <td class="total-value">${formatCurrency(total.paidAmount)}</td> <!-- TOTAL PAID AMOUNT (MOVED) -->
          <td class="total-value">${formatPercent(totalTiLeChot)}</td>
          <td class="total-value">${formatCurrency(totalDonTrungBinh)}</td>
        </tr>`;
      return { bodyHtml: totalRowHtml + bodyRowsHtml };
    }
    // =================================================================================
    // --- VIII. TABLE SORTING LOGIC ---
    // =================================================================================
    function sortTable(event, tableType) {
        const th = event.target.closest('th');
        if (!th || th.cellIndex === 0) return;
        let columnIndex = th.cellIndex;
        let sortState;
        let tableElement = th.closest('table');
        if (tableType === 'daily') {
            const date = tableElement.dataset.date;
            if (!sortStates.daily[date]) sortStates.daily[date] = { column: null, direction: 'asc' };
            sortState = sortStates.daily[date];
        } else {
            sortState = sortStates[tableType];
        }
        
        if (!sortState) return;
        
        if (sortState.column === columnIndex) {
            sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
        } else {
            sortState.column = columnIndex;
            sortState.direction = 'asc';
        }
        
        if (tableType === 'daily') {
            sortAndRenderDailyTable(tableElement, sortState);
        } else if (tableType === 'summary') {
            applyTab1Filters();
        }
    }
    function sortAndRenderDailyTable(table, sortState) {
        const date = table.dataset.date;
        const filteredData = getFilteredData('start-date-tab1', 'end-date-tab1');
        const dailyData = filteredData.filter(r => formatDate(r.ngay) === date);
        let dailyList = generateSummaryTableData(dailyData);
        sortList(dailyList, sortState, summaryColumnSortKeys);
        const { bodyHtml } = generateSummaryTableHTML(dailyList);
        table.querySelector('tbody').innerHTML = bodyHtml;
        updateSortIcons(table, sortState);
    }
    function sortList(list, sortState, columnKeys, defaultSortInfo) {
        const { column, direction } = sortState;
        const sortInfo = column ? columnKeys[column] : defaultSortInfo;

        if (!sortInfo) return;
        
        list.sort((a, b) => {
            let valA = typeof sortInfo.prop === 'function' ? sortInfo.prop(a) : a[sortInfo.prop];
            let valB = typeof sortInfo.prop === 'function' ? sortInfo.prop(b) : b[sortInfo.prop];
            
            // Handle null/undefined values
            if (valA == null) valA = sortInfo.type === 'string' ? '' : -Infinity;
            if (valB == null) valB = sortInfo.type === 'string' ? '' : -Infinity;
            
            let comparison = (sortInfo.type === 'string') ? String(valA).localeCompare(String(valB), 'en') : valA - valB;
            
            if (column) { 
                // If a column was clicked for sorting
                return direction === 'asc' ? comparison : -comparison; 
            } else {
                // If default sort (first load)
                if (defaultSortInfo.prop === 'department') {
                    // Sort by Department, then by Sale Name
                    let depA = a.department || '';
                    let depB = b.department || '';
                    let depComparison = depA.localeCompare(depB, 'en');
                    if (depComparison !== 0) {
                        return depComparison;
                    }
                    // If Department is the same, sort by Sale Name (column 1)
                    let nameA = a.name || '';
                    let nameB = b.name || '';
                    return nameA.localeCompare(nameB, 'en');
                }
                return comparison; // Other cases (if defaultSortInfo is not department)
            }
        });
    }
    function updateSortIcons(tableElement, sortState) {
      if (!tableElement) return;
      tableElement.querySelectorAll('thead th').forEach((th, index) => {
        const icon = th.querySelector('.sort-icon');
        if (!icon) return;
        icon.className = 'sort-icon';
        th.classList.remove('sorted');
        if (index === sortState.column) {
          th.classList.add('sorted');
          icon.classList.add(sortState.direction);
        }
      });
    }
    // =================================================================================
    // --- IX. TAB LOGIC ---
    // =================================================================================

    // =================================================================================
    // --- X. UTILITIES ---
    // =================================================================================
    const loader = document.getElementById('loading-overlay');
    const showLoader = () => loader.classList.add('visible');
    const hideLoader = () => loader.classList.remove('visible');
    
    // Function to get URL parameter
    function getUrlParameter(name) {
        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        const results = regex.exec(location.search);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    }

    function formatDate(dateObj) {
      if (!(dateObj instanceof Date) || isNaN(dateObj)) return '';
      return `${String(dateObj.getDate()).padStart(2, '0')}/${String(dateObj.getMonth() + 1).padStart(2, '0')}/${dateObj.getFullYear()}`;
    }
    function formatCurrency(v) {
      // Using USD format as a standard currency display
      return Number(v || 0).toLocaleString('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 });
    }
    function formatNumber(v) { return Number(v || 0).toLocaleString('en-US'); } // Using English number format
    function formatPercent(v) {
      if (!isFinite(v)) return '0.00%';
      return `${(Number(v || 0) * 100).toFixed(2)}%`;
    }
  </script>
</body>
</html>

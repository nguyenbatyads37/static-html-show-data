<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Báo cáo kinh doanh Kama</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    /* --- CÀI ĐẶT CHUNG & TABS --- */
    body {
      font-family: 'Roboto', Arial, sans-serif;
      padding: 20px;
      background-color: #f4f4f4;
      color: #333;
      /* --- THAY ĐỔI: Chữ to và đậm hơn --- */
      font-size: 17px;
      font-weight: 700;
    }
    /* ĐÃ XÓA CSS CHO .tab-container VÌ NÓ KHÔNG CÒN TRONG HTML */
    .tab-content {
      display: block !important; /* Đảm bảo nội dung hiển thị ngay lập tức */
      padding: 6px 12px;
      border-top: none;
      animation: fadeIn 0.5s;
    }
    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }
    /* --- STYLES CHUNG CHO BẢNG & CĂN LỀ --- */
    .table-responsive-container {
      overflow-x: auto;
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: auto;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    th,
    td {
      border: 1px solid #e0e0e0;
      padding: 14px 16px; /* Tăng padding */
      white-space: nowrap;
      vertical-align: middle;
      transition: background-color 0.2s;
       /* --- THAY ĐỔI: Chữ to hơn --- */
      font-size: 16px;
    }
    th {
      text-align: center !important;
      font-size: 17px; /* Tăng kích thước */
    }
    .text-left {
      text-align: left !important;
    }
    .text-center {
      text-align: center !important;
    }
    .marketing-name, .sale-name {
      font-weight: 700;
      color: #00008B;
    }
    .department-name {
      font-weight: 500;
      color: #555;
    }
    tbody tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    tbody tr:not(.team-header-row):not(.total-row):not(.highlight):hover {
      background-color: #eff5fb;
    }
    th.green-header, th.blue-header {
      background: #4CAF50;
      color: white;
      font-weight: 700;
    }
    th.yellow-header {
      background: #FFC107;
      color: #424242;
      font-weight: 700;
    }
    tr.total-row,
    tr.total-row:hover {
      background: #2d7c2d;
      color: white;
      font-weight: 700;
      font-size: 1.25em; /* Tăng kích thước */
      border-bottom: 3px solid #FFC107;
    }
    .total-row .total-label {
      text-transform: uppercase;
      text-align: left !important;
    }
    .total-row .total-value {
      text-align: right !important;
    }
    /* --- STYLES CHO TABS & LAYOUT CHUNG --- */
    .report-container {
      display: flex;
      gap: 20px;
    }
    .sidebar {
      width: 260px;
      flex-shrink: 0;
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    .sidebar h3 {
      background: #2d7c2d;
      color: #fff;
      padding: 12px;
      margin-top: 10px;
      font-size: 20px; /* Tăng kích thước */
      border-radius: 4px;
      font-weight: 700;
    }
    .sidebar label {
      display: block;
      margin: 10px 0; /* Tăng margin */
      font-size: 16px; /* Tăng kích thước */
      cursor: pointer;
    }
    .sidebar input[type="date"],
    .sidebar input[type="text"] {
      width: 100%;
      box-sizing: border-box;
      padding: 10px;
      margin: 4px 0 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 16px; /* Tăng kích thước */
    }
    /* --- THÊM MỚI: CSS cho bộ lọc nhanh --- */
    .quick-filters {
        margin-top: 20px;
        border-top: 1px solid #eee;
        padding-top: 15px;
    }
    .quick-filters button {
        width: 100%;
        padding: 10px;
        margin-bottom: 8px;
        background-color: #f0f0f0;
        border: 1px solid #ccc;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 700;
        font-size: 15px;
        transition: background-color 0.2s, color 0.2s;
    }
    .quick-filters button:hover {
        background-color: #2d7c2d;
        color: white;
    }
    .main-content-area {
      flex-grow: 1;
    }
    .header {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    .header img {
      height: 80px;
      margin-right: 20px;
    }
    .header h2 {
      margin: 0;
      color: #2d7c2d;
      font-weight: 700;
      font-size: 30px; /* Tăng kích thước */
    }
    /* --- CHỈ BÁO ĐANG TẢI --- */
    #loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      font-size: 1.8em; /* Tăng kích thước */
      font-weight: bold;
      color: #2d7c2d;
      transition: opacity 0.3s, visibility 0.3s;
      visibility: hidden;
      opacity: 0;
    }
    #loading-overlay.visible {
      visibility: visible;
      opacity: 1;
    }
    /* --- CSS CHO SẮP XẾP BẢNG --- */
    .sortable-table th {
      cursor: pointer;
      position: relative;
    }
    .sortable-table th .sort-icon {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.8em;
      opacity: 0.4;
      transition: opacity 0.2s;
    }
    .sortable-table th:hover .sort-icon {
      opacity: 0.8;
    }
    .sortable-table th.sorted .sort-icon {
      opacity: 1;
    }
    .sortable-table th .sort-icon.asc::after { content: " ▲"; }
    .sortable-table th .sort-icon.desc::after { content: " ▼"; }
    .daily-breakdown h3 {
      margin-top: 30px;
      background: #f0f0f0;
      padding: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 20px; /* Tăng kích thước */
      font-weight: 700;
    }
  </style>
</head>
<body>
  <div id="loading-overlay">Đang tải dữ liệu...</div>
  <!-- TAB 1: BÁO CÁO CHI TIẾT -->
  <div id="DetailedReport" class="tab-content">
    <div class="report-container">
      <div class="sidebar">
        <h3>Bộ lọc</h3>
        <label for="start-date-tab1">Từ ngày:</label><input type="date" id="start-date-tab1">
        <label for="end-date-tab1">Đến ngày:</label><input type="date" id="end-date-tab1">

        <!-- THÊM MỚI: Bộ lọc nhanh -->
        <div class="quick-filters">
            <button id="btn-today">Hôm nay</button>
            <button id="btn-yesterday">Hôm qua</button>
            <button id="btn-this-week">Tuần này</button>
            <button id="btn-last-week">Tuần trước</button>
        </div>
      </div>
      <div class="main-content-area">
        <div class="header">
          <img
            src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Fd3e93e8d.%E1%BA%A2nh.121830.png"
            alt="Logo">
          <h2 id="report-title-tab1">Báo cáo kinh doanh Kama</h2>
        </div>
        <div class="table-responsive-container">
          <table id="summary-table" class="sortable-table">
            <thead>
              <tr>
                <th class="green-header">STT<span class="sort-icon"></span></th>
                <th class="green-header">Sale<span class="sort-icon"></span></th>
                <th class="green-header">Phòng ban<span class="sort-icon"></span></th>
                <th class="green-header">Số data<span class="sort-icon"></span></th>
                <th class="green-header">Đơn chốt<span class="sort-icon"></span></th>
                <th class="green-header">Khách cũ<span class="sort-icon"></span></th>
                <th class="green-header">Tổng khách<span class="sort-icon"></span></th>
                <th class="blue-header">Doanh số mới<span class="sort-icon"></span></th>
                <th class="blue-header">Doanh số cũ<span class="sort-icon"></span></th>
                <th class="blue-header">Tổng doanh số<span class="sort-icon"></span></th>
                <!-- Cột MỚI: Đã thanh toán -->
                <th class="blue-header">Đã thanh toán<span class="sort-icon"></span></th> 
                <th class="yellow-header">Tỉ lệ chốt %<span class="sort-icon"></span></th>
                <th class="yellow-header">Đơn trung bình<span class="sort-icon"></span></th>
              </tr>
            </thead>
            <tbody id="summary-body"></tbody>
          </table>
        </div>
        <div id="daily-breakdown"></div>
      </div>
    </div>
  </div>
  <script>
    // =================================================================================
    // --- I. KHAI BÁO BIẾN TOÀN CỤC & CẤU HÌNH ---
    // =================================================================================
    const API_URL_REVENUE = 'https://script.google.com/macros/s/AKfycbzq298F76ScFgSvb-FIVpH6DL3vZLwHfbc75h1xyUM6Dt-Dl6PdGiJDbNnakt5c5xx4/exec';
    const API_URL_DATA_COUNT = 'https://script.google.com/macros/s/AKfycbys7V-NQdQhTLwnbU95FKvxZV4CXr4wql0uNwG2KoYLi-jrNBTUN6-s0t4_7kGKg3tl/exec';
    const API_URL_STAFF = 'https://script.google.com/macros/s/AKfycbxffPZlYiyRsoIyz82McL8-fsvaSv6OVVZnKmyeP-IJpswodOP58n8g_V7ZD2XLIBI-/exec?table=nhan-su';

    let masterData = [];
    let staffDataMap = {}; 
    
    const sortStates = {
      summary: { column: 2, direction: 'asc' }, // Mặc định: Phòng ban (index 2)
      daily: {}
    };
    // ĐÃ CẬP NHẬT index cột: Cột mới Đã thanh toán là index 10
    const summaryColumnSortKeys = {
      1: { prop: 'name', type: 'string' }, // Sale
      2: { prop: 'department', type: 'string' }, // Phòng ban
      3: { prop: 'soData', type: 'number' },
      4: { prop: 'donChot', type: 'number' },
      5: { prop: 'khachCu', type: 'number' },
      6: { prop: (s) => s.donChot + s.khachCu, type: 'number' },
      7: { prop: 'doanhThu', type: 'number' },
      8: { prop: 'doanhThuKhachCu', type: 'number' },
      9: { prop: (s) => s.doanhThu + s.doanhThuKhachCu, type: 'number' },
      10: { prop: 'paidAmount', type: 'number' }, // ĐÃ THANH TOÁN (NEW)
      11: { prop: (s) => s.soData ? s.donChot / s.soData : 0, type: 'number' }, // Tỉ lệ chốt
      12: { prop: (s) => (s.donChot + s.khachCu) > 0 ? (s.doanhThu + s.doanhThuKhachCu) / (s.donChot + s.khachCu) : 0, type: 'number' } // Đơn TB
    };
    // =================================================================================
    // --- II. KHỞI TẠO ỨNG DỤNG ---
    // =================================================================================
    document.addEventListener('DOMContentLoaded', () => {
      setupEventListeners();
      setDefaultDates();
      fetchAndProcessData();
    });
    function setDefaultDates() {
      const today = new Date();
      const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
      const formatDateForInput = (date) => date.toISOString().split('T')[0];
      document.getElementById('start-date-tab1').value = formatDateForInput(firstDay);
      document.getElementById('end-date-tab1').value = formatDateForInput(today); // Mặc định đến hôm nay
    }
    function setupEventListeners() {
      document.getElementById('start-date-tab1').addEventListener('change', handleFilterChange);
      document.getElementById('end-date-tab1').addEventListener('change', handleFilterChange);
      document.getElementById('summary-table').querySelector('thead').addEventListener('click', (e) => sortTable(e, 'summary'));
      document.getElementById('daily-breakdown').addEventListener('click', (e) => {
        if (e.target.closest('th')) {
          sortTable(e, 'daily');
        }
      });

      // --- THÊM MỚI: Event listeners cho bộ lọc nhanh ---
      document.getElementById('btn-today').addEventListener('click', () => setQuickFilterDates('today'));
      document.getElementById('btn-yesterday').addEventListener('click', () => setQuickFilterDates('yesterday'));
      document.getElementById('btn-this-week').addEventListener('click', () => setQuickFilterDates('this-week'));
      document.getElementById('btn-last-week').addEventListener('click', () => setQuickFilterDates('last-week'));
    }
    // =================================================================================
    // --- III. TẢI VÀ XỬ LÝ DỮ LIỆU ---
    // =================================================================================
    async function fetchAndProcessData() {
        showLoader();
        try {
            const [revenueResponse, dataCountResponse, staffResponse] = await Promise.all([
                fetch(API_URL_REVENUE),
                fetch(API_URL_DATA_COUNT),
                fetch(API_URL_STAFF) 
            ]);
            const revenueResult = await revenueResponse.json();
            const dataCountResult = await dataCountResponse.json();
            const staffResult = await staffResponse.json(); 

            // Xử lý dữ liệu nhân sự để tạo staffDataMap
            staffDataMap = (staffResult.data || []).reduce((map, r) => {
                const name = (r["Họ và Tên"] || '').trim();
                const department = (r["Phòng ban"] || 'Chưa xác định').trim();
                if (name) {
                    map[name] = department;
                }
                return map;
            }, {});

            const revenueData = (revenueResult.data || []).map(r => {
                const isSuccessfulOrder = (r["TRẠNG THÁI"] === "Success" && r["TRẠNG THÁI VẬN ĐƠN"] !== "Hủy");
                const isOldCustomerOrder = (r["TRẠNG THÁI"] === "Success (old customer)" && r["TRẠNG THÁI VẬN ĐƠN"] !== "Hủy");
                
                // Lấy giá trị Đã thanh toán (SỬ DỤNG KEY CHÍNH XÁC: "Đã thanh toán")
                const paidAmount = Number(r["Đã thanh toán"]) || 0; 

                return {
                    name: (r["Sale"] || 'N/A').trim(), 
                    ngay: new Date(r["NGÀY GIỜ"]),
                    donChot: isSuccessfulOrder ? 1 : 0,
                    doanhThu: isSuccessfulOrder ? (Number(r["GIÁ"]) || 0) : 0,
                    soData: 0, 
                    khachCu: isOldCustomerOrder ? 1 : 0,
                    doanhThuKhachCu: isOldCustomerOrder ? (Number(r["GIÁ"]) || 0) : 0,
                    paidAmount: paidAmount // NEW: Đã thanh toán
                };
            });
            const dataCountData = (dataCountResult.data || []).map(r => ({
                name: (r["Sale"] || 'N/A').trim(), 
                ngay: new Date(r["NGÀY"]), 
                donChot: 0,
                doanhThu: 0,
                soData: 1, 
                khachCu: 0,
                doanhThuKhachCu: 0,
                paidAmount: 0 // Leads không có Đã thanh toán
            }));
            
            masterData = [...revenueData, ...dataCountData].filter(r =>
                r.name !== 'N/A' && r.ngay instanceof Date && !isNaN(r.ngay)
            );

            // Gán Phòng ban cho dữ liệu master
            masterData.forEach(r => {
                r.department = staffDataMap[r.name] || 'N/A';
            });
            
            applyTab1Filters();
        } catch (err) {
            console.error("Lỗi tải dữ liệu:", err);
            alert('Không thể tải dữ liệu từ API. Vui lòng kiểm tra lại.');
            document.getElementById('report-title-tab1').textContent = 'LỖI TẢI DỮ LIỆU';
        } finally {
            hideLoader();
        }
    }
    // =================================================================================
    // --- IV. XỬ LÝ SỰ KIỆN VÀ BỘ LỌC ---
    // =================================================================================
    function handleFilterChange() {
      showLoader();
      setTimeout(() => {
        applyTab1Filters();
        hideLoader();
      }, 50);
    }
    function getFilteredData(startDateId, endDateId) {
      const startDateVal = document.getElementById(startDateId).value;
      const endDateVal = document.getElementById(endDateId).value;
      
      const startDate = startDateVal ? new Date(startDateVal) : null;
      if (startDate) startDate.setHours(0, 0, 0, 0);
      const endDate = endDateVal ? new Date(endDateVal) : null;
      if (endDate) endDate.setHours(23, 59, 59, 999);
      if ((startDate && isNaN(startDate)) || (endDate && isNaN(endDate))) return [];
      
      return masterData.filter(r => {
        const recordDate = r.ngay;
        return (!startDate || recordDate >= startDate) && (!endDate || recordDate <= endDate);
      });
    }

    // --- THÊM MỚI: Hàm xử lý bộ lọc nhanh ---
    function setQuickFilterDates(period) {
        const today = new Date();
        let startDate, endDate;

        switch (period) {
            case 'today':
                startDate = today;
                endDate = today;
                break;
            case 'yesterday':
                startDate = new Date();
                startDate.setDate(today.getDate() - 1);
                endDate = startDate;
                break;
            case 'this-week':
                startDate = new Date();
                const dayOfWeek = today.getDay(); // 0 = Sunday, 1 = Monday, ...
                const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); // adjust when day is sunday
                startDate.setDate(diff);
                endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 6);
                break;
            case 'last-week':
                startDate = new Date();
                startDate.setDate(today.getDate() - today.getDay() - 6);
                endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 6);
                break;
        }

        const formatDateForInput = (date) => date.toISOString().split('T')[0];
        document.getElementById('start-date-tab1').value = formatDateForInput(startDate);
        document.getElementById('end-date-tab1').value = formatDateForInput(endDate);
        
        // Kích hoạt bộ lọc
        handleFilterChange();
    }
    // =================================================================================
    // --- V. CÁC HÀM ÁP DỤNG BỘ LỌC ---
    // =================================================================================
    function applyTab1Filters() {
      const filteredData = getFilteredData('start-date-tab1', 'end-date-tab1');
      const summaryList = generateSummaryTableData(filteredData);
      
      // Sắp xếp mặc định: Cột 2 (Phòng ban), sau đó là Tên (Cột 1)
      const defaultSortInfo = { column: 2, direction: 'asc' };
      sortList(summaryList, sortStates.summary, summaryColumnSortKeys, defaultSortInfo); 
      
      renderSummary(summaryList);
      updateSortIcons(document.getElementById('summary-table'), sortStates.summary);
      renderDailyBreakdown(filteredData);
    }
    // =================================================================================
    // --- VI. CÁC HÀM TÍNH TOÁN VÀ TỔNG HỢP DỮ LIỆU ---
    // =================================================================================
    function generateSummaryTableData(data) {
      const summary = {};
      data.forEach(r => {
        const key = r.name;
        if (!summary[key]) {
          summary[key] = { 
            name: r.name, 
            department: r.department, 
            soData: 0, 
            donChot: 0, 
            doanhThu: 0, 
            khachCu: 0, 
            doanhThuKhachCu: 0,
            paidAmount: 0 // NEW: Khởi tạo Đã thanh toán
          };
        }
        const S = summary[key];
        S.soData += r.soData;
        S.donChot += r.donChot;
        S.doanhThu += r.doanhThu;
        S.khachCu += r.khachCu; 
        S.doanhThuKhachCu += r.doanhThuKhachCu; 
        S.paidAmount += r.paidAmount; // NEW: Cộng dồn Đã thanh toán
      });
      return Object.values(summary);
    }
    // =================================================================================
    // --- VII. CÁC HÀM HIỂN THỊ DỮ LIỆU (RENDERING) ---
    // =================================================================================
    function renderSummary(dataList) {
      const { bodyHtml } = generateSummaryTableHTML(dataList);
      document.getElementById('summary-body').innerHTML = bodyHtml;
    }
    function renderDailyBreakdown(filteredData) {
      const container = document.getElementById('daily-breakdown');
      container.innerHTML = '';
      if (filteredData.length === 0) {
        container.innerHTML = '<p style="text-align:center; margin-top: 20px;">Không có dữ liệu chi tiết.</p>';
        return;
      }
      const groupedByDate = {};
      filteredData.forEach(r => {
        const d = formatDate(r.ngay);
        if (!groupedByDate[d]) groupedByDate[d] = [];
        groupedByDate[d].push(r);
      });
      const sortedDates = Object.keys(groupedByDate).sort((a, b) => new Date(b.split('/').reverse().join('-')) - new Date(a.split('/').reverse().join('-')));
      let finalHtml = sortedDates.map(date => {
        let dailyList = generateSummaryTableData(groupedByDate[date]);
        // Giữ nguyên sắp xếp mặc định theo Phòng ban cho bảng chi tiết ngày
        sortList(dailyList, { column: 2, direction: 'asc' }, summaryColumnSortKeys, { prop: 'department', type: 'string' }); 
        const { bodyHtml } = generateSummaryTableHTML(dailyList); 
        return `
          <h3>${date}</h3>
          <div class="table-responsive-container">
            <table class="sortable-table daily-summary-table" data-date="${date}">
              <thead>
                <tr>
                  <th class="green-header">STT<span class="sort-icon"></span></th>
                  <th class="green-header">Sale<span class="sort-icon"></span></th>
                  <th class="green-header">Phòng ban<span class="sort-icon"></span></th> 
                  <th class="green-header">Số data<span class="sort-icon"></span></th>
                  <th class="green-header">Đơn chốt<span class="sort-icon"></span></th>
                  <th class="green-header">Khách cũ<span class="sort-icon"></span></th>
                  <th class="green-header">Tổng khách<span class="sort-icon"></span></th>
                  <th class="blue-header">Doanh số mới<span class="sort-icon"></span></th>
                  <th class="blue-header">Doanh số cũ<span class="sort-icon"></span></th>
                  <th class="blue-header">Tổng doanh số<span class="sort-icon"></span></th>
                  <th class="blue-header">Đã thanh toán<span class="sort-icon"></span></th>
                  <th class="yellow-header">Tỉ lệ chốt %<span class="sort-icon"></span></th>
                  <th class="yellow-header">Đơn trung bình<span class="sort-icon"></span></th>
                </tr>
              </thead>
              <tbody>${bodyHtml}</tbody>
            </table>
          </div>`;
      }).join('');
      container.innerHTML = finalHtml;
      sortStates.daily = {};
    }
    function generateSummaryTableHTML(dataList) {
      // THÊM paidAmount vào tổng
      let total = { soData: 0, donChot: 0, doanhThu: 0, khachCu: 0, doanhThuKhachCu: 0, paidAmount: 0 }; 
      const bodyRowsHtml = dataList.map((s, index) => {
        Object.keys(total).forEach(key => total[key] += s[key] || 0);
        
        const tongKhach = s.donChot + s.khachCu;
        const tongDoanhSo = s.doanhThu + s.doanhThuKhachCu;
        const tiLeChot = s.soData ? s.donChot / s.soData : 0;
        const donTrungBinh = tongKhach > 0 ? tongDoanhSo / tongKhach : 0;
        
        return `
          <tr>
            <td class="text-center">${index + 1}</td>
            <td class="text-left sale-name">${s.name}</td> 
            <td class="text-left department-name">${s.department || 'N/A'}</td>
            <td>${formatNumber(s.soData)}</td>
            <td>${formatNumber(s.donChot)}</td>
            <td>${formatNumber(s.khachCu)}</td>
            <td>${formatNumber(tongKhach)}</td>
            <td>${formatCurrency(s.doanhThu)}</td>
            <td>${formatCurrency(s.doanhThuKhachCu)}</td>
            <td>${formatCurrency(tongDoanhSo)}</td>
            <td>${formatCurrency(s.paidAmount)}</td> <!-- HIỂN THỊ ĐÃ THANH TOÁN -->
            <td>${formatPercent(tiLeChot)}</td>
            <td>${formatCurrency(donTrungBinh)}</td>
          </tr>`;
      }).join('');

      const totalTongKhach = total.donChot + total.khachCu;
      const totalTongDoanhSo = total.doanhThu + total.doanhThuKhachCu;
      const totalTiLeChot = total.soData ? total.donChot / total.soData : 0;
      const totalDonTrungBinh = totalTongKhach > 0 ? totalTongDoanhSo / totalTongKhach : 0;

      // Cập nhật colspan từ 3 lên 3
      const totalRowHtml = `
        <tr class="total-row">
          <td class="total-label" colspan="3">TỔNG CỘNG</td>
          <td class="total-value">${formatNumber(total.soData)}</td>
          <td class="total-value">${formatNumber(total.donChot)}</td>
          <td class="total-value">${formatNumber(total.khachCu)}</td>
          <td class="total-value">${formatNumber(totalTongKhach)}</td>
          <td class="total-value">${formatCurrency(total.doanhThu)}</td>
          <td class="total-value">${formatCurrency(total.doanhThuKhachCu)}</td>
          <td class="total-value">${formatCurrency(totalTongDoanhSo)}</td>
          <td class="total-value">${formatCurrency(total.paidAmount)}</td> <!-- TỔNG ĐÃ THANH TOÁN -->
          <td class="total-value">${formatPercent(totalTiLeChot)}</td>
          <td class="total-value">${formatCurrency(totalDonTrungBinh)}</td>
        </tr>`;
      return { bodyHtml: totalRowHtml + bodyRowsHtml };
    }
    // =================================================================================
    // --- VIII. LOGIC SẮP XẾP BẢNG ---
    // =================================================================================
    function sortTable(event, tableType) {
        const th = event.target.closest('th');
        if (!th || th.cellIndex === 0) return;
        let columnIndex = th.cellIndex;
        let sortState;
        let tableElement = th.closest('table');
        if (tableType === 'daily') {
            const date = tableElement.dataset.date;
            if (!sortStates.daily[date]) sortStates.daily[date] = { column: null, direction: 'asc' };
            sortState = sortStates.daily[date];
        } else {
            sortState = sortStates[tableType];
        }
        
        if (!sortState) return;
        
        if (sortState.column === columnIndex) {
            sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
        } else {
            sortState.column = columnIndex;
            sortState.direction = 'asc';
        }
        
        if (tableType === 'daily') {
            sortAndRenderDailyTable(tableElement, sortState);
        } else if (tableType === 'summary') {
            applyTab1Filters();
        }
    }
    function sortAndRenderDailyTable(table, sortState) {
        const date = table.dataset.date;
        const filteredData = getFilteredData('start-date-tab1', 'end-date-tab1');
        const dailyData = filteredData.filter(r => formatDate(r.ngay) === date);
        let dailyList = generateSummaryTableData(dailyData);
        sortList(dailyList, sortState, summaryColumnSortKeys);
        const { bodyHtml } = generateSummaryTableHTML(dailyList);
        table.querySelector('tbody').innerHTML = bodyHtml;
        updateSortIcons(table, sortState);
    }
    function sortList(list, sortState, columnKeys, defaultSortInfo) {
        const { column, direction } = sortState;
        const sortInfo = column ? columnKeys[column] : defaultSortInfo;

        if (!sortInfo) return;
        
        list.sort((a, b) => {
            let valA = typeof sortInfo.prop === 'function' ? sortInfo.prop(a) : a[sortInfo.prop];
            let valB = typeof sortInfo.prop === 'function' ? sortInfo.prop(b) : b[sortInfo.prop];
            
            // Xử lý giá trị null/undefined
            if (valA == null) valA = sortInfo.type === 'string' ? '' : -Infinity;
            if (valB == null) valB = sortInfo.type === 'string' ? '' : -Infinity;
            
            let comparison = (sortInfo.type === 'string') ? String(valA).localeCompare(String(valB), 'vi') : valA - valB;
            
            if (column) { 
                // Nếu có cột được click để sắp xếp
                return direction === 'asc' ? comparison : -comparison; 
            } else {
                // Nếu là sắp xếp mặc định (lần tải đầu tiên)
                if (defaultSortInfo.prop === 'department') {
                    // Sắp xếp theo Phòng ban, sau đó theo Tên Sale
                    let depA = a.department || '';
                    let depB = b.department || '';
                    let depComparison = depA.localeCompare(depB, 'vi');
                    if (depComparison !== 0) {
                        return depComparison;
                    }
                    // Nếu Phòng ban giống nhau, sắp xếp theo tên Sale (cột 1)
                    let nameA = a.name || '';
                    let nameB = b.name || '';
                    return nameA.localeCompare(nameB, 'vi');
                }
                return comparison; // Trường hợp còn lại (nếu defaultSortInfo không phải là department)
            }
        });
    }
    function updateSortIcons(tableElement, sortState) {
      if (!tableElement) return;
      tableElement.querySelectorAll('thead th').forEach((th, index) => {
        const icon = th.querySelector('.sort-icon');
        if (!icon) return;
        icon.className = 'sort-icon';
        th.classList.remove('sorted');
        if (index === sortState.column) {
          th.classList.add('sorted');
          icon.classList.add(sortState.direction);
        }
      });
    }
    // =================================================================================
    // --- IX. LOGIC TAB ---
    // =================================================================================

    // =================================================================================
    // --- X. CÁC HÀM TIỆN ÍCH (UTILITIES) ---
    // =================================================================================
    const loader = document.getElementById('loading-overlay');
    const showLoader = () => loader.classList.add('visible');
    const hideLoader = () => loader.classList.remove('visible');
    function formatDate(dateObj) {
      if (!(dateObj instanceof Date) || isNaN(dateObj)) return '';
      return `${String(dateObj.getDate()).padStart(2, '0')}/${String(dateObj.getMonth() + 1).padStart(2, '0')}/${dateObj.getFullYear()}`;
    }
    function formatCurrency(v) {
      return Number(v || 0).toLocaleString('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 });
    }
    function formatNumber(v) { return Number(v || 0).toLocaleString('vi-VN'); }
    function formatPercent(v) {
      if (!isFinite(v)) return '0.00%';
      return `${(Number(v || 0) * 100).toFixed(2)}%`;
    }
  </script>
</body>
</html>

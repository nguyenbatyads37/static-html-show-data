<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Báo Cáo Động Theo Thiết Bị</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        /* CSS cho giao diện chuyên nghiệp */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');

        /* Định nghĩa màu nâu chủ đạo */
        :root {
            --primary-brown: #795548;
            --light-brown: #a1887f;
            --dark-brown: #5d4037;
            --text-color: #333;
            --light-text-color: #666;
            --background-color: #fcf8f3; 
            --panel-background: #ffffff;
            --border-color: #e0e0e0; /* Màu viền chính */
            --strong-border-color: #d1c4e9; /* Màu viền đậm hơn cho bảng */
            --shadow-color: rgba(0,0,0,0.08);
        }

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 20px;
            color: var(--text-color);
            background: 
                linear-gradient(rgba(252, 248, 243, 0.9), rgba(252, 248, 243, 0.9)),
                url('https://images.unsplash.com/photo-1621905251189-08b45d6a269e?q=80&w=2069&auto=format&fit=crop') 
                center center fixed;
            background-size: cover;
        }
        
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0.85);
            display: flex; justify-content: center; align-items: center;
            z-index: 9999; flex-direction: column; gap: 20px;
        }

        #loading-logo-img {
            max-width: 250px;
            width: auto;
            animation: pulse 2s infinite ease-in-out;
        }
        
        @keyframes pulse {
            0% { opacity: 0.6; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
            100% { opacity: 0.6; transform: scale(1); }
        }

        .main-container {
            margin: auto; 
            display: none; 
        }
        .summary-panel { display: flex; gap: 20px; margin-bottom: 20px; }
        .summary-item { flex: 1; background-color: var(--panel-background); padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px var(--shadow-color); text-align: center; }
        .summary-item .label { font-size: 14px; color: var(--light-text-color); margin-bottom: 8px; display: block; }
        .summary-item .value { font-size: 24px; font-weight: 700; color: var(--primary-brown); }
        .selector-panel { background-color: var(--panel-background); padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px var(--shadow-color); margin-bottom: 20px; display: flex; justify-content: center; align-items: center; gap: 20px; }
        .selector-group { display: flex; align-items: center; gap: 10px; width: 100%; max-width: 500px; }
        .selector-panel label { font-size: 16px; font-weight: 500; color: var(--text-color); white-space: nowrap; }
        #typeFilter { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; background-color: var(--background-color); transition: border-color 0.3s; }
        #typeFilter:focus { outline: none; border-color: var(--primary-brown); }
        .report-container { background-color: var(--panel-background); border-radius: 12px; box-shadow: 0 10px 30px var(--shadow-color); overflow: hidden; transition: opacity 0.3s; }
        
        .report-header {
            background: var(--panel-background);
            color: var(--dark-brown);
            padding: 20px 30px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .header-logo-img {
            max-height: 240px;
            width: auto;
        }

        .report-header h1 { margin: 0; font-size: 28px; letter-spacing: 1px; }
        .report-body { padding: 30px; }
        .section-title { font-size: 20px; color: var(--text-color); margin-top: 0; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid var(--border-color); display: flex; align-items: center; }
        h3.section-title { font-size: 18px; border-bottom: none; }
        .section-title i { margin-right: 12px; color: var(--primary-brown); }
        .report-section { margin-bottom: 40px; }
        
        .filtered-summary-item {
            background-color: var(--background-color);
            border: 2px solid var(--primary-brown);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin-bottom: 25px;
        }
        .filtered-summary-item .label { display: block; font-size: 16px; font-weight: 500; color: var(--light-text-color); margin-bottom: 10px; }
        .filtered-summary-item .value { font-size: 28px; font-weight: 700; color: var(--dark-brown); }
        
        .charts-grid { display: flex; gap: 25px; }
        .chart-wrapper { flex: 1; min-width: 0; padding: 20px; background: var(--background-color); border-radius: 12px; box-shadow: 0 2px 8px var(--shadow-color); }
        .chart-wrapper canvas { max-height: 400px; }
        .report-footer { background-color: #fcf8f3; color: var(--light-text-color); font-size: 12px; text-align: center; padding: 15px; }
        
        @media (max-width: 992px) { .charts-grid { flex-direction: column; } }
        @media (max-width: 768px) { body { padding: 15px; } .summary-panel { flex-direction: column; } .selector-panel { flex-direction: column; align-items: stretch; } .selector-group { flex-direction: column; align-items: flex-start; } .report-header h1 { font-size: 24px; } .report-body { padding: 20px; } }
        @media (max-width: 600px) { body { padding: 10px; } .report-header h1 { font-size: 22px; } .report-body { padding: 15px; } .section-title { font-size: 18px; } h3.section-title { font-size: 16px; } .summary-item .value { font-size: 22px; } }

    </style>
</head>
<body>
    <div id="loading-overlay">
        <img id="loading-logo-img" src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2F61cc680f.%E1%BA%A2nh.053502.png" alt="Logo">
        <p>Đang tải dữ liệu, vui lòng chờ...</p>
    </div>

    <div class="main-container">
        <div class="summary-panel">
            <div class="summary-item">
                <span class="label"><i class="fa-solid fa-boxes-stacked"></i> Số Lượng Thiết Bị</span>
                <span class="value" id="deviceCount">0</span>
            </div>
            <div class="summary-item">
                <span class="label"><i class="fa-solid fa-sack-dollar"></i> Tổng Nguyên Giá</span>
                <span class="value" id="totalValue">0 VND</span>
            </div>
        </div>

        <div class="selector-panel">
            <div class="selector-group">
                <label for="typeFilter"><i class="fa-solid fa-filter"></i> Lọc theo loại thiết bị:</label>
                <select id="typeFilter"></select>
            </div>
        </div>

        <div class="report-container" id="reportContainer">
            <header class="report-header">
                <img class="header-logo-img" src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2F61cc680f.%E1%BA%A2nh.053502.png" alt="Logo">
                <h1>Báo Cáo Toàn Diện Về Thiết Bị</h1>
            </header>

            <main class="report-body">
                
                <!-- PHẦN BẢNG ĐÃ ĐƯỢC XÓA BỎ -->
                
                <section class="report-section">
                     <h2 class="section-title">
                        <i class="fa-solid fa-chart-simple"></i>
                        Biểu Đồ Phân Tích (Theo bộ lọc)
                    </h2>
                    
                    <div class="filtered-summary-item">
                        <span class="label">Tổng Nguyên Giá (Theo bộ lọc)</span>
                        <span class="value" id="filteredTotalValue">0 VND</span>
                    </div>

                    <div class="charts-grid">
                        <div class="chart-wrapper">
                            <h3 class="section-title"><i class="fa-solid fa-chart-pie"></i> Tỷ Lệ Tình Trạng</h3>
                            <canvas id="statusPieChart"></canvas>
                        </div>
                        <div class="chart-wrapper">
                             <h3 class="section-title"><i class="fa-solid fa-chart-column"></i> So Sánh Nguyên Giá</h3>
                             <canvas id="valueComparisonChart"></canvas>
                        </div>
                    </div>
                </section>
            </main>
            
            <footer class="report-footer">
                Báo cáo được tạo tự động vào ngày <span id="reportDate"></span>
            </footer>
        </div>
        
    </div>


    <script>
        // --- KHAI BÁO BIẾN TOÀN CỤC ---
        const API_URL = 'https://script.google.com/macros/s/AKfycbwqJDsGTe2OYuNyOK79D9CYu_9BRrprZPUjRwMP5LS2XjZmERMm-LSDxUe_RoghvCvr/exec';
        let allDevices = []; 
        
        // Lấy các phần tử HTML
        const loadingOverlay = document.getElementById('loading-overlay');
        const mainContainer = document.querySelector('.main-container');
        const typeFilter = document.getElementById('typeFilter');
        // const devicesTableContainer = document.getElementById('devicesTableContainer'); //Không cần thiết nữa
        const dateSpan = document.getElementById('reportDate');
        const valueChartCanvas = document.getElementById('valueComparisonChart').getContext('2d');
        const statusPieCanvas = document.getElementById('statusPieChart').getContext('2d');
        const deviceCountSpan = document.getElementById('deviceCount');
        const totalValueSpan = document.getElementById('totalValue');
        const filteredTotalValueSpan = document.getElementById('filteredTotalValue');

        let valueChart, statusPieChart;

        async function initialize() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error(`Lỗi mạng: ${response.statusText}`);
                const data = await response.json();

                allDevices = data.quanLyThietBi;
                
                populateTypeFilter();
                displayFilteredComponents(); 

                loadingOverlay.style.display = 'none';
                mainContainer.style.display = 'block';

            } catch (error) {
                loadingOverlay.innerHTML = `<p>Không thể tải dữ liệu. Vui lòng thử lại sau. Lỗi: ${error.message}</p>`;
                console.error("Lỗi khi khởi tạo báo cáo:", error);
            }
        }
        
        function populateTypeFilter() {
            const deviceTypes = ['Tất cả', ...new Set(allDevices.map(device => device['Loại thiết bị']))];
            typeFilter.innerHTML = deviceTypes.map(type => `<option value="${type}">${type}</option>`).join('');
        }

        function updateSummary(devices) {
            deviceCountSpan.textContent = devices.length;
            const totalValue = devices.reduce((sum, device) => sum + (Number(device['Nguyên giá']) || 0), 0);
            totalValueSpan.textContent = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(totalValue);
            filteredTotalValueSpan.textContent = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(totalValue);
        }
        
        // --- HÀM TẠO BẢNG ĐÃ ĐƯỢC XÓA BỎ ---
        
        function drawComparisonChart(devices) {
            if (valueChart) valueChart.destroy();
            const sortedDevices = [...devices].sort((a, b) => (b['Nguyên giá'] || 0) - (a['Nguyên giá'] || 0));

            valueChart = new Chart(valueChartCanvas, {
                type: 'bar',
                data: {
                    labels: sortedDevices.map(d => d['Tên thiết bị']),
                    datasets: [{
                        label: 'Nguyên giá (VND)',
                        data: sortedDevices.map(d => d['Nguyên giá']),
                        backgroundColor: 'rgba(121, 85, 72, 0.7)',
                        borderColor: '#795548',
                        borderWidth: 1
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { tooltip: { callbacks: { label: ctx => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(ctx.parsed.y) } } }, scales: { y: { beginAtZero: true, ticks: { callback: val => new Intl.NumberFormat('vi-VN', { notation: 'compact' }).format(val) } } } }
            });
        }
        
        function drawStatusPieChart(devices) {
            if (statusPieChart) statusPieChart.destroy();
            
            const statusCounts = devices.reduce((acc, device) => {
                const status = device['Trạng thái'];
                if(status) acc[status] = (acc[status] || 0) + 1;
                return acc;
            }, {});

            const sortedStatusData = Object.entries(statusCounts).sort(([, countA], [, countB]) => countB - countA);
            const statusLabels = sortedStatusData.map(([label]) => label);
            const statusData = sortedStatusData.map(([, count]) => count);
            const backgroundColors = { 'Tốt': '#6A8C3B', 'Mới': '#A1887F', 'Cần bảo trì': '#D8A76B', 'Hỏng': '#B05E5E', 'Bình thường': '#6A8C3B' };

            statusPieChart = new Chart(statusPieCanvas, {
                type: 'pie',
                data: { 
                    labels: statusLabels, 
                    datasets: [{ 
                        label: 'Số lượng', 
                        data: statusData,
                        backgroundColor: statusLabels.map(label => backgroundColors[label] || '#999'), 
                        borderColor: '#fff', 
                        borderWidth: 2 
                    }] 
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } } }
            });
        }

        function displayFilteredComponents() {
            const selectedType = typeFilter.value;
            const devicesToDisplay = (selectedType === 'Tất cả') 
                ? allDevices 
                : allDevices.filter(device => device['Loại thiết bị'] === selectedType);
            
            updateSummary(devicesToDisplay);
            // updateDevicesTable(devicesToDisplay); // Lệnh gọi hàm tạo bảng đã được xóa
            drawComparisonChart(devicesToDisplay);
            drawStatusPieChart(devicesToDisplay);
            dateSpan.textContent = new Date().toLocaleDateString('vi-VN');
        }
        
        typeFilter.addEventListener('change', displayFilteredComponents);
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Báo Cáo Động Theo Thiết Bị</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        /* CSS cho giao diện chuyên nghiệp */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');

        /* Định nghĩa màu nâu chủ đạo */
        :root {
            --primary-brown: #795548; /* Màu nâu đất */
            --light-brown: #a1887f; /* Nâu nhạt hơn */
            --dark-brown: #5d4037; /* Nâu đậm hơn */
            --accent-color: #ffb74d; /* Màu cam đất làm điểm nhấn */
            --text-color: #333;
            --light-text-color: #666;
            --background-color: #fcf8f3; /* Nền trắng ngà/kem nhạt */
            --panel-background: #ffffff;
            --border-color: #e0e0e0;
            --shadow-color: rgba(0,0,0,0.08);
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--background-color);
            margin: 0;
            padding: 20px;
            color: var(--text-color);
        }

        .main-container {
            max-width: 1400px;
            margin: auto;
        }
        
        .summary-panel {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .summary-item {
            flex: 1;
            background-color: var(--panel-background);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px var(--shadow-color);
            text-align: center;
        }

        .summary-item .label {
            font-size: 14px;
            color: var(--light-text-color);
            margin-bottom: 8px;
            display: block;
        }

        .summary-item .value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-brown); /* Sử dụng màu nâu chủ đạo */
        }

        .selector-panel {
            background-color: var(--panel-background);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px var(--shadow-color);
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }
        
        .selector-group {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-basis: 50%;
            max-width: 500px;
        }

        .selector-panel label {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-color);
            white-space: nowrap;
        }

        #typeFilter {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            background-color: var(--background-color);
            transition: border-color 0.3s;
        }
        
        #typeFilter:focus {
            outline: none;
            border-color: var(--primary-brown); /* Viền khi focus */
        }

        .report-container {
            background-color: var(--panel-background);
            border-radius: 12px;
            box-shadow: 0 10px 30px var(--shadow-color);
            overflow: hidden;
            transition: opacity 0.3s;
        }
        
        .report-header {
            background: linear-gradient(135deg, var(--dark-brown), var(--primary-brown), var(--light-brown)); /* Gradient màu nâu */
            color: white;
            padding: 30px;
            text-align: center;
        }

        .report-header h1 {
            margin: 0;
            font-size: 28px;
            letter-spacing: 1px;
        }

        .report-body {
            padding: 30px;
        }

        .section-title {
            font-size: 20px;
            color: var(--text-color);
            margin-top: 0;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
            display: flex;
            align-items: center;
        }

        .section-title i {
            margin-right: 12px;
            color: var(--primary-brown); /* Icon màu nâu chủ đạo */
        }
        
        .devices-list-section {
            margin-bottom: 30px; 
        }

        .table-responsive {
            width: 100%;
            overflow-x: auto;
        }
        
        .devices-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 15px;
        }

        .devices-table th, .devices-table td {
            padding: 12px 15px;
            text-align: left;
            white-space: nowrap;
            vertical-align: middle;
            border-bottom: 1px solid #eef2f5;
        }
        
        .devices-table thead th {
            background-color: #fef8f0; /* Nền đầu bảng nhạt hơn */
            font-weight: 700;
            color: var(--primary-brown); /* Tiêu đề cột màu nâu */
            font-size: 14px;
        }
        
        .devices-table tbody tr:hover {
            background-color: #fcf4ec; /* Hover màu nâu nhạt */
        }

        .devices-table td { color: var(--text-color); }
        .devices-table td:last-child { text-align: center; }
        .devices-table .qr-code-img {
            max-width: 60px;
            height: auto;
            border: 2px solid var(--border-color);
            border-radius: 4px;
        }
        
        /* --- CSS CHO BỐ CỤC 2 BIỂU ĐỒ --- */
        .charts-grid {
            display: flex;
            gap: 25px;
        }
        .chart-wrapper {
            flex: 1;
            min-width: 0;
            padding: 20px;
            background: var(--background-color); /* Nền biểu đồ */
            border-radius: 12px;
            box-shadow: 0 2px 8px var(--shadow-color);
        }
        .chart-wrapper canvas {
            max-height: 400px;
        }

        .report-footer {
            background-color: var(--background-color);
            color: var(--light-text-color);
            font-size: 12px;
            text-align: center;
            padding: 15px;
        }
        
        /* --- CSS CHO MÀN HÌNH NHỎ (RESPONSIVE) --- */
        @media (max-width: 992px) {
            .charts-grid {
                flex-direction: column;
            }
        }
        
        @media (max-width: 600px) {
            .summary-panel { flex-direction: column; }
            .selector-group { flex-basis: 100%; }
            .report-body { padding: 20px; }
        }
    </style>
</head>
<body>

    <div class="main-container">
        <!-- Bảng tóm tắt tổng quan -->
        <div class="summary-panel">
            <div class="summary-item">
                <span class="label"><i class="fa-solid fa-boxes-stacked"></i> Số Lượng Thiết Bị</span>
                <span class="value" id="deviceCount">0</span>
            </div>
            <div class="summary-item">
                <span class="label"><i class="fa-solid fa-sack-dollar"></i> Tổng Nguyên Giá</span>
                <span class="value" id="totalValue">0 VND</span>
            </div>
        </div>

        <!-- Bảng điều khiển chọn và lọc -->
        <div class="selector-panel">
            <div class="selector-group">
                <label for="typeFilter"><i class="fa-solid fa-filter"></i> Lọc để xem danh sách chi tiết:</label>
                <select id="typeFilter"></select>
            </div>
        </div>

        <!-- Khung chứa báo cáo chính -->
        <div class="report-container" id="reportContainer">
            <header class="report-header">
                <h1>Báo Cáo Toàn Diện Về Thiết Bị</h1>
            </header>

            <main class="report-body">
                <!-- Bảng danh sách chi tiết (Hiển thị các cột được chọn) -->
                <section class="devices-list-section" id="devicesListSection" style="display: none;">
                    <h2 class="section-title">
                        <i class="fa-solid fa-list-ul"></i>
                        Danh Sách Thiết Bị Chi Tiết
                    </h2>
                    <div id="devicesTableContainer" class="table-responsive">
                        <!-- Bảng danh sách thiết bị sẽ được chèn vào đây -->
                    </div>
                </section>

                <!-- Bảng thông tin đầy đủ tất cả sản phẩm được lọc -->
                <section class="full-details-section" id="fullDetailsSection" style="display: none;">
                    <h2 class="section-title">
                        <i class="fa-solid fa-table"></i>
                        Thông Tin Chi Tiết Tất Cả Thiết Bị Được Lọc
                    </h2>
                    <div id="fullDetailsTableContainer" class="table-responsive">
                        <!-- Bảng đầy đủ thông tin sẽ được chèn vào đây -->
                    </div>
                </section>
                
                <!-- Khu vực biểu đồ -->
                <section class="charts-section">
                    <div class="charts-grid">
                        <div class="chart-wrapper">
                            <h2 class="section-title"><i class="fa-solid fa-chart-pie"></i> Tỷ Lệ Tình Trạng</h2>
                            <canvas id="statusPieChart"></canvas>
                        </div>
                        <div class="chart-wrapper">
                             <h2 class="section-title"><i class="fa-solid fa-chart-column"></i> So Sánh Nguyên Giá</h2>
                             <canvas id="valueComparisonChart"></canvas>
                        </div>
                    </div>
                </section>
            </main>
            
            <footer class="report-footer">
                Báo cáo được tạo tự động vào ngày <span id="reportDate"></span>
            </footer>
        </div>
        
        <div id="noResults" style="display: none; text-align: center; padding: 50px; font-size: 18px; color: #888; background: var(--panel-background); border-radius: 12px; box-shadow: 0 4px 15px var(--shadow-color);">
            Không có thiết bị nào phù hợp với bộ lọc.
        </div>
    </div>


    <script>
        // --- KHO DỮ LIỆU TRUNG TÂM ---
        const allDevices = [
            { "id": "1879e7be", "Loại thiết bị": "Thiết Bị Cầm Tay", "Tên thiết bị": "Máy cắt cầm tay Lacela 241020", "Năm sản xuất": 2024, "Nguyên giá": 2500000, "Đặc tính kĩ thuật": "Công suất 1200W, Tốc độ 13000 vòng/phút", "Mã vạch": "https://quickchart.io/qr?text=1879e7be", "Trạng thái": "Mới", "Số seri": "MCCT.24.01" },
            { "id": "a2c5f8ab", "Loại thiết bị": "Máy Khoan", "Tên thiết bị": "Máy khoan bê tông Bosch GBH 2-28DFV", "Năm sản xuất": 2023, "Nguyên giá": 5800000, "Đặc tính kĩ thuật": "Công suất 820W, Lực đập 3.2 J", "Mã vạch": "https://quickchart.io/qr?text=a2c5f8ab", "Trạng thái": "Tốt", "Số seri": "MKB.23.05" },
            { "id": "f5d8e1c9", "Loại thiết bị": "Máy Hàn", "Tên thiết bị": "Máy hàn điện tử Hồng Ký HK 200N", "Năm sản xuất": 2022, "Nguyên giá": 3100000, "Đặc tính kĩ thuật": "Dòng hàn 20-200A, Que hàn 1.6 - 3.2mm", "Mã vạch": "https://quickchart.io/qr?text=f5d8e1c9", "Trạng thái": "Cần bảo trì", "Số seri": "MHDT.22.11" },
            { "id": "b3e9a1f7", "Loại thiết bị": "Thiết Bị Cầm Tay", "Tên thiết bị": "Máy mài góc Makita 9553NB", "Năm sản xuất": 2023, "Nguyên giá": 1250000, "Đặc tính kĩ thuật": "Công suất 710W, Đường kính đĩa 100mm", "Mã vạch": "https://quickchart.io/qr?text=b3e9a1f7", "Trạng thái": "Tốt", "Số seri": "MMG.23.02" },
            { "id": "c7d4e2a8", "Loại thiết bị": "Máy Khoan", "Tên thiết bị": "Máy khoan pin Dewalt DCD777D2", "Năm sản xuất": 2024, "Nguyên giá": 4200000, "Đặc tính kĩ thuật": "Pin 18V XR Li-Ion, Mô-men xoắn 65 Nm", "Mã vạch": "https://quickchart.io/qr?text=c7d4e2a8", "Trạng thái": "Mới", "Số seri": "MKP.24.08" },
            { "id": "d9f1b8c3", "Loại thiết bị": "Máy Nén Khí", "Tên thiết bị": "Máy nén khí Pegasus TM-V-0.17/8", "Năm sản xuất": 2022, "Nguyên giá": 3800000, "Đặc tính kĩ thuật": "Dung tích 100L, Công suất 2 HP", "Mã vạch": "https://quickchart.io/qr?text=d9f1b8c3", "Trạng thái": "Tốt", "Số seri": "MNK.22.15" },
            { "id": "e4a5c6b7", "Loại thiết bị": "Dụng Cụ Đo Lường", "Tên thiết bị": "Thước đo laser Leica Disto D2", "Năm sản xuất": 2023, "Nguyên giá": 2900000, "Đặc tính kĩ thuật": "Phạm vi đo 100m, Bluetooth", "Mã vạch": "https://quickchart.io/qr?text=e4a5c6b7", "Trạng thái": "Tốt", "Số seri": "TDL.23.09" },
            { "id": "1ab2c3d4", "Loại thiết bị": "Thiết Bị Cầm Tay", "Tên thiết bị": "Máy cưa đĩa Stanley SC16", "Năm sản xuất": 2021, "Nguyên giá": 1950000, "Đặc tính kĩ thuật": "Công suất 1600W, Đĩa cưa 185mm", "Mã vạch": "https://quickchart.io/qr?text=1ab2c3d4", "Trạng thái": "Cần bảo trì", "Số seri": "MCD.21.04" },
            { "id": "5ef6g7h8", "Loại thiết bị": "Máy Hàn", "Tên thiết bị": "Máy hàn que Jasic ARC 200", "Năm sản xuất": 2023, "Nguyên giá": 3500000, "Đặc tính kĩ thuật": "Công nghệ Inverter, Dòng hàn 20-200A", "Mã vạch": "https://quickchart.io/qr?text=5ef6g7h8", "Trạng thái": "Tốt", "Số seri": "MHQ.23.18" },
            { "id": "9ij0k1l2", "Loại thiết bị": "Dụng Cụ Đo Lường", "Tên thiết bị": "Máy cân mực laser Sincon SL-222", "Năm sản xuất": 2022, "Nguyên giá": 1800000, "Đặc tính kĩ thuật": "5 tia xanh, Phạm vi 20m", "Mã vạch": "https://quickchart.io/qr?text=9ij0k1l2", "Trạng thái": "Tốt", "Số seri": "MML.22.07" },
            { "id": "3mn4o5p6", "Loại thiết bị": "Thiết Bị Cầm Tay", "Tên thiết bị": "Máy thổi hơi nóng Stanley STXH2000", "Năm sản xuất": 2023, "Nguyên giá": 950000, "Đặc tính kĩ thuật": "Công suất 2000W, Nhiệt độ 50-600°C", "Mã vạch": "https://quickchart.io/qr?text=3mn4o5p6", "Trạng thái": "Hỏng", "Số seri": "MTH.23.11" }
        ];
        
        // Lấy các phần tử HTML
        const typeFilter = document.getElementById('typeFilter');
        const devicesListSection = document.getElementById('devicesListSection'); 
        const devicesTableContainer = document.getElementById('devicesTableContainer');
        const fullDetailsSection = document.getElementById('fullDetailsSection');
        const fullDetailsTableContainer = document.getElementById('fullDetailsTableContainer');
        const dateSpan = document.getElementById('reportDate');
        const valueChartCanvas = document.getElementById('valueComparisonChart').getContext('2d');
        const statusPieCanvas = document.getElementById('statusPieChart').getContext('2d');
        const deviceCountSpan = document.getElementById('deviceCount');
        const totalValueSpan = document.getElementById('totalValue');
        const reportContainer = document.getElementById('reportContainer');
        const noResultsDiv = document.getElementById('noResults');

        let valueChart, statusPieChart;
        let currentFilteredDevices = [];

        function populateTypeFilter() {
            const deviceTypes = ['Tất cả', ...new Set(allDevices.map(device => device['Loại thiết bị']))];
            typeFilter.innerHTML = '';
            deviceTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                typeFilter.appendChild(option);
            });
        }

        function updateSummary(devices) {
            deviceCountSpan.textContent = devices.length;
            const totalValue = devices.reduce((sum, device) => sum + device['Nguyên giá'], 0);
            totalValueSpan.textContent = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(totalValue);
        }
        
        function updateDevicesTable(devices) {
            const infoMapping = { 
                'Tên thiết bị': 'Tên Thiết Bị', 
                'Số seri': 'Số Seri', 
                'Loại thiết bị': 'Phân Loại', 
                'Năm sản xuất': 'Năm SX', 
                'Nguyên giá': 'Nguyên Giá',
                'Trạng thái': 'Tình Trạng', 
                'Đặc tính kĩ thuật': 'Đặc Tính Kỹ Thuật',
                'Mã vạch': 'Mã QR'
            };
            
            let tableHTML = '<table class="devices-table">';
            tableHTML += '<thead><tr>';
            for (const key in infoMapping) {
                tableHTML += `<th>${infoMapping[key]}</th>`;
            }
            tableHTML += '</tr></thead>';
            tableHTML += '<tbody>';
            devices.forEach(device => {
                tableHTML += '<tr>';
                for (const key in infoMapping) {
                    let value = device[key] || '---';
                    if (key === 'Nguyên giá') {
                        value = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(device[key]);
                    } else if (key === 'Mã vạch') {
                        value = `<img src="${device[key]}" alt="QR Code" class="qr-code-img">`;
                    }
                    tableHTML += `<td>${value}</td>`;
                }
                tableHTML += '</tr>';
            });
            tableHTML += '</tbody></table>';
            devicesTableContainer.innerHTML = tableHTML;
        }
        
        function updateFullDetailsTable(devices) {
            const allKeys = [
                "id", "Loại thiết bị", "Tên thiết bị", "Năm sản xuất", 
                "Nguyên giá", "Đặc tính kĩ thuật", "Mã vạch", "Trạng thái", "Số seri"
            ];

            const displayNames = {
                "id": "ID",
                "Loại thiết bị": "Loại Thiết Bị",
                "Tên thiết bị": "Tên Thiết Bị",
                "Năm sản xuất": "Năm Sản Xuất",
                "Nguyên giá": "Nguyên Giá",
                "Đặc tính kĩ thuật": "Đặc Tính Kỹ Thuật",
                "Mã vạch": "Mã QR",
                "Trạng thái": "Trạng Thái",
                "Số seri": "Số Seri"
            };
            
            let tableHTML = '<table class="devices-table">';
            tableHTML += '<thead><tr>';
            allKeys.forEach(key => {
                tableHTML += `<th>${displayNames[key] || key}</th>`;
            });
            tableHTML += '</tr></thead>';
            tableHTML += '<tbody>';

            devices.forEach(device => {
                tableHTML += '<tr>';
                allKeys.forEach(key => {
                    let value = device[key] !== undefined && device[key] !== null ? device[key] : '---';
                    if (key === 'Nguyên giá') {
                        value = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(device[key]);
                    } else if (key === 'Mã vạch') {
                        value = `<img src="${device[key]}" alt="QR Code" class="qr-code-img">`;
                    }
                    tableHTML += `<td>${value}</td>`;
                });
                tableHTML += '</tr>';
            });
            tableHTML += '</tbody></table>';
            fullDetailsTableContainer.innerHTML = tableHTML;
        }
        
        function drawComparisonChart(devices) {
            if (valueChart) valueChart.destroy();

            // Sắp xếp bản sao của mảng thiết bị theo nguyên giá giảm dần
            const sortedDevices = [...devices].sort((a, b) => b['Nguyên giá'] - a['Nguyên giá']);

            valueChart = new Chart(valueChartCanvas, {
                type: 'bar',
                data: {
                    labels: sortedDevices.map(d => d['Tên thiết bị']),
                    datasets: [{
                        label: 'Nguyên giá (VND)',
                        data: sortedDevices.map(d => d['Nguyên giá']),
                        backgroundColor: 'rgba(121, 85, 72, 0.7)',
                        borderColor: '#795548',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { tooltip: { callbacks: { label: ctx => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(ctx.parsed.y) } } },
                    scales: { y: { beginAtZero: true, ticks: { callback: val => new Intl.NumberFormat('vi-VN', { notation: 'compact' }).format(val) } } }
                }
            });
        }
        
        function drawStatusPieChart(devices) {
            if (statusPieChart) statusPieChart.destroy();

            const statusCounts = devices.reduce((acc, device) => {
                acc[device['Trạng thái']] = (acc[device['Trạng thái']] || 0) + 1;
                return acc;
            }, {});

            // Chuyển đổi đối tượng thành mảng và sắp xếp theo số lượng giảm dần
            const sortedStatusData = Object.entries(statusCounts)
                                      .sort(([, countA], [, countB]) => countB - countA);

            const statusLabels = sortedStatusData.map(([label]) => label);
            const statusData = sortedStatusData.map(([, count]) => count);

            const backgroundColors = { 
                'Tốt': '#6A8C3B', 'Mới': '#A1887F', 'Cần bảo trì': '#D8A76B', 'Hỏng': '#B05E5E'
            };

            statusPieChart = new Chart(statusPieCanvas, {
                type: 'pie',
                data: {
                    labels: statusLabels,
                    datasets: [{
                        label: 'Số lượng',
                        data: statusData,
                        backgroundColor: statusLabels.map(label => backgroundColors[label] || '#999'),
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } } }
            });
        }

        function filterAndDisplay() {
            const selectedType = typeFilter.value;
            currentFilteredDevices = (selectedType === 'Tất cả') 
                ? [...allDevices] 
                : allDevices.filter(device => device['Loại thiết bị'] === selectedType);
            
            if (currentFilteredDevices.length === 0) {
                 devicesListSection.style.display = 'none';
                 fullDetailsSection.style.display = 'none';
                 reportContainer.style.display = 'block'; 
                 noResultsDiv.style.display = 'block'; 
            } else {
                 devicesListSection.style.display = 'block';
                 fullDetailsSection.style.display = 'block';
                 reportContainer.style.display = 'block';
                 noResultsDiv.style.display = 'none';
            }

            updateSummary(currentFilteredDevices);
            updateDevicesTable(currentFilteredDevices);
            updateFullDetailsTable(currentFilteredDevices);
            drawComparisonChart(currentFilteredDevices);
            drawStatusPieChart(currentFilteredDevices);
            dateSpan.textContent = new Date().toLocaleDateString('vi-VN');
        }
        
        typeFilter.addEventListener('change', filterAndDisplay);

        function initialize() {
            populateTypeFilter();
            filterAndDisplay();
        }
        
        initialize();
    </script>

</body>
</html>

<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Quản lý đơn hàng MGT - Team Hà Nội (Chỉ xem)</title>
  <style>
    :root {
      --filter-row-height: 38px;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      background-color: #f5f5f5;
      color: #333;
      margin: 0;
      user-select: none;
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #2c3e50;
    }
    .main-filters {
      display: flex;
      gap: 20px;
      align-items: center;
      margin-bottom: 15px;
      padding: 15px;
      background: #fff;
      border-radius: 5px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      flex-wrap: wrap;
    }
    .filter-group {
      display: flex;
      flex-direction: column;
    }
    .filter-group label {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 5px;
      color: #555;
    }
    .filter-group select, .filter-group input {
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    .controls {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      align-items: center;
      background: #fff;
      padding: 10px 15px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .controls > div {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .table-wrapper {
      position: relative;
      overflow: auto;
      max-height: 65vh;
      background: white;
      border-radius: 0 0 5px 5px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 1900px;
      font-size: 14px;
    }
    thead {
      position: sticky;
      top: 0;
      z-index: 10;
    }
    th, td {
      border: 1px solid #e0e0e0;
      padding: 8px 12px;
      text-align: left;
      white-space: nowrap;
      background-color: white;
      position: relative;
    }
    th {
      background-color: #3498db;
      color: white;
      position: sticky;
      top: var(--filter-row-height);
      z-index: 20;
      font-weight: 500;
    }
    #filterRow th {
        top: 0;
        background-color: #f2f6fa;
        padding: 4px 8px;
    }
    .filter-input {
      width: 100%;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 3px;
      font-size: 13px;
    }
    
    .dual-filter-container {
      display: flex;
      gap: 4px;
      align-items: center;
    }
    .dual-filter-container input {
      flex: 1;
      min-width: 0;
    }
    
    button {
      padding: 6px 12px;
      cursor: pointer;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 13px;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #2980b9;
    }
    #downloadExcel {
        background-color: #16a085;
    }
    #downloadExcel:hover {
        background-color: #1abc9c;
    }
    #updateAll {
        display: none;
    }
    .no-data { text-align: center; padding: 20px; color: #7f8c8d; font-style: italic; }
    .refresh-btn { background-color: #2ecc71; }
    .refresh-btn:hover { background-color: #27ae60; }
    .refresh-icon { margin-right: 5px; }
    .fixed-column {
        position: sticky;
        z-index: 5;
        background-color: #f8f9fa;
    }
    th.fixed-column {
        z-index: 30;
        background-color: #3498db;
    }
    #filterRow th.fixed-column {
        z-index: 40;
        background-color: #e9ecef;
    }
    td.fixed-column {
        background-color: white;
    }
    .note-highlight { background-color: #fff2a8; }
    .status-ok { background-color: #d4edda; color: #155724; font-weight: bold; }
    .status-cancel { background-color: #f8d7da; color: #721c24; font-weight: bold; }
    td.cell-selected { background-color: rgba(52, 152, 219, 0.4) !important; }

    .order-counter {
      margin-left: 15px;
      font-weight: bold;
      font-size: 14px;
      color: #2c3e50;
    }
    .order-counter b {
      color: #e74c3c;
      font-size: 16px;
      padding: 0 4px;
    }
    
    .selection-summary {
      margin-left: 20px;
      font-size: 14px;
      color: #2980b9;
      font-weight: 500;
      display: flex;
      gap: 15px;
      align-items: center;
    }
    .selection-summary .summary-item {
      display: inline-block;
      background-color: #ecf0f1;
      padding: 3px 8px;
      border-radius: 4px;
      border: 1px solid #bdc3c7;
    }
    .selection-summary b {
      color: #c0392b;
      padding-left: 5px;
    }

    .custom-alert-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.4); display: flex; justify-content: center;
        align-items: flex-start; z-index: 1000; padding-top: 50px;
        opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
    }
    .custom-alert-overlay.show { opacity: 1; visibility: visible; }
    .custom-alert-box {
        background: white; padding: 20px 40px 20px 20px; border-radius: 5px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3); min-width: 300px;
        max-width: 500px; position: relative; transform: translateY(-50px);
        transition: transform 0.3s; border-top: 4px solid #3498db;
    }
    .custom-alert-overlay.show .custom-alert-box { transform: translateY(0); }
    .custom-alert-box.info { border-top-color: #3498db; }
    .custom-alert-box.success { border-top-color: #2ecc71; }
    .custom-alert-box.error { border-top-color: #e74c3c; }
    #customAlertMessage { margin: 0; font-size: 16px; color: #333; }
    .custom-alert-close-btn {
        position: absolute; top: 5px; right: 10px; background: none;
        border: none; font-size: 24px; font-weight: bold; color: #aaa;
        cursor: pointer; padding: 5px; line-height: 1;
    }
    .custom-alert-close-btn:hover { color: #333; }
  </style>
</head>
<body>
  <h2>QUẢN LÝ ĐƠN HÀNG MGT - TEAM HÀ NỘI (CHẾ ĐỘ CHỈ XEM)</h2>

  <div id="mainFilters" class="main-filters">
    <div class="filter-group">
        <label for="filterMarket">Thị trường</label>
        <select id="filterMarket"><option value="">Tất cả</option></select>
    </div>
    <div class="filter-group">
        <label for="filterProduct">Sản phẩm</label>
        <select id="filterProduct"><option value="">Tất cả</option></select>
    </div>
    <div class="filter-group">
        <label for="filterDateFrom">Từ ngày</label>
        <input type="date" id="filterDateFrom">
    </div>
    <div class="filter-group">
        <label for="filterDateTo">Tới ngày</label>
        <input type="date" id="filterDateTo">
    </div>
    <div class="filter-group">
        <label for="fixedColumns">Số cột cố định</label>
        <input type="number" id="fixedColumns" value="1" min="0" style="width: 60px;">
    </div>
  </div>

  <div class="controls">
    <div>
      <button id="refreshData" class="refresh-btn">
        <span class="refresh-icon">↻</span> Load dữ liệu
      </button>
      <button id="updateAll">Cập nhật tất cả thay đổi</button>
      <button id="downloadExcel">Tải Excel</button>
      <span id="orderCounter" class="order-counter"></span>
      <span id="selectionSummary" class="selection-summary"></span>
    </div>
    <div>
      <button id="toggleTrackingView" class="tab-btn tracking-tab">Xem đơn có mã Tracking</button>
    </div>
  </div>
  
  <div class="table-wrapper" id="tableContainer">
    <table>
      <thead>
        <tr id="filterRow"></tr>
        <tr>
          <th>Mã đơn hàng</th>
          <th>Ngày lên đơn</th>
          <th>Team</th>
          <th>Name*</th><th>Phone*</th><th>Add</th><th>City</th><th>State</th><th>Khu vực</th><th>Zipcode</th><th>Mặt hàng</th><th>Tên mặt hàng 1</th><th>Số lượng mặt hàng 1</th><th>Tên mặt hàng 2</th><th>Số lượng mặt hàng 2</th><th>Quà tặng</th><th>Số lượng quà kèm</th><th>Giá bán</th><th>Loại tiền thanh toán</th><th>Tổng tiền VNĐ</th><th>Hình thức thanh toán</th><th>Ghi chú</th><th>Ghi chú vận đơn</th><th>Kết quả check</th><th>Mã Tracking</th><th>Ngày đóng hàng</th><th>Trạng thái giao hàng</th><th>Thời gian giao dự kiến</th><th>Ngày Kế toán đối soát với FFM lần 2</th><th>Phí ship nội địa Mỹ (usd)</th><th>Phí xử lý đơn đóng hàng-Lưu kho(usd)</th><th>GHI CHÚ</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>
  
  <div id="customAlert" class="custom-alert-overlay">
    <div id="customAlertBox" class="custom-alert-box">
      <p id="customAlertMessage"></p>
      <button id="customAlertClose" class="custom-alert-close-btn">×</button>
    </div>
  </div>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx_rU4gsMXugPUK9ZoTczyWpKdsPVO3QcXzdpswFKVQmnsMU6B6J9lirCO_7NvET78/exec';
    
    const TEAM_COLUMN_NAME = "Team"; 

    const displayColumns = ["Mã đơn hàng", "Ngày lên đơn", TEAM_COLUMN_NAME, "Name*", "Phone*", "Add", "City", "State", "Khu vực", "Zipcode", "Mặt hàng", "Tên mặt hàng 1", "Số lượng mặt hàng 1", "Tên mặt hàng 2", "Số lượng mặt hàng 2", "Quà tặng", "Số lượng quà kèm", "Giá bán", "Loại tiền thanh toán", "Tổng tiền VNĐ", "Hình thức thanh toán", "Ghi chú", "Ghi chú vận đơn", "Kết quả check", "Mã Tracking", "Ngày đóng hàng", "Trạng thái giao hàng", "Thời gian giao dự kiến", "Ngày Kế toán đối soát với FFM lần 2", "Phí ship nội địa Mỹ (usd)", "Phí xử lý đơn đóng hàng-Lưu kho(usd)", "GHI CHÚ"];
    const columnMapping = { "Ghi chú vận đơn": "ngày hẹn đẩy đơn", "Kết quả check": "Kết quả Check" };
    
    const editableCols = []; 
    const checkStatusOptions = ["", "OK", "Huỷ", "Chờ check lại", "Sai SĐT", "Sai địa chỉ", "Khác"];

    let state = {
        allData: [],
        pendingChanges: new Map(),
        showTrackingOrders: false,
        filterValues: {},
    };
    let pasteAnchorCell = null;

    // --- HÀM THÔNG BÁO TÙY CHỈNH ---
    function showCustomAlert(message, type = 'info', duration = 4000) {
        const alertOverlay = document.getElementById('customAlert');
        const alertBox = document.getElementById('customAlertBox');
        const alertMessage = document.getElementById('customAlertMessage');
        alertMessage.textContent = message;
        alertBox.className = 'custom-alert-box ' + type;
        alertOverlay.classList.add('show');
        const hideAlert = () => alertOverlay.classList.remove('show');
        if (duration) { setTimeout(hideAlert, duration); }
        document.getElementById('customAlertClose').onclick = hideAlert;
    }

    // --- CÁC HÀM UTILITY ---
    function formatDate(dateString) { if (!dateString) return ''; try { const date = new Date(dateString.includes('Z') ? dateString : dateString + 'Z'); if (isNaN(date.getTime())) return dateString; const day = String(date.getDate()).padStart(2, '0'); const month = String(date.getMonth() + 1).padStart(2, '0'); const year = date.getFullYear(); return `${day}/${month}/${year}`; } catch (e) { return dateString; } }
    function formatDateTime(dateString) { if (!dateString) return ''; try { const date = new Date(dateString.includes('Z') ? dateString : dateString + 'Z'); if (isNaN(date.getTime())) return dateString; const day = String(date.getDate()).padStart(2, '0'); const month = String(date.getMonth() + 1).padStart(2, '0'); const year = date.getFullYear(); const hours = String(date.getHours()).padStart(2, '0'); const minutes = String(date.getMinutes()).padStart(2, '0'); const seconds = String(date.getSeconds()).padStart(2, '0'); return `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`; } catch (e) { return dateString; } }
    function updateOrderCounter(count) { const counterElement = document.getElementById('orderCounter'); if (counterElement) { counterElement.innerHTML = `Tổng số đơn: <b>${count}</b>`; } }
    
    // --- XỬ LÝ DỮ LIỆU VÀ LỌC ---
    function handleData(response) {
      document.getElementById('refreshData').disabled = false;
      document.getElementById('refreshData').innerHTML = '<span class="refresh-icon">↻</span> Load dữ liệu';
      state.allData = []; 
      state.pendingChanges.clear();
      if (response.error) { showCustomAlert(`Lỗi tải dữ liệu: ${response.error}`, 'error'); return; }
      const data = response.rows || response.data || response;
      if (!Array.isArray(data)) { showCustomAlert('Dữ liệu trả về không hợp lệ.', 'error'); return; }
      state.allData = data;
      
      const initialDataForFilters = filterByCarrier(state.allData);
      populateMainFilters(initialDataForFilters);
      setupColumnFilters();
      render();
    }
    
    function filterByCarrier(data) {
        return data.filter(row => {
            const carrier = row["Đơn vị vận chuyển"] || row["Đơn_vị_vận_chuyển"];
            return carrier?.toString().toUpperCase() === "MGT";
        });
    }

    function populateMainFilters(data) {
        const marketFilter = document.getElementById('filterMarket');
        const productFilter = document.getElementById('filterProduct');
        const markets = [...new Set(data.map(row => row["Khu vực"]).filter(Boolean))].sort();
        const products = [...new Set(data.map(row => row["Mặt hàng"]).filter(Boolean))].sort();
        marketFilter.innerHTML = '<option value="">Tất cả Thị trường</option>';
        productFilter.innerHTML = '<option value="">Tất cả Sản phẩm</option>';
        markets.forEach(market => marketFilter.innerHTML += `<option value="${market}">${market}</option>`);
        products.forEach(product => productFilter.innerHTML += `<option value="${product}">${product}</option>`);
    }
    
    function getFilteredData() {
        const mgtData = filterByCarrier(state.allData);

        let dataToRender = mgtData.filter(row => {
            const trackingCode = String(row["Mã Tracking"] || row["Mã_Tracking"] || '');
            return state.showTrackingOrders ? trackingCode.trim() !== '' : !trackingCode.trim();
        });

        // THAY ĐỔI: Lọc toàn bộ data có Team = "Hà Nội"
        dataToRender = dataToRender.filter(row => row[TEAM_COLUMN_NAME] && String(row[TEAM_COLUMN_NAME]).toLowerCase().trim() === 'hà nội');

        const market = document.getElementById('filterMarket').value;
        const product = document.getElementById('filterProduct').value;
        const dateFrom = document.getElementById('filterDateFrom').value;
        const dateTo = document.getElementById('filterDateTo').value;

        if (market) { dataToRender = dataToRender.filter(row => row["Khu vực"] === market); }
        if (product) { dataToRender = dataToRender.filter(row => row["Mặt hàng"] === product); }
        if (dateFrom) { const from = new Date(dateFrom); from.setHours(0, 0, 0, 0); dataToRender = dataToRender.filter(row => row["Ngày lên đơn"] && new Date(row["Ngày lên đơn"]) >= from); }
        if (dateTo) { const to = new Date(dateTo); to.setHours(23, 59, 59, 999); dataToRender = dataToRender.filter(row => row["Ngày lên đơn"] && new Date(row["Ngày lên đơn"]) <= to); }
        
        const trackingIncludeRaw = state.filterValues['tracking_include'] || '';
        const trackingExcludeRaw = state.filterValues['tracking_exclude'] || '';
        const otherColumnFilters = Object.entries(state.filterValues).filter(([key, val]) => val.trim() !== '' && !key.startsWith('tracking_'));
        
        if (otherColumnFilters.length > 0) {
            dataToRender = dataToRender.filter(row => {
                return otherColumnFilters.every(([col, filterValue]) => {
                    const dataKey = columnMapping[col] || col;
                    const cellValue = row[dataKey] ?? row[col] ?? row[dataKey.replace(/ /g, '_')] ?? '';
                    return String(cellValue).toLowerCase().includes(filterValue.toLowerCase());
                });
            });
        }
        
        if (trackingIncludeRaw || trackingExcludeRaw) {
            const lowerInclude = trackingIncludeRaw.toLowerCase();
            const lowerExclude = trackingExcludeRaw.toLowerCase();
            dataToRender = dataToRender.filter(row => {
                const cellValue = String(row['Mã Tracking'] || ''); 
                const lowerCellValue = cellValue.toLowerCase();
                if (lowerExclude && lowerCellValue.includes(lowerExclude)) { return false; }
                if (lowerInclude) {
                    if (lowerInclude.includes('\n')) {
                        const codes = new Set(trackingIncludeRaw.split('\n').map(t => t.trim()).filter(Boolean));
                        if (!codes.has(cellValue.trim())) return false;
                    } else {
                        if (!lowerCellValue.includes(lowerInclude)) return false;
                    }
                }
                return true; 
            });
        }
        
        const sortKey = 'Ngày Kế toán đối soát với FFM lần 2';
        dataToRender.sort((a, b) => {
            const parseDate = (val) => { if (!val) return null; const date = new Date(val); return isNaN(date.getTime()) ? null : date; };
            const dateA = parseDate(a[sortKey]);
            const dateB = parseDate(b[sortKey]);
            if (dateA === null && dateB === null) return 0;
            if (dateA === null) return 1;
            if (dateB === null) return -1;
            return dateA.getTime() - dateB.getTime();
        });
        
        return dataToRender;
    }
    
    // --- HÀM CỐ ĐỊNH CỘT ĐỘNG ---
    function updateFixedColumns() {
        const numFixed = parseInt(document.getElementById('fixedColumns').value, 10);
        const table = document.querySelector('.table-wrapper table');
        if (!table) return;
        const rows = Array.from(table.rows);
        rows.forEach(row => {
            Array.from(row.cells).forEach(cell => {
                cell.classList.remove('fixed-column');
                cell.style.left = '';
            });
        });
        if (numFixed <= 0 || rows.length < 2) return;
        const headerCells = rows[1].cells;
        const offsets = [0];
        for (let i = 1; i < numFixed; i++) {
            if (headerCells[i - 1]) {
                offsets[i] = offsets[i - 1] + headerCells[i - 1].offsetWidth;
            }
        }
        rows.forEach(row => {
            for (let i = 0; i < numFixed; i++) {
                const cell = row.cells[i];
                if (cell) {
                    cell.classList.add('fixed-column');
                    cell.style.left = `${offsets[i] || 0}px`;
                }
            }
        });
    }

    // --- RENDER GIAO DIỆN ---
    function render() {
        const filteredData = getFilteredData();
        const container = document.getElementById('tableBody');
        container.innerHTML = '';
        if (filteredData.length === 0) { 
            // THAY ĐỔI: Cập nhật thông báo không có dữ liệu
            container.innerHTML = `<tr><td colspan="${displayColumns.length}" class="no-data">Không có dữ liệu cho team Hà Nội</td></tr>`;
            updateOrderCounter(0);
            return;
        }
        updateOrderCounter(filteredData.length);
        filteredData.forEach((row) => {
            const tr = document.createElement('tr');
            tr.dataset.orderId = row["Mã đơn hàng"]; 
            displayColumns.forEach(col => {
                const td = document.createElement('td');
                const dataKey = columnMapping[col] || col;
                let value = String(row[dataKey] ?? row[col] ?? row[col.replace(/ /g, '_')] ?? '');
                
                if (col === "Ngày Kế toán đối soát với FFM lần 2") {
                    value = formatDateTime(value);
                } else if (["Ngày lên đơn", "Ngày đóng hàng"].includes(col)) {
                    value = formatDate(value);
                }

                if (col === "Ghi chú vận đơn" && value) { td.classList.add('note-highlight'); }
                const checkValue = String(value).trim().toLowerCase();
                td.classList.remove('status-ok', 'status-cancel');
                if (col === "Kết quả check") {
                    if (checkValue === 'ok') td.classList.add('status-ok');
                    else if (checkValue.includes('huỷ')) td.classList.add('status-cancel');
                }
                
                td.textContent = value;
                
                tr.appendChild(td);
            });
            container.appendChild(tr);
        });
        updateFixedColumns();
    }
    
    function setupColumnFilters() {
        const filterRow = document.getElementById('filterRow');
        filterRow.innerHTML = '';
        state.filterValues = {};
        displayColumns.forEach((col, index) => {
            const th = document.createElement('th');
            if (col === "Mã Tracking") {
                const container = document.createElement('div'); container.className = 'dual-filter-container';
                const includeInput = document.createElement('input'); includeInput.type = 'text'; includeInput.className = 'filter-input'; includeInput.placeholder = 'Bao gồm...'; includeInput.addEventListener('input', () => { state.filterValues['tracking_include'] = includeInput.value; render(); });
                const excludeInput = document.createElement('input'); excludeInput.type = 'text'; excludeInput.className = 'filter-input'; excludeInput.placeholder = 'Loại trừ...'; excludeInput.addEventListener('input', () => { state.filterValues['tracking_exclude'] = excludeInput.value; render(); });
                container.appendChild(includeInput); container.appendChild(excludeInput); th.appendChild(container);
            } else {
                const input = document.createElement('input'); input.type = 'text'; input.className = 'filter-input'; input.placeholder = `Lọc ${col}`; input.dataset.column = col;
                input.addEventListener('input', () => { state.filterValues[col] = input.value; render(); });
                th.appendChild(input);
            }
            filterRow.appendChild(th);
        });
    }
    
    // --- CÁC HÀM ĐIỀU KHIỂN ---
    function setupControls() {
        document.getElementById('refreshData').addEventListener('click', refreshData);
        document.getElementById('toggleTrackingView').addEventListener('click', toggleTrackingView);
        document.getElementById('filterMarket').addEventListener('change', render);
        document.getElementById('filterProduct').addEventListener('change', render);
        document.getElementById('filterDateFrom').addEventListener('change', render);
        document.getElementById('filterDateTo').addEventListener('change', render);
        document.getElementById('downloadExcel').addEventListener('click', downloadAsExcel);
        document.getElementById('fixedColumns').addEventListener('change', updateFixedColumns);
    }
    
    function refreshData() { const btn = document.getElementById('refreshData'); btn.disabled = true; btn.innerHTML = '<span class="loading"></span> Đang tải...'; state.filterValues = {}; document.getElementById('filterRow').innerHTML = ''; document.getElementById('mainFilters').querySelectorAll('input, select').forEach(el => { if(el.id !== 'fixedColumns') el.value = ''; }); updateOrderCounter(0); loadData(); }
    function toggleTrackingView() { const btn = document.getElementById('toggleTrackingView'); const isActive = btn.classList.toggle('active'); state.showTrackingOrders = isActive; btn.textContent = isActive ? 'Xem đơn chưa có mã Tracking' : 'Xem đơn có mã Tracking'; render(); }
    function loadData() { document.getElementById('tableBody').innerHTML = `<tr><td colspan="${displayColumns.length}" style="text-align: center;">Đang tải...</td></tr>`; const script = document.createElement('script'); script.src = SCRIPT_URL + '?callback=handleData&rand=' + Math.random(); const oldScript = document.querySelector('script[src^="' + SCRIPT_URL + '"]'); if (oldScript) document.body.removeChild(oldScript); document.body.appendChild(script); }

    function getCellValue(cell) { return cell ? cell.textContent : ''; }

    function updateSelectionSummary() { const summaryEl = document.getElementById('selectionSummary'); const selectedCells = document.querySelectorAll('td.cell-selected'); summaryEl.innerHTML = ''; if (selectedCells.length <= 1) { return; } const numericKeywords = ["số lượng", "giá", "tiền", "phí", "zipcode"]; const columns = new Map(); selectedCells.forEach(cell => { const colIndex = cell.cellIndex; if (!columns.has(colIndex)) { columns.set(colIndex, []); } columns.get(colIndex).push(cell); }); const summaryParts = []; columns.forEach((cells, colIndex) => { const headerText = displayColumns[colIndex].toLowerCase(); const isNumeric = numericKeywords.some(kw => headerText.includes(kw)); if (isNumeric) { let sum = 0; let count = 0; cells.forEach(cell => { const value = getCellValue(cell); const num = parseFloat(String(value).replace(/[^\d.-]/g, '')); if (!isNaN(num)) { sum += num; count++; } }); if (count > 0) { summaryParts.push(`<span class="summary-item">${displayColumns[colIndex]} | Sum: <b>${sum.toLocaleString('vi-VN')}</b></span>`); } } else { let count = 0; cells.forEach(cell => { if (getCellValue(cell).trim() !== '') { count++; } }); if (count > 0) { summaryParts.push(`<span class="summary-item">${displayColumns[colIndex]} | Count: <b>${count}</b></span>`); } } }); summaryEl.innerHTML = summaryParts.join(''); }
    
    function setupInteractionHandlers() {
        const tableBody = document.getElementById('tableBody'); if (!tableBody) return;
        let isSelecting = false, startCell = null;
        const clearAllSelections = () => { document.querySelectorAll('td.cell-selected').forEach(c => c.classList.remove('cell-selected')); updateSelectionSummary(); };
        const selectCells = (start, end) => { clearAllSelections(); const tableRows = tableBody.rows; const minRow = Math.min(start.parentElement.rowIndex, end.parentElement.rowIndex); const maxRow = Math.max(start.parentElement.rowIndex, end.parentElement.rowIndex); const minCol = Math.min(start.cellIndex, end.cellIndex); const maxCol = Math.max(start.cellIndex, end.cellIndex); for (let i = 0; i < tableRows.length; i++) { const row = tableRows[i]; if (row.rowIndex >= minRow && row.rowIndex <= maxRow) { for (let j = minCol; j <= maxCol; j++) { if (row.cells[j]) row.cells[j].classList.add('cell-selected'); } } } };
        tableBody.addEventListener('mousedown', e => { if (e.button !== 0) return; const cell = e.target.closest('td'); if (!cell) return; e.preventDefault(); if (e.shiftKey && startCell) { selectCells(startCell, cell); updateSelectionSummary(); } else { isSelecting = true; clearAllSelections(); startCell = cell; cell.classList.add('cell-selected'); updateSelectionSummary(); } });
        tableBody.addEventListener('mousemove', e => { if (!isSelecting || !startCell) return; const currentCell = e.target.closest('td'); if (currentCell) { selectCells(startCell, currentCell); } });
        document.addEventListener('mouseup', () => { if (isSelecting) { isSelecting = false; updateSelectionSummary(); } });
        document.addEventListener('copy', e => { const selectedCells = document.querySelectorAll('td.cell-selected'); if (selectedCells.length === 0) return; e.preventDefault(); const rows = new Map(); selectedCells.forEach(cell => { const rowIndex = cell.parentElement.rowIndex; if (!rows.has(rowIndex)) rows.set(rowIndex, []); rows.get(rowIndex).push({ colIndex: cell.cellIndex, text: getCellValue(cell) }); }); const sortedRows = [...rows.entries()].sort((a, b) => a[0] - b[0]); const copyText = sortedRows.map(([, cells]) => cells.sort((a, b) => a.colIndex - b[0]).map(cell => cell.text).join('\t')).join('\n'); e.clipboardData.setData('text/plain', copyText); showCustomAlert(`Đã sao chép ${selectedCells.length} ô.`, 'info', 2000); });
    }

    // --- HÀM TẢI FILE EXCEL (CSV) ---
    function downloadAsExcel() {
        const dataToExport = getFilteredData();
        if (dataToExport.length === 0) { showCustomAlert("Không có dữ liệu để tải về.", 'info'); return; }
        const sanitizeCsvCell = (cell, colName) => {
            if (cell === null || cell === undefined) return '';
            let str = String(cell);
            if ((colName === "Mã Tracking" || colName === "Phone*") && str) {
                return `="${str.replace(/"/g, '""')}"`;
            }
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                str = str.replace(/"/g, '""');
                return `"${str}"`;
            }
            return str;
        };
        const headers = displayColumns.map(col => sanitizeCsvCell(col, col)).join(',');
        const rows = dataToExport.map(row => { 
            return displayColumns.map(col => { 
                const dataKey = columnMapping[col] || col; 
                let value = row[dataKey] ?? row[col] ?? row[col.replace(/ /g, '_')] ?? ''; 
                
                if (col === "Ngày Kế toán đối soát với FFM lần 2") {
                    value = formatDateTime(value);
                } else if (["Ngày lên đơn", "Ngày đóng hàng"].includes(col)) {
                    value = formatDate(value);
                }
                return sanitizeCsvCell(value, col); 
            }).join(','); 
        }).join('\n');
        const BOM = '\uFEFF'; const csvContent = BOM + headers + '\n' + rows;
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        if (link.download !== undefined) { const url = URL.createObjectURL(blob); const today = new Date(); const dateStr = `${today.getFullYear()}${(today.getMonth()+1).toString().padStart(2,'0')}${today.getDate().toString().padStart(2,'0')}`; link.setAttribute("href", url); link.setAttribute("download", `BaoCaoDonHang_MGT_TeamHaNoi_${dateStr}.csv`); link.style.visibility = 'hidden'; document.body.appendChild(link); link.click(); document.body.removeChild(link); }
    }

    // --- KHỞI TẠO ---
    document.addEventListener('DOMContentLoaded', () => {
        setupControls();
        setupInteractionHandlers(); 
        refreshData();
    });
  </script>
</body>
</html>

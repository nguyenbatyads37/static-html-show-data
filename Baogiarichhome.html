<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Báo giá + Biểu đồ sản lượng kWh</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body{
      margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:#f1f5f9; color:#0f172a; padding:24px;
    }
    .wrap{
      max-width:1100px; margin:0 auto;
      background: #fff;
      padding: 24px;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.07);
    }
    
    /* --- Nút In --- */
    .actions-container{
        max-width: 1100px; margin: 0 auto 16px;
        text-align: right;
    }
    #printBtn{
        display: inline-flex; align-items: center; gap: 8px;
        background-color: #1e40af; color: white;
        font-family: Inter, sans-serif; font-size: 15px; font-weight: 600;
        border: none; border-radius: 8px;
        padding: 10px 16px;
        cursor: pointer;
        transition: background-color .2s;
    }
    #printBtn:hover{ background-color: #1d4ed8; }

    /* ===== Header / Logo ===== */
    .header-top{
      display:flex; justify-content:space-between; align-items:center;
      border-bottom:3px solid #1e40af; padding-bottom:12px;
      margin-bottom:20px;
    }
    .logo{ display:flex; align-items:center; gap:14px; }
    .logo img{height:60px}
    .info{
      text-align:center; color:#1e40af;
      font-size:22px; font-weight:800; line-height:1.5;
    }
    .header-right img{height:80px; max-width:120px}

    /* ===== Customer info ===== */
    .cust-info{margin-bottom:16px; font-size:14px}
    .cust-info td{padding:4px 8px}

    /* ===== Bảng báo giá ===== */
    table{border-collapse:collapse; width:100%; font-size:14px; margin-bottom:32px}
    th,td{border:1px solid #cbd5e1; padding:8px; text-align:center; vertical-align:middle}
    th{background:#1e40af; color:#fff}
    td img{height:60px; object-fit:cover; max-width: 100%;}

    /* ===== Tiêu đề chính ===== */
    h2{
      text-align:center; margin:20px 0; color:#1e40af;
      font-size:28px; font-weight:800; letter-spacing:.3px;
    }

    /* ===== Biểu đồ ===== */
    .card{
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:16px; padding:20px;
      box-shadow:0 6px 20px rgba(0,0,0,.08);
    }
    .chart-wrap{position:relative; width:100%; height:420px; padding:12px}
    .skeleton{
      position:absolute; inset:12px; border-radius:16px; border:1px dashed #d1d5db;
      background:linear-gradient(90deg, rgba(0,0,0,0.02) 0%, rgba(0,0,0,0.06) 50%, rgba(0,0,0,0.02) 100%);
      background-size: 200% 100%; animation: shimmer 1.4s infinite;
    }
    @keyframes shimmer{ 0%{background-position:200% 0} 100%{background-position:-200% 0} }

    .foot{display:flex; justify-content:space-between; align-items:center; color:#475569; font-size:12px; margin-top:8px}
    .src a{color:#0ea5e9; text-decoration:none}

    /* Responsive: khi màn nhỏ */
    @media (max-width: 720px){
      body { padding: 12px; }
      .wrap { padding: 16px; }
      .header-top{flex-direction:column; gap:12px}
    }

    /* ===== CSS DÀNH RIÊNG CHO VIỆC IN ẤN ===== */
    @media print {
      /* Ẩn các thành phần không cần thiết */
      .actions-container, .foot .src {
        display: none;
      }
      /* Thiết lập lại layout cho trang in */
      body {
        padding: 0;
        background: #fff;
        font-size: 10pt; /* Dùng đơn vị 'pt' cho in ấn là chuẩn nhất */
      }
      .wrap {
        max-width: 100%;
        margin: 0;
        padding: 0;
        box-shadow: none;
        border: none;
        border-radius: 0;
      }
      /* Tinh chỉnh khoảng cách cho gọn gàng */
      h2 {
        margin-top: 20px;
        margin-bottom: 10px;
        font-size: 22pt;
      }
      table { margin-bottom: 20px; }
      
      /* Bắt buộc trình duyệt phải in màu nền (rất quan trọng) */
      th {
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }

      /* Tránh bị ngắt trang ở những vị trí không mong muốn */
      tr, .card {
        page-break-inside: avoid;
      }
      .card {
        border: 1px solid #ccc;
        box-shadow: none;
      }
      /* Biểu đồ có thể cần giảm kích thước để vừa trang A4 */
      .chart-wrap {
        height: 350px;
      }
    }
  </style>
</head>
<body>

  <!-- Nút In được đặt ở đây -->
  <div class="actions-container">
    <button id="printBtn">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
      In Báo Giá (PDF)
    </button>
  </div>

  <div class="wrap">
    <!-- Header -->
    <div class="header-top">
      <div class="logo">
        <img src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Fd5c0b92e.%E1%BA%A2nh.031051.png" alt="logo"/>
      </div>
      <div class="info">
        Năng lượng xanh - cuộc sống xanh<br/>
        Lợi ích lâu dài – sinh lời bền vững<br/>
        ☎ 0854.866.866, 0945.396.911
      </div>
      <div class="header-right">
        <img src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Fd20565af.%E1%BA%A2nh.031058.png" alt="solar"/>
      </div>
    </div>

    <!-- Thông tin khách hàng -->
    <table class="cust-info">
      <tr>
        <td><b>Tên khách hàng:</b> Em Đạt</td>
        <td><b>Đơn hàng:</b> <span id="orderIdText" data-order-id="PO20259001">PO20259001</span></td>
      </tr>
      <tr>
        <td><b>Số điện thoại:</b> NA</td>
        <td><b>Ngày báo giá:</b> 14/09/2025</td>
      </tr>
      <tr>
        <td colspan="2"><b>Địa chỉ:</b> Kiến An - Hải Phòng</td>
      </tr>
    </table>

    <p>Xin cảm ơn quý khách đã quan tâm tới sản phẩm và dịch vụ của Richhome. Chúng tôi xin được gửi tới quý khách chi tiết như sau:</p>

    <h2>BẢNG BÁO GIÁ</h2>
    <table>
      <thead>
        <tr>
          <th>STT</th>
          <th>Tên sản phẩm</th>
          <th>Thông tin sản phẩm</th>
          <th>Hình ảnh</th>
          <th>Số lượng</th>
          <th>Giá bán</th>
          <th>Thành tiền</th>
          <th>Bảo hành</th>
        </tr>
      </thead>
      <tbody id="quote-body">
        <!-- Dữ liệu được render ở đây -->
      </tbody>
      <tfoot>
        <tr>
          <td colspan="6" style="text-align:right;font-weight:700">Tổng cộng</td>
          <td id="grandTotal" style="font-weight:700">0</td>
          <td></td>
        </tr>
      </tfoot>
    </table>

    <!-- Biểu đồ -->
    <div class="card">
      <h2>Sản lượng điện (kWh) theo tháng</h2>
      <div class="chart-wrap">
        <div class="skeleton" id="skeleton"></div>
        <canvas id="chart"></canvas>
      </div>
      <div class="foot">
        <div class="src">Nguồn API:
          <a id="apiUrlLink" href="#" target="_blank">Google Apps Script JSON</a>
        </div>
        <div id="status">Đang tải dữ liệu…</div>
      </div>
    </div>
  </div>

  <!-- Chart.js v4 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
  <script>
    // ====== Cấu hình ======
    const API = 'https://script.google.com/macros/s/AKfycbwVY_D5_6IObsUMP06ipkIwCdl7bhoCHOYbAJn57ydqAHB6SZn18KBihEprE2uAycvRdw/exec';
    
    document.getElementById('apiUrlLink').href = API;

    // ====== Sự kiện cho nút In ======
    document.getElementById('printBtn').addEventListener('click', function() {
      window.print();
    });

    // ====== Helpers ======
    function fmtNumber(x){return Number(x||0).toLocaleString('vi-VN');}
    function toNumberSafe(x){
      if(x==null) return null;
      const s = String(x).replace(/[^\d,.\-]/g,'').replace(',','.');
      const v = Number(s); return Number.isFinite(v)?v:null;
    }
    function pickKey(obj, includes){
      const keys = Object.keys(obj||{});
      const t = includes.map(s=>s.toLowerCase());
      return keys.find(k=>t.every(x=>k.toLowerCase().includes(x)));
    }
    function getOrderId(){
      const usp = new URLSearchParams(location.search);
      const idFromUrl = usp.get('id');
      const fallback = document.getElementById('orderIdText')?.dataset?.orderId || '';
      return idFromUrl || fallback || '';
    }

    // ====== Biểu đồ ======
    let chart;
    function renderChart(labels,data){
      if(chart) chart.destroy();
      const ctx = document.getElementById('chart');
      chart = new Chart(ctx,{
        type:'bar',
        data:{labels,datasets:[{data,label:'Sản lượng (kWh)',backgroundColor:'#ff8a00',borderRadius:8}]},
        options:{
          maintainAspectRatio:false,
          plugins:{
            legend:{display:false},
            datalabels:{anchor:'end',align:'end',color:'#111',formatter:v=>v?fmtNumber(v):''}
          },
          scales:{
            x:{ticks:{color:'#111'}},
            y:{beginAtZero:true,ticks:{color:'#111',callback:v=>fmtNumber(v)},title:{display:true,text:'kWh'}}
          }
        },
        plugins:[ChartDataLabels]
      });
    }

    // ====== Render bảng báo giá ======
    function renderQuote(items){
      const tbody = document.getElementById('quote-body');
      tbody.innerHTML = '';
      let sum = 0;
      
      console.log("Dữ liệu chi tiết đơn hàng đã được lọc:", items);

      items.forEach((r, idx)=>{
        const ten = r['Tên sản phẩm'] ?? r['Mã sản phẩm'] ?? '';
        const info = r['Thông tin sản phẩm'] ?? '';
        const imageUrl = r['imageUrl'] ?? '';
        const sl = toNumberSafe(r['Số lượng']) ?? 0;
        const gia = toNumberSafe(r['Giá bán']) ?? 0;
        const tt = toNumberSafe(r['Thành tiền']);
        const thanhTien = (tt != null ? tt : (sl * gia)) || 0;
        sum += thanhTien;
        const baoHanh = r['COL_12'] ?? '';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td style="text-align:left">${ten}</td>
          <td style="text-align:left">${info}</td>
          <td>${imageUrl ? `<img src="${imageUrl}" alt="ảnh sản phẩm">` : ''}</td>
          <td>${fmtNumber(sl)}</td>
          <td>${fmtNumber(gia)}</td>
          <td>${fmtNumber(thanhTien)}</td>
          <td>${baoHanh}</td>
        `;
        tbody.appendChild(tr);
      });
      document.getElementById('grandTotal').textContent = fmtNumber(sum);
    }

    // ====== Load tất cả ======
    async function loadAll(){
      const orderId = getOrderId();
      const orderSpan = document.getElementById('orderIdText');
      if(orderSpan) orderSpan.textContent = orderId || orderSpan.textContent;

      document.getElementById('skeleton').style.display='block';
      document.getElementById('status').textContent='Đang tải dữ liệu…';

      try{
        const res = await fetch(API,{cache:'no-store'});
        if(!res.ok){ throw new Error(`HTTP error! status: ${res.status}`) }
        const json = await res.json();
        console.log("Dữ liệu gốc nhận từ API:", json);

        // ----- Biểu đồ -----
        const bieuDoRows = json?.BIEU_DO?.rows ?? json?.BIEU_DO;
        const rowsRaw = Array.isArray(bieuDoRows) ? bieuDoRows.filter(Boolean) : [];
        
        if(rowsRaw.length){
          const mKey = pickKey(rowsRaw[0],['tháng']) || 'Tháng';
          const vKey = pickKey(rowsRaw[0],['sản lượng','kwh']) || 'Sản lượng Kwh';
          const rows = rowsRaw
            .map(x=>({ ...x }))
            .sort((a,b)=>Number(toNumberSafe(a[mKey])) - Number(toNumberSafe(b[mKey])));
          const labels = rows.map(r=>'T'+Number(toNumberSafe(r[mKey])));
          const data = rows.map(r=>toNumberSafe(r[vKey]));
          renderChart(labels,data);
          document.getElementById('status').textContent='Đã tải '+data.filter(v=>v!=null).length+' điểm dữ liệu.';
        } else {
          document.getElementById('status').textContent='Không có dữ liệu biểu đồ.';
        }

        // ----- Báo giá từ CHI_TIET_DON_HANG -----
        const quoteRows = json?.CHI_TIET_DON_HANG?.rows;
        const quoteAll = Array.isArray(quoteRows) ? quoteRows.filter(Boolean) : [];
        
        const filtered = orderId ? quoteAll.filter(r=>String(r['Đơn hàng']||'')===orderId) : [];
        if (filtered.length > 0) {
            renderQuote(filtered);
        } else {
            document.getElementById('quote-body').innerHTML = `<tr><td colspan="8">Không tìm thấy chi tiết cho đơn hàng "${orderId}".</td></tr>`;
        }

      }catch(e){
        console.error(e);
        document.getElementById('status').textContent = 'Lỗi tải dữ liệu: ' + e.message;
      }finally{
        document.getElementById('skeleton').style.display='none';
      }
    }

    // Khởi động
    loadAll();
  </script>
</body>
</html>


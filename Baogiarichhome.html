<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Báo giá + Biểu đồ sản lượng kWh</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body{
      margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:#fff; color:#0f172a; padding:24px;
    }
    .wrap{max-width:1100px; margin:0 auto}

    /* ===== Header / Logo ===== */
    .header-top{display:flex; justify-content:space-between; align-items:center; border-bottom:3px solid #1e40af; padding-bottom:12px; margin-bottom:20px}
    .logo{display:flex; align-items:center; gap:10px}
    .logo img{height:60px}
    .info{font-size:14px; line-height:1.5}
    .info b{color:#1e40af}

    /* ===== Customer info ===== */
    .cust-info{margin-bottom:16px; font-size:14px}
    .cust-info td{padding:4px 8px}

    /* ===== Bảng báo giá ===== */
    table{border-collapse:collapse; width:100%; font-size:14px; margin-bottom:32px}
    th,td{border:1px solid #cbd5e1; padding:8px; text-align:center}
    th{background:#1e40af; color:#fff}
    td img{height:60px}

    h2{text-align:center; margin:20px 0; color:#111827}

    /* ===== Biểu đồ ===== */
    .card{
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:16px; padding:20px;
      box-shadow:0 6px 20px rgba(0,0,0,.08);
    }
    .chart-wrap{position:relative; width:100%; height:420px; padding:12px}
    .skeleton{
      position:absolute; inset:12px; border-radius:16px; border:1px dashed #d1d5db;
      background:linear-gradient(90deg, rgba(0,0,0,0.02) 0%, rgba(0,0,0,0.06) 50%, rgba(0,0,0,0.02) 100%);
      background-size: 200% 100%; animation: shimmer 1.4s infinite;
    }
    @keyframes shimmer{ 0%{background-position:200% 0} 100%{background-position:-200% 0} }

    .foot{display:flex; justify-content:space-between; align-items:center; color:#475569; font-size:12px; margin-top:8px}
    .src a{color:#0ea5e9; text-decoration:none}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Header -->
    <div class="header-top">
      <div class="logo">
        <img src="https://dummyimage.com/100x60/1e40af/fff&text=LOGO" alt="logo"/>
        <div class="info">
          <b>Năng lượng xanh - cuộc sống xanh</b><br/>
          Lợi ích lâu dài – sinh lời bền vững<br/>
          ☎ 0854.866.866, 0945.396.911
        </div>
      </div>
      <div><img src="https://dummyimage.com/120x80/cccccc/000&text=Solar" alt="solar"/></div>
    </div>

    <!-- Thông tin khách hàng -->
    <table class="cust-info">
      <tr>
        <td><b>Tên khách hàng:</b> Em Đạt</td>
        <td><b>Đơn hàng:</b> PO20259001</td>
      </tr>
      <tr>
        <td><b>Số điện thoại:</b> NA</td>
        <td><b>Ngày báo giá:</b> 14/09/2025</td>
      </tr>
      <tr>
        <td colspan="2"><b>Địa chỉ:</b> Kiến An - Hải Phòng</td>
      </tr>
    </table>

    <p>Xin cảm ơn quý khách đã quan tâm tới sản phẩm và dịch vụ của Richhome. Chúng tôi xin được gửi tới quý khách chi tiết như sau:</p>

    <h2>BẢNG BÁO GIÁ</h2>
    <table>
      <thead>
        <tr>
          <th>STT</th>
          <th>Tên sản phẩm</th>
          <th>Thông tin sản phẩm</th>
          <th>Hình ảnh</th>
          <th>Số lượng</th>
          <th>Giá bán</th>
          <th>Thành tiền</th>
          <th>Bảo hành</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>1</td>
          <td>Tấm pin nlmt AE 700W</td>
          <td>Tấm pin 700W hiệu suất cao, lắp đặt dễ, bền bỉ</td>
          <td><img src="https://dummyimage.com/60x60/ff8a00/fff&text=Pin" alt="pin"/></td>
          <td>12</td>
          <td>2,850,000</td>
          <td>34,200,000</td>
          <td>12 Năm</td>
        </tr>
        <tr>
          <td>2</td>
          <td>Dây điện kết nối tấm pin</td>
          <td>Dây điện chịu UV, 2 lớp cách điện</td>
          <td><img src="https://dummyimage.com/60x60/f87171/fff&text=Dây" alt="dây"/></td>
          <td>100</td>
          <td>15,000</td>
          <td>1,500,000</td>
          <td>3 Năm</td>
        </tr>
      </tbody>
    </table>

    <!-- Biểu đồ -->
    <div class="card">
      <h2>Sản lượng điện (kWh) theo tháng</h2>
      <div class="chart-wrap">
        <div class="skeleton" id="skeleton"></div>
        <canvas id="chart"></canvas>
      </div>
      <div class="foot">
        <div class="src">Nguồn API: 
          <a href="https://script.google.com/macros/s/AKfycbx8P6QVtjZKxXzCzIEFIOy0sTrmW2s8mLyQs98p1u-3PxNt-1NWtrMKsqyB8NqngNR5Dw/exec" target="_blank">Google Apps Script JSON</a>
        </div>
        <div id="status">Đang tải dữ liệu…</div>
      </div>
    </div>
  </div>

  <!-- Chart.js v4 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
  <script>
    const API = 'https://script.google.com/macros/s/AKfycbx8P6QVtjZKxXzCzIEFIOy0sTrmW2s8mLyQs98p1u-3PxNt-1NWtrMKsqyB8NqngNR5Dw/exec';
    const ctx = document.getElementById('chart');
    let chart;

    function fmtNumber(x){return Number(x||0).toLocaleString('vi-VN');}
    function toNumberSafe(x){
      if(x==null) return null;
      const s = String(x).replace(/[^\d,.\-]/g,'').replace(',','.');
      const v = Number(s); return Number.isFinite(v)?v:null;
    }
    function pickKey(obj, includes){
      const keys = Object.keys(obj||{});
      const t = includes.map(s=>s.toLowerCase());
      return keys.find(k=>t.every(x=>k.toLowerCase().includes(x)));
    }

    async function load(){
      document.getElementById('skeleton').style.display='block';
      document.getElementById('status').textContent='Đang tải dữ liệu…';
      try{
        const res=await fetch(API,{cache:'no-store'});
        const json=await res.json();
        const rowsRaw=(json?.BIEU_DO||[]).filter(Boolean);
        const mKey=pickKey(rowsRaw[0],['tháng'])||'Tháng';
        const vKey=pickKey(rowsRaw[0],['sản lượng','kwh'])||'Sản lượng kWh';
        const rows=rowsRaw.sort((a,b)=>Number(toNumberSafe(a[mKey]))-Number(toNumberSafe(b[mKey])));
        const labels=rows.map(r=>'T'+Number(toNumberSafe(r[mKey])));
        const data=rows.map(r=>toNumberSafe(r[vKey]));
        render(labels,data);
        document.getElementById('status').textContent='Đã tải '+data.filter(v=>v!=null).length+' điểm dữ liệu.';
      }catch(e){console.error(e);document.getElementById('status').textContent='Lỗi tải dữ liệu';}
      finally{document.getElementById('skeleton').style.display='none';}
    }

    function render(labels,data){
      if(chart) chart.destroy();
      chart=new Chart(ctx,{
        type:'bar',
        data:{labels,datasets:[{data,label:'Sản lượng (kWh)',backgroundColor:'#ff8a00',borderRadius:8}]},
        options:{
          maintainAspectRatio:false,
          plugins:{
            legend:{display:false},
            datalabels:{anchor:'end',align:'end',color:'#111',formatter:v=>v?fmtNumber(v):''}
          },
          scales:{
            x:{ticks:{color:'#111'}},
            y:{beginAtZero:true,ticks:{color:'#111',callback:v=>fmtNumber(v)},title:{display:true,text:'kWh'}}
          }
        },
        plugins:[ChartDataLabels]
      });
    }
    load();
  </script>
</body>
</html>

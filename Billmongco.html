<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>In Đơn Hàng - Debug Version</title>
    <style>
        body { font-family: Arial, sans-serif; background: #555; margin: 0; padding: 20px; color: #000; }
        
        /* Debug Box - Để hiển thị lỗi cho bạn xem */
        #debug-info {
            background: #333; color: #0f0; font-family: monospace; 
            padding: 10px; margin-bottom: 20px; white-space: pre-wrap; 
            font-size: 12px; border: 1px solid #0f0; display: none;
        }

        #invoices-wrapper { width: 100%; max-width: 85mm; margin: 0 auto; display: flex; flex-direction: column; gap: 30px; }
        .invoice-page { width: 76mm; background: #fff; padding: 4mm; min-height: 150mm; margin: 0 auto; position: relative; }
        
        /* CSS cho hóa đơn */
        .header { text-align: center; border-bottom: 2px dashed #000; padding-bottom: 8px; margin-bottom: 10px; }
        .company-name { color: #cc0000; font-weight: 900; font-size: 19pt; margin: 0; text-transform: uppercase; }
        .customer-info { font-size: 10pt; border-bottom: 1px solid #aaa; padding-bottom: 8px; margin-bottom: 10px; }
        .row { display: flex; margin-bottom: 4px; }
        .label { font-weight: bold; width: 60px; }
        .value { font-weight: 600; flex-grow: 1; }
        table { width: 100%; border-collapse: collapse; font-size: 10pt; margin-bottom: 10px; }
        th { border-bottom: 2px solid #000; text-align: left; font-size: 9pt; }
        td { border-bottom: 1px dotted #999; padding: 6px 0; font-weight: 600; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .total-section { text-align: right; font-size: 12pt; font-weight: 900; border-top: 2px dashed #000; padding-top: 8px; }
        .total-price { color: #cc0000; font-size: 16pt; }
        .qr-container { text-align: center; margin-top: 10px; border-top: 1px dotted #000; padding-top: 10px; }
        .qr-img { width: 40mm; height: 40mm; }

        @media print {
            body { background: #555; }
            #debug-info, .controls { display: none !important; }
            .invoice-page { page-break-after: always; }
        }
    </style>
</head>
<body>

    <!-- KHUNG HIỂN THỊ TRẠNG THÁI & LỖI (Quan trọng để debug) -->
    <div id="status-message" style="text-align: center; color: white; font-size: 18px; padding: 20px;">
        Đang kết nối dữ liệu...
    </div>
    
    <div id="debug-info"></div>

    <div id="invoices-wrapper"></div>

    <script>
        // --- CẤU HÌNH ---
        const API_URL = "https://script.google.com/macros/s/AKfycbwpJsxVad9VBvd9CPlNDGLu-Brfwlk6yXEPN7Kgc-Mr3UqgXKqM52LPS-ANdklmA1bY/exec";
        
        // --- HÀM HỖ TRỢ ---
        function log(msg) {
            console.log(msg);
            const debugBox = document.getElementById('debug-info');
            debugBox.style.display = 'block';
            debugBox.innerHTML += msg + "\n";
        }

        function formatMoney(amount) {
            if (!amount && amount !== 0) return "0";
            return new Intl.NumberFormat('en-US').format(amount);
        }

        function formatDate(dateString) {
            if (!dateString) return "";
            try {
                const date = new Date(dateString);
                return isNaN(date.getTime()) ? dateString : date.toLocaleString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' });
            } catch (e) { return dateString; }
        }

        // --- HÀM RENDER ---
        function renderInvoices(orders) {
            const wrapper = document.getElementById('invoices-wrapper');
            wrapper.innerHTML = "";
            let html = "";

            orders.forEach(item => {
                // CHÚ Ý: Đảm bảo tên trường khớp với Google Sheet
                const idOder = item['ID oder'] || item['ID'] || 'N/A';
                const customer = item['Customer name'] || '';
                const phone = item['Mobile'] || '';
                const address = item['Address'] || '';
                const product = item['Product'] || '';
                const detail = item['Detail'] ? `(${item['Detail']})` : '';
                const qty = item['Quantity'] || 0;
                const total = formatMoney(item['Total MNT']);
                const date = formatDate(item['Date']);
                
                // QR Logic
                let qrSrc = item['QR code'];
                if (!qrSrc) qrSrc = `https://quickchart.io/qr?text=${encodeURIComponent(idOder)}&size=200`;

                html += `
                <div class="invoice-page">
                    <div class="header">
                        <h1 class="company-name">Viet Long Global</h1>
                        <div>Logistics & Trading Services</div>
                    </div>
                    <div class="customer-info">
                        <div class="row"><span class="label">Date:</span><span class="value">${date}</span></div>
                        <div class="row"><span class="label">To:</span><span class="value">${customer}</span></div>
                        <div class="row"><span class="label">Phone:</span><span class="value">${phone}</span></div>
                        <div class="row"><span class="label">Addr:</span><span class="value">${address}</span></div>
                    </div>
                    <table>
                        <thead><tr><th>Product</th><th class="text-center">Qty</th><th class="text-right">Total</th></tr></thead>
                        <tbody>
                            <tr>
                                <td>${product} <br><i>${detail}</i></td>
                                <td class="text-center">${qty}</td>
                                <td class="text-right">${total}</td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="total-section">Total: <span class="total-price">${total} ₮</span></div>
                    <div class="qr-container">
                        <img src="${qrSrc}" class="qr-img"><br>
                        <b>${idOder}</b>
                    </div>
                    <div style="text-align:center; margin-top:10px; font-style:italic;">Thank you!</div>
                </div>`;
            });

            wrapper.innerHTML = html;
        }

        // --- HÀM TẢI DỮ LIỆU ---
        async function loadData() {
            log("1. Bắt đầu tải dữ liệu từ API...");
            try {
                const response = await fetch(API_URL);
                log(`2. Trạng thái kết nối: ${response.status} ${response.statusText}`);
                
                if (!response.ok) throw new Error("Không kết nối được API.");

                const json = await response.json();
                log("3. Đã nhận JSON thành công.");

                // Xử lý cấu trúc dữ liệu (Khắc phục lỗi data không load)
                let allData = [];
                if (json.data && Array.isArray(json.data)) {
                    allData = json.data;
                    log("-> Phát hiện dữ liệu nằm trong biến 'data'");
                } else if (Array.isArray(json)) {
                    allData = json;
                    log("-> Phát hiện dữ liệu là mảng trực tiếp");
                } else {
                    log("-> CẤU TRÚC JSON KHÔNG HỢP LỆ: " + JSON.stringify(json).substring(0, 100));
                    throw new Error("Cấu trúc JSON không đúng định dạng mong đợi.");
                }

                if (allData.length > 0) {
                    log("-> Các cột tìm thấy trong dòng đầu tiên: " + Object.keys(allData[0]).join(", "));
                } else {
                    throw new Error("Dữ liệu rỗng.");
                }

                // --- LỌC THEO URL ---
                const urlParams = new URLSearchParams(window.location.search);
                const idParam = urlParams.get('id');
                
                if (idParam) {
                    const targetIds = idParam.split(',').map(s => s.trim());
                    log(`4. Đang lọc theo ID oder: ${targetIds.join(", ")}`);

                    // Lọc dữ liệu (Chuyển về chuỗi để so sánh chính xác)
                    const filtered = allData.filter(item => {
                        const rawId = item['ID oder']; // Lấy chính xác tên cột này
                        return targetIds.includes(String(rawId).trim());
                    });

                    if (filtered.length === 0) {
                        document.getElementById('status-message').innerHTML = `
                            ❌ Đã tải dữ liệu nhưng không tìm thấy ID nào trùng khớp.<br>
                            ID yêu cầu: ${idParam}<br>
                            (Kiểm tra lại tên cột "ID oder" trong Google Sheet)
                        `;
                        log("-> Không tìm thấy kết quả nào trùng khớp.");
                    } else {
                        document.getElementById('status-message').style.display = 'none';
                        log(`-> Tìm thấy ${filtered.length} đơn hàng.`);
                        renderInvoices(filtered);
                    }
                } else {
                    log("-> Không có tham số ?id=, hiển thị toàn bộ.");
                    document.getElementById('status-message').style.display = 'none';
                    renderInvoices(allData);
                }

            } catch (e) {
                document.getElementById('status-message').innerHTML = `<span style="color:red">Lỗi: ${e.message}</span>`;
                log("❌ LỖI NGHIÊM TRỌNG: " + e.message);
                console.error(e);
            }
        }

        window.onload = loadData;
    </script>
</body>
</html>


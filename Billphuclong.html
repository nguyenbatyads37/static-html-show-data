<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hoá đơn Phúc Long - URL Data</title>
    <style>
        body {
            background-color: #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: 'Courier New', Courier, monospace;
            margin: 0;
            padding: 20px 0;
        }

        .receipt {
            background-color: #fff;
            width: 320px;
            padding: 20px 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            font-size: 12px;
            line-height: 1.4;
            color: #000;
        }

        .text-center { text-align: center; }
        .bold { font-weight: bold; }

        /* --- LOGO --- */
        .logo-area {
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .logo-img {
            width: 100px;
            height: auto;
            margin-bottom: 5px;
            filter: grayscale(100%) contrast(120%); 
        }

        .brand-name { font-size: 14px; font-weight: bold; margin-top: 5px; text-transform: uppercase; }
        .address { font-size: 11px; margin-bottom: 15px; }
        .title { font-size: 14px; font-weight: bold; text-transform: uppercase; margin: 10px 0; }

        /* --- LINE --- */
        .dashed-line { border-bottom: 1px dashed #000; margin: 5px 0; width: 100%; display: block; }

        /* --- INFO --- */
        .info-group { margin-bottom: 5px; }
        .flex-row { display: flex; justify-content: space-between; }

        /* --- TABLE --- */
        table { width: 100%; border-collapse: collapse; margin-top: 5px; }
        th { text-align: left; border-bottom: 1px dashed #000; padding-bottom: 5px; }
        th:last-child, td:last-child { text-align: right; }
        td { padding-top: 5px; vertical-align: top; }

        /* --- TOTALS --- */
        .totals { margin-top: 5px; }
        .total-row { display: flex; justify-content: space-between; margin: 3px 0; }
        .final-total { font-size: 16px; font-weight: bold; margin: 10px 0; text-transform: uppercase; }
        .footer { margin-top: 15px; font-size: 12px; margin-bottom: 10px; }

        /* --- QR --- */
        .qr-section { text-align: center; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #000; }
        .qr-img { width: 70%; max-width: 180px; height: auto; margin-top: 5px; filter: grayscale(100%) contrast(120%); }
        .qr-note { font-size: 10px; font-style: italic; margin-bottom: 5px; }
    </style>
</head>
<body>

    <div class="receipt">
        <!-- Logo -->
        <div class="logo-area">
            <img src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Fd428368f.%E1%BA%A2nh.105644.png" alt="Logo" class="logo-img">
        </div>

        <!-- Header -->
        <div class="text-center">
            <div class="brand-name">PHUC LONG</div>
            <div class="address">42 Tran Cao Van, Q.3</div>
            <div class="title">PHIEU THANH TOAN</div>
        </div>

        <!-- Details -->
        <div class="text-center bold" style="margin-bottom: 5px;">TAG: Q#2</div>
        <div class="info-group">
            <div class="flex-row">
                <span>Trans#: 50.101</span>
                <span>Serv: Phuong Thao</span>
            </div>
            <div class="flex-row">
                <span id="invoice-date">...</span>
                <span>#Cust: 1</span>
            </div>
        </div>

        <!-- Items Table -->
        <div class="dashed-line"></div>
        <table>
            <thead>
                <tr>
                    <th style="width: 15%;">Quan</th>
                    <th style="width: 55%;">Description</th>
                    <th style="width: 30%;">Cost</th>
                </tr>
            </thead>
            <tbody id="invoice-items">
                <!-- Dữ liệu sẽ được điền tự động -->
            </tbody>
        </table>
        <div class="dashed-line"></div>

        <!-- Totals -->
        <div class="totals">
            <div class="total-row">
                <span></span>
                <div style="width: 100%; display: flex; justify-content: flex-end;">
                    <span style="margin-right: 20px;">Total:</span>
                    <span id="sub-total">0</span>
                </div>
            </div>
            
            <div class="dashed-line"></div>

            <div class="total-row final-total">
                <span>TOTAL :</span>
                <span id="final-total">0</span>
            </div>

            <div class="total-row" style="margin-top: 15px;">
                <span>CASH</span>
                <span id="cash-total">0</span>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer text-center">C PHU+D+ NG</div>

        <!-- QR -->
        <div class="qr-section">
            <div class="qr-note">Quét mã để thanh toán</div>
            <img src="https://img.vietqr.io/image/vietinbank-113366668888-compact.jpg" alt="QR Code" class="qr-img">
            <div style="font-size: 10px; margin-top: 5px;">Cam on quy khach!</div>
        </div>
    </div>

    <!-- SCRIPT XỬ LÝ -->
    <script>
        function renderInvoice() {
            // 1. Lấy dữ liệu từ URL parameter 'data'
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            const rawData = urlParams.get('data');

            // 2. Dữ liệu mặc định nếu URL trống
            let inputData = "";
            if (rawData) {
                // Giải mã URL (decode) để hiển thị đúng tiếng Việt và dấu cách
                inputData = decodeURIComponent(rawData);
            } else {
                inputData = "Demo Item 1_a_50,000_b_Demo Item 2_a_25,000"; // Dữ liệu mẫu
            }

            const tbody = document.getElementById('invoice-items');
            const subTotalEl = document.getElementById('sub-total');
            const finalTotalEl = document.getElementById('final-total');
            const cashTotalEl = document.getElementById('cash-total');
            const dateEl = document.getElementById('invoice-date');

            // Cập nhật ngày giờ hiện tại
            const now = new Date();
            dateEl.innerText = now.toLocaleString('en-US', { hour12: true });

            // 3. Xử lý chuỗi dữ liệu
            // Tách các dòng món ăn bằng ký tự _b_
            const rows = inputData.split('_b_');
            
            let html = '';
            let totalAmount = 0;

            rows.forEach((row, index) => {
                // Tách tên và giá bằng ký tự _a_
                const parts = row.split('_a_');
                
                if (parts.length >= 2) {
                    const name = parts[0].trim();
                    const priceString = parts[1].trim();
                    
                    // Xử lý giá tiền để cộng tổng (xoá dấu phẩy hoặc dấu chấm nếu có để parse số)
                    const priceValue = parseInt(priceString.replace(/,/g, '').replace(/\./g, '')) || 0;
                    totalAmount += priceValue;

                    // Tạo HTML cho dòng (STT = index + 1)
                    html += `
                        <tr>
                            <td class="text-center">${index + 1}</td>
                            <td>${name}</td>
                            <td>${priceString}</td>
                        </tr>
                    `;
                }
            });

            // Xuất ra giao diện
            tbody.innerHTML = html;

            // Format lại tổng tiền có dấu phẩy (en-US standard)
            const formattedTotal = totalAmount.toLocaleString('en-US');
            
            subTotalEl.innerText = formattedTotal;
            finalTotalEl.innerText = formattedTotal;
            cashTotalEl.innerText = formattedTotal;
        }

        // Chạy hàm khi trang tải xong
        renderInvoice();
    </script>
</body>
</html>

<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bill Viewer</title>
  <style>
    /* ====== Professional UI Refresh ====== */
    :root{
      --bg-dark: #0D1117;
      --bg-medium: #161B22;
      --bg-light: #21262D;
      --border-color: #30363D;
      --text-primary: #C9D1D9;
      --text-secondary: #8B949E;
      --accent-primary: #58A6FF;
      --accent-secondary: #A371F7;
      --success: #3FB950;
      --danger: #F85149;
      --warn: #F0A923;
      --font-sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
      --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin:0;
      font: 16px/1.6 var(--font-sans);
      color: var(--text-primary);
      background-color: var(--bg-dark);
      background-image:
        radial-gradient(circle at 1% 1%, rgba(88, 166, 255, 0.1), transparent 30%),
        radial-gradient(circle at 99% 99%, rgba(163, 113, 247, 0.1), transparent 30%);
    }
    .container{ max-width: 1600px; margin: 32px auto; padding: 0 24px; }

    .header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      margin-bottom: 24px;
    }
    .title{
      font-size: 28px;
      font-weight: 700;
      letter-spacing:-.5px;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .badge{
      font-size:12px;
      font-weight: 500;
      color: var(--text-secondary);
      padding: 4px 12px;
      border: 1px solid var(--border-color);
      border-radius: 20px;
      background-color: var(--bg-medium);
    }

    .card{
      background: var(--bg-medium);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.2);
      overflow:hidden;
    }

    .toolbar{
      position: sticky; top:0; z-index:10;
      display:flex; flex-wrap:wrap; gap:12px; align-items:center;
      padding: 16px 20px;
      border-bottom:1px solid var(--border-color);
      background: rgba(22, 27, 34, 0.8);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    .toolbar .group{ display:flex; gap:8px; align-items:center; }
    .toolbar label { font-size: 14px; color: var(--text-secondary); }

    .input, .select{
      background: var(--bg-dark);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      padding: 8px 12px;
      border-radius: 8px;
      outline: none;
      min-width: 120px;
      font-size: 14px;
      transition: border-color .2s ease, box-shadow .2s ease;
    }
    .input::placeholder{ color: var(--text-secondary); }
    .input:focus, .select:focus{
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.2);
    }

    .btn{
      cursor:pointer; user-select:none; border:1px solid transparent;
      border-radius: 8px; padding: 8px 16px; font-weight:600; font-size: 14px;
      background: linear-gradient(145deg, var(--accent-primary), var(--accent-secondary));
      color: white;
      box-shadow: 0 4px 12px rgba(0,0,0,.2);
      transition: all .15s ease;
    }
    .btn:disabled{ opacity:.5; cursor:not-allowed; filter: grayscale(.5); }
    .btn:hover:not(:disabled){ transform: translateY(-2px); box-shadow: 0 8px 20px rgba(88, 166, 255, 0.25); }
    .btn.secondary{
      background: var(--bg-light);
      border-color: var(--border-color);
      color: var(--text-primary);
      box-shadow: none;
    }
    .btn.secondary:hover:not(:disabled){
      background: var(--border-color);
      color: white;
      transform: translateY(0);
      box-shadow: none;
    }
    .btn.warn{
      background: linear-gradient(145deg, var(--warn), #eab308);
      color: var(--bg-dark);
      box-shadow:none;
    }
    .btn.warn:hover:not(:disabled){
      box-shadow: 0 8px 20px rgba(240, 169, 35, 0.2);
    }

    .notice{
      background: rgba(240, 169, 35, .1);
      color: #f0c674;
      border: 1px solid rgba(240, 169, 35, 0.3);
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
    }

    .statusbar{
      display:flex; flex-wrap:wrap; gap:16px; align-items:center;
      color:var(--text-secondary);
      padding: 12px 20px;
      border-top:1px solid var(--border-color);
      font-size: 13px;
      background-color: var(--bg-dark);
    }

    .table-wrap{ width:100%; overflow:auto; }
    table{
      width:100%;
      border-collapse: collapse;
      min-width: 1280px;
    }

    /* --- NEW: Highlighted Header --- */
    thead th{
      position: sticky; top: 73px; /* D∆∞·ªõi toolbar ch√≠nh */ z-index:5;
      color: #FFFFFF; /* White text for contrast */
      text-transform: uppercase;
      letter-spacing: .05em;
      font-size: 12px;
      font-weight: 600;
      text-align: left;
      vertical-align: middle;
      padding: 16px 16px;
      background: linear-gradient(90deg, rgba(88, 166, 255, 0.15), rgba(163, 113, 247, 0.15)), var(--bg-light);
      border-bottom: 2px solid var(--accent-primary);
      text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }

    th, td{
      padding: 14px 16px;
      border-bottom:1px solid var(--border-color);
      vertical-align: top;
      white-space: nowrap;
    }
    tbody tr{ transition: background-color .15s ease; }
    tbody tr:hover{ background: rgba(88, 166, 255, 0.05); }
    tbody tr:nth-child(even){ background: rgba(255,255,255,.01); }
    
    /* Style for editable cells */
    td[contenteditable="true"] {
      cursor: cell;
      outline: none;
      transition: background-color .3s ease;
    }
    td[contenteditable="true"]:focus {
      box-shadow: inset 0 0 0 2px var(--accent-primary);
      background-color: var(--bg-dark);
    }


    .center{ text-align:center; }
    .right{ text-align:right; }
    .mono{ font-family: var(--font-mono); font-size: 13px; color: var(--text-secondary); }

    .w-xs{ width: 84px; } .w-s{ width: 120px; } .w-m{ width: 160px; }
    .w-l{ width: 240px; } .w-xl{ width: 320px; }

    .pagination{ display:flex; align-items:center; gap:8px; margin-left:auto; }
    .pill{
      border:1px solid var(--border-color);
      padding: 6px 12px;
      border-radius: 20px;
      color: var(--text-secondary);
      background-color: var(--bg-dark);
      font-size: 13px;
    }

    .srch{ flex: 1 1 320px; }
    .empty{ padding: 48px 24px; text-align:center; color: var(--text-secondary); }

    /* Modal */
    .modal{
      position: fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      background: rgba(13, 17, 23, 0.7);
      z-index:50;
      opacity: 0;
      visibility: hidden;
      transition: opacity .2s ease, visibility .2s ease;
    }
    .modal.show{ opacity: 1; visibility: visible; }
    .modal .box{
      max-width: 860px; width: calc(100% - 32px);
      background: rgba(22, 27, 34, 0.8);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border:1px solid var(--border-color);
      border-radius: 14px;
      box-shadow: 0 20px 60px rgba(0,0,0,.4);
      transform: scale(0.95);
      transition: transform .2s ease;
    }
    .modal.show .box { transform: scale(1); }
    .modal .box .head{
      padding: 16px 20px;
      border-bottom:1px solid var(--border-color);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      font-size: 20px; font-weight: 600;
    }
    .modal .box .body{ padding: 20px; }
    .kvs{ display:grid; grid-template-columns: 160px 1fr; gap:12px 16px; align-items:center; }
    .kvs .k{ color: var(--text-secondary); font-size: 14px; }
    .log{
      font: 13px/1.5 var(--font-mono);
      background: var(--bg-dark);
      color: var(--text-secondary);
      padding:12px;
      border-radius:8px;
      border:1px solid var(--border-color);
      height:180px;
      overflow:auto;
      white-space:pre-wrap;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="title">
        üì¶ B·∫£ng v·∫≠n ƒë∆°n (Bills)
        <span class="badge" id="datasetMeta">ƒëang t·∫£i‚Ä¶</span>
      </div>
      <div class="badge">Apps Script JSONP</div>
    </div>

    <div class="card">
      <div class="toolbar">
        <div class="group srch" style="flex:1 1 420px">
          <input id="q" class="input" type="search" placeholder="T√¨m nhanh tr√™n trang hi·ªán t·∫°i (m·ªçi c·ªôt)‚Ä¶" style="width:100%" />
        </div>
        <div class="group">
          <label for="limit">M·ªói trang</label>
          <select id="limit" class="select">
            <option>25</option>
            <option selected>50</option>
            <option>100</option>
            <option>200</option>
          </select>
        </div>
        <div class="group pagination">
          <button id="prev" class="btn secondary">‚óÄ Tr∆∞·ªõc</button>
          <span class="pill" id="pageinfo">Trang 1/1</span>
          <button id="next" class="btn secondary">Ti·∫øp ‚ñ∂</button>
          <button id="reload" class="btn">‚Üª N·∫°p l·∫°i</button>
          <button id="diagBtn" class="btn warn">‚öô Ch·∫©n ƒëo√°n</button>
        </div>
      </div>

      <!-- Quick inline editor -->
      <div class="toolbar" style="border-top:1px solid var(--border-color); top: 73px;">
        <div class="group">
          <span class="badge">Ch·ªânh s·ª≠a nhanh</span>
        </div>
        <div class="group">
          <label for="billNo">S·ªë Bill</label>
          <input id="billNo" class="input w-m" placeholder="VD: B1234" />
        </div>
        <div class="group">
          <label for="colSel">C·ªôt</label>
          <select id="colSel" class="select w-l"></select>
        </div>
        <div class="group" style="flex:1 1 280px">
          <label for="newVal">Gi√° tr·ªã m·ªõi</label>
          <input id="newVal" class="input" placeholder="Nh·∫≠p gi√° tr·ªã‚Ä¶" style="width:100%" />
        </div>
        <div class="group">
          <button id="saveBtn" class="btn">üíæ L∆∞u (doPost)</button>
        </div>
      </div>

      <div class="table-wrap">
        <table id="table">
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="statusbar">
        <span id="status">ƒêang t·∫£i d·ªØ li·ªáu‚Ä¶</span>
        <span class="mono" id="updated"></span>
      </div>
    </div>

    <!-- Inline notice for network permission in canvas -->
    <p class="notice" id="permNote" style="display:none;margin-top:16px">
      ‚ö† Tr√¨nh xem c√≥ th·ªÉ ƒëang ch·∫∑n m·∫°ng. H√£y b·∫•m <b>Allow</b> khi popup h·ªèi quy·ªÅn xu·∫•t hi·ªán, r·ªìi nh·∫•n <b>‚Üª N·∫°p l·∫°i</b>. B·∫°n c≈©ng c√≥ th·ªÉ m·ªü file HTML n√†y tr·ª±c ti·∫øp ngo√†i canvas ƒë·ªÉ kh√¥ng b·ªã ch·∫∑n.
    </p>
  </div>

  <!-- Diagnostics Modal -->
  <div class="modal" id="diagModal">
    <div class="box">
      <div class="head">
        <span>Ch·∫©n ƒëo√°n k·∫øt n·ªëi</span>
        <button id="closeDiag" class="btn secondary">ƒê√≥ng</button>
      </div>
      <div class="body">
        <div class="kvs" style="margin-bottom:16px">
          <div class="k">Endpoint</div>
          <div>
            <input id="endpoint" class="input" style="width:100%" />
            <div style="margin-top:8px; display:flex; gap:8px;">
              <button id="saveEndpoint" class="btn secondary">L∆∞u endpoint</button>
              <a id="openJsonp" class="btn secondary" style="text-decoration:none; display:inline-block" target="_blank">M·ªü trong tab m·ªõi</a>
            </div>
          </div>
          <div class="k">G·ª£i √Ω</div>
          <div class="notice">
            ƒê·∫£m b·∫£o Apps Script Web App ƒëang <b>Deploy</b> v·ªõi <b>Execute as: Me</b> v√† <b>Who has access: Anyone</b>.
            Endpoint ph·∫£i tr·∫£ v·ªÅ <code>callback(...)</code> (JSONP), kh√¥ng ph·∫£i JSON thu·∫ßn.
          </div>
        </div>
        <div style="display:flex; gap:8px; margin:16px 0">
          <button id="runTests" class="btn">‚ñ∂ Ch·∫°y test</button>
          <button id="loadSample" class="btn secondary">N·∫°p d·ªØ li·ªáu m·∫´u</button>
        </div>
        <div class="log" id="log"></div>
      </div>
    </div>
  </div>

<script>
  // ====== Config (editable via Diagnostics) ======
  let GAS_URL = 'https://script.google.com/macros/s/AKfycbyMrOG8nhmPXi_PkvfjAS_FqUViaQxUESsTlvWKKe815JAikAEUV4ZKBKpXjQubsRGySw/exec';
  const WRITE_KEY = '';

  // ====== JSONP helper (with timeout & placeholder support) ======
  function jsonp(url, opts={}){
    const param = opts.param || 'callback';
    const timeout = opts.timeout || 12000;
    const placeholder = opts.placeholder || '$CALLBACK$';
    const raw = !!opts.raw; // n·∫øu true, url c√≥ ch·ª©a placeholder v√† ta s·∫Ω thay b·∫±ng t√™n callback

    return new Promise((resolve, reject) => {
      const cb = 'cb_' + Math.random().toString(36).slice(2);
      let done = false;
      let timer;
      let s;
      function cleanup(){
        done = true;
        clearTimeout(timer);
        window[cb] && delete window[cb];
        if (s && s.parentNode) s.parentNode.removeChild(s);
      }
      window[cb] = (data) => { cleanup(); resolve(data); };

      // Build src
      let src;
      if (raw) {
        src = url.replace(placeholder, cb);
      } else {
        const hasParam = url.includes(param+'=');
        src = url + (url.includes('?') ? '&' : '?') + (hasParam ? '' : param + '=' + cb);
      }
      // cache buster
      src += (src.includes('?') ? '&' : '?') + '_ts=' + Date.now();

      s = document.createElement('script');
      s.async = true;
      s.src = src;
      s.onerror = () => { if (done) return; cleanup(); reject(new Error('JSONP failed (network/blocked)')); };

      timer = setTimeout(() => { if (done) return; cleanup(); reject(new Error('JSONP timeout (no callback executed)')); }, timeout);
      document.head.appendChild(s);
    });
  }

  // ====== State ======
  let columns = [];
  let total = 0;
  let page = 1;
  let limit = 50;
  let currentRows = [];

  // ====== UI refs ======
  const thead = document.getElementById('thead');
  const tbody = document.getElementById('tbody');
  const q = document.getElementById('q');
  const limitSel = document.getElementById('limit');
  const prevBtn = document.getElementById('prev');
  const nextBtn = document.getElementById('next');
  const reloadBtn = document.getElementById('reload');
  const diagBtn = document.getElementById('diagBtn');
  const pageinfo = document.getElementById('pageinfo');
  const statusEl = document.getElementById('status');
  const updatedEl = document.getElementById('updated');
  const datasetMeta = document.getElementById('datasetMeta');
  const billNo = document.getElementById('billNo');
  const colSel = document.getElementById('colSel');
  const newVal = document.getElementById('newVal');
  const saveBtn = document.getElementById('saveBtn');
  const permNote = document.getElementById('permNote');
  const diagModal = document.getElementById('diagModal');
  const closeDiag = document.getElementById('closeDiag');
  const endpoint = document.getElementById('endpoint');
  const saveEndpoint = document.getElementById('saveEndpoint');
  const openJsonp = document.getElementById('openJsonp');
  const runTestsBtn = document.getElementById('runTests');
  const loadSampleBtn = document.getElementById('loadSample');
  const logEl = document.getElementById('log');

  // ====== Column presentation rules ======
  const centerCols = new Set([
    'S·ªë Bill','Ng√†y b·ªëc','M√£ kh√°ch g·ª≠i','T·ªânh','X√£','T·ªânh nh·∫≠n','X√£ nh·∫≠n','SƒêT kh√°ch nh·∫≠n',
    'S·ªë ki·ªán','Tr·ªçng l∆∞·ª£ng th·ª±c','Th·ªÉ t√≠ch','ƒê∆°n v·ªã t√≠nh c∆∞·ªõc','ƒê∆°n gi√°','Ph·ª• ph√≠','VAT','Th√†nh ti·ªÅn','COD','Tr·∫°ng th√°i thanh to√°n','Ng∆∞·ªùi thanh to√°n','STT'
  ]);
  const widthMap = {
    'S·ªë Bill':'w-xs', 'Ng√†y b·ªëc':'w-s', 'M√£ kh√°ch g·ª≠i':'w-s', 'T·ªânh':'w-s', 'X√£':'w-s',
    'T√™n kh√°ch g·ª≠i':'w-m', 'ƒê·ªãa ch·ªâ':'w-xl', 'ƒê·ªãa ch·ªâ ƒë√£ l∆∞u':'w-xl',
    'T√™n kh√°ch nh·∫≠n':'w-m', 'ƒê·ªãa ch·ªâ nh·∫≠n':'w-xl', 'T·ªânh nh·∫≠n':'w-s', 'X√£ nh·∫≠n':'w-s', 'SƒêT kh√°ch nh·∫≠n':'w-m',
    'D·ªãch v·ª• GTGT':'w-m', 'N·ªôi dung h√†ng h√≥a':'w-xl', 'S·ªë ki·ªán':'w-xs', 'Tr·ªçng l∆∞·ª£ng th·ª±c':'w-s', 'Th·ªÉ t√≠ch':'w-s',
    'ƒê∆°n v·ªã t√≠nh c∆∞·ªõc':'w-m', 'ƒê∆°n gi√°':'w-m', 'Ph·ª• ph√≠':'w-m', 'VAT':'w-xs', 'Th√†nh ti·ªÅn':'w-m',
    'Ng∆∞·ªùi thanh to√°n':'w-m', 'COD':'w-m', 'Tr·∫°ng th√°i thanh to√°n':'w-m', 'Ghi ch√∫':'w-xl', 'STT':'w-xs'
  };

  // ====== Renderers ======
  function renderHeader(){
    const tr = document.createElement('tr');
    colSel.innerHTML = '';
    for(const name of columns){
      const th = document.createElement('th');
      th.textContent = name;
      if(centerCols.has(name)) th.classList.add('center');
      const w = widthMap[name]; if(w) th.classList.add(w);
      tr.appendChild(th);

      const opt = document.createElement('option');
      opt.value = name; opt.textContent = name;
      colSel.appendChild(opt);
    }
    thead.innerHTML = '';
    thead.appendChild(tr);
  }

  function htmlesc(s){ return String(s==null? '': s).replace(/[&<>]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[ch])); }

  // --- NEW: Handler for auto-saving STT column edits ---
  async function handleSttEdit(event) {
    const cell = event.target;
    const newValue = cell.textContent.trim();
    const originalValue = cell.dataset.originalValue;
    const billNo = cell.closest('tr').dataset.billNo;

    // Do nothing if value hasn't changed or if we can't find the bill number
    if (newValue === originalValue || !billNo) {
      return;
    }

    // UI feedback: Saving in progress
    cell.style.backgroundColor = 'rgba(240, 169, 35, 0.2)'; // Warn color
    setStatus(`ƒêang l∆∞u STT m·ªõi "${newValue}" cho Bill ${billNo}...`);

    try {
      const resp = await doPostUpdate({ bill: billNo, column: 'STT', value: newValue });
      if (!resp || resp.ok === false) {
        throw new Error(resp.error || 'Ph·∫£n h·ªìi kh√¥ng th√†nh c√¥ng t·ª´ server.');
      }
      
      // UI feedback: Success
      cell.style.backgroundColor = 'rgba(63, 185, 80, 0.2)'; // Success color
      cell.dataset.originalValue = newValue; // Update original value to prevent re-saving
      setStatus(`L∆∞u th√†nh c√¥ng STT cho Bill ${billNo}.`);

    } catch (e) {
      console.error('Update failed:', e);
      // UI feedback: Error
      cell.style.backgroundColor = 'rgba(248, 81, 73, 0.2)'; // Danger color
      cell.textContent = originalValue; // Revert to original value
      setStatus(`‚ùå L·ªói khi l∆∞u STT cho Bill ${billNo}: ${e.message}`);
    } finally {
      // Reset background color after a delay
      setTimeout(() => {
        cell.style.backgroundColor = '';
      }, 2500);
    }
  }

  function renderRows(rows){
    if(!rows || !rows.length){
      tbody.innerHTML = `<tr><td colspan="${columns.length}"><div class="empty">Kh√¥ng c√≥ d·ªØ li·ªáu.</div></td></tr>`;
      return;
    }
    const frag = document.createDocumentFragment();
    for(const r of rows){
      const tr = document.createElement('tr');
      // --- NEW: Add data-bill-no to the row for easy identification ---
      tr.dataset.billNo = r['S·ªë Bill'];

      for(const col of columns){
        const td = document.createElement('td');
        const val = r[col] ?? '';
        td.innerHTML = htmlesc(val);
        if(centerCols.has(col)) td.classList.add('center');
        const w = widthMap[col]; if(w) td.classList.add(w);

        // --- NEW: Make STT column editable ---
        if (col === 'STT') {
          td.contentEditable = true;
          td.dataset.originalValue = val; // Store original value
          td.addEventListener('blur', handleSttEdit); // Add event listener
        }

        tr.appendChild(td);
      }
      frag.appendChild(tr);
    }
    tbody.innerHTML = '';
    tbody.appendChild(frag);
  }

  function updatePageInfo(){
    const pages = Math.max(1, Math.ceil(total / limit));
    page = Math.min(Math.max(1, page), pages);
    prevBtn.disabled = (page <= 1);
    nextBtn.disabled = (page >= pages);
    pageinfo.textContent = `Trang ${page}/${pages}`;
  }

  function setStatus(text){ statusEl.textContent = text; }

  // ====== Data loading ======
  async function loadPage(){
    try{
      setStatus('ƒêang t·∫£i d·ªØ li·ªáu‚Ä¶');
      limit = parseInt(limitSel.value,10) || 50;
      const offset = (page - 1) * limit;
      const url = `${GAS_URL}?offset=${offset}&limit=${limit}`;
      const resp = await jsonp(url);
      if(!resp || resp.ok === false){ throw new Error(resp && resp.error || 'T·∫£i th·∫•t b·∫°i'); }

      columns = resp.columns || Object.keys((resp.rows && resp.rows[0]) || {});
      total = resp.total || (resp.rows ? resp.rows.length : 0);
      currentRows = resp.rows || [];

      renderHeader();
      applySearch();
      updatePageInfo();
      setStatus(`ƒê√£ n·∫°p ${currentRows.length} d√≤ng / t·ªïng ${total}`);
      updatedEl.textContent = resp.updatedAt ? `C·∫≠p nh·∫≠t: ${new Date(resp.updatedAt).toLocaleString()}` : '';
      datasetMeta.textContent = `${resp.sheetName || 'Bill'} ‚Ä¢ ${resp.spreadsheetId || ''}`;
    }catch(err){
      console.error(err);
      setStatus('‚ùå L·ªói: ' + err.message);
      permNote.style.display = 'block';
    }
  }

  // ====== Submit update via hidden iframe (avoid CORS) ======
  function doPostUpdate({ bill, column, value }){
    return new Promise((resolve) => {
      const iframeName = 'post_ifr_' + Math.random().toString(36).slice(2);
      const ifr = document.createElement('iframe');
      ifr.name = iframeName; ifr.style.display = 'none';
      document.body.appendChild(ifr);

      const form = document.createElement('form');
      form.method = 'POST';
      form.action = `${GAS_URL}?target=iframe`;
      form.target = iframeName;

      const params = {
        key: WRITE_KEY || '',
        mode: 'update',
        keyField: 'S·ªë Bill',
        keyValue: bill,
        set: JSON.stringify({ [column]: value })
      };
      for(const [k,v] of Object.entries(params)){
        const inp = document.createElement('input');
        inp.type = 'hidden'; inp.name = k; inp.value = v; form.appendChild(inp);
      }
      document.body.appendChild(form);

      const onMsg = (ev) => {
        if(!ev || !ev.data || ev.data.source !== 'apps-script') return;
        window.removeEventListener('message', onMsg);
        setTimeout(() => { ifr.remove(); form.remove(); }, 100);
        resolve(ev.data.payload);
      };
      window.addEventListener('message', onMsg);
      form.submit();
    });
  }

  // ====== Search (client-side) ======
  function applySearch(){
    if(!currentRows) return;
    const keyword = q.value.trim().toLowerCase();
    let rows = currentRows;
    if(keyword){
      rows = currentRows.filter(obj => {
        for(const col of columns){
          const v = (obj[col]||'').toString().toLowerCase();
          if(v.includes(keyword)) return true;
        }
        return false;
      });
    }
    renderRows(rows);
  }

  // ====== Diagnostics ======
  function log(msg){ logEl.textContent += (logEl.textContent ? '\n' : '') + msg; logEl.scrollTop = logEl.scrollHeight; }
  function openDiag(){ diagModal.classList.add('show'); endpoint.value = GAS_URL; refreshOpenJsonpLink(); logEl.textContent=''; }
  function closeDiagModal(){ diagModal.classList.remove('show'); }
  function refreshOpenJsonpLink(){ const test = endpoint.value + (endpoint.value.includes('?')?'&':'?') + 'offset=0&limit=1&callback=jsonpTest'; openJsonp.href = test; }

  async function runTests(){
    logEl.textContent = '';
    log('Test 1: JSONP n·ªôi b·ªô (data: URL)...');
    try{
      const dataUrl = 'data:text/javascript,' + encodeURIComponent('$CALLBACK$({ok:true, hello:"world"});');
      const r1 = await jsonp(dataUrl, { raw:true });
      log('  ‚úî Th√†nh c√¥ng: ' + JSON.stringify(r1));
    }catch(e){ log('  ‚úñ Th·∫•t b·∫°i: ' + e.message); }

    log('Test 2: Ki·ªÉm tra endpoint tr·∫£ JSONP...');
    try{
      const url = endpoint.value + (endpoint.value.includes('?')?'&':'?') + 'offset=0&limit=1&callback=$CALLBACK$';
      const r2 = await jsonp(url, { raw:true });
      log('  ‚úî Tr·∫£ JSONP h·ª£p l·ªá: ' + JSON.stringify(r2));
    }catch(e){
      log('  ‚úñ Kh√¥ng nh·∫≠n ƒë∆∞·ª£c JSONP: ' + e.message);
      log('    H∆∞·ªõng d·∫´n:');
      log('    ‚Ä¢ M·ªü link ·ªü n√∫t "M·ªü trong tab m·ªõi" v√† xem n·ªôi dung b·∫Øt ƒë·∫ßu b·∫±ng jsonpTest( ... ) hay kh√¥ng.');
      log('    ‚Ä¢ N·∫øu th·∫•y trang ƒëƒÉng nh·∫≠p Google, h√£y redeploy Web App v·ªõi Who has access = Anyone.');
      log('    ‚Ä¢ N·∫øu n·ªôi dung l√† JSON thu·∫ßn (b·∫Øt ƒë·∫ßu b·∫±ng { ), c·∫ßn d√πng JSONP (tr·∫£ callback) ho·∫∑c ƒëi qua proxy.');
    }
  }

  function loadSample(){
    const sample = {
      ok:true,
      spreadsheetId: 'sample',
      sheetName: 'Bill',
      total: 2,
      columns: ['STT','S·ªë Bill','T√™n kh√°ch g·ª≠i','T√™n kh√°ch nh·∫≠n','ƒê·ªãa ch·ªâ','ƒê∆°n gi√°','Th√†nh ti·ªÅn','Tr·∫°ng th√°i thanh to√°n','Ghi ch√∫'],
      rows: [
        { 'STT':'1','S·ªë Bill':'B0001','T√™n kh√°ch g·ª≠i':'Nguy·ªÖn A','T√™n kh√°ch nh·∫≠n':'Tr·∫ßn B','ƒê·ªãa ch·ªâ':'H√† N·ªôi','ƒê∆°n gi√°':'50,000','Th√†nh ti·ªÅn':'75,000','Tr·∫°ng th√°i thanh to√°n':'Ch∆∞a thu','Ghi ch√∫':'demo' },
        { 'STT':'2','S·ªë Bill':'B0002','T√™n kh√°ch g·ª≠i':'L√™ C','T√™n kh√°ch nh·∫≠n':'Ph·∫°m D','ƒê·ªãa ch·ªâ':'HCM','ƒê∆°n gi√°':'60,000','Th√†nh ti·ªÅn':'60,000','Tr·∫°ng th√°i thanh to√°n':'ƒê√£ thu','Ghi ch√∫':'' }
      ],
      updatedAt: new Date().toISOString()
    };
    columns = sample.columns; total = sample.total; currentRows = sample.rows;
    renderHeader(); applySearch(); updatePageInfo(); datasetMeta.textContent = `${sample.sheetName} ‚Ä¢ ${sample.spreadsheetId}`; updatedEl.textContent = `C·∫≠p nh·∫≠t: ${new Date(sample.updatedAt).toLocaleString()}`; setStatus('ƒê√£ n·∫°p d·ªØ li·ªáu m·∫´u.');
  }

  // ====== Events ======
  limitSel.addEventListener('change', () => { page = 1; loadPage(); });
  prevBtn.addEventListener('click', () => { page--; loadPage(); });
  nextBtn.addEventListener('click', () => { page++; loadPage(); });
  reloadBtn.addEventListener('click', () => loadPage());
  q.addEventListener('input', () => applySearch());
  saveBtn.addEventListener('click', async () => {
    const bill = billNo.value.trim();
    const column = colSel.value;
    const value = newVal.value;
    if(!bill || !column){ alert('ƒêi·ªÅn S·ªë Bill v√† ch·ªçn c·ªôt c·∫ßn s·ª≠a.'); return; }
    setStatus('ƒêang g·ª≠i c·∫≠p nh·∫≠t‚Ä¶');
    try{
      const resp = await doPostUpdate({ bill, column, value });
      setStatus('ƒê√£ c·∫≠p nh·∫≠t. ƒêang t·∫£i l·∫°i‚Ä¶');
      await loadPage();
    }catch(e){ console.error(e); setStatus('‚ùå G·ª≠i c·∫≠p nh·∫≠t th·∫•t b·∫°i'); }
  });

  diagBtn.addEventListener('click', openDiag);
  closeDiag.addEventListener('click', closeDiagModal);
  saveEndpoint.addEventListener('click', () => { GAS_URL = endpoint.value.trim(); setStatus('ƒê√£ l∆∞u endpoint. Nh·∫•n ‚Üª N·∫°p l·∫°i ƒë·ªÉ th·ª≠.'); refreshOpenJsonpLink(); });
  endpoint.addEventListener('input', refreshOpenJsonpLink);
  runTestsBtn.addEventListener('click', runTests);
  loadSampleBtn.addEventListener('click', loadSample);

  // ====== Init ======
  // G·ª£i √Ω b·∫≠t note quy·ªÅn m·∫°ng n·∫øu ƒëang ch·∫°y trong canvas tr∆∞·ªõc khi c√≥ d·ªØ li·ªáu
  setTimeout(() => { if (!currentRows.length) permNote.style.display = 'block'; }, 1500);
  loadPage();
</script>
</body>
</html>

<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bill Viewer</title>
  <style>
    /* ====== Professional UI Refresh ====== */
    :root{
      --bg-dark: #0D1117;
      --bg-medium: #161B22;
      --bg-light: #21262D;
      --border-color: #30363D;
      --text-primary: #C9D1D9;
      --text-secondary: #8B949E;
      --accent-primary: #58A6FF;
      --accent-secondary: #A371F7;
      --success: #3FB950;
      --danger: #F85149;
      --warn: #F0A923;
      --font-sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
      --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin:0;
      font: 16px/1.6 var(--font-sans);
      color: var(--text-primary);
      background-color: var(--bg-dark);
      background-image:
        radial-gradient(circle at 1% 1%, rgba(88, 166, 255, 0.1), transparent 30%),
        radial-gradient(circle at 99% 99%, rgba(163, 113, 247, 0.1), transparent 30%);
    }
    .container{ max-width: 1600px; margin: 32px auto; padding: 0 24px; }

    .header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      margin-bottom: 24px;
    }
    .title{
      font-size: 28px;
      font-weight: 700;
      letter-spacing:-.5px;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .badge{
      font-size:12px;
      font-weight: 500;
      color: var(--text-secondary);
      padding: 4px 12px;
      border: 1px solid var(--border-color);
      border-radius: 20px;
      background-color: var(--bg-medium);
    }

    .card{
      background: var(--bg-medium);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.2);
      overflow:hidden;
    }

    .toolbar{
      position: sticky; top:0; z-index:10;
      display:flex; flex-wrap:wrap; gap:12px; align-items:center;
      padding: 16px 20px;
      border-bottom:1px solid var(--border-color);
      background: rgba(22, 27, 34, 0.8);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    .toolbar .group{ display:flex; gap:8px; align-items:center; }
    .toolbar label { font-size: 14px; color: var(--text-secondary); }

    .input, .select{
      background: var(--bg-dark);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      padding: 8px 12px;
      border-radius: 8px;
      outline: none;
      min-width: 120px;
      font-size: 14px;
      transition: border-color .2s ease, box-shadow .2s ease;
    }
    .input::placeholder{ color: var(--text-secondary); }
    .input:focus, .select:focus{
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.2);
    }

    .btn{
      cursor:pointer; user-select:none; border:1px solid transparent;
      border-radius: 8px; padding: 8px 16px; font-weight:600; font-size: 14px;
      background: linear-gradient(145deg, var(--accent-primary), var(--accent-secondary));
      color: white;
      box-shadow: 0 4px 12px rgba(0,0,0,.2);
      transition: all .15s ease;
    }
    .btn:disabled{ opacity:.5; cursor:not-allowed; filter: grayscale(.5); }
    .btn:hover:not(:disabled){ transform: translateY(-2px); box-shadow: 0 8px 20px rgba(88, 166, 255, 0.25); }
    .btn.secondary{
      background: var(--bg-light);
      border-color: var(--border-color);
      color: var(--text-primary);
      box-shadow: none;
    }
    .btn.secondary:hover:not(:disabled){
      background: var(--border-color);
      color: white;
      transform: translateY(0);
      box-shadow: none;
    }
    .btn.warn{
      background: linear-gradient(145deg, var(--warn), #eab308);
      color: var(--bg-dark);
      box-shadow:none;
    }
    .btn.warn:hover:not(:disabled){
      box-shadow: 0 8px 20px rgba(240, 169, 35, 0.2);
    }

    .notice{
      background: rgba(240, 169, 35, .1);
      color: #f0c674;
      border: 1px solid rgba(240, 169, 35, 0.3);
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
    }

    .statusbar{
      display:flex; flex-wrap:wrap; gap:16px; align-items:center;
      color:var(--text-secondary);
      padding: 12px 20px;
      border-top:1px solid var(--border-color);
      font-size: 13px;
      background-color: var(--bg-dark);
    }

    .table-wrap{ width:100%; overflow:auto; }
    table{
      width:100%;
      border-collapse: collapse;
      min-width: 1280px;
    }

    /* --- NEW: Highlighted Header --- */
    thead th{
      position: sticky; top: 73px; /* Dưới toolbar chính */ z-index:5;
      color: #FFFFFF; /* White text for contrast */
      text-transform: uppercase;
      letter-spacing: .05em;
      font-size: 12px;
      font-weight: 600;
      text-align: left;
      vertical-align: middle;
      padding: 16px 16px;
      background: linear-gradient(90deg, rgba(88, 166, 255, 0.15), rgba(163, 113, 247, 0.15)), var(--bg-light);
      border-bottom: 2px solid var(--accent-primary);
      text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }

    th, td{
      padding: 14px 16px;
      border-bottom:1px solid var(--border-color);
      vertical-align: top;
      white-space: nowrap;
    }
    tbody tr{ transition: background-color .15s ease; }
    tbody tr:hover{ background: rgba(88, 166, 255, 0.05); }
    tbody tr:nth-child(even){ background: rgba(255,255,255,.01); }
    
    /* Style for editable cells */
    td[contenteditable="true"] {
      cursor: cell;
      outline: none;
      transition: background-color .3s ease;
    }
    td[contenteditable="true"]:focus {
      box-shadow: inset 0 0 0 2px var(--accent-primary);
      background-color: var(--bg-dark);
    }


    .center{ text-align:center; }
    .right{ text-align:right; }
    .mono{ font-family: var(--font-mono); font-size: 13px; color: var(--text-secondary); }

    .w-xs{ width: 84px; } .w-s{ width: 120px; } .w-m{ width: 160px; }
    .w-l{ width: 240px; } .w-xl{ width: 320px; }

    .pagination{ display:flex; align-items:center; gap:8px; margin-left:auto; }
    .pill{
      border:1px solid var(--border-color);
      padding: 6px 12px;
      border-radius: 20px;
      color: var(--text-secondary);
      background-color: var(--bg-dark);
      font-size: 13px;
    }

    .srch{ flex: 1 1 320px; }
    .empty{ padding: 48px 24px; text-align:center; color: var(--text-secondary); }

    /* Modal */
    .modal{
      position: fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      background: rgba(13, 17, 23, 0.7);
      z-index:50;
      opacity: 0;
      visibility: hidden;
      transition: opacity .2s ease, visibility .2s ease;
    }
    .modal.show{ opacity: 1; visibility: visible; }
    .modal .box{
      max-width: 860px; width: calc(100% - 32px);
      background: rgba(22, 27, 34, 0.8);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border:1px solid var(--border-color);
      border-radius: 14px;
      box-shadow: 0 20px 60px rgba(0,0,0,.4);
      transform: scale(0.95);
      transition: transform .2s ease;
    }
    .modal.show .box { transform: scale(1); }
    .modal .box .head{
      padding: 16px 20px;
      border-bottom:1px solid var(--border-color);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      font-size: 20px; font-weight: 600;
    }
    .modal .box .body{ padding: 20px; }
    .kvs{ display:grid; grid-template-columns: 160px 1fr; gap:12px 16px; align-items:center; }
    .kvs .k{ color: var(--text-secondary); font-size: 14px; }
    .log{
      font: 13px/1.5 var(--font-mono);
      background: var(--bg-dark);
      color: var(--text-secondary);
      padding:12px;
      border-radius:8px;
      border:1px solid var(--border-color);
      height:180px;
      overflow:auto;
      white-space:pre-wrap;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="title">
        📦 Bảng vận đơn (Bills)
        <span class="badge" id="datasetMeta">đang tải…</span>
      </div>
      <div class="badge">Apps Script JSONP</div>
    </div>

    <div class="card">
      <div class="toolbar">
        <div class="group srch" style="flex:1 1 420px">
          <input id="q" class="input" type="search" placeholder="Tìm nhanh trên trang hiện tại (mọi cột)…" style="width:100%" />
        </div>
        <div class="group">
          <label for="limit">Mỗi trang</label>
          <select id="limit" class="select">
            <option>25</option>
            <option selected>50</option>
            <option>100</option>
            <option>200</option>
          </select>
        </div>
        <div class="group pagination">
          <button id="prev" class="btn secondary">◀ Trước</button>
          <span class="pill" id="pageinfo">Trang 1/1</span>
          <button id="next" class="btn secondary">Tiếp ▶</button>
          <button id="reload" class="btn">↻ Nạp lại</button>
          <button id="diagBtn" class="btn warn">⚙ Chẩn đoán</button>
        </div>
      </div>

      <!-- Quick inline editor -->
      <div class="toolbar" style="border-top:1px solid var(--border-color); top: 73px;">
        <div class="group">
          <span class="badge">Chỉnh sửa nhanh</span>
        </div>
        <div class="group">
          <label for="billNo">Số Bill</label>
          <input id="billNo" class="input w-m" placeholder="VD: B1234" />
        </div>
        <div class="group">
          <label for="colSel">Cột</label>
          <select id="colSel" class="select w-l"></select>
        </div>
        <div class="group" style="flex:1 1 280px">
          <label for="newVal">Giá trị mới</label>
          <input id="newVal" class="input" placeholder="Nhập giá trị…" style="width:100%" />
        </div>
        <div class="group">
          <button id="saveBtn" class="btn">💾 Lưu (doPost)</button>
        </div>
      </div>

      <div class="table-wrap">
        <table id="table">
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="statusbar">
        <span id="status">Đang tải dữ liệu…</span>
        <span class="mono" id="updated"></span>
      </div>
    </div>

    <!-- Inline notice for network permission in canvas -->
    <p class="notice" id="permNote" style="display:none;margin-top:16px">
      ⚠ Trình xem có thể đang chặn mạng. Hãy bấm <b>Allow</b> khi popup hỏi quyền xuất hiện, rồi nhấn <b>↻ Nạp lại</b>. Bạn cũng có thể mở file HTML này trực tiếp ngoài canvas để không bị chặn.
    </p>
  </div>

  <!-- Diagnostics Modal -->
  <div class="modal" id="diagModal">
    <div class="box">
      <div class="head">
        <span>Chẩn đoán kết nối</span>
        <button id="closeDiag" class="btn secondary">Đóng</button>
      </div>
      <div class="body">
        <div class="kvs" style="margin-bottom:16px">
          <div class="k">Endpoint</div>
          <div>
            <input id="endpoint" class="input" style="width:100%" />
            <div style="margin-top:8px; display:flex; gap:8px;">
              <button id="saveEndpoint" class="btn secondary">Lưu endpoint</button>
              <a id="openJsonp" class="btn secondary" style="text-decoration:none; display:inline-block" target="_blank">Mở trong tab mới</a>
            </div>
          </div>
          <div class="k">Gợi ý</div>
          <div class="notice">
            Đảm bảo Apps Script Web App đang <b>Deploy</b> với <b>Execute as: Me</b> và <b>Who has access: Anyone</b>.
            Endpoint phải trả về <code>callback(...)</code> (JSONP), không phải JSON thuần.
          </div>
        </div>
        <div style="display:flex; gap:8px; margin:16px 0">
          <button id="runTests" class="btn">▶ Chạy test</button>
          <button id="loadSample" class="btn secondary">Nạp dữ liệu mẫu</button>
        </div>
        <div class="log" id="log"></div>
      </div>
    </div>
  </div>

<script>
  // ====== Config (editable via Diagnostics) ======
  let GAS_URL = 'https://script.google.com/macros/s/AKfycbyMrOG8nhmPXi_PkvfjAS_FqUViaQxUESsTlvWKKe815JAikAEUV4ZKBKpXjQubsRGySw/exec';
  const WRITE_KEY = '';

  // ====== JSONP helper (with timeout & placeholder support) ======
  function jsonp(url, opts={}){
    const param = opts.param || 'callback';
    const timeout = opts.timeout || 12000;
    const placeholder = opts.placeholder || '$CALLBACK$';
    const raw = !!opts.raw; // nếu true, url có chứa placeholder và ta sẽ thay bằng tên callback

    return new Promise((resolve, reject) => {
      const cb = 'cb_' + Math.random().toString(36).slice(2);
      let done = false;
      let timer;
      let s;
      function cleanup(){
        done = true;
        clearTimeout(timer);
        window[cb] && delete window[cb];
        if (s && s.parentNode) s.parentNode.removeChild(s);
      }
      window[cb] = (data) => { cleanup(); resolve(data); };

      // Build src
      let src;
      if (raw) {
        src = url.replace(placeholder, cb);
      } else {
        const hasParam = url.includes(param+'=');
        src = url + (url.includes('?') ? '&' : '?') + (hasParam ? '' : param + '=' + cb);
      }
      // cache buster
      src += (src.includes('?') ? '&' : '?') + '_ts=' + Date.now();

      s = document.createElement('script');
      s.async = true;
      s.src = src;
      s.onerror = () => { if (done) return; cleanup(); reject(new Error('JSONP failed (network/blocked)')); };

      timer = setTimeout(() => { if (done) return; cleanup(); reject(new Error('JSONP timeout (no callback executed)')); }, timeout);
      document.head.appendChild(s);
    });
  }

  // ====== State ======
  let columns = [];
  let total = 0;
  let page = 1;
  let limit = 50;
  let currentRows = [];

  // ====== UI refs ======
  const thead = document.getElementById('thead');
  const tbody = document.getElementById('tbody');
  const q = document.getElementById('q');
  const limitSel = document.getElementById('limit');
  const prevBtn = document.getElementById('prev');
  const nextBtn = document.getElementById('next');
  const reloadBtn = document.getElementById('reload');
  const diagBtn = document.getElementById('diagBtn');
  const pageinfo = document.getElementById('pageinfo');
  const statusEl = document.getElementById('status');
  const updatedEl = document.getElementById('updated');
  const datasetMeta = document.getElementById('datasetMeta');
  const billNo = document.getElementById('billNo');
  const colSel = document.getElementById('colSel');
  const newVal = document.getElementById('newVal');
  const saveBtn = document.getElementById('saveBtn');
  const permNote = document.getElementById('permNote');
  const diagModal = document.getElementById('diagModal');
  const closeDiag = document.getElementById('closeDiag');
  const endpoint = document.getElementById('endpoint');
  const saveEndpoint = document.getElementById('saveEndpoint');
  const openJsonp = document.getElementById('openJsonp');
  const runTestsBtn = document.getElementById('runTests');
  const loadSampleBtn = document.getElementById('loadSample');
  const logEl = document.getElementById('log');

  // ====== Column presentation rules ======
  const centerCols = new Set([
    'Số Bill','Ngày bốc','Mã khách gửi','Tỉnh','Xã','Tỉnh nhận','Xã nhận','SĐT khách nhận',
    'Số kiện','Trọng lượng thực','Thể tích','Đơn vị tính cước','Đơn giá','Phụ phí','VAT','Thành tiền','COD','Trạng thái thanh toán','Người thanh toán','STT'
  ]);
  const widthMap = {
    'Số Bill':'w-xs', 'Ngày bốc':'w-s', 'Mã khách gửi':'w-s', 'Tỉnh':'w-s', 'Xã':'w-s',
    'Tên khách gửi':'w-m', 'Địa chỉ':'w-xl', 'Địa chỉ đã lưu':'w-xl',
    'Tên khách nhận':'w-m', 'Địa chỉ nhận':'w-xl', 'Tỉnh nhận':'w-s', 'Xã nhận':'w-s', 'SĐT khách nhận':'w-m',
    'Dịch vụ GTGT':'w-m', 'Nội dung hàng hóa':'w-xl', 'Số kiện':'w-xs', 'Trọng lượng thực':'w-s', 'Thể tích':'w-s',
    'Đơn vị tính cước':'w-m', 'Đơn giá':'w-m', 'Phụ phí':'w-m', 'VAT':'w-xs', 'Thành tiền':'w-m',
    'Người thanh toán':'w-m', 'COD':'w-m', 'Trạng thái thanh toán':'w-m', 'Ghi chú':'w-xl', 'STT':'w-xs'
  };

  // ====== Renderers ======
  function renderHeader(){
    const tr = document.createElement('tr');
    colSel.innerHTML = '';
    for(const name of columns){
      const th = document.createElement('th');
      th.textContent = name;
      if(centerCols.has(name)) th.classList.add('center');
      const w = widthMap[name]; if(w) th.classList.add(w);
      tr.appendChild(th);

      const opt = document.createElement('option');
      opt.value = name; opt.textContent = name;
      colSel.appendChild(opt);
    }
    thead.innerHTML = '';
    thead.appendChild(tr);
  }

  function htmlesc(s){ return String(s==null? '': s).replace(/[&<>]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[ch])); }

  // --- NEW: Handler for auto-saving STT column edits ---
  async function handleSttEdit(event) {
    const cell = event.target;
    const newValue = cell.textContent.trim();
    const originalValue = cell.dataset.originalValue;
    const billNo = cell.closest('tr').dataset.billNo;

    // Do nothing if value hasn't changed or if we can't find the bill number
    if (newValue === originalValue || !billNo) {
      return;
    }

    // UI feedback: Saving in progress
    cell.style.backgroundColor = 'rgba(240, 169, 35, 0.2)'; // Warn color
    setStatus(`Đang lưu STT mới "${newValue}" cho Bill ${billNo}...`);

    try {
      const resp = await doPostUpdate({ bill: billNo, column: 'STT', value: newValue });
      if (!resp || resp.ok === false) {
        throw new Error(resp.error || 'Phản hồi không thành công từ server.');
      }
      
      // UI feedback: Success
      cell.style.backgroundColor = 'rgba(63, 185, 80, 0.2)'; // Success color
      cell.dataset.originalValue = newValue; // Update original value to prevent re-saving
      setStatus(`Lưu thành công STT cho Bill ${billNo}.`);

    } catch (e) {
      console.error('Update failed:', e);
      // UI feedback: Error
      cell.style.backgroundColor = 'rgba(248, 81, 73, 0.2)'; // Danger color
      cell.textContent = originalValue; // Revert to original value
      setStatus(`❌ Lỗi khi lưu STT cho Bill ${billNo}: ${e.message}`);
    } finally {
      // Reset background color after a delay
      setTimeout(() => {
        cell.style.backgroundColor = '';
      }, 2500);
    }
  }

  function renderRows(rows){
    if(!rows || !rows.length){
      tbody.innerHTML = `<tr><td colspan="${columns.length}"><div class="empty">Không có dữ liệu.</div></td></tr>`;
      return;
    }
    const frag = document.createDocumentFragment();
    for(const r of rows){
      const tr = document.createElement('tr');
      // --- NEW: Add data-bill-no to the row for easy identification ---
      tr.dataset.billNo = r['Số Bill'];

      for(const col of columns){
        const td = document.createElement('td');
        const val = r[col] ?? '';
        td.innerHTML = htmlesc(val);
        if(centerCols.has(col)) td.classList.add('center');
        const w = widthMap[col]; if(w) td.classList.add(w);

        // --- NEW: Make STT column editable ---
        if (col === 'STT') {
          td.contentEditable = true;
          td.dataset.originalValue = val; // Store original value
          td.addEventListener('blur', handleSttEdit); // Add event listener
        }

        tr.appendChild(td);
      }
      frag.appendChild(tr);
    }
    tbody.innerHTML = '';
    tbody.appendChild(frag);
  }

  function updatePageInfo(){
    const pages = Math.max(1, Math.ceil(total / limit));
    page = Math.min(Math.max(1, page), pages);
    prevBtn.disabled = (page <= 1);
    nextBtn.disabled = (page >= pages);
    pageinfo.textContent = `Trang ${page}/${pages}`;
  }

  function setStatus(text){ statusEl.textContent = text; }

  // ====== Data loading ======
  async function loadPage(){
    try{
      setStatus('Đang tải dữ liệu…');
      limit = parseInt(limitSel.value,10) || 50;
      const offset = (page - 1) * limit;
      const url = `${GAS_URL}?offset=${offset}&limit=${limit}`;
      const resp = await jsonp(url);
      if(!resp || resp.ok === false){ throw new Error(resp && resp.error || 'Tải thất bại'); }

      columns = resp.columns || Object.keys((resp.rows && resp.rows[0]) || {});
      total = resp.total || (resp.rows ? resp.rows.length : 0);
      currentRows = resp.rows || [];

      renderHeader();
      applySearch();
      updatePageInfo();
      setStatus(`Đã nạp ${currentRows.length} dòng / tổng ${total}`);
      updatedEl.textContent = resp.updatedAt ? `Cập nhật: ${new Date(resp.updatedAt).toLocaleString()}` : '';
      datasetMeta.textContent = `${resp.sheetName || 'Bill'} • ${resp.spreadsheetId || ''}`;
    }catch(err){
      console.error(err);
      setStatus('❌ Lỗi: ' + err.message);
      permNote.style.display = 'block';
    }
  }

  // ====== Submit update via hidden iframe (avoid CORS) ======
  function doPostUpdate({ bill, column, value }){
    return new Promise((resolve) => {
      const iframeName = 'post_ifr_' + Math.random().toString(36).slice(2);
      const ifr = document.createElement('iframe');
      ifr.name = iframeName; ifr.style.display = 'none';
      document.body.appendChild(ifr);

      const form = document.createElement('form');
      form.method = 'POST';
      form.action = `${GAS_URL}?target=iframe`;
      form.target = iframeName;

      const params = {
        key: WRITE_KEY || '',
        mode: 'update',
        keyField: 'Số Bill',
        keyValue: bill,
        set: JSON.stringify({ [column]: value })
      };
      for(const [k,v] of Object.entries(params)){
        const inp = document.createElement('input');
        inp.type = 'hidden'; inp.name = k; inp.value = v; form.appendChild(inp);
      }
      document.body.appendChild(form);

      const onMsg = (ev) => {
        if(!ev || !ev.data || ev.data.source !== 'apps-script') return;
        window.removeEventListener('message', onMsg);
        setTimeout(() => { ifr.remove(); form.remove(); }, 100);
        resolve(ev.data.payload);
      };
      window.addEventListener('message', onMsg);
      form.submit();
    });
  }

  // ====== Search (client-side) ======
  function applySearch(){
    if(!currentRows) return;
    const keyword = q.value.trim().toLowerCase();
    let rows = currentRows;
    if(keyword){
      rows = currentRows.filter(obj => {
        for(const col of columns){
          const v = (obj[col]||'').toString().toLowerCase();
          if(v.includes(keyword)) return true;
        }
        return false;
      });
    }
    renderRows(rows);
  }

  // ====== Diagnostics ======
  function log(msg){ logEl.textContent += (logEl.textContent ? '\n' : '') + msg; logEl.scrollTop = logEl.scrollHeight; }
  function openDiag(){ diagModal.classList.add('show'); endpoint.value = GAS_URL; refreshOpenJsonpLink(); logEl.textContent=''; }
  function closeDiagModal(){ diagModal.classList.remove('show'); }
  function refreshOpenJsonpLink(){ const test = endpoint.value + (endpoint.value.includes('?')?'&':'?') + 'offset=0&limit=1&callback=jsonpTest'; openJsonp.href = test; }

  async function runTests(){
    logEl.textContent = '';
    log('Test 1: JSONP nội bộ (data: URL)...');
    try{
      const dataUrl = 'data:text/javascript,' + encodeURIComponent('$CALLBACK$({ok:true, hello:"world"});');
      const r1 = await jsonp(dataUrl, { raw:true });
      log('  ✔ Thành công: ' + JSON.stringify(r1));
    }catch(e){ log('  ✖ Thất bại: ' + e.message); }

    log('Test 2: Kiểm tra endpoint trả JSONP...');
    try{
      const url = endpoint.value + (endpoint.value.includes('?')?'&':'?') + 'offset=0&limit=1&callback=$CALLBACK$';
      const r2 = await jsonp(url, { raw:true });
      log('  ✔ Trả JSONP hợp lệ: ' + JSON.stringify(r2));
    }catch(e){
      log('  ✖ Không nhận được JSONP: ' + e.message);
      log('    Hướng dẫn:');
      log('    • Mở link ở nút "Mở trong tab mới" và xem nội dung bắt đầu bằng jsonpTest( ... ) hay không.');
      log('    • Nếu thấy trang đăng nhập Google, hãy redeploy Web App với Who has access = Anyone.');
      log('    • Nếu nội dung là JSON thuần (bắt đầu bằng { ), cần dùng JSONP (trả callback) hoặc đi qua proxy.');
    }
  }

  function loadSample(){
    const sample = {
      ok:true,
      spreadsheetId: 'sample',
      sheetName: 'Bill',
      total: 2,
      columns: ['STT','Số Bill','Tên khách gửi','Tên khách nhận','Địa chỉ','Đơn giá','Thành tiền','Trạng thái thanh toán','Ghi chú'],
      rows: [
        { 'STT':'1','Số Bill':'B0001','Tên khách gửi':'Nguyễn A','Tên khách nhận':'Trần B','Địa chỉ':'Hà Nội','Đơn giá':'50,000','Thành tiền':'75,000','Trạng thái thanh toán':'Chưa thu','Ghi chú':'demo' },
        { 'STT':'2','Số Bill':'B0002','Tên khách gửi':'Lê C','Tên khách nhận':'Phạm D','Địa chỉ':'HCM','Đơn giá':'60,000','Thành tiền':'60,000','Trạng thái thanh toán':'Đã thu','Ghi chú':'' }
      ],
      updatedAt: new Date().toISOString()
    };
    columns = sample.columns; total = sample.total; currentRows = sample.rows;
    renderHeader(); applySearch(); updatePageInfo(); datasetMeta.textContent = `${sample.sheetName} • ${sample.spreadsheetId}`; updatedEl.textContent = `Cập nhật: ${new Date(sample.updatedAt).toLocaleString()}`; setStatus('Đã nạp dữ liệu mẫu.');
  }

  // ====== Events ======
  limitSel.addEventListener('change', () => { page = 1; loadPage(); });
  prevBtn.addEventListener('click', () => { page--; loadPage(); });
  nextBtn.addEventListener('click', () => { page++; loadPage(); });
  reloadBtn.addEventListener('click', () => loadPage());
  q.addEventListener('input', () => applySearch());
  saveBtn.addEventListener('click', async () => {
    const bill = billNo.value.trim();
    const column = colSel.value;
    const value = newVal.value;
    if(!bill || !column){ alert('Điền Số Bill và chọn cột cần sửa.'); return; }
    setStatus('Đang gửi cập nhật…');
    try{
      const resp = await doPostUpdate({ bill, column, value });
      setStatus('Đã cập nhật. Đang tải lại…');
      await loadPage();
    }catch(e){ console.error(e); setStatus('❌ Gửi cập nhật thất bại'); }
  });

  diagBtn.addEventListener('click', openDiag);
  closeDiag.addEventListener('click', closeDiagModal);
  saveEndpoint.addEventListener('click', () => { GAS_URL = endpoint.value.trim(); setStatus('Đã lưu endpoint. Nhấn ↻ Nạp lại để thử.'); refreshOpenJsonpLink(); });
  endpoint.addEventListener('input', refreshOpenJsonpLink);
  runTestsBtn.addEventListener('click', runTests);
  loadSampleBtn.addEventListener('click', loadSample);

  // ====== Init ======
  // Gợi ý bật note quyền mạng nếu đang chạy trong canvas trước khi có dữ liệu
  setTimeout(() => { if (!currentRows.length) permNote.style.display = 'block'; }, 1500);
  loadPage();
</script>
</body>
</html>

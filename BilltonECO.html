<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bill Viewer</title>
  <style>
    /* ====== Office Light Theme UI - Spreadsheet Style ====== */
    :root{
      --bg-light: #FFFFFF;
      --bg-secondary: #F8F9FA;
      --border-color: #DEE2E6;
      --grid-color: #D3D3D3;
      --text-primary: #212529;
      --text-secondary: #6C757D;
      --accent-primary: #0D6EFD;
      --success: #198754;
      --danger: #DC3545;
      --warn: #FFC107;
      --header-yellow-bg: #FFF3CD;
      --header-yellow-text: #664D03;
      --font-sans: "Times New Roman", Times, serif;
      --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin:0;
      font: 16px/1.6 var(--font-sans);
      color: var(--text-primary);
      background-color: var(--bg-secondary);
    }
    .container{ max-width: 1600px; margin: 32px auto; padding: 0 24px; }

    .header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      margin-bottom: 24px;
    }
    .title{
      font-size: 28px;
      font-weight: 700;
      letter-spacing:-.5px;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .badge{
      font-size:12px;
      font-weight: 500;
      color: var(--text-secondary);
      padding: 4px 12px;
      border: 1px solid var(--border-color);
      border-radius: 20px;
      background-color: var(--bg-light);
    }

    .card{
      background: var(--bg-light);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      overflow:hidden;
    }

    .toolbar{
      position: sticky; top:0; z-index:10;
      display:flex; flex-wrap:wrap; gap:12px; align-items:center;
      padding: 16px 20px;
      border-bottom:1px solid var(--border-color);
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    .toolbar .group{ display:flex; gap:8px; align-items:center; }
    .toolbar label { font-size: 14px; color: var(--text-secondary); }

    .input, .select{
      background: var(--bg-light);
      border: 1px solid #CED4DA;
      color: var(--text-primary);
      padding: 8px 12px;
      border-radius: 6px;
      outline: none;
      min-width: 120px;
      font-size: 14px;
      font-family: var(--font-sans);
      transition: border-color .2s ease, box-shadow .2s ease;
    }
    .input::placeholder{ color: #6C757D; }
    .input:focus, .select:focus{
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.2);
    }

    .btn{
      cursor:pointer; user-select:none; border:1px solid transparent;
      border-radius: 6px; padding: 8px 16px; font-weight:600; font-size: 14px;
      background: var(--accent-primary);
      color: white;
      font-family: var(--font-sans);
      transition: all .15s ease;
    }
    .btn:disabled{ opacity:.65; cursor:not-allowed; }
    .btn:hover:not(:disabled){ filter: brightness(1.1); }
    .btn.secondary{
      background: var(--bg-secondary);
      border-color: #CED4DA;
      color: var(--text-primary);
    }
    .btn.secondary:hover:not(:disabled){
      background: #E2E6EA;
    }

    .notice{
      background: #FFF3CD;
      color: #664D03;
      border: 1px solid #FFECB5;
      padding: 12px 16px;
      border-radius: 6px;
      font-size: 14px;
    }

    .statusbar{
      display:flex; flex-wrap:wrap; gap:16px; align-items:center;
      color:var(--text-secondary);
      padding: 12px 20px;
      border-top:1px solid var(--border-color);
      font-size: 13px;
      background-color: var(--bg-secondary);
    }

    /* --- NEW: Table container with max-height for sticky header to work --- */
    .table-wrap{ 
      width:100%; 
      overflow:auto; 
      max-height: calc(100vh - 300px); /* Adjust this value as needed */
    }
    table{
      width:100%;
      border-collapse: collapse;
      min-width: 1280px;
    }

    thead th{
      position: sticky; 
      top: 0; /* Stick to the top of .table-wrap */
      z-index: 10;
      color: var(--header-yellow-text);
      font-weight: bold;
      text-align: left;
      vertical-align: middle;
      padding: 10px 12px;
      /* --- NEW: Yellow background --- */
      background: var(--header-yellow-bg);
    }

    th, td{
      padding: 10px 12px;
      border: 1px solid var(--grid-color);
      vertical-align: top;
      white-space: nowrap;
    }
    
    tbody td {
      font-size: 14px;
    }

    /* --- NEW: Sticky first column --- */
    thead th:first-child, tbody td:first-child {
      position: sticky;
      left: 0;
      z-index: 5;
      background: var(--bg-light); /* Match body cell background */
    }
    thead th:first-child {
      z-index: 11; /* Higher than the rest of the header */
      background: var(--header-yellow-bg); /* Match header background */
    }

    tbody tr:hover td { background: #F1F3F5; }
    /* Keep sticky column consistent on hover */
    tbody tr:hover td:first-child { background: #E9ECEF; }
    
    td[contenteditable="true"] {
      cursor: cell;
      outline: none;
      transition: background-color .3s ease, box-shadow .3s ease;
    }
    td[contenteditable="true"]:focus {
      box-shadow: inset 0 0 0 2px var(--accent-primary);
      background-color: var(--bg-light);
    }

    /* --- NEW: Visible Scrollbar Styling --- */
    .table-wrap {
      scrollbar-width: thin;
      scrollbar-color: var(--text-secondary) var(--bg-secondary);
    }
    .table-wrap::-webkit-scrollbar {
      width: 12px;
      height: 12px;
    }
    .table-wrap::-webkit-scrollbar-track {
      background: var(--bg-secondary);
    }
    .table-wrap::-webkit-scrollbar-thumb {
      background-color: var(--text-secondary);
      border-radius: 10px;
      border: 3px solid var(--bg-secondary);
    }

    .center{ text-align:center; }
    .right{ text-align:right; }
    .mono{ font-family: var(--font-mono); font-size: 13px; color: var(--text-secondary); }

    .w-xs{ width: 84px; } .w-s{ width: 120px; } .w-m{ width: 160px; }
    .w-l{ width: 240px; } .w-xl{ width: 320px; }

    .pagination{ display:flex; align-items:center; gap:8px; margin-left:auto; }
    .pill{
      border:1px solid var(--border-color);
      padding: 6px 12px;
      border-radius: 20px;
      color: var(--text-secondary);
      background-color: var(--bg-light);
      font-size: 13px;
    }

    .srch{ flex: 1 1 320px; }
    .empty{ padding: 48px 24px; text-align:center; color: var(--text-secondary); }

    /* --- NEW: Print Styles --- */
    @media print {
      body, .container, .card {
        margin: 0;
        padding: 0;
        border: none;
        box-shadow: none;
        background: none;
      }
      .header, .toolbar, .statusbar, .notice, .pagination, #saveBtn, #reloadBtn, #printBtn, #sortBtn {
        display: none !important;
      }
      .table-wrap {
        max-height: none;
        overflow: visible;
      }
      table, th, td {
        border: 1px solid #000;
        font-size: 10pt;
      }
      thead {
        background-color: #eee;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="title">
        üì¶ B·∫£ng v·∫≠n ƒë∆°n (Bills)
        <span class="badge" id="datasetMeta">ƒëang t·∫£i‚Ä¶</span>
      </div>
      <div class="badge">Apps Script JSONP</div>
    </div>

    <div class="card">
      <div class="toolbar">
        <div class="group srch" style="flex:1 1 420px">
          <input id="q" class="input" type="search" placeholder="T√¨m nhanh tr√™n trang hi·ªán t·∫°i (m·ªçi c·ªôt)‚Ä¶" style="width:100%" />
        </div>
        <div class="group">
          <label for="limit">M·ªói trang</label>
          <select id="limit" class="select">
            <option>25</option>
            <option selected>50</option>
            <option>100</option>
            <option>200</option>
          </select>
        </div>
        <div class="group pagination">
          <button id="sortBtn" class="btn secondary">‚áÖ S·∫Øp x·∫øp l·∫°i STT</button>
          <button id="prev" class="btn secondary">‚óÄ Tr∆∞·ªõc</button>
          <span class="pill" id="pageinfo">Trang 1/1</span>
          <button id="next" class="btn secondary">Ti·∫øp ‚ñ∂</button>
          <button id="reload" class="btn">‚Üª N·∫°p l·∫°i</button>
          <!-- NEW: Print Button -->
          <button id="printBtn" class="btn secondary">üñ®Ô∏è In</button>
        </div>
      </div>

      <!-- Quick inline editor (This toolbar is now hidden by default in the CSS for printing) -->
      <div class="toolbar" style="border-top:1px solid var(--border-color);">
        <div class="group">
          <span class="badge">Ch·ªânh s·ª≠a nhanh</span>
        </div>
        <div class="group">
          <label for="billNo">S·ªë Bill</label>
          <input id="billNo" class="input w-m" placeholder="VD: B1234" />
        </div>
        <div class="group">
          <label for="colSel">C·ªôt</label>
          <select id="colSel" class="select w-l"></select>
        </div>
        <div class="group" style="flex:1 1 280px">
          <label for="newVal">Gi√° tr·ªã m·ªõi</label>
          <input id="newVal" class="input" placeholder="Nh·∫≠p gi√° tr·ªã‚Ä¶" style="width:100%" />
        </div>
        <div class="group">
          <button id="saveBtn" class="btn">üíæ L∆∞u (doPost)</button>
        </div>
      </div>

      <div class="table-wrap">
        <table id="table">
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="statusbar">
        <span id="status">ƒêang t·∫£i d·ªØ li·ªáu‚Ä¶</span>
        <span class="mono" id="updated"></span>
      </div>
    </div>

    <!-- Inline notice for network permission in canvas -->
    <p class="notice" id="permNote" style="display:none;margin-top:16px">
      ‚ö† Tr√¨nh xem c√≥ th·ªÉ ƒëang ch·∫∑n m·∫°ng. H√£y b·∫•m <b>Allow</b> khi popup h·ªèi quy·ªÅn xu·∫•t hi·ªán, r·ªìi nh·∫•n <b>‚Üª N·∫°p l·∫°i</b>. B·∫°n c≈©ng c√≥ th·ªÉ m·ªü file HTML n√†y tr·ª±c ti·∫øp ngo√†i canvas ƒë·ªÉ kh√¥ng b·ªã ch·∫∑n.
    </p>
  </div>

<script>
  // ====== Config (editable via Diagnostics) ======
  let GAS_URL = 'https://script.google.com/macros/s/AKfycbyMrOG8nhmPXi_PkvfjAS_FqUViaQxUESsTlvWKKe815JAikAEUV4ZKBKpXjQubsRGySw/exec';
  const WRITE_KEY = '';

  // ====== JSONP helper (with timeout & placeholder support) ======
  function jsonp(url, opts={}){
    const param = opts.param || 'callback';
    const timeout = opts.timeout || 12000;
    const placeholder = opts.placeholder || '$CALLBACK$';
    const raw = !!opts.raw;

    return new Promise((resolve, reject) => {
      const cb = 'cb_' + Math.random().toString(36).slice(2);
      let done = false;
      let timer;
      let s;
      function cleanup(){
        done = true;
        clearTimeout(timer);
        window[cb] && delete window[cb];
        if (s && s.parentNode) s.parentNode.removeChild(s);
      }
      window[cb] = (data) => { cleanup(); resolve(data); };

      let src;
      if (raw) {
        src = url.replace(placeholder, cb);
      } else {
        const hasParam = url.includes(param+'=');
        src = url + (url.includes('?') ? '&' : '?') + (hasParam ? '' : param + '=' + cb);
      }
      src += (src.includes('?') ? '&' : '?') + '_ts=' + Date.now();

      s = document.createElement('script');
      s.async = true;
      s.src = src;
      s.onerror = () => { if (done) return; cleanup(); reject(new Error('JSONP failed (network/blocked)')); };

      timer = setTimeout(() => { if (done) return; cleanup(); reject(new Error('JSONP timeout (no callback executed)')); }, timeout);
      document.head.appendChild(s);
    });
  }

  // ====== State ======
  let columns = [];
  let total = 0;
  let page = 1;
  let limit = 50;
  let currentRows = [];

  // ====== UI refs ======
  const thead = document.getElementById('thead');
  const tbody = document.getElementById('tbody');
  const q = document.getElementById('q');
  const limitSel = document.getElementById('limit');
  const prevBtn = document.getElementById('prev');
  const nextBtn = document.getElementById('next');
  const reloadBtn = document.getElementById('reload');
  const sortBtn = document.getElementById('sortBtn');
  const printBtn = document.getElementById('printBtn'); // New button ref
  const pageinfo = document.getElementById('pageinfo');
  const statusEl = document.getElementById('status');
  const updatedEl = document.getElementById('updated');
  const datasetMeta = document.getElementById('datasetMeta');
  const billNo = document.getElementById('billNo');
  const colSel = document.getElementById('colSel');
  const newVal = document.getElementById('newVal');
  const saveBtn = document.getElementById('saveBtn');
  const permNote = document.getElementById('permNote');

  // ====== Column presentation rules ======
  const centerCols = new Set([
    'S·ªë Bill','Ng√†y b·ªëc','M√£ kh√°ch g·ª≠i','T·ªânh','X√£','T·ªânh nh·∫≠n','X√£ nh·∫≠n','SƒêT kh√°ch nh·∫≠n',
    'S·ªë ki·ªán','Tr·ªçng l∆∞·ª£ng th·ª±c','Th·ªÉ t√≠ch','ƒê∆°n v·ªã t√≠nh c∆∞·ªõc','ƒê∆°n gi√°','Ph·ª• ph√≠','VAT','Th√†nh ti·ªÅn','COD','Tr·∫°ng th√°i thanh to√°n','Ng∆∞·ªùi thanh to√°n','STT'
  ]);
  const widthMap = {
    'S·ªë Bill':'w-xs', 'Ng√†y b·ªëc':'w-s', 'M√£ kh√°ch g·ª≠i':'w-s', 'T·ªânh':'w-s', 'X√£':'w-s',
    'T√™n kh√°ch g·ª≠i':'w-m', 'ƒê·ªãa ch·ªâ':'w-xl', 'ƒê·ªãa ch·ªâ ƒë√£ l∆∞u':'w-xl',
    'T√™n kh√°ch nh·∫≠n':'w-m', 'ƒê·ªãa ch·ªâ nh·∫≠n':'w-xl', 'T·ªânh nh·∫≠n':'w-s', 'X√£ nh·∫≠n':'w-s', 'SƒêT kh√°ch nh·∫≠n':'w-m',
    'D·ªãch v·ª• GTGT':'w-m', 'N·ªôi dung h√†ng h√≥a':'w-xl', 'S·ªë ki·ªán':'w-xs', 'Tr·ªçng l∆∞·ª£ng th·ª±c':'w-s', 'Th·ªÉ t√≠ch':'w-s',
    'ƒê∆°n v·ªã t√≠nh c∆∞·ªõc':'w-m', 'ƒê∆°n gi√°':'w-m', 'Ph·ª• ph√≠':'w-m', 'VAT':'w-xs', 'Th√†nh ti·ªÅn':'w-m',
    'Ng∆∞·ªùi thanh to√°n':'w-m', 'COD':'w-m', 'Tr·∫°ng th√°i thanh to√°n':'w-m', 'Ghi ch√∫':'w-xl', 'STT':'w-xs'
  };

  // ====== Renderers ======
  function renderHeader(){
    const tr = document.createElement('tr');
    colSel.innerHTML = '';
    for(const name of columns){
      const th = document.createElement('th');
      th.textContent = name;
      if(centerCols.has(name)) th.classList.add('center');
      const w = widthMap[name]; if(w) th.classList.add(w);
      tr.appendChild(th);

      const opt = document.createElement('option');
      opt.value = name; opt.textContent = name;
      colSel.appendChild(opt);
    }
    thead.innerHTML = '';
    thead.appendChild(tr);
  }

  function htmlesc(s){ return String(s==null? '': s).replace(/[&<>]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[ch])); }

  async function handleCellEdit(event) {
    const cell = event.target;
    const newValue = cell.textContent.trim();
    const originalValue = cell.dataset.originalValue;
    const billNo = cell.closest('tr').dataset.billNo;
    const column = cell.dataset.column;

    if (newValue === originalValue || !billNo || !column) {
      return;
    }

    cell.style.backgroundColor = 'rgba(255, 193, 7, 0.2)';
    setStatus(`ƒêang l∆∞u "${newValue}" cho c·ªôt "${column}" c·ªßa Bill ${billNo}...`);

    try {
      const resp = await doPostUpdate({ bill: billNo, column: column, value: newValue });
      if (!resp || resp.ok === false) {
        throw new Error(resp.error || 'Ph·∫£n h·ªìi kh√¥ng th√†nh c√¥ng t·ª´ server.');
      }
      
      cell.style.backgroundColor = 'rgba(25, 135, 84, 0.15)';
      cell.dataset.originalValue = newValue;
      
      // Update the value in the client-side data model as well
      const rowIndex = currentRows.findIndex(row => row['S·ªë Bill'] === billNo);
      if (rowIndex > -1) {
        currentRows[rowIndex][column] = newValue;
      }

      setStatus(`L∆∞u th√†nh c√¥ng cho Bill ${billNo}.`);

    } catch (e) {
      console.error('Update failed:', e);
      cell.style.backgroundColor = 'rgba(220, 53, 69, 0.15)';
      cell.textContent = originalValue;
      setStatus(`‚ùå L·ªói khi l∆∞u cho Bill ${billNo}: ${e.message}`);
    } finally {
      setTimeout(() => {
        cell.style.backgroundColor = '';
      }, 2500);
    }
  }

  function renderRows(rows){
    if(!rows || !rows.length){
      tbody.innerHTML = `<tr><td colspan="${columns.length}"><div class="empty">Kh√¥ng c√≥ d·ªØ li·ªáu.</div></td></tr>`;
      return;
    }
    const frag = document.createDocumentFragment();
    for(const r of rows){
      const tr = document.createElement('tr');
      tr.dataset.billNo = r['S·ªë Bill'];

      for(const col of columns){
        const td = document.createElement('td');
        const val = r[col] ?? '';
        td.innerHTML = htmlesc(val);
        if(centerCols.has(col)) td.classList.add('center');
        const w = widthMap[col]; if(w) td.classList.add(w);

        td.contentEditable = true;
        td.dataset.originalValue = val;
        td.dataset.column = col;
        td.addEventListener('blur', handleCellEdit);

        tr.appendChild(td);
      }
      frag.appendChild(tr);
    }
    tbody.innerHTML = '';
    tbody.appendChild(frag);
  }

  function updatePageInfo(){
    const pages = Math.max(1, Math.ceil(total / limit));
    page = Math.min(Math.max(1, page), pages);
    prevBtn.disabled = (page <= 1);
    nextBtn.disabled = (page >= pages);
    pageinfo.textContent = `Trang ${page}/${pages}`;
  }

  function setStatus(text){ statusEl.textContent = text; }

  function sortAndRender() {
    currentRows.sort((a, b) => {
      const sttA = parseInt(a['STT'], 10) || Infinity;
      const sttB = parseInt(b['STT'], 10) || Infinity;
      return sttA - sttB;
    });
    applySearch();
    setStatus('ƒê√£ s·∫Øp x·∫øp l·∫°i theo STT.');
  }

  async function loadPage(){
    try{
      setStatus('ƒêang t·∫£i d·ªØ li·ªáu‚Ä¶');
      limit = parseInt(limitSel.value,10) || 50;
      const offset = (page - 1) * limit;
      const url = `${GAS_URL}?offset=${offset}&limit=${limit}`;
      const resp = await jsonp(url);
      if(!resp || resp.ok === false){ throw new Error(resp && resp.error || 'T·∫£i th·∫•t b·∫°i'); }

      let fetchedColumns = resp.columns || Object.keys((resp.rows && resp.rows[0]) || {});
      
      const sttIndex = fetchedColumns.indexOf('STT');
      if (sttIndex > -1) {
        const sttColumn = fetchedColumns.splice(sttIndex, 1)[0];
        fetchedColumns.unshift(sttColumn);
      }
      columns = fetchedColumns;

      total = resp.total || (resp.rows ? resp.rows.length : 0);
      currentRows = resp.rows || [];

      currentRows.sort((a, b) => {
        const sttA = parseInt(a['STT'], 10) || Infinity;
        const sttB = parseInt(b['STT'], 10) || Infinity;
        return sttA - sttB;
      });

      renderHeader();
      applySearch();
      updatePageInfo();
      setStatus(`ƒê√£ n·∫°p ${currentRows.length} d√≤ng / t·ªïng ${total}`);
      updatedEl.textContent = resp.updatedAt ? `C·∫≠p nh·∫≠t: ${new Date(resp.updatedAt).toLocaleString()}` : '';
      datasetMeta.textContent = `${resp.sheetName || 'Bill'} ‚Ä¢ ${resp.spreadsheetId || ''}`;
    }catch(err){
      console.error(err);
      setStatus('‚ùå L·ªói: ' + err.message);
      permNote.style.display = 'block';
    }
  }

  function doPostUpdate({ bill, column, value }){
    return new Promise((resolve) => {
      const iframeName = 'post_ifr_' + Math.random().toString(36).slice(2);
      const ifr = document.createElement('iframe');
      ifr.name = iframeName; ifr.style.display = 'none';
      document.body.appendChild(ifr);

      const form = document.createElement('form');
      form.method = 'POST';
      form.action = `${GAS_URL}?target=iframe`;
      form.target = iframeName;

      const params = {
        key: WRITE_KEY,
        mode: 'update',
        keyField: 'S·ªë Bill',
        keyValue: bill,
        set: JSON.stringify({ [column]: value })
      };
      for(const [k,v] of Object.entries(params)){
        const inp = document.createElement('input');
        inp.type = 'hidden'; inp.name = k; inp.value = v; form.appendChild(inp);
      }
      document.body.appendChild(form);

      const onMsg = (ev) => {
        if(!ev || !ev.data || ev.data.source !== 'apps-script') return;
        window.removeEventListener('message', onMsg);
        setTimeout(() => { ifr.remove(); form.remove(); }, 100);
        resolve(ev.data.payload);
      };
      window.addEventListener('message', onMsg);
      form.submit();
    });
  }

  function applySearch(){
    if(!currentRows) return;
    const keyword = q.value.trim().toLowerCase();
    let rows = currentRows;
    if(keyword){
      rows = currentRows.filter(obj => {
        for(const col of columns){
          const v = (obj[col]||'').toString().toLowerCase();
          if(v.includes(keyword)) return true;
        }
        return false;
      });
    }
    renderRows(rows);
  }

  // ====== Events ======
  limitSel.addEventListener('change', () => { page = 1; loadPage(); });
  prevBtn.addEventListener('click', () => { page--; loadPage(); });
  nextBtn.addEventListener('click', () => { page++; loadPage(); });
  reloadBtn.addEventListener('click', () => loadPage());
  sortBtn.addEventListener('click', sortAndRender);
  printBtn.addEventListener('click', () => window.print()); // New print event
  q.addEventListener('input', () => applySearch());
  saveBtn.addEventListener('click', async () => {
    const bill = billNo.value.trim();
    const column = colSel.value;
    const value = newVal.value;
    if(!bill || !column){ alert('ƒêi·ªÅn S·ªë Bill v√† ch·ªçn c·ªôt c·∫ßn s·ª≠a.'); return; }
    setStatus('ƒêang g·ª≠i c·∫≠p nh·∫≠t‚Ä¶');
    try{
      const resp = await doPostUpdate({ bill, column, value });
      setStatus('ƒê√£ c·∫≠p nh·∫≠t. ƒêang t·∫£i l·∫°i‚Ä¶');
      await loadPage();
    }catch(e){ console.error(e); setStatus('‚ùå G·ª≠i c·∫≠p nh·∫≠t th·∫•t b·∫°i'); }
  });

  // ====== Init ======
  setTimeout(() => { if (!currentRows.length) permNote.style.display = 'block'; }, 1500);
  loadPage();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Báo Cáo Công Nợ | Tổng kho Hà Hòa</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4CAF50; --hover-color: #45a049; --text-color: #333;
            --border-color: #e0e0e0; --error-color: #d32f2f;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; }
        body { background-color: #f4f7f6; line-height: 1.6; }
        .container { max-width: 1400px; margin: 20px auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid var(--primary-color); }
        header img { height: 80px; margin-bottom: 10px; border-radius: 8px; }
        header h1 { color: var(--primary-color); font-size: 28px; }
        .tabs { display: flex; flex-wrap: wrap; border-bottom: 1px solid var(--border-color); margin-bottom: 25px; }
        .tab { padding: 12px 25px; cursor: pointer; background-color: #f5f5f5; border: 1px solid var(--border-color); border-bottom: none; margin-right: 5px; border-radius: 5px 5px 0 0; font-weight: 500; transition: background-color 0.3s, color 0.3s; }
        .tab.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { padding: 12px 15px; text-align: left; border: 1px solid var(--border-color); white-space: nowrap; }
        th { background-color: var(--primary-color); color: white; position: sticky; top: 0; z-index: 10; }
        tbody tr:nth-child(even) { background-color: #f9f9f9; }
        tbody tr:hover { background-color: #e8f5e9; }
        .status-indicator { text-align: center; padding: 20px; font-size: 16px; color: #777; font-style: italic; }
        .status-indicator.error { color: var(--error-color); font-weight: 500; }
        .table-title { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .table-title h2 { color: #333; }
        .table-title .record-count { font-size: 14px; color: #555; background-color: #e0e0e0; padding: 4px 10px; border-radius: 12px; font-weight: 500; }
        footer { text-align: center; margin-top: 30px; color: #888; font-size: 13px; }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <img alt="Logo" src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAkGBxAHBg8SBw4QDQ4OEA0QDw4SDQ8ODQ0QFREWFhURExYYHSggGBolGxMVITEhJSkrLi4uFx8zODMtNygtLisBCgoKDg0OGhAQGyslHyUtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLf/AABEIAKAAoAMBIgACEQEDEQH/xAAcAAEAAgMBAQEAAAAAAAAAAAAABgcDBAUCAQj/xABEEAACAQMCAwUDBgsGBgMAAAABAgADBBESIQUGMUEHEyJRYXEUMoGRoQgjQlKxwdEWJDNDU2Jy4fAkorLxJURzg7LC/AETREAAQMBBQQGCAQGAwAAAAAAAQACEQMEEiExBUFRcRMiMmGBkaGxssHR8ELhFVIjM0JSYnKCkvEG/QAGwEBAAIDAQEAAAAAAAAAAAAAAAECAwQFBgf/2gAMAwEAAhEDEQA/APcYiIgIiICIiAiIgIiICIiAiIgIiICIiAiIgIiICIiAiIgIiICIiAiIgIiICIiAiIgIiICIiAiIgIiICIiAiIgIiICIiAiIgIiICIiAiIgIiICIiAiIgIiICIiAiIgIiICIiAiIgIiICIiAiIgIiICIiAiIgIiICJGd5772Lsm9NtfbL9abXW/V9StTpqG9XG3I5OMnE0b/APG3wF/yNT/0pAecRE7L+NvAX/I1P/Skfxs4C/5Gp/6UgPOYidj/GzgL/AJGp/wClJ3Nl3jsO+3JtOzbzbrm5ClytKqrsoHUkA5AEwREBERAREQEREBERAREQEREBERAREQEREBERATzT+UduV9u7f2jZ9ot1rU3dDZ7dTDeovuqPVPrPjHRRONmfAn0tPIt87Wrb47wXV5Z2FV2jZ6K0kNJqg+0EAHr84GcdIDzCJi/418V/+D63/AKhE/jXxV/4Prf8AqEQFfE6jYt3drbR2pe2Srb6N7bqyMwBZDURs4J6jBPwM8v/Gvir/wfW//AFCJ3HczfS6Xm+bLsl92NXo3dyKVZ61dKq0wxwSwByAM5OPAn9ID1yIiAiIgIiICIiAiIgIiICIiAiIgIiICIiAiIgIiICfnpvl2Lbf7a7R+9VH6zP0KnnXfLcvcrdXfC93q/ba3W6XFaixSk2GUU0A/X+LMC5iJhPtP7k/8Anu4f9J/4p9p/cn/z3cP+k/8AFAV8T6b+TvsO0X2/7te3FOoKNnbWlQqMMes+CwA8lAP+YTz/wC0/uT/AOe7h/0n/in1H8mndLauy9k3N9e1rbbbrumh06VRWNJBkrnB4ySw58PjIHkoiICIiAiIgIiICIiAiIgIiICIiAiIgIiICIiAiIgIiICeO/yg9k23/AHxvd5S01H2dXtaZraZ9UMtNFOceGVI+BnzPoYn0BPBv5Re7W3dq7+3i92jZrlcW1bSmpNTSdlZUpooYgngEqcfA/GfO53J7wfyPdP+g/8AFAucict3J7wfyPdP+g/8U7nc7uV2tZb52O93uxXFBbe5SrVDUplRSAbLNk8AY5/EB9dBERAREQEREBERAREQEREBERAREQEREBERAREQEREBETK7oAEnAHUk+EDGIoP0mBwSB4n+wYQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEo9p7R2fs9FrXt1bt9spM21WrWp01LeOFZgCeD+BlxOY332PYt9LWlq2nbqN2oowdEYkFT4qykFh8Dxx1EDT/AN8d1f8AnHYP++0/80/3x3V/5x2D/vtP/NM99j/dD/xW5/eJ/wB6H/FDsf7of+K3P7xP+/D/AIoGf++O6v8AzjsH/faf+adzsvafZ+06rWuz9r7PdrgqlytC60qlQKBksVUkkcgZPkJ5n7H+6H/itz+8T/vw/wCKdzsDsDsXs27rf9l7WqW65NNqbVPUZyjYyvUnjkD8BAkAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQ//Z" />
            <h1>Hệ thống Báo cáo Công nợ</h1>
        </header>

        <div class="tabs">
            <div id="tab-btn-khn" class="tab active">Khách Hàng Nợ</div>
            <div id="tab-btn-khtn" class="tab">Khách hàng trả nợ</div>
            <div id="tab-btn-hth" class="tab">Hàng thu hồi</div>
        </div>

        <div id="tab-content-khn" class="tab-content active">
            <div class="table-title">
                <h2>Bảng Khách Hàng Nợ</h2>
                <span id="count-khn" class="record-count">...</span>
            </div>
            <div class="table-container" id="container-khn">
                <p class="status-indicator">Đang tải dữ liệu...</p>
            </div>
        </div>
        
        <div id="tab-content-khtn" class="tab-content">
            <div class="table-title">
                <h2>Bảng Khách hàng trả nợ</h2>
                <span id="count-khtn" class="record-count">...</span>
            </div>
            <div class="table-container" id="container-khtn">
                 <p class="status-indicator">Vui lòng chọn tab để xem</p>
            </div>
        </div>
        
        <div id="tab-content-hth" class="tab-content">
            <div class="table-title">
                <h2>Bảng Hàng thu hồi</h2>
                <span id="count-hth" class="record-count">...</span>
            </div>
            <div class="table-container" id="container-hth">
                 <p class="status-indicator">Vui lòng chọn tab để xem</p>
            </div>
        </div>
        
        <footer>
            <p>&copy; 2023 - Hệ thống quản lý Tổng kho Hà Hòa</p>
        </footer>
    </div>
    
    <script>
        // ========== CẤU HÌNH ==========
        // !!! THAY THẾ BẰNG URL WEB APP MỚI NHẤT CỦA BẠN !!!
        const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbzJTJ9uaaGXhSpzRwCER5bqJVBHseSQpw9DQNaYahV5N0Z-9Xz-ctvvaOJgtap9c78A/exec'; 
        
        const TABLE_CONFIG = {
            'khn': { name: 'Khách Hàng Nợ', containerId: 'container-khn', countId: 'count-khn', loaded: false },
            'khtn': { name: 'Khách hàng trả nợ', containerId: 'container-khtn', countId: 'count-khtn', loaded: false },
            'hth': { name: 'Hàng thu hồi', containerId: 'container-hth', countId: 'count-hth', loaded: false }
        };

        // ========== HÀM RENDER GIAO DIỆN ==========
        function renderTable(tableKey, data) {
            const config = TABLE_CONFIG[tableKey];
            if (!config) return;

            const container = document.getElementById(config.containerId);
            document.getElementById(config.countId).textContent = `${data.total || 0} bản ghi`;

            if (data.error) {
                container.innerHTML = `<p class="status-indicator error">Lỗi: ${data.error}</p>`;
                return;
            }
            if (data.rows.length === 0) {
                container.innerHTML = '<p class="status-indicator">Không có dữ liệu.</p>';
                return;
            }

            const headers = Object.keys(data.rows[0]);
            const headerHtml = `<thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>`;
            
            const bodyHtml = `<tbody>${data.rows.map(row => 
                `<tr>${headers.map(h => `<td>${row[h] ?? ''}</td>`).join('')}</tr>`
            ).join('')}</tbody>`;

            container.innerHTML = `<table>${headerHtml}${bodyHtml}</table>`;
        }

        // ========== HÀM TẢI DỮ LIỆU BẰNG JSONP ==========
        function loadDataViaJSONP(tableKey) {
            const config = TABLE_CONFIG[tableKey];
            if (!config || config.loaded) return; // Không tải lại nếu đã tải rồi

            const callbackName = `handleData_${tableKey}`;
            
            // Tạo hàm callback toàn cục
            window[callbackName] = function(data) {
                renderTable(tableKey, data);
                config.loaded = true; // Đánh dấu đã tải xong
                // Dọn dẹp
                delete window[callbackName];
                document.getElementById(`jsonp-script-${tableKey}`).remove();
            };

            const script = document.createElement('script');
            script.id = `jsonp-script-${tableKey}`;
            const url = `${API_BASE_URL}?table=${encodeURIComponent(config.name)}&callback=${callbackName}`;
            script.src = url;

            script.onerror = () => {
                 window[callbackName]({ error: "Không thể kết nối tới máy chủ. Vui lòng kiểm tra lại URL hoặc cài đặt CORS." });
            };
            
            document.body.appendChild(script);
        }

        // ========== GÁN SỰ KIỆN VÀ KHỞI CHẠY ==========
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const targetKey = e.currentTarget.id.replace('tab-btn-', '');
                    
                    document.querySelectorAll('.tab, .tab-content').forEach(el => el.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    document.getElementById(`tab-content-${targetKey}`).classList.add('active');
                    
                    // Chỉ tải dữ liệu khi người dùng click vào tab lần đầu tiên
                    loadDataViaJSONP(targetKey);
                });
            });

            // Tải dữ liệu cho tab mặc định
            loadDataViaJSONP('khn');
        });

    </script>

</body>
</html>

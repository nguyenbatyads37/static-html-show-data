<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công Nợ Khách Hàng Nhà Phân Phối Hà Hoà | Tổng kho Hà Hòa</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4CAF50; --secondary-color: #ff9800; --hover-color: #45a049; --text-color: #333;
            --border-color: #e0e0e0; --error-color: #d32f2f; --input-bg: #fffbe6;
            --filter-btn-bg: #f0f0f0; --filter-btn-hover-bg: #e0e0e0; --filter-btn-active-bg: #4CAF50;
            --summary-color: #1D6F42;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; }
        body { background-color: #f4f7f6; line-height: 1.6; }
        .container { max-width: 1600px; margin: 20px auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        header { text-align: center; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 2px solid var(--primary-color); }
        header img { height: 120px; width: 120px; object-fit: cover; margin-bottom: 15px; border-radius: 50%; box-shadow: 0 4px 8px rgba(0,0,0,0.15); border: 3px solid var(--primary-color); }
        header h1 { color: var(--primary-color); font-size: 28px; }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; padding: 20px; background-color: #f9f9f9; border-radius: 8px; border: 1px solid var(--border-color); }
        .dashboard-card { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); border-left: 5px solid var(--primary-color); transition: transform 0.2s, box-shadow 0.2s; }
        .dashboard-card.summary { border-left-color: var(--summary-color); }
        .dashboard-card.summary p { color: var(--summary-color); }
        .dashboard-card:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .dashboard-card h3 { font-size: 16px; color: #555; margin-bottom: 10px; font-weight: 500; }
        .dashboard-card p { font-size: 24px; font-weight: 700; color: var(--primary-color); }
        .tabs { display: flex; flex-wrap: wrap; border-bottom: 1px solid var(--border-color); margin-bottom: 25px; }
        .tab { padding: 12px 25px; cursor: pointer; background-color: #f5f5f5; border: 1px solid var(--border-color); border-bottom: none; margin-right: 5px; border-radius: 5px 5px 0 0; font-weight: 500; transition: background-color 0.3s, color 0.3s; }
        .tab.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        #tab-btn-tonghop.active { background-color: var(--secondary-color); border-color: var(--secondary-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { padding: 12px 15px; text-align: center; border: 1px solid var(--border-color); white-space: nowrap; vertical-align: middle; }
        th { background-color: var(--primary-color); color: white; position: sticky; top: 0; z-index: 10; }
        #container-tonghop th { background-color: var(--secondary-color); }
        tbody tr:nth-child(even) { background-color: #f9f9f9; }
        tbody tr:hover { background-color: #e8f5e9; }
        .input-row { background-color: var(--input-bg) !important; font-weight: bold; }
        .input-row td { padding: 8px; vertical-align: middle;}
        .input-row input, .input-row select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; font-weight: bold; }
        .input-row input::placeholder { font-weight: normal; color: #999; }
        .input-row input:focus, .input-row select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2); outline: none; }
        .input-row input:read-only { background-color: #f0f0f0; cursor: not-allowed; }
        .status-indicator { text-align: center; padding: 20px; font-size: 16px; color: #777; font-style: italic; }
        .status-indicator.error { color: var(--error-color); font-weight: 500; }
        .table-title { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 15px; }
        .table-title h2 { color: #333; }
        .table-title .controls-wrapper { display: flex; align-items: center; gap: 15px; }
        .table-title .record-count { font-size: 14px; color: #555; background-color: #e0e0e0; padding: 4px 10px; border-radius: 12px; font-weight: 500; }
        footer { text-align: center; margin-top: 30px; color: #888; font-size: 13px; }
        .delete-btn { cursor: pointer; color: var(--error-color); font-weight: bold; font-size: 1.4em; line-height: 1; }
        .delete-btn:hover { color: #a02020; }
        .filter-controls { display: flex; gap: 20px; flex-wrap: wrap; margin-top: 10px; align-items: center; }
        .date-filters { display: flex; gap: 8px; flex-wrap: wrap; }
        .filter-btn { padding: 6px 12px; font-size: 13px; font-weight: 500; border: 1px solid var(--border-color); border-radius: 15px; cursor: pointer; background-color: var(--filter-btn-bg); transition: all 0.3s ease; }
        .filter-btn:hover { background-color: var(--filter-btn-hover-bg); }
        .filter-btn.active { background-color: var(--filter-btn-active-bg); color: white; border-color: var(--hover-color); }
        .sales-rep-filter-container select { padding: 6px 10px; border-radius: 15px; border: 1px solid var(--border-color); font-size: 13px; font-weight: 500; background-color: #fff; }
        .table-header-controls { display: flex; flex-direction: column; }
        .filter-row th { background-color: #f2f2f2; padding: 5px; }
        .filter-row input { width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px; }
        .export-btn { background-color: #1D6F42; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: 500; display: inline-flex; align-items: center; gap: 8px; transition: background-color: 0.3s; }
        .export-btn:hover { background-color: #165934; }
        .export-btn i { font-size: 16px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <img alt="Logo" src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Ff6c823b5.%E1%BA%A2nh.094646.jpg" />
            <h1>Công Nợ Khách Hàng Nhà Phân Phối Hà Hoà</h1>
        </header>
        <div class="dashboard">
            <div class="dashboard-card"><h3>Tổng Tiền Nợ</h3><p id="dashboard-total-no">0</p></div>
            <div class="dashboard-card"><h3>Tổng Tiền Đã Trả</h3><p id="dashboard-total-tra">0</p></div>
            <div class="dashboard-card"><h3>Giá Trị Hàng Thu Hồi</h3><p id="dashboard-total-thuhoi">0</p></div>
            <div class="dashboard-card summary"><h3>Tổng Công Nợ Cuối Cùng</h3><p id="dashboard-total-conlai">0</p></div>
        </div>
        <div class="tabs">
            <div id="tab-btn-tonghop" class="tab">Tổng hợp</div>
            <div id="tab-btn-khn" class="tab active">Khách Hàng Nợ</div>
            <div id="tab-btn-khtn" class="tab">Khách hàng trả nợ</div>
            <div id="tab-btn-hth" class="tab">Hàng thu hồi</div>
        </div>
        <div id="tab-content-tonghop" class="tab-content">
            <div class="table-header-controls">
                <div class="table-title">
                    <h2>Bảng Tổng Hợp Công Nợ</h2>
                    <div class="controls-wrapper"><span id="count-tonghop" class="record-count">...</span><button class="export-btn"><i class="fas fa-file-excel"></i> Tải Excel</button></div>
                </div>
                <div class="filter-controls" id="filters-tonghop"></div>
            </div>
            <div class="table-container" id="container-tonghop"><p class="status-indicator">Vui lòng chọn tab để xem</p></div>
        </div>
        <div id="tab-content-khn" class="tab-content active">
            <div class="table-header-controls">
                <div class="table-title">
                    <h2>Bảng Khách Hàng Nợ</h2>
                    <div class="controls-wrapper"><span id="count-khn" class="record-count">...</span><button class="export-btn"><i class="fas fa-file-excel"></i> Tải Excel</button></div>
                </div>
                <div class="filter-controls" id="filters-khn"></div>
            </div>
            <div class="table-container" id="container-khn"><p class="status-indicator">Đang tải dữ liệu...</p></div>
        </div>
        <div id="tab-content-khtn" class="tab-content">
            <div class="table-header-controls">
                <div class="table-title">
                    <h2>Bảng Khách hàng trả nợ</h2>
                    <div class="controls-wrapper"><span id="count-khtn" class="record-count">...</span><button class="export-btn"><i class="fas fa-file-excel"></i> Tải Excel</button></div>
                </div>
                <div class="filter-controls" id="filters-khtn"></div>
            </div>
            <div class="table-container" id="container-khtn"><p class="status-indicator">Vui lòng chọn tab để xem</p></div>
        </div>
        <div id="tab-content-hth" class="tab-content">
             <div class="table-header-controls">
                <div class="table-title">
                    <h2>Bảng Hàng thu hồi</h2>
                    <div class="controls-wrapper"><span id="count-hth" class="record-count">...</span><button class="export-btn"><i class="fas fa-file-excel"></i> Tải Excel</button></div>
                </div>
                <div class="filter-controls" id="filters-hth"></div>
            </div>
            <div class="table-container" id="container-hth"><p class="status-indicator">Vui lòng chọn tab để xem</p></div>
        </div>
        <footer><p>&copy; 2023 - Hệ thống quản lý Tổng kho Hà Hòa</p></footer>
    </div>
    
    <script>
        // *** ĐÃ THAY LINK SCRIPT CỦA BẠN ***
        const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbz8ORpJUsqitXINUJEJPPoX7u7UMDOvi3yFYCHSPUbjDfxUNDA_sDfIDt1ltGZsEU04/exec'; 
        
        const TABLE_CONFIG = {
            'khn': { name: 'Khách Hàng Nợ', containerId: 'container-khn', countId: 'count-khn', loaded: false, totalField: 'Số tiền nợ', dashboardId: 'dashboard-total-no' },
            'khtn': { name: 'Khách hàng trả nợ', containerId: 'container-khtn', countId: 'count-khtn', loaded: false, totalField: 'Số tiền nợ', dashboardId: 'dashboard-total-tra' },
            'hth': { name: 'Hàng thu hồi', containerId: 'container-hth', countId: 'count-hth', loaded: false, totalField: 'Thành tiền', dashboardId: 'dashboard-total-thuhoi' },
            'tonghop': { name: 'Tổng hợp', containerId: 'container-tonghop', countId: 'count-tonghop', loaded: false }
        };

        const headerMapping = { 'Giao hàng cho nợ': 'NV Giao hàng cho nợ', 'Người chịu trách nhiệm': 'NV Kinh doanh' };
        
        const HIDDEN_COLUMNS = ['ID'];
        let originalTableData = {};
        let filteredTableData = {};
        
        let filterState = { dateFilter: 'all', salesRepFilter: 'all', columnFilters: {} };
        let filterTimeout;

        function updateDashboard() {
            let totalNo = 0, totalTra = 0, totalThuHoi = 0;
            ['khn', 'khtn', 'hth'].forEach(key => {
                const config = TABLE_CONFIG[key];
                const data = filteredTableData[key] || originalTableData[key];
                let total = 0;
                if (data && data.rows) {
                    total = data.rows.reduce((sum, row) => sum + (parseFloat(row[config.totalField]) || 0), 0);
                    document.getElementById(config.dashboardId).textContent = total.toLocaleString('vi-VN') + ' VNĐ';
                }
                if (key === 'khn') totalNo = total;
                if (key === 'khtn') totalTra = total;
                if (key === 'hth') totalThuHoi = total;
            });
            const totalConLai = totalNo - totalTra - totalThuHoi;
            document.getElementById('dashboard-total-conlai').textContent = totalConLai.toLocaleString('vi-VN') + ' VNĐ';
        }
        
        function renderFilterControls(tableKey) {
            const filterContainer = document.getElementById(`filters-${tableKey}`);
            if (!filterContainer) return;
            const dateFilters = [ { label: 'Tất cả', type: 'all' }, { label: 'Hôm nay', type: 'today' }, { label: 'Hôm qua', type: 'yesterday' }, { label: 'Tuần này', type: 'this_week' }, { label: 'Tuần trước', type: 'last_week' }, { label: 'Tháng này', type: 'this_month' }, { label: 'Tháng trước', type: 'last_month' }, ];
            filterContainer.innerHTML = `<div class="date-filters">${dateFilters.map(f =>  `<button class="filter-btn ${f.type === 'all' ? 'active' : ''}" data-filter="${f.type}">${f.label}</button>` ).join('')}</div><div class="sales-rep-filter-container" id="sales-rep-filters-${tableKey}"></div>`;
            filterContainer.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    filterState.dateFilter = btn.dataset.filter;
                    filterContainer.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    Object.keys(TABLE_CONFIG).forEach(key => applyAllFilters(key));
                });
            });
        }
        
        function renderSalesRepFilter(tableKey) {
            const container = document.getElementById(`sales-rep-filters-${tableKey}`);
            const data = originalTableData[tableKey];
            if (!container || !data || !data.rows) return;
            const salesRepHeader = 'Người chịu trách nhiệm';
            if (!data.headers.includes(salesRepHeader)) return;
            const salesReps = [...new Set(data.rows.map(row => row[salesRepHeader]).filter(Boolean))].sort();
            container.innerHTML = `<select id="sales-rep-select-${tableKey}"><option value="all">Tất cả NV Kinh Doanh</option>${salesReps.map(name => `<option value="${name}">${name}</option>`).join('')}</select>`;
            const select = document.getElementById(`sales-rep-select-${tableKey}`);
            select.value = filterState.salesRepFilter;
            select.addEventListener('change', (e) => {
                filterState.salesRepFilter = e.target.value;
                applyAllFilters(tableKey);
            });
        }

        function getFilterDateRange(filterType) {
            const now = new Date(); const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()); let startDate, endDate;
            switch (filterType) {
                case 'today': startDate = today; endDate = new Date(today); endDate.setDate(endDate.getDate() + 1); break;
                case 'yesterday': startDate = new Date(today); startDate.setDate(startDate.getDate() - 1); endDate = today; break;
                case 'this_week': const day = today.getDay(); startDate = new Date(today.getFullYear(), today.getMonth(), today.getDate() - day + (day === 0 ? -6 : 1)); endDate = new Date(startDate); endDate.setDate(endDate.getDate() + 7); break;
                case 'last_week': startDate = new Date(today.getFullYear(), today.getMonth(), today.getDate() - today.getDay() - 6); endDate = new Date(startDate); endDate.setDate(endDate.getDate() + 7); break;
                case 'this_month': startDate = new Date(today.getFullYear(), today.getMonth(), 1); endDate = new Date(today.getFullYear(), today.getMonth() + 1, 1); break;
                case 'last_month': startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1); endDate = new Date(today.getFullYear(), today.getMonth(), 1); break;
                default: return null;
            }
            return { startDate, endDate };
        }

        function applyAllFilters(tableKey) {
            if (tableKey === 'tonghop') { calculateAndRenderCombinedData(filterState.dateFilter); return; }
            const originalData = originalTableData[tableKey];
            if (!originalData || !originalData.rows) return;
            let filteredRows = [...originalData.rows];
            const dateRange = getFilterDateRange(filterState.dateFilter);
            if (dateRange) {
                const dateColumn = originalData.headers.find(h => h.toLowerCase().includes('ngày')) || null;
                if (dateColumn) {
                    filteredRows = filteredRows.filter(row => {
                        if (!row[dateColumn]) return false;
                        try { const rowDate = new Date(row[dateColumn]); return rowDate >= dateRange.startDate && rowDate < dateRange.endDate; } catch (e) { return false; }
                    });
                }
            }
            if (filterState.salesRepFilter !== 'all') {
                const salesRepHeader = 'Người chịu trách nhiệm';
                filteredRows = filteredRows.filter(row => row[salesRepHeader] === filterState.salesRepFilter);
            }
            const currentColumnFilters = filterState.columnFilters[tableKey] || {};
            Object.entries(currentColumnFilters).forEach(([header, value]) => {
                if (value) {
                    const lowerCaseValue = value.toLowerCase();
                    filteredRows = filteredRows.filter(row => row[header] != null && String(row[header]).toLowerCase().includes(lowerCaseValue));
                }
            });
            filteredTableData[tableKey] = { ...originalData, rows: filteredRows, total: filteredRows.length };
            renderTable(tableKey, filteredTableData[tableKey], true);
            updateDashboard();
        }

        function calculateAndRenderCombinedData(filterType) {
            const customerData = {}; const dateRange = getFilterDateRange(filterType);
            const isRowInDateRange = (row, dateColumnName) => {
                if (!dateRange || !dateColumnName) return true;
                if (!row[dateColumnName]) return false;
                try { const rowDate = new Date(row[dateColumnName]); return rowDate >= dateRange.startDate && rowDate < dateRange.endDate; } catch (e) { return false; }
            };
            const processData = (key, valueField) => {
                if (originalTableData[key]?.rows) {
                    const dateCol = originalTableData[key].headers.find(h => h.toLowerCase().includes('ngày'));
                    originalTableData[key].rows.forEach(row => {
                        if (isRowInDateRange(row, dateCol)) {
                            const maKH = row['Mã KH'] || 'KH_LE';
                            if (!customerData[maKH]) { customerData[maKH] = { maKH, tenKH: row['Tên KH'], tongNo: 0, daTra: 0, thuHoi: 0, conLai: 0 }; }
                            customerData[maKH][valueField] += parseFloat(row[TABLE_CONFIG[key].totalField]) || 0;
                        }
                    });
                }
            };
            processData('khn', 'tongNo'); processData('khtn', 'daTra'); processData('hth', 'thuHoi');
            Object.values(customerData).forEach(c => { c.conLai = c.tongNo - c.daTra - c.thuHoi; });
            renderCombinedTable(customerData);
        }

        function renderCombinedTable(customerData) {
            const container = document.getElementById('container-tonghop'); const sortedData = Object.values(customerData).sort((a, b) => a.tenKH.localeCompare(b.tenKH));
            document.getElementById('count-tonghop').textContent = `${sortedData.length} khách hàng`;
            const headers = ['Mã KH', 'Tên Khách Hàng', 'Tổng Nợ', 'Đã Trả', 'Hàng Thu Hồi', 'Công Nợ Cuối Cùng'];
            const headerHtml = `<thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>`;
            const bodyHtml = `<tbody>${sortedData.map(c => `<tr><td>${c.maKH}</td><td style="text-align: left;">${c.tenKH}</td><td>${c.tongNo.toLocaleString('vi-VN')}</td><td>${c.daTra.toLocaleString('vi-VN')}</td><td>${c.thuHoi.toLocaleString('vi-VN')}</td><td><b>${c.conLai.toLocaleString('vi-VN')} VNĐ</b></td></tr>`).join('')}</tbody>`;
            container.innerHTML = `<table>${headerHtml}${bodyHtml}</table>`;
        }

        function formatCellData(value, header) {
            if (typeof value === 'string' && (value.includes('T') && value.endsWith('Z'))) { try { return new Date(value).toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' }); } catch (e) { return value; } }
            if (typeof value === 'number' && (header.toLowerCase().includes('tiền') || header.toLowerCase().includes('đơn giá'))) { return value.toLocaleString('vi-VN') + ' VNĐ'; }
            return value ?? '';
        }

        async function deleteRow(buttonEl) {
            const tableKey = buttonEl.dataset.tableKey;
            const rowId = buttonEl.dataset.id;
            const config = TABLE_CONFIG[tableKey];
            if (!rowId || !config) return alert('Lỗi: Không tìm thấy thông tin để xóa.');

            if (confirm('Bạn có chắc chắn muốn xóa dòng này không?')) {
                const rowEl = buttonEl.closest('tr');
                rowEl.style.opacity = '0.5';
                try {
                    const response = await fetch(API_BASE_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({ action: 'deleteRow', table: config.name, id: rowId })
                    });
                    const result = await response.json();
                    if (result.success) {
                        TABLE_CONFIG[tableKey].loaded = false;
                        loadDataViaJSONP(tableKey);
                    } else {
                        alert('Xóa thất bại: ' + (result.message || 'Lỗi không xác định.'));
                        rowEl.style.opacity = '1';
                    }
                } catch (error) {
                    alert('Lỗi kết nối khi xóa: ' + error.message);
                    rowEl.style.opacity = '1';
                }
            }
        }
        
        async function submitNewRow(tableKey) {
            const config = TABLE_CONFIG[tableKey];
            const inputRow = document.getElementById(`input-row-${tableKey}`);
            if (!config || !inputRow) return;

            const rowData = {};
            inputRow.querySelectorAll('input, select').forEach(input => {
                const originalHeader = input.dataset.field;
                if (originalHeader) {
                     rowData[originalHeader] = ['Số tiền nợ', 'Đơn giá', 'Thành tiền'].includes(originalHeader) 
                        ? input.value.replace(/\./g, '') 
                        : input.value;
                }
            });
            
            if (!Object.values(rowData).some(v => String(v).trim())) return alert('Vui lòng nhập ít nhất một trường.');
            const dataToSend = { ...rowData, ID: crypto.randomUUID() };
            inputRow.querySelectorAll('input, select').forEach(input => input.disabled = true);

            try {
                const response = await fetch(API_BASE_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action: 'addRow', table: config.name, data: dataToSend })
                });
                const result = await response.json();
                if (result.success) {
                    TABLE_CONFIG[tableKey].loaded = false;
                    loadDataViaJSONP(tableKey);
                } else {
                    alert('Thêm dữ liệu thất bại: ' + (result.message || 'Lỗi không xác định.'));
                }
            } catch (error) {
                alert('Lỗi kết nối khi thêm dữ liệu: ' + error.message);
            } finally {
                inputRow.querySelectorAll('input, select').forEach(input => input.disabled = false);
            }
        }

        function setupCurrencyInput(input) { if (!input) return; input.addEventListener('input', function() { const rawValue = this.value.replace(/\./g, ''); this.value = isNaN(rawValue) || rawValue.trim() === '' ? '' : Number(rawValue).toLocaleString('vi-VN'); }); }
        
        function calculateDueDate(tableKey) {
            const inputRow = document.getElementById(`input-row-${tableKey}`); if (!inputRow) return;
            const ngayNoInput = inputRow.querySelector('input[data-field="Ngày nợ"]'); const hanTraNoInput = inputRow.querySelector('input[data-field="Hạn trả nợ"]'); const ngayPhaiTraInput = inputRow.querySelector('input[data-field="Ngày phải trả"]');
            if (ngayNoInput && hanTraNoInput && ngayPhaiTraInput) {
                const startDate = ngayNoInput.value; const days = parseInt(hanTraNoInput.value, 10);
                if (startDate && !isNaN(days) && days > 0) { const resultDate = new Date(startDate); resultDate.setDate(resultDate.getDate() + days); ngayPhaiTraInput.value = resultDate.toISOString().slice(0, 10); } else { ngayPhaiTraInput.value = ''; }
            }
        }

        function renderTable(tableKey, data, shouldCreateInputRow = true) {
            const config = TABLE_CONFIG[tableKey]; if (!config) return;
            const container = document.getElementById(config.containerId);
            document.getElementById(config.countId).textContent = `${data.total || 0} bản ghi`;
            if (data.error) { container.innerHTML = `<p class="status-indicator error">Lỗi: ${data.error}</p>`; return; }
            if (!data.rows || !data.headers) { container.innerHTML = '<p class="status-indicator">Không có dữ liệu.</p>'; return; }

            const headers = data.headers || [];
            const headerHtml = `<thead><tr><th style="width: 50px;">Xóa</th>${headers.map(h => `<th style="${HIDDEN_COLUMNS.includes(h) ? 'display: none;' : ''}">${headerMapping[h] || h}</th>`).join('')}</tr><tr class="filter-row" id="filter-row-${tableKey}"><th></th>${headers.map(h => `<th style="${HIDDEN_COLUMNS.includes(h) ? 'display: none;' : ''}"><input type="text" placeholder="Lọc..." data-header="${h}"></th>`).join('')}</tr></thead>`;
            
            let inputRowHtml = '';
            if (shouldCreateInputRow) {
                 inputRowHtml = `<tr id="input-row-${tableKey}" class="input-row"><td></td>${headers.map(h => {
                        const style = HIDDEN_COLUMNS.includes(h) ? 'style="display: none;"' : ''; let fieldHtml; const displayedHeader = headerMapping[h] || h;
                        switch (h) {
                            case 'ID': fieldHtml = `<input type="hidden" data-field="${h}">`; break;
                            case 'Ngày nợ': case 'Ngày trả': case 'Ngày thu hồi': fieldHtml = `<input type="date" data-field="${h}">`; break;
                            case 'Số tiền nợ': case 'Đơn giá': case 'Thành tiền': fieldHtml = `<input type="text" inputmode="decimal" placeholder="0" data-field="${h}">`; break;
                            case 'Hạn trả nợ': fieldHtml = `<input type="number" placeholder="Số ngày" data-field="${h}">`; break;
                            case 'Ngày phải trả': fieldHtml = `<input type="date" readonly data-field="${h}">`; break;
                            default: fieldHtml = `<input type="text" placeholder="${displayedHeader}..." data-field="${h}">`; break;
                        }
                        return `<td ${style}>${fieldHtml}</td>`;
                    }).join('')}</tr>`;
            }
            
            const bodyHtml = `<tbody>${inputRowHtml}${data.rows.map(row => `<tr><td><span class="delete-btn" data-id="${row['ID']}" data-table-key="${tableKey}">&#10006;</span></td>${headers.map(h => `<td style="${HIDDEN_COLUMNS.includes(h) ? 'display: none;' : ''}">${formatCellData(row[h], h)}</td>`).join('')}</tr>`).join('')}</tbody>`;
            container.innerHTML = `<table>${headerHtml}${bodyHtml}</table>`;

            const currentColumnFilters = filterState.columnFilters[tableKey] || {};
            document.querySelectorAll(`#filter-row-${tableKey} input`).forEach(input => {
                const header = input.dataset.header; input.value = currentColumnFilters[header] || '';
                input.addEventListener('input', (e) => {
                    clearTimeout(filterTimeout);
                    filterTimeout = setTimeout(() => {
                        if (!filterState.columnFilters[tableKey]) filterState.columnFilters[tableKey] = {};
                        filterState.columnFilters[tableKey][header] = e.target.value;
                        applyAllFilters(tableKey);
                    }, 300);
                });
            });

            if (shouldCreateInputRow) {
                const inputRow = document.getElementById(`input-row-${tableKey}`);
                ['Số tiền nợ', 'Đơn giá', 'Thành tiền'].forEach(field => setupCurrencyInput(inputRow.querySelector(`input[data-field="${field}"]`)));
                const ngayNoInput = inputRow.querySelector('input[data-field="Ngày nợ"]'); const hanTraNoInput = inputRow.querySelector('input[data-field="Hạn trả nợ"]');
                if (ngayNoInput) ngayNoInput.addEventListener('change', () => calculateDueDate(tableKey));
                if (hanTraNoInput) hanTraNoInput.addEventListener('input', () => calculateDueDate(tableKey));
                inputRow.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); submitNewRow(tableKey); } });
            }
        }

        function loadDataViaJSONP(tableKey, onComplete) {
            const config = TABLE_CONFIG[tableKey]; if (!config || config.loaded) { if (onComplete) onComplete(); return; }
            document.getElementById(config.containerId).innerHTML = `<p class="status-indicator">Đang tải dữ liệu...</p>`;
            const callbackName = `handleData_${tableKey}_${Date.now()}`;
            window[callbackName] = function(data) {
                if(data.rows) originalTableData[tableKey] = data; else originalTableData[tableKey] = { headers: data.headers || [], rows: [], total: 0 };
                if (tableKey !== 'tonghop') { renderFilterControls(tableKey); renderSalesRepFilter(tableKey); applyAllFilters(tableKey); }
                config.loaded = true;
                document.getElementById(`script_${callbackName}`)?.remove();
                delete window[callbackName];
                if (onComplete) onComplete();
            };
            const script = document.createElement('script'); script.id = `script_${callbackName}`;
            script.src = `${API_BASE_URL}?table=${encodeURIComponent(config.name)}&callback=${callbackName}`;
            script.onerror = () => { window[callbackName]({ error: "Không thể kết nối tới máy chủ. Vui lòng kiểm tra lại URL Script và đảm bảo đã triển khai phiên bản mới." }); };
            document.body.appendChild(script);
        }

        function exportToExcel() {
            const activeKey = document.querySelector('.tab.active')?.id.replace('tab-btn-', ''); if (!activeKey) return alert('Không tìm thấy tab đang hoạt động.');
            let dataRows = []; let headers;
            if (activeKey === 'tonghop') {
                const table = document.querySelector('#container-tonghop table'); if (!table) return alert('Không có dữ liệu tổng hợp để xuất.');
                headers = Array.from(table.querySelectorAll('thead th')).map(th => th.innerText.trim()); dataRows = Array.from(table.querySelectorAll('tbody tr')).map(tr => Array.from(tr.querySelectorAll('td')).map(td => td.innerText.trim()));
            } else {
                const data = filteredTableData[activeKey] || originalTableData[activeKey]; if (!data || !data.rows || data.rows.length === 0) return alert('Không có dữ liệu để xuất.');
                headers = data.headers.filter(h => !HIDDEN_COLUMNS.includes(h)).map(h => headerMapping[h] || h); dataRows = data.rows.map(row => data.headers.filter(h => !HIDDEN_COLUMNS.includes(h)).map(h => row[h] ?? ''));
            }
            if (dataRows.length === 0) return alert('Không có dữ liệu để xuất.');
            const escapeCsvCell = (cell) => { let cellString = String(cell ?? '').replace(/\sVNĐ/g, '').replace(/\./g, ''); if (cellString.search(/("|,|\n)/g) >= 0) cellString = '"' + cellString.replace(/"/g, '""') + '"'; return cellString; };
            const csvContent = [headers, ...dataRows].map(row => row.map(escapeCsvCell).join(',')).join('\n');
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement('a'); const url = URL.createObjectURL(blob);
            const filename = `BaoCao_${TABLE_CONFIG[activeKey].name.replace(/\s/g, '_')}_${new Date().toISOString().slice(0, 10)}.csv`;
            link.setAttribute('href', url); link.setAttribute('download', filename); document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const targetKey = e.currentTarget.id.replace('tab-btn-', '');
                    document.querySelectorAll('.tab, .tab-content').forEach(el => el.classList.remove('active'));
                    e.currentTarget.classList.add('active'); document.getElementById(`tab-content-${targetKey}`).classList.add('active');
                    if (targetKey === 'tonghop') {
                        Promise.all([ new Promise(resolve => loadDataViaJSONP('khn', resolve)), new Promise(resolve => loadDataViaJSONP('khtn', resolve)), new Promise(resolve => loadDataViaJSONP('hth', resolve)) ]).then(() => {
                            if (!TABLE_CONFIG.tonghop.loaded) { renderFilterControls('tonghop'); TABLE_CONFIG.tonghop.loaded = true; }
                            applyAllFilters('tonghop');
                        });
                    } else { loadDataViaJSONP(targetKey); }
                });
            });
            document.querySelector('.container').addEventListener('click', (event) => { if (event.target?.classList.contains('delete-btn')) { deleteRow(event.target); } });
            document.querySelectorAll('.export-btn').forEach(button => button.addEventListener('click', exportToExcel));
            loadDataViaJSONP('khn');
        });
    </script>
</body>
</html>

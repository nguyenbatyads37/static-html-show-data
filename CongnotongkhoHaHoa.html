<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Báo Cáo Công Nợ | Tổng kho Hà Hòa</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4CAF50; --secondary-color: #ff9800; --hover-color: #45a049; --text-color: #333;
            --border-color: #e0e0e0; --error-color: #d32f2f; --input-bg: #fffbe6;
            --filter-btn-bg: #f0f0f0; --filter-btn-hover-bg: #e0e0e0; --filter-btn-active-bg: #4CAF50;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; }
        body { background-color: #f4f7f6; line-height: 1.6; }
        .container { max-width: 1600px; margin: 20px auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        header { text-align: center; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 2px solid var(--primary-color); }
        header img { height: 120px; width: 120px; object-fit: cover; margin-bottom: 15px; border-radius: 50%; box-shadow: 0 4px 8px rgba(0,0,0,0.15); border: 3px solid var(--primary-color); }
        header h1 { color: var(--primary-color); font-size: 28px; }

        /* CSS cho Dashboard */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        .dashboard-card {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
            border-left: 5px solid var(--primary-color);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .dashboard-card.summary { border-left-color: var(--secondary-color); }
        .dashboard-card.summary p { color: var(--secondary-color); }
        .dashboard-card:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .dashboard-card h3 { font-size: 16px; color: #555; margin-bottom: 10px; font-weight: 500; }
        .dashboard-card p { font-size: 24px; font-weight: 700; color: var(--primary-color); }

        .tabs { display: flex; flex-wrap: wrap; border-bottom: 1px solid var(--border-color); margin-bottom: 25px; }
        .tab { padding: 12px 25px; cursor: pointer; background-color: #f5f5f5; border: 1px solid var(--border-color); border-bottom: none; margin-right: 5px; border-radius: 5px 5px 0 0; font-weight: 500; transition: background-color 0.3s, color 0.3s; }
        .tab.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        #tab-btn-tonghop.active { background-color: var(--secondary-color); border-color: var(--secondary-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { padding: 12px 15px; text-align: center; border: 1px solid var(--border-color); white-space: nowrap; vertical-align: middle; }
        th { background-color: var(--primary-color); color: white; position: sticky; top: 0; z-index: 10; }
        #container-tonghop th { background-color: var(--secondary-color); }
        tbody tr:nth-child(even) { background-color: #f9f9f9; }
        tbody tr:hover { background-color: #e8f5e9; }
       
        /* UPDATED: In đậm dòng nhập */
        .input-row { background-color: var(--input-bg) !important; font-weight: bold; }
        .input-row td { padding: 8px; vertical-align: middle;}
        .input-row input, .input-row select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; font-weight: bold; }
        .input-row input::placeholder { font-weight: normal; color: #999; }
        .input-row input:focus, .input-row select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2); outline: none; }
        .input-row input:read-only { background-color: #f0f0f0; cursor: not-allowed; }

        .status-indicator { text-align: center; padding: 20px; font-size: 16px; color: #777; font-style: italic; }
        .status-indicator.error { color: var(--error-color); font-weight: 500; }
        .table-title { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 15px; }
        .table-title h2 { color: #333; }
        .table-title .controls-wrapper { display: flex; align-items: center; gap: 15px; }
        .table-title .record-count { font-size: 14px; color: #555; background-color: #e0e0e0; padding: 4px 10px; border-radius: 12px; font-weight: 500; }
        footer { text-align: center; margin-top: 30px; color: #888; font-size: 13px; }
        .delete-btn { cursor: pointer; color: var(--error-color); font-weight: bold; font-size: 1.4em; line-height: 1; }
        .delete-btn:hover { color: #a02020; }
        .filters { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
        .filter-btn { padding: 6px 12px; font-size: 13px; font-weight: 500; border: 1px solid var(--border-color); border-radius: 15px; cursor: pointer; background-color: var(--filter-btn-bg); transition: all 0.3s ease; }
        .filter-btn:hover { background-color: var(--filter-btn-hover-bg); }
        .filter-btn.active { background-color: var(--filter-btn-active-bg); color: white; border-color: var(--hover-color); }
        .table-header-controls { display: flex; flex-direction: column; }
        
        /* CSS cho nút Tải Excel */
        .export-btn {
            background-color: #1D6F42;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.3s;
        }
        .export-btn:hover { background-color: #165934; }
        .export-btn i { font-size: 16px; }

    </style>
</head>
<body>
    <div class="container">
        <header>
            <img alt="Logo" src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Ff6c823b5.%E1%BA%A2nh.094646.jpg" />
            <h1>Hệ thống Báo cáo Công nợ</h1>
        </header>

        <!-- Bảng điều khiển (Dashboard) -->
        <div class="dashboard">
            <div class="dashboard-card">
                <h3>Tổng Tiền Nợ (Đang lọc)</h3>
                <p id="dashboard-total-no">0</p>
            </div>
            <div class="dashboard-card">
                <h3>Tổng Tiền Đã Trả (Đang lọc)</h3>
                <p id="dashboard-total-tra">0</p>
            </div>
            <div class="dashboard-card">
                <h3>Giá Trị Hàng Thu Hồi (Đang lọc)</h3>
                <p id="dashboard-total-thuhoi">0</p>
            </div>
            <div class="dashboard-card summary">
                <h3>Tổng Công Nợ Cuối Cùng (Đang lọc)</h3>
                <p id="dashboard-total-conlai">0</p>
            </div>
        </div>

        <div class="tabs">
            <div id="tab-btn-tonghop" class="tab">Tổng hợp</div>
            <div id="tab-btn-khn" class="tab active">Khách Hàng Nợ</div>
            <div id="tab-btn-khtn" class="tab">Khách hàng trả nợ</div>
            <div id="tab-btn-hth" class="tab">Hàng thu hồi</div>
        </div>
        
        <!-- Tab Tổng hợp -->
        <div id="tab-content-tonghop" class="tab-content">
            <div class="table-header-controls">
                <div class="table-title">
                    <h2>Bảng Tổng Hợp Công Nợ</h2>
                    <div class="controls-wrapper">
                        <span id="count-tonghop" class="record-count">...</span>
                        <button class="export-btn"><i class="fas fa-file-excel"></i> Tải Excel</button>
                    </div>
                </div>
                <div class="filters" id="filters-tonghop"></div>
            </div>
            <div class="table-container" id="container-tonghop"><p class="status-indicator">Vui lòng chọn tab để xem</p></div>
        </div>

        <!-- Tab Khách Hàng Nợ -->
        <div id="tab-content-khn" class="tab-content active">
            <div class="table-header-controls">
                <div class="table-title">
                    <h2>Bảng Khách Hàng Nợ</h2>
                    <div class="controls-wrapper">
                        <span id="count-khn" class="record-count">...</span>
                        <button class="export-btn"><i class="fas fa-file-excel"></i> Tải Excel</button>
                    </div>
                </div>
                <div class="filters" id="filters-khn"></div>
            </div>
            <div class="table-container" id="container-khn"><p class="status-indicator">Đang tải dữ liệu...</p></div>
        </div>
        
        <!-- Tab Khách hàng trả nợ -->
        <div id="tab-content-khtn" class="tab-content">
            <div class="table-header-controls">
                <div class="table-title">
                    <h2>Bảng Khách hàng trả nợ</h2>
                    <div class="controls-wrapper">
                        <span id="count-khtn" class="record-count">...</span>
                        <button class="export-btn"><i class="fas fa-file-excel"></i> Tải Excel</button>
                    </div>
                </div>
                <div class="filters" id="filters-khtn"></div>
            </div>
            <div class="table-container" id="container-khtn"><p class="status-indicator">Vui lòng chọn tab để xem</p></div>
        </div>
        
        <!-- Tab Hàng thu hồi -->
        <div id="tab-content-hth" class="tab-content">
             <div class="table-header-controls">
                <div class="table-title">
                    <h2>Bảng Hàng thu hồi</h2>
                    <div class="controls-wrapper">
                        <span id="count-hth" class="record-count">...</span>
                        <button class="export-btn"><i class="fas fa-file-excel"></i> Tải Excel</button>
                    </div>
                </div>
                <div class="filters" id="filters-hth"></div>
            </div>
            <div class="table-container" id="container-hth"><p class="status-indicator">Vui lòng chọn tab để xem</p></div>
        </div>
        
        <footer><p>&copy; 2023 - Hệ thống quản lý Tổng kho Hà Hòa</p></footer>
    </div>
    
    <script>
        const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbwueKpfmNJZ9eq-3JELQqbRoHxG0pKF0Cz8FjTjQ9RgHuqjjm6YMlMo7-KI5IMvUTRv/exec'; 
        
        const TABLE_CONFIG = {
            'khn': { name: 'Khách Hàng Nợ', containerId: 'container-khn', countId: 'count-khn', loaded: false, totalField: 'Số tiền nợ', dashboardId: 'dashboard-total-no' },
            'khtn': { name: 'Khách hàng trả nợ', containerId: 'container-khtn', countId: 'count-khtn', loaded: false, totalField: 'Số tiền nợ', dashboardId: 'dashboard-total-tra' },
            'hth': { name: 'Hàng thu hồi', containerId: 'container-hth', countId: 'count-hth', loaded: false, totalField: 'Thành tiền', dashboardId: 'dashboard-total-thuhoi' },
            'tonghop': { name: 'Tổng hợp', containerId: 'container-tonghop', countId: 'count-tonghop', loaded: false }
        };

        const headerMapping = {
            'Giao hàng cho nợ': 'NV Giao hàng cho nợ',
            'Người chịu trách nhiệm': 'NV Kinh doanh'
        };
        const reverseHeaderMapping = {
            'NV Giao hàng cho nợ': 'Giao hàng cho nợ',
            'NV Kinh doanh': 'Người chịu trách nhiệm'
        };
        
        const HIDDEN_COLUMNS = ['ID'];
        let originalTableData = {};
        let filteredTableData = {};
        let activeFilterType = 'all';

        // --- HÀM XỬ LÝ DASHBOARD ---
        function updateDashboard() {
            let totalNo = 0, totalTra = 0, totalThuHoi = 0;

            ['khn', 'khtn', 'hth'].forEach(key => {
                const config = TABLE_CONFIG[key];
                const data = filteredTableData[key] || originalTableData[key];
                const dashboardEl = document.getElementById(config.dashboardId);
                let total = 0;
                
                if (data && data.rows && dashboardEl) {
                    total = data.rows.reduce((sum, row) => {
                        const value = parseFloat(row[config.totalField]) || 0;
                        return sum + value;
                    }, 0);
                    // UPDATED: Thêm VNĐ
                    dashboardEl.textContent = total.toLocaleString('vi-VN') + ' VNĐ';
                } else if (dashboardEl) {
                    dashboardEl.textContent = '0 VNĐ';
                }

                if (key === 'khn') totalNo = total;
                if (key === 'khtn') totalTra = total;
                if (key === 'hth') totalThuHoi = total;
            });
            
            const totalConLai = totalNo - totalTra - totalThuHoi;
             // UPDATED: Thêm VNĐ
            document.getElementById('dashboard-total-conlai').textContent = totalConLai.toLocaleString('vi-VN') + ' VNĐ';
        }
        
        // --- CÁC HÀM XỬ LÝ BỘ LỌC NGÀY ---
        
        function renderFilterButtons(tableKey) {
            const filterContainer = document.getElementById(`filters-${tableKey}`);
            if (!filterContainer) return;
            
            const filters = [
                { label: 'Tất cả', type: 'all' }, { label: 'Hôm nay', type: 'today' }, { label: 'Hôm qua', type: 'yesterday' },
                { label: 'Tuần này', type: 'this_week' }, { label: 'Tuần trước', type: 'last_week' },
                { label: 'Tháng này', type: 'this_month' }, { label: 'Tháng trước', type: 'last_month' },
            ];

            filterContainer.innerHTML = filters.map(f => 
                `<button class="filter-btn ${f.type === 'all' ? 'active' : ''}" data-filter="${f.type}">${f.label}</button>`
            ).join('');

            filterContainer.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    activeFilterType = btn.dataset.filter;
                    Object.keys(TABLE_CONFIG).forEach(key => applyFilter(key, activeFilterType));
                    document.querySelectorAll('.filter-btn').forEach(b => {
                        b.classList.toggle('active', b.dataset.filter === activeFilterType);
                    });
                });
            });
        }
        
        function getFilterDateRange(filterType) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            let startDate, endDate;

            switch (filterType) {
                case 'today':
                    startDate = today;
                    endDate = new Date(today); endDate.setDate(endDate.getDate() + 1);
                    break;
                case 'yesterday':
                    startDate = new Date(today); startDate.setDate(startDate.getDate() - 1);
                    endDate = today;
                    break;
                case 'this_week':
                    const dayOfWeek = today.getDay();
                    const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
                    startDate = new Date(today.getFullYear(), today.getMonth(), diff);
                    endDate = new Date(startDate); endDate.setDate(endDate.getDate() + 7);
                    break;
                case 'last_week':
                    startDate = new Date(today.getFullYear(), today.getMonth(), today.getDate() - today.getDay() - 6);
                    endDate = new Date(startDate); endDate.setDate(endDate.getDate() + 7);
                    break;
                case 'this_month':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 1);
                    break;
                case 'last_month':
                    startDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    endDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    break;
                default: return null;
            }
            return { startDate, endDate };
        }

        function applyFilter(tableKey, filterType) {
             if(tableKey === 'tonghop') {
                 calculateAndRenderCombinedData(filterType);
                 return;
             }

            const originalData = originalTableData[tableKey];
            if (!originalData) return;

            if (filterType === 'all') {
                filteredTableData[tableKey] = { ...originalData };
                renderTable(tableKey, originalData);
                updateDashboard();
                return;
            }

            const dateRange = getFilterDateRange(filterType);
            if (!dateRange) return;

            const dateColumn = originalData.headers.find(h => h.toLowerCase().includes('ngày')) || null;
            if (!dateColumn) {
                 filteredTableData[tableKey] = { ...originalData };
            } else {
                 const filteredRows = originalData.rows.filter(row => {
                    const cellValue = row[dateColumn];
                    if (!cellValue) return false;
                    try {
                        const rowDate = new Date(cellValue);
                        return rowDate >= dateRange.startDate && rowDate < dateRange.endDate;
                    } catch (e) { return false; }
                });
                
                filteredTableData[tableKey] = { ...originalData, rows: filteredRows, total: filteredRows.length };
            }

            renderTable(tableKey, filteredTableData[tableKey], false);
            updateDashboard();
        }

        // --- BẢNG TỔNG HỢP ---

        function renderCombinedTable(customerData) {
            const container = document.getElementById('container-tonghop');
            const countSpan = document.getElementById('count-tonghop');

            const sortedData = Object.values(customerData).sort((a, b) => a.tenKH.localeCompare(b.tenKH));
            countSpan.textContent = `${sortedData.length} khách hàng`;

            const headers = ['Mã KH', 'Tên Khách Hàng', 'Tổng Nợ', 'Đã Trả', 'Hàng Thu Hồi', 'Công Nợ Cuối Cùng'];
            const headerHtml = `<thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>`;
            
            const bodyHtml = `<tbody>${sortedData.map(c => `
                <tr>
                    <td>${c.maKH}</td>
                    <td style="text-align: left;">${c.tenKH}</td>
                    <td>${c.tongNo.toLocaleString('vi-VN')} VNĐ</td>
                    <td>${c.daTra.toLocaleString('vi-VN')} VNĐ</td>
                    <td>${c.thuHoi.toLocaleString('vi-VN')} VNĐ</td>
                    <td><b>${c.conLai.toLocaleString('vi-VN')} VNĐ</b></td>
                </tr>
            `).join('')}</tbody>`;

            container.innerHTML = `<table>${headerHtml}${bodyHtml}</table>`;
        }

        function calculateAndRenderCombinedData(filterType) {
            const customerData = {}; 
            const dateRange = getFilterDateRange(filterType);

            const isRowInDateRange = (row, dateColumnName) => {
                if (!dateRange || !dateColumnName) return true;
                const dateValue = row[dateColumnName];
                if (!dateValue) return false;
                try {
                    const rowDate = new Date(dateValue);
                    return rowDate >= dateRange.startDate && rowDate < dateRange.endDate;
                } catch (e) { return false; }
            };

            if (originalTableData['khn']?.rows) {
                const dateCol = originalTableData['khn'].headers.find(h => h.toLowerCase().includes('ngày'));
                originalTableData['khn'].rows.forEach(row => {
                    if (isRowInDateRange(row, dateCol)) {
                        const maKH = row['Mã KH'] || 'KH_LE';
                        if (!customerData[maKH]) {
                            customerData[maKH] = { maKH, tenKH: row['Tên KH'], tongNo: 0, daTra: 0, thuHoi: 0, conLai: 0 };
                        }
                        customerData[maKH].tongNo += parseFloat(row['Số tiền nợ']) || 0;
                    }
                });
            }

            if (originalTableData['khtn']?.rows) {
                 const dateCol = originalTableData['khtn'].headers.find(h => h.toLowerCase().includes('ngày'));
                originalTableData['khtn'].rows.forEach(row => {
                     if (isRowInDateRange(row, dateCol)) {
                        const maKH = row['Mã KH'] || 'KH_LE';
                        if (!customerData[maKH]) {
                            customerData[maKH] = { maKH, tenKH: row['Tên KH'], tongNo: 0, daTra: 0, thuHoi: 0, conLai: 0 };
                        }
                        customerData[maKH].daTra += parseFloat(row['Số tiền nợ']) || 0;
                    }
                });
            }

            if (originalTableData['hth']?.rows) {
                 const dateCol = originalTableData['hth'].headers.find(h => h.toLowerCase().includes('ngày'));
                originalTableData['hth'].rows.forEach(row => {
                     if (isRowInDateRange(row, dateCol)) {
                        const maKH = row['Mã KH'] || 'KH_LE';
                        if (!customerData[maKH]) {
                            customerData[maKH] = { maKH, tenKH: row['Tên KH'], tongNo: 0, daTra: 0, thuHoi: 0, conLai: 0 };
                        }
                        customerData[maKH].thuHoi += parseFloat(row['Thành tiền']) || 0;
                    }
                });
            }
            
            Object.keys(customerData).forEach(maKH => {
                const c = customerData[maKH];
                c.conLai = c.tongNo - c.daTra - c.thuHoi;
            });

            renderCombinedTable(customerData);
        }

        // --- CÁC HÀM CỐT LÕI ---
        
        function formatCellData(value, header) {
            if (header === 'Hạn trả nợ' && value && !isNaN(Number(value))) return `${value} Ngày`;
            if (typeof value === 'string' && (value.includes('T') && value.endsWith('Z'))) {
                try {
                    const date = new Date(value);
                    return date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });
                } catch (e) { return value; }
            }
            // UPDATED: Thêm VNĐ vào cuối
            if (typeof value === 'number' && (header.toLowerCase().includes('tiền') || header.toLowerCase().includes('đơn giá'))) {
                return value.toLocaleString('vi-VN') + ' VNĐ';
            }
            return value ?? '';
        }
        
        async function deleteRow(buttonEl) {
            const tableKey = buttonEl.dataset.tableKey;
            const rowId = buttonEl.dataset.id;
            const config = TABLE_CONFIG[tableKey];

            if (!rowId || !config) return alert('Lỗi: Không tìm thấy thông tin để xóa.');

            if (confirm('Bạn có chắc chắn muốn xóa dòng này không?')) {
                const row = buttonEl.closest('tr');
                row.style.opacity = '0.5';

                try {
                    fetch(API_BASE_URL, {
                        method: 'POST', mode: 'no-cors',
                        body: JSON.stringify({ action: 'deleteRow', table: config.name, id: rowId }),
                    });
                    
                    row.remove();
                    
                    originalTableData[tableKey].rows = originalTableData[tableKey].rows.filter(r => r.ID !== rowId);
                    originalTableData[tableKey].total--;
                    if (filteredTableData[tableKey]) {
                        filteredTableData[tableKey].rows = filteredTableData[tableKey].rows.filter(r => r.ID !== rowId);
                        filteredTableData[tableKey].total--;
                    }

                    const countSpan = document.getElementById(config.countId);
                    countSpan.textContent = `${(filteredTableData[tableKey] || originalTableData[tableKey]).total} bản ghi`;
                    updateDashboard();

                } catch (error) {
                    alert('Đã có lỗi xảy ra khi xóa.');
                    row.style.opacity = '1';
                }
            }
        }

        async function submitNewRow(tableKey) {
            const config = TABLE_CONFIG[tableKey];
            const inputRow = document.getElementById(`input-row-${tableKey}`);
            if (!config || !inputRow) return;

            const inputs = Array.from(inputRow.querySelectorAll('input, select'));
            const displayedHeaders = Array.from(document.querySelectorAll(`#${config.containerId} th`)).map(th => th.textContent.trim()).filter(h => h !== 'Xóa');
            const rowData = {};
            
            inputs.forEach(input => {
                const headerIndex = Array.from(input.closest('tr').children).indexOf(input.closest('td')) - 1;
                const displayedHeader = displayedHeaders[headerIndex];
                const originalHeader = reverseHeaderMapping[displayedHeader] || displayedHeader;
                
                if (originalHeader && !HIDDEN_COLUMNS.includes(originalHeader)) {
                    // UPDATED: Loại bỏ dấu chấm trước khi gửi đi
                    if (['Số tiền nợ', 'Đơn giá', 'Thành tiền'].includes(originalHeader)) {
                        rowData[originalHeader] = input.value.replace(/\./g, '');
                    } else {
                        rowData[originalHeader] = input.value;
                    }
                }
            });
            
            if (!Object.values(rowData).some(value => String(value).trim() !== '')) return alert('Vui lòng nhập ít nhất một trường thông tin.');
            
            const dataToSend = { ...rowData, ID: crypto.randomUUID() };
            Object.keys(dataToSend).forEach(h => {
                if (h.toLowerCase().includes('ngày') && dataToSend[h]) {
                    try { dataToSend[h] = new Date(dataToSend[h]).toISOString(); } catch (e) {}
                }
            });
            
            inputRow.querySelectorAll('input, select').forEach(input => input.disabled = true);

            try {
                fetch(API_BASE_URL, {
                    method: 'POST', mode: 'no-cors', 
                    body: JSON.stringify({ action: 'addRow', table: config.name, data: dataToSend }),
                });

                originalTableData[tableKey].rows.unshift(dataToSend);
                originalTableData[tableKey].total++;
                
                applyFilter(tableKey, 'all');
                document.querySelectorAll(`#filters-${tableKey} .filter-btn`).forEach(btn => btn.classList.toggle('active', btn.dataset.filter === 'all'));

                inputRow.querySelectorAll('input:not([type=hidden]):not([readonly])').forEach(input => input.value = '');
                const firstInput = inputRow.querySelector('input:not([type=hidden]):not([readonly])');
                if (firstInput) firstInput.focus();

            } catch (error) {
                alert(`Đã có lỗi xảy ra: ${error.message}`);
            } finally {
                inputRow.querySelectorAll('input, select').forEach(input => input.disabled = false);
            }
        }
        
        function calculateDays(tableKey) {
            const inputRow = document.getElementById(`input-row-${tableKey}`);
            if (!inputRow) return;

            const ngayNoInput = inputRow.querySelector('input[data-field="Ngày nợ"]');
            const ngayPhaiTraInput = inputRow.querySelector('input[data-field="Ngày phải trả"]');
            const hanTraNoInput = inputRow.querySelector('input[data-field="Hạn trả nợ"]');

            if (ngayNoInput && ngayPhaiTraInput && hanTraNoInput) {
                const startDate = new Date(ngayNoInput.value);
                const endDate = new Date(ngayPhaiTraInput.value);
                if (!isNaN(startDate.getTime()) && !isNaN(endDate.getTime()) && endDate >= startDate) {
                    hanTraNoInput.value = Math.ceil(Math.abs(endDate - startDate) / (1000 * 60 * 60 * 24));
                } else { hanTraNoInput.value = ''; }
            }
        }

        // --- NEW: HÀM ĐỂ THIẾT LẬP Ô NHẬP TIỀN TỆ ---
        function setupCurrencyInput(input) {
            if (!input) return;
            
            input.setAttribute('size', (input.placeholder.length || 10) + 2);

            input.addEventListener('input', function(e) {
                const cursorPosition = this.selectionStart;
                const originalLength = this.value.length;
                const rawValue = this.value.replace(/\./g, '');

                if (isNaN(rawValue) || rawValue.trim() === '') {
                    this.value = '';
                    this.size = (this.placeholder.length || 10) + 2;
                    return;
                }

                const formattedValue = Number(rawValue).toLocaleString('vi-VN');
                this.value = formattedValue;
                const newLength = this.value.length;
                const newCursorPosition = cursorPosition + (newLength - originalLength);
                this.setSelectionRange(newCursorPosition, newCursorPosition);
                this.size = this.value.length > 0 ? this.value.length + 1 : (this.placeholder.length || 10) + 2;
            });
        }


        function renderTable(tableKey, data, shouldCreateInputRow = true) {
            const config = TABLE_CONFIG[tableKey];
            if (!config) return;

            const container = document.getElementById(config.containerId);
            document.getElementById(config.countId).textContent = `${data.total || 0} bản ghi`;

            if (data.error) { container.innerHTML = `<p class="status-indicator error">Lỗi: ${data.error}</p>`; return; }
            if (!data.rows && !data.headers) { container.innerHTML = '<p class="status-indicator">Không có dữ liệu.</p>'; return; }

            const headers = data.headers || Object.keys(data.rows[0] || {});
            const headerHtml = `<thead><tr><th style="width: 50px;">Xóa</th>${headers.map(h => `<th style="${HIDDEN_COLUMNS.includes(h) ? 'display: none;' : ''}">${headerMapping[h] || h}</th>`).join('')}</tr></thead>`;
            
            let inputRowHtml = '';
            if (shouldCreateInputRow) {
                 inputRowHtml = `<tr id="input-row-${tableKey}" class="input-row"><td></td>${
                    headers.map(h => {
                        const style = HIDDEN_COLUMNS.includes(h) ? 'style="display: none;"' : '';
                        let fieldHtml;
                        const displayedHeader = headerMapping[h] || h;
                        switch (h) {
                            case 'ID': fieldHtml = `<input type="hidden" data-field="${h}">`; break;
                            case 'Ngày nợ': case 'Ngày trả': case 'Ngày phải trả': case 'Ngày thu hồi':
                                fieldHtml = `<input type="date" data-field="${h}">`; break;
                            // UPDATED: Đổi type="number" thành type="text" để cho phép dấu chấm
                            case 'Số tiền nợ': case 'Đơn giá': case 'Thành tiền':
                                fieldHtml = `<input type="text" inputmode="decimal" placeholder="0" data-field="${h}">`; break;
                            case 'Hạn trả nợ':
                                fieldHtml = `<input type="text" placeholder="Tự động" readonly data-field="${h}">`; break;
                            default: fieldHtml = `<input type="text" placeholder="${displayedHeader}..." data-field="${h}">`; break;
                        }
                        return `<td ${style}>${fieldHtml}</td>`;
                    }).join('')
                }</tr>`;
            }
            
            const bodyHtml = `<tbody>${inputRowHtml}${data.rows.map(row => {
                const deleteButtonHtml = `<td><span class="delete-btn" data-id="${row['ID']}" data-table-key="${tableKey}">&#10006;</span></td>`;
                const cellsHtml = headers.map(h => {
                    const cellContent = formatCellData(row[h], h);
                    return `<td style="${HIDDEN_COLUMNS.includes(h) ? 'display: none;' : ''}">${cellContent}</td>`;
                }).join('');
                return `<tr>${deleteButtonHtml}${cellsHtml}</tr>`;
            }).join('')}</tbody>`;

            container.innerHTML = `<table>${headerHtml}${bodyHtml}</table>`;
            
            if (shouldCreateInputRow) {
                const inputRow = document.getElementById(`input-row-${tableKey}`);
                
                inputRow.querySelectorAll('input[type="text"]').forEach(input => {
                    if (input.readOnly) return;
                    input.addEventListener('input', () => {
                        if (input.value.length > 0) {
                            const start = input.selectionStart;
                            const end = input.selectionEnd;
                            input.value = input.value.charAt(0).toUpperCase() + input.value.slice(1);
                            input.setSelectionRange(start, end);
                        }
                    });
                });
                
                // UPDATED: Gọi hàm thiết lập cho các ô nhập tiền tệ
                const currencyFields = ['Số tiền nợ', 'Đơn giá', 'Thành tiền'];
                currencyFields.forEach(field => {
                    const input = inputRow.querySelector(`input[data-field="${field}"]`);
                    setupCurrencyInput(input);
                });


                const ngayNoInput = inputRow.querySelector('input[data-field="Ngày nợ"]');
                const ngayPhaiTraInput = inputRow.querySelector('input[data-field="Ngày phải trả"]');
                
                if (ngayNoInput) ngayNoInput.addEventListener('change', () => calculateDays(tableKey));
                if (ngayPhaiTraInput) ngayPhaiTraInput.addEventListener('change', () => calculateDays(tableKey));

                inputRow.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter') { event.preventDefault(); submitNewRow(tableKey); }
                });
            }
        }

        function loadDataViaJSONP(tableKey, onComplete) {
            const config = TABLE_CONFIG[tableKey];
            if (!config || config.loaded) {
                if (onComplete) onComplete();
                return;
            }
            document.getElementById(config.containerId).innerHTML = `<p class="status-indicator">Đang tải dữ liệu...</p>`;
            const callbackName = `handleData_${tableKey}`;
            
            window[callbackName] = function(data) {
                originalTableData[tableKey] = data; 
                filteredTableData[tableKey] = { ...data };
                if (tableKey !== 'tonghop') {
                    renderTable(tableKey, data);
                    renderFilterButtons(tableKey); 
                }
                updateDashboard();
                config.loaded = true;
                document.getElementById(`jsonp-script-${tableKey}`)?.remove();
                delete window[callbackName];
                if (onComplete) onComplete();
            };

            const script = document.createElement('script');
            script.id = `jsonp-script-${tableKey}`;
            script.src = `${API_BASE_URL}?table=${encodeURIComponent(config.name)}&callback=${callbackName}`;
            script.onerror = () => { window[callbackName]({ error: "Không thể kết nối tới máy chủ." }); };
            document.body.appendChild(script);
        }

        function exportToExcel() {
            const activeTabEl = document.querySelector('.tab.active');
            if (!activeTabEl) {
                alert('Không tìm thấy tab đang hoạt động để xuất file.');
                return;
            }
            const activeKey = activeTabEl.id.replace('tab-btn-', '');
            
            let dataRows = [];
            let headers;
            
            if (activeKey === 'tonghop') {
                const table = document.querySelector('#container-tonghop table');
                if (!table) {
                    alert('Không có dữ liệu tổng hợp để xuất.');
                    return;
                }
                headers = Array.from(table.querySelectorAll('thead th')).map(th => th.innerText.trim());
                dataRows = Array.from(table.querySelectorAll('tbody tr')).map(tr => 
                    Array.from(tr.querySelectorAll('td')).map(td => td.innerText.trim())
                );
            } else {
                const data = filteredTableData[activeKey] || originalTableData[activeKey];
                if (!data || !data.rows || data.rows.length === 0) {
                    alert('Không có dữ liệu trong tab này để xuất.');
                    return;
                }
                
                headers = data.headers.filter(h => !HIDDEN_COLUMNS.includes(h)).map(h => headerMapping[h] || h);

                dataRows = data.rows.map(row => {
                    return data.headers.filter(h => !HIDDEN_COLUMNS.includes(h)).map(header => {
                        return row[header] ?? ''; 
                    });
                });
            }
            
            if (dataRows.length === 0) {
                alert('Không có dữ liệu để xuất.');
                return;
            }

            const dataToExport = [headers, ...dataRows];

            const escapeCsvCell = (cell) => {
                if (cell === null || cell === undefined) return '';
                let cellString = String(cell);
                // UPDATED: Xử lý giá trị tiền tệ trước khi xuất, loại bỏ VNĐ và dấu chấm
                cellString = cellString.replace(/\sVNĐ/g, '').replace(/\./g, '');
                if (cellString.search(/("|,|\n)/g) >= 0) {
                    cellString = '"' + cellString.replace(/"/g, '""') + '"';
                }
                return cellString;
            };

            const csvContent = dataToExport.map(row => row.map(escapeCsvCell).join(',')).join('\n');
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                const today = new Date().toISOString().slice(0, 10);
                const filename = `BaoCao_${TABLE_CONFIG[activeKey].name.replace(/\s/g, '_')}_${today}.csv`;

                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                alert('Trình duyệt của bạn không hỗ trợ tải xuống tệp tự động.');
            }
        }


        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const targetKey = e.currentTarget.id.replace('tab-btn-', '');
                    document.querySelectorAll('.tab, .tab-content').forEach(el => el.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    document.getElementById(`tab-content-${targetKey}`).classList.add('active');
                    
                    if (targetKey === 'tonghop') {
                        Promise.all([
                            new Promise(resolve => loadDataViaJSONP('khn', resolve)),
                            new Promise(resolve => loadDataViaJSONP('khtn', resolve)),
                            new Promise(resolve => loadDataViaJSONP('hth', resolve))
                        ]).then(() => {
                            if (!TABLE_CONFIG.tonghop.loaded) {
                                renderFilterButtons('tonghop');
                                TABLE_CONFIG.tonghop.loaded = true;
                            }
                            applyFilter('tonghop', activeFilterType);
                        });
                    } else {
                        loadDataViaJSONP(targetKey);
                    }
                });
            });
            
            const mainContainer = document.querySelector('.container');
            mainContainer.addEventListener('click', (event) => {
                if (event.target?.classList.contains('delete-btn')) {
                    deleteRow(event.target);
                }
            });

            document.querySelectorAll('.export-btn').forEach(button => {
                button.addEventListener('click', exportToExcel);
            });

            loadDataViaJSONP('khn');
        });
    </script>
</body>
</html>

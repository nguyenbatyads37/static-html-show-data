<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Báo Cáo Công Nợ | Tổng kho Hà Hòa</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4CAF50; --hover-color: #45a049; --text-color: #333;
            --border-color: #e0e0e0; --error-color: #d32f2f; --input-bg: #fffbe6;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; }
        body { background-color: #f4f7f6; line-height: 1.6; }
        .container { max-width: 1400px; margin: 20px auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid var(--primary-color); }
        header img { height: 120px; width: 120px; object-fit: cover; margin-bottom: 15px; border-radius: 50%; box-shadow: 0 4px 8px rgba(0,0,0,0.15); border: 3px solid var(--primary-color); }
        header h1 { color: var(--primary-color); font-size: 28px; }
        .tabs { display: flex; flex-wrap: wrap; border-bottom: 1px solid var(--border-color); margin-bottom: 25px; }
        .tab { padding: 12px 25px; cursor: pointer; background-color: #f5f5f5; border: 1px solid var(--border-color); border-bottom: none; margin-right: 5px; border-radius: 5px 5px 0 0; font-weight: 500; transition: background-color 0.3s, color 0.3s; }
        .tab.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { padding: 12px 15px; text-align: left; border: 1px solid var(--border-color); white-space: nowrap; }
        th { background-color: var(--primary-color); color: white; position: sticky; top: 0; z-index: 10; }
        tbody tr:nth-child(even) { background-color: #f9f9f9; }
        tbody tr:hover { background-color: #e8f5e9; }
        .input-row { background-color: var(--input-bg) !important; }
        .input-row td { padding: 8px; vertical-align: middle;}
        .input-row input, .input-row select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
        .input-row input:focus, .input-row select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2); outline: none; }
        .input-row input:read-only { background-color: #f0f0f0; cursor: not-allowed; }
        .status-indicator { text-align: center; padding: 20px; font-size: 16px; color: #777; font-style: italic; }
        .status-indicator.error { color: var(--error-color); font-weight: 500; }
        .table-title { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 15px; }
        .table-title h2 { color: #333; }
        .table-title .record-count { font-size: 14px; color: #555; background-color: #e0e0e0; padding: 4px 10px; border-radius: 12px; font-weight: 500; }
        .han-tra-no-container { display: flex; gap: 5px; align-items: center; }
        .han-tra-no-container select { flex-shrink: 0; width: auto; }
        .han-tra-no-container input { flex-grow: 1; }
        footer { text-align: center; margin-top: 30px; color: #888; font-size: 13px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <img alt="Logo" src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Ff6c823b5.%E1%BA%A2nh.094646.jpg" />
            <h1>Hệ thống Báo cáo Công nợ</h1>
        </header>
        <div class="tabs">
            <div id="tab-btn-khn" class="tab active">Khách Hàng Nợ</div>
            <div id="tab-btn-khtn" class="tab">Khách hàng trả nợ</div>
            <div id="tab-btn-hth" class="tab">Hàng thu hồi</div>
        </div>
        <div id="tab-content-khn" class="tab-content active">
            <div class="table-title">
                <h2>Bảng Khách Hàng Nợ</h2>
                <span id="count-khn" class="record-count">...</span>
            </div>
            <div class="table-container" id="container-khn"><p class="status-indicator">Đang tải dữ liệu...</p></div>
        </div>
        <div id="tab-content-khtn" class="tab-content">
            <div class="table-title">
                <h2>Bảng Khách hàng trả nợ</h2>
                <span id="count-khtn" class="record-count">...</span>
            </div>
            <div class="table-container" id="container-khtn"><p class="status-indicator">Vui lòng chọn tab để xem</p></div>
        </div>
        <div id="tab-content-hth" class="tab-content">
            <div class="table-title">
                <h2>Bảng Hàng thu hồi</h2>
                <span id="count-hth" class="record-count">...</span>
            </div>
            <div class="table-container" id="container-hth"><p class="status-indicator">Vui lòng chọn tab để xem</p></div>
        </div>
        <footer><p>&copy; 2023 - Hệ thống quản lý Tổng kho Hà Hòa</p></footer>
    </div>
    
    <script>
        const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbz_PGa2OLPSmaGs-xVCEBNRCK8w59cVfE73sgTzPo5nkW9Rpg0P8TFneHNW8GSdpZLh/exec'; 
        
        const TABLE_CONFIG = {
            'khn': { name: 'Khách Hàng Nợ', containerId: 'container-khn', countId: 'count-khn', loaded: false },
            'khtn': { name: 'Khách hàng trả nợ', containerId: 'container-khtn', countId: 'count-khtn', loaded: false },
            'hth': { name: 'Hàng thu hồi', containerId: 'container-hth', countId: 'count-hth', loaded: false }
        };

        // *** THAY ĐỔI: Danh sách các cột cần ẩn hoàn toàn khỏi giao diện ***
        const HIDDEN_COLUMNS = ['ID', 'Ngày phải trả'];

        function formatCellData(value, header) {
            if (header === 'Hạn trả nợ' && value && !isNaN(Number(value))) {
                return `${value} Ngày`;
            }
            if (typeof value === 'string' && (value.includes('T') && value.endsWith('Z') || /^\d{4}-\d{2}-\d{2}$/.test(value))) {
                try {
                    const date = new Date(value);
                    return date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });
                } catch (e) { return value; }
            }
            return value;
        }

        async function submitNewRow(tableKey) {
            const config = TABLE_CONFIG[tableKey];
            const inputRow = document.getElementById(`input-row-${tableKey}`);
            if (!config || !inputRow) return;

            const inputs = Array.from(inputRow.querySelectorAll('input'));
            const headers = Array.from(document.querySelectorAll(`#${config.containerId} th`)).map(th => th.textContent.trim());
            const rowData = {};
            let hasValue = false;
            
            const hanTraNoSelect = inputRow.querySelector('.han-tra-no-select');
            const hanTraNoInput = inputRow.querySelector('.han-tra-no-input');
            
            inputs.forEach((input, index) => {
                const header = headers[index];
                if (!HIDDEN_COLUMNS.includes(header)) {
                    rowData[header] = input.value;
                }
            });
            
            if (hanTraNoSelect) {
                 const hanTraNoValue = hanTraNoSelect.value === 'custom' ? hanTraNoInput.value : hanTraNoSelect.value;
                 rowData['Hạn trả nợ'] = hanTraNoValue;
            }

            Object.values(rowData).forEach(value => {
                 if (String(value).trim() !== '') hasValue = true;
            });

            if (!hasValue) {
                alert('Vui lòng nhập ít nhất một trường thông tin.');
                return;
            }
            
            const dataToSend = { ...rowData };

            // *** THAY ĐỔI: Tự động tạo ID ngẫu nhiên (UID) cho mỗi bản ghi mới ***
            dataToSend['ID'] = crypto.randomUUID();

            if (dataToSend['Ngày nợ']) dataToSend['Ngày nợ'] = `${dataToSend['Ngày nợ']}T00:00:00.000Z`;
            
            // Khóa các ô nhập liệu trong khi gửi
            inputs.forEach(input => input.disabled = true);
            if(hanTraNoSelect) hanTraNoSelect.disabled = true;

            try {
                // Gửi dữ liệu đi (không cần chờ phản hồi)
                fetch(API_BASE_URL, {
                    method: 'POST', mode: 'no-cors', 
                    body: JSON.stringify({ action: 'addRow', table: config.name, data: dataToSend }),
                });

                // Thêm dòng mới vào bảng ngay lập tức để người dùng thấy
                const newRow = document.createElement('tr');
                headers.forEach(header => {
                    const cell = document.createElement('td');
                    if (HIDDEN_COLUMNS.includes(header)) {
                        cell.style.display = 'none';
                    }
                    // Dùng dataToSend để lấy ID đã tạo, còn lại dùng rowData
                    const cellValue = header === 'ID' ? dataToSend['ID'] : rowData[header];
                    cell.textContent = formatCellData(cellValue ?? '', header);
                    newRow.appendChild(cell);
                });
                inputRow.insertAdjacentElement('afterend', newRow);

                // Cập nhật số lượng bản ghi
                const countSpan = document.getElementById(config.countId);
                const currentCount = parseInt(countSpan.textContent) || 0;
                countSpan.textContent = `${currentCount + 1} bản ghi`;

                // Xóa dữ liệu trong dòng nhập liệu
                inputs.forEach(input => { if (!input.readOnly && input.type !== 'hidden') input.value = ''; });
                if (hanTraNoSelect) {
                    hanTraNoSelect.value = '';
                    hanTraNoInput.value = '';
                    hanTraNoInput.style.display = 'none';
                }
                
                // Focus vào ô nhập liệu đầu tiên
                inputs.find(input => !input.readOnly && input.type !== 'hidden')?.focus();

            } catch (error) {
                console.error('Lỗi khi gửi dữ liệu:', error);
                alert(`Đã có lỗi xảy ra: ${error.message}`);
            } finally {
                // Mở lại các ô nhập liệu
                inputs.forEach(input => input.disabled = false);
                if(hanTraNoSelect) hanTraNoSelect.disabled = false;
            }
        }

        function renderTable(tableKey, data) {
            const config = TABLE_CONFIG[tableKey];
            if (!config) return;

            const container = document.getElementById(config.containerId);
            document.getElementById(config.countId).textContent = `${data.total || 0} bản ghi`;

            if (data.error) { container.innerHTML = `<p class="status-indicator error">Lỗi: ${data.error}</p>`; return; }
            if (data.rows.length === 0 && !data.headers) { container.innerHTML = '<p class="status-indicator">Không có dữ liệu.</p>'; return; }

            const headers = data.headers || Object.keys(data.rows[0] || {});
            const headerHtml = `<thead><tr>${headers.map(h => 
                `<th style="${HIDDEN_COLUMNS.includes(h) ? 'display: none;' : ''}">${h}</th>`
            ).join('')}</tr></thead>`;
            
            const inputRowHtml = `<tr id="input-row-${tableKey}" class="input-row">${
                headers.map(h => {
                    const headerText = h.trim();
                    const style = HIDDEN_COLUMNS.includes(headerText) ? 'style="display: none;"' : '';
                    let fieldHtml = '';
                    // *** THAY ĐỔI: Logic tạo ô nhập liệu đã được đơn giản hóa ***
                    switch (headerText) {
                        case 'ID':
                        case 'Ngày phải trả':
                            fieldHtml = `<input type="hidden">`; break;
                        case 'Ngày nợ': fieldHtml = `<input type="date">`; break;
                        case 'Số tiền nợ': fieldHtml = `<input type="number" placeholder="0">`; break;
                        case 'Hạn trả nợ':
                            fieldHtml = `<div class="han-tra-no-container">
                                    <select class="han-tra-no-select">
                                        <option value="" selected disabled>Chọn...</option>
                                        <option value="15">15 ngày</option>
                                        <option value="30">30 ngày</option>
                                        <option value="custom">Tự nhập...</option>
                                    </select>
                                    <input type="number" class="han-tra-no-input" placeholder="số ngày" style="display: none;">
                                </div>`; break;
                        default: fieldHtml = `<input type="text" placeholder="${h}...">`; break;
                    }
                    return `<td ${style}>${fieldHtml}</td>`;
                }).join('')
            }</tr>`;
            
            const bodyHtml = `<tbody>${inputRowHtml}${data.rows.map(row => 
                `<tr>${headers.map(h => 
                    `<td style="${HIDDEN_COLUMNS.includes(h) ? 'display: none;' : ''}">${formatCellData(row[h] ?? '', h)}</td>`
                ).join('')}</tr>`
            ).join('')}</tbody>`;

            container.innerHTML = `<table>${headerHtml}${bodyHtml}</table>`;

            const hanTraNoSelect = document.querySelector(`#input-row-${tableKey} .han-tra-no-select`);
            if (hanTraNoSelect) {
                const hanTraNoInput = document.querySelector(`#input-row-${tableKey} .han-tra-no-input`);
                hanTraNoSelect.addEventListener('change', () => {
                    hanTraNoInput.style.display = hanTraNoSelect.value === 'custom' ? 'block' : 'none';
                    if (hanTraNoSelect.value === 'custom') {
                        hanTraNoInput.value = '';
                        hanTraNoInput.focus();
                    }
                });
            }
            
            const inputRow = document.getElementById(`input-row-${tableKey}`);
            inputRow.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    submitNewRow(tableKey);
                }
            });
        }

        function loadDataViaJSONP(tableKey) {
            const config = TABLE_CONFIG[tableKey];
            if (!config || config.loaded) return;
            document.getElementById(config.containerId).innerHTML = `<p class="status-indicator">Đang tải dữ liệu...</p>`;
            const callbackName = `handleData_${tableKey}`;
            window[callbackName] = function(data) {
                renderTable(tableKey, data);
                config.loaded = true;
                const scriptEl = document.getElementById(`jsonp-script-${tableKey}`);
                if (scriptEl) scriptEl.remove();
            };
            const script = document.createElement('script');
            script.id = `jsonp-script-${tableKey}`;
            script.src = `${API_BASE_URL}?table=${encodeURIComponent(config.name)}&callback=${callbackName}`;
            script.onerror = () => { window[callbackName]({ error: "Không thể kết nối tới máy chủ." }); };
            document.body.appendChild(script);
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const targetKey = e.currentTarget.id.replace('tab-btn-', '');
                    document.querySelectorAll('.tab, .tab-content').forEach(el => el.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    document.getElementById(`tab-content-${targetKey}`).classList.add('active');
                    Object.values(TABLE_CONFIG).forEach(cfg => cfg.loaded = false);
                    loadDataViaJSONP(targetKey);
                });
            });
            loadDataViaJSONP('khn');
        });
    </script>
</body>
</html>

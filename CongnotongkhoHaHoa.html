<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công Nợ Khách Hàng Nhà Phân Phối Hà Hoà | Tổng kho Hà Hòa</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4CAF50; --secondary-color: #ff9800; --hover-color: #45a049; --text-color: #333;
            --border-color: #e0e0e0; --error-color: #d32f2f; --input-bg: #fffbe6;
            --summary-color: #1D6F42; --disabled-color: #ccc;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; }
        body { background-color: #f4f7f6; line-height: 1.6; }
        .container { max-width: 1600px; margin: 20px auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); display: none; }
        .container.visible { display: block; }
        header { display: flex; flex-direction: column; align-items: center; text-align: center; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 2px solid var(--primary-color); position: relative;}
        header img { height: 120px; width: 120px; object-fit: cover; margin-bottom: 15px; border-radius: 50%; box-shadow: 0 4px 8px rgba(0,0,0,0.15); border: 3px solid var(--primary-color); }
        header h1 { color: var(--primary-color); font-size: 28px; }
        #user-info { position: absolute; top: 10px; right: 10px; font-size: 14px; color: #555; background-color: #f0f0f0; padding: 8px 12px; border-radius: 20px; }
        #user-info #logout-btn { color: var(--error-color); text-decoration: none; font-weight: 500; margin-left: 8px; }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; padding: 20px; background-color: #f9f9f9; border-radius: 8px; border: 1px solid var(--border-color); }
        .dashboard-card { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); border-left: 5px solid var(--primary-color); transition: transform 0.2s, box-shadow 0.2s; }
        .dashboard-card.summary { border-left-color: var(--summary-color); }
        .dashboard-card.summary p { color: var(--summary-color); }
        .dashboard-card:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .dashboard-card h3 { font-size: 16px; color: #555; margin-bottom: 10px; font-weight: 500; }
        .dashboard-card p { font-size: 24px; font-weight: 700; color: var(--primary-color); }
        .tabs { display: flex; flex-wrap: wrap; border-bottom: 1px solid var(--border-color); margin-bottom: 25px; }
        .tab { padding: 12px 25px; cursor: pointer; background-color: #f5f5f5; border: 1px solid var(--border-color); border-bottom: none; margin-right: 5px; border-radius: 5px 5px 0 0; font-weight: 500; transition: background-color 0.3s, color 0.3s; }
        .tab.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        #tab-btn-tonghop.active { background-color: var(--secondary-color); border-color: var(--secondary-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .table-container { overflow-x: auto; max-height: 60vh; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { padding: 12px 15px; text-align: center; border: 1px solid var(--border-color); white-space: nowrap; vertical-align: middle; }
        td { padding: 0; } 
        tbody td input, tbody td select {
            width: 100%; height: 100%; border: none; background-color: transparent;
            padding: 12px 15px; font-size: 14px; text-align: center; appearance: none;
        }
        tbody td select { text-align: center; padding: 0 15px; }
        tbody td select[data-field="Giao hàng cho nợ"],
        tbody td select[data-field="Người chịu trách nhiệm"] { text-align: left; }
        tbody td input:focus, tbody td select:focus { outline: 2px solid var(--secondary-color); background-color: #fffbe6; }
        tbody td input[readonly] { background-color: #f0f0f0; cursor: not-allowed; }
        th { background-color: var(--primary-color); color: white; position: sticky; top: 0; z-index: 10; padding: 12px 15px; }
        thead .filter-row th { padding: 5px; background-color: #e8f5e9; top: 48px; z-index: 10; position: sticky;}
        thead .filter-row input { width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; }
        #container-tonghop th { background-color: var(--secondary-color); }
        tbody tr:nth-child(even) { background-color: #f9f9f9; }
        tbody tr:hover { background-color: #e8f5e9; }
        tbody tr.row-new { background-color: #e8f5e9 !important; font-weight: bold; }
        tbody tr.row-dirty { background-color: #fff9c4 !important; }
        tbody tr.row-deleted { display: none; }
        .input-row { background-color: var(--input-bg) !important; font-weight: bold; }
        .input-row td { padding: 8px; vertical-align: middle;}
        .input-row input, .input-row select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; font-weight: bold; }
        .input-row input::placeholder { font-weight: normal; color: #999; }
        .status-indicator { text-align: center; padding: 20px; font-size: 16px; color: #777; font-style: italic; }
        .status-indicator.error { color: var(--error-color); font-weight: 500; }
        .table-title { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 15px; }
        .table-title h2 { color: #333; }
        .table-title .controls-wrapper { display: flex; align-items: center; gap: 10px; }
        .table-title .record-count { font-size: 14px; color: #555; background-color: #e0e0e0; padding: 4px 10px; border-radius: 12px; font-weight: 500; }
        footer { text-align: center; margin-top: 30px; color: #888; font-size: 13px; }
        .delete-btn { cursor: pointer; color: var(--error-color); font-weight: bold; font-size: 1.4em; line-height: 1; display: block; padding: 12px 15px; }
        .delete-btn:hover { color: #a02020; }
        .action-btn { border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: 500; display: inline-flex; align-items: center; gap: 8px; transition: background-color 0.3s; }
        .action-btn i { font-size: 16px; }
        .export-btn { background-color: #1D6F42; color: white; }
        .export-btn:hover { background-color: #165934; }
        .update-btn { background-color: #ff9800; color: white; }
        .update-btn:hover { background-color: #e68900; }
        .update-btn:disabled { background-color: var(--disabled-color); cursor: not-allowed; }
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 1000; display: flex; justify-content: center; align-items: center; }
        #login-box { background: #fff; padding: 40px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); text-align: center; width: 100%; max-width: 350px; }
        #login-box h2 { margin-bottom: 25px; color: var(--primary-color); }
        .input-group { margin-bottom: 20px; text-align: left; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: 500; color: #555; }
        .input-group input { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px; }
        #login-btn { width: 100%; padding: 12px; background-color: var(--primary-color); color: white; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; transition: background-color 0.3s; }
        #login-btn:hover { background-color: var(--hover-color); }
        #login-error { margin-top: 15px; color: var(--error-color); font-size: 14px; height: 20px; }
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; align-items: flex-end; gap: 10px; }
        .toast { padding: 12px 20px; border-radius: 6px; color: #fff; font-size: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; transform: translateX(100%); animation: slideIn 0.5s forwards, fadeOut 0.5s 4.5s forwards; }
        .toast.success { background-color: #4CAF50; }
        .toast.error { background-color: var(--error-color); }
        .toast.warning { background-color: #ff9800; }
        @keyframes slideIn { to { opacity: 1; transform: translateX(0); } }
        @keyframes fadeOut { to { opacity: 0; transform: translateX(100%); } }
    </style>
</head>
<body>
    <div id="login-overlay">
        <div id="login-box">
            <h2>Đăng Nhập Hệ Thống</h2>
            <form id="login-form">
                <div class="input-group">
                    <label for="username">Tên đăng nhập</label>
                    <input type="text" id="username" required>
                </div>
                <div class="input-group">
                    <label for="password">Mật khẩu</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" id="login-btn">Đăng Nhập</button>
                <p id="login-error"></p>
            </form>
        </div>
    </div>

    <div class="container">
        <header>
             <div id="user-info"></div>
            <img alt="Logo" src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Ff6c823b5.%E1%BA%A2nh.094646.jpg" />
            <h1>Công Nợ Khách Hàng Nhà Phân Phối Hà Hoà</h1>
        </header>
        <div class="dashboard">
            <div class="dashboard-card"><h3>Tổng Tiền Nợ</h3><p id="dashboard-total-no">0</p></div>
            <div class="dashboard-card"><h3>Tổng Tiền Đã Trả</h3><p id="dashboard-total-tra">0</p></div>
            <div class="dashboard-card"><h3>Giá Trị Hàng Thu Hồi</h3><p id="dashboard-total-thuhoi">0</p></div>
            <div class="dashboard-card summary"><h3>Tổng Công Nợ Cuối Cùng</h3><p id="dashboard-total-conlai">0</p></div>
        </div>
        <div class="tabs">
            <div id="tab-btn-tonghop" class="tab">Tổng hợp</div>
            <div id="tab-btn-khn" class="tab active">Khách Hàng Nợ</div>
            <div id="tab-btn-khtn" class="tab">Khách hàng trả nợ</div>
            <div id="tab-btn-hth" class="tab">Hàng thu hồi</div>
        </div>
        
        <div id="tab-content-tonghop" class="tab-content">
            <div class="table-title"><h2>Bảng Tổng Hợp Công Nợ</h2><div class="controls-wrapper"><span id="count-tonghop" class="record-count">...</span><button class="export-btn action-btn"><i class="fas fa-file-excel"></i> Tải Excel</button></div></div>
            <div class="table-container" id="container-tonghop"><p class="status-indicator">Vui lòng chọn tab để xem</p></div>
        </div>
        <div id="tab-content-khn" class="tab-content active">
            <div class="table-title"><h2>Bảng Khách Hàng Nợ</h2><div class="controls-wrapper"><span id="count-khn" class="record-count">...</span><button class="update-btn action-btn" disabled><i class="fas fa-save"></i> Lưu Thay Đổi</button><button class="export-btn action-btn"><i class="fas fa-file-excel"></i> Tải Excel</button></div></div>
            <div class="table-container" id="container-khn"><p class="status-indicator">Đang tải dữ liệu...</p></div>
        </div>
        <div id="tab-content-khtn" class="tab-content">
            <div class="table-title"><h2>Bảng Khách hàng trả nợ</h2><div class="controls-wrapper"><span id="count-khtn" class="record-count">...</span><button class="update-btn action-btn" disabled><i class="fas fa-save"></i> Lưu Thay Đổi</button><button class="export-btn action-btn"><i class="fas fa-file-excel"></i> Tải Excel</button></div></div>
            <div class="table-container" id="container-khtn"><p class="status-indicator">Vui lòng chọn tab để xem</p></div>
        </div>
        <div id="tab-content-hth" class="tab-content">
             <div class="table-title"><h2>Bảng Hàng thu hồi</h2><div class="controls-wrapper"><span id="count-hth" class="record-count">...</span><button class="update-btn action-btn" disabled><i class="fas fa-save"></i> Lưu Thay Đổi</button><button class="export-btn action-btn"><i class="fas fa-file-excel"></i> Tải Excel</button></div></div>
            <div class="table-container" id="container-hth"><p class="status-indicator">Vui lòng chọn tab để xem</p></div>
        </div>

        <footer><p>&copy; 2023 - Hệ thống quản lý Tổng kho Hà Hòa</p></footer>
    </div>
    
    <div id="toast-container"></div>

    <datalist id="customer-list-options"></datalist>

    <script>
        const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbwZ73GdTFsSitoVqJKiZKIbU3wHM_qpjxQEbhlKTwi1V9GijNC8SPoRH9vVDD65xb9x/exec';
        
        const TABLE_CONFIG = {
            'khn': { name: 'Khách Hàng Nợ', containerId: 'container-khn', countId: 'count-khn', loaded: false, totalField: 'Số tiền nợ', dashboardId: 'dashboard-total-no' },
            'khtn': { name: 'Khách hàng trả nợ', containerId: 'container-khtn', countId: 'count-khtn', loaded: false, totalField: 'Số tiền nợ', dashboardId: 'dashboard-total-tra' },
            'hth': { name: 'Hàng thu hồi', containerId: 'container-hth', countId: 'count-hth', loaded: false, totalField: 'Thành tiền', dashboardId: 'dashboard-total-thuhoi' },
            'tonghop': { name: 'Tổng hợp', containerId: 'container-tonghop', countId: 'count-tonghop', loaded: false }
        };

        const headerMapping = { 'Giao hàng cho nợ': 'NV Giao hàng cho nợ', 'Người chịu trách nhiệm': 'NV Kinh doanh' };
        // --- START: SỬA ĐỔI - Hiển thị lại cột Hạn trả nợ ---
        const HIDDEN_COLUMNS = ['id']; 
        // --- END: SỬA ĐỔI ---

        let originalTableData = {};
        let changeSet = { create: {}, update: {}, delete: {} };
        let nhanSuList = [];
        let customerList = []; 

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => { toast.remove(); }, 5000);
        }

        // --- START: SỬA ĐỔI - Thêm <select> cho Hạn trả nợ ---
        function createCellInput(originalHeader, value) {
            const formattedValue = value ?? '';
            let inputHtml = '';
            const displayedHeader = headerMapping[originalHeader] || originalHeader;

            if (displayedHeader === 'NV Giao hàng cho nợ' || displayedHeader === 'NV Kinh doanh') {
                const options = nhanSuList.map(name => 
                    `<option value="${name}" ${name === formattedValue ? 'selected' : ''}>${name}</option>`
                ).join('');
                return `<td><select data-field="${originalHeader}"><option value="">-- Chọn --</option>${options}</select></td>`;
            }

            switch (originalHeader) {
                case 'Ngày nợ': case 'Ngày trả': case 'Ngày thu hồi':
                    const dateValue = formatDateForInput(formattedValue);
                    inputHtml = `<input type="date" data-field="${originalHeader}" value="${dateValue}">`;
                    break;
                case 'Ngày phải trả':
                    const dueDateValue = formatDateForInput(formattedValue);
                    inputHtml = `<input type="date" data-field="${originalHeader}" value="${dueDateValue}" readonly>`;
                    break;
                case 'Số tiền nợ': case 'Đơn giá': case 'Thành tiền':
                    const numericValue = isNaN(Number(formattedValue)) ? '' : Number(formattedValue).toLocaleString('vi-VN');
                    inputHtml = `<input type="text" inputmode="decimal" data-field="${originalHeader}" value="${numericValue}">`;
                    break;
                case 'Tên khách hàng':
                    inputHtml = `<input type="text" list="customer-list-options" data-field="${originalHeader}" value="${formattedValue}">`;
                    break;
                case 'Hạn trả nợ':
                    const val = formattedValue || '30'; // Mặc định là 30 nếu không có giá trị
                    inputHtml = `<select data-field="Hạn trả nợ">
                                    <option value="15" ${val == 15 ? 'selected' : ''}>15 ngày</option>
                                    <option value="30" ${val == 30 ? 'selected' : ''}>30 ngày</option>
                                 </select>`;
                    break;
                default:
                    inputHtml = `<input type="text" data-field="${originalHeader}" value="${formattedValue}">`;
                    break;
            }
            return `<td>${inputHtml}</td>`;
        }
        // --- END: SỬA ĐỔI ---


        function renderTable(tableKey, data) {
            const config = TABLE_CONFIG[tableKey];
            const container = document.getElementById(config.containerId);
            document.getElementById(config.countId).textContent = `${data.data?.length || 0} bản ghi`;
            
            if (tableKey === 'khn' && data.data) {
                const uniqueCustomers = {};
                data.data.slice().reverse().forEach(row => {
                    const name = row['Tên khách hàng'];
                    if (name && !uniqueCustomers[name]) {
                        uniqueCustomers[name] = {
                            name: name,
                            address: row['Địa chỉ'],
                            phone: row['SĐT'],
                            region: row['Khu vực']
                        };
                    }
                });
                customerList = Object.values(uniqueCustomers);
                
                const datalist = document.getElementById('customer-list-options');
                datalist.innerHTML = customerList.map(c => `<option value="${c.name}"></option>`).join('');
            }

            if (!data.data || !data.headers) {
                container.innerHTML = '<p class="status-indicator">Không có dữ liệu.</p>';
                return;
            }
            
            const headers = data.headers;
            const displayedHeaders = headers.filter(h => !HIDDEN_COLUMNS.includes(h));
            const headerHtml = `<thead>
                <tr><th style="width: 50px;">Xóa</th>${displayedHeaders.map(h => `<th>${headerMapping[h] || h}</th>`).join('')}</tr>
                <tr class="filter-row">
                    <th></th>
                    ${displayedHeaders.map((h) => `<th><input type="text" class="filter-input" data-header="${h}" placeholder="Lọc..."></th>`).join('')}
                </tr>
            </thead>`;
            
            // --- START: SỬA ĐỔI - Thêm <select> cho Hạn trả nợ ở dòng mới ---
            const inputRowHtml = `<tr id="input-row-${tableKey}" class="input-row"><td></td>${headers.map(h => {
                if (HIDDEN_COLUMNS.includes(h)) return `<td style="display: none;"><input type="hidden" data-field="${h}"></td>`;
                const displayedHeader = headerMapping[h] || h;
                let fieldHtml;
                if (displayedHeader === 'NV Giao hàng cho nợ' || displayedHeader === 'NV Kinh doanh') {
                    const options = nhanSuList.map(name => `<option value="${name}">${name}</option>`).join('');
                    fieldHtml = `<select data-field="${h}"><option value="">-- Chọn --</option>${options}</select>`;
                } else {
                    switch (h) {
                        case 'Tên khách hàng': fieldHtml = `<input type="text" list="customer-list-options" placeholder="Tên khách hàng..." data-field="${h}">`; break;
                        case 'Ngày nợ': fieldHtml = `<input type="date" data-field="${h}">`; break;
                        case 'Hạn trả nợ': fieldHtml = `<select data-field="Hạn trả nợ">
                                                        <option value="15">15 ngày</option>
                                                        <option value="30" selected>30 ngày</option>
                                                      </select>`; break;
                        case 'Ngày phải trả': fieldHtml = `<input type="date" data-field="${h}" readonly>`; break;
                        case 'Số tiền nợ': case 'Đơn giá': case 'Thành tiền': fieldHtml = `<input type="text" inputmode="decimal" placeholder="0" data-field="${h}">`; break;
                        default: fieldHtml = `<input type="text" placeholder="${displayedHeader}..." data-field="${h}">`; break;
                    }
                }
                return `<td>${fieldHtml}</td>`;
            }).join('')}</tr>`;
            // --- END: SỬA ĐỔI ---
            
            const bodyHtml = `<tbody>${inputRowHtml}${data.data.map(row => {
                const rowId = row['id'];
                if (tableKey === 'khn') {
                    row['Ngày phải trả'] = calculateDueDate(row['Ngày nợ'], row['Hạn trả nợ']);
                }
                const cellsHtml = headers.map(h => {
                    if (HIDDEN_COLUMNS.includes(h)) return `<td style="display: none;"></td>`;
                    return createCellInput(h, row[h]);
                }).join('');
                return `<tr data-id="${rowId}"><td><span class="delete-btn" data-id="${rowId}">&#10006;</span></td>${cellsHtml}</tr>`;
            }).join('')}</tbody>`;
            
            container.innerHTML = `<table>${headerHtml}${bodyHtml}</table>`;
            setupEventListeners(tableKey, container);
        }
        
        // --- START: SỬA ĐỔI - Cập nhật logic tính toán ---
        function setupEventListeners(tableKey, container) {
            const table = container.querySelector('table');
            if (!table) return;

            table.querySelectorAll('.filter-input').forEach(input => {
                input.addEventListener('input', () => filterTable(tableKey));
            });

            // Gộp listener cho input và change để tối ưu
            const handleInputOrChange = (e) => {
                const element = e.target;
                const tr = element.closest('tr');
                if (!tr) return;

                // Cập nhật ngày phải trả tự động
                if (tableKey === 'khn' && (element.dataset.field === 'Ngày nợ' || element.dataset.field === 'Hạn trả nợ')) {
                    const ngayNoInput = tr.querySelector('input[data-field="Ngày nợ"]');
                    const hanTraNoSelect = tr.querySelector('select[data-field="Hạn trả nợ"]');
                    const ngayPhaiTraInput = tr.querySelector('input[data-field="Ngày phải trả"]');
                    
                    if (ngayNoInput && hanTraNoSelect && ngayPhaiTraInput) {
                        const ngayPhaiTra = calculateDueDate(ngayNoInput.value, hanTraNoSelect.value);
                        ngayPhaiTraInput.value = formatDateForInput(ngayPhaiTra);
                    }
                }
                
                // Các logic khác chỉ chạy trên sự kiện 'input'
                if (e.type === 'input') {
                    if (element.tagName === 'INPUT' && element.type === 'text' && !element.hasAttribute('inputmode')) {
                        capitalizeFirstLetter(element);
                    }
                    
                    if (tableKey === 'khn' && element.dataset.field === 'Tên khách hàng') {
                        const customerName = element.value;
                        const foundCustomer = customerList.find(c => c.name === customerName);
                        if (foundCustomer) {
                            const addressInput = tr.querySelector('input[data-field="Địa chỉ"]');
                            const phoneInput = tr.querySelector('input[data-field="SĐT"]');
                            const regionInput = tr.querySelector('input[data-field="Khu vực"]');
                            if(addressInput) addressInput.value = foundCustomer.address || '';
                            if(phoneInput) phoneInput.value = foundCustomer.phone || '';
                            if(regionInput) regionInput.value = foundCustomer.region || '';
                        }
                    }
                }
            };
            
            const tbody = table.querySelector('tbody');
            tbody.addEventListener('input', handleInputOrChange);
            tbody.addEventListener('change', handleInputOrChange); // Bắt sự kiện change cho <select>
            
            tbody.addEventListener('change', (e) => {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') {
                    handleCellEdit(e, tableKey);
                }
            });

            tbody.querySelectorAll('input[inputmode="decimal"]').forEach(setupCurrencyInput);
            table.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => handleDeleteClick(e, tableKey)));
            
            const inputRow = document.getElementById(`input-row-${tableKey}`);
            if (inputRow) {
                 inputRow.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); submitNewRow(tableKey); } });
            }
        }
        // --- END: SỬA ĐỔI ---

        
        function handleCellEdit(e, tableKey) {
            const element = e.target;
            const tr = element.closest('tr');
            const rowId = tr.dataset.id;
            const field = element.dataset.field;
            let newValue = element.value;

            if (!rowId) return;

            if (!changeSet.update[tableKey]) changeSet.update[tableKey] = {};
            if (!changeSet.update[tableKey][rowId]) {
                const originalRow = originalTableData[tableKey].data.find(r => r.id == rowId);
                changeSet.update[tableKey][rowId] = { ...originalRow, id: rowId };
            }
            
            if(element.getAttribute('inputmode') === 'decimal'){
                newValue = newValue.replace(/\./g, '');
            }

            changeSet.update[tableKey][rowId][field] = newValue;
            
            if (tableKey === 'khn' && (field === 'Ngày nợ' || field === 'Hạn trả nợ')) {
                const ngayNo = changeSet.update[tableKey][rowId]['Ngày nợ'];
                const hanTraNo = changeSet.update[tableKey][rowId]['Hạn trả nợ'];
                const ngayPhaiTra = calculateDueDate(ngayNo, hanTraNo);
                changeSet.update[tableKey][rowId]['Ngày phải trả'] = formatDateForServer(ngayPhaiTra);
            }
            
            tr.classList.add('row-dirty');
            setChangesMade(tableKey, true);
        }
        
        function handleDeleteClick(e, tableKey) {
            const rowId = e.target.dataset.id;
            const tr = e.target.closest('tr');
            if(rowId && tr) {
                if (!changeSet.delete[tableKey]) changeSet.delete[tableKey] = [];
                changeSet.delete[tableKey].push(rowId);
                tr.classList.add('row-deleted');
                setChangesMade(tableKey, true);
            }
        }
        
        function submitNewRow(tableKey) {
            const inputRow = document.getElementById(`input-row-${tableKey}`);
            const headers = originalTableData[tableKey].headers;
            const rowData = {};
            
            headers.forEach(h => {
                const input = inputRow.querySelector(`[data-field="${h}"]`);
                if(input) rowData[h] = input.value;
            });
            
            if (!Object.values(rowData).some(v => String(v).trim())) {
                 showToast('Vui lòng nhập ít nhất một thông tin để thêm dòng mới.', 'warning');
                 return; 
            }

            if (tableKey === 'khn') {
                rowData['Ngày phải trả'] = formatDateForServer(calculateDueDate(rowData['Ngày nợ'], rowData['Hạn trả nợ']));
            }

            const tempId = crypto.randomUUID();
            rowData['id'] = tempId;
            
            if(!changeSet.create[tableKey]) changeSet.create[tableKey] = {};
            changeSet.create[tableKey][tempId] = rowData;

            const tempRenderData = {...rowData};
            if(tableKey === 'khn') tempRenderData['Ngày phải trả'] = calculateDueDate(rowData['Ngày nợ'], rowData['Hạn trả nợ']);

            const newTr = document.createElement('tr');
            newTr.dataset.id = tempId;
            newTr.classList.add('row-new');
            
            const cellsHtml = headers.map(h => {
                if (HIDDEN_COLUMNS.includes(h)) return `<td style="display: none;"></td>`;
                return createCellInput(h, tempRenderData[h]);
            }).join('');

            newTr.innerHTML = `<td><span class="delete-btn" data-id="${tempId}">&#10006;</span></td>` + cellsHtml;
            
            newTr.querySelectorAll('input[inputmode="decimal"]').forEach(setupCurrencyInput);
            
            inputRow.parentElement.insertBefore(newTr, inputRow.nextSibling);
            inputRow.querySelectorAll('input, select').forEach(input => {
                if (!input.readOnly) {
                    if (input.dataset.field === 'Hạn trả nợ') {
                        input.value = '30'; // Reset dropdown về mặc định
                    } else {
                        input.value = '';
                    }
                }
            });
            setChangesMade(tableKey, true);
        }

        async function handleSaveChanges(tableKey) {
            const updateBtn = document.querySelector(`#tab-content-${tableKey} .update-btn`);
            updateBtn.disabled = true;
            updateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang lưu...';

            const config = TABLE_CONFIG[tableKey];
            const payloads = [];
            
            const cleanData = (data) => {
                 return data.map(row => {
                    const newRow = {...row};
                    Object.keys(newRow).forEach(key => {
                        const numericHeaders = ['Số tiền nợ', 'Đơn giá', 'Thành tiền', 'Hạn trả nợ'];
                        if (numericHeaders.includes(key) && typeof newRow[key] === 'string') {
                            newRow[key] = newRow[key].replace(/\./g, '');
                        }
                    });
                    return newRow;
                });
            };

            const createData = Object.values(changeSet.create[tableKey] || {});
            if (createData.length > 0) {
                payloads.push(fetch(API_BASE_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ tableName: config.name, action: 'create', data: cleanData(createData) }) }));
            }

            const updateData = Object.values(changeSet.update[tableKey] || {});
            if (updateData.length > 0) {
                payloads.push(fetch(API_BASE_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ tableName: config.name, action: 'update', data: cleanData(updateData) }) }));
            }
            
            const deleteIds = changeSet.delete[tableKey] || [];
            if (deleteIds.length > 0) {
                 payloads.push(fetch(API_BASE_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ tableName: config.name, action: 'delete', data: { ids: deleteIds } }) }));
            }
            
            try {
                await Promise.all(payloads);
                showToast('Lưu thay đổi thành công!', 'success');
                changeSet = { create: {}, update: {}, delete: {} };
                TABLE_CONFIG[tableKey].loaded = false;
                loadData(tableKey);

            } catch (error) {
                showToast('Đã xảy ra lỗi khi lưu: ' + error.message, 'error');
            } finally {
                updateBtn.innerHTML = '<i class="fas fa-save"></i> Lưu Thay Đổi';
            }
        }
        
        async function loadData(tableKey, onComplete) {
            const config = TABLE_CONFIG[tableKey];
            if (!config || (config.loaded && hasPendingChanges(tableKey))) { if(onComplete) onComplete(); return; }
            document.getElementById(config.containerId).innerHTML = `<p class="status-indicator">Đang tải dữ liệu...</p>`;
            try {
                const response = await fetch(`${API_BASE_URL}?tableName=${encodeURIComponent(config.name)}`);
                const data = await response.json();
                originalTableData[tableKey] = JSON.parse(JSON.stringify(data)); 
                renderTable(tableKey, data);
                updateDashboard();
                config.loaded = true;
                setChangesMade(tableKey, false);
            } catch (error) {
                document.getElementById(config.containerId).innerHTML = `<p class="status-indicator error">Lỗi tải dữ liệu: ${error.message}</p>`;
            } finally {
                 if (onComplete) onComplete();
            }
        }

        async function fetchNhanSuAndLogin(username, password, errorEl, loginBtn) {
            try {
                const response = await fetch(`${API_BASE_URL}?tableName=Nhân sự`);
                if (!response.ok) throw new Error('Không thể tải dữ liệu người dùng.');
                
                const personnelData = await response.json();
                if (!personnelData || !personnelData.data) throw new Error('Dữ liệu người dùng không hợp lệ.');
                
                nhanSuList = personnelData.data.map(user => user['Họ và tên']).filter(Boolean).sort();
                
                if (username && password) {
                    let foundUser = personnelData.data.find(user => user['Tên đăng nhập'] === username && user['Passwword'] == password);

                    if (foundUser) {
                        const userToStore = { name: foundUser['Họ và tên'] };
                        sessionStorage.setItem('loggedInUser', JSON.stringify(userToStore));
                        initApp();
                    } else {
                        errorEl.textContent = 'Tên đăng nhập hoặc mật khẩu không đúng.';
                    }
                }
            } catch (error) {
                errorEl.textContent = 'Lỗi kết nối hoặc không tìm thấy bảng Nhân sự.';
                console.error("Login/Fetch Error:", error);
            } finally {
                if (loginBtn) {
                    loginBtn.textContent = 'Đăng Nhập';
                    loginBtn.disabled = false;
                }
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorEl = document.getElementById('login-error');
            const loginBtn = document.getElementById('login-btn');
            
            errorEl.textContent = '';
            loginBtn.textContent = 'Đang xử lý...';
            loginBtn.disabled = true;
            
            await fetchNhanSuAndLogin(username, password, errorEl, loginBtn);
        }

        function handleLogout() {
            sessionStorage.removeItem('loggedInUser');
            location.reload();
        }

        async function initApp() {
            const user = JSON.parse(sessionStorage.getItem('loggedInUser'));
            if (user) {
                document.getElementById('login-overlay').style.display = 'none';
                document.querySelector('.container').classList.add('visible');
                
                const userInfoEl = document.getElementById('user-info');
                userInfoEl.innerHTML = `Xin chào, <strong>${user.name}</strong>! <a href="#" id="logout-btn">Đăng xuất</a>`;
                document.getElementById('logout-btn').addEventListener('click', handleLogout);
                
                if (nhanSuList.length === 0) {
                    await fetchNhanSuAndLogin();
                }
                const activeTab = document.querySelector('.tab.active')?.id.replace('tab-btn-', '') || 'khn';
                loadData(activeTab);
            } else {
                document.getElementById('login-overlay').style.display = 'flex';
                document.querySelector('.container').classList.remove('visible');
            }
        }

        function setChangesMade(tableKey, madeChanges) {
            const updateBtn = document.querySelector(`#tab-content-${tableKey} .update-btn`);
            if (updateBtn) updateBtn.disabled = !madeChanges;
        }

        function hasPendingChanges(tableKey) {
            const createCount = Object.keys(changeSet.create[tableKey] || {}).length;
            const updateCount = Object.keys(changeSet.update[tableKey] || {}).length;
            const deleteCount = (changeSet.delete[tableKey] || []).length;
            return createCount + updateCount + deleteCount > 0;
        }

        function updateDashboard() {
            let totalNo = 0, totalTra = 0, totalThuHoi = 0;
            ['khn', 'khtn', 'hth'].forEach(key => {
                const config = TABLE_CONFIG[key];
                const data = originalTableData[key];
                let total = 0;
                if (data && data.data) {
                    total = data.data.reduce((sum, row) => sum + (parseFloat(String(row[config.totalField]).replace(/[^0-9,-]+/g,"")) || 0), 0);
                    document.getElementById(config.dashboardId).textContent = total.toLocaleString('vi-VN') + ' VNĐ';
                }
                if (key === 'khn') totalNo = total; if (key === 'khtn') totalTra = total; if (key === 'hth') totalThuHoi = total;
            });
            document.getElementById('dashboard-total-conlai').textContent = (totalNo - totalTra - totalThuHoi).toLocaleString('vi-VN') + ' VNĐ';
        }
        
        function calculateDueDate(startDateStr, daysToAddStr) {
            if (!startDateStr || daysToAddStr === null || daysToAddStr === '') return null;
            try {
                const startDate = new Date(startDateStr);
                const daysToAdd = parseInt(daysToAddStr, 10);
                if (isNaN(startDate.getTime()) || isNaN(daysToAdd)) return null;
                startDate.setUTCDate(startDate.getUTCDate() + daysToAdd);
                return startDate;
            } catch (e) { return null; }
        }

        function filterTable(tableKey) {
            const container = document.getElementById(TABLE_CONFIG[tableKey].containerId);
            const filters = Array.from(container.querySelectorAll('.filter-input'));
            const tbody = container.querySelector('tbody');
            const rows = tbody.querySelectorAll('tr:not(.input-row)');

            const filterValues = filters.map(f => ({
                header: f.dataset.header,
                value: f.value.toLowerCase().trim()
            }));

            rows.forEach(row => {
                const rowId = row.dataset.id;
                const rowData = originalTableData[tableKey].data.find(d => d.id == rowId);
                
                if (!rowData) return;

                let isVisible = true;
                for (const filter of filterValues) {
                    if (!filter.value) continue;
                    let cellValue = rowData[filter.header] ?? '';
                    
                    if (cellValue && (filter.header.includes('Ngày') || filter.header.includes('ngày'))) {
                        cellValue = formatDateForInput(cellValue) || cellValue;
                    }

                    cellValue = String(cellValue).toLowerCase().trim();
                    if (!cellValue.includes(filter.value)) {
                        isVisible = false;
                        break;
                    }
                }
                row.style.display = isVisible ? '' : 'none';
            });
        }
        
        function capitalizeFirstLetter(input) {
            const value = input.value;
            if (value.length > 0) {
                input.value = value.charAt(0).toUpperCase() + value.slice(1);
            }
        }

        function formatDateForInput(date) {
            if (!date) return '';
            try {
                const d = new Date(date);
                if (isNaN(d.getTime())) return '';
                const year = d.getUTCFullYear();
                const month = String(d.getUTCMonth() + 1).padStart(2, '0');
                const day = String(d.getUTCDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            } catch (e) { return ''; }
        }

        function formatDateForServer(date) {
            if (!date) return '';
             try {
                const d = new Date(date);
                if (isNaN(d.getTime())) return '';
                const year = d.getUTCFullYear();
                const month = String(d.getUTCMonth() + 1).padStart(2, '0');
                const day = String(d.getUTCDate()).padStart(2, '0');
                return `${month}/${day}/${year}`;
            } catch (e) { return ''; }
        }

        function setupCurrencyInput(input) { 
            if (!input) return; 
            const format = () => {
                const rawValue = input.value.replace(/\./g, ''); 
                input.value = isNaN(rawValue) || rawValue.trim() === '' ? '' : Number(rawValue).toLocaleString('vi-VN');
            };
            input.addEventListener('input', format);
            input.addEventListener('blur', format);
        }

        function exportToExcel() {
             const activeKey = document.querySelector('.tab.active')?.id.replace('tab-btn-', ''); if (!activeKey) return;
            const data = originalTableData[activeKey]; 
            if (!data || !data.data || data.data.length === 0) return showToast('Không có dữ liệu để xuất.', 'warning');
            const headers = data.headers.filter(h => !HIDDEN_COLUMNS.includes(h)).map(h => headerMapping[h] || h);
            const dataRows = data.data.map(row => data.headers.filter(h => !HIDDEN_COLUMNS.includes(h)).map(h => row[h] ?? ''));
            const csvContent = [headers, ...dataRows].map(row => row.map(cell => `"${String(cell ?? '').replace(/"/g, '""')}"`).join(',')).join('\n');
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `BaoCao_${TABLE_CONFIG[activeKey].name.replace(/\s/g, '_')}_${new Date().toISOString().slice(0, 10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', async (e) => {
                    const targetKey = e.currentTarget.id.replace('tab-btn-', '');
                    const currentActiveKey = document.querySelector('.tab.active')?.id.replace('tab-btn-', '');
                    if (currentActiveKey === targetKey) return;
                    if (currentActiveKey && hasPendingChanges(currentActiveKey) && !confirm('Bạn có thay đổi chưa lưu. Bạn có chắc muốn chuyển tab không?')) return;
                    
                    if (currentActiveKey) changeSet = { create: {}, update: {}, delete: {} };
                    document.querySelectorAll('.tab, .tab-content').forEach(el => el.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    document.getElementById(`tab-content-${targetKey}`).classList.add('active');
                    if (targetKey !== 'tonghop') {
                         await loadData(targetKey);
                    }
                });
            });
            document.querySelectorAll('.export-btn').forEach(button => button.addEventListener('click', exportToExcel));
            document.querySelectorAll('.update-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const tableKey = e.target.closest('.tab-content').id.replace('tab-content-', '');
                    handleSaveChanges(tableKey);
                });
            });
             initApp();
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>D·ªØ li·ªáu F3 - Xem to√†n b·ªô</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #2d7c2d;
      --primary-light: #4CAF50;
      --text-dark: #111;
      --text-medium: #333;
      --bg-light: #f4f4f4;
      --border-color: #e0e0e0;
      --font-main: 'Roboto', Arial, sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-main);
      padding: 5px;
      background: var(--bg-light);
      color: var(--text-dark);
      margin: 0;
      font-size: 15px;
    }

    .container {
      max-width: 100%;
      margin: 0 auto;
    }

    .header {
      background: #fff;
      padding: 8px 12px;
      border-radius: 8px;
      margin-bottom: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .header h1 {
      margin: 0 0 10px 0;
      color: var(--primary-color);
      font-size: 24px;
    }

    .controls {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 8px;
      padding: 8px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .controls input[type="text"],
    .controls input[type="date"],
    .controls select {
      padding: 6px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 15px;
    }

    .controls input[type="text"] {
      flex: 1;
      min-width: 200px;
    }

    .btn {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      font-size: 15px;
      background: var(--primary-color);
      color: #fff;
    }

    .btn:hover {
      background: var(--primary-light);
    }

    .btn-secondary {
      background: #6c757d;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .table-wrapper {
      overflow: auto;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      max-height: calc(100vh - 200px);
      position: relative;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 15px;
    }

    th {
      background: var(--primary-color);
      color: #fff;
      padding: 8px 6px;
      text-align: left;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
      white-space: nowrap;
      font-size: 14px;
    }

    td {
      padding: 6px;
      border-bottom: 1px solid var(--border-color);
      white-space: nowrap;
      font-size: 14px;
    }

    tbody tr:nth-child(even) {
      background: #f9f9f9;
    }

    tbody tr:hover {
      background: #eff5fb;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: var(--primary-color);
      font-size: 16px;
    }

    .error {
      background: #ffebee;
      color: #c62828;
      padding: 15px;
      border-radius: 4px;
      margin: 15px 0;
    }

    .stats {
      padding: 10px;
      background: #e8f5e9;
      border-radius: 4px;
      margin-bottom: 15px;
      font-size: 15px;
    }

    .text-center {
      text-align: center;
    }

    .text-right {
      text-align: right;
    }

    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 11px;
      font-weight: 600;
    }

    .sortable {
      user-select: none;
      position: relative;
    }

    .sortable:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .sort-indicator {
      display: inline-block;
      margin-left: 5px;
      font-size: 10px;
      opacity: 0.7;
    }

    .sortable.asc .sort-indicator::after {
      content: ' ‚Üë';
    }

    .sortable.desc .sort-indicator::after {
      content: ' ‚Üì';
    }

    .status-select {
      padding: 6px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
      background: #fff;
      cursor: pointer;
      min-width: 150px;
    }

    .status-select:hover {
      border-color: var(--primary-color);
    }

    .status-select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(45, 124, 45, 0.2);
    }

    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin: 15px 0;
      padding: 10px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .pagination-info {
      font-size: 13px;
      color: var(--text-medium);
      margin: 0 10px;
    }

    .pagination button {
      padding: 6px 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: #fff;
      cursor: pointer;
      font-size: 13px;
    }

    .pagination button:hover:not(:disabled) {
      background: var(--primary-light);
      color: #fff;
      border-color: var(--primary-light);
    }

    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .pagination .page-number {
      min-width: 40px;
      text-align: center;
    }

    .pagination .page-number.active {
      background: var(--primary-color);
      color: #fff;
      border-color: var(--primary-color);
    }

    .page-size-selector {
      display: flex;
      align-items: center;
      gap: 5px;
      margin-left: 15px;
    }

    .page-size-selector select {
      padding: 5px 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 13px;
    }

    .filter-section {
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .filter-section h3 {
      margin: 0 0 10px 0;
      font-size: 14px;
      color: var(--primary-color);
    }

    .filter-dropdowns {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      padding: 10px;
      background: #f9f9f9;
      border-radius: 4px;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
      min-width: 180px;
    }

    .filter-group label {
      font-weight: 600;
      font-size: 12px;
      color: var(--text-medium);
      margin-bottom: 5px;
    }

    .filter-group select {
      padding: 6px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 12px;
      background: #fff;
      cursor: pointer;
      min-width: 180px;
    }

    .filter-group select:hover {
      border-color: var(--primary-color);
    }

    .summary-table {
      width: 100%;
      margin-bottom: 15px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      border-collapse: collapse;
    }

    .summary-table td {
      padding: 12px 15px;
      border: 1px solid var(--border-color);
      font-size: 15px;
      text-align: center;
    }

    .summary-table tr:first-child td {
      background: var(--primary-color);
      color: #fff;
      font-weight: 700;
      font-size: 15px;
    }

    .summary-table tr:last-child td {
      text-align: center;
      font-weight: 700;
      font-size: 16px;
      color: var(--primary-color);
    }

    .quick-filters {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 15px;
      padding: 12px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .quick-filters h3 {
      width: 100%;
      margin: 0 0 10px 0;
      font-size: 14px;
      color: var(--primary-color);
    }

    .quick-filter-btn {
      padding: 6px 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: #fff;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .quick-filter-btn:hover {
      background: var(--primary-light);
      color: #fff;
      border-color: var(--primary-light);
    }

    .quick-filter-btn.active {
      background: var(--primary-color);
      color: #fff;
      border-color: var(--primary-color);
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>üìä D·ªØ li·ªáu F3 - Xem to√†n b·ªô</h1>
      <div id="greeting" style="margin-bottom: 10px; font-size: 14px; color: var(--primary-color); font-weight: 500;">
      </div>
      <div class="stats" id="stats">ƒêang t·∫£i d·ªØ li·ªáu...</div>
    </div>

    <div class="controls">
      <input type="text" id="searchInput" placeholder="üîç T√¨m ki·∫øm trong t·∫•t c·∫£ c√°c c·ªôt..." />
      
      <!-- B·ªô l·ªçc Th√°ng -->
      <label style="display: flex; align-items: center; gap: 5px; font-size: 13px; font-weight: 500;">
        Th√°ng:
        <select id="filterMonth">
          <option value="">T·∫•t c·∫£</option>
          <option value="1">Th√°ng 1</option>
          <option value="2">Th√°ng 2</option>
          <option value="3">Th√°ng 3</option>
          <option value="4">Th√°ng 4</option>
          <option value="5">Th√°ng 5</option>
          <option value="6">Th√°ng 6</option>
          <option value="7">Th√°ng 7</option>
          <option value="8">Th√°ng 8</option>
          <option value="9">Th√°ng 9</option>
          <option value="10">Th√°ng 10</option>
          <option value="11">Th√°ng 11</option>
          <option value="12">Th√°ng 12</option>
        </select>
      </label>

      <!-- B·ªô l·ªçc NƒÉm -->
      <label style="display: flex; align-items: center; gap: 5px; font-size: 13px; font-weight: 500;">
        NƒÉm:
        <select id="filterYear">
          <option value="2023">2023</option>
          <option value="2024">2024</option>
          <option value="2025">2025</option>
          <option value="2026">2026</option>
          <option value="2027">2027</option>
          <option value="2028">2028</option>
          <option value="2029">2029</option>
          <option value="2030">2030</option>
        </select>
      </label>

      <label style="display: flex; align-items: center; gap: 5px; font-size: 13px; font-weight: 500;">
        T·ª´ ng√†y:
        <input type="date" id="startDate" placeholder="T·ª´ ng√†y" />
      </label>
      <label style="display: flex; align-items: center; gap: 5px; font-size: 13px; font-weight: 500;">
        ƒê·∫øn ng√†y:
        <input type="date" id="endDate" placeholder="ƒê·∫øn ng√†y" />
      </label>
      <div class="filter-dropdowns" style="display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-start;">
        <div class="filter-group" style="min-width: 200px;">
          <label
            style="font-weight: 600; font-size: 12px; color: var(--text-medium); margin-bottom: 5px; display: block;">CSKH
            (Team L√Ω)</label>
          <select id="filterCSKH"
            style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px; width: 100%;">
            <option value="">T·∫•t c·∫£</option>
          </select>
        </div>
        <div class="filter-group" style="min-width: 150px;">
          <label
            style="font-weight: 600; font-size: 12px; color: var(--text-medium); margin-bottom: 5px; display: block;">Tr·∫°ng
            th√°i cu·ªëi c√πng</label>
          <select id="filterTrangThaiCuoiCung"
            style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px; width: 100%;">
            <option value="">T·∫•t c·∫£</option>
          </select>
        </div>
      </div>
      <button class="btn" id="refreshBtn">üîÑ L√†m m·ªõi</button>
      <button class="btn btn-secondary" id="exportBtn">üì• Xu·∫•t Excel</button>
    </div>

    <div class="quick-filters">
      <h3>‚ö° L·ªçc nhanh theo th·ªùi gian</h3>
      <button class="quick-filter-btn" data-filter="today">H√¥m nay</button>
      <button class="quick-filter-btn" data-filter="yesterday">H√¥m qua</button>
      <button class="quick-filter-btn" data-filter="thisWeek">Tu·∫ßn n√†y</button>
      <button class="quick-filter-btn" data-filter="lastWeek">Tu·∫ßn tr∆∞·ªõc</button>
      <button class="quick-filter-btn" data-filter="thisMonth">Th√°ng n√†y</button>
      <button class="quick-filter-btn" data-filter="clear">X√≥a l·ªçc</button>
    </div>

    <div class="table-wrapper">
      <div id="loading" class="loading">ƒêang t·∫£i d·ªØ li·ªáu...</div>
      <div id="error" class="error" style="display: none;"></div>

      <!-- B·∫£ng th√¥ng s·ªë t·ªïng h·ª£p -->
      <table class="summary-table" id="summaryTable" style="display: none;">
        <tbody>
          <tr>
            <td>T·ªïng s·ªë ƒë∆°n</td>
            <td>T·ªïng ti·ªÅn VNƒê</td>
            <td style="display: none;">T·ªïng Ph√≠ ship</td>
            <td style="display: none;">T·ªïng Ti·ªÅn Vi·ªát ƒë√£ ƒë·ªëi so√°t</td>
            <td>S·ªë ƒë∆°n c·ªßa CSKH</td>
            <td>S·ªë ƒë∆°n ƒë∆∞·ª£c chia</td>
          </tr>
          <tr>
            <td id="summaryTotalDon">0</td>
            <td id="summaryTotalTongTien">0 ‚Ç´</td>
            <td id="summaryTotalPhiShip" style="display: none;">0 ‚Ç´</td>
            <td id="summaryTotalTienVietDoiSoat" style="display: none;">0 ‚Ç´</td>
            <td id="summarySoDonCSKH">0</td>
            <td id="summarySoDonDuocChia">0</td>
          </tr>
        </tbody>
      </table>

      <table id="dataTable" style="display: none;">
        <thead>
          <tr>
            <th>STT</th>
            <th>M√£ ƒë∆°n h√†ng</th>
            <th>Ng√†y l√™n ƒë∆°n</th>
            <th>Name*</th>
            <th>Phone*</th>
            <th>Add</th>
            <th>Nh√¢n vi√™n Sale</th>
            <th>CSKH</th>
            <th>M·∫∑t h√†ng</th>
            <th>Khu v·ª±c</th>
            <th class="text-right">T·ªïng ti·ªÅn VNƒê</th>
            <th class="text-right" style="display: none;">Ph√≠ ship</th>
            <th class="text-right" style="display: none;">Ti·ªÅn Vi·ªát ƒë√£ ƒë·ªëi so√°t</th>
            <th class="sortable" data-sort="trangThaiCuoiCung" style="cursor: pointer;">
              Tr·∫°ng th√°i cu·ªëi c√πng
              <span class="sort-indicator">‚Üï</span>
            </th>
          </tr>
        </thead>
        <tbody id="tableBody">
        </tbody>
        <tfoot id="tableFooter">
        </tfoot>
      </table>
    </div>

    <div class="pagination" id="pagination" style="display: none;">
      <button id="firstPageBtn">‚èÆ ƒê·∫ßu</button>
      <button id="prevPageBtn">‚óÄ Tr∆∞·ªõc</button>
      <span class="pagination-info" id="pageInfo">Trang 1 / 1</span>
      <button id="nextPageBtn">Sau ‚ñ∂</button>
      <button id="lastPageBtn">Cu·ªëi ‚è≠</button>
      <div class="page-size-selector">
        <label>S·ªë d√≤ng/trang:</label>
        <select id="pageSizeSelect">
          <option value="50">50</option>
          <option value="100" selected>100</option>
          <option value="200">200</option>
          <option value="500">500</option>
        </select>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    const F3_URL = 'https://lumi-6dff7-default-rtdb.asia-southeast1.firebasedatabase.app/datasheet/F3.json';
    const HR_URL = 'https://lumi-6dff7-default-rtdb.asia-southeast1.firebasedatabase.app/datasheet/Nh%C3%A2ns%E1%BB%B1';

    let allData = [];
    let filteredData = [];
    let currentPage = 1;
    let pageSize = 100;
    let totalPages = 1;
    let allowedStaffNames = null;
    let hrData = [];
    let currentEmployee = null;
    let currentBoPhan = null;
    let sortState = { column: null, direction: 'asc' };
    let dataKeyMap = new Map();
    let trangThaiCuoiCungOptions = [];

    // --- H√ÄM M·ªöI: X·ª¨ L√ù CHU·ªñI TI·ªÄN T·ªÜ TH√ÄNH S·ªê ---
    function parseMoney(value) {
      if (!value) return 0;
      if (typeof value === 'number') return value;
      // Chuy·ªÉn v·ªÅ chu·ªói, x√≥a t·∫•t c·∫£ c√°c k√Ω t·ª± kh√¥ng ph·∫£i l√† s·ªë ho·∫∑c d·∫•u tr·ª´
      const cleaned = String(value).replace(/[^0-9-]/g, '');
      return parseFloat(cleaned) || 0;
    }

    // ƒê√£ c·∫≠p nh·∫≠t ƒë·ªÉ d√πng parseMoney
    function formatCurrency(value) {
      const num = parseMoney(value);
      if (num === 0) return '0 ‚Ç´';
      const rounded = Math.round(num / 1000) * 1000;
      return rounded.toLocaleString('vi-VN') + ' ‚Ç´';
    }

    function getRowValue(row, ...columnNames) {
      for (const colName of columnNames) {
        if (row[colName] !== undefined && row[colName] !== null && row[colName] !== '') {
          return row[colName];
        }
      }
      return '';
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      try {
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return dateStr;
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
      } catch {
        return dateStr;
      }
    }

    function normalizeF3(data) {
      if (!data) return [];
      if (Array.isArray(data)) return data.filter(item => item && typeof item === 'object');
      if (typeof data === 'object') {
        return Object.values(data).filter(item => item && typeof item === 'object');
      }
      return [];
    }

    function normalizeHR(data) {
      if (!data) return [];
      if (Array.isArray(data)) return data;
      if (typeof data === 'object') {
        return Object.values(data).filter(item => item && typeof item === 'object');
      }
      return [];
    }

    function getQueryParam(key) {
      try {
        const params = new URLSearchParams(window.location.search);
        let val = params.get(key);
        if (!val) {
          const hash = window.location.hash || '';
          const match = hash.match(new RegExp(`[?#&]?(?:${key})=([^&]+)`));
          if (match && match[1]) val = decodeURIComponent(match[1]);
        }
        return val ? String(val).trim() : '';
      } catch (_) { return ''; }
    }

    function getUserIdFromURL() {
      return getQueryParam('id') || null;
    }

    async function loadAndProcessHRData() {
      const scope = getQueryParam('scope');
      if (scope === 'allF3') {
        allowedStaffNames = null;
        currentEmployee = null;
        currentBoPhan = null;
        const greetingEl = document.getElementById('greeting');
        if (greetingEl) greetingEl.textContent = '';
        return;
      }

      const userId = getUserIdFromURL();

      try {
        const hrResponse = await fetchWithRetry(HR_URL + '.json');
        hrData = normalizeHR(hrResponse);

        if (!Array.isArray(hrData) || !hrData.length) {
          allowedStaffNames = null;
          currentEmployee = null;
          currentBoPhan = null;
          const greetingEl = document.getElementById('greeting');
          if (greetingEl) greetingEl.textContent = '';
          return;
        }

        if (!userId) {
          allowedStaffNames = null;
          currentEmployee = null;
          currentBoPhan = null;
          const greetingEl = document.getElementById('greeting');
          if (greetingEl) greetingEl.textContent = '';
          return;
        }

        const matchId = (row) => {
          const candidates = ['id', 'ID', 'Id', 'uid', 'UID', 'Uid', 'M√£ nh√¢n s·ª±', 'M√£_Nh√¢n_s·ª±', 'Ma_Nhan_su'];
          for (const k of candidates) {
            if (row[k] !== undefined && String(row[k]).trim() === userId) return true;
          }
          for (const k in row) {
            if (k && k.toLowerCase() === 'id' && String(row[k]).trim() === userId) return true;
          }
          return false;
        };

        const foundEmployee = hrData.find(matchId);

        if (!foundEmployee) {
          const greetingEl = document.getElementById('greeting');
          if (greetingEl) greetingEl.textContent = `Kh√¥ng t√¨m th·∫•y id: ${userId} trong Nh√¢n s·ª±`;
          allowedStaffNames = null;
          currentEmployee = null;
          currentBoPhan = null;
          return;
        }

        currentEmployee = foundEmployee;

        const viTri = (currentEmployee['V·ªã tr√≠'] ?? currentEmployee['Vi_tri'] ?? currentEmployee['Vi tr√≠'] ?? currentEmployee['Position'] ?? '').toString().trim();
        const team = (currentEmployee['Team'] ?? '').toString().trim();
        const hoVaTen = (currentEmployee['H·ªç V√† T√™n'] ?? currentEmployee['H·ªç_v√†_t√™n'] ?? currentEmployee['H·ªç v√† t√™n'] ?? currentEmployee['T√™n'] ?? currentEmployee['Name'] ?? '').toString().trim();
        const boPhan = (currentEmployee['B·ªô ph·∫≠n'] ?? currentEmployee['B·ªô_ph·∫≠n'] ?? currentEmployee['Bo_phan'] ?? '').toString().trim();

        currentBoPhan = (boPhan === 'CSKH') ? 'Sale' : boPhan;

        const isLeader = /leader/i.test(viTri);
        const isNV = /^nv$/i.test(viTri) || viTri.toLowerCase() === 'nh√¢n vi√™n' || viTri === '';

        const greetingEl = document.getElementById('greeting');
        if (greetingEl && hoVaTen) {
          greetingEl.textContent = `üëã Xin ch√†o ${hoVaTen}${boPhan ? ` - ${boPhan}` : ''}`;
        }

        const set = new Set();
        if (isLeader) {
          hrData.forEach(emp => {
            const empTeam = (emp['Team'] ?? '').toString().trim();
            if (empTeam === team && empTeam && empTeam !== 'ƒê√£ ngh·ªâ') {
              const name = (emp['H·ªç V√† T√™n'] ?? emp['H·ªç_v√†_t√™n'] ?? emp['H·ªç v√† t√™n'] ?? emp['T√™n'] ?? emp['Name'] ?? '').toString().trim();
              if (name) {
                set.add(name);
              }
            }
          });
        } else {
          if (hoVaTen) {
            set.add(hoVaTen);
          }
        }

        allowedStaffNames = set.size ? set : null;

      } catch (error) {
        console.error('‚ùå L·ªói khi load d·ªØ li·ªáu nh√¢n vi√™n:', error);
        allowedStaffNames = null;
        currentEmployee = null;
        currentBoPhan = null;
        const greetingEl = document.getElementById('greeting');
        if (greetingEl) greetingEl.textContent = '';
      }
    }

    async function fetchWithRetry(url, options = {}) {
      const { retries = 3, delayMs = 500 } = options;
      for (let i = 0; i < retries; i++) {
        try {
          const response = await fetch(url);
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          return await response.json();
        } catch (error) {
          if (i === retries - 1) throw error;
          await new Promise(resolve => setTimeout(resolve, delayMs));
        }
      }
    }

    async function loadData() {
      const loadingEl = document.getElementById('loading');
      const errorEl = document.getElementById('error');
      const tableEl = document.getElementById('dataTable');

      loadingEl.style.display = 'block';
      errorEl.style.display = 'none';
      tableEl.style.display = 'none';

      try {
        await loadAndProcessHRData();
        const data = await fetchWithRetry(F3_URL);
        allData = normalizeF3(data);

        dataKeyMap.clear();
        if (typeof data === 'object' && !Array.isArray(data)) {
          Object.keys(data).forEach(key => {
            const row = data[key];
            if (row && typeof row === 'object') {
              const maDonHang = getRowValue(row, 'M√£_ƒë∆°n_h√†ng', 'M√£ ƒë∆°n h√†ng') || '';
              if (maDonHang) {
                dataKeyMap.set(maDonHang, key);
              }
            }
          });
        }

        const cutoffSet = new Set();
        allData.forEach(row => {
          const cutoff = getRowValue(row, 'Th·ªùi_gian_cutoff', 'Th·ªùi gian cutoff', 'Th·ªùi_gian_Cutoff', 'Th·ªùi gian Cutoff') || '';
          if (cutoff && cutoff.trim() !== '') {
            cutoffSet.add(cutoff.trim());
          }
        });
        trangThaiCuoiCungOptions = Array.from(cutoffSet).sort();

        filteredData = [...allData];
        currentPage = 1;
        populateFilters();
        applyFilters();
        updateStats();
        renderTable();
        loadingEl.style.display = 'none';
        tableEl.style.display = 'table';
      } catch (error) {
        console.error('‚ùå Error loading data:', error);
        loadingEl.style.display = 'none';
        errorEl.style.display = 'block';
        errorEl.textContent = `‚ùå L·ªói t·∫£i d·ªØ li·ªáu: ${error.message}.`;
      }
    }

    function updateStats() {
      const statsEl = document.getElementById('stats');
      const start = (currentPage - 1) * pageSize + 1;
      const end = Math.min(currentPage * pageSize, filteredData.length);
      statsEl.textContent = `üìä T·ªïng s·ªë: ${allData.length.toLocaleString('vi-VN')} ƒë∆°n | L·ªçc ƒë∆∞·ª£c: ${filteredData.length.toLocaleString('vi-VN')} ƒë∆°n | Hi·ªÉn th·ªã: ${start.toLocaleString('vi-VN')}-${end.toLocaleString('vi-VN')}`;
    }

    function calculatePagination() {
      totalPages = Math.max(1, Math.ceil(filteredData.length / pageSize));
      if (currentPage > totalPages) {
        currentPage = totalPages;
      }
    }

    function sortData(column) {
      if (sortState.column === column) {
        sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
      } else {
        sortState.column = column;
        sortState.direction = 'asc';
      }

      filteredData.sort((a, b) => {
        let aVal, bVal;
        if (column === 'trangThaiCuoiCung') {
          aVal = getRowValue(a, 'Th·ªùi_gian_cutoff', 'Th·ªùi gian cutoff', 'Th·ªùi_gian_Cutoff', 'Th·ªùi gian Cutoff') || '';
          bVal = getRowValue(b, 'Th·ªùi_gian_cutoff', 'Th·ªùi gian cutoff', 'Th·ªùi_gian_Cutoff', 'Th·ªùi gian Cutoff') || '';
        } else {
          return 0;
        }

        aVal = String(aVal).trim().toLowerCase();
        bVal = String(bVal).trim().toLowerCase();

        if (sortState.direction === 'asc') {
          return aVal.localeCompare(bVal, 'vi');
        } else {
          return bVal.localeCompare(aVal, 'vi');
        }
      });

      document.querySelectorAll('.sortable').forEach(th => {
        th.classList.remove('asc', 'desc');
      });
      const sortableTh = document.querySelector(`.sortable[data-sort="${column}"]`);
      if (sortableTh) {
        sortableTh.classList.add(sortState.direction);
      }

      currentPage = 1;
      renderTable();
    }

    async function saveTrangThaiCuoiCung(maDonHang, newValue) {
      const firebaseKey = dataKeyMap.get(maDonHang);
      if (!firebaseKey) {
        alert('Kh√¥ng t√¨m th·∫•y key ƒë·ªÉ l∆∞u d·ªØ li·ªáu. Vui l√≤ng l√†m m·ªõi trang v√† th·ª≠ l·∫°i.');
        return false;
      }

      const updateUrl = `https://lumi-6dff7-default-rtdb.asia-southeast1.firebasedatabase.app/datasheet/F3/${firebaseKey}/Th·ªùi_gian_cutoff.json`;

      try {
        const response = await fetch(updateUrl, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(newValue)
        });

        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const row = allData.find(r => getRowValue(r, 'M√£_ƒë∆°n_h√†ng', 'M√£ ƒë∆°n h√†ng') === maDonHang);
        if (row) {
          row['Th·ªùi_gian_cutoff'] = newValue;
          row['Th·ªùi gian cutoff'] = newValue;
          row['Th·ªùi_gian_Cutoff'] = newValue;
          row['Th·ªùi gian Cutoff'] = newValue;
        }

        const filteredRow = filteredData.find(r => getRowValue(r, 'M√£_ƒë∆°n_h√†ng', 'M√£ ƒë∆°n h√†ng') === maDonHang);
        if (filteredRow) {
          filteredRow['Th·ªùi_gian_cutoff'] = newValue;
          filteredRow['Th·ªùi gian cutoff'] = newValue;
          filteredRow['Th·ªùi_gian_Cutoff'] = newValue;
          filteredRow['Th·ªùi gian Cutoff'] = newValue;
        }

        if (newValue && newValue.trim() !== '' && !trangThaiCuoiCungOptions.includes(newValue.trim())) {
          trangThaiCuoiCungOptions.push(newValue.trim());
          trangThaiCuoiCungOptions.sort();
        }

        return true;
      } catch (error) {
        console.error('‚ùå L·ªói khi l∆∞u d·ªØ li·ªáu:', error);
        alert(`L·ªói khi l∆∞u d·ªØ li·ªáu: ${error.message}`);
        return false;
      }
    }

    function renderTable() {
      const tbody = document.getElementById('tableBody');
      const tableEl = document.getElementById('dataTable');
      const paginationEl = document.getElementById('pagination');

      tbody.innerHTML = '';

      if (filteredData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="14" class="text-center">Kh√¥ng c√≥ d·ªØ li·ªáu.</td></tr>';
        tableEl.style.display = 'table';
        paginationEl.style.display = 'none';
        document.getElementById('tableFooter').innerHTML = '';
        document.getElementById('summaryTable').style.display = 'none';
        return;
      }

      filteredData.sort((a, b) => {
        const aTrangThai = String(getRowValue(a, 'Th·ªùi_gian_cutoff', 'Th·ªùi gian cutoff', 'Th·ªùi_gian_Cutoff', 'Th·ªùi gian Cutoff') || '').trim();
        const bTrangThai = String(getRowValue(b, 'Th·ªùi_gian_cutoff', 'Th·ªùi gian cutoff', 'Th·ªùi_gian_Cutoff', 'Th·ªùi gian Cutoff') || '').trim();
        const aEmpty = !aTrangThai;
        const bEmpty = !bTrangThai;

        if (aEmpty && !bEmpty) return -1;
        if (!aEmpty && bEmpty) return 1;
        if (aEmpty && bEmpty) return 0;
        return aTrangThai.localeCompare(bTrangThai, 'vi');
      });

      calculatePagination();
      renderSummaryTable();

      const startIndex = (currentPage - 1) * pageSize;
      const endIndex = startIndex + pageSize;
      const pageData = filteredData.slice(startIndex, endIndex);

      pageData.forEach((row, index) => {
        const globalIndex = startIndex + index;
        const tr = document.createElement('tr');

        const maDonHang = getRowValue(row, 'M√£_ƒë∆°n_h√†ng', 'M√£ ƒë∆°n h√†ng') || '';
        const ngayLenDon = formatDate(getRowValue(row, 'Ng√†y_l√™n_ƒë∆°n', 'Ng√†y l√™n ƒë∆°n', 'Th·ªùi gian l√™n ƒë∆°n'));
        const name = getRowValue(row, 'Name', 'Name*', 'T√™n l√™n ƒë∆°n') || '';
        const phone = getRowValue(row, 'Phone', 'Phone*', 'phone', 'phone*') || '';
        const add = getRowValue(row, 'Add', 'add', 'ƒê·ªãa ch·ªâ', 'ƒê·ªãa_ch·ªâ') || '';
        // S·ª≠ d·ª•ng parseMoney ƒë·ªÉ ƒë·∫£m b·∫£o gi√° tr·ªã ƒë√∫ng tr∆∞·ªõc khi hi·ªÉn th·ªã
        const tongTien = formatCurrency(getRowValue(row, 'T·ªïng_ti·ªÅn_VNƒê', 'T·ªïng ti·ªÅn VNƒê', 'T·ªïng Ti·ªÅn VNƒê', 'T·ªïng_ti·ªÅn_VND', 'T·ªïng ti·ªÅn'));
        const nvSale = getRowValue(row, 'Nh√¢n_vi√™n_Sale', 'Nh√¢n vi√™n Sale') || '';
        const cskh = getRowValue(row, 'CSKH', 'NV_CSKH', 'NV CSKH', 'Nh√¢n_vi√™n_CSKH', 'Nh√¢n vi√™n CSKH', 'ChƒÉm s√≥c KH', 'ChƒÉm s√≥c kh√°ch h√†ng') || '';
        const matHang = getRowValue(row, 'M·∫∑t_h√†ng', 'M·∫∑t h√†ng') || '';
        const khuVuc = getRowValue(row, 'Khu_v·ª±c', 'Khu v·ª±c') || '';
        const phiShip = formatCurrency(getRowValue(row, 'Ph√≠_ship', 'Ph√≠ ship'));
        const tienVietDoiSoat = formatCurrency(getRowValue(row, 'Ti·ªÅn_Vi·ªát_ƒë√£_ƒë·ªëi_so√°t', 'Ti·ªÅn Vi·ªát ƒë√£ ƒë·ªëi so√°t'));
        const trangThaiCuoiCung = getRowValue(row, 'Th·ªùi_gian_cutoff', 'Th·ªùi gian cutoff', 'Th·ªùi_gian_Cutoff', 'Th·ªùi gian Cutoff') || '';

        let selectOptions = '<option value="">-- Ch·ªçn --</option>';
        trangThaiCuoiCungOptions.forEach(opt => {
          const selected = opt === trangThaiCuoiCung ? 'selected' : '';
          selectOptions += `<option value="${opt.replace(/"/g, '&quot;')}" ${selected}>${opt}</option>`;
        });
        if (trangThaiCuoiCung && !trangThaiCuoiCungOptions.includes(trangThaiCuoiCung)) {
          selectOptions += `<option value="${trangThaiCuoiCung.replace(/"/g, '&quot;')}" selected>${trangThaiCuoiCung}</option>`;
        }

        tr.innerHTML = `
          <td class="text-center">${globalIndex + 1}</td>
          <td>${maDonHang}</td>
          <td>${ngayLenDon}</td>
          <td>${name}</td>
          <td>${phone}</td>
          <td>${add}</td>
          <td>${nvSale}</td>
          <td>${cskh}</td>
          <td>${matHang}</td>
          <td>${khuVuc}</td>
          <td class="text-right">${tongTien}</td>
          <td class="text-right" style="display: none;">${phiShip}</td>
          <td class="text-right" style="display: none;">${tienVietDoiSoat}</td>
          <td>
            <select class="status-select" data-ma-don="${maDonHang.replace(/"/g, '&quot;')}" onchange="handleTrangThaiCuoiCungChange(this)">
              ${selectOptions}
            </select>
          </td>
        `;
        tbody.appendChild(tr);
      });

      tableEl.style.display = 'table';
      updatePaginationControls();

      const sortableHeader = document.querySelector('.sortable[data-sort="trangThaiCuoiCung"]');
      if (sortableHeader) {
        const newSortableHeader = sortableHeader.cloneNode(true);
        sortableHeader.parentNode.replaceChild(newSortableHeader, sortableHeader);
        newSortableHeader.addEventListener('click', function () {
          sortData('trangThaiCuoiCung');
        });
      }
    }

    // ƒê√£ c·∫≠p nh·∫≠t ƒë·ªÉ d√πng parseMoney trong t√≠nh t·ªïng
    function renderSummaryTable() {
      const summaryTable = document.getElementById('summaryTable');
      if (!summaryTable) return;

      let totalTongTien = 0;
      let totalPhiShip = 0;
      let totalTienVietDoiSoat = 0;
      const seenCodes = new Set();
      let totalDon = 0;
      let soDonCSKH = 0;
      let soDonDuocChia = 0;

      filteredData.forEach(row => {
        const maDonHang = String(getRowValue(row, 'M√£_ƒë∆°n_h√†ng', 'M√£ ƒë∆°n h√†ng') || '').trim();

        if (maDonHang && !seenCodes.has(maDonHang)) {
          seenCodes.add(maDonHang);
          totalDon++;

          totalTongTien += parseMoney(getRowValue(row, 'T·ªïng_ti·ªÅn_VNƒê', 'T·ªïng ti·ªÅn VNƒê', 'T·ªïng Ti·ªÅn VNƒê', 'T·ªïng_ti·ªÅn_VND', 'T·ªïng ti·ªÅn'));
          totalPhiShip += parseMoney(getRowValue(row, 'Ph√≠_ship', 'Ph√≠ ship'));
          totalTienVietDoiSoat += parseMoney(getRowValue(row, 'Ti·ªÅn_Vi·ªát_ƒë√£_ƒë·ªëi_so√°t', 'Ti·ªÅn Vi·ªát ƒë√£ ƒë·ªëi so√°t'));

          const cskh = String(getRowValue(row, 'CSKH', 'NV_CSKH', 'NV CSKH', 'Nh√¢n_vi√™n_CSKH', 'Nh√¢n vi√™n CSKH') || '').trim();
          const nvSale = String(getRowValue(row, 'Nh√¢n_vi√™n_Sale', 'Nh√¢n vi√™n Sale') || '').trim();

          if (cskh && nvSale && cskh === nvSale) {
            soDonCSKH++;
          }
          if (cskh && cskh !== nvSale) {
            soDonDuocChia++;
          }
        }
      });

      document.getElementById('summaryTotalDon').textContent = totalDon.toLocaleString('vi-VN') + ' ƒë∆°n';
      document.getElementById('summaryTotalTongTien').textContent = formatCurrency(totalTongTien);
      document.getElementById('summaryTotalPhiShip').textContent = formatCurrency(totalPhiShip);
      document.getElementById('summaryTotalTienVietDoiSoat').textContent = formatCurrency(totalTienVietDoiSoat);
      document.getElementById('summarySoDonCSKH').textContent = soDonCSKH.toLocaleString('vi-VN') + ' ƒë∆°n';
      document.getElementById('summarySoDonDuocChia').textContent = soDonDuocChia.toLocaleString('vi-VN') + ' ƒë∆°n';

      summaryTable.style.display = 'table';
    }

    function updatePaginationControls() {
      const paginationEl = document.getElementById('pagination');
      const pageInfoEl = document.getElementById('pageInfo');
      const firstBtn = document.getElementById('firstPageBtn');
      const prevBtn = document.getElementById('prevPageBtn');
      const nextBtn = document.getElementById('nextPageBtn');
      const lastBtn = document.getElementById('lastPageBtn');

      if (filteredData.length === 0) {
        paginationEl.style.display = 'none';
        return;
      }

      paginationEl.style.display = 'flex';
      pageInfoEl.textContent = `Trang ${currentPage} / ${totalPages}`;

      firstBtn.disabled = currentPage === 1;
      prevBtn.disabled = currentPage === 1;
      nextBtn.disabled = currentPage === totalPages;
      lastBtn.disabled = currentPage === totalPages;
    }

    function goToPage(page) {
      if (page < 1 || page > totalPages) return;
      currentPage = page;
      renderTable();
      updateStats();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function populateNVSaleCheckboxes() {
      const select = document.getElementById('filterCSKH');
      if (!select) return;

      const teamLyMembers = new Set();
      hrData.forEach(emp => {
        const team = (emp['Team'] || '').toString().trim();
        if (team === 'CSKH- L√Ω') {
          const hoVaTen = (emp['H·ªç V√† T√™n'] ?? emp['H·ªç_v√†_t√™n'] ?? emp['H·ªç v√† t√™n'] ?? emp['T√™n'] ?? emp['Name'] ?? '').toString().trim();
          if (hoVaTen) teamLyMembers.add(hoVaTen);
        }
      });

      const cskhValues = new Set();
      allData.forEach(row => {
        const cskh = String(getRowValue(row, 'CSKH', 'NV_CSKH', 'NV CSKH', 'Nh√¢n_vi√™n_CSKH') || '').trim();
        if (cskh && teamLyMembers.has(cskh)) {
          cskhValues.add(cskh);
        }
      });

      const sortedValues = Array.from(cskhValues).sort();
      const firstOptionText = select.querySelector('option') ? select.querySelector('option').textContent : 'T·∫•t c·∫£';
      select.innerHTML = '';

      const allOption = document.createElement('option');
      allOption.value = '';
      allOption.textContent = firstOptionText;
      select.appendChild(allOption);

      const emptyOption = document.createElement('option');
      emptyOption.value = '__EMPTY__';
      emptyOption.textContent = 'Tr·ªëng';
      select.appendChild(emptyOption);

      sortedValues.forEach(value => {
        const option = document.createElement('option');
        option.value = value;
        option.textContent = value;
        select.appendChild(option);
      });

      select.addEventListener('change', applyFilters);
    }

    function populateFilters() {
      populateNVSaleCheckboxes();

      const selectTrangThai = document.getElementById('filterTrangThaiCuoiCung');
      if (selectTrangThai) {
        const firstOptionText = selectTrangThai.querySelector('option') ? selectTrangThai.querySelector('option').textContent : 'T·∫•t c·∫£';
        selectTrangThai.innerHTML = '';

        const allOption = document.createElement('option');
        allOption.value = '';
        allOption.textContent = firstOptionText;
        selectTrangThai.appendChild(allOption);

        const emptyOption = document.createElement('option');
        emptyOption.value = '__EMPTY__';
        emptyOption.textContent = 'Tr·ªëng';
        selectTrangThai.appendChild(emptyOption);

        trangThaiCuoiCungOptions.forEach(value => {
          const option = document.createElement('option');
          option.value = value;
          option.textContent = value;
          selectTrangThai.appendChild(option);
        });

        selectTrangThai.addEventListener('change', applyFilters);
      }
    }

    function getSelectedFilterValue(filterId) {
      const select = document.getElementById(filterId);
      if (!select) return '';
      return select.value.trim();
    }

    function applyFilters() {
      const searchText = document.getElementById('searchInput').value.toLowerCase().trim();
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const selectedCSKH = getSelectedFilterValue('filterCSKH');
      const selectedTrangThaiCuoiCung = getSelectedFilterValue('filterTrangThaiCuoiCung');

      currentPage = 1;

      filteredData = allData.filter(row => {
        if (selectedCSKH) {
          const cskhRaw = getRowValue(row, 'CSKH', 'NV_CSKH', 'NV CSKH', 'Nh√¢n_vi√™n_CSKH');
          const cskh = String(cskhRaw || '').trim();
          if (selectedCSKH === '__EMPTY__') {
            if (cskh !== '') return false;
          } else {
            if (cskh !== selectedCSKH) return false;
          }
        }

        if (currentEmployee && allowedStaffNames !== null) {
          const viTri = String(currentEmployee['V·ªã tr√≠'] || '').trim();
          const hoVaTen = String(currentEmployee['H·ªç V√† T√™n'] || '').trim();
          const cskh = String(getRowValue(row, 'CSKH', 'NV_CSKH', 'NV CSKH', 'Nh√¢n_vi√™n_CSKH') || '').trim();

          if (viTri === 'NV' || viTri === '') {
            if (cskh !== hoVaTen) return false;
          } else if (viTri === 'Leader') {
            if (!cskh || !allowedStaffNames.has(cskh)) return false;
          }
        }

        if (searchText) {
          const searchableText = Object.values(row).map(v => String(v || '').toLowerCase()).join(' ');
          if (!searchableText.includes(searchText)) return false;
        }

        if (startDate || endDate) {
          const rowDate = getRowValue(row, 'Ng√†y_l√™n_ƒë∆°n', 'Ng√†y l√™n ƒë∆°n', 'Th·ªùi gian l√™n ƒë∆°n');
          if (!rowDate) return false;

          try {
            const date = new Date(rowDate);
            if (isNaN(date.getTime())) return false;

            if (startDate) {
              const start = new Date(startDate);
              start.setHours(0, 0, 0, 0);
              if (date < start) return false;
            }
            if (endDate) {
              const end = new Date(endDate);
              end.setHours(23, 59, 59, 999);
              if (date > end) return false;
            }
          } catch {
            return false;
          }
        }

        if (selectedTrangThaiCuoiCung) {
          const trangThaiCuoiCung = String(getRowValue(row, 'Th·ªùi_gian_cutoff', 'Th·ªùi gian cutoff', 'Th·ªùi_gian_Cutoff', 'Th·ªùi gian Cutoff') || '').trim();
          if (selectedTrangThaiCuoiCung === '__EMPTY__') {
            if (trangThaiCuoiCung !== '') return false;
          } else {
            if (trangThaiCuoiCung !== selectedTrangThaiCuoiCung) return false;
          }
        }

        return true;
      });

      updateStats();
      renderTable();
    }

    // ƒê√£ c·∫≠p nh·∫≠t ƒë·ªÉ d√πng parseMoney khi xu·∫•t Excel
    function exportToExcel() {
      if (filteredData.length === 0) {
        alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!');
        return;
      }

      const headers = [
        'STT', 'M√£ ƒë∆°n h√†ng', 'Ng√†y l√™n ƒë∆°n', 'Name*', 'Phone*', 'Add', 'Nh√¢n vi√™n Sale', 'CSKH',
        'M·∫∑t h√†ng', 'Khu v·ª±c', 'T·ªïng ti·ªÅn VNƒê', 'Ph√≠ ship', 'Ti·ªÅn Vi·ªát ƒë√£ ƒë·ªëi so√°t', 'Tr·∫°ng th√°i cu·ªëi c√πng'
      ];

      const excelData = [headers];

      filteredData.forEach((row, index) => {
        excelData.push([
          index + 1,
          getRowValue(row, 'M√£_ƒë∆°n_h√†ng', 'M√£ ƒë∆°n h√†ng') || '',
          formatDate(getRowValue(row, 'Ng√†y_l√™n_ƒë∆°n', 'Ng√†y l√™n ƒë∆°n', 'Th·ªùi gian l√™n ƒë∆°n')),
          getRowValue(row, 'Name', 'Name*', 'T√™n l√™n ƒë∆°n') || '',
          getRowValue(row, 'Phone', 'Phone*', 'phone', 'phone*') || '',
          getRowValue(row, 'Add', 'add', 'ƒê·ªãa ch·ªâ', 'ƒê·ªãa_ch·ªâ') || '',
          getRowValue(row, 'Nh√¢n_vi√™n_Sale', 'Nh√¢n vi√™n Sale') || '',
          getRowValue(row, 'CSKH', 'NV_CSKH', 'NV CSKH', 'Nh√¢n_vi√™n_CSKH') || '',
          getRowValue(row, 'M·∫∑t_h√†ng', 'M·∫∑t h√†ng') || '',
          getRowValue(row, 'Khu_v·ª±c', 'Khu v·ª±c') || '',
          parseMoney(getRowValue(row, 'T·ªïng_ti·ªÅn_VNƒê', 'T·ªïng ti·ªÅn VNƒê', 'T·ªïng Ti·ªÅn VNƒê', 'T·ªïng_ti·ªÅn_VND', 'T·ªïng ti·ªÅn')),
          parseMoney(getRowValue(row, 'Ph√≠_ship', 'Ph√≠ ship')),
          parseMoney(getRowValue(row, 'Ti·ªÅn_Vi·ªát_ƒë√£_ƒë·ªëi_so√°t', 'Ti·ªÅn Vi·ªát ƒë√£ ƒë·ªëi so√°t')),
          getRowValue(row, 'Th·ªùi_gian_cutoff', 'Th·ªùi gian cutoff', 'Th·ªùi_gian_Cutoff', 'Th·ªùi gian Cutoff') || ''
        ]);
      });

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(excelData);
      const colWidths = headers.map(() => ({ wch: 15 }));
      ws['!cols'] = colWidths;

      XLSX.utils.book_append_sheet(wb, ws, 'F3_Data');
      const now = new Date();
      const fileName = `F3_Data_${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}.xlsx`;
      XLSX.writeFile(wb, fileName);
    }

    function setDateRangeFromMonth() {
      const monthSelect = document.getElementById('filterMonth');
      const yearSelect = document.getElementById('filterYear');
      
      const month = monthSelect.value;
      const yearStr = yearSelect.value;

      if (!month || !yearStr) {
        if (!month) {
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
        }
        return;
      }

      const year = parseInt(yearStr);
      const monthNum = parseInt(month);

      const startDate = new Date(year, monthNum - 1, 1);
      const endDate = new Date(year, monthNum, 0);

      const formatDateISO = (date) => {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
      };

      document.getElementById('startDate').value = formatDateISO(startDate);
      document.getElementById('endDate').value = formatDateISO(endDate);
    }

    function handleQuickFilter(filterType, clickedBtn) {
      const now = new Date();
      const startDateEl = document.getElementById('startDate');
      const endDateEl = document.getElementById('endDate');
      const monthSelect = document.getElementById('filterMonth');

      document.querySelectorAll('.quick-filter-btn').forEach(btn => btn.classList.remove('active'));

      if (clickedBtn && filterType !== 'clear') {
        clickedBtn.classList.add('active');
      }

      if (monthSelect) monthSelect.value = '';

      switch (filterType) {
        case 'today':
          const today = now.toISOString().split('T')[0];
          startDateEl.value = today;
          endDateEl.value = today;
          break;
        case 'yesterday':
          const yesterday = new Date(now);
          yesterday.setDate(yesterday.getDate() - 1);
          startDateEl.value = yesterday.toISOString().split('T')[0];
          endDateEl.value = yesterday.toISOString().split('T')[0];
          break;
        case 'thisWeek':
          const day = now.getDay();
          const diff = now.getDate() - day + (day === 0 ? -6 : 1);
          const thisWeekStart = new Date(now);
          thisWeekStart.setDate(diff);
          const thisWeekEnd = new Date(thisWeekStart);
          thisWeekEnd.setDate(thisWeekEnd.getDate() + 6);
          startDateEl.value = thisWeekStart.toISOString().split('T')[0];
          endDateEl.value = thisWeekEnd.toISOString().split('T')[0];
          break;
        case 'lastWeek':
          const lastWeekStart = new Date(now);
          const lastDay = lastWeekStart.getDay();
          const lastDiff = lastWeekStart.getDate() - lastDay - 6 + (lastDay === 0 ? -6 : 1);
          lastWeekStart.setDate(lastDiff);
          const lastWeekEnd = new Date(lastWeekStart);
          lastWeekEnd.setDate(lastWeekEnd.getDate() + 6);
          startDateEl.value = lastWeekStart.toISOString().split('T')[0];
          endDateEl.value = lastWeekEnd.toISOString().split('T')[0];
          break;
        case 'thisMonth':
          const thisMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
          const thisMonthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0);
          startDateEl.value = thisMonthStart.toISOString().split('T')[0];
          endDateEl.value = thisMonthEnd.toISOString().split('T')[0];
          break;
        case 'clear':
          startDateEl.value = '';
          endDateEl.value = '';
          if (monthSelect) monthSelect.value = '';
          break;
      }
      applyFilters();
    }

    document.addEventListener('DOMContentLoaded', () => {
        const currentYear = new Date().getFullYear();
        const yearSelect = document.getElementById('filterYear');
        if(yearSelect) yearSelect.value = currentYear;
    });

    document.getElementById('searchInput').addEventListener('input', applyFilters);
    document.getElementById('startDate').addEventListener('change', function () {
      document.getElementById('filterMonth').value = '';
      applyFilters();
    });
    document.getElementById('endDate').addEventListener('change', function () {
      document.getElementById('filterMonth').value = '';
      applyFilters();
    });
    
    document.getElementById('filterMonth').addEventListener('change', function () {
      setDateRangeFromMonth();
      document.querySelectorAll('.quick-filter-btn').forEach(btn => btn.classList.remove('active'));
      applyFilters();
    });

    document.getElementById('filterYear').addEventListener('change', function () {
      if(document.getElementById('filterMonth').value !== "") {
        setDateRangeFromMonth();
        applyFilters();
      }
    });

    document.getElementById('refreshBtn').addEventListener('click', loadData);
    document.getElementById('exportBtn').addEventListener('click', exportToExcel);

    document.querySelectorAll('.quick-filter-btn').forEach(btn => {
      btn.addEventListener('click', function () {
        handleQuickFilter(this.getAttribute('data-filter'), this);
      });
    });

    document.getElementById('firstPageBtn').addEventListener('click', () => goToPage(1));
    document.getElementById('prevPageBtn').addEventListener('click', () => goToPage(currentPage - 1));
    document.getElementById('nextPageBtn').addEventListener('click', () => goToPage(currentPage + 1));
    document.getElementById('lastPageBtn').addEventListener('click', () => goToPage(totalPages));
    document.getElementById('pageSizeSelect').addEventListener('change', function () {
      pageSize = parseInt(this.value);
      currentPage = 1;
      renderTable();
      updateStats();
    });

    window.handleTrangThaiCuoiCungChange = async function (selectElement) {
      const maDonHang = selectElement.getAttribute('data-ma-don');
      const newValue = selectElement.value;

      if (!maDonHang) return;
      selectElement.disabled = true;
      selectElement.style.opacity = '0.6';

      async function updateAppSheet(maDonHang, newValue) {
        const APP_ID = 'f9aacd5a-8966-45b1-b20c-c8f5ea16c63b';
        const ACCESS_KEY = 'V2-w28Id-wg3Ec-NToRD-xUaHk-CPMlL-44lVt-tNHJ3-DeMAp';
        const TABLE_NAME = 'F3';
        const url = `https://api.appsheet.com/api/v2/apps/${APP_ID}/tables/${TABLE_NAME}/Action`;
        const body = {
          "Action": "Edit",
          "Properties": { "Locale": "vi-VN" },
          "Rows": [{ "M√£ ƒë∆°n h√†ng": maDonHang, "Th·ªùi gian cutoff": newValue }]
        };

        try {
          const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'ApplicationAccessKey': ACCESS_KEY },
            body: JSON.stringify(body)
          });
          if (!response.ok) throw new Error(await response.text());
          return true;
        } catch (error) {
          console.error('‚ùå L·ªói AppSheet:', error);
          alert(`L·ªói AppSheet: ${error.message}`);
          return false;
        }
      }

      const [firebaseSuccess, appSheetSuccess] = await Promise.all([
        saveTrangThaiCuoiCung(maDonHang, newValue),
        updateAppSheet(maDonHang, newValue)
      ]);

      selectElement.disabled = false;
      selectElement.style.opacity = '1';

      if (firebaseSuccess && appSheetSuccess) {
        const originalBg = selectElement.style.backgroundColor;
        selectElement.style.backgroundColor = '#c8e6c9';
        setTimeout(() => { selectElement.style.backgroundColor = originalBg; }, 1000);
      } else {
        const row = filteredData.find(r => getRowValue(r, 'M√£_ƒë∆°n_h√†ng') === maDonHang);
        if (row) selectElement.value = getRowValue(row, 'Th·ªùi_gian_cutoff');
      }
    };

    loadData();
  </script>
</body>
</html>


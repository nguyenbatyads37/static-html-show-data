<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>D·ªØ li·ªáu F3 - Xem to√†n b·ªô</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #2d7c2d;
      --primary-light: #4CAF50;
      --text-dark: #111;
      --text-medium: #333;
      --bg-light: #f4f4f4;
      --border-color: #e0e0e0;
      --font-main: 'Roboto', Arial, sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-main);
      padding: 5px;
      background: var(--bg-light);
      color: var(--text-dark);
      margin: 0;
      font-size: 15px;
    }

    .container {
      max-width: 100%;
      margin: 0 auto;
    }

    .header {
      background: #fff;
      padding: 8px 12px;
      border-radius: 8px;
      margin-bottom: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .header h1 {
      margin: 0 0 10px 0;
      color: var(--primary-color);
      font-size: 24px;
    }

    .controls {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 8px;
      padding: 8px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .controls input[type="text"],
    .controls input[type="date"] {
      padding: 6px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 15px;
    }

    .controls input[type="text"] {
      flex: 1;
      min-width: 200px;
    }

    .btn {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      font-size: 15px;
      background: var(--primary-color);
      color: #fff;
    }

    .btn:hover {
      background: var(--primary-light);
    }

    .btn-secondary {
      background: #6c757d;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .table-wrapper {
      overflow: auto;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      max-height: calc(100vh - 200px);
      position: relative;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 15px;
    }

    th {
      background: var(--primary-color);
      color: #fff;
      padding: 8px 6px;
      text-align: left;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
      white-space: nowrap;
      font-size: 14px;
    }

    td {
      padding: 6px;
      border-bottom: 1px solid var(--border-color);
      white-space: nowrap;
      font-size: 14px;
    }

    tbody tr:nth-child(even) {
      background: #f9f9f9;
    }

    tbody tr:hover {
      background: #eff5fb;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: var(--primary-color);
      font-size: 16px;
    }

    .error {
      background: #ffebee;
      color: #c62828;
      padding: 15px;
      border-radius: 4px;
      margin: 15px 0;
    }

    .stats {
      padding: 10px;
      background: #e8f5e9;
      border-radius: 4px;
      margin-bottom: 15px;
      font-size: 15px;
    }

    .text-center {
      text-align: center;
    }

    .text-right {
      text-align: right;
    }

    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 11px;
      font-weight: 600;
    }

    .badge-success {
      background: #c8e6c9;
      color: #2e7d32;
    }

    .badge-warning {
      background: #fff9c4;
      color: #f57f17;
    }

    .badge-danger {
      background: #ffcdd2;
      color: #c62828;
    }

    .sortable {
      user-select: none;
      position: relative;
    }

    .sortable:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .sort-indicator {
      display: inline-block;
      margin-left: 5px;
      font-size: 10px;
      opacity: 0.7;
    }

    .sortable.asc .sort-indicator::after {
      content: ' ‚Üë';
    }

    .sortable.desc .sort-indicator::after {
      content: ' ‚Üì';
    }

    .status-select {
      padding: 6px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
      background: #fff;
      cursor: pointer;
      min-width: 150px;
    }

    .status-select:hover {
      border-color: var(--primary-color);
    }

    .status-select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(45, 124, 45, 0.2);
    }

    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin: 15px 0;
      padding: 10px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .pagination-info {
      font-size: 13px;
      color: var(--text-medium);
      margin: 0 10px;
    }

    .pagination button {
      padding: 6px 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: #fff;
      cursor: pointer;
      font-size: 13px;
    }

    .pagination button:hover:not(:disabled) {
      background: var(--primary-light);
      color: #fff;
      border-color: var(--primary-light);
    }

    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .pagination .page-number {
      min-width: 40px;
      text-align: center;
    }

    .pagination .page-number.active {
      background: var(--primary-color);
      color: #fff;
      border-color: var(--primary-color);
    }

    .page-size-selector {
      display: flex;
      align-items: center;
      gap: 5px;
      margin-left: 15px;
    }

    .page-size-selector select {
      padding: 5px 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 13px;
    }

    .filter-section {
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .filter-section h3 {
      margin: 0 0 10px 0;
      font-size: 14px;
      color: var(--primary-color);
    }

    .filter-dropdowns {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      padding: 10px;
      background: #f9f9f9;
      border-radius: 4px;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
      min-width: 180px;
    }

    .filter-group label {
      font-weight: 600;
      font-size: 12px;
      color: var(--text-medium);
      margin-bottom: 5px;
    }

    .filter-group select {
      padding: 6px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 12px;
      background: #fff;
      cursor: pointer;
      min-width: 180px;
    }

    .filter-group select:hover {
      border-color: var(--primary-color);
    }

    .total-row {
      background: #ffeb3b !important;
      font-weight: 700 !important;
      position: sticky;
      top: 0;
      z-index: 5;
    }

    .total-row td {
      background: #ffeb3b !important;
      border-bottom: 2px solid #f57f17;
      border-top: 2px solid #f57f17;
    }

    .summary-table {
      width: 100%;
      margin-bottom: 15px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      border-collapse: collapse;
    }

    .summary-table td {
      padding: 12px 15px;
      border: 1px solid var(--border-color);
      font-size: 15px;
      text-align: center;
    }

    .summary-table tr:first-child td {
      background: var(--primary-color);
      color: #fff;
      font-weight: 700;
      font-size: 15px;
    }

    .summary-table tr:last-child td {
      text-align: center;
      font-weight: 700;
      font-size: 16px;
      color: var(--primary-color);
    }

    .quick-filters {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 15px;
      padding: 12px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .quick-filters h3 {
      width: 100%;
      margin: 0 0 10px 0;
      font-size: 14px;
      color: var(--primary-color);
    }

    .quick-filter-btn {
      padding: 6px 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: #fff;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .quick-filter-btn:hover {
      background: var(--primary-light);
      color: #fff;
      border-color: var(--primary-light);
    }

    .quick-filter-btn.active {
      background: var(--primary-color);
      color: #fff;
      border-color: var(--primary-color);
    }

    .checkbox-filter-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 200px;
      overflow-y: auto;
      padding: 10px;
      background: #f9f9f9;
      border-radius: 4px;
      border: 1px solid #ccc;
      min-width: 200px;
    }

    .checkbox-filter-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 0;
    }

    .checkbox-filter-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .checkbox-filter-item label {
      cursor: pointer;
      font-size: 12px;
      margin: 0;
      font-weight: normal;
      user-select: none;
    }

    .checkbox-filter-header {
      font-weight: 600;
      font-size: 12px;
      color: var(--text-medium);
      margin-bottom: 5px;
      padding-bottom: 5px;
      border-bottom: 1px solid #ddd;
    }

    .filter-toggle-btn {
      border: 1px solid #ccc;
      background: #fff;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 11px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .filter-toggle-btn:hover {
      background: var(--primary-light);
      color: #fff;
      border-color: var(--primary-light);
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>üìä D·ªØ li·ªáu F3 - Xem to√†n b·ªô</h1>
      <div id="greeting" style="margin-bottom: 10px; font-size: 14px; color: var(--primary-color); font-weight: 500;">
      </div>
      <div class="stats" id="stats">ƒêang t·∫£i d·ªØ li·ªáu...</div>
    </div>

    <div class="controls">
      <input type="text" id="searchInput" placeholder="üîç T√¨m ki·∫øm trong t·∫•t c·∫£ c√°c c·ªôt..." />
      <label style="display: flex; align-items: center; gap: 5px; font-size: 13px; font-weight: 500;">
        Th√°ng:
        <select id="filterMonth"
          style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px;">
          <option value="">T·∫•t c·∫£</option>
          <option value="1">Th√°ng 1</option>
          <option value="2">Th√°ng 2</option>
          <option value="3">Th√°ng 3</option>
          <option value="4">Th√°ng 4</option>
          <option value="5">Th√°ng 5</option>
          <option value="6">Th√°ng 6</option>
          <option value="7">Th√°ng 7</option>
          <option value="8">Th√°ng 8</option>
          <option value="9">Th√°ng 9</option>
          <option value="10">Th√°ng 10</option>
          <option value="11">Th√°ng 11</option>
          <option value="12">Th√°ng 12</option>
        </select>
      </label>
      <label style="display: flex; align-items: center; gap: 5px; font-size: 13px; font-weight: 500;">
        T·ª´ ng√†y:
        <input type="date" id="startDate" placeholder="T·ª´ ng√†y" />
      </label>
      <label style="display: flex; align-items: center; gap: 5px; font-size: 13px; font-weight: 500;">
        ƒê·∫øn ng√†y:
        <input type="date" id="endDate" placeholder="ƒê·∫øn ng√†y" />
      </label>
      <div class="filter-dropdowns" style="display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-start;">
        <div class="filter-group" style="min-width: 200px;">
          <label
            style="font-weight: 600; font-size: 12px; color: var(--text-medium); margin-bottom: 5px; display: block;">CSKH
            (Team L√Ω)</label>
          <select id="filterCSKH"
            style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px; width: 100%;">
            <option value="">T·∫•t c·∫£</option>
          </select>
        </div>
        <div class="filter-group" style="min-width: 150px;">
          <label
            style="font-weight: 600; font-size: 12px; color: var(--text-medium); margin-bottom: 5px; display: block;">Tr·∫°ng
            th√°i cu·ªëi c√πng</label>
          <select id="filterTrangThaiCuoiCung"
            style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px; width: 100%;">
            <option value="">T·∫•t c·∫£</option>
          </select>
        </div>
      </div>
      <button class="btn" id="refreshBtn">üîÑ L√†m m·ªõi</button>
      <button class="btn btn-secondary" id="exportBtn">üì• Xu·∫•t Excel</button>
    </div>

    <div class="quick-filters">
      <h3>‚ö° L·ªçc nhanh theo th·ªùi gian</h3>
      <button class="quick-filter-btn" data-filter="today">H√¥m nay</button>
      <button class="quick-filter-btn" data-filter="yesterday">H√¥m qua</button>
      <button class="quick-filter-btn" data-filter="thisWeek">Tu·∫ßn n√†y</button>
      <button class="quick-filter-btn" data-filter="lastWeek">Tu·∫ßn tr∆∞·ªõc</button>
      <button class="quick-filter-btn" data-filter="thisMonth">Th√°ng n√†y</button>
      <button class="quick-filter-btn" data-filter="clear">X√≥a l·ªçc</button>
    </div>

    <div class="table-wrapper">
      <div id="loading" class="loading">ƒêang t·∫£i d·ªØ li·ªáu...</div>
      <div id="error" class="error" style="display: none;"></div>

      <!-- B·∫£ng th√¥ng s·ªë t·ªïng h·ª£p -->
      <table class="summary-table" id="summaryTable" style="display: none;">
        <tbody>
          <tr>
            <td>T·ªïng s·ªë ƒë∆°n</td>
            <td>T·ªïng ti·ªÅn VNƒê</td>
            <td style="display: none;">T·ªïng Ph√≠ ship</td>
            <td style="display: none;">T·ªïng Ti·ªÅn Vi·ªát ƒë√£ ƒë·ªëi so√°t</td>
            <td>S·ªë ƒë∆°n c·ªßa CSKH</td>
            <td>S·ªë ƒë∆°n ƒë∆∞·ª£c chia</td>
          </tr>
          <tr>
            <td id="summaryTotalDon">0</td>
            <td id="summaryTotalTongTien">0 ‚Ç´</td>
            <td id="summaryTotalPhiShip" style="display: none;">0 ‚Ç´</td>
            <td id="summaryTotalTienVietDoiSoat" style="display: none;">0 ‚Ç´</td>
            <td id="summarySoDonCSKH">0</td>
            <td id="summarySoDonDuocChia">0</td>
          </tr>
        </tbody>
      </table>

      <table id="dataTable" style="display: none;">
        <thead>
          <tr>
            <th>STT</th>
            <th>M√£ ƒë∆°n h√†ng</th>
            <th>Ng√†y l√™n ƒë∆°n</th>
            <th>Name*</th>
            <th>Phone*</th>
            <th>Add</th>
            <th>Nh√¢n vi√™n Sale</th>
            <th>CSKH</th>
            <th>M·∫∑t h√†ng</th>
            <th>Khu v·ª±c</th>
            <th class="text-right">T·ªïng ti·ªÅn VNƒê</th>
            <th class="text-right" style="display: none;">Ph√≠ ship</th>
            <th class="text-right" style="display: none;">Ti·ªÅn Vi·ªát ƒë√£ ƒë·ªëi so√°t</th>
            <th class="sortable" data-sort="trangThaiCuoiCung" style="cursor: pointer;">
              Tr·∫°ng th√°i cu·ªëi c√πng
              <span class="sort-indicator">‚Üï</span>
            </th>
          </tr>
        </thead>
        <tbody id="tableBody">
        </tbody>
        <tfoot id="tableFooter">
        </tfoot>
      </table>
    </div>

    <div class="pagination" id="pagination" style="display: none;">
      <button id="firstPageBtn">‚èÆ ƒê·∫ßu</button>
      <button id="prevPageBtn">‚óÄ Tr∆∞·ªõc</button>
      <span class="pagination-info" id="pageInfo">Trang 1 / 1</span>
      <button id="nextPageBtn">Sau ‚ñ∂</button>
      <button id="lastPageBtn">Cu·ªëi ‚è≠</button>
      <div class="page-size-selector">
        <label>S·ªë d√≤ng/trang:</label>
        <select id="pageSizeSelect">
          <option value="50">50</option>
          <option value="100" selected>100</option>
          <option value="200">200</option>
          <option value="500">500</option>
        </select>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    const F3_URL = 'https://lumi-6dff7-default-rtdb.asia-southeast1.firebasedatabase.app/datasheet/F3.json';
    // Link HR ƒë·ªÉ l·∫•y ph√¢n quy·ªÅn
    const HR_URL = 'https://lumi-6dff7-default-rtdb.asia-southeast1.firebasedatabase.app/datasheet/Nh%C3%A2ns%E1%BB%B1';

    let allData = [];
    let filteredData = [];
    let currentPage = 1;
    let pageSize = 100;
    let totalPages = 1;
    let allowedStaffNames = null; // null = hi·ªÉn th·ªã t·∫•t c·∫£, Set = ch·ªâ hi·ªÉn th·ªã nh√¢n vi√™n trong Set
    let hrData = [];
    let currentEmployee = null; // L∆∞u th√¥ng tin nh√¢n vi√™n hi·ªán t·∫°i
    let currentBoPhan = null; // L∆∞u B·ªô ph·∫≠n c·ªßa nh√¢n vi√™n hi·ªán t·∫°i
    let sortState = { column: null, direction: 'asc' }; // Tr·∫°ng th√°i s·∫Øp x·∫øp
    let dataKeyMap = new Map(); // Map ƒë·ªÉ l∆∞u key c·ªßa Firebase cho m·ªói row (d√πng M√£_ƒë∆°n_h√†ng)
    let trangThaiCuoiCungOptions = []; // Danh s√°ch c√°c gi√° tr·ªã unique c·ªßa "Th·ªùi gian cutoff"

    // Format s·ªë ti·ªÅn (l√†m tr√≤n t·ªõi h√†ng ngh√¨n)
    function formatCurrency(value) {
      if (!value) return '0';
      const num = Number(value);
      // L√†m tr√≤n t·ªõi h√†ng ngh√¨n
      const rounded = Math.round(num / 1000) * 1000;
      return rounded.toLocaleString('vi-VN') + ' ‚Ç´';
    }

    // Helper function ƒë·ªÉ l·∫•y gi√° tr·ªã t·ª´ row v·ªõi nhi·ªÅu t√™n c·ªôt kh√°c nhau
    function getRowValue(row, ...columnNames) {
      for (const colName of columnNames) {
        if (row[colName] !== undefined && row[colName] !== null && row[colName] !== '') {
          return row[colName];
        }
      }
      return '';
    }

    // Format ng√†y
    function formatDate(dateStr) {
      if (!dateStr) return '';
      try {
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return dateStr;
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
      } catch {
        return dateStr;
      }
    }

    // Normalize d·ªØ li·ªáu F3
    function normalizeF3(data) {
      console.log('üîÑ normalizeF3 - input type:', typeof data, 'isArray:', Array.isArray(data));

      if (!data) {
        console.warn('‚ö†Ô∏è normalizeF3: data is null/undefined');
        return [];
      }

      if (Array.isArray(data)) {
        const filtered = data.filter(item => item && typeof item === 'object');
        console.log(`‚úÖ normalizeF3: Array with ${data.length} items, ${filtered.length} valid objects`);
        return filtered;
      }

      if (typeof data === 'object') {
        const values = Object.values(data);
        const filtered = values.filter(item => item && typeof item === 'object');
        console.log(`‚úÖ normalizeF3: Object with ${values.length} values, ${filtered.length} valid objects`);
        return filtered;
      }

      console.warn('‚ö†Ô∏è normalizeF3: Unknown data type:', typeof data);
      return [];
    }

    // Normalize d·ªØ li·ªáu HR
    function normalizeHR(data) {
      if (!data) return [];
      if (Array.isArray(data)) return data;
      if (typeof data === 'object') {
        return Object.values(data).filter(item => item && typeof item === 'object');
      }
      return [];
    }

    // L·∫•y tham s·ªë t·ª´ URL (h·ªó tr·ª£ c·∫£ query string v√† hash)
    function getQueryParam(key) {
      try {
        const params = new URLSearchParams(window.location.search);
        let val = params.get(key);
        if (!val) {
          const hash = window.location.hash || '';
          // support both #id=XXX or #...&id=XXX
          const match = hash.match(new RegExp(`[?#&]?(?:${key})=([^&]+)`));
          if (match && match[1]) val = decodeURIComponent(match[1]);
        }
        return val ? String(val).trim() : '';
      } catch (_) { return ''; }
    }

    // L·∫•y id t·ª´ URL parameter (gi·ªØ l·∫°i ƒë·ªÉ t∆∞∆°ng th√≠ch)
    function getUserIdFromURL() {
      return getQueryParam('id') || null;
    }

    // Load v√† x·ª≠ l√Ω d·ªØ li·ªáu nh√¢n vi√™n
    async function loadAndProcessHRData() {
      // Ki·ªÉm tra scope=allF3 tr∆∞·ªõc - n·∫øu c√≥ th√¨ b·ªè qua ph√¢n quy·ªÅn
      const scope = getQueryParam('scope');
      if (scope === 'allF3') {
        console.log('üìå scope=allF3 ƒë∆∞·ª£c set, b·ªè qua ph√¢n quy·ªÅn - xem t·∫•t c·∫£ d·ªØ li·ªáu');
        allowedStaffNames = null;
        currentEmployee = null;
        currentBoPhan = null;
        const greetingEl = document.getElementById('greeting');
        if (greetingEl) {
          greetingEl.textContent = '';
        }
        return;
      }

      const userId = getUserIdFromURL();

      // Lu√¥n load HR data ƒë·ªÉ s·ª≠ d·ª•ng cho filter (ngay c·∫£ khi kh√¥ng c√≥ id)
      try {
        // Fetch d·ªØ li·ªáu nh√¢n vi√™n t·ª´ HR link ƒë·ªÉ ph√¢n quy·ªÅn
        console.log('üì• ƒêang t·∫£i HR data t·ª´:', HR_URL + '.json');
        const hrResponse = await fetchWithRetry(HR_URL + '.json');
        hrData = normalizeHR(hrResponse);

        console.log('‚úÖ HR data ƒë√£ t·∫£i th√†nh c√¥ng:', hrData.length, 'nh√¢n vi√™n');

        // Ki·ªÉm tra n·∫øu kh√¥ng c√≥ HR data
        if (!Array.isArray(hrData) || !hrData.length) {
          console.warn('‚ö†Ô∏è Kh√¥ng c√≥ HR data, cho ph√©p xem t·∫•t c·∫£');
          allowedStaffNames = null;
          currentEmployee = null;
          currentBoPhan = null;
          const greetingEl = document.getElementById('greeting');
          if (greetingEl) {
            greetingEl.textContent = '';
          }
          return;
        }

        // N·∫øu kh√¥ng c√≥ id trong URL, cho ph√©p xem t·∫•t c·∫£ (admin mode) nh∆∞ng v·∫´n gi·ªØ HR data
        if (!userId) {
          console.log('üìå Kh√¥ng c√≥ id trong URL, hi·ªÉn th·ªã t·∫•t c·∫£ nh√¢n vi√™n (admin mode)');
          allowedStaffNames = null;
          currentEmployee = null;
          currentBoPhan = null;
          // ·∫®n ph·∫ßn ch√†o h·ªèi
          const greetingEl = document.getElementById('greeting');
          if (greetingEl) {
            greetingEl.textContent = '';
          }
          return;
        }

        // T√¨m nh√¢n vi√™n theo id (gi·ªëng KPIsale.html)
        const matchId = (row) => {
          const candidates = ['id', 'ID', 'Id', 'uid', 'UID', 'Uid', 'M√£ nh√¢n s·ª±', 'M√£_Nh√¢n_s·ª±', 'Ma_Nhan_su'];
          for (const k of candidates) {
            if (row[k] !== undefined && String(row[k]).trim() === userId) return true;
          }
          for (const k in row) {
            if (k && k.toLowerCase() === 'id' && String(row[k]).trim() === userId) return true;
          }
          return false;
        };

        const foundEmployee = hrData.find(matchId);

        if (!foundEmployee) {
          console.warn('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y nh√¢n vi√™n v·ªõi id:', userId);
          const greetingEl = document.getElementById('greeting');
          if (greetingEl) {
            greetingEl.textContent = `Kh√¥ng t√¨m th·∫•y id: ${userId} trong Nh√¢n s·ª±`;
          }
          allowedStaffNames = null;
          currentEmployee = null;
          currentBoPhan = null;
          return;
        }

        // G√°n cho bi·∫øn global
        currentEmployee = foundEmployee;

        // L·∫•y th√¥ng tin nh√¢n vi√™n v·ªõi nhi·ªÅu t√™n c·ªôt kh√°c nhau
        const viTri = (currentEmployee['V·ªã tr√≠'] ?? currentEmployee['Vi_tri'] ?? currentEmployee['Vi tr√≠'] ?? currentEmployee['Position'] ?? '').toString().trim();
        const team = (currentEmployee['Team'] ?? '').toString().trim();
        const hoVaTen = (currentEmployee['H·ªç V√† T√™n'] ?? currentEmployee['H·ªç_v√†_t√™n'] ?? currentEmployee['H·ªç v√† t√™n'] ?? currentEmployee['T√™n'] ?? currentEmployee['Name'] ?? '').toString().trim();
        const boPhan = (currentEmployee['B·ªô ph·∫≠n'] ?? currentEmployee['B·ªô_ph·∫≠n'] ?? currentEmployee['Bo_phan'] ?? '').toString().trim();

        // L∆∞u th√¥ng tin nh√¢n vi√™n hi·ªán t·∫°i
        // N·∫øu B·ªô ph·∫≠n = CSKH th√¨ x·ª≠ l√Ω nh∆∞ Sale
        currentBoPhan = (boPhan === 'CSKH') ? 'Sale' : boPhan;

        // X√°c ƒë·ªãnh Leader/NV
        const isLeader = /leader/i.test(viTri);
        const isNV = /^nv$/i.test(viTri) || viTri.toLowerCase() === 'nh√¢n vi√™n' || viTri === '';

        console.log('üë§ Nh√¢n vi√™n hi·ªán t·∫°i:', {
          id: userId,
          hoVaTen: hoVaTen,
          viTri: viTri,
          team: team,
          boPhan: boPhan,
          isLeader: isLeader,
          isNV: isNV
        });

        // Hi·ªÉn th·ªã ch√†o h·ªèi
        const greetingEl = document.getElementById('greeting');
        if (greetingEl && hoVaTen) {
          greetingEl.textContent = `üëã Xin ch√†o ${hoVaTen}${boPhan ? ` - ${boPhan}` : ''}`;
        }

        // X·ª≠ l√Ω ph√¢n quy·ªÅn theo v·ªã tr√≠
        const set = new Set();
        if (isLeader) {
          // Leader: xem full Team c·ªßa m√¨nh
          hrData.forEach(emp => {
            const empTeam = (emp['Team'] ?? '').toString().trim();
            if (empTeam === team && empTeam && empTeam !== 'ƒê√£ ngh·ªâ') {
              // L·∫•y t√™n v·ªõi nhi·ªÅu t√™n c·ªôt kh√°c nhau
              const name = (emp['H·ªç V√† T√™n'] ?? emp['H·ªç_v√†_t√™n'] ?? emp['H·ªç v√† t√™n'] ?? emp['T√™n'] ?? emp['Name'] ?? '').toString().trim();
              if (name) {
                set.add(name);
              }
            }
          });
          console.log('üëî Leader - Danh s√°ch nh√¢n vi√™n trong team:', Array.from(set));
        } else {
          // NV ho·∫∑c kh√¥ng ph·∫£i Leader: ch·ªâ xem c·ªßa ch√≠nh m√¨nh
          if (hoVaTen) {
            set.add(hoVaTen);
            console.log('üë∑ NV/Staff - Ch·ªâ hi·ªÉn th·ªã c·ªßa ch√≠nh m√¨nh:', hoVaTen);
            console.log('üìã B·ªô ph·∫≠n:', boPhan);
            console.log('‚úÖ S·∫Ω l·ªçc ƒë∆°n h√†ng c√≥:', {
              'Sale': boPhan === 'Sale' ? hoVaTen : 'N/A',
              'MKT': boPhan === 'MKT' ? hoVaTen : 'N/A',
              'V·∫≠n ƒê∆°n': (boPhan === 'V·∫≠n ƒê∆°n' || boPhan === 'V·∫≠n H√†nh') ? hoVaTen : 'N/A'
            });
          }
        }

        allowedStaffNames = set.size ? set : null;

      } catch (error) {
        console.error('‚ùå L·ªói khi load d·ªØ li·ªáu nh√¢n vi√™n:', error);
        allowedStaffNames = null;
        currentEmployee = null;
        currentBoPhan = null;
        // ·∫®n ph·∫ßn ch√†o h·ªèi
        const greetingEl = document.getElementById('greeting');
        if (greetingEl) {
          greetingEl.textContent = '';
        }
      }
    }

    // Fetch v·ªõi retry
    async function fetchWithRetry(url, options = {}) {
      const { retries = 3, delayMs = 500 } = options;
      for (let i = 0; i < retries; i++) {
        try {
          const response = await fetch(url);
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          return await response.json();
        } catch (error) {
          if (i === retries - 1) throw error;
          await new Promise(resolve => setTimeout(resolve, delayMs));
        }
      }
    }

    // Load d·ªØ li·ªáu
    async function loadData() {
      const loadingEl = document.getElementById('loading');
      const errorEl = document.getElementById('error');
      const tableEl = document.getElementById('dataTable');

      loadingEl.style.display = 'block';
      errorEl.style.display = 'none';
      tableEl.style.display = 'none';

      try {
        console.log('üîÑ B·∫Øt ƒë·∫ßu load d·ªØ li·ªáu...');

        // Load d·ªØ li·ªáu nh√¢n vi√™n tr∆∞·ªõc
        await loadAndProcessHRData();
        console.log('‚úÖ ƒê√£ load d·ªØ li·ªáu HR');

        // Load d·ªØ li·ªáu F3
        console.log('üì° ƒêang fetch d·ªØ li·ªáu F3 t·ª´:', F3_URL);
        const data = await fetchWithRetry(F3_URL);
        console.log('üì• ƒê√£ nh·∫≠n d·ªØ li·ªáu F3, ki·ªÉu:', typeof data, Array.isArray(data) ? 'Array' : 'Object');

        allData = normalizeF3(data);
        console.log(`‚úÖ ƒê√£ normalize F3 data, s·ªë l∆∞·ª£ng: ${allData.length} d√≤ng`);

        // X√¢y d·ª±ng mapping gi·ªØa M√£_ƒë∆°n_h√†ng v√† key trong Firebase
        dataKeyMap.clear();
        if (typeof data === 'object' && !Array.isArray(data)) {
          Object.keys(data).forEach(key => {
            const row = data[key];
            if (row && typeof row === 'object') {
              const maDonHang = getRowValue(row, 'M√£_ƒë∆°n_h√†ng', 'M√£ ƒë∆°n h√†ng') || '';
              if (maDonHang) {
                dataKeyMap.set(maDonHang, key);
              }
            }
          });
          console.log('üìã ƒê√£ t·∫°o mapping cho', dataKeyMap.size, 'ƒë∆°n h√†ng');
        }

        // L·∫•y danh s√°ch c√°c gi√° tr·ªã unique t·ª´ c·ªôt "Th·ªùi gian cutoff"
        const cutoffSet = new Set();
        allData.forEach(row => {
          const cutoff = getRowValue(row, 'Th·ªùi_gian_cutoff', 'Th·ªùi gian cutoff', 'Th·ªùi_gian_Cutoff', 'Th·ªùi gian Cutoff') || '';
          if (cutoff && cutoff.trim() !== '') {
            cutoffSet.add(cutoff.trim());
          }
        });
        trangThaiCuoiCungOptions = Array.from(cutoffSet).sort();
        console.log('üìã Danh s√°ch c√°c gi√° tr·ªã "Th·ªùi gian cutoff":', trangThaiCuoiCungOptions);

        // Debug: Ki·ªÉm tra t√™n c·ªôt th·ª±c t·∫ø trong d·ªØ li·ªáu (ƒë·∫∑c bi·ªát l√† c·ªôt T·ªïng ti·ªÅn)
        if (allData.length > 0) {
          const firstRow = allData[0];
          const allKeys = Object.keys(firstRow);
          console.log('üìã T·∫•t c·∫£ c√°c c·ªôt trong d·ªØ li·ªáu:', allKeys);
          console.log('üîç M·∫´u d√≤ng ƒë·∫ßu ti√™n:', firstRow);

          // T√¨m c√°c c·ªôt c√≥ ch·ª©a "ti·ªÅn" ho·∫∑c "tien" ho·∫∑c "VND"
          const tienColumns = allKeys.filter(key =>
            key.toLowerCase().includes('ti·ªÅn') ||
            key.toLowerCase().includes('tien') ||
            key.toLowerCase().includes('vnd') ||
            key.toLowerCase().includes('tong')
          );
          console.log('üí∞ C√°c c·ªôt li√™n quan ƒë·∫øn ti·ªÅn:', tienColumns);

          // Log gi√° tr·ªã c·ªßa m·ªôt v√†i d√≤ng ƒë·∫ßu ti√™n ƒë·ªÉ debug
          tienColumns.forEach(col => {
            console.log(`  - ${col}:`, firstRow[col]);
          });
        } else {
          console.warn('‚ö†Ô∏è allData r·ªóng sau khi normalize!');
          console.log('üì¶ D·ªØ li·ªáu g·ªëc:', data);
        }

        filteredData = [...allData];
        console.log(`üìä filteredData ban ƒë·∫ßu: ${filteredData.length} d√≤ng`);

        currentPage = 1; // Reset v·ªÅ trang 1 khi load l·∫°i
        populateFilters();
        console.log('‚úÖ ƒê√£ populate filters');

        // √Åp d·ª•ng filter ngay sau khi populate ƒë·ªÉ l·ªçc theo id (n·∫øu c√≥)
        applyFilters();
        console.log(`üìä filteredData sau khi apply filters: ${filteredData.length} d√≤ng`);

        updateStats();
        renderTable();
        loadingEl.style.display = 'none';
        tableEl.style.display = 'table'; // ƒê·∫£m b·∫£o b·∫£ng ƒë∆∞·ª£c hi·ªÉn th·ªã
        console.log('‚úÖ ƒê√£ render b·∫£ng th√†nh c√¥ng');
        console.log('üìä T·ªïng s·ªë d√≤ng d·ªØ li·ªáu:', allData.length);
        console.log('üìä S·ªë d√≤ng sau khi filter:', filteredData.length);
        console.log('üë• HR data c√≥', hrData.length, 'nh√¢n vi√™n');
      } catch (error) {
        console.error('‚ùå Error loading data:', error);
        console.error('Stack trace:', error.stack);
        loadingEl.style.display = 'none';
        errorEl.style.display = 'block';
        errorEl.textContent = `‚ùå L·ªói t·∫£i d·ªØ li·ªáu: ${error.message}. Vui l√≤ng m·ªü Console (F12) ƒë·ªÉ xem chi ti·∫øt.`;
      }
    }

    // C·∫≠p nh·∫≠t th·ªëng k√™
    function updateStats() {
      const statsEl = document.getElementById('stats');
      const start = (currentPage - 1) * pageSize + 1;
      const end = Math.min(currentPage * pageSize, filteredData.length);
      statsEl.textContent = `üìä T·ªïng s·ªë: ${allData.length.toLocaleString('vi-VN')} ƒë∆°n | L·ªçc ƒë∆∞·ª£c: ${filteredData.length.toLocaleString('vi-VN')} ƒë∆°n | Hi·ªÉn th·ªã: ${start.toLocaleString('vi-VN')}-${end.toLocaleString('vi-VN')}`;
    }

    // T√≠nh to√°n ph√¢n trang
    function calculatePagination() {
      totalPages = Math.max(1, Math.ceil(filteredData.length / pageSize));
      if (currentPage > totalPages) {
        currentPage = totalPages;
      }
    }

    // H√†m s·∫Øp x·∫øp d·ªØ li·ªáu
    function sortData(column) {
      if (sortState.column === column) {
        // ƒê·∫£o chi·ªÅu s·∫Øp x·∫øp n·∫øu click v√†o c√πng c·ªôt
        sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
      } else {
        sortState.column = column;
        sortState.direction = 'asc';
      }

      filteredData.sort((a, b) => {
        let aVal, bVal;

        if (column === 'trangThaiCuoiCung') {
          aVal = getRowValue(a, 'Th·ªùi_gian_cutoff', 'Th·ªùi gian cutoff', 'Th·ªùi_gian_Cutoff', 'Th·ªùi gian Cutoff') || '';
          bVal = getRowValue(b, 'Th·ªùi_gian_cutoff', 'Th·ªùi gian cutoff', 'Th·ªùi_gian_Cutoff', 'Th·ªùi gian Cutoff') || '';
        } else {
          return 0;
        }

        aVal = String(aVal).trim().toLowerCase();
        bVal = String(bVal).trim().toLowerCase();

        if (sortState.direction === 'asc') {
          return aVal.localeCompare(bVal, 'vi');
        } else {
          return bVal.localeCompare(aVal, 'vi');
        }
      });

      // C·∫≠p nh·∫≠t UI sort indicator
      document.querySelectorAll('.sortable').forEach(th => {
        th.classList.remove('asc', 'desc');
      });
      const sortableTh = document.querySelector(`.sortable[data-sort="${column}"]`);
      if (sortableTh) {
        sortableTh.classList.add(sortState.direction);
      }

      currentPage = 1; // Reset v·ªÅ trang 1
      renderTable();
    }

    // H√†m l∆∞u gi√° tr·ªã "Th·ªùi gian cutoff" v√†o Firebase
    async function saveTrangThaiCuoiCung(maDonHang, newValue) {
      const firebaseKey = dataKeyMap.get(maDonHang);
      if (!firebaseKey) {
        console.error('‚ùå Kh√¥ng t√¨m th·∫•y key Firebase cho ƒë∆°n h√†ng:', maDonHang);
        alert('Kh√¥ng t√¨m th·∫•y key ƒë·ªÉ l∆∞u d·ªØ li·ªáu. Vui l√≤ng l√†m m·ªõi trang v√† th·ª≠ l·∫°i.');
        return false;
      }

      const updateUrl = `https://lumi-6dff7-default-rtdb.asia-southeast1.firebasedatabase.app/datasheet/F3/${firebaseKey}/Th·ªùi_gian_cutoff.json`;

      try {
        const response = await fetch(updateUrl, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(newValue)
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        // C·∫≠p nh·∫≠t d·ªØ li·ªáu local
        const row = allData.find(r => {
          const md = getRowValue(r, 'M√£_ƒë∆°n_h√†ng', 'M√£ ƒë∆°n h√†ng') || '';
          return md === maDonHang;
        });
        if (row) {
          // C·∫≠p nh·∫≠t t·∫•t c·∫£ c√°c t√™n c·ªôt c√≥ th·ªÉ
          row['Th·ªùi_gian_cutoff'] = newValue;
          row['Th·ªùi gian cutoff'] = newValue;
          row['Th·ªùi_gian_Cutoff'] = newValue;
          row['Th·ªùi gian Cutoff'] = newValue;
        }

        // C·∫≠p nh·∫≠t filteredData
        const filteredRow = filteredData.find(r => {
          const md = getRowValue(r, 'M√£_ƒë∆°n_h√†ng', 'M√£ ƒë∆°n h√†ng') || '';
          return md === maDonHang;
        });
        if (filteredRow) {
          filteredRow['Th·ªùi_gian_cutoff'] = newValue;
          filteredRow['Th·ªùi gian cutoff'] = newValue;
          filteredRow['Th·ªùi_gian_Cutoff'] = newValue;
          filteredRow['Th·ªùi gian Cutoff'] = newValue;
        }

        // Th√™m gi√° tr·ªã m·ªõi v√†o danh s√°ch options n·∫øu ch∆∞a c√≥
        if (newValue && newValue.trim() !== '' && !trangThaiCuoiCungOptions.includes(newValue.trim())) {
          trangThaiCuoiCungOptions.push(newValue.trim());
          trangThaiCuoiCungOptions.sort();
        }

        console.log('‚úÖ ƒê√£ l∆∞u th√†nh c√¥ng:', { maDonHang, newValue, firebaseKey });
        return true;
      } catch (error) {
        console.error('‚ùå L·ªói khi l∆∞u d·ªØ li·ªáu:', error);
        alert(`L·ªói khi l∆∞u d·ªØ li·ªáu: ${error.message}`);
        return false;
      }
    }

    // Render b·∫£ng
    function renderTable() {
      const tbody = document.getElementById('tableBody');
      const tableEl = document.getElementById('dataTable');
      const paginationEl = document.getElementById('pagination');

      tbody.innerHTML = '';

      console.log('üé® renderTable called, filteredData.length:', filteredData.length);

      if (filteredData.length === 0) {
        console.warn('‚ö†Ô∏è filteredData r·ªóng, hi·ªÉn th·ªã th√¥ng b√°o "Kh√¥ng c√≥ d·ªØ li·ªáu"');
        tbody.innerHTML = '<tr><td colspan="14" class="text-center">Kh√¥ng c√≥ d·ªØ li·ªáu. Vui l√≤ng ki·ªÉm tra b·ªô l·ªçc ho·∫∑c m·ªü Console (F12) ƒë·ªÉ xem chi ti·∫øt.</td></tr>';
        tableEl.style.display = 'table';
        paginationEl.style.display = 'none';
        document.getElementById('tableFooter').innerHTML = '';
        document.getElementById('summaryTable').style.display = 'none';
        return;
      }

      // S·∫Øp x·∫øp d·ªØ li·ªáu: c√°c d√≤ng c√≥ "Tr·∫°ng th√°i cu·ªëi c√πng" tr·ªëng l√™n ƒë·∫ßu
      filteredData.sort((a, b) => {
        const aTrangThai = String(getRowValue(a, 'Th·ªùi_gian_cutoff', 'Th·ªùi gian cutoff', 'Th·ªùi_gian_Cutoff', 'Th·ªùi gian Cutoff') || '').trim();
        const bTrangThai = String(getRowValue(b, 'Th·ªùi_gian_cutoff', 'Th·ªùi gian cutoff', 'Th·ªùi_gian_Cutoff', 'Th·ªùi gian Cutoff') || '').trim();

        const aEmpty = !aTrangThai || aTrangThai === '';
        const bEmpty = !bTrangThai || bTrangThai === '';

        // N·∫øu m·ªôt trong hai tr·ªëng, ƒë∆∞a tr·ªëng l√™n ƒë·∫ßu
        if (aEmpty && !bEmpty) return -1;
        if (!aEmpty && bEmpty) return 1;

        // N·∫øu c·∫£ hai ƒë·ªÅu tr·ªëng ho·∫∑c c·∫£ hai ƒë·ªÅu c√≥ gi√° tr·ªã, s·∫Øp x·∫øp theo tr·∫°ng th√°i
        if (aEmpty && bEmpty) return 0;

        // S·∫Øp x·∫øp theo tr·∫°ng th√°i (alphabetical)
        return aTrangThai.localeCompare(bTrangThai, 'vi');
      });

      calculatePagination();

      // Render b·∫£ng th√¥ng s·ªë t·ªïng h·ª£p
      renderSummaryTable();

      // L·∫•y d·ªØ li·ªáu c·ªßa trang hi·ªán t·∫°i
      const startIndex = (currentPage - 1) * pageSize;
      const endIndex = startIndex + pageSize;
      const pageData = filteredData.slice(startIndex, endIndex);

      pageData.forEach((row, index) => {
        const globalIndex = startIndex + index;
        const tr = document.createElement('tr');

        // S·ª≠ d·ª•ng t√™n c·ªôt v·ªõi d·∫•u g·∫°ch d∆∞·ªõi (theo c·∫•u tr√∫c d·ªØ li·ªáu th·ª±c t·∫ø)
        const maDonHang = getRowValue(row, 'M√£_ƒë∆°n_h√†ng', 'M√£ ƒë∆°n h√†ng') || '';
        const ngayLenDon = formatDate(getRowValue(row, 'Ng√†y_l√™n_ƒë∆°n', 'Ng√†y l√™n ƒë∆°n', 'Th·ªùi gian l√™n ƒë∆°n'));
        const name = getRowValue(row, 'Name', 'Name*', 'T√™n l√™n ƒë∆°n') || '';
        const phone = getRowValue(row, 'Phone', 'Phone*', 'phone', 'phone*') || '';
        const add = getRowValue(row, 'Add', 'add', 'ƒê·ªãa ch·ªâ', 'ƒê·ªãa_ch·ªâ') || '';
        // Th·ª≠ nhi·ªÅu t√™n c·ªôt kh√°c nhau cho T·ªïng ti·ªÅn VNƒê
        const tongTien = formatCurrency(getRowValue(row, 'T·ªïng_ti·ªÅn_VNƒê', 'T·ªïng ti·ªÅn VNƒê', 'T·ªïng Ti·ªÅn VNƒê', 'T·ªïng_ti·ªÅn_VND', 'T·ªïng ti·ªÅn') || 0);
        const nvSale = getRowValue(row, 'Nh√¢n_vi√™n_Sale', 'Nh√¢n vi√™n Sale') || '';
        const cskh = getRowValue(
          row,
          'CSKH',
          'NV_CSKH',
          'NV CSKH',
          'Nh√¢n_vi√™n_CSKH',
          'Nh√¢n vi√™n CSKH',
          'ChƒÉm s√≥c KH',
          'ChƒÉm s√≥c kh√°ch h√†ng'
        ) || '';
        const matHang = getRowValue(row, 'M·∫∑t_h√†ng', 'M·∫∑t h√†ng') || '';
        const khuVuc = getRowValue(row, 'Khu_v·ª±c', 'Khu v·ª±c') || '';

        const phiShip = formatCurrency(getRowValue(row, 'Ph√≠_ship', 'Ph√≠ ship') || 0);
        const tienVietDoiSoat = formatCurrency(getRowValue(row, 'Ti·ªÅn_Vi·ªát_ƒë√£_ƒë·ªëi_so√°t', 'Ti·ªÅn Vi·ªát ƒë√£ ƒë·ªëi so√°t') || 0);
        const trangThaiCuoiCung = getRowValue(row, 'Th·ªùi_gian_cutoff', 'Th·ªùi gian cutoff', 'Th·ªùi_gian_Cutoff', 'Th·ªùi gian Cutoff') || '';

        // T·∫°o dropdown select cho c·ªôt "Tr·∫°ng th√°i cu·ªëi c√πng"
        let selectOptions = '<option value="">-- Ch·ªçn --</option>';
        trangThaiCuoiCungOptions.forEach(opt => {
          const selected = opt === trangThaiCuoiCung ? 'selected' : '';
          selectOptions += `<option value="${opt.replace(/"/g, '&quot;')}" ${selected}>${opt}</option>`;
        });
        // Th√™m option hi·ªán t·∫°i n·∫øu ch∆∞a c√≥ trong danh s√°ch
        if (trangThaiCuoiCung && !trangThaiCuoiCungOptions.includes(trangThaiCuoiCung)) {
          selectOptions += `<option value="${trangThaiCuoiCung.replace(/"/g, '&quot;')}" selected>${trangThaiCuoiCung}</option>`;
        }

        tr.innerHTML = `
          <td class="text-center">${globalIndex + 1}</td>
          <td>${maDonHang}</td>
          <td>${ngayLenDon}</td>
          <td>${name}</td>
          <td>${phone}</td>
          <td>${add}</td>
          <td>${nvSale}</td>
          <td>${cskh}</td>
          <td>${matHang}</td>
          <td>${khuVuc}</td>
          <td class="text-right">${tongTien}</td>
          <td class="text-right" style="display: none;">${phiShip}</td>
          <td class="text-right" style="display: none;">${tienVietDoiSoat}</td>
          <td>
            <select class="status-select" data-ma-don="${maDonHang.replace(/"/g, '&quot;')}" onchange="handleTrangThaiCuoiCungChange(this)">
              ${selectOptions}
            </select>
          </td>
        `;

        tbody.appendChild(tr);
      });

      tableEl.style.display = 'table';
      updatePaginationControls();

      // G·∫Øn event listener cho sortable header sau khi render
      const sortableHeader = document.querySelector('.sortable[data-sort="trangThaiCuoiCung"]');
      if (sortableHeader) {
        // X√≥a listener c≈© n·∫øu c√≥
        const newSortableHeader = sortableHeader.cloneNode(true);
        sortableHeader.parentNode.replaceChild(newSortableHeader, sortableHeader);
        // G·∫Øn listener m·ªõi
        newSortableHeader.addEventListener('click', function () {
          sortData('trangThaiCuoiCung');
        });
      }
    }

    // Render b·∫£ng th√¥ng s·ªë t·ªïng h·ª£p
    function renderSummaryTable() {
      const summaryTable = document.getElementById('summaryTable');
      if (!summaryTable) return;

      let totalTongTien = 0;
      let totalPhiShip = 0;
      let totalTienVietDoiSoat = 0;

      // Theo d√µi c√°c m√£ ƒë∆°n h√†ng ƒë√£ g·∫∑p ƒë·ªÉ lo·∫°i b·ªè tr√πng l·∫∑p
      const seenCodes = new Set();
      let totalDon = 0;
      let soDonCSKH = 0; // S·ªë ƒë∆°n c·ªßa CSKH (CSKH === Nh√¢n vi√™n Sale)
      let soDonDuocChia = 0; // S·ªë ƒë∆°n ƒë∆∞·ª£c chia (c√≥ CSKH nh∆∞ng CSKH !== Nh√¢n vi√™n Sale)

      filteredData.forEach(row => {
        const maDonHang = String(getRowValue(row, 'M√£_ƒë∆°n_h√†ng', 'M√£ ƒë∆°n h√†ng') || '').trim();

        // Ch·ªâ t√≠nh n·∫øu m√£ ƒë∆°n h√†ng ch∆∞a xu·∫•t hi·ªán (kh√¥ng tr√πng)
        if (maDonHang && !seenCodes.has(maDonHang)) {
          seenCodes.add(maDonHang);
          totalDon++;

          // Th·ª≠ nhi·ªÅu t√™n c·ªôt kh√°c nhau cho T·ªïng ti·ªÅn VNƒê
          const tongTienValue = getRowValue(row, 'T·ªïng_ti·ªÅn_VNƒê', 'T·ªïng ti·ªÅn VNƒê', 'T·ªïng Ti·ªÅn VNƒê', 'T·ªïng_ti·ªÅn_VND', 'T·ªïng ti·ªÅn') || 0;
          totalTongTien += Number(tongTienValue || 0);
          totalPhiShip += Number(getRowValue(row, 'Ph√≠_ship', 'Ph√≠ ship') || 0);
          totalTienVietDoiSoat += Number(getRowValue(row, 'Ti·ªÅn_Vi·ªát_ƒë√£_ƒë·ªëi_so√°t', 'Ti·ªÅn Vi·ªát ƒë√£ ƒë·ªëi so√°t') || 0);

          // L·∫•y gi√° tr·ªã CSKH v√† Nh√¢n vi√™n Sale
          const cskh = String(getRowValue(
            row,
            'CSKH',
            'NV_CSKH',
            'NV CSKH',
            'Nh√¢n_vi√™n_CSKH',
            'Nh√¢n vi√™n CSKH',
            'ChƒÉm s√≥c KH',
            'ChƒÉm s√≥c kh√°ch h√†ng'
          ) || '').trim();

          const nvSale = String(getRowValue(row, 'Nh√¢n_vi√™n_Sale', 'Nh√¢n vi√™n Sale') || '').trim();

          // T√≠nh s·ªë ƒë∆°n c·ªßa CSKH: CSKH === Nh√¢n vi√™n Sale v√† c·∫£ 2 ƒë·ªÅu kh√¥ng tr·ªëng
          if (cskh && nvSale && cskh === nvSale) {
            soDonCSKH++;
          }

          // T√≠nh s·ªë ƒë∆°n ƒë∆∞·ª£c chia: c√≥ CSKH nh∆∞ng CSKH !== Nh√¢n vi√™n Sale (ho·∫∑c Nh√¢n vi√™n Sale tr·ªëng)
          if (cskh && cskh !== nvSale) {
            soDonDuocChia++;
          }
        }
      });

      // C·∫≠p nh·∫≠t c√°c gi√° tr·ªã trong b·∫£ng th√¥ng s·ªë
      document.getElementById('summaryTotalDon').textContent = totalDon.toLocaleString('vi-VN') + ' ƒë∆°n';
      document.getElementById('summaryTotalTongTien').textContent = formatCurrency(totalTongTien);
      document.getElementById('summaryTotalPhiShip').textContent = formatCurrency(totalPhiShip);
      document.getElementById('summaryTotalTienVietDoiSoat').textContent = formatCurrency(totalTienVietDoiSoat);
      document.getElementById('summarySoDonCSKH').textContent = soDonCSKH.toLocaleString('vi-VN') + ' ƒë∆°n';
      document.getElementById('summarySoDonDuocChia').textContent = soDonDuocChia.toLocaleString('vi-VN') + ' ƒë∆°n';

      // Hi·ªÉn th·ªã b·∫£ng th√¥ng s·ªë
      summaryTable.style.display = 'table';
    }

    // C·∫≠p nh·∫≠t controls ph√¢n trang
    function updatePaginationControls() {
      const paginationEl = document.getElementById('pagination');
      const pageInfoEl = document.getElementById('pageInfo');
      const firstBtn = document.getElementById('firstPageBtn');
      const prevBtn = document.getElementById('prevPageBtn');
      const nextBtn = document.getElementById('nextPageBtn');
      const lastBtn = document.getElementById('lastPageBtn');

      if (filteredData.length === 0) {
        paginationEl.style.display = 'none';
        return;
      }

      paginationEl.style.display = 'flex';
      pageInfoEl.textContent = `Trang ${currentPage} / ${totalPages}`;

      firstBtn.disabled = currentPage === 1;
      prevBtn.disabled = currentPage === 1;
      nextBtn.disabled = currentPage === totalPages;
      lastBtn.disabled = currentPage === totalPages;
    }

    // Chuy·ªÉn trang
    function goToPage(page) {
      if (page < 1 || page > totalPages) return;
      currentPage = page;
      renderTable();
      updateStats();
      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Populate checkbox filter cho CSKH (Team L√Ω)
    function populateNVSaleCheckboxes() {
      const select = document.getElementById('filterCSKH');
      if (!select) return;

      // L·∫•y danh s√°ch nh√¢n vi√™n thu·ªôc team "CSKH- L√Ω" t·ª´ HR data
      const teamLyMembers = new Set();
      hrData.forEach(emp => {
        const team = (emp['Team'] || '').toString().trim();
        if (team === 'CSKH- L√Ω') {
          const hoVaTen = (emp['H·ªç V√† T√™n'] ?? emp['H·ªç_v√†_t√™n'] ?? emp['H·ªç v√† t√™n'] ?? emp['T√™n'] ?? emp['Name'] ?? '').toString().trim();
          if (hoVaTen) {
            teamLyMembers.add(hoVaTen);
          }
        }
      });

      // L·∫•y danh s√°ch CSKH t·ª´ d·ªØ li·ªáu F3 (ch·ªâ l·∫•y nh·ªØng ng∆∞·ªùi trong team L√Ω)
      const cskhValues = new Set();
      allData.forEach(row => {
        const cskh = String(getRowValue(
          row,
          'CSKH',
          'NV_CSKH',
          'NV CSKH',
          'Nh√¢n_vi√™n_CSKH',
          'Nh√¢n vi√™n CSKH',
          'ChƒÉm s√≥c KH',
          'ChƒÉm s√≥c kh√°ch h√†ng'
        ) || '').trim();
        if (cskh && teamLyMembers.has(cskh)) {
          cskhValues.add(cskh);
        }
      });

      const sortedValues = Array.from(cskhValues).sort();

      // X√≥a c√°c option c≈© (tr·ª´ option ƒë·∫ßu ti√™n)
      const firstOption = select.querySelector('option');
      const firstOptionText = firstOption ? firstOption.textContent : 'T·∫•t c·∫£';
      select.innerHTML = '';

      // Th√™m l·∫°i option ƒë·∫ßu ti√™n
      const allOption = document.createElement('option');
      allOption.value = '';
      allOption.textContent = firstOptionText;
      select.appendChild(allOption);

      // Th√™m option "Tr·ªëng"
      const emptyOption = document.createElement('option');
      emptyOption.value = '__EMPTY__';
      emptyOption.textContent = 'Tr·ªëng';
      select.appendChild(emptyOption);

      // Th√™m c√°c options t·ª´ sortedValues
      sortedValues.forEach(value => {
        const option = document.createElement('option');
        option.value = value;
        option.textContent = value;
        select.appendChild(option);
      });

      // Th√™m event listener
      select.addEventListener('change', applyFilters);
    }

    // Populate filter dropdowns
    function populateFilters() {
      // Populate dropdown cho CSKH (Team L√Ω)
      populateNVSaleCheckboxes();

      // Populate dropdown cho Tr·∫°ng th√°i cu·ªëi c√πng
      const selectTrangThai = document.getElementById('filterTrangThaiCuoiCung');
      if (selectTrangThai) {
        // X√≥a c√°c option c≈© (tr·ª´ option ƒë·∫ßu ti√™n)
        const firstOption = selectTrangThai.querySelector('option');
        const firstOptionText = firstOption ? firstOption.textContent : 'T·∫•t c·∫£';
        selectTrangThai.innerHTML = '';

        // Th√™m l·∫°i option ƒë·∫ßu ti√™n
        const allOption = document.createElement('option');
        allOption.value = '';
        allOption.textContent = firstOptionText;
        selectTrangThai.appendChild(allOption);

        // Th√™m option "Tr·ªëng"
        const emptyOption = document.createElement('option');
        emptyOption.value = '__EMPTY__';
        emptyOption.textContent = 'Tr·ªëng';
        selectTrangThai.appendChild(emptyOption);

        // Th√™m c√°c options t·ª´ trangThaiCuoiCungOptions
        trangThaiCuoiCungOptions.forEach(value => {
          const option = document.createElement('option');
          option.value = value;
          option.textContent = value;
          selectTrangThai.appendChild(option);
        });

        // Th√™m event listener
        selectTrangThai.addEventListener('change', applyFilters);
      }
    }

    // L·∫•y gi√° tr·ªã ƒë√£ ch·ªçn t·ª´ dropdown
    function getSelectedFilterValue(filterId) {
      const select = document.getElementById(filterId);
      if (!select) return '';
      return select.value.trim();
    }

    // L·ªçc d·ªØ li·ªáu
    function applyFilters() {
      const searchText = document.getElementById('searchInput').value.toLowerCase().trim();
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;

      // Reset v·ªÅ trang 1 khi filter
      currentPage = 1;

      // L·∫•y gi√° tr·ªã filter CSKH t·ª´ dropdown
      const selectedCSKH = getSelectedFilterValue('filterCSKH');

      // L·∫•y gi√° tr·ªã filter Tr·∫°ng th√°i cu·ªëi c√πng
      const selectedTrangThaiCuoiCung = getSelectedFilterValue('filterTrangThaiCuoiCung');

      filteredData = allData.filter(row => {
        // L·ªçc theo CSKH (dropdown filter)
        if (selectedCSKH) {
          const cskhRaw = getRowValue(
            row,
            'CSKH',
            'NV_CSKH',
            'NV CSKH',
            'Nh√¢n_vi√™n_CSKH',
            'Nh√¢n vi√™n CSKH',
            'ChƒÉm s√≥c KH',
            'ChƒÉm s√≥c kh√°ch h√†ng'
          );
          const cskh = String(cskhRaw || '').trim();

          if (selectedCSKH === '__EMPTY__') {
            // L·ªçc c√°c d√≤ng c√≥ CSKH tr·ªëng
            if (cskh !== '') {
              return false;
            }
          } else {
            // L·ªçc c√°c d√≤ng c√≥ CSKH kh·ªõp v·ªõi gi√° tr·ªã ƒë√£ ch·ªçn
            if (cskh !== selectedCSKH) {
              return false;
            }
          }
        }
        // L·ªçc theo nh√¢n vi√™n ƒë∆∞·ª£c ph√©p xem (n·∫øu c√≥ gi·ªõi h·∫°n) - ∆ØU TI√äN CAO NH·∫§T
        // Ki·ªÉm tra n·∫øu c√≥ currentEmployee v√† allowedStaffNames (c√≥ id trong URL)
        // Ph√¢n quy·ªÅn kh·ªõp v·ªõi c·ªôt CSKH
        if (currentEmployee && allowedStaffNames !== null) {
          const viTri = String(currentEmployee['V·ªã tr√≠'] || '').trim();
          const hoVaTen = String(currentEmployee['H·ªç V√† T√™n'] || '').trim();

          // L·∫•y gi√° tr·ªã CSKH t·ª´ d√≤ng d·ªØ li·ªáu
          const cskh = String(getRowValue(
            row,
            'CSKH',
            'NV_CSKH',
            'NV CSKH',
            'Nh√¢n_vi√™n_CSKH',
            'Nh√¢n vi√™n CSKH',
            'ChƒÉm s√≥c KH',
            'ChƒÉm s√≥c kh√°ch h√†ng'
          ) || '').trim();

          // N·∫øu l√† NV, ch·ªâ hi·ªÉn th·ªã ƒë∆°n h√†ng c√≥ CSKH === t√™n c·ªßa h·ªç
          if (viTri === 'NV' || viTri === '') {
            if (cskh !== hoVaTen) {
              return false;
            }
          }
          // N·∫øu l√† Leader, hi·ªÉn th·ªã ƒë∆°n h√†ng c√≥ CSKH trong danh s√°ch team
          else if (viTri === 'Leader') {
            if (!cskh || !allowedStaffNames.has(cskh)) {
              return false;
            }
          }
        }

        // T√¨m ki·∫øm text
        if (searchText) {
          const searchableText = Object.values(row)
            .map(v => String(v || '').toLowerCase())
            .join(' ');
          if (!searchableText.includes(searchText)) return false;
        }

        // L·ªçc theo ng√†y
        if (startDate || endDate) {
          const rowDate = getRowValue(row, 'Ng√†y_l√™n_ƒë∆°n', 'Ng√†y l√™n ƒë∆°n', 'Th·ªùi gian l√™n ƒë∆°n');
          if (!rowDate) return false;

          try {
            const date = new Date(rowDate);
            if (isNaN(date.getTime())) return false;

            if (startDate) {
              const start = new Date(startDate);
              start.setHours(0, 0, 0, 0);
              if (date < start) return false;
            }

            if (endDate) {
              const end = new Date(endDate);
              end.setHours(23, 59, 59, 999);
              if (date > end) return false;
            }
          } catch {
            return false;
          }
        }

        // Filter Tr·∫°ng th√°i cu·ªëi c√πng
        if (selectedTrangThaiCuoiCung) {
          const trangThaiCuoiCung = String(getRowValue(row, 'Th·ªùi_gian_cutoff', 'Th·ªùi gian cutoff', 'Th·ªùi_gian_Cutoff', 'Th·ªùi gian Cutoff') || '').trim();
          if (selectedTrangThaiCuoiCung === '__EMPTY__') {
            if (trangThaiCuoiCung !== '') return false;
          } else {
            if (trangThaiCuoiCung !== selectedTrangThaiCuoiCung) return false;
          }
        }

        return true;
      });

      updateStats();
      renderTable();
    }

    // Xu·∫•t Excel
    function exportToExcel() {
      // Xu·∫•t theo b·ªô l·ªçc (filteredData)
      if (filteredData.length === 0) {
        alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!');
        return;
      }

      const headers = [
        'STT',
        'M√£ ƒë∆°n h√†ng',
        'Ng√†y l√™n ƒë∆°n',
        'Name*',
        'Phone*',
        'Add',
        'Nh√¢n vi√™n Sale',
        'CSKH',
        'M·∫∑t h√†ng',
        'Khu v·ª±c',
        'T·ªïng ti·ªÅn VNƒê',
        'Ph√≠ ship',
        'Ti·ªÅn Vi·ªát ƒë√£ ƒë·ªëi so√°t',
        'Tr·∫°ng th√°i cu·ªëi c√πng'
      ];

      const excelData = [headers];

      filteredData.forEach((row, index) => {
        // Th·ª≠ nhi·ªÅu t√™n c·ªôt kh√°c nhau cho T·ªïng ti·ªÅn VNƒê
        const tongTienValue = getRowValue(row, 'T·ªïng_ti·ªÅn_VNƒê', 'T·ªïng ti·ªÅn VNƒê', 'T·ªïng Ti·ªÅn VNƒê', 'T·ªïng_ti·ªÅn_VND', 'T·ªïng ti·ªÅn') || 0;
        const cskhValue = getRowValue(
          row,
          'CSKH',
          'NV_CSKH',
          'NV CSKH',
          'Nh√¢n_vi√™n_CSKH',
          'Nh√¢n vi√™n CSKH',
          'ChƒÉm s√≥c KH',
          'ChƒÉm s√≥c kh√°ch h√†ng'
        ) || '';
        excelData.push([
          index + 1,
          getRowValue(row, 'M√£_ƒë∆°n_h√†ng', 'M√£ ƒë∆°n h√†ng') || '',
          formatDate(getRowValue(row, 'Ng√†y_l√™n_ƒë∆°n', 'Ng√†y l√™n ƒë∆°n', 'Th·ªùi gian l√™n ƒë∆°n')),
          getRowValue(row, 'Name', 'Name*', 'T√™n l√™n ƒë∆°n') || '',
          getRowValue(row, 'Phone', 'Phone*', 'phone', 'phone*') || '',
          getRowValue(row, 'Add', 'add', 'ƒê·ªãa ch·ªâ', 'ƒê·ªãa_ch·ªâ') || '',
          getRowValue(row, 'Nh√¢n_vi√™n_Sale', 'Nh√¢n vi√™n Sale') || '',
          cskhValue,
          getRowValue(row, 'M·∫∑t_h√†ng', 'M·∫∑t h√†ng') || '',
          getRowValue(row, 'Khu_v·ª±c', 'Khu v·ª±c') || '',
          tongTienValue || 0,
          getRowValue(row, 'Ph√≠_ship', 'Ph√≠ ship') || 0,
          getRowValue(row, 'Ti·ªÅn_Vi·ªát_ƒë√£_ƒë·ªëi_so√°t', 'Ti·ªÅn Vi·ªát ƒë√£ ƒë·ªëi so√°t') || 0,
          getRowValue(row, 'Th·ªùi_gian_cutoff', 'Th·ªùi gian cutoff', 'Th·ªùi_gian_Cutoff', 'Th·ªùi gian Cutoff') || ''
        ]);
      });

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(excelData);

      // Thi·∫øt l·∫≠p ƒë·ªô r·ªông c·ªôt t·ª± ƒë·ªông
      const colWidths = [];
      headers.forEach(() => {
        colWidths.push({ wch: 15 });
      });
      ws['!cols'] = colWidths;

      XLSX.utils.book_append_sheet(wb, ws, 'F3_Data');

      const now = new Date();
      const fileName = `F3_Data_${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}.xlsx`;

      XLSX.writeFile(wb, fileName);
      alert(`‚úÖ ƒê√£ xu·∫•t ${filteredData.length.toLocaleString('vi-VN')} d√≤ng d·ªØ li·ªáu theo b·ªô l·ªçc th√†nh c√¥ng!`);
    }

    // H√†m set date range t·ª´ th√°ng
    function setDateRangeFromMonth(month) {
      if (!month) {
        document.getElementById('startDate').value = '';
        document.getElementById('endDate').value = '';
        return;
      }

      const now = new Date();
      const year = now.getFullYear();
      const monthNum = parseInt(month);

      // Ng√†y ƒë·∫ßu th√°ng (m√πng 1)
      const startDate = new Date(year, monthNum - 1, 1);
      // Ng√†y cu·ªëi th√°ng (ng√†y 0 c·ªßa th√°ng ti·∫øp theo = ng√†y cu·ªëi th√°ng hi·ªán t·∫°i)
      const endDate = new Date(year, monthNum, 0);

      // Format YYYY-MM-DD ƒë·ªÉ tr√°nh timezone issues
      const formatDate = (date) => {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
      };

      document.getElementById('startDate').value = formatDate(startDate);
      document.getElementById('endDate').value = formatDate(endDate);

      console.log(`üìÖ ƒê√£ set filter th√°ng ${month}: t·ª´ ${formatDate(startDate)} ƒë·∫øn ${formatDate(endDate)}`);
    }

    // H√†m x·ª≠ l√Ω quick filter
    function handleQuickFilter(filterType, clickedBtn) {
      const now = new Date();
      const startDateEl = document.getElementById('startDate');
      const endDateEl = document.getElementById('endDate');
      const monthSelect = document.getElementById('filterMonth');

      // X√≥a active class t·ª´ t·∫•t c·∫£ buttons
      document.querySelectorAll('.quick-filter-btn').forEach(btn => {
        btn.classList.remove('active');
      });

      // Set active cho button ƒë∆∞·ª£c click
      if (clickedBtn && filterType !== 'clear') {
        clickedBtn.classList.add('active');
      }

      // Reset th√°ng filter
      if (monthSelect) monthSelect.value = '';

      switch (filterType) {
        case 'today':
          const today = now.toISOString().split('T')[0];
          startDateEl.value = today;
          endDateEl.value = today;
          break;
        case 'yesterday':
          const yesterday = new Date(now);
          yesterday.setDate(yesterday.getDate() - 1);
          const yesterdayStr = yesterday.toISOString().split('T')[0];
          startDateEl.value = yesterdayStr;
          endDateEl.value = yesterdayStr;
          break;
        case 'thisWeek':
          const thisWeekStart = new Date(now);
          const day = thisWeekStart.getDay();
          const diff = thisWeekStart.getDate() - day + (day === 0 ? -6 : 1); // Th·ª© 2
          thisWeekStart.setDate(diff);
          const thisWeekEnd = new Date(thisWeekStart);
          thisWeekEnd.setDate(thisWeekEnd.getDate() + 6); // Ch·ªß nh·∫≠t
          startDateEl.value = thisWeekStart.toISOString().split('T')[0];
          endDateEl.value = thisWeekEnd.toISOString().split('T')[0];
          break;
        case 'lastWeek':
          const lastWeekStart = new Date(now);
          const lastDay = lastWeekStart.getDay();
          const lastDiff = lastWeekStart.getDate() - lastDay - 6 + (lastDay === 0 ? -6 : 1);
          lastWeekStart.setDate(lastDiff);
          const lastWeekEnd = new Date(lastWeekStart);
          lastWeekEnd.setDate(lastWeekEnd.getDate() + 6);
          startDateEl.value = lastWeekStart.toISOString().split('T')[0];
          endDateEl.value = lastWeekEnd.toISOString().split('T')[0];
          break;
        case 'thisMonth':
          const thisMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
          const thisMonthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0);
          startDateEl.value = thisMonthStart.toISOString().split('T')[0];
          endDateEl.value = thisMonthEnd.toISOString().split('T')[0];
          break;
        case 'clear':
          startDateEl.value = '';
          endDateEl.value = '';
          if (monthSelect) monthSelect.value = '';
          document.querySelectorAll('.quick-filter-btn').forEach(btn => {
            btn.classList.remove('active');
          });
          break;
      }

      applyFilters();
    }

    // Event listeners
    document.getElementById('searchInput').addEventListener('input', applyFilters);
    document.getElementById('startDate').addEventListener('change', function () {
      // Khi thay ƒë·ªïi date th·ªß c√¥ng, x√≥a filter th√°ng
      document.getElementById('filterMonth').value = '';
      applyFilters();
    });
    document.getElementById('endDate').addEventListener('change', function () {
      // Khi thay ƒë·ªïi date th·ªß c√¥ng, x√≥a filter th√°ng
      document.getElementById('filterMonth').value = '';
      applyFilters();
    });
    document.getElementById('filterMonth').addEventListener('change', function () {
      const month = this.value;
      setDateRangeFromMonth(month);
      // X√≥a active class t·ª´ quick filter buttons
      document.querySelectorAll('.quick-filter-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      applyFilters();
    });
    document.getElementById('refreshBtn').addEventListener('click', loadData);
    document.getElementById('exportBtn').addEventListener('click', exportToExcel);

    // Toggle hi·ªÉn th·ªã danh s√°ch CSKH

    // Quick filter buttons
    document.querySelectorAll('.quick-filter-btn').forEach(btn => {
      btn.addEventListener('click', function () {
        const filterType = this.getAttribute('data-filter');
        handleQuickFilter(filterType, this);
      });
    });

    // Pagination event listeners
    document.getElementById('firstPageBtn').addEventListener('click', () => goToPage(1));
    document.getElementById('prevPageBtn').addEventListener('click', () => goToPage(currentPage - 1));
    document.getElementById('nextPageBtn').addEventListener('click', () => goToPage(currentPage + 1));
    document.getElementById('lastPageBtn').addEventListener('click', () => goToPage(totalPages));

    document.getElementById('pageSizeSelect').addEventListener('change', function () {
      pageSize = parseInt(this.value);
      currentPage = 1;
      renderTable();
      updateStats();
    });

    // H√†m x·ª≠ l√Ω khi thay ƒë·ªïi gi√° tr·ªã "Tr·∫°ng th√°i cu·ªëi c√πng"
    // H√†m x·ª≠ l√Ω khi thay ƒë·ªïi gi√° tr·ªã "Tr·∫°ng th√°i cu·ªëi c√πng"
    window.handleTrangThaiCuoiCungChange = async function (selectElement) {
      const maDonHang = selectElement.getAttribute('data-ma-don');
      const newValue = selectElement.value;

      if (!maDonHang) {
        console.error('‚ùå Kh√¥ng t√¨m th·∫•y m√£ ƒë∆°n h√†ng');
        return;
      }

      // Hi·ªÉn th·ªã loading
      selectElement.disabled = true;
      selectElement.style.opacity = '0.6';

      // --- B·∫Øt ƒë·∫ßu c·∫≠p nh·∫≠t ---

      async function updateAppSheet(maDonHang, newValue) {

        const APP_ID = 'f9aacd5a-8966-45b1-b20c-c8f5ea16c63b';
        const ACCESS_KEY = 'V2-w28Id-wg3Ec-NToRD-xUaHk-CPMlL-44lVt-tNHJ3-DeMAp';
        const TABLE_NAME = 'F3';

        const url = `https://api.appsheet.com/api/v2/apps/${APP_ID}/tables/${TABLE_NAME}/Action`;

        const body = {
          "Action": "Edit",
          "Properties": {
            "Locale": "vi-VN",
          },
          "Rows": [
            {
              "M√£ ƒë∆°n h√†ng": maDonHang,
              "Th·ªùi gian cutoff": newValue
            }
          ]
        };

        try {
          console.log('üöÄ ƒêang g·ª≠i y√™u c·∫ßu ƒë·∫øn AppSheet:', { url, body });
          const response = await fetch(url, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'ApplicationAccessKey': ACCESS_KEY
            },
            body: JSON.stringify(body)
          });

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`L·ªói HTTP ${response.status}: ${errorText}`);
          }

          const result = await response.json();
          console.log('‚úÖ AppSheet ƒë√£ c·∫≠p nh·∫≠t th√†nh c√¥ng:', result);
          return true;

        } catch (error) {
          console.error('‚ùå L·ªói khi c·∫≠p nh·∫≠t AppSheet:', error);
          alert(`L·ªói khi c·∫≠p nh·∫≠t d·ªØ li·ªáu tr√™n AppSheet: ${error.message}`);
          return false;
        }
      }


      const [firebaseSuccess, appSheetSuccess] = await Promise.all([
        saveTrangThaiCuoiCung(maDonHang, newValue),
        updateAppSheet(maDonHang, newValue)
      ]);
      // --- K·∫øt th√∫c c·∫≠p nh·∫≠t ---

      // Kh√¥i ph·ª•c UI
      selectElement.disabled = false;
      selectElement.style.opacity = '1';

      if (firebaseSuccess && appSheetSuccess) {
        // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng n·∫øu c·∫£ hai ƒë·ªÅu th√†nh c√¥ng
        const originalBg = selectElement.style.backgroundColor;
        selectElement.style.backgroundColor = '#c8e6c9';
        setTimeout(() => {
          selectElement.style.backgroundColor = originalBg;
        }, 1000);
      } else {
        // Kh√¥i ph·ª•c gi√° tr·ªã c≈© n·∫øu c√≥ l·ªói
        const row = filteredData.find(r => {
          const md = getRowValue(r, 'M√£_ƒë∆°n_h√†ng', 'M√£ ƒë∆°n h√†ng') || '';
          return md === maDonHang;
        });
        if (row) {
          const oldValue = getRowValue(row, 'Th·ªùi_gian_cutoff', 'Th·ªùi gian cutoff', 'Th·ªùi_gian_Cutoff', 'Th·ªùi gian Cutoff') || '';
          selectElement.value = oldValue;
        }
      }
    };
    // Load d·ªØ li·ªáu khi trang load
    loadData();
  </script>
</body>

</html>


<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>M√°y In AppSheet - Debug Version</title>
    <style>
        @page { size: A4; margin: 5mm; }
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f0f2f5; }
        .no-print { background: #fff; padding: 20px; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 20px; }
        .filter-bar { display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap; }
        button { padding: 10px 20px; cursor: pointer; font-weight: bold; border-radius: 5px; border: none; }
        .btn-fetch { background: #007bff; color: white; }
        .btn-print { background: #28a745; color: white; font-size: 16px; }
        table { width: 100%; border-collapse: collapse; background: white; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        th { background: #f4f4f4; }

        /* V√πng In */
        #print-area { display: none; grid-template-columns: repeat(4, 1fr); width: 200mm; margin: auto; }
        .card { width: 48.5mm; height: 35.5mm; border: 0.8px solid black; font-size: 8px; page-break-inside: avoid; display: flex; flex-direction: column; }
        .card-header { border-bottom: 0.8px solid black; padding: 1px 3px; font-weight: bold; font-size: 9px; }
        .card-table { width: 100%; border-collapse: collapse; flex-grow: 1; }
        .card-table td { border: 0.5px solid black; padding: 1px 2px; height: 5.5mm; }
        .label { background: #e9e9e9; font-weight: bold; width: 30%; }

        @media print {
            .no-print, table, h2 { display: none !important; }
            #print-area { display: grid !important; }
        }
    </style>
</head>
<body>

<div class="no-print">
    <h2>M√°y In Phi·∫øu ƒê∆°n H√†ng</h2>
    <div class="filter-bar">
        <div>
            <label style="display:block; font-size:12px;">Kh√°ch h√†ng:</label>
            <input type="text" id="in-kh" oninput="applyFilter()">
        </div>
        <div>
            <label style="display:block; font-size:12px;">Tr·∫°ng th√°i:</label>
            <select id="in-st" onchange="applyFilter()">
                <option value="T·∫•t c·∫£">T·∫•t c·∫£</option>
                <option value="Ch∆∞a in" selected>Ch∆∞a in</option>
                <option value="ƒê√£ in">ƒê√£ in</option>
            </select>
        </div>
        <button class="btn-fetch" onclick="loadData()">T·∫£i l·∫°i d·ªØ li·ªáu</button>
        <button class="btn-print" onclick="startPrintProcess()">üî• IN V√Ä C·∫¨P NH·∫¨T TR·∫†NG TH√ÅI</button>
    </div>
    <div id="status" style="margin-top:10px; font-weight:bold; color:blue;">ƒêang ch·ªù l·ªánh...</div>
</div>

<table class="no-print">
    <thead>
        <tr>
            <th><input type="checkbox" id="check-all" onclick="selectAll(this)"></th>
            <th>Ng√†y SX</th>
            <th>Kh√°ch h√†ng</th>
            <th>T√™n h√†ng</th>
            <th>L√¥ SX</th>
            <th>Tr·∫°ng th√°i</th>
        </tr>
    </thead>
    <tbody id="table-body"></tbody>
</table>

<div id="print-area"></div>

<script>
    const CONFIG = {
        appId: '9664c7b9-d2da-4ca0-a32f-e0011ca47144',
        accessKey: 'V2-phqlX-WYQ36-If1qU-agfBo-Tmt2k-azwGa-lQjoP-gwMOr',
        tableName: 'ƒê∆°n h√†ng',
        keyColumn: 'ID' // <-- N·∫æU L·ªñI, H√ÉY ƒê·ªîI 'ID' TH√ÄNH '_RowNumber' HO·∫∂C T√äN C·ªòT KH√ìA C·ª¶A B·∫†N
    };

    let fullRows = [];

    window.onload = loadData;

    async function loadData() {
        const st = document.getElementById('status');
        st.innerText = "‚åõ ƒêang l·∫•y d·ªØ li·ªáu...";
        try {
            const res = await fetch(`https://api.appsheet.com/api/v2/apps/${CONFIG.appId}/tables/${encodeURIComponent(CONFIG.tableName)}/Action`, {
                method: 'POST',
                headers: { 'ApplicationAccessKey': CONFIG.accessKey, 'Content-Type': 'application/json' },
                body: JSON.stringify({ "Action": "Find", "Rows": [] })
            });
            const data = await res.json();
            if (Array.isArray(data)) {
                fullRows = data;
                applyFilter();
                st.innerText = `‚úÖ ƒê√£ t·∫£i ${fullRows.length} d√≤ng.`;
            } else {
                alert("L·ªói: Kh√¥ng t√¨m th·∫•y b·∫£ng 'ƒê∆°n h√†ng'. H√£y ki·ªÉm tra l·∫°i t√™n b·∫£ng trong AppSheet.");
            }
        } catch (e) {
            alert("L·ªói k·∫øt n·ªëi: " + e.message);
        }
    }

    function applyFilter() {
        const kh = document.getElementById('in-kh').value.toLowerCase();
        const st = document.getElementById('in-st').value;
        const filtered = fullRows.filter(r => {
            const matchKH = !kh || (r['KH'] && String(r['KH']).toLowerCase().includes(kh));
            let matchST = true;
            if (st === "Ch∆∞a in") matchST = r['Tr·∫°ng th√°i in'] !== "ƒê√£ in";
            if (st === "ƒê√£ in") matchST = r['Tr·∫°ng th√°i in'] === "ƒê√£ in";
            return matchKH && matchST;
        });

        document.getElementById('table-body').innerHTML = filtered.map(r => `
            <tr>
                <td><input type="checkbox" class="item-cb" data-id="${r[CONFIG.keyColumn]}"></td>
                <td>${r['Ng√†y SX'] || ''}</td>
                <td>${r['KH'] || ''}</td>
                <td>${r['T√™n h√†ng'] || ''}</td>
                <td>${r['L√¥ SX'] || ''}</td>
                <td>${r['Tr·∫°ng th√°i in'] || 'Ch∆∞a in'}</td>
            </tr>
        `).join('');
    }

    function selectAll(source) {
        document.querySelectorAll('.item-cb').forEach(c => c.checked = source.checked);
    }

    async function startPrintProcess() {
        const cbs = document.querySelectorAll('.item-cb:checked');
        const ids = Array.from(cbs).map(c => c.getAttribute('data-id'));

        if (ids.length === 0) return alert("B·∫°n ch∆∞a t√≠ch ch·ªçn d√≤ng n√†o ƒë·ªÉ in!");

        // 1. Chu·∫©n b·ªã d·ªØ li·ªáu in
        const toPrint = fullRows.filter(r => ids.includes(String(r[CONFIG.keyColumn])));
        const area = document.getElementById('print-area');
        area.innerHTML = '';
        
        toPrint.forEach(r => {
            const div = document.createElement('div');
            div.className = 'card';
            div.innerHTML = `
                <div class="card-header">Form: XH-ELM-2023</div>
                <table class="card-table">
                    <tr><td class="label">KH</td><td>${r['KH'] || ''}</td><td class="label">Lo·∫°i h√†ng</td><td>${r['Lo·∫°i h√†ng'] || ''}</td></tr>
                    <tr><td class="label">T√™n h√†ng</td><td colspan="3">${r['T√™n h√†ng'] || ''}</td></tr>
                    <tr><td class="label">SL</td><td>${r['SL'] || ''}</td><td class="label">Ng√†y nh·∫≠n</td><td>${r['Ng√†y nh·∫≠n'] || ''}</td></tr>
                    <tr><td class="label">L√¥ SX</td><td>${r['L√¥ SX'] || ''}</td><td class="label">Ng√†y SX</td><td>${r['Ng√†y SX'] || ''}</td></tr>
                    <tr><td class="label">Ki·ªÉm h√†ng</td><td>${r['Ki·ªÉm h√†ng'] || ''}</td><td class="label">Tr∆∞·ªüng ca</td><td>${r['Tr∆∞·ªüng ca'] || ''}</td></tr>
                    <tr><td class="label">Ghi ch√∫</td><td colspan="3">${r['Ghi ch√∫'] || ''}</td></tr>
                </table>`;
            area.appendChild(div);
        });

        // 2. L·ªánh In
        window.print();

        // 3. C·∫≠p nh·∫≠t (H·ªèi √Ω ki·∫øn)
        if (confirm(`ƒê√£ hi·ªán c·ª≠a s·ªï in. B·∫°n c√≥ mu·ªën c·∫≠p nh·∫≠t 'ƒê√£ in' cho ${ids.length} ƒë∆°n n√†y kh√¥ng?`)) {
            await updateStatus(ids);
        }
    }

    async function updateStatus(ids) {
        document.getElementById('status').innerText = "‚è≥ ƒêang c·∫≠p nh·∫≠t...";
        const rows = ids.map(id => ({ [CONFIG.keyColumn]: id, "Tr·∫°ng th√°i in": "ƒê√£ in" }));
        
        try {
            const res = await fetch(`https://api.appsheet.com/api/v2/apps/${CONFIG.appId}/tables/${encodeURIComponent(CONFIG.tableName)}/Action`, {
                method: 'POST',
                headers: { 'ApplicationAccessKey': CONFIG.accessKey, 'Content-Type': 'application/json' },
                body: JSON.stringify({ "Action": "Edit", "Rows": rows })
            });
            const result = await res.json();
            
            // N·∫øu AppSheet tr·∫£ v·ªÅ d·ªØ li·ªáu r·ªóng ho·∫∑c b√°o l·ªói
            if (res.ok) {
                alert("‚úÖ ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i l√™n AppSheet!");
                loadData();
            } else {
                throw new Error("L·ªánh c·∫≠p nh·∫≠t b·ªã AppSheet t·ª´ ch·ªëi. H√£y ki·ªÉm tra c·ªôt Kh√≥a.");
            }
        } catch (e) {
            alert("‚ùå L·ªói c·∫≠p nh·∫≠t: " + e.message + "\n\nGi·∫£i ph√°p: H√£y ki·ªÉm tra l·∫°i t√™n c·ªôt Kh√≥a (Key) trong code.");
        }
    }
</script>
</body>
</html>

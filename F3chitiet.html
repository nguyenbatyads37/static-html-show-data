<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>D·ªØ li·ªáu F3 - Xem to√†n b·ªô</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #2d7c2d;
      --primary-light: #4CAF50;
      --text-dark: #111;
      --text-medium: #333;
      --bg-light: #f4f4f4;
      --border-color: #e0e0e0;
      --font-main: 'Roboto', Arial, sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-main);
      padding: 10px;
      background: var(--bg-light);
      color: var(--text-dark);
      margin: 0;
      font-size: 12px;
    }

    .container {
      max-width: 100%;
      margin: 0 auto;
    }

    .header {
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .header h1 {
      margin: 0 0 10px 0;
      color: var(--primary-color);
      font-size: 24px;
    }

    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 15px;
      padding: 12px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .controls input[type="text"],
    .controls input[type="date"] {
      padding: 6px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 13px;
    }

    .controls input[type="text"] {
      flex: 1;
      min-width: 200px;
    }

    .btn {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      background: var(--primary-color);
      color: #fff;
    }

    .btn:hover {
      background: var(--primary-light);
    }

    .btn-secondary {
      background: #6c757d;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .table-wrapper {
      overflow-x: auto;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    th {
      background: var(--primary-color);
      color: #fff;
      padding: 10px 8px;
      text-align: left;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
      white-space: nowrap;
    }

    td {
      padding: 8px;
      border-bottom: 1px solid var(--border-color);
      white-space: nowrap;
    }

    tbody tr:nth-child(even) {
      background: #f9f9f9;
    }

    tbody tr:hover {
      background: #eff5fb;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: var(--primary-color);
      font-size: 16px;
    }

    .error {
      background: #ffebee;
      color: #c62828;
      padding: 15px;
      border-radius: 4px;
      margin: 15px 0;
    }

    .stats {
      padding: 10px;
      background: #e8f5e9;
      border-radius: 4px;
      margin-bottom: 15px;
      font-size: 13px;
    }

    .text-center {
      text-align: center;
    }

    .text-right {
      text-align: right;
    }

    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 11px;
      font-weight: 600;
    }

    .badge-success {
      background: #c8e6c9;
      color: #2e7d32;
    }

    .badge-warning {
      background: #fff9c4;
      color: #f57f17;
    }

    .badge-danger {
      background: #ffcdd2;
      color: #c62828;
    }

    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin: 15px 0;
      padding: 10px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .pagination-info {
      font-size: 13px;
      color: var(--text-medium);
      margin: 0 10px;
    }

    .pagination button {
      padding: 6px 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: #fff;
      cursor: pointer;
      font-size: 13px;
    }

    .pagination button:hover:not(:disabled) {
      background: var(--primary-light);
      color: #fff;
      border-color: var(--primary-light);
    }

    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .pagination .page-number {
      min-width: 40px;
      text-align: center;
    }

    .pagination .page-number.active {
      background: var(--primary-color);
      color: #fff;
      border-color: var(--primary-color);
    }

    .page-size-selector {
      display: flex;
      align-items: center;
      gap: 5px;
      margin-left: 15px;
    }

    .page-size-selector select {
      padding: 5px 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 13px;
    }

    .filter-section {
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .filter-section h3 {
      margin: 0 0 10px 0;
      font-size: 14px;
      color: var(--primary-color);
    }

    .filter-dropdowns {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      padding: 10px;
      background: #f9f9f9;
      border-radius: 4px;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
      min-width: 180px;
    }

    .filter-group label {
      font-weight: 600;
      font-size: 12px;
      color: var(--text-medium);
      margin-bottom: 5px;
    }

    .filter-group select {
      padding: 6px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 12px;
      background: #fff;
      cursor: pointer;
      min-width: 180px;
    }

    .filter-group select:hover {
      border-color: var(--primary-color);
    }

    .total-row {
      background: #ffeb3b !important;
      font-weight: 700 !important;
      position: sticky;
      top: 0;
      z-index: 5;
    }

    .total-row td {
      background: #ffeb3b !important;
      border-bottom: 2px solid #f57f17;
      border-top: 2px solid #f57f17;
    }

    .summary-table {
      width: 100%;
      margin-bottom: 15px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      border-collapse: collapse;
    }

    .summary-table td {
      padding: 12px 15px;
      border: 1px solid var(--border-color);
      font-size: 13px;
      text-align: center;
    }

    .summary-table tr:first-child td {
      background: var(--primary-color);
      color: #fff;
      font-weight: 700;
      font-size: 13px;
    }

    .summary-table tr:last-child td {
      text-align: center;
      font-weight: 700;
      font-size: 14px;
      color: var(--primary-color);
    }

    .quick-filters {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 15px;
      padding: 12px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .quick-filters h3 {
      width: 100%;
      margin: 0 0 10px 0;
      font-size: 14px;
      color: var(--primary-color);
    }

    .quick-filter-btn {
      padding: 6px 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: #fff;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .quick-filter-btn:hover {
      background: var(--primary-light);
      color: #fff;
      border-color: var(--primary-light);
    }

    .quick-filter-btn.active {
      background: var(--primary-color);
      color: #fff;
      border-color: var(--primary-color);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìä D·ªØ li·ªáu F3 - Xem to√†n b·ªô</h1>
      <div id="greeting" style="margin-bottom: 10px; font-size: 14px; color: var(--primary-color); font-weight: 500;"></div>
      <div class="stats" id="stats">ƒêang t·∫£i d·ªØ li·ªáu...</div>
    </div>

    <div class="controls">
      <input type="text" id="searchInput" placeholder="üîç T√¨m ki·∫øm trong t·∫•t c·∫£ c√°c c·ªôt..." />
      <label style="display: flex; align-items: center; gap: 5px; font-size: 13px; font-weight: 500;">
        Th√°ng:
        <select id="filterMonth" style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px;">
          <option value="">T·∫•t c·∫£</option>
          <option value="1">Th√°ng 1</option>
          <option value="2">Th√°ng 2</option>
          <option value="3">Th√°ng 3</option>
          <option value="4">Th√°ng 4</option>
          <option value="5">Th√°ng 5</option>
          <option value="6">Th√°ng 6</option>
          <option value="7">Th√°ng 7</option>
          <option value="8">Th√°ng 8</option>
          <option value="9">Th√°ng 9</option>
          <option value="10">Th√°ng 10</option>
          <option value="11">Th√°ng 11</option>
          <option value="12">Th√°ng 12</option>
        </select>
      </label>
      <label style="display: flex; align-items: center; gap: 5px; font-size: 13px; font-weight: 500;">
        T·ª´ ng√†y:
        <input type="date" id="startDate" placeholder="T·ª´ ng√†y" />
      </label>
      <label style="display: flex; align-items: center; gap: 5px; font-size: 13px; font-weight: 500;">
        ƒê·∫øn ng√†y:
        <input type="date" id="endDate" placeholder="ƒê·∫øn ng√†y" />
      </label>
      <div class="filter-dropdowns" style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
        <div class="filter-group" style="min-width: 150px;">
          <select id="filterNVSale" style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px; width: 100%;">
            <option value="">T·∫•t c·∫£ - NV Sale</option>
          </select>
        </div>
        <div class="filter-group" style="min-width: 150px;">
          <select id="filterNVMarketing" style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px; width: 100%;">
            <option value="">T·∫•t c·∫£ - NV Marketing</option>
          </select>
        </div>
        <div class="filter-group" style="min-width: 150px;">
          <select id="filterNVVanDon" style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px; width: 100%;">
            <option value="">T·∫•t c·∫£ - NV V·∫≠n ƒë∆°n</option>
          </select>
        </div>
        <div class="filter-group" style="min-width: 150px;">
          <select id="filterKetQuaCheck" style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px; width: 100%;">
            <option value="">T·∫•t c·∫£ - K·∫øt qu·∫£ Check</option>
          </select>
        </div>
        <div class="filter-group" style="min-width: 150px;">
          <select id="filterTrangThaiGiaoHang" style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px; width: 100%;">
            <option value="">T·∫•t c·∫£ - Tr·∫°ng th√°i GH</option>
          </select>
        </div>
      </div>
      <button class="btn" id="refreshBtn">üîÑ L√†m m·ªõi</button>
      <button class="btn btn-secondary" id="exportBtn">üì• Xu·∫•t Excel</button>
    </div>

    <div class="quick-filters">
      <h3>‚ö° L·ªçc nhanh theo th·ªùi gian</h3>
      <button class="quick-filter-btn" data-filter="today">H√¥m nay</button>
      <button class="quick-filter-btn" data-filter="yesterday">H√¥m qua</button>
      <button class="quick-filter-btn" data-filter="thisWeek">Tu·∫ßn n√†y</button>
      <button class="quick-filter-btn" data-filter="lastWeek">Tu·∫ßn tr∆∞·ªõc</button>
      <button class="quick-filter-btn" data-filter="thisMonth">Th√°ng n√†y</button>
      <button class="quick-filter-btn" data-filter="clear">X√≥a l·ªçc</button>
    </div>

    <div class="table-wrapper">
      <div id="loading" class="loading">ƒêang t·∫£i d·ªØ li·ªáu...</div>
      <div id="error" class="error" style="display: none;"></div>
      
      <!-- B·∫£ng th√¥ng s·ªë t·ªïng h·ª£p -->
      <table class="summary-table" id="summaryTable" style="display: none;">
        <tbody>
          <tr>
            <td>T·ªïng s·ªë ƒë∆°n</td>
            <td>T·ªïng ti·ªÅn VNƒê</td>
            <td>T·ªïng Ph√≠ ship</td>
            <td>T·ªïng Ti·ªÅn Vi·ªát ƒë√£ ƒë·ªëi so√°t</td>
          </tr>
          <tr>
            <td id="summaryTotalDon">0</td>
            <td id="summaryTotalTongTien">0 ‚Ç´</td>
            <td id="summaryTotalPhiShip">0 ‚Ç´</td>
            <td id="summaryTotalTienVietDoiSoat">0 ‚Ç´</td>
          </tr>
        </tbody>
      </table>

      <table id="dataTable" style="display: none;">
        <thead>
          <tr>
            <th>STT</th>
            <th>M√£ ƒë∆°n h√†ng</th>
            <th>M√£ Tracking</th>
            <th>Ng√†y l√™n ƒë∆°n</th>
            <th>Name*</th>
            <th>Nh√¢n vi√™n Sale</th>
            <th>Nh√¢n vi√™n Marketing</th>
            <th>NV V·∫≠n ƒë∆°n</th>
            <th>K·∫øt qu·∫£ Check</th>
            <th>Tr·∫°ng th√°i giao h√†ng NB</th>
            <th>ƒê∆°n v·ªã v·∫≠n chuy·ªÉn</th>
            <th>Tr·∫°ng th√°i thu ti·ªÅn</th>
            <th>M·∫∑t h√†ng</th>
            <th>Khu v·ª±c</th>
            <th class="text-right">T·ªïng ti·ªÅn VNƒê</th>
            <th class="text-right">Ph√≠ ship</th>
            <th class="text-right">Ti·ªÅn Vi·ªát ƒë√£ ƒë·ªëi so√°t</th>
          </tr>
        </thead>
        <tbody id="tableBody">
        </tbody>
        <tfoot id="tableFooter">
        </tfoot>
      </table>
    </div>

    <div class="pagination" id="pagination" style="display: none;">
      <button id="firstPageBtn">‚èÆ ƒê·∫ßu</button>
      <button id="prevPageBtn">‚óÄ Tr∆∞·ªõc</button>
      <span class="pagination-info" id="pageInfo">Trang 1 / 1</span>
      <button id="nextPageBtn">Sau ‚ñ∂</button>
      <button id="lastPageBtn">Cu·ªëi ‚è≠</button>
      <div class="page-size-selector">
        <label>S·ªë d√≤ng/trang:</label>
        <select id="pageSizeSelect">
          <option value="50">50</option>
          <option value="100" selected>100</option>
          <option value="200">200</option>
          <option value="500">500</option>
        </select>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    const F3_URL = 'https://lumi-6dff7-default-rtdb.asia-southeast1.firebasedatabase.app/datasheet/F3.json';
    const HR_URL = 'https://lumi-6dff7-default-rtdb.asia-southeast1.firebasedatabase.app/datasheet/Nh%C3%A2n_s%E1%BB%B1.json';
    
    let allData = [];
    let filteredData = [];
    let currentPage = 1;
    let pageSize = 100;
    let totalPages = 1;
    let allowedStaffNames = null; // null = hi·ªÉn th·ªã t·∫•t c·∫£, Set = ch·ªâ hi·ªÉn th·ªã nh√¢n vi√™n trong Set
    let hrData = [];
    let currentEmployee = null; // L∆∞u th√¥ng tin nh√¢n vi√™n hi·ªán t·∫°i
    let currentBoPhan = null; // L∆∞u B·ªô ph·∫≠n c·ªßa nh√¢n vi√™n hi·ªán t·∫°i

    // Format s·ªë ti·ªÅn (l√†m tr√≤n t·ªõi h√†ng ngh√¨n)
    function formatCurrency(value) {
      if (!value) return '0';
      const num = Number(value);
      // L√†m tr√≤n t·ªõi h√†ng ngh√¨n
      const rounded = Math.round(num / 1000) * 1000;
      return rounded.toLocaleString('vi-VN') + ' ‚Ç´';
    }

    // Format ng√†y
    function formatDate(dateStr) {
      if (!dateStr) return '';
      try {
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return dateStr;
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
      } catch {
        return dateStr;
      }
    }

    // Normalize d·ªØ li·ªáu F3
    function normalizeF3(data) {
      if (!data) return [];
      if (Array.isArray(data)) return data;
      if (typeof data === 'object') {
        return Object.values(data).filter(item => item && typeof item === 'object');
      }
      return [];
    }

    // Normalize d·ªØ li·ªáu HR
    function normalizeHR(data) {
      if (!data) return [];
      if (Array.isArray(data)) return data;
      if (typeof data === 'object') {
        return Object.values(data).filter(item => item && typeof item === 'object');
      }
      return [];
    }

    // L·∫•y id t·ª´ URL parameter
    function getUserIdFromURL() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('id') || null;
    }

    // Load v√† x·ª≠ l√Ω d·ªØ li·ªáu nh√¢n vi√™n
    async function loadAndProcessHRData() {
      const userId = getUserIdFromURL();
      
      // N·∫øu kh√¥ng c√≥ id trong URL, cho ph√©p xem t·∫•t c·∫£
      if (!userId) {
        console.log('üìå Kh√¥ng c√≥ id trong URL, hi·ªÉn th·ªã t·∫•t c·∫£ nh√¢n vi√™n');
        allowedStaffNames = null;
        currentEmployee = null;
        currentBoPhan = null;
        // ·∫®n ph·∫ßn ch√†o h·ªèi
        const greetingEl = document.getElementById('greeting');
        if (greetingEl) {
          greetingEl.textContent = '';
        }
        return;
      }

      try {
        // Fetch d·ªØ li·ªáu nh√¢n vi√™n
        const hrResponse = await fetchWithRetry(HR_URL);
        hrData = normalizeHR(hrResponse);
        
        // T√¨m nh√¢n vi√™n theo id
        const candidates = ['id', 'ID', 'Id', 'uid', 'UID', 'Uid', 'M√£ nh√¢n s·ª±', 'M√£_Nh√¢n_s·ª±', 'Ma_Nhan_su'];
        let foundEmployee = null;
        
        for (const emp of hrData) {
          for (const key of candidates) {
            if (emp[key] && String(emp[key]).trim() === String(userId).trim()) {
              foundEmployee = emp;
              break;
            }
          }
          if (foundEmployee) break;
        }

        if (!foundEmployee) {
          console.warn('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y nh√¢n vi√™n v·ªõi id:', userId);
          allowedStaffNames = null;
          currentEmployee = null;
          currentBoPhan = null;
          // ·∫®n ph·∫ßn ch√†o h·ªèi
          const greetingEl = document.getElementById('greeting');
          if (greetingEl) {
            greetingEl.textContent = '';
          }
          return;
        }

        // G√°n cho bi·∫øn global
        currentEmployee = foundEmployee;

        const viTri = String(currentEmployee['V·ªã tr√≠'] || '').trim();
        const team = String(currentEmployee['Team'] || '').trim();
        const hoVaTen = String(currentEmployee['H·ªç V√† T√™n'] || '').trim();
        const boPhan = String(currentEmployee['B·ªô ph·∫≠n'] || '').trim();
        
        // L∆∞u th√¥ng tin nh√¢n vi√™n hi·ªán t·∫°i
        // N·∫øu B·ªô ph·∫≠n = CSKH th√¨ x·ª≠ l√Ω nh∆∞ Sale
        currentBoPhan = (boPhan === 'CSKH') ? 'Sale' : boPhan;

        console.log('üë§ Nh√¢n vi√™n hi·ªán t·∫°i:', {
          id: userId,
          hoVaTen: hoVaTen,
          viTri: viTri,
          team: team,
          boPhan: boPhan
        });

        // Hi·ªÉn th·ªã ch√†o h·ªèi
        const greetingEl = document.getElementById('greeting');
        if (greetingEl && hoVaTen) {
          greetingEl.textContent = `üëã Xin ch√†o ${hoVaTen}${boPhan ? ` - ${boPhan}` : ''}`;
        }

        // N·∫øu l√† Leader, l·∫•y t·∫•t c·∫£ nh√¢n vi√™n trong Team
        if (viTri === 'Leader' && team) {
          const teamMembers = hrData.filter(emp => {
            const empTeam = String(emp['Team'] || '').trim();
            return empTeam === team && empTeam !== 'ƒê√£ ngh·ªâ';
          });
          
          allowedStaffNames = new Set();
          teamMembers.forEach(emp => {
            const name = String(emp['H·ªç V√† T√™n'] || '').trim();
            if (name) {
              allowedStaffNames.add(name);
            }
          });
          
          console.log('üë• Leader - Danh s√°ch nh√¢n vi√™n trong team:', Array.from(allowedStaffNames));
        } 
        // N·∫øu l√† NV, ch·ªâ l·∫•y t√™n m√¨nh
        else if (viTri === 'NV' || viTri === '') {
          allowedStaffNames = new Set();
          if (hoVaTen) {
            allowedStaffNames.add(hoVaTen);
          }
          console.log('üë§ NV - Ch·ªâ hi·ªÉn th·ªã:', Array.from(allowedStaffNames));
          console.log('üìã B·ªô ph·∫≠n:', boPhan);
          console.log('‚úÖ S·∫Ω l·ªçc ƒë∆°n h√†ng c√≥:', {
            'Sale': boPhan === 'Sale' ? hoVaTen : 'N/A',
            'MKT': boPhan === 'MKT' ? hoVaTen : 'N/A',
            'V·∫≠n ƒê∆°n': (boPhan === 'V·∫≠n ƒê∆°n' || boPhan === 'V·∫≠n H√†nh') ? hoVaTen : 'N/A'
          });
        } 
        // Tr∆∞·ªùng h·ª£p kh√°c, cho ph√©p xem t·∫•t c·∫£
        else {
          console.log('‚ö†Ô∏è V·ªã tr√≠ kh√¥ng x√°c ƒë·ªãnh ho·∫∑c kh√¥ng ph·∫£i Leader/NV:', viTri);
          allowedStaffNames = null;
        }

      } catch (error) {
        console.error('‚ùå L·ªói khi load d·ªØ li·ªáu nh√¢n vi√™n:', error);
        allowedStaffNames = null;
        currentEmployee = null;
        currentBoPhan = null;
        // ·∫®n ph·∫ßn ch√†o h·ªèi
        const greetingEl = document.getElementById('greeting');
        if (greetingEl) {
          greetingEl.textContent = '';
        }
      }
    }

    // Fetch v·ªõi retry
    async function fetchWithRetry(url, options = {}) {
      const { retries = 3, delayMs = 500 } = options;
      for (let i = 0; i < retries; i++) {
        try {
          const response = await fetch(url);
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          return await response.json();
        } catch (error) {
          if (i === retries - 1) throw error;
          await new Promise(resolve => setTimeout(resolve, delayMs));
        }
      }
    }

    // Load d·ªØ li·ªáu
    async function loadData() {
      const loadingEl = document.getElementById('loading');
      const errorEl = document.getElementById('error');
      const tableEl = document.getElementById('dataTable');
      
      loadingEl.style.display = 'block';
      errorEl.style.display = 'none';
      tableEl.style.display = 'none';

      try {
        // Load d·ªØ li·ªáu nh√¢n vi√™n tr∆∞·ªõc
        await loadAndProcessHRData();
        
        // Load d·ªØ li·ªáu F3
        const data = await fetchWithRetry(F3_URL);
        allData = normalizeF3(data);
        filteredData = [...allData];
        currentPage = 1; // Reset v·ªÅ trang 1 khi load l·∫°i
        populateFilters();
        // √Åp d·ª•ng filter ngay sau khi populate ƒë·ªÉ l·ªçc theo id (n·∫øu c√≥)
        applyFilters();
        updateStats();
        renderTable();
        loadingEl.style.display = 'none';
      } catch (error) {
        console.error('Error loading data:', error);
        loadingEl.style.display = 'none';
        errorEl.style.display = 'block';
        errorEl.textContent = `‚ùå L·ªói t·∫£i d·ªØ li·ªáu: ${error.message}`;
      }
    }

    // C·∫≠p nh·∫≠t th·ªëng k√™
    function updateStats() {
      const statsEl = document.getElementById('stats');
      const start = (currentPage - 1) * pageSize + 1;
      const end = Math.min(currentPage * pageSize, filteredData.length);
      statsEl.textContent = `üìä T·ªïng s·ªë: ${allData.length.toLocaleString('vi-VN')} ƒë∆°n | L·ªçc ƒë∆∞·ª£c: ${filteredData.length.toLocaleString('vi-VN')} ƒë∆°n | Hi·ªÉn th·ªã: ${start.toLocaleString('vi-VN')}-${end.toLocaleString('vi-VN')}`;
    }

    // T√≠nh to√°n ph√¢n trang
    function calculatePagination() {
      totalPages = Math.max(1, Math.ceil(filteredData.length / pageSize));
      if (currentPage > totalPages) {
        currentPage = totalPages;
      }
    }

    // Render b·∫£ng
    function renderTable() {
      const tbody = document.getElementById('tableBody');
      const tableEl = document.getElementById('dataTable');
      const paginationEl = document.getElementById('pagination');
      
      tbody.innerHTML = '';
      
      if (filteredData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="17" class="text-center">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
        tableEl.style.display = 'table';
        paginationEl.style.display = 'none';
        document.getElementById('tableFooter').innerHTML = '';
        document.getElementById('summaryTable').style.display = 'none';
        return;
      }

      calculatePagination();
      
      // Render b·∫£ng th√¥ng s·ªë t·ªïng h·ª£p
      renderSummaryTable();
      
      // L·∫•y d·ªØ li·ªáu c·ªßa trang hi·ªán t·∫°i
      const startIndex = (currentPage - 1) * pageSize;
      const endIndex = startIndex + pageSize;
      const pageData = filteredData.slice(startIndex, endIndex);

      pageData.forEach((row, index) => {
        const globalIndex = startIndex + index;
        const tr = document.createElement('tr');
        
        const maDonHang = row['M√£ ƒë∆°n h√†ng'] || '';
        const maTracking = row['M√£ Tracking'] || '';
        const ngayLenDon = formatDate(row['Ng√†y l√™n ƒë∆°n'] || row['Th·ªùi gian l√™n ƒë∆°n']);
        const name = row['Name*'] || row['T√™n l√™n ƒë∆°n'] || '';
        const tongTien = formatCurrency(row['T·ªïng ti·ªÅn VNƒê']);
        const nvSale = row['Nh√¢n vi√™n Sale'] || '';
        const nvMarketing = row['Nh√¢n vi√™n Marketing'] || '';
        const nvVanDon = row['NV V·∫≠n ƒë∆°n'] || '';
        const ketQuaCheck = row['K·∫øt qu·∫£ Check'] || '';
        const trangThaiGiaoHang = row['Tr·∫°ng th√°i giao h√†ng NB'] || '';
        const donViVanChuyen = row['ƒê∆°n v·ªã v·∫≠n chuy·ªÉn'] || '';
        const trangThaiThuTien = row['Tr·∫°ng th√°i thu ti·ªÅn'] || '';
        const matHang = row['M·∫∑t h√†ng'] || '';
        const khuVuc = row['Khu v·ª±c'] || '';

        // T·∫°o badge cho K·∫øt qu·∫£ Check
        let checkBadge = '';
        if (ketQuaCheck) {
          const checkLower = ketQuaCheck.toLowerCase();
          if (checkLower.includes('ok')) {
            checkBadge = `<span class="badge badge-success">${ketQuaCheck}</span>`;
          } else if (checkLower.includes('h·ªßy') || checkLower.includes('huy')) {
            checkBadge = `<span class="badge badge-danger">${ketQuaCheck}</span>`;
          } else {
            checkBadge = `<span class="badge badge-warning">${ketQuaCheck}</span>`;
          }
        }

        const phiShip = formatCurrency(row['Ph√≠ ship'] || 0);
        const tienVietDoiSoat = formatCurrency(row['Ti·ªÅn Vi·ªát ƒë√£ ƒë·ªëi so√°t'] || 0);

        tr.innerHTML = `
          <td class="text-center">${globalIndex + 1}</td>
          <td>${maDonHang}</td>
          <td>${maTracking}</td>
          <td>${ngayLenDon}</td>
          <td>${name}</td>
          <td>${nvSale}</td>
          <td>${nvMarketing}</td>
          <td>${nvVanDon}</td>
          <td>${checkBadge || ketQuaCheck}</td>
          <td>${trangThaiGiaoHang}</td>
          <td>${donViVanChuyen}</td>
          <td>${trangThaiThuTien}</td>
          <td>${matHang}</td>
          <td>${khuVuc}</td>
          <td class="text-right">${tongTien}</td>
          <td class="text-right">${phiShip}</td>
          <td class="text-right">${tienVietDoiSoat}</td>
        `;
        
        tbody.appendChild(tr);
      });

      tableEl.style.display = 'table';
      updatePaginationControls();
    }

    // Render b·∫£ng th√¥ng s·ªë t·ªïng h·ª£p
    function renderSummaryTable() {
      const summaryTable = document.getElementById('summaryTable');
      if (!summaryTable) return;

      let totalTongTien = 0;
      let totalPhiShip = 0;
      let totalTienVietDoiSoat = 0;
      let totalDon = filteredData.length;

      filteredData.forEach(row => {
        totalTongTien += Number(row['T·ªïng ti·ªÅn VNƒê'] || 0);
        totalPhiShip += Number(row['Ph√≠ ship'] || 0);
        totalTienVietDoiSoat += Number(row['Ti·ªÅn Vi·ªát ƒë√£ ƒë·ªëi so√°t'] || 0);
      });

      // C·∫≠p nh·∫≠t c√°c gi√° tr·ªã trong b·∫£ng th√¥ng s·ªë
      document.getElementById('summaryTotalDon').textContent = totalDon.toLocaleString('vi-VN') + ' ƒë∆°n';
      document.getElementById('summaryTotalTongTien').textContent = formatCurrency(totalTongTien);
      document.getElementById('summaryTotalPhiShip').textContent = formatCurrency(totalPhiShip);
      document.getElementById('summaryTotalTienVietDoiSoat').textContent = formatCurrency(totalTienVietDoiSoat);

      // Hi·ªÉn th·ªã b·∫£ng th√¥ng s·ªë
      summaryTable.style.display = 'table';
    }

    // C·∫≠p nh·∫≠t controls ph√¢n trang
    function updatePaginationControls() {
      const paginationEl = document.getElementById('pagination');
      const pageInfoEl = document.getElementById('pageInfo');
      const firstBtn = document.getElementById('firstPageBtn');
      const prevBtn = document.getElementById('prevPageBtn');
      const nextBtn = document.getElementById('nextPageBtn');
      const lastBtn = document.getElementById('lastPageBtn');

      if (filteredData.length === 0) {
        paginationEl.style.display = 'none';
        return;
      }

      paginationEl.style.display = 'flex';
      pageInfoEl.textContent = `Trang ${currentPage} / ${totalPages}`;

      firstBtn.disabled = currentPage === 1;
      prevBtn.disabled = currentPage === 1;
      nextBtn.disabled = currentPage === totalPages;
      lastBtn.disabled = currentPage === totalPages;
    }

    // Chuy·ªÉn trang
    function goToPage(page) {
      if (page < 1 || page > totalPages) return;
      currentPage = page;
      renderTable();
      updateStats();
      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Populate filter dropdowns
    function populateFilters() {
      const filterConfigs = [
        { id: 'filterNVSale', field: 'Nh√¢n vi√™n Sale', boPhan: 'Sale' },
        { id: 'filterNVMarketing', field: 'Nh√¢n vi√™n Marketing', boPhan: 'MKT' },
        { id: 'filterNVVanDon', field: 'NV V·∫≠n ƒë∆°n', boPhan: 'V·∫≠n ƒê∆°n' },
        { id: 'filterKetQuaCheck', field: 'K·∫øt qu·∫£ Check', boPhan: null },
        { id: 'filterTrangThaiGiaoHang', field: 'Tr·∫°ng th√°i giao h√†ng NB', boPhan: null }
      ];

      filterConfigs.forEach(config => {
        const select = document.getElementById(config.id);
        if (!select) return;

        // X√°c ƒë·ªãnh xem c√≥ ph·∫£i dropdown t∆∞∆°ng ·ª©ng v·ªõi B·ªô ph·∫≠n c·ªßa nh√¢n vi√™n kh√¥ng
        const isMatchingBoPhan = currentBoPhan && config.boPhan && 
          (config.boPhan === currentBoPhan || 
           (config.boPhan === 'V·∫≠n ƒê∆°n' && currentBoPhan === 'V·∫≠n H√†nh'));

        // L·∫•y unique values
        const values = new Set();
        allData.forEach(row => {
          const value = row[config.field];
          if (value !== null && value !== undefined && value !== '') {
            const valueStr = String(value).trim();
            
            // N·∫øu c√≥ gi·ªõi h·∫°n nh√¢n vi√™n V√Ä ƒë√¢y l√† filter t∆∞∆°ng ·ª©ng v·ªõi B·ªô ph·∫≠n
            // Ch·ªâ l·∫•y nh·ªØng ng∆∞·ªùi trong danh s√°ch ƒë∆∞·ª£c ph√©p
            if (currentEmployee && allowedStaffNames !== null && isMatchingBoPhan) {
              if (allowedStaffNames.has(valueStr)) {
                values.add(valueStr);
              }
            } else if (config.boPhan === null) {
              // Filter kh√¥ng ph·∫£i nh√¢n vi√™n (K·∫øt qu·∫£ Check, Tr·∫°ng th√°i GH) - lu√¥n hi·ªÉn th·ªã t·∫•t c·∫£
              values.add(valueStr);
            } else if (!currentEmployee || allowedStaffNames === null) {
              // Kh√¥ng c√≥ id trong URL - hi·ªÉn th·ªã t·∫•t c·∫£
              values.add(valueStr);
            }
            // N·∫øu c√≥ id nh∆∞ng kh√¥ng ph·∫£i B·ªô ph·∫≠n t∆∞∆°ng ·ª©ng - kh√¥ng hi·ªÉn th·ªã g√¨ (ƒë·ªÉ tr·ªëng)
          }
        });

        const sortedValues = Array.from(values).sort();
        
        // Gi·ªØ l·∫°i option ƒë·∫ßu ti√™n (ƒë√£ c√≥ trong HTML)
        const firstOption = select.querySelector('option');
        const firstOptionText = firstOption ? firstOption.textContent : 'T·∫•t c·∫£';
        select.innerHTML = '';
        
        // Th√™m l·∫°i option ƒë·∫ßu ti√™n
        const allOption = document.createElement('option');
        allOption.value = '';
        allOption.textContent = firstOptionText;
        select.appendChild(allOption);

        // Ch·ªâ th√™m option "Tr·ªëng" n·∫øu kh√¥ng c√≥ gi·ªõi h·∫°n ho·∫∑c kh√¥ng ph·∫£i dropdown B·ªô ph·∫≠n t∆∞∆°ng ·ª©ng
        if (!currentEmployee || allowedStaffNames === null || !isMatchingBoPhan) {
          const emptyOption = document.createElement('option');
          emptyOption.value = '__EMPTY__';
          emptyOption.textContent = 'Tr·ªëng';
          select.appendChild(emptyOption);
        }

        // Th√™m c√°c options
        sortedValues.forEach(value => {
          const option = document.createElement('option');
          option.value = value;
          option.textContent = value;
          select.appendChild(option);
        });

        // Th√™m event listener
        select.addEventListener('change', applyFilters);
        
        // N·∫øu l√† NV v√† ƒë√¢y l√† dropdown t∆∞∆°ng ·ª©ng v·ªõi B·ªô ph·∫≠n, t·ª± ƒë·ªông ch·ªçn t√™n
        if (currentEmployee && allowedStaffNames !== null && isMatchingBoPhan) {
          const viTri = String(currentEmployee['V·ªã tr√≠'] || '').trim();
          const hoVaTen = String(currentEmployee['H·ªç V√† T√™n'] || '').trim();
          
          if ((viTri === 'NV' || viTri === '') && hoVaTen && sortedValues.includes(hoVaTen)) {
            select.value = hoVaTen;
            console.log(`‚úÖ ƒê√£ t·ª± ƒë·ªông ch·ªçn "${hoVaTen}" trong dropdown ${config.id}`);
          }
        }
        
        // X·ª≠ l√Ω hi·ªÉn th·ªã/·∫©n dropdown d·ª±a tr√™n B·ªô ph·∫≠n
        const filterGroup = select.closest('.filter-group');
        if (filterGroup) {
          if (currentEmployee && allowedStaffNames !== null && config.boPhan !== null && !isMatchingBoPhan) {
            // N·∫øu c√≥ id v√† ƒë√¢y KH√îNG ph·∫£i dropdown t∆∞∆°ng ·ª©ng v·ªõi B·ªô ph·∫≠n - ·∫©n ƒëi
            filterGroup.style.display = 'none';
          } else {
            // Hi·ªÉn th·ªã l·∫°i n·∫øu kh√¥ng c√≥ id ho·∫∑c l√† dropdown t∆∞∆°ng ·ª©ng
            filterGroup.style.display = '';
          }
        }
      });
    }

    // L·∫•y gi√° tr·ªã ƒë√£ ch·ªçn t·ª´ dropdown
    function getSelectedFilterValue(filterId) {
      const select = document.getElementById(filterId);
      if (!select) return '';
      return select.value.trim();
    }

    // L·ªçc d·ªØ li·ªáu
    function applyFilters() {
      const searchText = document.getElementById('searchInput').value.toLowerCase().trim();
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;

      // Reset v·ªÅ trang 1 khi filter
      currentPage = 1;

      // L·∫•y c√°c filter ƒë√£ ch·ªçn t·ª´ dropdown
      const selectedNVSale = getSelectedFilterValue('filterNVSale');
      const selectedNVMarketing = getSelectedFilterValue('filterNVMarketing');
      const selectedNVVanDon = getSelectedFilterValue('filterNVVanDon');
      const selectedKetQuaCheck = getSelectedFilterValue('filterKetQuaCheck');
      const selectedTrangThaiGiaoHang = getSelectedFilterValue('filterTrangThaiGiaoHang');

      filteredData = allData.filter(row => {
        // L·ªçc theo nh√¢n vi√™n ƒë∆∞·ª£c ph√©p xem (n·∫øu c√≥ gi·ªõi h·∫°n) - ∆ØU TI√äN CAO NH·∫§T
        // Ki·ªÉm tra n·∫øu c√≥ currentEmployee v√† allowedStaffNames (c√≥ id trong URL)
        if (currentEmployee && allowedStaffNames !== null && currentBoPhan) {
          const viTri = String(currentEmployee['V·ªã tr√≠'] || '').trim();
          const hoVaTen = String(currentEmployee['H·ªç V√† T√™n'] || '').trim();
          
          // N·∫øu l√† NV, ch·ªâ hi·ªÉn th·ªã ƒë∆°n h√†ng c·ªßa ch√≠nh h·ªç (l·ªçc ch·∫∑t ch·∫Ω)
          if (viTri === 'NV' || viTri === '') {
            let matches = false;
            
            // So s√°nh v·ªõi c·ªôt t∆∞∆°ng ·ª©ng d·ª±a tr√™n B·ªô ph·∫≠n
            if (currentBoPhan === 'Sale') {
              const nvSale = String(row['Nh√¢n vi√™n Sale'] || '').trim();
              matches = nvSale === hoVaTen;
            } else if (currentBoPhan === 'MKT') {
              const nvMarketing = String(row['Nh√¢n vi√™n Marketing'] || '').trim();
              matches = nvMarketing === hoVaTen;
            } else if (currentBoPhan === 'V·∫≠n ƒê∆°n' || currentBoPhan === 'V·∫≠n H√†nh') {
              const nvVanDon = String(row['NV V·∫≠n ƒë∆°n'] || '').trim();
              matches = nvVanDon === hoVaTen;
            }
            
            // N·∫øu kh√¥ng kh·ªõp, lo·∫°i b·ªè ƒë∆°n h√†ng n√†y
            if (!matches) {
              return false;
            }
          } 
          // N·∫øu l√† Leader, hi·ªÉn th·ªã ƒë∆°n h√†ng c·ªßa team
          else if (viTri === 'Leader') {
            let hasAllowedStaff = false;
            
            // So s√°nh v·ªõi c·ªôt t∆∞∆°ng ·ª©ng d·ª±a tr√™n B·ªô ph·∫≠n
            if (currentBoPhan === 'Sale') {
              const nvSale = String(row['Nh√¢n vi√™n Sale'] || '').trim();
              hasAllowedStaff = nvSale && allowedStaffNames.has(nvSale);
            } else if (currentBoPhan === 'MKT') {
              const nvMarketing = String(row['Nh√¢n vi√™n Marketing'] || '').trim();
              hasAllowedStaff = nvMarketing && allowedStaffNames.has(nvMarketing);
            } else if (currentBoPhan === 'V·∫≠n ƒê∆°n' || currentBoPhan === 'V·∫≠n H√†nh') {
              const nvVanDon = String(row['NV V·∫≠n ƒë∆°n'] || '').trim();
              hasAllowedStaff = nvVanDon && allowedStaffNames.has(nvVanDon);
            }
            
            if (!hasAllowedStaff) return false;
          }
        }

        // T√¨m ki·∫øm text
        if (searchText) {
          const searchableText = Object.values(row)
            .map(v => String(v || '').toLowerCase())
            .join(' ');
          if (!searchableText.includes(searchText)) return false;
        }

        // L·ªçc theo ng√†y
        if (startDate || endDate) {
          const rowDate = row['Ng√†y l√™n ƒë∆°n'] || row['Th·ªùi gian l√™n ƒë∆°n'];
          if (!rowDate) return false;
          
          try {
            const date = new Date(rowDate);
            if (isNaN(date.getTime())) return false;
            
            if (startDate) {
              const start = new Date(startDate);
              start.setHours(0, 0, 0, 0);
              if (date < start) return false;
            }
            
            if (endDate) {
              const end = new Date(endDate);
              end.setHours(23, 59, 59, 999);
              if (date > end) return false;
            }
          } catch {
            return false;
          }
        }

        // Filter Nh√¢n vi√™n Sale (ch·ªâ √°p d·ª•ng n·∫øu KH√îNG c√≥ id trong URL)
        // N·∫øu c√≥ id v√† l√† NV, ƒë√£ l·ªçc ·ªü tr√™n r·ªìi, KH√îNG l·ªçc l·∫°i ·ªü ƒë√¢y
        if (selectedNVSale) {
          // Ch·ªâ √°p d·ª•ng filter dropdown n·∫øu KH√îNG c√≥ currentEmployee ho·∫∑c kh√¥ng c√≥ allowedStaffNames
          const shouldApplyFilter = !currentEmployee || allowedStaffNames === null;
          
          if (shouldApplyFilter) {
            const nvSale = String(row['Nh√¢n vi√™n Sale'] || '').trim();
            if (selectedNVSale === '__EMPTY__') {
              if (nvSale !== '') return false;
            } else {
              if (nvSale !== selectedNVSale) return false;
            }
          }
        }

        // Filter Nh√¢n vi√™n Marketing (ch·ªâ √°p d·ª•ng n·∫øu KH√îNG c√≥ id trong URL)
        if (selectedNVMarketing) {
          const shouldApplyFilter = !currentEmployee || allowedStaffNames === null;
          
          if (shouldApplyFilter) {
            const nvMarketing = String(row['Nh√¢n vi√™n Marketing'] || '').trim();
            if (selectedNVMarketing === '__EMPTY__') {
              if (nvMarketing !== '') return false;
            } else {
              if (nvMarketing !== selectedNVMarketing) return false;
            }
          }
        }

        // Filter NV V·∫≠n ƒë∆°n (ch·ªâ √°p d·ª•ng n·∫øu KH√îNG c√≥ id trong URL)
        if (selectedNVVanDon) {
          const shouldApplyFilter = !currentEmployee || allowedStaffNames === null;
          
          if (shouldApplyFilter) {
            const nvVanDon = String(row['NV V·∫≠n ƒë∆°n'] || '').trim();
            if (selectedNVVanDon === '__EMPTY__') {
              if (nvVanDon !== '') return false;
            } else {
              if (nvVanDon !== selectedNVVanDon) return false;
            }
          }
        }

        // Filter K·∫øt qu·∫£ Check
        if (selectedKetQuaCheck) {
          const ketQuaCheck = String(row['K·∫øt qu·∫£ Check'] || '').trim();
          if (selectedKetQuaCheck === '__EMPTY__') {
            if (ketQuaCheck !== '') return false;
          } else {
            if (ketQuaCheck !== selectedKetQuaCheck) return false;
          }
        }

        // Filter Tr·∫°ng th√°i giao h√†ng NB
        if (selectedTrangThaiGiaoHang) {
          const trangThaiGiaoHang = String(row['Tr·∫°ng th√°i giao h√†ng NB'] || '').trim();
          if (selectedTrangThaiGiaoHang === '__EMPTY__') {
            if (trangThaiGiaoHang !== '') return false;
          } else {
            if (trangThaiGiaoHang !== selectedTrangThaiGiaoHang) return false;
          }
        }

        return true;
      });

      updateStats();
      renderTable();
    }

    // Xu·∫•t Excel
    function exportToExcel() {
      if (filteredData.length === 0) {
        alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!');
        return;
      }

      const headers = [
        'STT',
        'M√£ ƒë∆°n h√†ng',
        'M√£ Tracking',
        'Ng√†y l√™n ƒë∆°n',
        'Name*',
        'T·ªïng ti·ªÅn VNƒê',
        'Nh√¢n vi√™n Sale',
        'Nh√¢n vi√™n Marketing',
        'NV V·∫≠n ƒë∆°n',
        'K·∫øt qu·∫£ Check',
        'Tr·∫°ng th√°i giao h√†ng NB',
        'ƒê∆°n v·ªã v·∫≠n chuy·ªÉn',
        'Tr·∫°ng th√°i thu ti·ªÅn',
        'M·∫∑t h√†ng',
        'Khu v·ª±c'
      ];

      const excelData = [headers];

      filteredData.forEach((row, index) => {
        excelData.push([
          index + 1,
          row['M√£ ƒë∆°n h√†ng'] || '',
          row['M√£ Tracking'] || '',
          formatDate(row['Ng√†y l√™n ƒë∆°n'] || row['Th·ªùi gian l√™n ƒë∆°n']),
          row['Name*'] || row['T√™n l√™n ƒë∆°n'] || '',
          row['T·ªïng ti·ªÅn VNƒê'] || 0,
          row['Nh√¢n vi√™n Sale'] || '',
          row['Nh√¢n vi√™n Marketing'] || '',
          row['NV V·∫≠n ƒë∆°n'] || '',
          row['K·∫øt qu·∫£ Check'] || '',
          row['Tr·∫°ng th√°i giao h√†ng NB'] || '',
          row['ƒê∆°n v·ªã v·∫≠n chuy·ªÉn'] || '',
          row['Tr·∫°ng th√°i thu ti·ªÅn'] || '',
          row['M·∫∑t h√†ng'] || '',
          row['Khu v·ª±c'] || ''
        ]);
      });

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(excelData);
      XLSX.utils.book_append_sheet(wb, ws, 'F3_Data');
      
      const now = new Date();
      const fileName = `F3_Data_${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}.xlsx`;
      
      XLSX.writeFile(wb, fileName);
      alert(`‚úÖ ƒê√£ xu·∫•t ${filteredData.length} d√≤ng d·ªØ li·ªáu th√†nh c√¥ng!`);
    }

    // H√†m set date range t·ª´ th√°ng
    function setDateRangeFromMonth(month) {
      if (!month) {
        document.getElementById('startDate').value = '';
        document.getElementById('endDate').value = '';
        return;
      }
      
      const now = new Date();
      const year = now.getFullYear();
      const monthNum = parseInt(month);
      
      // Ng√†y ƒë·∫ßu th√°ng
      const startDate = new Date(year, monthNum - 1, 1);
      // Ng√†y cu·ªëi th√°ng
      const endDate = new Date(year, monthNum, 0);
      
      document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
      document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
    }

    // H√†m x·ª≠ l√Ω quick filter
    function handleQuickFilter(filterType, clickedBtn) {
      const now = new Date();
      const startDateEl = document.getElementById('startDate');
      const endDateEl = document.getElementById('endDate');
      const monthSelect = document.getElementById('filterMonth');
      
      // X√≥a active class t·ª´ t·∫•t c·∫£ buttons
      document.querySelectorAll('.quick-filter-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Set active cho button ƒë∆∞·ª£c click
      if (clickedBtn && filterType !== 'clear') {
        clickedBtn.classList.add('active');
      }
      
      // Reset th√°ng filter
      if (monthSelect) monthSelect.value = '';
      
      switch(filterType) {
        case 'today':
          const today = now.toISOString().split('T')[0];
          startDateEl.value = today;
          endDateEl.value = today;
          break;
        case 'yesterday':
          const yesterday = new Date(now);
          yesterday.setDate(yesterday.getDate() - 1);
          const yesterdayStr = yesterday.toISOString().split('T')[0];
          startDateEl.value = yesterdayStr;
          endDateEl.value = yesterdayStr;
          break;
        case 'thisWeek':
          const thisWeekStart = new Date(now);
          const day = thisWeekStart.getDay();
          const diff = thisWeekStart.getDate() - day + (day === 0 ? -6 : 1); // Th·ª© 2
          thisWeekStart.setDate(diff);
          const thisWeekEnd = new Date(thisWeekStart);
          thisWeekEnd.setDate(thisWeekEnd.getDate() + 6); // Ch·ªß nh·∫≠t
          startDateEl.value = thisWeekStart.toISOString().split('T')[0];
          endDateEl.value = thisWeekEnd.toISOString().split('T')[0];
          break;
        case 'lastWeek':
          const lastWeekStart = new Date(now);
          const lastDay = lastWeekStart.getDay();
          const lastDiff = lastWeekStart.getDate() - lastDay - 6 + (lastDay === 0 ? -6 : 1);
          lastWeekStart.setDate(lastDiff);
          const lastWeekEnd = new Date(lastWeekStart);
          lastWeekEnd.setDate(lastWeekEnd.getDate() + 6);
          startDateEl.value = lastWeekStart.toISOString().split('T')[0];
          endDateEl.value = lastWeekEnd.toISOString().split('T')[0];
          break;
        case 'thisMonth':
          const thisMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
          const thisMonthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0);
          startDateEl.value = thisMonthStart.toISOString().split('T')[0];
          endDateEl.value = thisMonthEnd.toISOString().split('T')[0];
          break;
        case 'clear':
          startDateEl.value = '';
          endDateEl.value = '';
          if (monthSelect) monthSelect.value = '';
          document.querySelectorAll('.quick-filter-btn').forEach(btn => {
            btn.classList.remove('active');
          });
          break;
      }
      
      applyFilters();
    }

    // Event listeners
    document.getElementById('searchInput').addEventListener('input', applyFilters);
    document.getElementById('startDate').addEventListener('change', function() {
      // Khi thay ƒë·ªïi date th·ªß c√¥ng, x√≥a filter th√°ng
      document.getElementById('filterMonth').value = '';
      applyFilters();
    });
    document.getElementById('endDate').addEventListener('change', function() {
      // Khi thay ƒë·ªïi date th·ªß c√¥ng, x√≥a filter th√°ng
      document.getElementById('filterMonth').value = '';
      applyFilters();
    });
    document.getElementById('filterMonth').addEventListener('change', function() {
      const month = this.value;
      setDateRangeFromMonth(month);
      // X√≥a active class t·ª´ quick filter buttons
      document.querySelectorAll('.quick-filter-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      applyFilters();
    });
    document.getElementById('refreshBtn').addEventListener('click', loadData);
    document.getElementById('exportBtn').addEventListener('click', exportToExcel);
    
    // Quick filter buttons
    document.querySelectorAll('.quick-filter-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const filterType = this.getAttribute('data-filter');
        handleQuickFilter(filterType, this);
      });
    });

    // Pagination event listeners
    document.getElementById('firstPageBtn').addEventListener('click', () => goToPage(1));
    document.getElementById('prevPageBtn').addEventListener('click', () => goToPage(currentPage - 1));
    document.getElementById('nextPageBtn').addEventListener('click', () => goToPage(currentPage + 1));
    document.getElementById('lastPageBtn').addEventListener('click', () => goToPage(totalPages));
    
    document.getElementById('pageSizeSelect').addEventListener('change', function() {
      pageSize = parseInt(this.value);
      currentPage = 1;
      renderTable();
      updateStats();
    });

    // Load d·ªØ li·ªáu khi trang load
    loadData();
  </script>
</body>
</html>


// Dán hàm này vào file Code.gs của bạn
// và XÓA hàm updateSheetData cũ đi.

function updateSheetDataOptimized(changesByRow) {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("TONG"); // <-- THAY TÊN SHEET CỦA BẠN NẾU CẦN
    if (!sheet) {
      throw new Error("Không tìm thấy Sheet 'TONG'.");
    }

    // 1. ĐỌC TOÀN BỘ DỮ LIỆU TỪ SHEET MỘT LẦN DUY NHẤT
    // Đây là bước quan trọng nhất để tăng tốc độ
    const dataRange = sheet.getDataRange();
    const allData = dataRange.getValues();
    const headers = allData[0];

    // 2. TẠO MAP ĐỂ TRA CỨU CHỈ SỐ CỘT NHANH CHÓNG
    // Giúp không phải tìm kiếm tên cột trong vòng lặp
    const columnIndexMap = {};
    headers.forEach((header, index) => {
      columnIndexMap[header] = index;
    });

    const maDonHangColIndex = columnIndexMap['maDonHang'];
    if (maDonHangColIndex === undefined) {
      throw new Error("Không tìm thấy cột 'maDonHang' trong sheet.");
    }
    
    let changesCount = 0;

    // 3. LẶP QUA CÁC THAY ĐỔI VÀ CẬP NHẬT VÀO MẢNG 'allData' TRONG BỘ NHỚ
    // Thao tác trên mảng JavaScript cực kỳ nhanh
    for (let i = 1; i < allData.length; i++) {
      const currentRowMaDonHang = allData[i][maDonHangColIndex];
      
      // Kiểm tra xem mã đơn hàng này có thay đổi không
      if (changesByRow[currentRowMaDonHang]) {
        const updates = changesByRow[currentRowMaDonHang];
        
        for (const columnKey in updates) {
          const colIndex = columnIndexMap[columnKey];
          if (colIndex !== undefined) {
            // Cập nhật giá trị trực tiếp vào mảng 2 chiều
            allData[i][colIndex] = updates[columnKey];
            changesCount++;
          }
        }
      }
    }

    // 4. GHI TOÀN BỘ MẢNG ĐÃ CẬP NHẬT TRỞ LẠI SHEET MỘT LẦN DUY NHẤT
    // Bước này cũng giúp tăng tốc độ đáng kể so với ghi từng ô
    if (changesCount > 0) {
      dataRange.setValues(allData);
    }
    
    return {
      success: true,
      message: `Cập nhật thành công ${changesCount} thay đổi!`
    };

  } catch (e) {
    Logger.log(e);
    return {
      success: false,
      message: `Đã xảy ra lỗi: ${e.message}`
    };
  }
}

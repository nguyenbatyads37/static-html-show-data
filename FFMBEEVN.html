<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>Danh sách đơn hàng vận chuyển bởi BEE</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      padding: 20px;
      font-size: 14px;
    }
    h1 {
      color: #333;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      table-layout: fixed; /* Giúp cột đều hơn */
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px 10px;
      text-align: left;
      white-space: nowrap;      /* Ngăn xuống dòng */
      overflow: hidden;         /* Ẩn nội dung thừa */
      text-overflow: ellipsis;  /* Hiển thị '...' */
      position: relative; /* Cần thiết cho drag-handle */
    }
    th {
      background-color: #f2f2f2;
      font-weight: bold;
      position: sticky; /* Giữ header cố định khi cuộn */
      top: 0;
      z-index: 2;
    }
    tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    #loading-message, #error-message {
      font-size: 1.2em;
      color: #555;
      font-style: italic;
      margin-top: 20px;
    }
    #error-message {
      color: red;
      font-weight: bold;
    }

    /* === CSS cho các tính năng chỉnh sửa === */
    .editable-cell {
      background-color: #e8f0fe; /* Màu nền nhẹ để phân biệt */
      cursor: cell;
    }
    .editable-cell:focus {
      outline: 2px solid #4285f4; /* Viền xanh khi focus */
      background-color: #fff;
      white-space: normal; /* Cho phép text xuống dòng khi sửa */
      overflow: visible;
    }
    
    /* Tay cầm để kéo (drag handle) */
    .drag-handle {
      position: absolute;
      right: 0;
      bottom: 0;
      width: 8px;
      height: 8px;
      background-color: #4285f4;
      cursor: crosshair;
      display: none; /* Mặc định ẩn */
      z-index: 10;
    }
    
    /* Hiển thị handle khi focus vào ô cha */
    .editable-cell:focus .drag-handle {
      display: block;
    }

    /* Viền cho vùng chọn khi kéo */
    .drag-selection {
        border: 2px dotted #4285f4 !important;
    }
  </style>
</head>
<body>

  <h1>Danh sách đơn hàng vận chuyển bởi "BEE"</h1>
  <div id="loading-message">Đang tải dữ liệu, vui lòng chờ...</div>
  <div id="error-message" style="display: none;"></div>

  <div style="overflow-x: auto;"> <!-- Container cho phép cuộn ngang -->
    <table id="data-table">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>

<script>
  // ==========================================================
  // CẤU HÌNH TRUNG TÂM
  // ==========================================================
  const API_URL = "https://script.google.com/macros/s/AKfycbwqkdJyB7KGfY7yOEWzNpouDxJAAotREMtNwtQTN1uZ_22eMthIOHjN4t_OknZdjloS/exec";

  // Ánh xạ tên biến sang Tiếng Việt (thứ tự cột sẽ theo thứ tự này)
  const COLUMN_MAPPING = {
    maDonHang: 'Mã Đơn Hàng',
    ngayLenDon: 'Ngày Lên Đơn',
    tenKhachHang: 'Tên Khách Hàng',
    sdtKhach: 'SĐT Khách',
    diaChiGiao: 'Địa Chỉ Giao',
    tenSanPham: 'Tên Sản Phẩm',
    maVanDon: 'Mã Vận Đơn',
    thoiGianGiaoDuKien: 'Thời Gian Giao Dự Kiến',
    ghiChuNB: 'Ghi Chú Nội Bộ',
    tenSale: 'Tên Sale',
    // --- Các biến sẽ bị ẩn ---
    nvVanDon: 'NV Vận Đơn',
    ketQuaCheck: 'Kết Quả Check',
    trangThaiGiaoHangNB: 'Trạng Thái Giao Hàng NB',
    lyDo: 'Lý Do',
    donViVanChuyen: 'Đơn Vị Vận Chuyển',
    tenLenDon: 'Tên Lên Đơn'
  };

  // Danh sách các cột cần ẨN khỏi bảng
  const HIDDEN_COLUMNS = [
    'nvVanDon', 'ketQuaCheck', 'trangThaiGiaoHangNB', 
    'lyDo', 'donViVanChuyen', 'tenLenDon'
  ];

  // Danh sách các cột có thể CHỈNH SỬA
  const EDITABLE_COLUMNS = ['maVanDon', 'ghiChuNB'];

  // Danh sách các cột cần định dạng NGÀY THÁNG
  const DATE_COLUMNS = ['ngayLenDon', 'thoiGianGiaoDuKien'];

  // ==========================================================
  // LOGIC CHÍNH
  // ==========================================================
  
  // Hàm định dạng ngày tháng từ chuỗi ISO
  function formatDateTime(isoString) {
    if (!isoString) return '';
    try {
      const date = new Date(isoString);
      if (isNaN(date)) return isoString; // Trả về chuỗi gốc nếu không hợp lệ
      
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      
      return `${day}/${month}/${year} ${hours}:${minutes}`;
    } catch (e) {
      return isoString; // An toàn nếu có lỗi
    }
  }

  // Hàm chính để lấy dữ liệu và xây dựng bảng
  async function fetchDataAndBuildTable() {
    const loadingDiv = document.getElementById('loading-message');
    const errorDiv = document.getElementById('error-message');
    const table = document.getElementById('data-table');
    const tableHead = table.querySelector('thead');
    const tableBody = table.querySelector('tbody');

    try {
      const response = await fetch(API_URL);
      if (!response.ok) throw new Error(`Lỗi HTTP! Trạng thái: ${response.status}`);
      const allData = await response.json();
      
      const filteredData = allData.filter(item => item.donViVanChuyen === "BEE");

      loadingDiv.style.display = 'none';

      if (filteredData.length === 0) {
        errorDiv.textContent = 'Không tìm thấy đơn hàng nào được vận chuyển bởi "BEE".';
        errorDiv.style.display = 'block';
        return;
      }
      
      // Lấy danh sách các key sẽ được hiển thị (đã lọc các cột ẩn)
      const visibleColumns = Object.keys(COLUMN_MAPPING).filter(key => !HIDDEN_COLUMNS.includes(key));
      
      // 1. TẠO TIÊU ĐỀ BẢNG
      let headerRow = '<tr>';
      visibleColumns.forEach(key => {
        headerRow += `<th>${COLUMN_MAPPING[key]}</th>`;
      });
      headerRow += '</tr>';
      tableHead.innerHTML = headerRow;

      // 2. TẠO CÁC HÀNG DỮ LIỆU
      tableBody.innerHTML = ''; // Xóa nội dung cũ
      filteredData.forEach(rowData => {
        const rowEl = document.createElement('tr');
        visibleColumns.forEach(key => {
          const cellEl = document.createElement('td');
          let cellValue = rowData[key] ?? '';

          // Định dạng ngày tháng
          if (DATE_COLUMNS.includes(key)) {
            cellValue = formatDateTime(cellValue);
          }
          
          cellEl.textContent = cellValue;
          
          // Thêm thuộc tính cho các ô có thể chỉnh sửa
          if (EDITABLE_COLUMNS.includes(key)) {
            cellEl.classList.add('editable-cell');
            cellEl.setAttribute('contenteditable', 'true');
            
            // Thêm handle để kéo
            const dragHandle = document.createElement('div');
            dragHandle.className = 'drag-handle';
            cellEl.appendChild(dragHandle);
          }
          
          rowEl.appendChild(cellEl);
        });
        tableBody.appendChild(rowEl);
      });
      
      // 3. Khởi tạo các tính năng tương tác
      initializeInteractiveFeatures();

    } catch (error) {
      loadingDiv.style.display = 'none';
      errorDiv.textContent = 'Đã xảy ra lỗi khi tải dữ liệu: ' + error.message;
      errorDiv.style.display = 'block';
      console.error("Lỗi chi tiết:", error);
    }
  }

  // Hàm khởi tạo các sự kiện cho bảng
  function initializeInteractiveFeatures() {
    const tableBody = document.getElementById('data-table').querySelector('tbody');
    
    // Xử lý sự kiện DÁN (PASTE)
    tableBody.addEventListener('paste', handlePaste);
    
    // Xử lý sự kiện KÉO ĐỂ ĐIỀN (DRAG-FILL)
    let isDragging = false;
    let startCell = null;
    let fillValue = '';

    tableBody.addEventListener('mousedown', (e) => {
        if (e.target.classList.contains('drag-handle')) {
            isDragging = true;
            startCell = e.target.parentElement;
            fillValue = startCell.textContent;
            e.preventDefault(); // Ngăn hành vi mặc định
            
            // Xóa các vùng chọn cũ
            document.querySelectorAll('.drag-selection').forEach(el => el.classList.remove('drag-selection'));
            startCell.classList.add('drag-selection');
        }
    });

    tableBody.addEventListener('mouseover', (e) => {
        if (isDragging && e.target.tagName === 'TD') {
            const endCell = e.target;
            const startColumnIndex = startCell.cellIndex;
            const endColumnIndex = endCell.cellIndex;

            // Chỉ cho phép kéo trong cùng một cột
            if (startColumnIndex === endColumnIndex) {
                 updateDragSelection(startCell, endCell);
            }
        }
    });
    
    document.addEventListener('mouseup', (e) => {
        if (isDragging) {
            isDragging = false;
            // Áp dụng giá trị cho các ô đã chọn
            document.querySelectorAll('.drag-selection').forEach(cell => {
                // Chỉ điền nếu ô đó có thể chỉnh sửa
                if (cell.classList.contains('editable-cell')) {
                    // Lấy textContent mà không có div của drag-handle
                    const handle = cell.querySelector('.drag-handle');
                    if(handle) cell.textContent = ''; // Xóa text cũ và cả handle
                    cell.textContent = fillValue;
                    if(handle) cell.appendChild(handle); // Gắn lại handle
                }
            });
            startCell = null;
        }
    });
  }
  
  function updateDragSelection(start, end) {
      document.querySelectorAll('.drag-selection').forEach(el => el.classList.remove('drag-selection'));
      const tableRows = Array.from(document.getElementById('data-table').rows);
      const startRowIndex = start.parentElement.rowIndex;
      const endRowIndex = end.parentElement.rowIndex;
      const colIndex = start.cellIndex;
      
      const minRow = Math.min(startRowIndex, endRowIndex);
      const maxRow = Math.max(startRowIndex, endRowIndex);

      for(let i = minRow; i <= maxRow; i++) {
          tableRows[i].cells[colIndex]?.classList.add('drag-selection');
      }
  }

  // Hàm xử lý dán dữ liệu
  function handlePaste(e) {
    const targetCell = e.target;
    if (!targetCell.classList.contains('editable-cell')) return;

    e.preventDefault();
    const pasteData = (e.clipboardData || window.clipboardData).getData('text');
    const lines = pasteData.trim().split(/\r\n|\n|\r/); // Tách theo các loại xuống dòng

    let currentRow = targetCell.parentElement;
    const cellIndex = targetCell.cellIndex;

    lines.forEach((line, index) => {
      if (!currentRow) return;
      const cellToUpdate = currentRow.cells[cellIndex];
      
      if (cellToUpdate && cellToUpdate.classList.contains('editable-cell')) {
        // Lấy handle ra trước khi gán text
        const handle = cellToUpdate.querySelector('.drag-handle');
        if(handle) cellToUpdate.textContent = ''; // Xóa text cũ và cả handle
        cellToUpdate.textContent = line;
        if(handle) cellToUpdate.appendChild(handle); // Gắn lại handle
      }
      
      currentRow = currentRow.nextElementSibling; // Di chuyển xuống hàng tiếp theo
    });
  }

  // Gọi hàm chính khi trang tải xong
  window.addEventListener('load', fetchDataAndBuildTable);

</script>
</body>
</html>

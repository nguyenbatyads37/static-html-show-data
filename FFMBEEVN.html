<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Mã Tracking - BEE</title>
    <style>
        /* [Giữ nguyên toàn bộ phần CSS như trước] */
        /* ... */
    </style>
</head>
<body>
    <!-- [Giữ nguyên phần HTML như trước] -->
    <!-- ... -->

    <script>
        // Global variables
        let allData = [];
        let filteredData = [];
        let changedData = {};
        let currentTab = 'all';
        let currentPage = 1;
        let rowsPerPage = 100;
        
        // THAY THẰNG URL CỦA BẠN VÀO ĐÂY
        const DATA_URL = 'https://script.google.com/macros/s/YOUR_DATA_SCRIPT_ID/exec';
        const UPDATE_URL = 'https://script.google.com/macros/s/YOUR_UPDATE_SCRIPT_ID/exec';
        
        // [Giữ nguyên phần DOM elements như trước]
        // ...

        // ==================== CÁC HÀM CHÍNH ====================

        async function loadData() {
            try {
                tableContainer.innerHTML = '<div class="loading">Đang tải dữ liệu...</div>';
                saveAllBtn.style.display = 'none';
                changedData = {};
                
                const response = await fetch(`${DATA_URL}?t=${Date.now()}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const result = await response.json();
                
                // Xử lý nhiều định dạng response khác nhau
                if (Array.isArray(result)) {
                    allData = result;
                } else if (result.data) {
                    allData = result.data;
                } else {
                    allData = Object.values(result);
                }
                
                // Lọc chỉ lấy đơn vị vận chuyển BEE
                allData = allData.filter(item => item['Đơn vị vận chuyển'] === 'BEE');
                
                createTabs();
                filterDataByTab(currentTab);
                
            } catch (error) {
                console.error('Lỗi tải dữ liệu:', error);
                showNotification(`Lỗi tải dữ liệu: ${error.message}`, true);
                tableContainer.innerHTML = `<div class="error">Lỗi tải dữ liệu: ${error.message}</div>`;
            }
        }

        // Hàm lưu từng dòng (đã sửa lỗi undefined)
        async function saveChanges(maDonHang) {
            if (!maDonHang || !changedData[maDonHang]) {
                console.error('Không có dữ liệu thay đổi để lưu');
                return;
            }

            try {
                // Chuẩn bị payload đúng cấu trúc
                const payload = {
                    "Mã đơn hàng": maDonHang,
                    "Mã Tracking": changedData[maDonHang]["Mã Tracking"] || "" // Fallback nếu undefined
                };

                console.log('Dữ liệu gửi đi:', payload); // Log để debug

                const response = await fetch(UPDATE_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const result = await response.json();
                console.log('Kết quả trả về:', result); // Log để debug

                if (result.status === "success") {
                    delete changedData[maDonHang];
                    showNotification(`Đã cập nhật mã đơn ${maDonHang} thành công!`);
                    
                    // Ẩn dòng nếu đã có tracking
                    const row = document.querySelector(`tr[data-id="${maDonHang}"]`);
                    if (row) {
                        const trackingCell = row.querySelector('[data-field="Mã Tracking"]');
                        if (trackingCell && trackingCell.textContent.trim()) {
                            row.classList.add('hidden-row');
                        }
                    }
                    
                    // Disable nút lưu
                    const saveBtn = document.querySelector(`.save-btn[data-id="${maDonHang}"]`);
                    if (saveBtn) saveBtn.disabled = true;
                    
                    // Ẩn nút "Lưu tất cả" nếu không còn thay đổi
                    if (Object.keys(changedData).length === 0) {
                        saveAllBtn.style.display = 'none';
                    }
                } else {
                    throw new Error(result.message || "Lỗi từ server");
                }
            } catch (error) {
                console.error(`Lỗi khi lưu ${maDonHang}:`, error);
                showNotification(`Lỗi khi lưu ${maDonHang}: ${error.message}`, true);
            }
        }

        // Hàm lưu tất cả (đã xử lý lỗi undefined)
        async function saveAllChanges() {
            if (Object.keys(changedData).length === 0) return;

            saveAllBtn.disabled = true;
            const originalText = saveAllBtn.textContent;
            saveAllBtn.textContent = "ĐANG LƯU...";
            
            try {
                const results = [];
                for (const [maDonHang, changes] of Object.entries(changedData)) {
                    if (!maDonHang || !changes) continue;
                    
                    try {
                        const payload = {
                            "Mã đơn hàng": maDonHang,
                            "Mã Tracking": changes["Mã Tracking"] || ""
                        };

                        const response = await fetch(UPDATE_URL, {
                            method: 'POST',
                            body: JSON.stringify(payload),
                            headers: { 'Content-Type': 'application/json' }
                        });

                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        
                        const result = await response.json();
                        if (result.status === "success") {
                            results.push({ success: true, maDonHang });
                        } else {
                            throw new Error(result.message || "Lỗi từ server");
                        }
                    } catch (error) {
                        console.error(`Lỗi ${maDonHang}:`, error);
                        results.push({ 
                            success: false, 
                            maDonHang, 
                            error: error.message 
                        });
                    }
                }

                // Hiển thị kết quả
                const successCount = results.filter(r => r.success).length;
                const errorCount = results.length - successCount;
                
                if (errorCount > 0) {
                    showNotification(`Đã lưu ${successCount} đơn, ${errorCount} lỗi`, true);
                } else {
                    showNotification(`Đã lưu thành công ${successCount} đơn!`);
                }
                
                // Làm mới dữ liệu
                await loadData();
                
            } catch (error) {
                console.error('Lỗi nghiêm trọng:', error);
                showNotification(`Lỗi hệ thống: ${error.message}`, true);
            } finally {
                saveAllBtn.disabled = false;
                saveAllBtn.textContent = originalText;
            }
        }

        // ==================== CÁC HÀM HỖ TRỢ ====================

        function addCellEventListeners() {
            // Xử lý ô editable
            document.querySelectorAll('td.editable[contenteditable="true"]').forEach(cell => {
                cell.addEventListener('input', function() {
                    const row = this.closest('tr');
                    const maDonHang = row.getAttribute('data-id');
                    const field = this.getAttribute('data-field');
                    
                    if (!maDonHang) {
                        console.error('Không tìm thấy mã đơn hàng');
                        return;
                    }
                    
                    // Khởi tạo nếu chưa có
                    if (!changedData[maDonHang]) {
                        changedData[maDonHang] = {};
                    }
                    
                    // Lưu thay đổi
                    changedData[maDonHang][field] = this.textContent.trim();
                    
                    // Kích hoạt nút lưu
                    const saveBtn = row.querySelector('.save-btn');
                    if (saveBtn) {
                        saveBtn.disabled = false;
                        saveAllBtn.style.display = 'block';
                    }
                });
            });
            
            // Xử lý dropdown
            document.querySelectorAll('.editable-select select').forEach(select => {
                select.addEventListener('change', function() {
                    const row = this.closest('tr');
                    const maDonHang = row.getAttribute('data-id');
                    const field = this.closest('td').getAttribute('data-field');
                    const newValue = this.value;
                    
                    if (!maDonHang) return;
                    
                    // Cập nhật màu dropdown
                    this.style.backgroundColor = CHECK_RESULT_COLORS[newValue] || CHECK_RESULT_COLORS[''];
                    
                    // Lưu thay đổi
                    if (!changedData[maDonHang]) {
                        changedData[maDonHang] = {};
                    }
                    changedData[maDonHang][field] = newValue;
                    
                    // Kích hoạt nút lưu
                    const saveBtn = row.querySelector('.save-btn');
                    if (saveBtn) {
                        saveBtn.disabled = false;
                        saveAllBtn.style.display = 'block';
                    }
                });
            });
            
            // Xử lý nút lưu từng dòng
            document.querySelectorAll('.save-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const maDonHang = this.getAttribute('data-id');
                    if (maDonHang) {
                        await saveChanges(maDonHang);
                    }
                });
            });
        }

        // [Các hàm khác giữ nguyên]
        // ...

        // Khởi động ứng dụng
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            
            // [Các event listener khác giữ nguyên]
            // ...
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Mã Tracking</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f7fa;
            color: #333;
        }
        .container {
            max-width: 100%;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .control-panel {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .search-box {
            flex-grow: 1;
            display: flex;
            gap: 10px;
        }
        input, button {
            padding: 10px 15px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-size: 16px;
        }
        input {
            flex-grow: 1;
            min-width: 200px;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
            white-space: nowrap;
        }
        button:hover {
            background-color: #2980b9;
        }
        button.success {
            background-color: #2ecc71;
        }
        button.success:hover {
            background-color: #27ae60;
        }
        button.danger {
            background-color: #e74c3c;
        }
        button.danger:hover {
            background-color: #c0392b;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }
        th, td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            white-space: nowrap;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
            position: sticky;
            top: 0;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .status {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            display: inline-block;
            min-width: 120px;
            text-align: center;
        }
        .status-pending {
            background-color: #f39c12;
            color: white;
        }
        .status-completed {
            background-color: #2ecc71;
            color: white;
        }
        .editable {
            background-color: #fffde7;
            cursor: pointer;
        }
        .editable:hover {
            background-color: #fff9c4;
        }
        .loading {
            text-align: center;
            padding: 40px;
            font-style: italic;
            color: #7f8c8d;
        }
        .error {
            color: #e74c3c;
            text-align: center;
            padding: 20px;
        }
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 4px;
            color: white;
            background-color: #2ecc71;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
        }
        .notification.error {
            background-color: #e74c3c;
        }
        .fixed-column {
            position: sticky;
            left: 0;
            background-color: white;
            z-index: 1;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #f1f1f1;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
        }
        .tab.active {
            background-color: #3498db;
            color: white;
        }
        @media (max-width: 768px) {
            .control-panel {
                flex-direction: column;
            }
            .search-box {
                width: 100%;
            }
            th, td {
                padding: 6px 8px;
                font-size: 12px;
            }
            .tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
            }
            .tab {
                padding: 8px 12px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>QUẢN LÝ MÃ TRACKING</h1>
        
        <div class="tabs" id="tabsContainer">
            <!-- Tabs sẽ được tạo động bằng JavaScript -->
        </div>
        
        <div class="control-panel">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Tìm kiếm theo mã đơn hàng hoặc tracking...">
                <button id="searchBtn">Tìm kiếm</button>
            </div>
            <div class="action-buttons">
                <button id="refreshBtn" class="success">Làm mới dữ liệu</button>
                <button id="saveAllBtn" class="success" style="display: none;">Lưu tất cả thay đổi</button>
            </div>
        </div>
        
        <div id="tableContainer">
            <div class="loading">Đang tải dữ liệu...</div>
        </div>
    </div>
    
    <div id="notification" class="notification"></div>

    <script>
        // Biến toàn cục
        let allData = [];
        let filteredData = [];
        let changedData = {};
        let currentTab = 'all';
        const DATA_URL = 'https://script.google.com/macros/s/AKfycbyDGqwYSX0Sxxlom-q29UhB2CJVGpTttVctWYNOfqMDCv4MkGmmMShtROnrgZYOgn9Opw/exec';
        const UPDATE_URL = 'https://script.google.com/macros/s/AKfycbzs8_0mubkmfnbQkpRjneoRpXYJIvXBzyfWUzbhsH5JZ6MYU6QAqSkoBebjwtbsbOGRTA/exec';
        
        // DOM elements
        const tableContainer = document.getElementById('tableContainer');
        const tabsContainer = document.getElementById('tabsContainer');
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const saveAllBtn = document.getElementById('saveAllBtn');
        const notification = document.getElementById('notification');
        
        // Danh sách cột cố định sẽ hiển thị
        const DISPLAY_COLUMNS = [
            'Mã đơn hàng',
            'Mã Tracking',
            'Ngày lên đơn',
            'Name*',
            'Phone*',
            'Add',
            'City',
            'State',
            'Zipcode',
            'Mặt hàng',
            'Tên mặt hàng 1',
            'Số lượng mặt hàng 1',
            'Tên mặt hàng 2',
            'Số lượng mặt hàng 2',
            'Quà tặng',
            'Số lượng quà kèm',
            'Giá bán',
            'Loại tiền thanh toán',
            'Tổng tiền VNĐ',
            'Hình thức thanh toán',
            'Ghi chú',
            'Nhân viên Sale',
            'Nhân viên Marketing',
            'NV Vận đơn',
            'Kết quả Check',
            'Trạng thái giao hàng NB',
            'Lý do',
            'Đơn vị vận chuyển',
            'Trạng thái thu tiền',
            'Ngày hẹn đẩy đơn',
            'Số tiền thực thu',
            'Ngày Up bill',
            'Ảnh bill',
            'Ngày chuyển khoản',
            'Loại thanh toán',
            'Tên người chuyển khoản',
            'Tài khoản nhận',
            'Số tiền đã nhận',
            'Tỷ giá cước',
            'Đơn vị tiền đối soát',
            'Ngày đối soát cước',
            'Tiền ship',
            'Tỷ giá',
            'Đơn vị tiền tệ tính cước',
            'Thời gian lên đơn',
            'Ghi chú của FFM',
            'FFM thanh toán',
            'Ngày đối soát bill',
            'Ngày Kế toán đối soát với FFM lần 1',
            'Số tiền về TK Cty từ FFM lần 1',
            'Ngày Kế toán đối soát với FFM lần 2',
            'Tiền Việt đã đối soát',
            'Ngày Kế toán đối soát với FFM lần 3',
            'Ca',
            'Tổng số tiền từ FFM',
            'Số tiền về TK Cty ngoài FFM',
            'Số tiền của đơn hàng đã về TK Cty',
            'Kế toán xác nhận thu tiền về',
            'Thông tin đơn',
            'Thông tin khách hàng',
            'Thông tin nhân sự',
            'Phản hồi tích cực',
            'Phản hồi tiêu cực',
            'count',
            'Phân loại KH',
            'Xác nhận đơn',
            'Diễn giải',
            'Tên page',
            'Giá gốc',
            'Màu backlist',
            'Trạng thái đơn',
            'Tiền chiết khấu',
            'Phí ship',
            'Tiền sau ship',
            'Tên lên đơn',
            'Tạo bản in',
            'in',
            'Cảnh báo Blacklist, Trùng đơn',
            'Khu vực',
            'Phí lưu kho',
            'Team',
            'Mã check',
            'Ghi chú của BEE',
            'Đánh dấu',
            'Ngày đóng hàng',
            'Trạng thái giao hàng',
            'Thời gian giao dự kiến',
            'Phí ship nội địa Mỹ (usd)',
            'Phí xử lý đơn đóng hàng-Lưu kho(usd)',
            'GHI CHÚ',
            'Ngày đối soát',
            'Time kế toán xác nhận',
            'Ghi chú của VĐ',
            'Đơn vị thanh toán',
            'Tài khoản thanh toán',
            'Update',
            'Trạng thái dvvc',
            'Nhập kho',
            'Tổng phí vc',
            'Tiền cước',
            'Số tiền đối soát',
            'maDonHang'
        ];
        
        // Hàm hiển thị thông báo
        function showNotification(message, isError = false) {
            notification.textContent = message;
            notification.className = isError ? 'notification error' : 'notification';
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        // Hàm tải dữ liệu
        async function loadData() {
            try {
                tableContainer.innerHTML = '<div class="loading">Đang tải dữ liệu...</div>';
                saveAllBtn.style.display = 'none';
                changedData = {};
                
                const response = await fetch(DATA_URL);
                if (!response.ok) {
                    throw new Error('Không thể tải dữ liệu từ server');
                }
                
                const result = await response.json();
                
                // Kiểm tra cấu trúc dữ liệu trả về
                if (!result || typeof result !== 'object') {
                    throw new Error('Dữ liệu không hợp lệ từ server');
                }
                
                // Chuyển đổi dữ liệu thành mảng
                if (Array.isArray(result)) {
                    allData = result;
                } else if (result.data && Array.isArray(result.data)) {
                    allData = result.data;
                } else if (result.records && Array.isArray(result.records)) {
                    allData = result.records;
                } else {
                    // Nếu không phải mảng, chuyển đổi thành mảng
                    allData = Object.keys(result).map(key => {
                        return { ...result[key], id: key };
                    });
                }
                
                // Lọc chỉ hiển thị các đơn có Đơn vị vận chuyển là BEE
                allData = allData.filter(item => item['Đơn vị vận chuyển'] === 'BEE');
                
                // Tạo các tab theo Khu vực
                createTabs();
                
                // Hiển thị dữ liệu ban đầu
                filterDataByTab(currentTab);
            } catch (error) {
                tableContainer.innerHTML = `<div class="error">Lỗi khi tải dữ liệu: ${error.message}</div>`;
                console.error('Lỗi:', error);
            }
        }
        
        // Hàm tạo các tab theo Khu vực
        function createTabs() {
            tabsContainer.innerHTML = '';
            
            // Lấy danh sách các khu vực duy nhất
            const regions = [...new Set(allData.map(item => item['Khu vực'] || 'Khác'))];
            
            // Tạo tab "Tất cả"
            const allTab = document.createElement('div');
            allTab.className = 'tab active';
            allTab.textContent = 'Tất cả';
            allTab.onclick = () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                allTab.classList.add('active');
                currentTab = 'all';
                filterDataByTab('all');
            };
            tabsContainer.appendChild(allTab);
            
            // Tạo các tab theo khu vực
            regions.forEach(region => {
                const tab = document.createElement('div');
                tab.className = 'tab';
                tab.textContent = region;
                tab.onclick = () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentTab = region;
                    filterDataByTab(region);
                };
                tabsContainer.appendChild(tab);
            });
        }
        
        // Hàm lọc dữ liệu theo tab
        function filterDataByTab(tab) {
            if (tab === 'all') {
                filteredData = [...allData];
            } else {
                filteredData = allData.filter(item => item['Khu vực'] === tab);
            }
            
            // Áp dụng tìm kiếm nếu có
            const keyword = searchInput.value.toLowerCase().trim();
            if (keyword) {
                filteredData = filteredData.filter(item => {
                    return (
                        (item['Mã đơn hàng'] && item['Mã đơn hàng'].toLowerCase().includes(keyword)) ||
                        (item['Mã Tracking'] && item['Mã Tracking'].toLowerCase().includes(keyword)) ||
                        (item['Name*'] && item['Name*'].toLowerCase().includes(keyword)) ||
                        (item['Phone*'] && item['Phone*'].toLowerCase().includes(keyword)) ||
                        (item['Nhân viên Sale'] && item['Nhân viên Sale'].toLowerCase().includes(keyword))
                    );
                });
            }
            
            renderTable(filteredData);
        }
        
        // Hàm hiển thị bảng
        function renderTable(data) {
            if (!Array.isArray(data)) {
                tableContainer.innerHTML = '<div class="error">Dữ liệu không hợp lệ: không phải mảng</div>';
                return;
            }
            
            if (data.length === 0) {
                tableContainer.innerHTML = '<div class="error">Không tìm thấy dữ liệu phù hợp</div>';
                return;
            }
            
            let html = `
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th class="fixed-column">STT</th>
            `;
            
            // Tạo header từ danh sách cột cố định
            DISPLAY_COLUMNS.forEach(column => {
                html += `<th>${column}</th>`;
            });
            
            html += `
                                <th class="fixed-column">Thao Tác</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.forEach((item, index) => {
                const hasTracking = item['Mã Tracking'] && item['Mã Tracking'].trim() !== '';
                const statusClass = hasTracking ? 'status-completed' : 'status-pending';
                const statusText = hasTracking ? 'Đã có tracking' : 'Chưa có tracking';
                
                // Kiểm tra xem có thay đổi nào chưa lưu không
                const isChanged = changedData[item['Mã đơn hàng']] !== undefined;
                const trackingValue = isChanged ? changedData[item['Mã đơn hàng']] : item['Mã Tracking'];
                
                html += `
                    <tr data-id="${item['Mã đơn hàng'] || index}">
                        <td class="fixed-column">${index + 1}</td>
                `;
                
                // Thêm các ô dữ liệu theo danh sách cột cố định
                DISPLAY_COLUMNS.forEach(column => {
                    if (column === 'Mã Tracking') {
                        html += `<td class="editable" contenteditable="true" data-field="${column}">${item[column] || ''}</td>`;
                    } else {
                        html += `<td>${item[column] || ''}</td>`;
                    }
                });
                
                html += `
                        <td class="fixed-column">
                            <button class="save-btn" data-id="${item['Mã đơn hàng'] || index}" ${!isChanged ? 'disabled' : ''}>
                                Lưu
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            tableContainer.innerHTML = html;
            
            // Thêm sự kiện cho các ô có thể chỉnh sửa
            document.querySelectorAll('[contenteditable="true"]').forEach(cell => {
                cell.addEventListener('focus', function() {
                    this.dataset.original = this.textContent;
                });
                
                cell.addEventListener('blur', function() {
                    const newValue = this.textContent.trim();
                    const originalValue = this.dataset.original || '';
                    const row = this.closest('tr');
                    const maDonHang = row.getAttribute('data-id');
                    const field = this.getAttribute('data-field');
                    
                    if (newValue !== originalValue) {
                        if (!changedData[maDonHang]) {
                            changedData[maDonHang] = {};
                        }
                        changedData[maDonHang][field] = newValue;
                        
                        // Kích hoạt nút lưu
                        const saveBtn = row.querySelector('.save-btn');
                        if (saveBtn) saveBtn.disabled = false;
                        
                        // Hiển thị nút lưu tất cả nếu có thay đổi
                        if (Object.keys(changedData).length > 0) {
                            saveAllBtn.style.display = 'block';
                        }
                    }
                });
            });
            
            // Thêm sự kiện cho các nút lưu từng dòng
            document.querySelectorAll('.save-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const maDonHang = this.getAttribute('data-id');
                    await saveChanges(maDonHang);
                });
            });
        }
        
        // Hàm lưu thay đổi
        async function saveChanges(maDonHang) {
            if (!changedData[maDonHang]) return;
            
            try {
                const trackingValue = changedData[maDonHang]['Mã Tracking'] || '';
                
                const formData = new URLSearchParams();
                formData.append('maDonHang', maDonHang);
                formData.append('maTracking', trackingValue);
                
                const response = await fetch(UPDATE_URL, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Lỗi kết nối khi lưu dữ liệu');
                }
                
                const result = await response.json();
                
                if (result.status === 'ok') {
                    // Xóa khỏi danh sách thay đổi
                    delete changedData[maDonHang];
                    
                    // Cập nhật UI
                    const saveBtn = document.querySelector(`.save-btn[data-id="${maDonHang}"]`);
                    if (saveBtn) saveBtn.disabled = true;
                    
                    // Ẩn nút lưu tất cả nếu không còn thay đổi
                    if (Object.keys(changedData).length === 0) {
                        saveAllBtn.style.display = 'none';
                    }
                    
                    showNotification('Cập nhật mã tracking thành công!');
                    
                    // Làm mới dữ liệu sau 1 giây
                    setTimeout(loadData, 1000);
                } else {
                    throw new Error(result.message || 'Lỗi khi cập nhật dữ liệu');
                }
            } catch (error) {
                console.error('Lỗi khi lưu:', error);
                showNotification(`Lỗi: ${error.message}`, true);
            }
        }
        
        // Hàm lưu tất cả thay đổi
        async function saveAllChanges() {
            if (Object.keys(changedData).length === 0) return;
            
            try {
                saveAllBtn.disabled = true;
                saveAllBtn.textContent = 'Đang lưu...';
                
                // Tạo mảng promises để gửi tất cả các yêu cầu
                const promises = Object.keys(changedData).map(maDonHang => {
                    const trackingValue = changedData[maDonHang]['Mã Tracking'] || '';
                    
                    const formData = new URLSearchParams();
                    formData.append('maDonHang', maDonHang);
                    formData.append('maTracking', trackingValue);
                    
                    return fetch(UPDATE_URL, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        }
                    });
                });
                
                // Gửi tất cả yêu cầu cùng lúc
                const responses = await Promise.all(promises);
                
                // Kiểm tra kết quả
                for (const response of responses) {
                    if (!response.ok) {
                        throw new Error('Một số cập nhật không thành công');
                    }
                }
                
                // Xóa tất cả thay đổi
                changedData = {};
                saveAllBtn.style.display = 'none';
                saveAllBtn.textContent = 'Lưu tất cả thay đổi';
                
                showNotification('Đã lưu tất cả thay đổi thành công!');
                
                // Làm mới dữ liệu sau 1 giây
                setTimeout(loadData, 1000);
            } catch (error) {
                console.error('Lỗi khi lưu tất cả:', error);
                showNotification(`Lỗi: ${error.message}`, true);
                saveAllBtn.disabled = false;
                saveAllBtn.textContent = 'Lưu tất cả thay đổi';
            }
        }
        
        // Hàm tìm kiếm
        function searchData() {
            filterDataByTab(currentTab);
        }
        
        // Sự kiện
        searchBtn.addEventListener('click', searchData);
        searchInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') searchData();
        });
        
        refreshBtn.addEventListener('click', loadData);
        saveAllBtn.addEventListener('click', saveAllChanges);
        
        // Tải dữ liệu ban đầu
        loadData();
    </script>
</body>
</html>

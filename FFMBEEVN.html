<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Mã Tracking</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f7fa;
            color: #333;
        }
        .container {
            max-width: 100%;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .control-panel {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .search-box {
            flex-grow: 1;
            display: flex;
            gap: 10px;
        }
        input, button {
            padding: 10px 15px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-size: 16px;
        }
        input {
            flex-grow: 1;
            min-width: 200px;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
            white-space: nowrap;
        }
        button:hover {
            background-color: #2980b9;
        }
        button.success {
            background-color: #2ecc71;
        }
        button.success:hover {
            background-color: #27ae60;
        }
        button.danger {
            background-color: #e74c3c;
        }
        button.danger:hover {
            background-color: #c0392b;
        }
        button.warning {
            background-color: #e74c3c;
            font-weight: bold;
        }
        button.warning:hover {
            background-color: #c0392b;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }
        th, td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            white-space: nowrap;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 2;
        }
        tr:hover {
            background-color: #f5f5f5;
        }
        .status {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            display: inline-block;
            min-width: 120px;
            text-align: center;
        }
        .status-pending {
            background-color: #f39c12;
            color: white;
        }
        .status-completed {
            background-color: #2ecc71;
            color: white;
        }
        .editable {
            background-color: #fffde7;
            cursor: pointer;
        }
        .editable:hover {
            background-color: #fff9c4;
        }
        .loading {
            text-align: center;
            padding: 40px;
            font-style: italic;
            color: #7f8c8d;
        }
        .error {
            color: #e74c3c;
            text-align: center;
            padding: 20px;
        }
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 4px;
            color: white;
            background-color: #2ecc71;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
        }
        .notification.error {
            background-color: #e74c3c;
        }
        .fixed-column {
            position: sticky;
            left: 0;
            background-color: white;
            z-index: 1;
        }
        tr:hover .fixed-column {
            background-color: #f5f5f5;
        }
        th.fixed-column {
            background-color: #f2f2f2;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #f1f1f1;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
        }
        .tab.active {
            background-color: #3498db;
            color: white;
        }
        .multi-paste-area {
            margin-top: 10px;
            display: none;
        }
        .multi-paste-area textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-family: monospace;
        }
        .multi-paste-buttons {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }
        .hidden-row {
            display: none;
        }

        /* === CSS MỚI CHO DROPDOWN === */
        td.editable-select {
            padding: 5px;
            position: relative;
        }
        .editable-select select {
            color: white;
            font-weight: bold;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            width: 100%;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            text-align: center;
            text-align-last: center;
        }
        .editable-select select:focus {
            outline: none;
            box-shadow: 0 0 0 2px #3498db;
        }
        .editable-select::after {
            content: "▼";
            font-size: 10px;
            color: white;
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
        }
        /* === KẾT THÚC CSS MỚI === */

        @media (max-width: 768px) {
            .control-panel {
                flex-direction: column;
            }
            .search-box {
                width: 100%;
            }
            th, td {
                padding: 6px 8px;
                font-size: 12px;
            }
            .tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
            }
            .tab {
                padding: 8px 12px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>QUẢN LÝ MÃ TRACKING</h1>
        
        <div class="tabs" id="tabsContainer">
            <!-- Tabs sẽ được tạo động bằng JavaScript -->
        </div>
        
        <div class="control-panel">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Tìm kiếm theo mã đơn hàng hoặc tracking...">
                <button id="searchBtn">Tìm kiếm</button>
            </div>
            <div class="action-buttons">
                <button id="refreshBtn" class="success">Làm mới dữ liệu</button>
                <button id="saveAllBtn" class="warning" style="display: none;">LƯU TẤT CẢ THAY ĐỔI</button>
                <button id="multiPasteBtn">Paste nhiều dòng</button>
            </div>
        </div>
        
        <div class="multi-paste-area" id="multiPasteArea">
            <p>Nhập danh sách mã Tracking (mỗi mã một dòng, theo thứ tự từ trên xuống):</p>
            <textarea id="multiPasteTextarea" placeholder="Dán nhiều mã tracking ở đây, mỗi mã một dòng..."></textarea>
            <div class="multi-paste-buttons">
                <button id="applyMultiPasteBtn" class="success">Áp dụng</button>
                <button id="cancelMultiPasteBtn" class="danger">Hủy</button>
            </div>
        </div>
        
        <div id="tableContainer">
            <div class="loading">Đang tải dữ liệu...</div>
        </div>
    </div>
    
    <div id="notification" class="notification"></div>

    <script>
        // Biến toàn cục
        let allData = [];
        let filteredData = [];
        let changedData = {};
        let currentTab = 'all';
        const DATA_URL = 'https://script.google.com/macros/s/AKfycbyDGqwYSX0Sxxlom-q29UhB2CJVGpTttVctWYNOfqMDCv4MkGmmMShtROnrgZYOgn9Opw/exec';
        const UPDATE_URL = 'https://script.google.com/macros/s/AKfycbyqc4EFLBFcBoQzZscRWs7yPcIN7dHZyxI2hYn0MKcQoLsGQQasIulV4dkxNSK3J0TOIQ/exec';
        
        // DOM elements
        const tableContainer = document.getElementById('tableContainer');
        const tabsContainer = document.getElementById('tabsContainer');
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const saveAllBtn = document.getElementById('saveAllBtn');
        const notification = document.getElementById('notification');
        const multiPasteBtn = document.getElementById('multiPasteBtn');
        const multiPasteArea = document.getElementById('multiPasteArea');
        const multiPasteTextarea = document.getElementById('multiPasteTextarea');
        const applyMultiPasteBtn = document.getElementById('applyMultiPasteBtn');
        const cancelMultiPasteBtn = document.getElementById('cancelMultiPasteBtn');
        
        // Danh sách cột cố định sẽ hiển thị - ĐÃ CẬP NHẬT THỨ TỰ
        const DISPLAY_COLUMNS = [
            'Mã đơn hàng',
            'Kết quả Check', // ĐÃ DI CHUYỂN LÊN ĐÂY
            'Mã Tracking',
            'Ngày lên đơn',
            'Name*',
            'Phone*',
            'Add',
            'City',
            'State',
            'Zipcode',
            'Mặt hàng',
            'Tên mặt hàng 1',
            'Số lượng mặt hàng 1',
            'Tên mặt hàng 2',
            'Số lượng mặt hàng 2',
            'Quà tặng',
            'Số lượng quà kèm',
            'Giá bán',
            'Loại tiền thanh toán',
            'Tổng tiền VNĐ',
            'Hình thức thanh toán',
            'Ghi chú',
            'Nhân viên Sale',
            'Nhân viên Marketing',
            'NV Vận đơn',
            //'Kết quả Check', // ĐÃ BỎ Ở ĐÂY
            'Trạng thái giao hàng NB',
            'Lý do',
            'Đơn vị vận chuyển',
            'Trạng thái thu tiền',
            'Ngày hẹn đẩy đơn',
            'Số tiền thực thu',
            'Ngày Up bill',
            'Ảnh bill',
            'Ngày chuyển khoản',
            'Loại thanh toán',
            'Tên người chuyển khoản',
            'Tài khoản nhận',
            'Số tiền đã nhận',
            'Tỷ giá cước',
            'Đơn vị tiền đối soát',
            'Ngày đối soát cước',
            'Tiền ship',
            'Tỷ giá',
            'Đơn vị tiền tệ tính cước',
            'Thời gian lên đơn',
            'Ghi chú của FFM',
            'FFM thanh toán',
            'Ngày đối soát bill',
            'Ngày Kế toán đối soát với FFM lần 1',
            'Số tiền về TK Cty từ FFM lần 1',
            'Ngày Kế toán đối soát với FFM lần 2',
            'Tiền Việt đã đối soát',
            'Ngày Kế toán đối soát với FFM lần 3',
            'Ca',
            'Tổng số tiền từ FFM',
            'Số tiền về TK Cty ngoài FFM',
            'Số tiền của đơn hàng đã về TK Cty',
            'Kế toán xác nhận thu tiền về',
            'Thông tin đơn',
            'Thông tin khách hàng',
            'Thông tin nhân sự',
            'Phản hồi tích cực',
            'Phản hồi tiêu cực',
            'count',
            'Phân loại KH',
            'Xác nhận đơn',
            'Diễn giải',
            'Tên page',
            'Giá gốc',
            'Màu backlist',
            'Trạng thái đơn',
            'Tiền chiết khấu',
            'Phí ship',
            'Tiền sau ship',
            'Tên lên đơn',
            'Tạo bản in',
            'in',
            'Cảnh báo Blacklist, Trùng đơn',
            'Khu vực',
            'Phí lưu kho',
            'Team',
            'Mã check',
            'Ghi chú của BEE',
            'Đánh dấu',
            'Ngày đóng hàng',
            'Trạng thái giao hàng',
            'Thời gian giao dự kiến',
            'Phí ship nội địa Mỹ (usd)',
            'Phí xử lý đơn đóng hàng-Lưu kho(usd)',
            'GHI CHÚ',
            'Ngày đối soát',
            'Time kế toán xác nhận',
            'Ghi chú của VĐ',
            'Đơn vị thanh toán',
            'Tài khoản thanh toán',
            'Update',
            'Trạng thái dvvc',
            'Nhập kho',
            'Tổng phí vc',
            'Tiền cước',
            'Số tiền đối soát',
            'maDonHang'
        ];
        
        // Các cột có thể chỉnh sửa - ĐÃ CẬP NHẬT
        const EDITABLE_COLUMNS = ['Mã Tracking', 'Name*', 'Kết quả Check'];
        
        // MỚI: Định nghĩa màu sắc cho các giá trị trong "Kết quả Check"
        const CHECK_RESULT_COLORS = {
            'OK': '#2ecc71',         // Xanh lá
            'Không OK': '#e74c3c',    // Đỏ
            'Chưa check': '#f39c12', // Cam
            '': '#bdc3c7'            // Xám cho giá trị rỗng
        };
        const CHECK_RESULT_OPTIONS = ['Chưa check', 'OK', 'Không OK'];

        // Hàm hiển thị thông báo
        function showNotification(message, isError = false) {
            notification.textContent = message;
            notification.className = isError ? 'notification error' : 'notification';
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        // Hàm tải dữ liệu
        async function loadData() {
            try {
                tableContainer.innerHTML = '<div class="loading">Đang tải dữ liệu...</div>';
                saveAllBtn.style.display = 'none';
                changedData = {};
                
                const response = await fetch(DATA_URL);
                if (!response.ok) {
                    throw new Error('Không thể tải dữ liệu từ server');
                }
                
                const result = await response.json();
                
                if (!result || typeof result !== 'object') {
                    throw new Error('Dữ liệu không hợp lệ từ server');
                }
                
                if (Array.isArray(result)) {
                    allData = result;
                } else if (result.data && Array.isArray(result.data)) {
                    allData = result.data;
                } else if (result.records && Array.isArray(result.records)) {
                    allData = result.records;
                } else {
                    allData = Object.keys(result).map(key => ({ ...result[key], id: key }));
                }
                
                allData = allData.filter(item => item['Đơn vị vận chuyển'] === 'BEE');
                
                createTabs();
                filterDataByTab(currentTab);
            } catch (error) {
                tableContainer.innerHTML = `<div class="error">Lỗi khi tải dữ liệu: ${error.message}</div>`;
                console.error('Lỗi:', error);
            }
        }
        
        // Hàm tạo các tab theo Khu vực
        function createTabs() {
            tabsContainer.innerHTML = '';
            
            const regions = [...new Set(allData.map(item => item['Khu vực'] || 'Khác'))];
            
            const allTab = document.createElement('div');
            allTab.className = 'tab active';
            allTab.textContent = 'Tất cả';
            allTab.onclick = () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                allTab.classList.add('active');
                currentTab = 'all';
                filterDataByTab('all');
            };
            tabsContainer.appendChild(allTab);
            
            regions.forEach(region => {
                const tab = document.createElement('div');
                tab.className = 'tab';
                tab.textContent = region;
                tab.onclick = () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentTab = region;
                    filterDataByTab(region);
                };
                tabsContainer.appendChild(tab);
            });
        }
        
        // Hàm lọc dữ liệu theo tab
        function filterDataByTab(tab) {
            if (tab === 'all') {
                filteredData = [...allData];
            } else {
                filteredData = allData.filter(item => (item['Khu vực'] || 'Khác') === tab);
            }
            
            const keyword = searchInput.value.toLowerCase().trim();
            if (keyword) {
                filteredData = filteredData.filter(item => 
                    Object.values(item).some(val => 
                        String(val).toLowerCase().includes(keyword)
                    )
                );
            }
            
            renderTable(filteredData);
        }
        
        // Hàm hiển thị bảng - ĐÃ CẬP NHẬT
        function renderTable(data) {
            if (!Array.isArray(data)) {
                tableContainer.innerHTML = '<div class="error">Dữ liệu không hợp lệ: không phải mảng</div>';
                return;
            }
            
            if (data.length === 0) {
                tableContainer.innerHTML = '<div class="error">Không tìm thấy dữ liệu phù hợp</div>';
                return;
            }
            
            let html = `
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th class="fixed-column">STT</th>`;
            
            DISPLAY_COLUMNS.forEach(column => {
                html += `<th>${column}</th>`;
            });
            
            html += `<th class="fixed-column">Thao Tác</th></tr>
                        </thead>
                        <tbody>`;
            
            data.forEach((item, index) => {
                const hasTracking = item['Mã Tracking'] && item['Mã Tracking'].trim() !== '';
                const isChanged = changedData[item['maDonHang']] !== undefined;
                const rowClass = hasTracking ? 'hidden-row' : '';
                
                html += `<tr data-id="${item['maDonHang'] || index}" data-index="${index}" class="${rowClass}">
                            <td class="fixed-column">${index + 1}</td>`;
                
                DISPLAY_COLUMNS.forEach(column => {
                    const originalValue = item[column] || '';
                    let displayValue = originalValue;
                    if (isChanged && changedData[item['maDonHang']][column] !== undefined) {
                        displayValue = changedData[item['maDonHang']][column];
                    }

                    if (column === 'Kết quả Check') {
                        const color = CHECK_RESULT_COLORS[displayValue] || CHECK_RESULT_COLORS[''];
                        let optionsHtml = '';
                        CHECK_RESULT_OPTIONS.forEach(opt => {
                            optionsHtml += `<option value="${opt}" ${displayValue === opt ? 'selected' : ''}>${opt}</option>`;
                        });

                        html += `<td class="editable-select" data-field="${column}">
                                    <select style="background-color: ${color};">
                                        ${optionsHtml}
                                    </select>
                                 </td>`;
                    } else if (EDITABLE_COLUMNS.includes(column)) {
                        html += `<td class="editable" contenteditable="true" data-field="${column}">${displayValue}</td>`;
                    } else {
                        html += `<td>${originalValue}</td>`;
                    }
                });
                
                html += `<td class="fixed-column">
                            <button class="save-btn" data-id="${item['maDonHang'] || index}" ${!isChanged ? 'disabled' : ''}>Lưu</button>
                         </td></tr>`;
            });
            
            html += `</tbody></table></div>`;
            tableContainer.innerHTML = html;
            
            // Thêm sự kiện cho các ô và dropdown có thể chỉnh sửa
            addCellEventListeners();
        }

        // Hàm thêm các trình xử lý sự kiện vào các ô - ĐÃ CẬP NHẬT
        function addCellEventListeners() {
            // Sự kiện cho các ô văn bản có thể chỉnh sửa
            document.querySelectorAll('td.editable[contenteditable="true"]').forEach(cell => {
                cell.addEventListener('input', function() {
                    const row = this.closest('tr');
                    const maDonHang = row.getAttribute('data-id');
                    const field = this.getAttribute('data-field');
                    const newValue = this.textContent.trim();
                    
                    if (!changedData[maDonHang]) {
                        changedData[maDonHang] = {};
                    }
                    changedData[maDonHang][field] = newValue;
                    
                    row.querySelector('.save-btn').disabled = false;
                    saveAllBtn.style.display = 'block';
                });
            });

            // Sự kiện cho dropdown "Kết quả Check"
            document.querySelectorAll('.editable-select select').forEach(select => {
                select.addEventListener('change', function() {
                    const newValue = this.value;
                    const row = this.closest('tr');
                    const maDonHang = row.getAttribute('data-id');
                    const field = this.closest('td').getAttribute('data-field');
                    
                    this.style.backgroundColor = CHECK_RESULT_COLORS[newValue] || CHECK_RESULT_COLORS[''];
                    
                    if (!changedData[maDonHang]) {
                        changedData[maDonHang] = {};
                    }
                    changedData[maDonHang][field] = newValue;
                    
                    row.querySelector('.save-btn').disabled = false;
                    saveAllBtn.style.display = 'block';
                });
            });
            
            document.querySelectorAll('.save-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const maDonHang = this.getAttribute('data-id');
                    await saveChanges(maDonHang);
                });
            });
        }
        
        // Hàm lưu thay đổi
        async function saveChanges(maDonHang) {
            if (!changedData[maDonHang]) return;
            
            try {
                const formData = new URLSearchParams();
                formData.append('maDonHang', maDonHang);
                
                for (const [field, value] of Object.entries(changedData[maDonHang])) {
                    formData.append(field, value);
                }
                
                const response = await fetch(UPDATE_URL, {
                    method: 'POST',
                    body: formData,
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
                });
                
                if (!response.ok) throw new Error('Lỗi kết nối khi lưu dữ liệu');
                
                const result = await response.json();
                
                if (result.status === 'ok') {
                    delete changedData[maDonHang];
                    
                    const saveBtn = document.querySelector(`.save-btn[data-id="${maDonHang}"]`);
                    if (saveBtn) saveBtn.disabled = true;
                    
                    if (Object.keys(changedData).length === 0) {
                        saveAllBtn.style.display = 'none';
                    }
                    
                    showNotification('Cập nhật dữ liệu thành công!');
                    
                    // Cập nhật dữ liệu gốc sau khi lưu thành công
                    const dataIndex = allData.findIndex(item => item.maDonHang === maDonHang);
                    if (dataIndex > -1) {
                        Object.assign(allData[dataIndex], result.updatedData); // Giả sử server trả về dữ liệu đã cập nhật
                    }

                    // Ẩn dòng nếu có mã tracking
                    const row = document.querySelector(`tr[data-id="${maDonHang}"]`);
                    const trackingCell = row.querySelector('[data-field="Mã Tracking"]');
                    if (row && trackingCell && trackingCell.textContent.trim() !== '') {
                        row.classList.add('hidden-row');
                    }

                } else {
                    throw new Error(result.message || 'Lỗi khi cập nhật dữ liệu');
                }
            } catch (error) {
                console.error('Lỗi khi lưu:', error);
                showNotification(`Lỗi: ${error.message}`, true);
            }
        }
        
        // Hàm lưu tất cả thay đổi
        async function saveAllChanges() {
             if (Object.keys(changedData).length === 0) return;

            const buttonText = 'LƯU TẤT CẢ THAY ĐỔI';
            saveAllBtn.disabled = true;
            saveAllBtn.textContent = 'ĐANG LƯU...';

            const updatesToProcess = { ...changedData };
            const promises = Object.keys(updatesToProcess).map(maDonHang => saveChangePromise(maDonHang, updatesToProcess[maDonHang]));

            try {
                const results = await Promise.all(promises);
                const successfulUpdates = results.filter(r => r.success).length;
                const failedUpdates = results.length - successfulUpdates;

                if (failedUpdates > 0) {
                    showNotification(`${successfulUpdates} lưu thành công, ${failedUpdates} thất bại.`, true);
                } else {
                    showNotification('Đã lưu tất cả thay đổi thành công!');
                }

                // Làm mới lại toàn bộ dữ liệu để đảm bảo đồng bộ
                await loadData();

            } catch (error) {
                console.error('Lỗi khi lưu tất cả:', error);
                showNotification(`Lỗi nghiêm trọng: ${error.message}`, true);
            } finally {
                saveAllBtn.disabled = false;
                saveAllBtn.textContent = buttonText;
                if (Object.keys(changedData).length === 0) {
                    saveAllBtn.style.display = 'none';
                }
            }
        }
        
        // Hàm trợ giúp cho saveAllChanges
        async function saveChangePromise(maDonHang, changes) {
            try {
                const formData = new URLSearchParams();
                formData.append('maDonHang', maDonHang);
                for (const [field, value] of Object.entries(changes)) {
                    formData.append(field, value);
                }

                const response = await fetch(UPDATE_URL, {
                    method: 'POST',
                    body: formData,
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
                });

                if (!response.ok) throw new Error(`Lỗi HTTP ${response.status}`);
                const result = await response.json();
                if (result.status !== 'ok') throw new Error(result.message || 'Server báo lỗi');

                // Xóa khỏi danh sách thay đổi nếu thành công
                delete changedData[maDonHang];
                return { success: true, maDonHang };
            } catch (error) {
                console.error(`Lỗi khi lưu mã đơn hàng ${maDonHang}:`, error);
                return { success: false, maDonHang, error: error.message };
            }
        }
        
        // Hàm tìm kiếm
        function searchData() {
            filterDataByTab(currentTab);
        }
        
        // Hàm xử lý paste nhiều dòng
        function handleMultiPaste() {
            multiPasteArea.style.display = 'block';
            multiPasteTextarea.value = '';
            multiPasteTextarea.focus();
        }
        
        // Hàm áp dụng paste nhiều dòng
        function applyMultiPaste() {
            const trackingList = multiPasteTextarea.value.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);
            
            if (trackingList.length === 0) {
                showNotification('Không có dữ liệu nào để áp dụng', true);
                return;
            }
            
            const rows = Array.from(document.querySelectorAll('tbody tr:not(.hidden-row)'));
            let appliedCount = 0;
            
            trackingList.forEach((value, index) => {
                if (index < rows.length) {
                    const row = rows[index];
                    const maDonHang = row.getAttribute('data-id');
                    const trackingCell = row.querySelector('[data-field="Mã Tracking"]');
                    
                    if (trackingCell) {
                        trackingCell.textContent = value;
                        if (!changedData[maDonHang]) changedData[maDonHang] = {};
                        changedData[maDonHang]['Mã Tracking'] = value;
                        
                        const saveBtn = row.querySelector('.save-btn');
                        if (saveBtn) saveBtn.disabled = false;
                        appliedCount++;
                    }
                }
            });
            
            if (Object.keys(changedData).length > 0) {
                saveAllBtn.style.display = 'block';
            }
            
            multiPasteArea.style.display = 'none';
            showNotification(`Đã áp dụng ${appliedCount} giá trị`);
        }
        
        // Sự kiện
        searchBtn.addEventListener('click', searchData);
        searchInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') searchData();
        });
        
        refreshBtn.addEventListener('click', loadData);
        saveAllBtn.addEventListener('click', saveAllChanges);
        multiPasteBtn.addEventListener('click', handleMultiPaste);
        applyMultiPasteBtn.addEventListener('click', applyMultiPaste);
        cancelMultiPasteBtn.addEventListener('click', () => {
            multiPasteArea.style.display = 'none';
        });
        
        // Tải dữ liệu ban đầu
        loadData();
    </script>
</body>
</html>


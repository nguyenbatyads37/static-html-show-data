<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gi·∫•y ƒë·ªÅ ngh·ªã c·∫•p GPVT - H·ªì s∆° xe</title>
    <style>
        /* ===== RESET & BASE STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Times New Roman", Times, serif;
            font-size: 12pt;
            line-height: 1.3;
            background-color: #f5f5f5;
            padding: 20px;
        }

        /* ===== TAB NAVIGATION ===== */
        .tabs-container {
            max-width: 210mm;
            margin: 0 auto 20px;
            background: #fff;
            border: 1px solid #ccc;
            display: flex;
        }

        .tab-link {
            flex: 1;
            padding: 12px 20px;
            background: #f0f0f0;
            border: none;
            border-right: 1px solid #ccc;
            cursor: pointer;
            font-size: 12pt;
            font-weight: bold;
            transition: background 0.3s;
        }

        .tab-link:last-child {
            border-right: none;
        }

        .tab-link:hover {
            background: #e0e0e0;
        }

        .tab-link.active {
            background: #fff;
            color: #000;
        }

        /* ===== CONTENT CONTAINER & A4 PAGE ===== */
        .content-container {
            max-width: 210mm;
            margin: 0 auto;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .page-container {
            width: 210mm;
            min-height: 297mm;
            background: white;
            margin: 0 auto;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 15mm 15mm 15mm 25mm;
            position: relative;
        }

        .print-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 25px;
            font-size: 12pt;
            font-weight: bold;
            cursor: pointer;
            border-radius: 4px;
            margin-bottom: 15px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        .print-button:hover {
            background: #218838;
        }

        /* ===== PAGE 1 STYLES - GI·∫§Y ƒê·ªÄ NGH·ªä ===== */
        .header-section {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 5px;
        }

        .header-left {
            width: 35%;
            font-size: 11pt;
            text-align: center;
        }

        .header-right {
            width: 60%;
            font-size: 11pt;
            text-align: center;
        }

        .header-left .company-name {
            font-weight: bold;
            font-size: 12pt;
            margin: 2px 0;
        }

        .header-right .vietnam {
            font-weight: bold;
            font-size: 12pt;
            white-space: nowrap;
            overflow: hidden;
        }

        .header-right .motto {
            font-weight: bold;
            font-size: 11pt;
            text-decoration: underline;
            text-underline-offset: 2px;
        }

        .document-title {
            text-align: center;
            font-weight: bold;
            font-size: 13pt;
            text-transform: uppercase;
            margin: 12px 0 10px;
            line-height: 1.3;
        }

        .recipient {
            text-align: center;
            font-size: 12pt;
            margin: 10px 0 12px;
        }

        /* Main Content */
        .main-content {
            font-size: 11.5pt;
            text-align: justify;
        }

        .main-content p {
            margin-bottom: 6px;
            text-indent: 30px;
            line-height: 1.35;
        }

        /* Table Styles */
        .table-wrapper {
            margin: 10px 0;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 9pt;
            table-layout: fixed;
        }

        th,
        td {
            border: 1px solid #000;
            padding: 3px;
            text-align: center;
            vertical-align: middle;
            word-wrap: break-word;
        }

        th {
            background-color: #f0f0f0;
            font-weight: bold;
            font-size: 9pt;
            line-height: 1.2;
        }

        #table-body td {
            line-height: 1.15em;
            max-height: 3.45em;
            overflow: hidden;
            text-align: left;
            padding: 3px;
            font-size: 9pt;
        }

        #table-body td:nth-child(1),
        #table-body td:nth-child(5) {
            text-align: center;
        }

        #table-body td:nth-child(2) {
            text-align: center;
        }

        /* Footer Section */
        .footer-section {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            font-size: 11.5pt;
        }

        .footer-left {
            width: 40%;
            line-height: 1.3;
        }

        .footer-right {
            width: 40%;
            text-align: center;
        }

        .footer-right .position {
            font-weight: bold;
            font-size: 12pt;
            text-transform: uppercase;
            margin-bottom: 3px;
        }

        .footer-right .sign-note {
            font-style: italic;
            font-size: 10.5pt;
            margin-bottom: 40px;
        }

        .signature-container {
            position: relative;
            height: 80px;
            margin-top: -30px;
        }

        .signature-container img {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            max-width: 140px;
            height: auto;
            opacity: 0.8;
        }

        .footer-right .name {
            font-weight: bold;
            font-size: 12pt;
        }

        #ho-so-info {
           display: none; /* ·∫®n khu v·ª±c n√†y */
        }

        /* ===== TAB 2: ƒêƒÇNG K√ù XE STYLES ===== */
        #dangky-container {
            max-width: 210mm;
            margin: 0 auto;
        }

        .dangky-page {
            width: 210mm;
            min-height: 297mm;
            background: white;
            margin: 0 auto 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 20mm 15mm;
            page-break-after: always;
        }
        .dangky-page:last-child {
             page-break-after: auto;
        }


        .dangky-bks {
            text-align: center;
            font-size: 16pt;
            font-weight: bold;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #000;
        }

        .dangky-image-wrapper {
            width: 100%;
            text-align: center;
            border: 1px solid #ddd;
            padding: 10px;
            background: #f9f9f9;
            min-height: 200px; /* TƒÉng chi·ªÅu cao t·ªëi thi·ªÉu */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .dangky-image-wrapper img {
            max-width: 100%;
            height: auto;
            object-fit: contain;
            display: block;
            margin: 0 auto;
        }
        
        .error-message {
            color: red;
            font-size: 12pt;
            font-weight: bold;
            text-align: center;
            padding: 20px;
        }

        /* ===== PRINT STYLES ===== */
        @media print {
            @page {
                size: A4;
                margin: 0;
            }

            body {
                background: white;
                margin: 0;
                padding: 0;
                font-size: 12pt;
                line-height: 1.3;
            }

            .tabs-container,
            .print-button {
                display: none !important;
            }

            .content-container {
                margin: 0;
                width: 100%;
            }

            .tab-content {
                display: none !important;
            }

            .tab-content.printing {
                display: block !important;
            }

            .page-container,
            .dangky-page {
                width: 210mm;
                min-height: 297mm;
                margin: 0;
                box-shadow: none;
                page-break-after: always;
            }
             .page-container {
                 padding: 15mm 15mm 15mm 25mm;
             }
             .dangky-page {
                padding: 20mm 15mm;
            }

            .dangky-page:last-child {
                page-break-after: auto;
            }

            .dangky-image-wrapper {
                overflow: visible !important;
                background: #fff;
                border: 1px solid #ccc;
            }

            .dangky-image-wrapper img {
                max-width: 100%;
            }

            table {
                font-size: 9pt;
                page-break-inside: avoid;
            }

            th,
            td {
                font-size: 9pt;
            }

            .header-section,
            .footer-section,
            .signature-container {
                page-break-inside: avoid;
            }
            
            #ho-so-info {
                display: none !important;
            }
        }
    </style>
</head>

<body>
    <div class="tabs-container">
        <button class="tab-link active" data-tab="tab1">Gi·∫•y ƒë·ªÅ ngh·ªã</button>
        <button class="tab-link" data-tab="tab2">ƒêƒÉng k√Ω xe</button>
    </div>

    <div class="content-container">
        <div id="tab1" class="tab-content active">
            <button class="print-button" onclick="printTab('tab1')">üñ®Ô∏è In Gi·∫•y ƒë·ªÅ ngh·ªã</button>
            <div class="page-container">
                <div class="header-section">
                    <div class="header-left">
                        <div class="company-name" id="company-name-header">T√äN C√îNG TY</div>
                        S·ªë: <span id="doc-number">...</span>
                    </div>
                    <div class="header-right">
                        <div class="vietnam">C·ªòNG H√íA X√É H·ªòI CH·ª¶ NGHƒ®A VI·ªÜT NAM</div>
                        <div class="motto">ƒê·ªôc l·∫≠p - T·ª± do - H·∫°nh ph√∫c</div>
                        <div class="date-place" id="date-place">L·∫°ng S∆°n, ng√†y ... th√°ng ... nƒÉm 2024</div>
                    </div>
                </div>
                <div class="document-title">
                    GI·∫§Y ƒê·ªÄ NGH·ªä C·∫§P GI·∫§Y PH√âP V·∫¨N T·∫¢I ƒê∆Ø·ªúNG B·ªò QU·ªêC T·∫æ GI·ªÆA VI·ªÜT NAM V√Ä TRUNG QU·ªêC
                </div>
                <div class="recipient">
                    <strong>K√≠nh g·ª≠i: S·ªü Giao th√¥ng v·∫≠n t·∫£i L·∫°ng S∆°n</strong>
                </div>
                <div class="main-content">
                    <p>1. T√™n ƒë∆°n v·ªã v·∫≠n t·∫£i: <strong id="company-name-content">...</strong></p>
                    <p>2. ƒê·ªãa ch·ªâ: <span id="address">...</span></p>
                    <p>3. ƒêi·ªán tho·∫°i: <span id="phone">...</span></p>
                    <p>4. Gi·∫•y ph√©p kinh doanh v·∫≠n t·∫£i b·∫±ng xe √¥ t√¥ s·ªë <span id="dkkd">...</span>, ng√†y c·∫•p: <span id="dkkd-date">...</span>; n∆°i c·∫•p: S·ªü
                        Giao th√¥ng v·∫≠n t·∫£i L·∫°ng S∆°n.</p>
                    <p>5. ƒê·ªÅ ngh·ªã c·∫•p Gi·∫•y ph√©p v·∫≠n t·∫£i lo·∫°i <span id="request-type"
                            style="color: red; font-weight: bold;">...</span> cho c√°c ph∆∞∆°ng ti·ªán sau:</p>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 4%">TT</th>
                                <th style="width: 10%">Bi·ªÉn s·ªë xe</th>
                                <th style="width: 10%">Nh√£n hi·ªáu</th>
                                <th style="width: 7%">NƒÉm SX</th>
                                <th style="width: 8%">Tr·ªçng t·∫£i</th>
                                <th style="width: 15%">Th·ªùi gian<br>ƒë·ªÅ ngh·ªã</th>
                                <th style="width: 10%">H√¨nh th·ª©c<br>Hƒê</th>
                                <th style="width: 16%">Tuy·∫øn Hƒê</th>
                                <th style="width: auto; min-width: 150px;">ƒêi·ªÉm<br>d·ª´ng ngh·ªâ</th>
                            </tr>
                        </thead>
                        <tbody id="table-body">
                        </tbody>
                    </table>
                </div>
                <div class="main-content">
                    <p>6. Ng∆∞·ªùi li√™n h·ªá: <span id="contact-person">...</span>, ƒêi·ªán tho·∫°i: <span
                            id="contact-phone">...</span></p>
                </div>
                <div class="footer-section">
                    <div class="footer-left">
                        <strong>N∆°i nh·∫≠n:</strong><br>
                        - Nh∆∞ tr√™n;<br>
                        - L∆∞u: VT.
                    </div>
                    <div class="footer-right">
                        <div class="position">GI√ÅM ƒê·ªêC</div>
                        <div class="sign-note">(K√Ω t√™n, ƒë√≥ng d·∫•u)</div>
                        <div class="signature-container">
                        </div>
                        <div class="name" id="director-name">L·ª•c Di·ªáu Na</div>
                    </div>
                </div>
                <div id="ho-so-info">
                    M√£ HS: <span id="ho-so-content">...</span>
                    <div id="cap-lan-1-row">
                        C·∫•p l·∫ßn 1 ng√†y: <span id="ngay-cap-landau-content">...</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab2" class="tab-content">
            <button class="print-button" onclick="printTab('tab2')">üñ®Ô∏è In ƒêƒÉng k√Ω xe</button>
            <div id="dangky-container">
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const urlParams = new URLSearchParams(window.location.search);

            const getParam = (key, defaultValue = '') => {
                const rawValue = urlParams.get(key);
                // Ch·ªâ decode n·∫øu c√≥ gi√° tr·ªã, tr√°nh l·ªói v·ªõi gi√° tr·ªã null
                return rawValue ? decodeURIComponent(rawValue) : defaultValue;
            };

            // --- ƒêI·ªÄN D·ªÆ LI·ªÜU CHUNG ---
            const companyName = getParam('tencongty', 'T√äN C√îNG TY');
            document.getElementById('company-name-header').textContent = companyName.toUpperCase();
            document.getElementById('company-name-content').textContent = companyName;

            const fields = {
                'so': 'doc-number', 'diachi': 'address', 'sdt': 'phone',
                'dkkd': 'dkkd', 'ngaycapdkkd': 'dkkd-date',
                'nguoilienhe': 'contact-person', 'sdtlh': 'contact-phone',
                'loaidenghi': 'request-type', 'giamdoc': 'director-name',
                'mahoso': 'ho-so-content', 'ngaycaplandau': 'ngay-cap-landau-content'
            };
            
            Object.entries(fields).forEach(([param, id]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = getParam(param, '...');
                }
            });

            // --- X·ª¨ L√ù CH·ªÆ K√ù ---
            const directorNameElement = document.getElementById('director-name');
            if (getParam('loaichuky').toLowerCase() !== 'ch·ªØ k√Ω') {
                 if(directorNameElement) directorNameElement.style.visibility = 'hidden';
            }

            // --- X·ª¨ L√ù NG√ÄY TH√ÅNG ---
            const datePlaceElement = document.getElementById('date-place');
            if (urlParams.has('ngaythang')) {
                datePlaceElement.textContent = getParam('ngaythang');
            } else {
                const today = new Date();
                datePlaceElement.textContent = `L·∫°ng S∆°n, ng√†y ${today.getDate()} th√°ng ${today.getMonth() + 1} nƒÉm ${today.getFullYear()}`;
            }

            // --- ƒêI·ªÄN B·∫¢NG D·ªÆ LI·ªÜU XE ---
            const dataString = getParam('data');
            let bksList = [];
            if (dataString) {
                const tableBody = document.getElementById('table-body');
                const rows = dataString.split('_b_');
                rows.forEach((rowData, index) => {
                    if (!rowData.trim()) return;
                    const cells = rowData.split('_a_').map(cell => cell.trim());
                    // L·∫•y BKS t·ª´ c·ªôt ƒë·∫ßu ti√™n c·ªßa d·ªØ li·ªáu v√† l∆∞u l·∫°i
                    if (cells[0]) {
                        bksList.push(cells[0]);
                    }
                    const row = tableBody.insertRow();
                    row.insertCell().textContent = index + 1;
                    cells.forEach(cellData => {
                        row.insertCell().textContent = cellData;
                    });
                });
            }

            // --- HI·ªÇN TH·ªä CON D·∫§U & CH·ªÆ K√ù ---
            const signatureContainer = document.querySelector('.signature-container');
            const sealUrl = getParam('condau');
            const signatureUrl = getParam('chuki');

            const createImage = (src, alt, className) => {
                const img = document.createElement('img');
                img.src = src;
                img.alt = alt;
                img.className = className;
                img.onerror = () => {
                    console.error(`Kh√¥ng th·ªÉ t·∫£i ·∫£nh: ${alt}`, src);
                    img.style.display = 'none';
                };
                return img;
            };

            if (sealUrl) signatureContainer.appendChild(createImage(sealUrl, 'Con d·∫•u', 'seal'));
            if (signatureUrl) signatureContainer.appendChild(createImage(signatureUrl, 'Ch·ªØ k√Ω', 'signature'));

            // --- TAB 2: T·∫†O C√ÅC TRANG ƒêƒÇNG K√ù XE ---
            const dangkyContainer = document.getElementById('dangky-container');
            const linkAnhData = getParam('linkanh');

            if (linkAnhData.trim()) {
                const imageSets = linkAnhData.split('_b_');
                imageSets.forEach((imageSet, index) => {
                    if (!imageSet.trim()) return;
                    
                    // T√¨m URL h·ª£p l·ªá ƒë·∫ßu ti√™n trong set ·∫£nh n√†y
                    const imageUrl = imageSet.split('_a_')
                                           .map(p => p.trim())
                                           .find(p => p.toLowerCase().startsWith('http'));

                    // L·∫•y BKS t∆∞∆°ng ·ª©ng t·ª´ danh s√°ch ƒë√£ t·∫°o
                    const bks = bksList[index] || 'Kh√¥ng r√µ BKS';
                    
                    if (imageUrl) {
                        createDangKyPage(dangkyContainer, bks, imageUrl);
                    }
                });
            } else {
                dangkyContainer.innerHTML = '<div class="error-message">Kh√¥ng c√≥ d·ªØ li·ªáu ·∫£nh ƒëƒÉng k√Ω xe.</div>';
            }
        });

        function createDangKyPage(container, bks, imageUrl) {
            const pageDiv = document.createElement('div');
            pageDiv.className = 'dangky-page';

            const bksDiv = document.createElement('div');
            bksDiv.className = 'dangky-bks';
            bksDiv.textContent = `·∫¢nh gi·∫•y ƒëƒÉng k√Ω xe: ${bks}`;
            pageDiv.appendChild(bksDiv);

            const wrapper = document.createElement('div');
            wrapper.className = 'dangky-image-wrapper';

            const img = document.createElement('img');
            img.src = imageUrl;
            img.alt = `·∫¢nh ƒëƒÉng k√Ω xe ${bks}`;
            img.loading = 'lazy';
            img.onerror = function () {
                this.style.display = 'none';
                wrapper.innerHTML = `<div class="error-message">L·ªói t·∫£i ·∫£nh. <br>URL c√≥ th·ªÉ kh√¥ng c√¥ng khai ho·∫∑c ƒë√£ h·∫øt h·∫°n.</div>`;
            };
            
            wrapper.appendChild(img);
            pageDiv.appendChild(wrapper);
            container.appendChild(pageDiv);
        }

        function printTab(tabId) {
            const activeTab = document.querySelector('.tab-content.active');
            const targetTab = document.getElementById(tabId);
            
            if(activeTab) activeTab.classList.remove('active');
            if(targetTab) targetTab.classList.add('active', 'printing');

            window.print();
            
            // Kh√¥i ph·ª•c l·∫°i tr·∫°ng th√°i tab sau khi in
             if(targetTab) targetTab.classList.remove('printing');
             if (activeTab && activeTab !== targetTab) {
                activeTab.classList.add('active');
             } else if (!activeTab) {
                document.getElementById('tab1').classList.add('active'); // M·∫∑c ƒë·ªãnh v·ªÅ tab 1 n·∫øu kh√¥ng c√≥ tab n√†o active
             }
        }

        document.querySelectorAll('.tab-link').forEach(link => {
            link.addEventListener('click', function () {
                const targetTabId = this.getAttribute('data-tab');
                document.querySelectorAll('.tab-link.active, .tab-content.active').forEach(el => el.classList.remove('active'));
                this.classList.add('active');
                document.getElementById(targetTabId).classList.add('active');
            });
        });

    </script>
</body>

</html>

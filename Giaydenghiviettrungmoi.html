<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gi·∫•y ƒë·ªÅ ngh·ªã c·∫•p ph√©p v·∫≠n t·∫£i</title>
    <style>
        /* CSS C∆† B·∫¢N CHO TRANG */
        body {
            font-family: 'Times New Roman', Times, serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }

        .page-container {
            background: white;
            width: 210mm;
            min-height: 297mm;
            margin: auto;
            padding: 15mm;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
            position: relative;
        }

        .header-section {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
        }

        .header-left,
        .header-right {
            width: 50%;
            text-align: center;
        }

        .company-name,
        .vietnam {
            font-weight: bold;
        }

        .motto {
            border-bottom: 1px solid black;
            display: inline-block;
            padding-bottom: 2px;
            margin-bottom: 5px;
        }

        .document-title {
            text-align: center;
            font-weight: bold;
            font-size: 16px;
            margin: 20px 0;
        }

        .recipient {
            text-align: center;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .main-content p {
            margin: 8px 0;
            line-height: 1.5;
            text-align: justify;
            font-size: 14px;
        }

        .table-wrapper {
            margin-top: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th,
        td {
            border: 1px solid black;
            padding: 5px;
            text-align: center;
            vertical-align: middle;
        }

        thead th {
            font-weight: bold;
        }

        .footer-section {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            font-size: 14px;
        }

        .footer-right {
            text-align: center;
        }

        .position {
            font-weight: bold;
        }

        .sign-note {
            font-style: italic;
            font-size: 12px;
        }
        
        .signature-container {
            height: 100px; /* D√†nh kh√¥ng gian cho ch·ªØ k√Ω v√† con d·∫•u */
            position: relative;
        }

        .signature-container img {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            max-width: 150px;
            max-height: 90px;
        }
        .signature-container img.seal {
             opacity: 0.8; /* L√†m con d·∫•u m·ªù h∆°n m·ªôt ch√∫t */
        }

        .name {
            margin-top: 5px;
            font-weight: bold;
        }

        #ho-so-info {
            position: absolute;
            bottom: 15mm;
            left: 15mm;
            font-size: 12px;
            font-style: italic;
        }

        /* --- CSS CHO TABS --- */
        .tab-navigation {
            text-align: center;
            margin-bottom: 20px;
        }
        .tab-link, .external-link {
            padding: 10px 15px;
            cursor: pointer;
            background-color: #ddd;
            border: 1px solid #ccc;
            display: inline-block;
            margin: 0 5px;
            border-radius: 5px 5px 0 0;
            font-weight: bold;
            font-family: Arial, Helvetica, sans-serif;
        }
        .tab-link.active, .external-link:hover {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }

        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .print-button {
             display: block; margin-bottom: 15px; padding: 10px; cursor: pointer;
        }

        /* --- CSS CHO TAB 2: ƒêƒÇNG K√ù XE --- */
        .dangky-page {
            background: white;
            width: 210mm;
            height: 297mm;
            margin: auto;
            margin-bottom: 20px;
            padding: 15mm;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            page-break-after: always; /* T·ª± ƒë·ªông ng·∫Øt trang khi in */
        }
        .dangky-bks {
            font-weight: bold;
            font-size: 16px;
            text-align: center;
            margin-bottom: 10px;
        }
        .dangky-image-wrapper {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px dashed #ccc;
            overflow: hidden;
        }
        .dangky-image-wrapper img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .error-message { color: red; text-align: center; margin-top: 20px; }

        /* CSS CHO TAB 3: H·ª¢P ƒê·ªíNG */
        #hopdong-container {
            width: 100%;
            min-height: 600px;
            height: calc(100vh - 200px);
            border: 1px solid #ccc;
            border-radius: 5px;
            overflow: hidden;
            background: #f9f9f9;
        }
        #hopdong-iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
        }
        #hopdong-container .error-message {
            padding: 40px;
            text-align: center;
            font-size: 16px;
        }


        /* CSS CHO IN ·∫§N */
        @media print {
            body { background-color: white; margin: 0; padding: 0; }
            .tab-navigation, .print-button { display: none !important; }
            .tab-content { display: none !important; }
            .tab-content.printing { display: block !important; }
            .page-container, .dangky-page {
                box-shadow: none;
                margin: 0;
                width: 100%;
                height: 100%;
                page-break-after: always;
            }
            #hopdong-iframe {
                height: 100vh !important;
            }
        }
    </style>
</head>

<body>
    <!-- KHU V·ª∞C ƒêI·ªÄU H∆Ø·ªöNG TAB -->
    <div class="tab-navigation">
        <button class="tab-link active" data-tab="tab1">üìÑ Gi·∫•y ƒë·ªÅ ngh·ªã</button>
        <button class="tab-link" data-tab="tab2">üöó ƒêƒÉng k√Ω xe</button>
        <button class="tab-link" data-tab="tab3">üìú H·ª£p ƒë·ªìng</button>
    </div>

    <div class="content-container">
        <!-- TAB 1: GI·∫§Y ƒê·ªÄ NGH·ªä -->
        <div id="tab1" class="tab-content active">
            <button class="print-button" onclick="printTab('tab1')">üñ®Ô∏è In Gi·∫•y ƒë·ªÅ ngh·ªã</button>
            <div class="page-container">
                <div class="header-section">
                    <div class="header-left">
                        <div class="company-name" id="company-name-header">T√äN C√îNG TY</div>
                        S·ªë: <span id="doc-number">...</span>
                    </div>
                    <div class="header-right">
                        <div class="vietnam">C·ªòNG H√íA X√É H·ªòI CH·ª¶ NGHƒ®A VI·ªÜT NAM</div>
                        <div class="motto">ƒê·ªôc l·∫≠p - T·ª± do - H·∫°nh ph√∫c</div>
                        <div class="date-place" id="date-place">L·∫°ng S∆°n, ng√†y ... th√°ng ... nƒÉm 2024</div>
                    </div>
                </div>
                <div class="document-title">
                    GI·∫§Y ƒê·ªÄ NGH·ªä C·∫§P GI·∫§Y PH√âP V·∫¨N T·∫¢I ƒê∆Ø·ªúNG B·ªò QU·ªêC T·∫æ GI·ªÆA VI·ªÜT NAM V√Ä TRUNG QU·ªêC
                </div>
                <div class="recipient">
                    <strong>K√≠nh g·ª≠i: S·ªü Giao th√¥ng v·∫≠n t·∫£i L·∫°ng S∆°n</strong>
                </div>
                <div class="main-content">
                    <p>1. T√™n ƒë∆°n v·ªã v·∫≠n t·∫£i: <strong id="company-name-content">...</strong></p>
                    <p>2. ƒê·ªãa ch·ªâ: <span id="address">...</span></p>
                    <p>3. ƒêi·ªán tho·∫°i: <span id="phone">...</span></p>
                    <p>4. Gi·∫•y ph√©p kinh doanh v·∫≠n t·∫£i b·∫±ng xe √¥ t√¥ s·ªë <span id="dkkd">...</span>, ng√†y c·∫•p: <span id="dkkd-date">...</span>; n∆°i c·∫•p: S·ªü Giao th√¥ng v·∫≠n t·∫£i L·∫°ng S∆°n.</p>
                    <p>5. ƒê·ªÅ ngh·ªã c·∫•p Gi·∫•y ph√©p v·∫≠n t·∫£i lo·∫°i <span id="request-type" style="color: red; font-weight: bold;">...</span> cho c√°c ph∆∞∆°ng ti·ªán sau:</p>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 4%">TT</th>
                                <th style="width: 10%">Bi·ªÉn s·ªë xe</th>
                                <th style="width: 10%">Nh√£n hi·ªáu</th>
                                <th style="width: 7%">NƒÉm SX</th>
                                <th style="width: 8%">Tr·ªçng t·∫£i</th>
                                <th style="width: 15%">Th·ªùi gian<br>ƒë·ªÅ ngh·ªã</th>
                                <th style="width: 10%">H√¨nh th·ª©c<br>Hƒê</th>
                                <th style="width: 16%">Tuy·∫øn Hƒê</th>
                                <th style="width: auto; min-width: 150px;">ƒêi·ªÉm<br>d·ª´ng ngh·ªâ</th>
                            </tr>
                        </thead>
                        <tbody id="table-body">
                        </tbody>
                    </table>
                </div>
                <div class="main-content">
                    <p>6. Ng∆∞·ªùi li√™n h·ªá: <span id="contact-person">...</span>, ƒêi·ªán tho·∫°i: <span id="contact-phone">...</span></p>
                </div>
                <div class="footer-section">
                    <div class="footer-left">
                        <strong>N∆°i nh·∫≠n:</strong><br>
                        - Nh∆∞ tr√™n;<br>
                        - L∆∞u: VT.
                    </div>
                    <div class="footer-right">
                        <div class="position">GI√ÅM ƒê·ªêC</div>
                        <div class="sign-note">(K√Ω t√™n, ƒë√≥ng d·∫•u)</div>
                        <div class="signature-container">
                        </div>
                        <div class="name" id="director-name">...</div>
                    </div>
                </div>
                <div id="ho-so-info">
                    M√£ HS: <span id="ho-so-content">...</span>
                    <div id="cap-lan-1-row">
                        C·∫•p l·∫ßn 1 ng√†y: <span id="ngay-cap-landau-content">...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 2: ƒêƒÇNG K√ù XE -->
        <div id="tab2" class="tab-content">
            <button class="print-button" onclick="printTab('tab2')">üñ®Ô∏è In ƒêƒÉng k√Ω xe</button>
            <div id="dangky-container">
            </div>
        </div>

        <!-- TAB 3: H·ª¢P ƒê·ªíNG -->
        <div id="tab3" class="tab-content">
            <button class="print-button" onclick="printTab('tab3')">üñ®Ô∏è In H·ª£p ƒë·ªìng</button>
            <div id="hopdong-container">
                <iframe id="hopdong-iframe"></iframe>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const urlParams = new URLSearchParams(window.location.search);

            const getParam = (key, defaultValue = '') => {
                const rawValue = urlParams.get(key);
                return rawValue ? decodeURIComponent(rawValue) : defaultValue;
            };

            // --- ƒêI·ªÄN D·ªÆ LI·ªÜU CHUNG ---
            const companyName = getParam('tencongty', 'T√äN C√îNG TY');
            document.getElementById('company-name-header').textContent = companyName.toUpperCase();
            document.getElementById('company-name-content').textContent = companyName;

            const fields = {
                'so': 'doc-number', 'diachi': 'address', 'sdt': 'phone',
                'dkkd': 'dkkd', 'ngaycapdkkd': 'dkkd-date',
                'nguoilienhe': 'contact-person', 'sdtlh': 'contact-phone',
                'loaidenghi': 'request-type', 'giamdoc': 'director-name',
                'mahoso': 'ho-so-content',
                'ngaycaplandau': 'ngay-cap-landau-content'
            };

            Object.entries(fields).forEach(([param, id]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = getParam(param, '...');
                }
            });

            // --- X·ª¨ L√ù CH·ªÆ K√ù ---
            const directorNameElement = document.getElementById('director-name');
            if (getParam('loaichuky').toLowerCase() !== 'ch·ªØ k√Ω') {
                if (directorNameElement) directorNameElement.style.visibility = 'hidden';
            }

            // --- X·ª¨ L√ù NG√ÄY TH√ÅNG ---
            const datePlaceElement = document.getElementById('date-place');
            if (urlParams.has('ngaythang')) {
                datePlaceElement.textContent = getParam('ngaythang');
            } else {
                const today = new Date();
                datePlaceElement.textContent = `L·∫°ng S∆°n, ng√†y ${today.getDate()} th√°ng ${today.getMonth() + 1} nƒÉm ${today.getFullYear()}`;
            }

            // --- ƒêI·ªÄN B·∫¢NG D·ªÆ LI·ªÜU XE ---
            const dataString = getParam('data');
            let bksList = [];
            if (dataString) {
                const tableBody = document.getElementById('table-body');
                const rows = dataString.split('_b_');
                rows.forEach((rowData, index) => {
                    if (!rowData.trim()) return;
                    const cells = rowData.split('_a_').map(cell => cell.trim());
                    if (cells[0]) {
                        bksList.push(cells[0]);
                    }
                    const row = tableBody.insertRow();
                    row.insertCell().textContent = index + 1;
                    cells.forEach(cellData => {
                        row.insertCell().textContent = cellData;
                    });
                });
            }

            // --- HI·ªÇN TH·ªä CON D·∫§U & CH·ªÆ K√ù ---
            const signatureContainer = document.querySelector('.signature-container');
            const sealUrl = getParam('condau');
            const signatureUrl = getParam('chuki');

            const createImage = (src, alt, className) => {
                const img = document.createElement('img');
                img.src = src;
                img.alt = alt;
                img.className = className;
                img.onerror = () => { img.style.display = 'none'; };
                return img;
            };

            if (sealUrl) signatureContainer.appendChild(createImage(sealUrl, 'Con d·∫•u', 'seal'));
            if (signatureUrl) signatureContainer.appendChild(createImage(signatureUrl, 'Ch·ªØ k√Ω', 'signature'));

            // --- TAB 2: T·∫†O C√ÅC TRANG ƒêƒÇNG K√ù XE ---
            const dangkyContainer = document.getElementById('dangky-container');
            const linkAnhData = getParam('linkanh');

            if (linkAnhData.trim()) {
                const imageSets = linkAnhData.split('_b_');
                imageSets.forEach((imageSet, index) => {
                    if (!imageSet.trim()) return;
                    const imageUrl = imageSet.split('_a_').map(p => p.trim()).find(p => p.toLowerCase().startsWith('http'));
                    const bks = bksList[index] || 'Kh√¥ng r√µ BKS';
                    if (imageUrl) {
                        createDangKyPage(dangkyContainer, bks, imageUrl);
                    }
                });
            } else {
                dangkyContainer.innerHTML = '<div class="error-message">Kh√¥ng c√≥ d·ªØ li·ªáu ·∫£nh ƒëƒÉng k√Ω xe.</div>';
            }
            
            // --- LOGIC X·ª¨ L√ù TAB ---
            const hopDongContainer = document.getElementById('hopdong-container');
            const hopDongIframe = document.getElementById('hopdong-iframe');
            
            document.querySelectorAll('.tab-link').forEach(link => {
                link.addEventListener('click', function () {
                    const targetTabId = this.getAttribute('data-tab');
                    document.querySelectorAll('.tab-link.active, .tab-content.active').forEach(el => el.classList.remove('active'));
                    this.classList.add('active');
                    document.getElementById(targetTabId).classList.add('active');
                    
                    // X·ª≠ l√Ω ƒë·∫∑c bi·ªát cho tab h·ª£p ƒë·ªìng
                    if (targetTabId === 'tab3') {
                        // L·∫•y tr·ª±c ti·∫øp t·ª´ URL ƒë·ªÉ gi·ªØ nguy√™n ƒë·ªãnh d·∫°ng encoded (kh√¥ng decode)
                        // L·∫•y to√†n b·ªô ph·∫ßn sau hd= (c√≥ th·ªÉ ch·ª©a nhi·ªÅu query params)
                        const urlString = window.location.search;
                        const hdMatch = urlString.match(/[?&]hd=(.*)/);
                        const hdDataRaw = hdMatch ? hdMatch[1] : null;
                        
                        if (hdDataRaw && !hopDongIframe.src) {
                            // T·∫°o URL ƒë√≠ch b·∫±ng c√°ch gh√©p chu·ªói (gi·ªØ nguy√™n ƒë·ªãnh d·∫°ng encoded)
                            const targetUrl = `https://nguyenbatyads37.github.io/static-html-show-data/Hopdongviettrung.html?${hdDataRaw}`;
                            
                            // T·∫£i n·ªôi dung v√†o iframe
                            hopDongIframe.src = targetUrl;
                            hopDongIframe.onerror = function() {
                                hopDongContainer.innerHTML = '<div class="error-message">Kh√¥ng th·ªÉ t·∫£i n·ªôi dung h·ª£p ƒë·ªìng. Vui l√≤ng ki·ªÉm tra l·∫°i URL ho·∫∑c k·∫øt n·ªëi m·∫°ng.</div>';
                            };
                        } else if (!hdDataRaw) {
                            hopDongContainer.innerHTML = '<div class="error-message">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu h·ª£p ƒë·ªìng (tham s·ªë "hd") trong URL.</div>';
                        }
                    }
                });
            });

        });

        function createDangKyPage(container, bks, imageUrl) {
            const pageDiv = document.createElement('div');
            pageDiv.className = 'dangky-page';

            const bksDiv = document.createElement('div');
            bksDiv.className = 'dangky-bks';
            bksDiv.textContent = `·∫¢nh gi·∫•y ƒëƒÉng k√Ω xe: ${bks}`;
            pageDiv.appendChild(bksDiv);

            const wrapper = document.createElement('div');
            wrapper.className = 'dangky-image-wrapper';

            const img = document.createElement('img');
            img.src = imageUrl;
            img.alt = `·∫¢nh ƒëƒÉng k√Ω xe ${bks}`;
            img.loading = 'lazy';
            img.onerror = function () {
                this.style.display = 'none';
                wrapper.innerHTML = `<div class="error-message">L·ªói t·∫£i ·∫£nh. URL c√≥ th·ªÉ kh√¥ng c√¥ng khai ho·∫∑c ƒë√£ h·∫øt h·∫°n.</div>`;
            };

            wrapper.appendChild(img);
            pageDiv.appendChild(wrapper);
            container.appendChild(pageDiv);
        }

        function printTab(tabId) {
            const activeTab = document.querySelector('.tab-content.active');
            const targetTab = document.getElementById(tabId);

            // T·∫°m th·ªùi ·∫©n tab hi·ªán t·∫°i v√† hi·ªÉn th·ªã tab c·∫ßn in
            if (activeTab) activeTab.classList.remove('active');
            if (targetTab) targetTab.classList.add('active', 'printing');

            window.print();

            // Kh√¥i ph·ª•c l·∫°i tr·∫°ng th√°i tab sau khi in
            if (targetTab) targetTab.classList.remove('printing');
            if (activeTab) {
                activeTab.classList.add('active');
            } else {
                 document.getElementById('tab1').classList.add('active'); 
            }
             if (activeTab !== targetTab) {
                targetTab.classList.remove('active');
             }
        }
    </script>
</body>
</html>

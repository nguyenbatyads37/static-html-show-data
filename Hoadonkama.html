<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thermal Invoice - Viet Long Global</title>
    <style>
        /* --- CẤU HÌNH CHUNG (Style K80) --- */
        body {
            font-family: 'Courier New', Courier, monospace; /* Font đơn giản chuẩn in nhiệt */
            background-color: #555; /* Nền tối để nổi bật khổ giấy trắng */
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        /* Wrapper chứa tất cả hóa đơn */
        #invoices-wrapper {
            width: 100%;
            max-width: 85mm;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px; /* Khoảng cách giữa các đơn khi xem trên màn hình */
        }

        /* --- KHUNG HÓA ĐƠN TỪNG ĐƠN --- */
        .invoice-page {
            width: 78mm; /* Khổ giấy 80mm trừ lề */
            background-color: #fff;
            padding: 5mm;
            box-sizing: border-box;
            position: relative; /* Để căn logo chìm */
            overflow: hidden;
            min-height: 150mm;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            
            /* QUAN TRỌNG: NGẮT TRANG */
            page-break-after: always;
            break-after: page;
        }

        /* Ẩn ngắt trang ở đơn cuối cùng */
        .invoice-page:last-child {
            page-break-after: auto;
        }

        /* --- LOGO CHÌM (WATERMARK) --- */
        .watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%; /* Độ rộng logo */
            height: auto;
            opacity: 0.15; /* Độ mờ (để 0.15 cho in nhiệt rõ nét) */
            z-index: 0;
            pointer-events: none;
            filter: grayscale(100%); /* Chuyển sang đen trắng tốt cho máy in nhiệt */
        }

        /* --- NỘI DUNG TRÊN LOGO --- */
        .content {
            position: relative;
            z-index: 1;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 15px;
            border-bottom: 2px dashed #000;
            padding-bottom: 10px;
        }

        .company-name {
            /* YÊU CẦU: Đỏ và Đậm */
            color: #cc0000; 
            font-weight: 900;
            font-size: 18pt;
            text-transform: uppercase;
            margin: 0;
            line-height: 1.2;
            text-shadow: 2px 2px 0px #fff; /* Viền trắng để nổi trên logo */
        }

        .company-contact {
            font-size: 8pt;
            margin-top: 5px;
            font-weight: bold;
            color: #000;
        }

        /* Customer Info */
        .customer-info {
            font-size: 10pt;
            margin-bottom: 15px;
            border-bottom: 1px solid #000;
            padding-bottom: 10px;
            background-color: rgba(255,255,255, 0.8); /* Nền trắng mờ che logo giúp dễ đọc chữ */
        }

        .row {
            display: flex;
            margin-bottom: 4px;
        }
        .label {
            font-weight: bold;
            width: 55px;
            flex-shrink: 0;
        }
        .value {
            flex-grow: 1;
            word-break: break-word;
            font-weight: 600;
        }

        /* Table */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10pt;
            background-color: rgba(255,255,255, 0.8);
            margin-bottom: 15px;
        }

        th {
            text-align: left;
            border-bottom: 1px solid #000;
            padding: 5px 0;
            font-size: 9pt;
            text-transform: uppercase;
        }

        td {
            padding: 8px 0;
            border-bottom: 1px dotted #555;
            vertical-align: top;
            font-weight: 600;
        }
        
        .col-qty { text-align: center; width: 30px; }
        .col-amt { text-align: right; width: 75px; }

        .detail-note {
            display: block;
            font-size: 9pt;
            font-style: italic;
            font-weight: normal;
            margin-top: 2px;
        }

        /* Total Section */
        .total-section {
            text-align: right;
            font-size: 12pt;
            font-weight: 900;
            border-top: 2px dashed #000;
            padding-top: 10px;
            margin-bottom: 15px;
            background-color: rgba(255,255,255, 0.9);
        }
        .total-price {
            color: #cc0000;
            font-size: 16pt;
        }

        /* QR Code */
        .qr-container {
            text-align: center;
            margin-top: 10px;
            border-top: 1px dotted #000;
            padding-top: 15px;
            background-color: rgba(255,255,255, 0.9);
        }
        .qr-image {
            width: 45mm;
            height: 45mm;
            border: 2px solid #000;
            padding: 2px;
        }
        .qr-text {
            font-size: 10pt;
            font-weight: bold;
            margin-top: 5px;
            text-transform: uppercase;
        }

        /* Footer */
        .footer {
            text-align: center;
            font-size: 9pt;
            margin-top: 20px;
            font-style: italic;
            font-weight: bold;
        }

        /* Loading/Status */
        #status-message {
            text-align: center;
            color: white;
            font-size: 18px;
            padding: 20px;
        }
        .error { color: #ff6b6b; font-weight: bold; }

        /* --- CẤU HÌNH IN ẤN (Ctrl + P) --- */
        @media print {
            body { margin: 0; padding: 0; background: none; }
            #invoices-wrapper { max-width: none; width: 100%; gap: 0; }
            #status-message { display: none; }
            
            .invoice-page {
                width: 100%;
                height: auto;
                margin: 0;
                box-shadow: none;
                border: none;
                /* Bắt buộc ngắt trang */
                page-break-after: always;
            }
            
            /* Giữ màu sắc khi in */
            .company-name, .total-price {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
    </style>
</head>
<body>

    <div id="status-message">Loading data from Google Sheet...</div>
    <div id="invoices-wrapper"></div>

    <script>
        // URL API Google Script của bạn
        const webAppUrl = "https://script.google.com/macros/s/AKfycbyKjBkwJR6OdGt4hB45Kf6yBRX0l7kUicHUK9XY1vLU4iho9uk--YvDirw-CuG7rGjc/exec";

        // Hàm định dạng tiền (VD: 120000 -> 120,000)
        function formatCurrency(value) {
            if (value === null || typeof value === 'undefined') return "0";
            // Chuyển về số trước khi format
            const num = parseFloat(String(value).replace(/[^0-9.-]+/g, ''));
            return new Intl.NumberFormat('en-US').format(num || 0);
        }

        // Hàm lấy ngày giờ hiện tại
        function getNow() {
            return new Date().toLocaleString('en-GB', { hour12: false });
        }

        async function generateInvoices() {
            const wrapper = document.getElementById('invoices-wrapper');
            const statusMsg = document.getElementById('status-message');
            wrapper.innerHTML = ''; // Xóa nội dung cũ

            try {
                // 1. Fetch dữ liệu (Giống code Biokama)
                const response = await fetch(webAppUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP Error: ${response.status}`);
                }
                
                const apiResponse = await response.json();
                let orders = apiResponse.data;

                if (!Array.isArray(orders)) {
                    throw new Error("API response valid 'data' array is missing.");
                }

                // --- LOGIC LỌC THEO URL (Tính năng hay của Biokama) ---
                // Ví dụ: ?id=DTP25090142 trên thanh địa chỉ sẽ chỉ in đơn đó
                const urlParams = new URLSearchParams(window.location.search);
                const idParam = urlParams.get('id');

                if (idParam) {
                    const desiredIDs = idParam.split(',').map(code => code.trim().toUpperCase());
                    orders = orders.filter(order => {
                        const orderId = String(order['ID'] || '').toUpperCase();
                        const orderCode = String(order['ID oder'] || '').toUpperCase();
                        return desiredIDs.includes(orderId) || desiredIDs.includes(orderCode);
                    });
                }

                // Biến chứa toàn bộ HTML để chèn vào DOM 1 lần (Tối ưu hiệu năng)
                let allInvoicesHTML = '';
                let count = 0;

                // 2. Vòng lặp xử lý từng đơn hàng
                orders.forEach(order => {
                    // Điều kiện lọc: Phải có ID thì mới in
                    const currentID = order['ID'];
                    if (!currentID || String(currentID).trim() === "") return;

                    count++;

                    // Xử lý QR Code (Ưu tiên ID oder, nếu không có thì lấy ID)
                    let qrContent = order['ID oder'];
                    if (!qrContent || qrContent === "") qrContent = currentID;
                    
                    // Sử dụng QuickChart giống mẫu tham khảo (Hoặc QRServer)
                    const qrUrl = `https://quickchart.io/qr?text=${encodeURIComponent(qrContent)}&size=200`;

                    // Xử lý chi tiết sản phẩm
                    let productDetail = '';
                    if (order['Detail']) {
                        productDetail = `<span class="detail-note">${order['Detail']}</span>`;
                    }

                    // 3. Tạo HTML cho từng hóa đơn (Template String)
                    allInvoicesHTML += `
                    <div class="invoice-page">
                        <!-- Watermark Background -->
                        <img src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2F64ec6826.%E1%BA%A2nh.114246.png" class="watermark" alt="Watermark">
                        
                        <div class="content">
                            <!-- Header -->
                            <div class="header">
                                <h1 class="company-name">Viet Long Global</h1>
                                <div class="company-contact">LOGISTICS & TRADING SERVICES</div>
                            </div>

                            <!-- Customer Info -->
                            <div class="customer-info">
                                <div class="row">
                                    <span class="label">Date:</span>
                                    <span class="value">${getNow()}</span>
                                </div>
                                <div class="row">
                                    <span class="label">To:</span>
                                    <span class="value">${order['Customer name'] || ''}</span>
                                </div>
                                <div class="row">
                                    <span class="label">Tel:</span>
                                    <span class="value">${order['Mobile'] || ''}</span>
                                </div>
                                <div class="row">
                                    <span class="label">Addr:</span>
                                    <span class="value">${order['Address'] || ''}</span>
                                </div>
                            </div>

                            <!-- Product Table -->
                            <table>
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th class="col-qty">Qty</th>
                                        <th class="col-amt">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>
                                            ${order['Product'] || ''}
                                            ${productDetail}
                                        </td>
                                        <td class="col-qty">${order['Quantity'] || 0}</td>
                                        <td class="col-amt">${formatCurrency(order['Total MNT'])}</td>
                                    </tr>
                                </tbody>
                            </table>

                            <!-- Total Section -->
                            <div class="total-section">
                                Total: <span class="total-price">${formatCurrency(order['Total MNT'])}</span>
                            </div>

                            <!-- QR Code -->
                            <div class="qr-container">
                                <img src="${qrUrl}" class="qr-image" alt="QR Code" onerror="this.style.display='none'">
                                <div class="qr-text">${qrContent}</div>
                            </div>

                            <!-- Footer -->
                            <div class="footer">
                                Thank you for your business!
                            </div>
                        </div>
                    </div>
                    `;
                });

                // 4. Hiển thị kết quả
                if (count > 0) {
                    wrapper.innerHTML = allInvoicesHTML;
                    statusMsg.style.display = 'none';
                } else {
                    statusMsg.textContent = "Data loaded successfully but no valid orders found.";
                    statusMsg.classList.add('error');
                }

            } catch (error) {
                console.error("Error:", error);
                statusMsg.innerHTML = `
                    Lỗi tải dữ liệu: ${error.message}<br>
                    <small>Hãy chắc chắn bạn đang chạy file này trên máy tính và đã cài extension CORS hoặc API đã được public.</small>
                `;
                statusMsg.classList.add('error');
            }
        }

        // Chạy hàm khi trang load xong
        window.addEventListener('load', generateInvoices);

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kh√°ch H√†ng N·ª£ | T·ªïng kho H√† H√≤a</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
      /* ================================
   H√Ä H√íA ‚Äì CLEAN DASHBOARD THEME
   - N·ªÅn x√°m nh·∫π, card tr·∫Øng
   - Header gradient nh·∫π, kh√¥ng animate
   - B·∫£ng r√µ r√†ng, sticky header
   - Input pill, b√≥ng nh·∫π
   - KH√îNG l·∫∑p icon ph·ªÖu
   ================================ */

/* Palette */
:root{
  --primary-color:#22c55e;
  --secondary-color:#f59e0b;
  --text-color:#0f172a;
  --muted:#64748b;
  --bg:#f3f4f6;
  --card:#ffffff;
  --border:#e5e7eb;
  --danger:#ef4444;
  --info:#0ea5e9;
}

/* Reset & base */
*{margin:0;padding:0;box-sizing:border-box;font-family:'Roboto',sans-serif;}
body{
  line-height:1.6;
  color:var(--text-color);
  background:var(--bg);              /* n·ªÅn x√°m nh·∫π */
  min-height:100vh;
}

/* Container (card tr·∫Øng n·ªïi) */
.container{
  max-width:1800px;margin:20px auto;padding:20px;border-radius:18px;
  background:var(--card);
  box-shadow:0 10px 28px rgba(2,6,23,.08);
  display:none;
}
.container.visible{display:block;}

/* ===== Header (gradient nh·∫π, kh√¥ng animate) ===== */
/* ===== Header (gradient nh·∫π, co gi√£n an to√†n) ===== */
header{
  display:flex;
  align-items:center;
  justify-content:flex-start;   /* s·∫Øp x·∫øp c√°c item theo th·ª© t·ª± + cho ph√©p wrap */
  flex-wrap:wrap;               /* h·∫πp th√¨ t·ª± xu·ªëng d√≤ng, kh√¥ng ƒë√® nhau */
  gap:16px;
  margin-bottom:20px;
  padding:18px;
  border-radius:16px;
  background:linear-gradient(135deg,#6366f1 0%,#22c55e 60%,#f59e0b 100%);
  color:#fff;
}

header img{
  height:88px;                  /* c√≥ th·ªÉ ch·ªânh t√πy giao di·ªán */
  width:88px;
  border-radius:14px;
  object-fit:cover;
  border:2px solid rgba(255,255,255,.75);
  box-shadow:0 8px 20px rgba(0,0,0,.2);
  order:1;                      /* 1) logo */
}

.contact-info{
  font-size:14px;
  order:2;                      /* 2) ƒë·ªãa ch·ªâ + hotline */
  min-width:220px;              /* tr√°nh b·ªã b√≥p qu√° nh·ªè */
}

.contact-info .address,
.contact-info .hotline{
  font-weight:700;
  font-size:16px;
}

/* KH√îNG absolute n·ªØa, ƒë·ªÉ trong lu·ªìng flex */
.header-title{
  order:3;                      /* 3) ti√™u ƒë·ªÅ */
  flex:1;                       /* chi·∫øm ph·∫ßn c√≤n l·∫°i ƒë·ªÉ cƒÉn gi·ªØa ƒë·∫πp */
  text-align:center;
}
.header-title h1{font-size:24px;font-weight:800;margin:0;}
.header-title h2{font-size:18px;margin:0;opacity:.95;}

/* KH√îNG absolute n·ªØa, ƒë·∫©y v·ªÅ b√™n ph·∫£i b·∫±ng margin-left:auto */
#user-info{
  order:4;                      /* 4) pill user ·ªü cu·ªëi h√†ng */
  margin-left:auto;             /* t√°ch sang ph·∫£i */
  background:#fff;
  color:#111827;
  padding:6px 14px;
  border-radius:999px;
  font-size:14px;
  font-weight:600;
  box-shadow:0 6px 14px rgba(0,0,0,.12);
  white-space:nowrap;
}
#user-info #logout-btn{color:var(--danger);margin-left:8px}

/* Responsive: tr√™n m√†n h·∫πp, cho ti√™u ƒë·ªÅ chi·∫øm tr·ªçn 1 d√≤ng */
@media (max-width: 768px){
  header img{ height:72px; width:72px; }
  .header-title{
    flex-basis:100%;            /* ti√™u ƒë·ªÅ xu·ªëng 1 d√≤ng ri√™ng */
    order:4;                    /* ƒë·∫∑t ti√™u ƒë·ªÅ d∆∞·ªõi c√πng cho ƒë·∫πp tr√™n mobile */
    margin-top:4px;
  }
  #user-info{ order:3; }        /* pill user n·∫±m c√πng h√†ng v·ªõi logo/ƒë·ªãa ch·ªâ */
  .header-title h1{ font-size:20px; }
  .header-title h2{ font-size:16px; }
}

#user-info #logout-btn{color:var(--danger);margin-left:8px}

/* ===== Dashboard cards ===== */
.dashboard{
  display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px;margin-bottom:25px
}
.dashboard-card{
  border-radius:18px;padding:20px;background:#fff;
  box-shadow:0 8px 20px rgba(0,0,0,.06);transition:transform .15s ease, box-shadow .15s ease;
}
.dashboard-card:hover{transform:translateY(-2px);box-shadow:0 12px 26px rgba(0,0,0,.1)}
.dashboard-card h3{font-size:15px;color:#475569;margin-bottom:6px}
.dashboard-card p{font-size:22px;font-weight:800}
.dashboard-card:nth-child(1){border-top:4px solid #6366f1}
.dashboard-card:nth-child(2){border-top:4px solid #22c55e}
.dashboard-card:nth-child(3){border-top:4px solid #f59e0b}
.dashboard-card:nth-child(4){border-top:4px solid #ec4899}

/* Card ki·ªÉm so√°t h·∫°n m·ª©c */
#max-debt-control-card{grid-column:1/-1;}
.debt-control-wrapper{display:flex;align-items:flex-end;gap:14px;flex-wrap:wrap;margin-top:10px}
.debt-control-group{flex:1;min-width:220px}
.debt-control-group label{
  font-size:11px;font-weight:800;letter-spacing:.2px;text-transform:uppercase;color:#334155;
  background:#f1f5f9;border:1px solid #e2e8f0;border-radius:999px;padding:4px 8px;display:inline-block;margin-bottom:6px
}
.debt-control-group input{
  width:100%;height:40px;border:1px solid var(--border);border-radius:12px;padding:8px 10px;background:#fff;
  transition:border-color .15s, box-shadow .15s
}
.debt-control-group input:focus{outline:none;border-color:#22c55e;box-shadow:0 0 0 4px rgba(34,197,94,.2)}

/* ===== Login ===== */
#login-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:1000;display:flex;align-items:center;justify-content:center}
#login-box{background:#fff;padding:40px;border-radius:18px;box-shadow:0 20px 40px rgba(0,0,0,.28);text-align:center;width:100%;max-width:350px}
#login-box h2{margin-bottom:25px;color:var(--primary-color)}
.input-group{margin-bottom:20px;text-align:left}
.input-group label{display:block;margin-bottom:6px;font-weight:700;color:#475569}
.input-group input{width:100%;padding:10px;border:1px solid var(--border);border-radius:12px;background:#fff}
#login-btn{width:100%;padding:12px;border:none;border-radius:12px;font-size:16px;font-weight:800;color:#fff;background:linear-gradient(90deg,#22c55e,#16a34a)}

/* ===== Toolbar ===== */
.action-btn{
  border:none;border-radius:12px;padding:10px 16px;font-size:14px;font-weight:700;color:#fff;
  display:inline-flex;align-items:center;gap:8px
}
.export-btn{background:linear-gradient(90deg,#6366f1,#22c55e)}
.update-btn{background:linear-gradient(90deg,#f59e0b,#f97316)}
.controls-wrapper .action-btn{height:38px;padding:0 14px}
.record-count{background:#eef2ff;color:#3730a3;font-weight:800;border-radius:999px;height:28px;display:inline-grid;place-items:center;padding:0 10px}

/* ===== Filters (pill) ===== */
.table-controls{
  background:#fff;border:1px solid rgba(2,6,23,.06);border-radius:14px;padding:14px;
  box-shadow:0 6px 16px rgba(2,6,23,.06);margin-bottom:12px
}
.filters-row{
  display:grid;gap:10px;grid-template-columns:120px repeat(auto-fit,minmax(180px,1fr));align-items:center
}
.filters-row .label{
  font-weight:800;color:#111827;display:flex;align-items:center;gap:8px
}
/* Quan tr·ªçng: KH√îNG t·∫°o icon ph·ªÖu b·∫±ng ::before n·ªØa (ƒë·ªÉ tr√°nh tr√πng) */
/* .filters-row .label::before{ ... }  <-- ƒê√É G·ª† */

/* Inputs */
/* Nh√£n mini cho t·ª´ng √¥ l·ªçc */
.filters-row .field{ display:flex; flex-direction:column; gap:4px; }
.filters-row .field label{
  font-size:11px; font-weight:800; letter-spacing:.2px; text-transform:uppercase; color:#334155;
  background:#f1f5f9; border:1px solid #e2e8f0; border-radius:999px; padding:4px 8px; width:max-content;
}

.table-controls .filter-input{
  border:1px solid var(--border);background:#fff;height:38px;padding:8px 12px;border-radius:999px;
  box-shadow:0 1px 0 rgba(2,6,23,.04);transition:border-color .15s, box-shadow .15s
}
.table-controls .filter-input:focus{outline:none;border-color:#6366f1;box-shadow:0 0 0 4px rgba(99,102,241,.18)}

/* ===== Add panel ===== */
.add-panel{border:1px dashed var(--border);border-radius:12px;background:#fff;padding:10px}
.add-panel summary{font-size:15px;color:#0f172a;padding:6px 2px;cursor:pointer;display:flex;align-items:center;gap:6px}
.add-panel summary b{display:inline-flex;align-items:center;gap:6px}
.add-panel summary b::before{
  content:"+";display:inline-grid;place-items:center;width:20px;height:20px;border-radius:6px;background:#22c55e;color:#fff;font-weight:900;font-size:14px
}
.add-grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));margin-top:10px}
.add-grid .field label{
  font-size:12px;font-weight:900;letter-spacing:.2px;color:#334155;text-transform:uppercase;
  background:#f1f5f9;border:1px solid #e2e8f0;display:inline-block;padding:5px 8px;border-radius:999px;width:max-content;margin-bottom:4px
}
.add-grid .field input,
.add-grid .field select,
.add-grid .field textarea,
tbody td input, tbody td select, tbody td textarea{
  width:100%;border:1px solid var(--border);border-radius:12px;background:#fff;padding:10px 12px;font-size:14px;
  transition:border-color .15s,box-shadow .15s;background-clip:padding-box
}
.add-grid .field textarea, tbody td textarea{ 
  min-height:40px;            /* ‚úÖ h·∫° xu·ªëng cho nh·ªè l·∫°i */
  resize:vertical;
}

.add-grid .field input:focus,.add-grid .field select:focus,.add-grid .field textarea:focus,
tbody td input:focus,tbody td select:focus,tbody td textarea:focus{
  outline:none;border-color:#22c55e;box-shadow:0 0 0 4px rgba(34,197,94,.18)
}
::placeholder{color:#94a3b8}

/* ===== B·∫£ng ===== */
.table-container{position:relative;overflow:auto;max-height:65vh;background:#fff;border-radius:12px;box-shadow:0 8px 20px rgba(2,6,23,.06)}
/* Cho ph√©p b·∫£ng r·ªông h∆°n khung ƒë·ªÉ k√©o gi√£n th·∫≠t s·ª± */
table{
  border-collapse: collapse;
  width: max-content;     /* c√≥ th·ªÉ n·ªü r·ªông khi k√©o */
  min-width: 100%;        /* v·∫´n kh√¥ng nh·ªè h∆°n container */
  table-layout: fixed;    /* gi·ªØ nguy√™n ƒë·ªô r·ªông c·ªôt sau khi set */
}
thead th{ overflow: hidden; } /* tr√°nh xu·∫•t hi·ªán thanh cu·ªôn trong TH */

/* Header sticky cho T·∫§T C·∫¢ ti√™u ƒë·ªÅ c·ªôt */
.table-container table thead th{
  position: sticky;
  top: 0;
  z-index: 60;                /* n·ªïi tr√™n √¥ d·ªØ li·ªáu */
  background: #4CAF50;        /* gi·ªØ n·ªÅn khi d√°n */
  color:#fff;
  font-weight:800;
  letter-spacing:.2px;
  border-bottom:1px solid rgba(255,255,255,.28);
  padding:8px 10px;
  white-space:nowrap;
}
/* Sticky header ch·∫Øc ch·∫Øn ƒë·ª©ng tr√™n tbody v√† col-resizer */
.table-container { position: relative; }

.table-container table thead{
  position: sticky;
  top: 0;
  z-index: 150;          /* > tbody */
  background: #4CAF50;   /* ph√≤ng h·ªü n·ªÅn khi d√°n */
}

.table-container table thead th{
  position: sticky;
  top: 0;
  z-index: 160;          /* > .col-resizer (99) */
  background: #4CAF50;
}


.table-container table thead tr:first-child th + th{
  box-shadow: -1px 0 0 rgba(255,255,255,.45) inset;
}
.table-container table thead tr:first-child th:first-child{ width:56px; }
.table-container table thead tr:first-child th:not(:first-child){
  min-width:140px;
}



/* Tay n·∫Øm k√©o c·ªôt */
.col-resizer{
  position:absolute; top:0; right:0; bottom:0;
  width:12px; cursor:col-resize; user-select:none; z-index:99;
}
.col-resizer::after{
  content:''; position:absolute; right:5px; top:20%; bottom:20%;
  width:2px; background:#e5e7eb;
}

body.resizing-col{ cursor:col-resize; user-select:none; }


th,td{border:0;border-bottom:1px solid #eef2f7}
tbody td{padding:8px 10px;vertical-align:middle}
tbody tr:nth-child(even){background:#f8fafc}
tbody tr:hover{background:#fffbe6}
tbody tr.row-new{background:#ecfdf5!important}
tbody tr.row-dirty{background:#fff7ed!important}
tbody tr.row-overdue:not(.debt-paid-off){background:#fee2e2!important}
tfoot{position:sticky;bottom:0;z-index:10}
tfoot td{background:#f0fdf4!important;color:#065f46;font-weight:800;padding:10px 12px!important;border-top:1px solid #e2e8f0}

/* Delete icon */
.delete-btn{cursor:pointer;color:var(--danger);font-weight:700;font-size:18px;line-height:1;opacity:.9}
.delete-btn:hover{transform:scale(1.06)}

/* Toast */
#toast-container{position:fixed;bottom:20px;right:20px;z-index:2000}
.toast{padding:12px 20px;border-radius:12px;color:#fff;font-weight:600;box-shadow:0 10px 20px rgba(0,0,0,.2);margin-top:8px}
.toast.success{background:#22c55e}
.toast.error{background:#ef4444}
.toast.warning{background:#f59e0b}

/* Footer */
footer{text-align:center;margin-top:30px;color:var(--muted);font-size:13px}

/* Responsive */
@media (max-width:900px){
  .add-grid{grid-template-columns:1fr}
  thead tr:first-child th:not(:first-child){min-width:200px}
}
.align-left  { text-align: left; }
.align-right { text-align: left; }
.align-center{ text-align: center; }
/* Compact filters */
.table-controls{ padding:10px }
.filters-row{
  gap:8px;
  grid-template-columns:120px repeat(auto-fit,minmax(140px,1fr));
  align-items:center;
}
.filters-row .label{ font-size:13px }
.table-controls .filter-input{
  height:32px;                 /* ‚Üì th·∫•p h∆°n */
  font-size:13px;
  padding:6px 10px;
  border-radius:10px;          /* pill nh·ªè h∆°n */
  min-width:0;                 /* tr√°nh n·ªü qu√° to */
}

/* Responsive: ƒë·∫©y nh√£n l√™n 1 d√≤ng ri√™ng khi h·∫πp */
@media (max-width: 1100px){
  .filters-row{
    grid-template-columns: repeat(3,minmax(0,1fr));
  }
  .filters-row .label{
    grid-column: 1 / -1;
    margin-bottom: 2px;
  }
}

/* Cho ph√©p h√†ng l·ªçc co l·∫°i theo c·ªôt, kh√¥ng ph√° b·ªë c·ª•c */
.table-container{ overflow: auto }
/* H√†ng t·ªïng d∆∞·ªõi c√πng */
tfoot td:first-child{ width:56px }                  /* kh·ªõp c·ªôt X√≥a */
tfoot td.total-label{
  white-space:nowrap;                               /* kh√¥ng xu·ªëng d√≤ng */
  font-weight:800; color:#065f46;
  text-transform:uppercase; letter-spacing:.3px;
}
tfoot td{ vertical-align:middle }

/* CƒÉn ti√™u ƒë·ªÅ v√† c·ª•m n√∫t c√πng 1 h√†ng */
.table-title{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  margin-bottom:10px;
}
.table-title h2{
  margin:0;
  font-size:22px;
  font-weight:800;
}

/* C·ª•m ƒë·∫øm b·∫£n ghi + n√∫t n·∫±m b√™n ph·∫£i */
.table-title .controls-wrapper{
  margin-left:auto;              /* ƒë·∫©y sang ph·∫£i */
  display:flex;
  align-items:center;
  gap:8px;                       /* kho·∫£ng c√°ch gi·ªØa pill & n√∫t */
  white-space:nowrap;            /* tr√°nh xu·ªëng d√≤ng s·ªõm */
}

/* Responsive: m√†n h√¨nh h·∫πp th√¨ cho xu·ªëng d√≤ng ƒë·∫πp */
@media (max-width: 640px){
  .table-title{
    flex-direction:column;
    align-items:flex-start;
    gap:8px;
  }
  .table-title .controls-wrapper{
    margin-left:0;
    flex-wrap:wrap;
    white-space:normal;
  }
}

/* --- T√ÅCH KH·ªêI: Filters v√† Add-panel l√† 2 card ri√™ng --- */
.table-controls{
  background: transparent;
  border: 0;
  box-shadow: none;
  padding: 0;                /* b·ªè padding b·ªçc ngo√†i ƒë·ªÉ h·∫øt kho·∫£ng tr·∫Øng */
}

/* Card cho kh·ªëi T√¨m ki·∫øm */
.table-controls .filters-row{
  background: #fff;
  border: 1px solid rgba(2,6,23,.06);
  border-radius: 14px;
  box-shadow: 0 6px 16px rgba(2,6,23,.06);
  padding: 10px 12px;
  margin-bottom: 10px;       /* kho·∫£ng c√°ch g·ªçn gi·ªØa 2 kh·ªëi */
  gap: 8px;                  /* gi·∫£m kho·∫£ng c√°ch √¥ */
}

/* Card cho kh·ªëi Th√™m kho·∫£n n·ª£ m·ªõi */
.table-controls .add-panel{
  background: #fff;
  border: 1px dashed var(--border);
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(2,6,23,.05);
  padding: 10px;             /* g·ªçn h∆°n */
  margin-top: 0;             /* tr√°nh c√°ch xa filters */
}

/* T·ªëi ∆∞u kho·∫£ng tr·∫Øng trong form th√™m */
.table-controls .add-panel summary{ padding: 6px 2px; margin-bottom: 6px; }
.table-controls .add-grid{ gap: 10px; }             /* thu kho·∫£ng c√°ch c√°c field */
.table-controls .add-actions{ margin-top: 8px; }    /* g·ªçn n√∫t Th√™m */
.table-controls .add-grid textarea{ min-height: 76px; } /* v·ª´a m·∫Øt h∆°n */
/* T√°ch controls ra kh·ªèi b·∫£ng, c√≥ kho·∫£ng c√°ch g·ªçn */
#controls-khn {
  margin-bottom: 12px;
}
.status-indicator {
  display: none !important;
}
/* Ti√™u ƒë·ªÅ T√¨m ki·∫øm n·∫±m ri√™ng 1 d√≤ng */
.filters-row .search-label {
  grid-column: 1 / -1;
  font-weight: 800;
  color: #111827;
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 6px;
  font-size: 14px;
}
.filters-grid {
  display: grid;
  gap: 10px;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
}
/* Card cho kh·ªëi T√¨m ki·∫øm (g·∫≠p/m·ªü) */
.table-controls .filters-panel{
  background:#fff;
  border:1px solid rgba(2,6,23,.06);
  border-radius:14px;
  box-shadow:0 6px 16px rgba(2,6,23,.06);
  padding:8px 10px;
  margin-bottom:10px;
}

/* Header c√≥ icon k√≠nh l√∫p, b·∫•m ƒë·ªÉ g·∫≠p/m·ªü */
.filters-panel > summary.search-label{
  list-style:none;
  cursor:pointer;
  font-weight:800;
  color:#111827;
  display:flex;
  align-items:center;
  gap:6px;
  padding:6px 2px;
  margin-bottom:6px;
}
.filters-panel > summary.search-label::after{
  content:"‚ñæ";
  margin-left:auto;
  transition:transform .15s ease;
  opacity:.6;
}
.filters-panel[open] > summary.search-label::after{
  transform:rotate(180deg);
}

/* L∆∞·ªõi filter g·ªçn, kh√¥ng tr√†n */
/* M·ªói field x·∫øp label ·ªü tr√™n, input ·ªü d∆∞·ªõi */
.filters-grid .field{
  display: flex;
  flex-direction: column;
  gap: 4px;
  min-width: 0;
}

/* Gi·ªØ label g·ªçn 1 d√≤ng, kh√¥ng ƒë·∫©y input l·ªách */
.filters-grid .field label{
  display: inline-flex;
  align-items: center;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  min-height: 24px;   /* c√≥ th·ªÉ ƒë·ªÉ 28px n·∫øu th√≠ch cao h∆°n */
}

/* √î nh·∫≠p li·ªáu full chi·ªÅu ngang kh·ªëi */
.filters-grid .field .filter-input{
  width: 100%;
}


/* Gi·ªØ label c·ªßa t·ª´ng √¥ l·ªçc lu√¥n 1 d√≤ng, ƒë·ªìng nh·∫•t chi·ªÅu cao */
.filters-grid .field label{
  white-space: nowrap;        /* kh√¥ng xu·ªëng d√≤ng */
  overflow: hidden;           /* n·∫øu d√†i th√¨ ·∫©n ph·∫ßn d∆∞ */
  text-overflow: ellipsis;    /* hi·ªán ‚Ä¶ n·∫øu qu√° d√†i */
  min-height: 28px;           /* c√°c chip cao b·∫±ng nhau */
  display: inline-flex;       /* cƒÉn gi·ªØa d·ªçc cho text */
  align-items: center;        /* cƒÉn gi·ªØa d·ªçc */
}
/* --- N√∫t + Th√™m n·∫±m b√™n ph·∫£i ti√™u ƒë·ªÅ "Th√™m kho·∫£n n·ª£ m·ªõi" --- */
.add-panel summary{
  display:inline-flex;   /* ch·ªâ co theo n·ªôi dung */
  align-items:center;
  gap:12px;              /* kho·∫£ng c√°ch gi·ªØa ch·ªØ v√† n√∫t */
}
.add-panel .add-btn-inline{
  margin-left:0;         /* b·ªè auto */
  height:28px;
  padding:0 10px;
  border-radius:8px;
  font-size:13px;
}

/* ·∫®n kh·ªëi actions c≈© ph√≠a d∆∞·ªõi (v√¨ ƒë√£ ƒë∆∞a n√∫t l√™n summary) */
.add-panel .add-actions{
  display:none !important;
}
.add-panel .add-btn-inline i{ display:none !important; }
/* ·∫®n n√∫t X√≥a l·ªçc c≈© ·ªü d∆∞·ªõi (n·∫øu c√≥ render) */


/* m√†u n·ªÅn ƒë∆°n gi·∫£n cho n√∫t x√≥a l·ªçc tr√™n ti√™u ƒë·ªÅ */
.clear-btn { background: linear-gradient(90deg, var(--info), #6366f1); }

/* Footer n√∫t +Th√™m ·ªü cu·ªëi panel */
.add-panel .add-actions{
  display:flex !important;          /* b·∫≠t l·∫°i n·∫øu tr∆∞·ªõc ƒë√≥ t·ª´ng hidden */
  justify-content:flex-end;
  gap:8px;
  padding-top:10px;
  margin-top:8px;
  border-top:1px dashed var(--border);
}

/* Style n√∫t d∆∞·ªõi c√πng ‚Äì h∆°i cao, bo m·ªÅm */
.add-panel .add-actions .add-btn-bottom{
  height:36px;
  padding:0 14px;
  border-radius:10px;
  font-weight:800;
}

/* Mobile: cho n√∫t full-width nh√¨n g·ªçn */
@media (max-width: 768px){
  .add-panel .add-actions{ justify-content:stretch; }
  .add-panel .add-actions .add-btn-bottom{ width:100%; }
}

/* Lu√¥n hi·ªÉn th·ªã 4 c·ªôt cho dashboard */
.dashboard {
  display: grid;
  grid-template-columns: repeat(4, 1fr); /* 4 c·ªôt b·∫±ng nhau */
  gap: 16px;
  margin-bottom: 20px;
}

/* Style n√∫t +Th√™m c·∫°nh Ghi ch√∫ */
.add-panel .add-btn-bottom {
  margin-top: 6px;
  background: linear-gradient(90deg, #22c55e, #16a34a);
  color: #fff;
  font-weight: 700;
  font-size: 13px;
  padding: 6px 12px;
  border-radius: 8px;
  cursor: pointer;
  border: none;
}
.add-panel .add-btn-bottom:hover {
  opacity: 0.9;
}

/* ƒê·∫∑t n√∫t +Th√™m b√™n ph·∫£i √¥ Ghi ch√∫ */
.note-field .note-input-wrap{
  display: flex;
  gap: 10px;
  align-items: flex-start;    /* n√∫t cƒÉn theo ƒë·ªânh textarea */
}
.note-field textarea{
  flex: 1;
  resize: vertical;           /* cho ph√©p k√©o nh·ªè/l·ªõn */
  min-height: 40px;           /* ‚úÖ ƒë·ªÉ t·ªëi thi·ªÉu 40px (ho·∫∑c b·ªè h·∫≥n n·∫øu mu·ªën thu nh·ªè t·ª± do) */
}


/* N√∫t +Th√™m b√™n ph·∫£i */
.add-btn-right{
  white-space: nowrap;
  border: none;
  border-radius: 8px;
  padding: 10px 14px;
  font-weight: 800;
  cursor: pointer;
  background: linear-gradient(90deg,#22c55e,#16a34a);
  color: #fff;
  display: inline-flex;
  align-items: center;
  height: 40px;
}
.add-btn-right:hover{ opacity: .95; }

/* V√¥ hi·ªáu style n√∫t c≈© d·∫°ng "d∆∞·ªõi" n·∫øu c√≤n */
.add-btn-bottom{ display: none !important; }

/* Override cu·ªëi CSS */
.header-title h1 {
  font-size: 36px;
  font-weight: 900;
  line-height: 1.3;
}

@media (max-width: 768px) {
  .header-title h1 {
    font-size: 24px;  /* nh·ªè l·∫°i tr√™n mobile */
  }
}

#current-customer-debt-display {
  display: none !important;
}
/* Custom autocomplete dropdown */
.autocomplete-wrapper {
  position: relative;
  display: inline-block;
  width: 100%;
}

.autocomplete-dropdown {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  max-height: 80px;
  overflow-y: auto;
  background: white;
  border: 1px solid var(--border);
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  z-index: 1000;
  display: none;
}

.autocomplete-option {
  padding: 8px 12px;
  border-bottom: 1px solid #f0f0f0;
  cursor: pointer;
  font-size: 13px;
}

.autocomplete-option:hover {
  background-color: #f8f9fa;
}

.autocomplete-option:last-child {
  border-bottom: none;
}
/* Kh√≥a n√∫t ti√™u ƒë·ªÅ c·ªßa add-panel ƒë·ªÉ kh√¥ng g·∫≠p/m·ªü n·ªØa */
.add-panel > details > summary{
  pointer-events: none;   /* kh√¥ng b·∫•m ƒë∆∞·ª£c */
  cursor: default;        /* ƒë·ªïi v·ªÅ con tr·ªè th∆∞·ªùng */
}
/* B·ªè d·∫•u + xanh (pseudo-element) */
.add-panel summary b::before{
  content: none !important;
  display: none !important;
}
.add-panel summary b {
  font-size: 20px;
  font-weight: 700;
  color: #111827;     /* m√†u ch·ªØ ƒë·∫≠m */
  letter-spacing: 0.5px; /* gi√£n ch·ªØ nh·∫π */
}

/* ==== In ƒë·∫≠m t·∫•t c·∫£ ch·ªØ trong b·∫£ng KH√ÅCH H√ÄNG N·ª¢ ==== */
#container-khn table,
#container-khn table th,
#container-khn table td,
#container-khn table input,
#container-khn table select,
#container-khn table textarea {
  font-weight: 700 !important;
}


</style>

</head>


<body>
    <div id="login-overlay">
        <div id="login-box">
            <h2>ƒêƒÉng Nh·∫≠p H·ªá Th·ªëng</h2>
            <form id="login-form">
                <div class="input-group"> <label for="username">T√™n ƒëƒÉng nh·∫≠p</label> <input type="text" id="username" required> </div>
                <div class="input-group"> <label for="password">M·∫≠t kh·∫©u</label> <input type="password" id="password" required> </div>
                <button type="submit" id="login-btn">ƒêƒÉng Nh·∫≠p</button>
                <p id="login-error"></p>
            </form>
        </div>
    </div>

    <div class="container">
       <header>
            <div id="user-info"></div>
            <img alt="Logo" src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Ff6c823b5.%E1%BA%A2nh.094646.jpg" />
            <div class="contact-info">
                <div class="address">ƒê·ªãa ch·ªâ : S·ªë 46 - Thanh L≈©ng - Qu·∫£ng oai - TP H√† N·ªôi</div>
                <div class="hotline">Hotline : 0969.250.323</div>
            </div>
            <div class="header-title">
                <h1>Nh√† Ph√¢n Ph·ªëi H√† Ho√†</h1>
                <h2>B·∫£ng Kh√°ch H√†ng N·ª£</h2>
            </div>
        </header>

        <div class="dashboard">
            <div class="dashboard-card"> <h3>T·ªïng Ti·ªÅn N·ª£</h3> <p id="dashboard-total-no">0</p> </div>
            <div class="dashboard-card"> <h3>T·ªïng Ti·ªÅn ƒê√£ Tr·∫£</h3> <p id="dashboard-total-tra">0</p> </div>
            <div class="dashboard-card"> <h3>Gi√° Tr·ªã H√†ng Thu H·ªìi</h3> <p id="dashboard-total-thuhoi">0</p> </div>
            <div class="dashboard-card summary"> <h3>T·ªïng C√¥ng N·ª£ Cu·ªëi C√πng</h3> <p id="dashboard-total-conlai">0</p> </div>
            
            <div class="dashboard-card" id="max-debt-control-card">
                <h3>Ki·ªÉm So√°t H·∫°n M·ª©c N·ª£</h3>
                <div class="debt-control-wrapper">
                    <div class="debt-control-group">
                        <label for="max-debt-input">H·∫°n M·ª©c N·ª£ T·ªëi ƒêa C·ªßa T·ª´ng Kh√°ch H√†ng(VNƒê)</label>
                        <input type="text" id="max-debt-input" inputmode="decimal" placeholder="Nh·∫≠p h·∫°n m·ª©c...">
                    </div>
                    <div class="debt-control-group">
                        <label for="custom-debt-term-input">S·ªë Ng√†y N·ª£ T·ªëi ƒêa C·ªßa T·ª´ng Kh√°ch H√†ng</label>
                        <input type="number" id="custom-debt-term-input" placeholder="Nh·∫≠p s·ªë ng√†y..." value="30">

                    </div>

                    <!-- NVKD limit in dashboard -->
                    <div class="debt-control-group">
                      <label for="max-sales-debt-input">H·∫°n M·ª©c N·ª£ T·ªëi ƒêa C·ªßa T·ª´ng NV Kinh Doanh (VNƒê)</label>
                      <input type="text" id="max-sales-debt-input" inputmode="decimal" placeholder="Nh·∫≠p h·∫°n m·ª©c...">
                    </div>

                    <div id="current-sales-debt-display" class="debt-control-group" style="display: none;">
                      <p class="debt-label">N·ª£ hi·ªán t·∫°i c·ªßa NVKD:</p>
                      <p id="current-sales-debt-value">0 VNƒê</p>
                    </div>

                    <div id="current-customer-debt-display" class="debt-control-group">
                        <p class="debt-label">N·ª£ hi·ªán t·∫°i c·ªßa KH:</p>
                        <p id="current-customer-debt-value">0 VNƒê</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="main-content-khn">
            <div class="table-title">
                <h2>B·∫£ng Kh√°ch H√†ng N·ª£</h2>
                <div class="controls-wrapper">
                    <span id="count-khn" class="record-count">...</span>
                     <!-- N√∫t X√≥a l·ªçc m·ªõi ƒë·∫∑t tr√™n ti√™u ƒë·ªÅ -->
    <button id="btn-clear-khn" class="action-btn clear-btn">
      <i class="fa fa-filter-circle-xmark"></i> X√≥a l·ªçc
    </button>
                    <button id="update-btn-khn" class="update-btn action-btn" disabled><i class="fas fa-save"></i> L∆∞u Thay ƒê·ªïi</button>
                    <button class="export-btn action-btn" data-table-key="khn"><i class="fas fa-file-excel"></i> T·∫£i Excel</button>
                </div>
            </div>
            <!-- Controls t√°ch ri√™ng, KH√îNG cu·ªôn -->
<div id="controls-khn"></div>

<!-- Ch·ªâ b·∫£ng n·∫±m trong khung cu·ªôn -->
<div class="table-container">
  <div id="container-khn">
    <p class="status-indicator">ƒêang t·∫£i d·ªØ li·ªáu...</p>
  </div>
</div>

        </div>

        <footer>
            <p>&copy; 2023 - H·ªá th·ªëng qu·∫£n l√Ω T·ªïng kho H√† H√≤a</p>
        </footer>
    </div>

    <div id="toast-container"></div>
    <datalist id="customer-list-options"></datalist>
    <datalist id="sales-person-list-options"></datalist>
    <datalist id="delivery-staff-list-options"></datalist>
    <datalist id="region-list-options"></datalist>
<datalist id="phone-list-options"></datalist>


   <script>
    const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbwZ73GdTFsSitoVqJKiZKIbU3wHM_qpjxQEbhlKTwi1V9GijNC8SPoRH9vVDD65xb9x/exec';
    const TABLE_CONFIG = {
        'khn': { name: 'Kh√°ch H√†ng N·ª£', containerId: 'container-khn', countId: 'count-khn', loaded: false, totalField: 'S·ªë ti·ªÅn n·ª£' },
        'khtn': { name: 'Kh√°ch h√†ng tr·∫£ n·ª£', loaded: false, totalField: 'S·ªë ti·ªÅn tr·∫£ n·ª£' },
        'hth': { name: 'H√†ng thu h·ªìi', loaded: false, totalField: 'Th√†nh ti·ªÅn' },
    };
    const headerMapping = { 'Giao h√†ng cho n·ª£': 'NV Giao h√†ng',  'NV cho n·ª£': 'NV Giao h√†ng', 'Ng∆∞·ªùi ch·ªãu tr√°ch nhi·ªám': 'NV Kinh doanh', 'S·ªë ti·ªÅn n·ª£': 'Ti·ªÅn N·ª£', 'H·∫°n tr·∫£ n·ª£': 'H·∫°n N·ª£', 'Ng√†y ph·∫£i tr·∫£': 'Ng√†y ƒë·∫øn h·∫°n' };
    const HIDDEN_COLUMNS = ['id', 'id n·ª£'];
    const GIAO_HANG_NV_LIST = ['Hoa', 'Phong', 'minh', 'duy', 'Tu·∫•n L√°i xe', 'H√† (Nam)', 'Xuy·∫øn', 'Ho√†', 'H·∫°nh', 'H√† (N·ªØ)'];
    const NV_GIAO_HANG_HEADERS = ['Giao h√†ng cho n·ª£']; // b·ªè 'NV cho n·ª£'
    // Ch·ªâ c√°c c·ªôt trong danh s√°ch n√†y m·ªõi c√≥ √¥ l·ªçc
const FILTERABLE_HEADERS = [
  'T√™n Kh√°ch H√†ng',
  'Khu v·ª±c',
  'Ng∆∞·ªùi ch·ªãu tr√°ch nhi·ªám',
  'SƒêT',
  'Ng√†y n·ª£',
  'Ng√†y ph·∫£i tr·∫£',
  'Giao h√†ng cho n·ª£',  // bi·∫øn th·ªÉ 1
  'NV cho n·ª£'          // bi·∫øn th·ªÉ 2
];


    const NUMERIC_COLUMNS_FOR_TOTAL = ['S·ªë ti·ªÅn n·ª£', 'Th√†nh ti·ªÅn', 'S·ªë ti·ªÅn tr·∫£ n·ª£', 'ƒê∆°n gi√°', 'S·ªë l∆∞·ª£ng', 'H·∫°n tr·∫£ n·ª£', 'S·ªë ng√†y'];
    const COLUMN_CONFIG = {
        'Ng∆∞·ªùi ch·ªãu tr√°ch nhi·ªám': { align: 'left', className: 'col-sales-staff' }, 'ƒê·ªãa ch·ªâ': { align: 'left' }, 'Ghi ch√∫': { align: 'left' }, 'T√™n Kh√°ch H√†ng': { align: 'left' }, 'S·∫£n ph·∫©m/M·∫∑t h√†ng': { align: 'left' }, 'T√™n s·∫£n ph·∫©m': { align: 'left' }, 'SƒêT': { align: 'left' }, 'S·ªë ti·ªÅn n·ª£': { align: 'right' }, 'ƒê∆°n gi√°': { align: 'right' }, 'Th√†nh ti·ªÅn': { align: 'right' }, 'S·ªë ti·ªÅn tr·∫£ n·ª£': { align: 'right' }, 'H·∫°n tr·∫£ n·ª£': { align: 'right' }, 'S·ªë ng√†y': { align: 'right' }, 'S·ªë l∆∞·ª£ng': { align: 'right' }, 'Ng√†y n·ª£': { align: 'center' }, 'Ng√†y tr·∫£': { align: 'center' }, 'Ng√†y thu h·ªìi': { align: 'center' }, 'Ng√†y ph·∫£i tr·∫£': { align: 'center' },
    };

    // === PH√ÇN QUY·ªÄN (ADD) ===
    function normalizeVi(s='') {
      return s.normalize('NFD')
              .replace(/[\u0300-\u036f]/g, '')
              .replace(/ƒë/g,'d').replace(/ƒê/g,'D')
              .toLowerCase().trim();
    }
    const ALLOWED_CREATORS_RAW = ['Hoa', 'Hanh', 'Xuyen']; // whitelist g·ªëc
const ALLOWED_CREATORS = ALLOWED_CREATORS_RAW.map(normalizeVi); // so s√°nh kh√¥ng d·∫•u, lowercase

// Danh s√°ch t√†i kho·∫£n ƒë∆∞·ª£c full quy·ªÅn ch·ªânh s·ª≠a
const FULL_EDIT_ACCOUNTS = ['hoa1975', 'xuyen', 'hanh'];

let currentPerms = { canCreate: false, canEditExisting: false, canDelete: false, isViewer: true, canEditDebtTerm: false };

function computePerms(displayName, username) {
  const nameNorm = normalizeVi(displayName || '');
  const userNorm = normalizeVi(username || '');

  // Admin: full quy·ªÅn
  if (userNorm === 'admin') {
    return { canCreate: true, canEditExisting: true, canDelete: true, isViewer: false, canEditDebtTerm: true };
  }

  // 3 t√†i kho·∫£n ƒë·∫∑c bi·ªát: full quy·ªÅn nh∆∞ng kh√¥ng ƒë∆∞·ª£c s·ª≠a "S·ªë ng√†y n·ª£ t·ªëi ƒëa"
  if (FULL_EDIT_ACCOUNTS.includes(userNorm)) {
    return { canCreate: true, canEditExisting: true, canDelete: true, isViewer: false, canEditDebtTerm: false };
  }

  // Ng∆∞·ªùi th∆∞·ªùng theo whitelist c≈© (ch·ªâ t·∫°o m·ªõi)
  const canCreate = ALLOWED_CREATORS.includes(nameNorm);
  return { canCreate, canEditExisting: false, canDelete: false, isViewer: !canCreate, canEditDebtTerm: false };
}


    // √Åp quy·ªÅn v√†o UI m·ªói b·∫£ng
    function applyPermissions(tableKey) {
      const perms = currentPerms;
      const cfg = TABLE_CONFIG[tableKey];
      if (!cfg || !cfg.containerId) return;

      // N√∫t L∆∞u
      const saveBtn = document.getElementById(`update-btn-${tableKey}`);
      if (saveBtn) {
        // viewer kh√¥ng c·∫ßn hi·ªán n√∫t
        saveBtn.style.display = perms.isViewer ? 'none' : 'inline-flex';
        saveBtn.disabled = perms.isViewer;
      }
      // Ki·ªÉm so√°t √¥ "S·ªë ng√†y n·ª£ t·ªëi ƒëa" 
const debtTermInput = document.getElementById('custom-debt-term-input');
if (debtTermInput) {
  if (perms.canEditDebtTerm) {
    debtTermInput.removeAttribute('readonly');
    debtTermInput.removeAttribute('disabled');
  } else {
    debtTermInput.setAttribute('readonly', 'readonly');
    debtTermInput.style.backgroundColor = '#f3f4f6'; // m√†u x√°m nh·∫°t ƒë·ªÉ bi·∫øt kh√¥ng s·ª≠a ƒë∆∞·ª£c
  }
}

      const container = document.getElementById(cfg.containerId);
      if (!container) return;

      // ·∫®n/hi·ªán form th√™m ngo√†i b·∫£ng
      // ·∫®n/hi·ªán n√∫t Th√™m ·ªü controls host (ngo√†i b·∫£ng)
let addBtn =
  document.getElementById(`btn-add-${tableKey}`) ||
  document.querySelector(`#controls-${tableKey} #btn-add-${tableKey}`) ||
  container.querySelector(`#btn-add-${tableKey}`);
if (addBtn) addBtn.style.display = perms.canCreate ? '' : 'none';


      // Kh√≥a edit c√°c d√≤ng d·ªØ li·ªáu c≈© (kh√¥ng cho s·ª≠a)
       // Kh√≥a/m·ªü kh√≥a theo quy·ªÅn
 // Kh√≥a/m·ªü kh√≥a theo quy·ªÅn
container.querySelectorAll('tbody tr[data-id]').forEach(tr => {
  tr.classList.remove('row-dirty');
  tr.querySelectorAll('input, select, textarea').forEach(el => {
    if (perms.canEditExisting) {
      el.removeAttribute('readonly');
      el.removeAttribute('disabled');
      // V·ªõi 3 t√†i kho·∫£n ƒë·∫∑c bi·ªát: kh√¥ng cho s·ª≠a "H·∫°n tr·∫£ n·ª£"
      if (!perms.canEditDebtTerm && el.dataset.field === 'H·∫°n tr·∫£ n·ª£') {
        if (el.tagName === 'SELECT') el.setAttribute('disabled', 'disabled');
        else el.setAttribute('readonly', 'readonly');
        el.style.backgroundColor = '#f3f4f6';
      }
    } else {
      if (el.tagName === 'SELECT') el.setAttribute('disabled', 'disabled');
      else el.setAttribute('readonly', 'readonly');
    }
  });
});

 // Hi·ªán/·∫©n n√∫t x√≥a theo quy·ªÅn
 container.querySelectorAll('.delete-btn').forEach(btn => {
  btn.style.display = perms.canDelete ? '' : 'none';
});


      
    }

    let originalTableData = {};
    let changeSet = { create: {}, update: {}, delete: {} };
    let nhanSuList = [];
    let customerList = [];
    // B·ªô l·ªçc t·∫°m d√πng cho form th√™m (kh√¥ng ·∫£nh h∆∞·ªüng √¥ l·ªçc UI)
const TEMP_FILTERS = { khn: {} };


    function calculateCustomerTotalDebt(customerName) {
        if (!customerName) return 0;
        let totalDebt = 0, totalPaid = 0, totalReturned = 0;

        const getConsolidatedData = (tableKey) => {
            const originalData = originalTableData[tableKey]?.data || [];
            const createdData = Object.values(changeSet.create[tableKey] || {});
            const updatedData = changeSet.update[tableKey] || {};
            const deletedIds = new Set(changeSet.delete[tableKey] || []);
            let consolidated = [];
            originalData.forEach(row => {
                if (!deletedIds.has(row.id)) {
                    consolidated.push({ ...row, ...(updatedData[row.id] || {}) });
                }
            });
            consolidated.push(...createdData);
            return consolidated;
        };

        const allDebts = getConsolidatedData('khn');
        const customerDebtIds = new Set();
        
        allDebts.forEach(row => {
            if (row['T√™n Kh√°ch H√†ng'] === customerName) {
                totalDebt += parseFloat(String(row['S·ªë ti·ªÅn n·ª£'] || '0').replace(/\./g, '')) || 0;
                customerDebtIds.add(row.id);
            }
        });

        getConsolidatedData('khtn').forEach(row => {
            if (customerDebtIds.has(row['id n·ª£'])) {
                totalPaid += parseFloat(String(row['S·ªë ti·ªÅn tr·∫£ n·ª£'] || '0').replace(/\./g, '')) || 0;
            }
        });

        getConsolidatedData('hth').forEach(row => {
            if (row['T√™n Kh√°ch H√†ng'] === customerName) {
                totalReturned += parseFloat(String(row['Th√†nh ti·ªÅn'] || '0').replace(/\./g, '')) || 0;
            }
        });
        
        return totalDebt - totalPaid - totalReturned;
    }

    function calculateSalespersonTotalDebt(salesName) {
        if (!salesName) return 0;

        const getConsolidatedData = (tableKey) => {
            const originalData = originalTableData[tableKey]?.data || [];
            const createdData = Object.values(changeSet.create[tableKey] || {});
            const updatedData = changeSet.update[tableKey] || {};
            const deletedIds = new Set(changeSet.delete[tableKey] || []);
            const consolidated = [];
            originalData.forEach(row => {
                if (!deletedIds.has(row.id)) {
                    consolidated.push({ ...row, ...(updatedData[row.id] || {}) });
                }
            });
            consolidated.push(...createdData);
            return consolidated;
        };

        const khn = getConsolidatedData('khn');   // b·∫£ng n·ª£
        const khtn = getConsolidatedData('khtn'); // b·∫£ng tr·∫£ n·ª£

        // c·ªông tr·∫£ n·ª£ theo id n·ª£
        const paidByDebtId = {};
        khtn.forEach(p => {
            const idNo = p['id n·ª£'];
            const val = parseFloat(String(p['S·ªë ti·ªÅn tr·∫£ n·ª£'] || '0').replace(/\./g, '')) || 0;
            paidByDebtId[idNo] = (paidByDebtId[idNo] || 0) + val;
        });

        // t·ªïng n·ª£ c√≤n l·∫°i theo 'Ng∆∞·ªùi ch·ªãu tr√°ch nhi·ªám'
        let total = 0;
        khn.forEach(row => {
            if (row['Ng∆∞·ªùi ch·ªãu tr√°ch nhi·ªám'] === salesName) {
                const debtId = row.id;
                const totalDebt = parseFloat(String(row['S·ªë ti·ªÅn n·ª£'] || '0').replace(/\./g, '')) || 0;
                const paid = paidByDebtId[debtId] || 0;
                const remain = Math.max(0, totalDebt - paid);
                total += remain;
            }
        });
        return total;
    }

   function updateVisibleRowCount(tableKey) {
  const cfg = TABLE_CONFIG[tableKey];
  const container = document.getElementById(cfg.containerId);
  if (!container || !cfg.countId) return;

  const visibleRows = Array.from(
    container.querySelectorAll('tbody tr[data-id]')
  ).filter(tr => tr.style.display !== 'none' && !tr.classList.contains('debt-paid-off'));

  document.getElementById(cfg.countId).textContent = `${visibleRows.length} b·∫£n ghi`;
}

    
    function processAndMarkPaidDebts() {
        const khnData = originalTableData['khn']?.data;
        const khtnData = originalTableData['khtn']?.data;
        if (!khnData) return;
        const paidAmounts = {};
        (khtnData || []).forEach(p => { paidAmounts[p['id n·ª£']] = (paidAmounts[p['id n·ª£']] || 0) + (parseFloat(String(p['S·ªë ti·ªÅn tr·∫£ n·ª£'] || '0').replace(/\./g, '')) || 0); });
        
        const khnTable = document.querySelector('#container-khn table');
        if (!khnTable) return;
        khnData.forEach(debt => {
            const totalDebt = parseFloat(String(debt['S·ªë ti·ªÅn n·ª£'] || '0').replace(/\./g, '')) || 0;
            const totalPaid = paidAmounts[debt.id] || 0;
            const row = khnTable.querySelector(`tr[data-id="${debt.id}"]`);
            if (row) {
                if (totalPaid >= totalDebt && totalDebt > 0) {
                    row.classList.add('debt-paid-off');
                } else {
                    row.classList.remove('debt-paid-off');
                }
            }
        });
    }

    function highlightOverdueRows() {
        const table = document.querySelector('#container-khn table');
        if (!table) return;
        const rows = table.querySelectorAll('tbody tr[data-id]');
        const today = new Date();
        today.setHours(0, 0, 0, 0); 

        rows.forEach(row => {
            if (row.classList.contains('debt-paid-off')) {
                row.classList.remove('row-overdue');
                return;
            }
            const dueDateInput = row.querySelector('[data-field="Ng√†y ph·∫£i tr·∫£"]');
            if (dueDateInput && dueDateInput.value) {
                const dueDate = new Date(dueDateInput.value);
                if (dueDate < today) {
                    row.classList.add('row-overdue');
                } else {
                    row.classList.remove('row-overdue');
                }
            }
        });
    }
    function bringOverdueToTop(tableKey='khn'){
  const cfg = TABLE_CONFIG[tableKey];
  const container = document.getElementById(cfg.containerId);
  if (!container) return;
  const table = container.querySelector('table');
  if (!table) return;
  const tbody = table.querySelector('tbody');
  if (!tbody) return;

  const rows = Array.from(tbody.querySelectorAll('tr[data-id]'));

  const getDue = (tr) => {
    const inp = tr.querySelector('[data-field="Ng√†y ph·∫£i tr·∫£"]');
    if (!inp || !inp.value) return Number.POSITIVE_INFINITY;
    const d = new Date(inp.value);
    return isNaN(d) ? Number.POSITIVE_INFINITY : d.getTime();
  };

  // Chia nh√≥m theo tr·∫°ng th√°i hi·ªÉn th·ªã & qu√° h·∫°n
  const visible = rows.filter(r => r.style.display !== 'none');
  const hidden  = rows.filter(r => r.style.display === 'none');

  const overdueVisible = visible.filter(r =>
    r.classList.contains('row-overdue') && !r.classList.contains('debt-paid-off')
  );
  const normalVisible = visible.filter(r => !overdueVisible.includes(r));

  // S·∫Øp x·∫øp qu√° h·∫°n theo ng√†y ƒë·∫øn h·∫°n (s·ªõm -> mu·ªôn)
  overdueVisible.sort((a,b) => getDue(a) - getDue(b));

  // Tu·ª≥ th√≠ch: s·∫Øp x·∫øp ph·∫ßn c√≤n l·∫°i theo ng√†y ƒë·∫øn h·∫°n lu√¥n cho d·ªÖ theo d√µi
  normalVisible.sort((a,b) => getDue(a) - getDue(b));

  // Re-append ƒë·ªÉ ƒë·ªïi th·ª© t·ª± DOM
  tbody.append(...overdueVisible, ...normalVisible, ...hidden);
}


    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => { toast.remove(); }, 5000);
    }
    
    function createCellInput(originalHeader, value) {
        const formattedValue = value ?? '';
        let inputHtml = '';
        const textareaColumns = ['Ghi ch√∫', 'S·∫£n ph·∫©m/M·∫∑t h√†ng'];
        const config = COLUMN_CONFIG[originalHeader] || { align: 'left', className: '' };
        const cellClasses = `align-${config.align} ${config.className || ''}`.trim();
        if (originalHeader === 'T√™n Kh√°ch H√†ng') {
            inputHtml = `<input type="text" list="customer-list-options" data-field="${originalHeader}" value="${formattedValue}">`;
        } else if (textareaColumns.includes(originalHeader)) {
            inputHtml = `<textarea data-field="${originalHeader}">${formattedValue}</textarea>`;
        } else if (originalHeader === 'Giao h√†ng cho n·ª£') {
            const options = GIAO_HANG_NV_LIST.map(name => `<option value="${name}" ${name === formattedValue ? 'selected' : ''}>${name}</option>`).join('');
            inputHtml = `<select data-field="${originalHeader}"><option value="">-- Ch·ªçn --</option>${options}</select>`;
        } else if (originalHeader === 'NV cho n·ª£') {
            inputHtml = `<input type="text" list="delivery-staff-list-options" data-field="${originalHeader}" value="${formattedValue}" placeholder="Nh·∫≠p t√™n NV giao h√†ng...">`;
        } else if (originalHeader === 'Ng∆∞·ªùi ch·ªãu tr√°ch nhi·ªám') {
            inputHtml = `<input type="text" list="sales-person-list-options" data-field="${originalHeader}" value="${formattedValue}">`;
        } else {
            switch (originalHeader) {
                case 'SƒêT':
                    inputHtml = `<input type="tel" data-field="${originalHeader}" value="${formattedValue}" placeholder="S·ªë ƒëi·ªán tho·∫°i...">`;
                    break;
                case 'Ng√†y n·ª£':
                    inputHtml = `<input type="date" data-field="${originalHeader}" value="${formatDateForInput(formattedValue)}">`; break;
                case 'Ng√†y ph·∫£i tr·∫£':
                    inputHtml = `<input type="date" data-field="${originalHeader}" value="${formatDateForInput(formattedValue)}" readonly>`; break;
                case 'S·ªë ti·ªÅn n·ª£': case 'ƒê∆°n gi√°': case 'S·ªë l∆∞·ª£ng': {
    const cleanValue = String(formattedValue ?? '').replace(/[^\d]/g,'');
    const numericValue = cleanValue ? formatThousands(cleanValue) : '';
    inputHtml = `<input type="text" inputmode="decimal" data-field="${originalHeader}" value="${numericValue}">`;
    break;
}

                case 'H·∫°n tr·∫£ n·ª£': {
  const currentValue = (formattedValue ?? '') || getGlobalDebtTerm(); // fallback theo dashboard
  inputHtml = `<input type="number" data-field="H·∫°n tr·∫£ n·ª£" min="0" step="1" value="${currentValue}">`;
  break;
}

                default:
                    inputHtml = `<input type="text" data-field="${originalHeader}" value="${formattedValue}">`; break;
            }
        }
        return `<td class="${cellClasses}">${inputHtml}</td>`;
    }

    /* ==== M·ªöI: Toolbox b√™n ngo√†i (b·ªô l·ªçc + form th√™m) ==== */
    function createExternalControls(tableKey, headers, displayedHeaders) {
      const cfg = TABLE_CONFIG[tableKey];
      if (!cfg?.containerId) return;
      const controlsHost = document.getElementById(`controls-${tableKey}`);
if (!controlsHost) return;
 // ‚úÖ Th√™m d√≤ng n√†y ƒë·ªÉ c√≥ container c·ªßa b·∫£ng
  const container = document.getElementById(cfg.containerId);
// N·∫øu ƒë√£ t·∫°o r·ªìi th√¨ gi·ªØ nguy√™n
if (controlsHost.querySelector('.table-controls')) return;

const controls = document.createElement('div');
controls.className = 'table-controls';


      // ====== B·ªô l·ªçc (external) ======
    // ====== B·ªô l·ªçc (external) ======
const filters = document.createElement('details');
filters.className = 'filters-panel';
filters.open = true;
filters.innerHTML = `
  <summary class="search-label">
  <i class="fa fa-search"></i> T√¨m ki·∫øm
  <label style="margin-left:12px;display:inline-flex;align-items:center;gap:6px;font-size:13px;">
    <input type="checkbox" class="filter-checkbox" data-role="overdue-sales"> NVKD cho n·ª£ qu√° h·∫°n
  </label>
  <label style="margin-left:12px;display:inline-flex;align-items:center;gap:6px;font-size:13px;">
    <input type="checkbox" class="filter-checkbox" data-role="all" checked> T·∫•t c·∫£
  </label>
</summary>

  <div class="filters-grid">
    ${
      displayedHeaders
        .filter(h => FILTERABLE_HEADERS.includes(h))
        .map(h => {
          const ph = headerMapping[h] || h;

          // 1) 2 √¥ ng√†y
          if (h === 'Ng√†y n·ª£') {
            return `
              <div class="field">
                <label>Ng√†y n·ª£</label>
                <input class="filter-input" type="date" data-header="Ng√†y n·ª£" data-role="date-start">
              </div>`;
          }
          if (h === 'Ng√†y ph·∫£i tr·∫£') {
            return `
              <div class="field">
                <label>Ng√†y ƒë·∫øn h·∫°n</label>
                <input class="filter-input" type="date" data-header="Ng√†y ph·∫£i tr·∫£" data-role="date-end">
              </div>`;
          }

          // 2) C√°c √¥ c·∫ßn autocomplete
          if (h === 'T√™n Kh√°ch H√†ng') {
            return `
              <div class="field">
                <label>${ph}</label>
                <input class="filter-input" data-header="${h}" list="customer-list-options" placeholder="${ph}...">
              </div>`;
          }
          if (h === 'Khu v·ª±c') {
            return `
              <div class="field">
                <label>${ph}</label>
                <input class="filter-input" data-header="${h}" list="region-list-options" placeholder="${ph}...">
              </div>`;
          }
          if (h === 'SƒêT') {
            return `
              <div class="field">
                <label>${ph}</label>
                <input class="filter-input" type="tel" data-header="${h}" list="phone-list-options" placeholder="S·ªë ƒëi·ªán tho·∫°i...">
              </div>`;
          }
          if (h === 'Giao h√†ng cho n·ª£' || h === 'NV cho n·ª£') {
            return `
              <div class="field">
                <label>${ph}</label>
                <input class="filter-input" data-header="${h}" list="delivery-staff-list-options" placeholder="${ph}...">
              </div>`;
          }
          if (h === 'Ng∆∞·ªùi ch·ªãu tr√°ch nhi·ªám') {
            return `
              <div class="field">
                <label>${ph}</label>
                <input class="filter-input" data-header="${h}" list="sales-person-list-options" placeholder="${ph}...">
              </div>`;
          }

          // 3) M·∫∑c ƒë·ªãnh
          return `
            <div class="field">
              <label>${ph}</label>
              <input class="filter-input" data-header="${h}" placeholder="${ph}...">
            </div>`;
        })
        .join('')
    }
  </div>
`;







      // ====== Form th√™m m·ªõi (external) ======
      const addPanel = document.createElement('div');
      addPanel.className = 'add-panel';
      addPanel.innerHTML = `
  <details open>
    <summary>
      <b>üí± T·∫°o kho·∫£n n·ª£ m·ªõi</b>
    </summary>

    <div class="add-grid" id="add-form-${tableKey}">
      ${headers.map(h => {
        if (HIDDEN_COLUMNS.includes(h)) return `<input type="hidden" data-field="${h}">`;
        const disp = headerMapping[h] || h;

        // Ghi ch√∫: c√≥ n√∫t +Th√™m ƒë·∫∑t b√™n ph·∫£i
if (h === 'Ghi ch√∫') {
  return `<div class="field note-field">
            <label>${disp}</label>
            <div class="note-input-wrap">
              <textarea data-field="${h}" placeholder="${disp}..."></textarea>
              <button type="button" id="btn-add-${tableKey}"
                      class="action-btn update-btn add-btn-right">
                + Th√™m
              </button>
            </div>
          </div>`;
}

// S·∫£n ph·∫©m/M·∫∑t h√†ng: ch·ªâ textarea (kh√¥ng c√≥ n√∫t)
if (h === 'S·∫£n ph·∫©m/M·∫∑t h√†ng') {
  return `<div class="field"><label>${disp}</label>
            <textarea data-field="${h}" placeholder="${disp}..."></textarea>
          </div>`;
}


        if (h === 'ƒê·ªãa ch·ªâ') {
          return `<div class="field"><label>${disp}</label>
                    <input type="text" data-field="${h}" placeholder="${disp}..." autocomplete="street-address">
                  </div>`;
        }
        if (h === 'T√™n Kh√°ch H√†ng') {
          return `<div class="field"><label>${disp}</label>
                    <input type="text" list="customer-list-options" data-field="${h}" placeholder="Nh·∫≠p t√™n Kh√°ch H√†ng...">
                  </div>`;
        }
        if (NV_GIAO_HANG_HEADERS.includes(h)) {
          const o = GIAO_HANG_NV_LIST.map(n => `<option value="${n}">${n}</option>`).join('');
          return `<div class="field"><label>${disp}</label>
                    <select data-field="${h}"><option value="">-- Ch·ªçn --</option>${o}</select>
                  </div>`;
        }
        if (h === 'NV cho n·ª£') {
          return `<div class="field"><label>${disp}</label>
                    <input type="text" list="delivery-staff-list-options" data-field="${h}" placeholder="Nh·∫≠p t√™n NV giao h√†ng...">
                  </div>`;
        }
        if (h === 'Ng∆∞·ªùi ch·ªãu tr√°ch nhi·ªám') {
          return `<div class="field"><label>${disp}</label>
                    <input type="text" list="sales-person-list-options" data-field="${h}" placeholder="${disp}...">
                  </div>`;
        }

        switch (h) {
          case 'SƒêT':
            return `<div class="field"><label>${disp}</label>
                      <input type="tel" data-field="${h}" placeholder="S·ªë ƒëi·ªán tho·∫°i...">
                    </div>`;
          case 'Ng√†y n·ª£':
            return `<div class="field"><label>${disp}</label>
                      <input type="date" data-field="${h}" value="${new Date().toISOString().slice(0,10)}">
                    </div>`;
          case 'H·∫°n tr·∫£ n·ª£':
            return `<div class="field"><label>${disp}</label>
                      <input type="number" data-field="H·∫°n tr·∫£ n·ª£" placeholder="Ng√†y" value="30">
                    </div>`;
          case 'Ng√†y ph·∫£i tr·∫£':
            return `<div class="field"><label>${disp}</label>
                      <input type="date" data-field="${h}" readonly>
                    </div>`;
          case 'S·ªë ti·ªÅn n·ª£':
          case 'S·ªë l∆∞·ª£ng':
          case 'ƒê∆°n gi√°':
            return `<div class="field"><label>${disp}</label>
                      <input type="text" inputmode="decimal" data-field="${h}" placeholder="0">
                    </div>`;
          default:
            return `<div class="field"><label>${disp}</label>
                      <input type="text" data-field="${h}" placeholder="${disp}...">
                    </div>`;
        }
      }).join('')}
    </div>
  </details>
`;



      controls.appendChild(filters);
      controls.appendChild(addPanel);

      // Ch√®n controls l√™n ƒë·∫ßu container
      controlsHost.appendChild(controls);
      syncGlobalDebtTermToForm();    // form v·ª´a render xong -> k√©o gi√° tr·ªã s·ªë ng√†y t·ª´ dashboard v√†o


      // G·∫Øn s·ª± ki·ªán t√¨m ki·∫øm
      controls.querySelectorAll('.filter-input').forEach(inp => {
        inp.addEventListener('input', () => filterTable(tableKey));
      });
      // Checkbox l·ªçc qu√° h·∫°n / t·∫•t c·∫£
controls.querySelectorAll('.filter-checkbox').forEach(chk => {
  chk.addEventListener('change', () => {
    // N·∫øu tick ‚ÄúT·∫•t c·∫£‚Äù th√¨ b·ªè tick ‚ÄúNVKD cho n·ª£ qu√° h·∫°n‚Äù
    const host = document.getElementById(`controls-${tableKey}`);
    const allChk = host?.querySelector('.filter-checkbox[data-role="all"]');
    const overdueChk = host?.querySelector('.filter-checkbox[data-role="overdue-sales"]');
    if (chk.dataset.role === 'all' && allChk?.checked && overdueChk) overdueChk.checked = false;

    // N·∫øu tick ‚ÄúNVKD cho n·ª£ qu√° h·∫°n‚Äù th√¨ b·ªè tick ‚ÄúT·∫•t c·∫£‚Äù
    if (chk.dataset.role === 'overdue-sales' && overdueChk?.checked && allChk) allChk.checked = false;

    filterTable(tableKey);
  });
});


      // T·ª± ƒë·ªông t√≠nh Ng√†y ph·∫£i tr·∫£ trong form khi ƒë·ªïi Ng√†y n·ª£/H·∫°n tr·∫£ n·ª£
      const addForm = controls.querySelector(`#add-form-${tableKey}`);
      const ngayNo = addForm?.querySelector('[data-field="Ng√†y n·ª£"]');
      const hanNo  = addForm?.querySelector('[data-field="H·∫°n tr·∫£ n·ª£"]');
      const ngayPhaiTra = addForm?.querySelector('[data-field="Ng√†y ph·∫£i tr·∫£"]');
      function updateDueDateFromForm() {
        if (ngayNo && hanNo && ngayPhaiTra) {
          const due = calculateDueDate(ngayNo.value, hanNo.value);
          ngayPhaiTra.value = due;

        }
      }
      if (ngayNo)  ngayNo.addEventListener('input', updateDueDateFromForm);
      if (hanNo)   hanNo.addEventListener('input', updateDueDateFromForm);
      updateDueDateFromForm();
      

      // Hi·ªÉn th·ªã n·ª£ hi·ªán t·∫°i KH & NVKD khi g√µ trong form
      const khInp = addForm?.querySelector('[data-field="T√™n Kh√°ch H√†ng"]');
if (khInp) {
  khInp.addEventListener('input', (e) => {
    const name = e.target.value.trim();

    // (1) Ch·ªâ hi·ªÉn th·ªã n·ª£ hi·ªán t·∫°i n·∫øu c√≥ ph·∫ßn t·ª≠
    const wrap = controls.querySelector('#current-customer-debt-display-ext');
    const valEl = controls.querySelector('#current-customer-debt-value-ext');
    if (wrap && valEl) {
      if (name) {
        const cur = calculateCustomerTotalDebt(name);
        valEl.textContent = `${cur.toLocaleString('vi-VN')} VNƒê`;
        wrap.style.display = 'block';
      } else {
        wrap.style.display = 'none';
      }
    }

    // (2) ƒê·ªìng b·ªô filter + l·ªçc b·∫£ng
    // (2) Thi·∫øt l·∫≠p l·ªçc t·∫°m v√† l·ªçc b·∫£ng
if (!TEMP_FILTERS.khn) TEMP_FILTERS.khn = {};
if (name) TEMP_FILTERS.khn['T√™n Kh√°ch H√†ng'] = name;
else delete TEMP_FILTERS.khn['T√™n Kh√°ch H√†ng'];

filterTable('khn');

  });
}

      const nvInp = addForm?.querySelector('[data-field="Ng∆∞·ªùi ch·ªãu tr√°ch nhi·ªám"]');
      if (nvInp) {
        nvInp.addEventListener('input', (e) => {
          const name = e.target.value.trim();
          const wrap = controls.querySelector('#current-sales-debt-display-ext');
          const valEl = controls.querySelector('#current-sales-debt-value-ext');
          if (name) {
            const cur = calculateSalespersonTotalDebt(name);
            valEl.textContent = `${cur.toLocaleString('vi-VN')} VNƒê`;
            wrap.style.display = 'block';
          } else {
            wrap.style.display = 'none';
          }
        });
      }

      // ƒê·ªãnh d·∫°ng ti·ªÅn trong form
      addForm?.querySelectorAll('input[inputmode="decimal"]').forEach(setupCurrencyInput);
      // Kh√≥a √¥ "H·∫°n tr·∫£ n·ª£" cho 3 t√†i kho·∫£n ƒë·∫∑c bi·ªát
if (!currentPerms.canEditDebtTerm) {
  const hanNoInput = addForm?.querySelector('[data-field="H·∫°n tr·∫£ n·ª£"]');
  if (hanNoInput) {
    hanNoInput.setAttribute('readonly', 'readonly');
    hanNoInput.style.backgroundColor = '#f3f4f6';
  }
}

      // N√∫t Th√™m (form ngo√†i b·∫£ng)
      const addBtn = controls.querySelector(`#btn-add-${tableKey}`);
if (addBtn) {
  addBtn.addEventListener('click', (ev) => {
    ev.stopPropagation(); // ch·∫∑n g·∫≠p/m·ªü <details> khi b·∫•m n√∫t
    submitNewRowFromExternalForm(tableKey, addForm, container);
  });
}



    }

    function submitNewRowFromExternalForm(tableKey, formEl, container) {
      if (!currentPerms.canCreate) {
        showToast('B·∫°n kh√¥ng c√≥ quy·ªÅn th√™m m·ªõi.', 'error');
        return;
      }
      const headers = originalTableData[tableKey].headers;
      const rowData = {};
      headers.forEach(h => {
        const i = formEl.querySelector(`[data-field="${h}"]`);
        if (i) rowData[h] = i.value.replace(/\./g, '');
      });

      // H·∫°n m·ª©c KH
      const maxDebtInput = document.getElementById('max-debt-input');
      const maxDebtValue = maxDebtInput ? (parseFloat(maxDebtInput.value.replace(/\./g, '')) || 0) : 0;
      if (maxDebtValue > 0) {
        const customerName = rowData['T√™n Kh√°ch H√†ng'];
        if (customerName) {
          const currentDebt = calculateCustomerTotalDebt(customerName);
          const newDebt = parseFloat(rowData['S·ªë ti·ªÅn n·ª£'] || '0') || 0;
          if (currentDebt + newDebt > maxDebtValue) {
            showToast(`N·ª£ c·ªßa KH (${(currentDebt + newDebt).toLocaleString('vi-VN')}) v∆∞·ª£t h·∫°n m·ª©c (${maxDebtValue.toLocaleString('vi-VN')}). Kh√¥ng th·ªÉ th√™m!`, 'error');
            return;
          }
        }
      }

      // H·∫°n m·ª©c NVKD
      const maxSalesInput = document.getElementById('max-sales-debt-input');
      const maxSalesVal = maxSalesInput ? (parseFloat(maxSalesInput.value.replace(/\./g, '')) || 0) : 0;
      if (maxSalesVal > 0) {
        const salesName = rowData['Ng∆∞·ªùi ch·ªãu tr√°ch nhi·ªám'];
        if (salesName) {
          const currentSalesDebt = calculateSalespersonTotalDebt(salesName);
          const newDebt = parseFloat(rowData['S·ªë ti·ªÅn n·ª£'] || '0') || 0;
          if (currentSalesDebt + newDebt > maxSalesVal) {
            showToast(`N·ª£ c·ªßa NVKD (${(currentSalesDebt + newDebt).toLocaleString('vi-VN')}) v∆∞·ª£t h·∫°n m·ª©c (${maxSalesVal.toLocaleString('vi-VN')}). Kh√¥ng th·ªÉ th√™m!`, 'error');
            return;
          }
        }
      }

      if (!rowData['T√™n Kh√°ch H√†ng']) {
        showToast('Vui l√≤ng nh·∫≠p T√™n Kh√°ch H√†ng.', 'warning');
        return;
      }

      rowData['Ng√†y ph·∫£i tr·∫£'] = formatDateForServer(calculateDueDate(rowData['Ng√†y n·ª£'], rowData['H·∫°n tr·∫£ n·ª£']));
      const tempId = crypto.randomUUID();
      rowData['id'] = tempId;

      if (!changeSet.create[tableKey]) changeSet.create[tableKey] = {};
      changeSet.create[tableKey][tempId] = rowData;

      // Ch√®n d√≤ng m·ªõi v√†o tbody
      const table = container.querySelector('table');
      const tbody = table?.querySelector('tbody');
      if (tbody) {
        const cellsHtml = headers.map(h =>
          HIDDEN_COLUMNS.includes(h)
            ? `<td style="display: none;"></td>`
            : createCellInput(h, rowData[h])
        ).join('');
        const tr = document.createElement('tr');
        tr.dataset.id = tempId;
        tr.classList.add('row-new');
        tr.innerHTML = `<td class="align-center"><span class="delete-btn temp-delete-btn" data-id="${tempId}">&#10006;</span></td>` + cellsHtml;
        tr.querySelectorAll('input[inputmode="decimal"]').forEach(setupCurrencyInput);
        tbody.insertBefore(tr, tbody.firstChild); // l√™n ƒë·∫ßu cho d·ªÖ th·∫•y
      }

      // Reset form
      formEl.querySelectorAll('input, select, textarea').forEach(i => {
        const field = i.dataset.field;
        if (field === 'Ng√†y n·ª£') i.value = new Date().toISOString().slice(0, 10);
         else if (field === 'H·∫°n tr·∫£ n·ª£') i.value = getGlobalDebtTerm();
        else if (i.tagName === 'SELECT') i.selectedIndex = 0;
        else if (!i.readOnly) i.value = '';
      });
      // T√≠nh l·∫°i "Ng√†y ph·∫£i tr·∫£" sau khi reset form
{
  const ngayNo = formEl.querySelector('[data-field="Ng√†y n·ª£"]');
  const hanNo  = formEl.querySelector('[data-field="H·∫°n tr·∫£ n·ª£"]');
  const ngayPT = formEl.querySelector('[data-field="Ng√†y ph·∫£i tr·∫£"]');
  if (ngayNo && hanNo && ngayPT) {
    const due = calculateDueDate(ngayNo.value, hanNo.value);
    ngayPT.value = due;

  }
}

      const csdExt = document.getElementById('current-sales-debt-display-ext');
      const ccdExt = document.getElementById('current-customer-debt-display-ext');
      if (csdExt) csdExt.style.display = 'none';
      if (ccdExt) ccdExt.style.display = 'none';

      setChangesMade(tableKey, true);
      updateTotals(tableKey);
      updateDashboard();
      updateVisibleRowCount(tableKey);
      highlightOverdueRows();
      bringOverdueToTop(tableKey);

      updateVisibleRowCount(tableKey);  
    }
    /* ==== H·∫øt ph·∫ßn m·ªõi ==== */
function setupCustomAutocomplete(inputElement, optionsList) {
  // Tr√°nh setup l·∫°i n·∫øu ƒë√£ c√≥ wrapper
  if (inputElement.parentNode?.classList?.contains('autocomplete-wrapper')) return;
  
  const wrapper = document.createElement('div');
  wrapper.className = 'autocomplete-wrapper';
  inputElement.parentNode.insertBefore(wrapper, inputElement);
  wrapper.appendChild(inputElement);
  
  const dropdown = document.createElement('div');
  dropdown.className = 'autocomplete-dropdown';
  wrapper.appendChild(dropdown);
  
  inputElement.removeAttribute('list');
  
  inputElement.addEventListener('input', function() {
    const value = this.value.toLowerCase();
    if (value.length === 0) {
      dropdown.style.display = 'none';
      return;
    }
    
    const filtered = optionsList.filter(option => 
      option.toLowerCase().includes(value)
    ).slice(0, 6); // Ch·ªâ hi·ªÉn th·ªã t·ªëi ƒëa 6 options
    
    if (filtered.length === 0) {
      dropdown.style.display = 'none';
      return;
    }
    
    dropdown.innerHTML = filtered.map(option => 
      `<div class="autocomplete-option" data-value="${option}">${option}</div>`
    ).join('');
    
    dropdown.style.display = 'block';
  });
  
  dropdown.addEventListener('click', function(e) {
    if (e.target.classList.contains('autocomplete-option')) {
      inputElement.value = e.target.dataset.value;
      dropdown.style.display = 'none';
      inputElement.dispatchEvent(new Event('input', { bubbles: true }));
    }
  });
  
  inputElement.addEventListener('blur', function() {
    setTimeout(() => dropdown.style.display = 'none', 150);
  });
}

// H√†m setup autocomplete cho t·∫•t c·∫£ input c·∫ßn thi·∫øt
function setupAllCustomAutocomplete() {
  // T√™n kh√°ch h√†ng
  const customerInputs = document.querySelectorAll('input[list="customer-list-options"]');
  customerInputs.forEach(input => setupCustomAutocomplete(input, customerList));
  
  // NV giao h√†ng
  const deliveryInputs = document.querySelectorAll('input[list="delivery-staff-list-options"]');
  deliveryInputs.forEach(input => setupCustomAutocomplete(input, GIAO_HANG_NV_LIST));
  
  // NV kinh doanh
  const salesInputs = document.querySelectorAll('input[list="sales-person-list-options"]');
  salesInputs.forEach(input => setupCustomAutocomplete(input, nhanSuList));
}
    function renderTable(tableKey, data) {
        const config = TABLE_CONFIG[tableKey];
        const container = document.getElementById(config.containerId);
        if (!container) return;

        if (tableKey === 'khn' && data.data) {
            const uniqueCustomers = {};
            data.data.slice().reverse().forEach(row => {
                if (row['T√™n Kh√°ch H√†ng'] && !uniqueCustomers[row['T√™n Kh√°ch H√†ng']]) uniqueCustomers[row['T√™n Kh√°ch H√†ng']] = {};
            });
            customerList = Object.keys(uniqueCustomers);
            document.getElementById('customer-list-options').innerHTML = customerList.map(c => `<option value="${c}"></option>`).join('');
        }
        // === Region & Phone datalist ===
const uniqueRegions = new Set();
const uniquePhones  = new Set();

data.data.forEach(row => {
  if (row['Khu v·ª±c']) uniqueRegions.add(String(row['Khu v·ª±c']).trim());
  if (row['SƒêT'])     uniquePhones.add(String(row['SƒêT']).trim());
});

const regionDL = document.getElementById('region-list-options');
if (regionDL) {
  regionDL.innerHTML = Array.from(uniqueRegions)
    .sort((a,b) => a.localeCompare(b, 'vi'))
    .map(v => `<option value="${v}"></option>`).join('');
}

const phoneDL = document.getElementById('phone-list-options');
if (phoneDL) {
  phoneDL.innerHTML = Array.from(uniquePhones)
    .sort()
    .map(v => `<option value="${v}"></option>`).join('');
}


        if (!data.data || !data.headers) {
            container.innerHTML = '<p class="status-indicator">Kh√¥ng c√≥ d·ªØ li·ªáu.</p>';
            return;
        }

        const headers = data.headers;
        const displayedHeaders = headers.filter(h => !HIDDEN_COLUMNS.includes(h));

        // T·∫†O TOOLBOX NGO√ÄI B·∫¢NG (b·ªô l·ªçc + form th√™m)
        createExternalControls(tableKey, headers, displayedHeaders);

        // D·ª±ng b·∫£ng (KH√îNG c√≥ h√†ng filter v√† input-row trong thead/tbody)
        const headerHtml = `
          <thead>
            <tr>
              <th style="width: 50px;">X√≥a</th>
              ${displayedHeaders.map(h => `<th data-field="${h}">${headerMapping[h] || h}</th>`).join('')}

            </tr>
          </thead>
        `;

        const bodyHtml = `
          <tbody>
            ${data.data.map(row => {
              const rId = row['id'];
              //row['Ng√†y ph·∫£i tr·∫£'] = calculateDueDate(row['Ng√†y n·ª£'], row['H·∫°n tr·∫£ n·ª£']);
              const cH = headers.map(h =>
                HIDDEN_COLUMNS.includes(h)
                  ? `<td style="display: none;">${row[h] || ''}</td>`
                  : createCellInput(h, row[h])
              ).join('');
              return `<tr data-id="${rId}">
                <td class="align-center"><span class="delete-btn" data-id="${rId}">&#10006;</span></td>${cH}
              </tr>`;
            }).join('')}
          </tbody>
        `;

        // T·∫°o ph·∫ßn t·ª≠ table r·ªìi append (gi·ªØ toolbox ƒë√£ t·∫°o)
        const tableEl = document.createElement('table');
        tableEl.innerHTML = `${headerHtml}${bodyHtml}<tfoot></tfoot>`;
        container.innerHTML = ''; // x√≥a s·∫°ch tr∆∞·ªõc khi append
        container.appendChild(tableEl);
        makeColumnsResizable(tableEl);

        setupEventListeners(tableKey, container);
        updateTotals(tableKey);
        highlightOverdueRows();
        bringOverdueToTop('khn');

        applyPermissions(tableKey);
    }

    function updateTotals(tableKey) {
  const container = document.getElementById(TABLE_CONFIG[tableKey].containerId);
  if (!container) return;
  const table = container.querySelector('table');
  if (!table) return;
  const tfoot = table.querySelector('tfoot');
  if (!tfoot) return;

  // L·∫•y headers hi·ªÉn th·ªã (ƒë√£ b·ªè c·ªôt X√≥a b·∫±ng slice(1))
  const headers = Array.from(table.querySelectorAll('thead tr:first-child th'))
    .slice(1)
    .map(th => Object.keys(headerMapping).find(k => headerMapping[k] === th.textContent) || th.textContent);

  // Ch·ªâ t√≠nh tr√™n c√°c d√≤ng ƒëang hi·ªÉn th·ªã v√† ch∆∞a ‚Äúƒë√£ t·∫•t to√°n‚Äù
  const visibleRows = Array.from(table.querySelectorAll('tbody tr'))
    .filter(row => row.style.display !== 'none' && !row.classList.contains('debt-paid-off'));

  // B·∫Øt ƒë·∫ßu: 1 √¥ tr·ªëng cho c·ªôt X√≥a + 1 √¥ nh√£n ‚ÄúT·ªïng c·ªông‚Äù
  let cells = ['<td></td>', '<td class="total-label align-left">T·ªïng c·ªông</td>'];

  // Duy·ªát t·ª´ng header: c·ªôt 1 (ƒë·∫ßu ti√™n) ƒë√£ d√πng cho nh√£n ‚Üí ƒë·ªÉ tr·ªëng,
  // c√°c c·ªôt s·ªë th√¨ t√≠nh t·ªïng v√† cƒÉn ph·∫£i.
  headers.forEach((header, idx) => {
    // idx === 0 ƒë√£ d√πng cho √¥ nh√£n ‚ÄúT·ªïng c·ªông‚Äù r·ªìi, b·ªè qua
  if (idx === 0) { return; }
    if (NUMERIC_COLUMNS_FOR_TOTAL.includes(header) && header !== 'H·∫°n tr·∫£ n·ª£') {
      const total = visibleRows.reduce((sum, row) => {
        const input = row.querySelector(`[data-field="${header}"]`);
        const val = input ? (input.value || '0').replace(/\./g, '') : '0';
        return sum + (parseFloat(val) || 0);
      }, 0);
      cells.push(`<td class="align-right">${total.toLocaleString('vi-VN')}</td>`);
    } else {
      cells.push('<td></td>');
    }
  });

  tfoot.innerHTML = `<tr>${cells.join('')}</tr>`;
}


    function setupEventListeners(tableKey, container) {
        if (!container) return;
        const table = container.querySelector('table'); if (!table) return;
        const tbody = table.querySelector('tbody');

        // L·ªçc: l·∫•y t·ª´ toolbox (v√¨ .filter-input ƒë·∫∑t trong container)
            // L·ªçc: l·∫•y filter t·ª´ controlsHost (ngo√†i b·∫£ng)
    const controlsHost = document.getElementById(`controls-${tableKey}`);
    if (controlsHost) {
      controlsHost.querySelectorAll('.filter-input')
        .forEach(input => input.addEventListener('input', () => filterTable(tableKey)));
    }

        // Edit cell (gi·ªØ nguy√™n ‚Äî nh∆∞ng s·∫Ω kh√¥ng hi·ªáu l·ª±c v√¨ canEditExisting=false)
        tbody.addEventListener('change', (e) => {
            const el = e.target; 
            const tr = el.closest('tr'); 
            if (tr && !tr.classList.contains('input-row')) handleCellEdit(e, tableKey); 
        });

        // T√≠nh ng√†y ph·∫£i tr·∫£ khi ƒë·ªïi tr∆∞·ªùng trong b·∫£ng
        const eventTrigger = (e) => {
            const el = e.target;
            const tr = el.closest('tr');
            if (!tr) return;

            if (el.tagName === 'INPUT' || el.tagName === 'SELECT') {
                const row = el.closest('tr');
                if (row) {
                    const ngayNoInput = row.querySelector('[data-field="Ng√†y n·ª£"]');
                    const hanTraNoInput = row.querySelector('[data-field="H·∫°n tr·∫£ n·ª£"]');
                    const ngayPhaiTraInput = row.querySelector('[data-field="Ng√†y ph·∫£i tr·∫£"]');
                    
                    if (ngayNoInput && hanTraNoInput && ngayPhaiTraInput) {
                        ngayPhaiTraInput.value = calculateDueDate(ngayNoInput.value, hanTraNoInput.value);

                    }
                }
            }
            if ((el.tagName === 'INPUT' && el.type === 'text' && !el.hasAttribute('inputmode')) || el.tagName === 'TEXTAREA') {
                capitalizeFirstLetter(el);
            }
        };
        tbody.addEventListener('input', eventTrigger);

        // X√≥a t·∫°m d√≤ng m·ªõi (ƒë∆∞·ª£c th√™m tr∆∞·ªõc khi l∆∞u)
        tbody.addEventListener('click', (e) => { 
            if (e.target.classList.contains('temp-delete-btn')) { 
                const tr = e.target.closest('tr'); 
                const rowId = tr.dataset.id; 
                if (changeSet.create[tableKey]?.[rowId]) delete changeSet.create[tableKey][rowId]; 
                tr.remove(); 
                updateTotals(tableKey); 
                updateDashboard(); 
                updateVisibleRowCount(tableKey); 
                setChangesMade(tableKey, hasPendingChanges(tableKey)); 
            } 
        });

        // ƒê·ªãnh d·∫°ng ti·ªÅn trong tbody
        tbody.querySelectorAll('input[inputmode="decimal"]').forEach(setupCurrencyInput);

        // N√∫t x√≥a: ch·∫∑n
        table.querySelectorAll('.delete-btn:not(.temp-delete-btn)').forEach(btn => btn.addEventListener('click', (e) => handleDeleteClick(e, tableKey)));
    }

    function handleCellEdit(e, tableKey) {
        if (!currentPerms.canEditExisting) return;

        const element = e.target; const tr = element.closest('tr'); const rowId = tr.dataset.id; const field = element.dataset.field;
        let newValue = (element.getAttribute('inputmode') === 'decimal') ? element.value.replace(/\./g, '') : element.value;
        if (!rowId) return;
            // ‚úÖ N·∫øu s·ª≠a Ng√†y n·ª£ ho·∫∑c H·∫°n tr·∫£ n·ª£ ‚Üí c·∫≠p nh·∫≠t l·∫°i Ng√†y ph·∫£i tr·∫£
    if (field === 'Ng√†y n·ª£' || field === 'H·∫°n tr·∫£ n·ª£') {
      const ngayNoInput = tr.querySelector('[data-field="Ng√†y n·ª£"]');
      const hanTraNoInput = tr.querySelector('[data-field="H·∫°n tr·∫£ n·ª£"]');
      const ngayPhaiTraInput = tr.querySelector('[data-field="Ng√†y ph·∫£i tr·∫£"]');
      if (ngayNoInput && hanTraNoInput && ngayPhaiTraInput) {
        ngayPhaiTraInput.value = calculateDueDate(ngayNoInput.value, hanTraNoInput.value);

      }
    }

        if (!changeSet.update[tableKey]) changeSet.update[tableKey] = {};
        if (!changeSet.update[tableKey][rowId]) {
            const rowDataFromDOM = {};
            originalTableData[tableKey].headers.forEach(h => {
                const cell = tr.querySelector(`[data-field="${h}"]`);
                if (cell) rowDataFromDOM[h] = cell.value.replace(/\./g, '');
                else { const originalRow = originalTableData[tableKey]?.data.find(r => r.id == rowId); if (originalRow) rowDataFromDOM[h] = originalRow[h]; }
            });
            changeSet.update[tableKey][rowId] = { ...rowDataFromDOM, id: rowId };
        }
        changeSet.update[tableKey][rowId][field] = newValue;
        tr.classList.add('row-dirty');
        setChangesMade(tableKey, true);
        updateTotals(tableKey);
        updateDashboard();
        highlightOverdueRows();
        bringOverdueToTop(tableKey);

    }

    function handleDeleteClick(e, tableKey) {
  const btn = e.currentTarget || e.target;
  const rowId = btn?.dataset?.id;
  if (!rowId) return;

  if (!currentPerms.canDelete) {
    showToast('B·∫°n kh√¥ng c√≥ quy·ªÅn x√≥a.', 'error');
    return;
  }

  if (!changeSet.delete[tableKey]) changeSet.delete[tableKey] = [];
  if (!changeSet.delete[tableKey].includes(rowId)) {
    changeSet.delete[tableKey].push(rowId);
  }

  const tr = btn.closest('tr');
  if (tr) tr.style.display = 'none';

  setChangesMade(tableKey, true);
  updateTotals(tableKey);
  updateDashboard();
  updateVisibleRowCount(tableKey);
  showToast('ƒê√£ ƒë√°nh d·∫•u x√≥a. Nh·∫•n "L∆∞u Thay ƒê·ªïi" ƒë·ªÉ √°p d·ª•ng.', 'success');
}


    async function handleSaveChanges(tableKey) {
        const updateBtn = document.getElementById('update-btn-khn');
        updateBtn.disabled = true; updateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang l∆∞u...';
        const config = TABLE_CONFIG[tableKey];

        const DATE_FIELDS = ['Ng√†y n·ª£', 'Ng√†y ph·∫£i tr·∫£', 'Ng√†y tr·∫£', 'Ng√†y thu h·ªìi'];

const cleanData = (data) => {
  return JSON.parse(JSON.stringify(data)).map(row => {
    Object.keys(row).forEach(key => {
      // Gi·ªØ s·ªë 0 ƒë·∫ßu c·ªßa SƒêT
      if (key === 'SƒêT' && row[key]) {
        const phoneStr = String(row[key]).trim();
        row[key] = "'" + phoneStr;
      }

      // Chu·∫©n ho√° NG√ÄY sang MM/DD/YYYY
      if (DATE_FIELDS.includes(key) && row[key]) {
        row[key] = formatDateForServer(row[key]);
      }

      // Chu·∫©n ho√° s·ªë ng√†y n·ª£
      if (key === 'H·∫°n tr·∫£ n·ª£' && row[key] != null) {
        const n = parseInt(String(row[key]).replace(/\./g, ''), 10);
        row[key] = Number.isFinite(n) ? n : '';
      }

      // Chu·∫©n ho√° s·ªë ti·ªÅn/s·ªë l∆∞·ª£ng
      if (['S·ªë ti·ªÅn n·ª£','S·ªë ti·ªÅn tr·∫£ n·ª£','Th√†nh ti·ªÅn','ƒê∆°n gi√°','S·ªë l∆∞·ª£ng'].includes(key) && row[key] != null) {
        const num = parseFloat(String(row[key]).replace(/\./g, '').replace(/,/g, ''));
        row[key] = Number.isFinite(num) ? num : '';
      }
    });
    return row;
  });
};


        const createDataAll = Object.values(changeSet.create[tableKey] || {});
        const updateDataAll = Object.values(changeSet.update[tableKey] || {});
        const deleteIdsAll = changeSet.delete[tableKey] || [];

        const createData = currentPerms.canCreate ? cleanData(createDataAll) : [];
        const updateData = currentPerms.canEditExisting ? cleanData(updateDataAll) : [];
        const deleteIds  = currentPerms.canDelete ? deleteIdsAll : [];

        const fetchPromises = [];
        if (createData.length > 0) {
          fetchPromises.push(fetch(API_BASE_URL, {
            method: 'POST', mode: 'no-cors',
            body: JSON.stringify({ tableName: config.name, action: 'create', data: createData })
          }));
        }
        if (updateData.length > 0) {
          fetchPromises.push(fetch(API_BASE_URL, {
            method: 'POST', mode: 'no-cors',
            body: JSON.stringify({ tableName: config.name, action: 'update', data: updateData })
          }));
        }
        if (deleteIds.length > 0) {
          fetchPromises.push(fetch(API_BASE_URL, {
            method: 'POST', mode: 'no-cors',
            body: JSON.stringify({ tableName: config.name, action: 'delete', data: { ids: deleteIds } })
          }));
        }

        try {
            await Promise.all(fetchPromises);
            showToast('L∆∞u thay ƒë·ªïi th√†nh c√¥ng!', 'success');
            changeSet = { create: {}, update: {}, delete: {} };
            Object.keys(TABLE_CONFIG).forEach(k => TABLE_CONFIG[k].loaded = false);
            await initApp(true);
        } catch (error) { showToast('ƒê√£ x·∫£y ra l·ªói khi l∆∞u: ' + error.message, 'error');
        } finally { updateBtn.innerHTML = '<i class="fas fa-save"></i> L∆∞u Thay ƒê·ªïi'; }
    }

    async function loadData(tableKey, onComplete) {
        const config = TABLE_CONFIG[tableKey];
        if (!config || (config.loaded && !hasPendingChanges(tableKey))) { if (onComplete) onComplete(); return; }
        if (config.containerId) document.getElementById(config.containerId).innerHTML = `<p class="status-indicator">ƒêang t·∫£i...</p>`;
        try {
            const response = await fetch(`${API_BASE_URL}?tableName=${encodeURIComponent(config.name)}`);
            if (!response.ok) throw new Error(`L·ªói m·∫°ng: ${response.statusText}`);
            originalTableData[tableKey] = await response.json();

            // X·ª≠ l√Ω SƒêT ƒë·ªÉ ƒë·∫£m b·∫£o gi·ªØ s·ªë 0 ƒë·∫ßu
            if (originalTableData[tableKey] && originalTableData[tableKey].data) {
                originalTableData[tableKey].data.forEach(row => {
                    if (row['SƒêT'] && typeof row['SƒêT'] === 'number') {
                        row['SƒêT'] = String(row['SƒêT']).padStart(10, '0');
                    } else if (row['SƒêT']) {
                        row['SƒêT'] = String(row['SƒêT']).trim();
                    }
                });
            }

            if (config.containerId) renderTable(tableKey, originalTableData[tableKey]);
            config.loaded = true;
            if (config.containerId) setChangesMade(tableKey, false);
        } catch (error) { 
            if (config.containerId) document.getElementById(config.containerId).innerHTML = `<p class="status-indicator error">L·ªói t·∫£i d·ªØ li·ªáu: ${error.message}</p>`;
        } finally { if (onComplete) onComplete(); }
    }

    async function fetchNhanSuAndLogin(username, password, errorEl, loginBtn) {
        try {
            const response = await fetch(`${API_BASE_URL}?tableName=Nh√¢n s·ª±`);
            if (!response.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu ng∆∞·ªùi d√πng.');
            const personnelData = await response.json();
            if (!personnelData || !personnelData.data) throw new Error('D·ªØ li·ªáu ng∆∞·ªùi d√πng kh√¥ng h·ª£p l·ªá.');
            nhanSuList = [...new Set(personnelData.data.map(user => user['H·ªç v√† t√™n']))].filter(Boolean).sort();
            if (username && password) {
                const foundUser = personnelData.data.find(user => user['T√™n ƒëƒÉng nh·∫≠p'] === username && user['Passwword'] == password);
                if (foundUser) {  sessionStorage.setItem('loggedInUser', JSON.stringify({
   name: foundUser['H·ªç v√† t√™n'],
  username: foundUser['T√™n ƒëƒÉng nh·∫≠p']
 })); await initApp();
                } else { errorEl.textContent = 'T√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng.'; }
            }
        } catch (error) { if(errorEl) errorEl.textContent = 'L·ªói k·∫øt n·ªëi ho·∫∑c kh√¥ng t√¨m th·∫•y b·∫£ng Nh√¢n s·ª±.';
        } finally { if (loginBtn) { loginBtn.textContent = 'ƒêƒÉng Nh·∫≠p'; loginBtn.disabled = false; } }
    }

    async function handleLogin(e) { e.preventDefault(); const username = document.getElementById('username').value; const password = document.getElementById('password').value; const errorEl = document.getElementById('login-error'); const loginBtn = document.getElementById('login-btn'); errorEl.textContent = ''; loginBtn.textContent = 'ƒêang x·ª≠ l√Ω...'; loginBtn.disabled = true; await fetchNhanSuAndLogin(username, password, errorEl, loginBtn); }
    function handleLogout() { sessionStorage.removeItem('loggedInUser'); location.reload(); }

    async function initApp(isReload = false) {
        const user = JSON.parse(sessionStorage.getItem('loggedInUser'));
        if (user) {
            // === PH√ÇN QUY·ªÄN (ADD) === t√≠nh quy·ªÅn m·ªçi l·∫ßn
            currentPerms = computePerms(user.name, user.username);


            if (!isReload) {
                document.getElementById('login-overlay').style.display = 'none';
                document.querySelector('.container').classList.add('visible');
                const userInfoEl = document.getElementById('user-info');
                userInfoEl.innerHTML = `Xin ch√†o, <strong>${user.name}</strong>! <a href="#" id="logout-btn">ƒêƒÉng xu·∫•t</a>`;
                document.getElementById('logout-btn').addEventListener('click', handleLogout);
            }
            await fetchNhanSuAndLogin(); 
            const salesDatalist = document.getElementById('sales-person-list-options');
            if (salesDatalist && nhanSuList.length > 0) salesDatalist.innerHTML = nhanSuList.map(name => `<option value="${name}"></option>`).join('');
            await Promise.all([loadData('khn'), loadData('khtn'), loadData('hth')]);
            processAndMarkPaidDebts();
            updateDashboard();
            updateVisibleRowCount('khn');
            highlightOverdueRows();
            applyPermissions('khn');
            // √Åp d·ª•ng quy·ªÅn cho to√†n b·ªô dashboard sau khi load xong
const debtTermInput = document.getElementById('custom-debt-term-input');
if (debtTermInput && !currentPerms.canEditDebtTerm) {
    debtTermInput.setAttribute('readonly', 'readonly');
    debtTermInput.style.backgroundColor = '#f3f4f6';
}

        } else {
            document.getElementById('login-overlay').style.display = 'flex';
        }
    }

    function setChangesMade(tableKey, madeChanges) { const btn = document.getElementById(`update-btn-${tableKey}`); if (btn) btn.disabled = !madeChanges; }
    function hasPendingChanges(tableKey) { return (Object.keys(changeSet.create[tableKey] || {}).length + Object.keys(changeSet.update[tableKey] || {}).length + (changeSet.delete[tableKey] || []).length) > 0; }
    
    function calculateGrandTotal(tableKey, filteredData = null) {
        const config = TABLE_CONFIG[tableKey];
        if (!config || !config.totalField) return 0;
        
        let sourceData;
        if(filteredData) {
            sourceData = filteredData;
        } else {
            const originalData = originalTableData[tableKey]?.data || [];
            const createdData = Object.values(changeSet.create[tableKey] || {});
            const updatedData = changeSet.update[tableKey] || {};
            const deletedIds = new Set(changeSet.delete[tableKey] || []);
            
            sourceData = [];
            originalData.forEach(row => {
                if (!deletedIds.has(row.id)) {
                    sourceData.push({ ...row, ...(updatedData[row.id] || {}) });
                }
            });
            sourceData.push(...createdData);
        }
        
        return sourceData.reduce((sum, row) => sum + (parseFloat(String(row[config.totalField] || '0').replace(/\./g, '')) || 0), 0);
    }
    
    function updateDashboard(filteredData = null) {
        const tN = calculateGrandTotal('khn', filteredData ? filteredData.khn : null);
        const tT = calculateGrandTotal('khtn', filteredData ? filteredData.khtn : null);
        const tTH = calculateGrandTotal('hth', filteredData ? filteredData.hth : null);
        document.getElementById('dashboard-total-no').textContent = tN.toLocaleString('vi-VN') + ' VNƒê';
        document.getElementById('dashboard-total-tra').textContent = tT.toLocaleString('vi-VN') + ' VNƒê';
        document.getElementById('dashboard-total-thuhoi').textContent = tTH.toLocaleString('vi-VN') + ' VNƒê';
        document.getElementById('dashboard-total-conlai').textContent = (tN - tT - tTH).toLocaleString('vi-VN') + ' VNƒê';
    }

    function calculateDueDate(startStr, daysStr) {
  if (!startStr || daysStr == null) return '';
  const days = parseInt(daysStr, 10);
  if (!Number.isFinite(days)) return '';

  // Parse local-date an to√†n
  let y, m, d;
  if (/^\d{4}-\d{2}-\d{2}$/.test(startStr)) {
    [y, m, d] = startStr.split('-').map(n => parseInt(n, 10));
  } else if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(startStr)) {
    const [mm, dd, yyyy] = startStr.split('/').map(n => parseInt(n, 10));
    y = yyyy; m = mm; d = dd;
  } else {
    const t = new Date(startStr);
    if (isNaN(t.getTime())) return '';
    y = t.getFullYear(); m = t.getMonth() + 1; d = t.getDate();
  }

  const dt = new Date(y, m - 1, d); // LOCAL 00:00
  dt.setDate(dt.getDate() + days);

  const yy = dt.getFullYear();
  const mm = String(dt.getMonth() + 1).padStart(2, '0');
  const dd = String(dt.getDate()).padStart(2, '0');
  return `${yy}-${mm}-${dd}`;           // lu√¥n YYYY-MM-DD cho input date
}
    
    function filterTable(tableKey) {
  const container = document.getElementById(TABLE_CONFIG[tableKey].containerId);
  const tbody = container.querySelector('tbody');
  if (!tbody) return;

  const rows = Array.from(tbody.querySelectorAll('tr'));

// ‚ùå B·ªè ch·ªó l·∫•y t·ª´ container
  // const allFilterInputs = Array.from(container.querySelectorAll('.filter-input'));

  // ‚úÖ L·∫•y filter-input t·ª´ controlsHost (ngo√†i b·∫£ng)
  const controlsHost = document.getElementById(`controls-${tableKey}`);
  const allFilterInputs = controlsHost
    ? Array.from(controlsHost.querySelectorAll('.filter-input'))
    : [];
    // L·∫•y tr·∫°ng th√°i 2 checkbox
const overdueChk = controlsHost?.querySelector('.filter-checkbox[data-role="overdue-sales"]');
const allChk     = controlsHost?.querySelector('.filter-checkbox[data-role="all"]');
const filterOverdue = !!overdueChk?.checked;
const filterAll     = !!allChk?.checked;
// N·∫øu b·ªè tick c·∫£ 2 checkbox th√¨ ·∫©n t·∫•t c·∫£ d√≤ng v√† return
if (!filterOverdue && !filterAll) {
  rows.forEach(row => row.style.display = 'none');
  updateTotals(tableKey);
  updateDashboard({ khn: [], khtn: [], hth: [] });
  updateVisibleRowCount(tableKey);
  return;
}


  // --- t√°ch l·ªçc ng√†y & text ---
  const startInput = allFilterInputs.find(i => i.dataset.role === 'date-start');
  const endInput   = allFilterInputs.find(i => i.dataset.role === 'date-end');
  const startStr = startInput?.value || '';
  const endStr   = endInput?.value   || '';

  const textFilters = allFilterInputs
    .filter(i => !i.dataset.role) // kh√¥ng ph·∫£i 2 √¥ ng√†y
    .map(i => ({ header: i.dataset.header, value: i.value.trim().toLowerCase() }));
    // G·ªôp th√™m b·ªô l·ªçc t·∫°m t·ª´ form th√™m (n·∫øu c√≥)
const tmp = TEMP_FILTERS[tableKey] || {};
Object.entries(tmp).forEach(([header, val]) => {
  if (val != null && String(val).trim() !== '') {
    textFilters.push({ header, value: String(val).trim().toLowerCase() });
  }
});


  const hasAnyText = textFilters.some(f => f.value !== '');
  const hasStart   = !!startStr;
  const hasEnd     = !!endStr;

  // helper so s√°nh ng√†y (yyyy-mm-dd) theo ng√†y, b·ªè gi·ªù
  const toYmd = d => (d ? new Date(d).toISOString().slice(0,10) : '');
  const parseSafe = s => (s ? new Date(s + 'T00:00:00') : null); // tr√°nh l·ªách m√∫i gi·ªù

  const startDate = parseSafe(startStr);
  const endDate   = parseSafe(endStr);

  // --- l·ªçc DOM theo ƒëi·ªÅu ki·ªán ---
  rows.forEach(row => {
    let ok = true;

    // 1) L·ªçc text (n·∫øu c√≥)
    if (ok && hasAnyText) {
      for (const f of textFilters) {
        if (!f.value) continue;
        const cell = row.querySelector(`[data-field="${f.header}"]`);
        const val = (cell ? (cell.value || cell.textContent) : '').toLowerCase();
        if (!val.includes(f.value)) { ok = false; break; }
      }
    }

    // 2) L·ªçc ng√†y theo 3 quy t·∫Øc
    if (ok && (hasStart || hasEnd)) {
      const startCell = row.querySelector('[data-field="Ng√†y n·ª£"]');
      const endCell   = row.querySelector('[data-field="Ng√†y ph·∫£i tr·∫£"]');

      const rowStart = parseSafe(startCell?.value || startCell?.textContent || '');
      const rowEnd   = parseSafe(endCell?.value   || endCell?.textContent   || '');

      // N·∫øu thi·∫øu d·ªØ li·ªáu ng√†y trong d√≤ng th√¨ coi l√† kh√¥ng kh·ªõp
      if (!rowStart || !rowEnd) ok = false;
      else {
        if (hasStart && !hasEnd) {
          // (1) Ch·ªâ ch·ªçn Ng√†y n·ª£ -> l·∫•y c√°c kho·∫£n n·ª£ b·∫Øt ƒë·∫ßu t·ª´ ng√†y ƒë√≥ tr·ªü ƒëi
          ok = (rowStart >= startDate);
        } else if (!hasStart && hasEnd) {
          // (2) Ch·ªâ ch·ªçn Ng√†y ƒë·∫øn h·∫°n -> ch·ªâ ƒë√∫ng ng√†y ƒë√≥ (so s√°nh ƒë√∫ng YYYY-MM-DD)
          ok = (toYmd(rowEnd) === toYmd(endDate));
        } else {
          // (3) Ch·ªçn c·∫£ 2 -> b·∫Øt ƒë·∫ßu >= start v√† k·∫øt th√∫c <= end
          ok = (rowStart >= startDate && rowEnd <= endDate);
        }
      }
    }
    // 3) L·ªçc ‚ÄúNVKD cho n·ª£ qu√° h·∫°n‚Äù (ch·ªâ √°p d·ª•ng khi kh√¥ng tick "T·∫•t c·∫£")
if (ok && filterOverdue && !filterAll) {
  const dueDateInput = row.querySelector('[data-field="Ng√†y ph·∫£i tr·∫£"]');
  const nvkdInput = row.querySelector('[data-field="Ng∆∞·ªùi ch·ªãu tr√°ch nhi·ªám"]');
  const nvkd = nvkdInput ? (nvkdInput.value || nvkdInput.textContent || '').trim() : '';
  const today = new Date(); today.setHours(0,0,0,0);

  if (!nvkd || !dueDateInput?.value) {
    ok = false; // thi·∫øu NVKD ho·∫∑c ng√†y ƒë·∫øn h·∫°n -> kh√¥ng t√≠nh qu√° h·∫°n
  } else {
    const dueDate = new Date(dueDateInput.value);
    ok = (dueDate < today); // ch·ªâ gi·ªØ d√≤ng ƒë√£ qu√° h·∫°n
  }
}

    row.style.display = ok ? '' : 'none';
  });

  // --- c·∫≠p nh·∫≠t t·ªïng & dashboard theo d·ªØ li·ªáu ƒë√£ l·ªçc ---
  updateTotals(tableKey);
  highlightOverdueRows();
  bringOverdueToTop(tableKey);


  // C·∫≠p nh·∫≠t dashboard d·ª±a tr√™n d·ªØ li·ªáu ƒë√£ l·ªçc (khi c√≥ b·∫•t k·ª≥ filter)
  const anyFilterActive = hasAnyText || hasStart || hasEnd || (filterOverdue && !filterAll);


  if (anyFilterActive) {
    const visibleIds = new Set(
      rows.filter(r => r.style.display !== 'none' && !r.classList.contains('debt-paid-off'))
          .map(r => r.dataset.id)
    );
    const filteredKhn = (originalTableData.khn?.data || []).filter(r => visibleIds.has(r.id));
    const filteredDebtIds = new Set(filteredKhn.map(r => r.id));
    const filteredCustomerNames = new Set(filteredKhn.map(r => r['T√™n Kh√°ch H√†ng']));

    const filteredKhtn = (originalTableData.khtn?.data || []).filter(r => filteredDebtIds.has(r['id n·ª£']));
    const filteredHth  = (originalTableData.hth?.data  || []).filter(r => filteredCustomerNames.has(r['T√™n Kh√°ch H√†ng']));

    updateDashboard({ khn: filteredKhn, khtn: filteredKhtn, hth: filteredHth });
  } else {
    updateDashboard();
  }
    // c·∫≠p nh·∫≠t s·ªë b·∫£n ghi hi·ªÉn th·ªã
  updateVisibleRowCount(tableKey);

}


  function capitalizeFirstLetter(input) {
  if (!input || !input.value) return;

  // ‚õî B·ªè auto-vi·∫øt hoa ri√™ng cho √¥ "Ghi ch√∫"
  const fieldName = (input.dataset && input.dataset.field) || '';
  if (fieldName === 'Ghi ch√∫') return;

  // Vi·∫øt hoa ch·ªØ c√°i ƒë·∫ßu m·ªói t·ª´ cho c√°c √¥ c√≤n l·∫°i
  input.value = input.value
    .split(' ')
    .map(word => {
      if (word.length === 0) return word;
      return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
    })
    .join(' ');
}

function formatDateForInput(s) {
  if (!s) return '';
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
  const d = new Date(s);
  if (isNaN(d.getTime())) return '';
  const yy = d.getFullYear();
  const mm = String(d.getMonth() + 1).padStart(2, '0');
  const dd = String(d.getDate()).padStart(2, '0');
  return `${yy}-${mm}-${dd}`;
}

// === helpers ===
function formatDateForServer(s) {
  if (!s) return '';
  const ymd = formatDateForInput(s);
  if (!ymd) return '';
  const [y, m, d] = ymd.split('-');
  return `${m}/${d}/${y}`;              // g·ª≠i l√™n Sheet d·∫°ng MM/DD/YYYY
}
const formatThousands = (s) =>
  String(s ?? '')
    .replace(/[^\d]/g, '')                // ch·ªâ gi·ªØ s·ªë
    .replace(/\B(?=(\d{3})+(?!\d))/g, '.');  // ch√®n d·∫•u "."
function finalizeCurrency(el){
  if (!el || !el.getAttribute || el.getAttribute('inputmode') !== 'decimal') return;
  const raw = String(el.value || '').replace(/[^\d]/g, '');
  el.value = raw ? raw.replace(/\B(?=(\d{3})+(?!\d))/g, '.') : '';
}
function getGlobalDebtTerm(){
  const g = document.getElementById('custom-debt-term-input');
  const n = g && g.value ? parseInt(g.value, 10) : 30;
  return Number.isFinite(n) ? String(n) : '30';
}




    function setupCurrencyInput(input) {
  if (!input || input.__currencyBound) return;
  input.__currencyBound = true;

  let composing = false;

  input.addEventListener('compositionstart', () => composing = true);
  input.addEventListener('compositionend',   () => { 
    composing = false; 
    formatRealtime(); 
  });

  // Format ngay khi g√µ (real-time)
  const formatRealtime = () => {
    if (composing) return; // kh√¥ng format khi ƒëang g√µ ti·∫øng Vi·ªát
    
    const cursorPos = input.selectionStart;
    const oldValue = input.value;
    const rawValue = oldValue.replace(/[^\d]/g, ''); // ch·ªâ gi·ªØ s·ªë
    
    if (rawValue === '') {
      input.value = '';
      return;
    }
    
    // Format v·ªõi d·∫•u ch·∫•m
    const formattedValue = rawValue.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    
    if (formattedValue !== oldValue) {
      input.value = formattedValue;
      
      // T√≠nh to√°n l·∫°i v·ªã tr√≠ con tr·ªè
      const oldDots = (oldValue.slice(0, cursorPos).match(/\./g) || []).length;
      const newDots = (formattedValue.slice(0, cursorPos).match(/\./g) || []).length;
      const newCursorPos = cursorPos + (newDots - oldDots);
      
      // ƒê·∫∑t l·∫°i con tr·ªè
      input.setSelectionRange(newCursorPos, newCursorPos);
    }
  };

  // Format ngay khi g√µ
  input.addEventListener('input', formatRealtime);

  // Ch·ªâ format khi k·∫øt th√∫c nh·∫≠p (gi·ªØ l·∫°i cho ch·∫Øc ch·∫Øn)
  const finalize = () => { if (!composing) finalizeCurrency(input); };

  input.addEventListener('blur', finalize);
  input.addEventListener('change', finalize);

  // Enter/Tab: format ngay
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' || e.key === 'Tab') {
      finalize();
    }
  });

  // Space: ch·∫∑n ch√®n kho·∫£ng tr·∫Øng + format ngay
  input.addEventListener('keydown', (e) => {
    if (e.key === ' ' || e.code === 'Space') {
      e.preventDefault();      // kh√¥ng cho th√™m d·∫•u c√°ch v√†o √¥
      finalize();              // format s·ªë (ch√®n d·∫•u .)
    }
  });

  // Paste: format sau khi paste
  input.addEventListener('paste', () => {
    setTimeout(formatRealtime, 0);
  });

  // Format gi√° tr·ªã ban ƒë·∫ßu (n·∫øu c√≥)
  finalizeCurrency(input);
}


// === Resizable columns (k√©o gi√£n c·ªôt) ‚Äî map theo t√™n field, kh√¥ng l·ªách c·ªôt ·∫©n ===
function makeColumnsResizable(table){
  if (!table) return;
  const headerThs = Array.from(table.querySelectorAll('thead th[data-field]'));

  headerThs.forEach((th, displayIdx) => {
    th.style.position = 'relative';      // ƒë·ªÉ tay n·∫Øm b√°m ƒë√∫ng v√†o TH
    const field = th.dataset.field;

    const handle = document.createElement('div');
    handle.className = 'col-resizer';
    th.appendChild(handle);

    let startX = 0, startW = 0;

    const onMouseDown = (e) => {
      startX = e.pageX;
      startW = th.getBoundingClientRect().width;
      document.body.classList.add('resizing-col');
      document.addEventListener('mousemove', onMouseMove);
      document.addEventListener('mouseup', onMouseUp);
      e.preventDefault();
    };

    const onMouseMove = (e) => {
      const dx = e.pageX - startX;
      const newW = Math.max(100, startW + dx);
      th.style.width = newW + 'px';
      th.style.minWidth = newW + 'px';

      // √Åp cho ƒë√∫ng TD c·ªßa c·ªôt n√†y
      table.querySelectorAll('tbody tr').forEach(tr => {
        const ctrl = tr.querySelector(`[data-field="${CSS.escape(field)}"]`);
        if (ctrl) {
          const td = ctrl.closest('td');
          td.style.width = newW + 'px';
          td.style.minWidth = newW + 'px';
        }
      });

      // √Åp cho tfoot (c·ªông 1 v√¨ c·ªôt 0 l√† "X√≥a")
      const tfRow = table.querySelector('tfoot tr');
      if (tfRow && tfRow.children[displayIdx + 1]) {
        const td = tfRow.children[displayIdx + 1];
        td.style.width = newW + 'px';
        td.style.minWidth = newW + 'px';
      }
    };

    const onMouseUp = () => {
      document.body.classList.remove('resizing-col');
      document.removeEventListener('mousemove', onMouseMove);
      document.removeEventListener('mouseup', onMouseUp);
    };

    handle.addEventListener('mousedown', onMouseDown);
  });
}




function exportToExcel(e) {
  const tableKey = e.currentTarget.dataset.tableKey;
  if (!tableKey) return;

  const cfg = TABLE_CONFIG[tableKey];
  const container = document.getElementById(cfg.containerId);
  const table = container?.querySelector('table');
  if (!table) return showToast('Kh√¥ng t√¨m th·∫•y b·∫£ng ƒë·ªÉ xu·∫•t.', 'warning');

  // L·∫•y danh s√°ch c·ªôt hi·ªÉn th·ªã (b·ªè c·ªôt "X√≥a")
  const ths = Array.from(table.querySelectorAll('thead tr:first-child th[data-field]'));
  const headersInfo = ths.map(th => ({
    display: (th.textContent || '').trim(),  // t√™n hi·ªÉn th·ªã tr√™n file
    original: th.dataset.field               // t√™n c·ªôt g·ªëc ƒë·ªÉ t√¨m [data-field="..."]
  }));
  const headers = headersInfo.map(h => h.display);
  if (headers.length === 0) return showToast('Kh√¥ng c√≥ c·ªôt d·ªØ li·ªáu ƒë·ªÉ xu·∫•t.', 'warning');

  // X√°c ƒë·ªãnh c·ªôt s·ªë / c·ªôt ng√†y d·ª±a tr√™n t√™n c·ªôt g·ªëc
  const isNumericCol = (orig) => NUMERIC_COLUMNS_FOR_TOTAL.includes(orig);
  const isDateCol    = (orig) => orig.includes('Ng√†y');

  // Thu th·∫≠p d·ªØ li·ªáu c√°c h√†ng ƒëang hi·ªÉn th·ªã
  const rows = Array.from(table.querySelectorAll('tbody tr'))
    .filter(tr => tr.style.display !== 'none' && !tr.classList.contains('debt-paid-off'));

  const dataAoA = [headers];

  rows.forEach(tr => {
    const rowArr = headersInfo.map(h => {
      const ctrl = tr.querySelector(`[data-field="${CSS.escape(h.original)}"]`);
      let raw = '';
      if (ctrl) {
        // input/select/textarea
        raw = (ctrl.value ?? ctrl.textContent ?? '').trim();
      } else {
        // fallback: l·∫•y text c·ªßa TD ch·ª©a control (r·∫•t hi·∫øm khi c·∫ßn)
        const td = Array.from(tr.children).find(td =>
          td.querySelector && td.querySelector(`[data-field="${CSS.escape(h.original)}"]`)
        );
        raw = (td?.textContent || '').trim();
      }

      if (isNumericCol(h.original)) {
        const num = Number(String(raw).replace(/\./g, '').replace(/,/g, ''));
        return Number.isFinite(num) ? num : null;
      }
      if (isDateCol(h.original)) {
        const d = new Date(raw);
        return isNaN(d.getTime()) ? raw : d;
      }
      return raw;
    });

    dataAoA.push(rowArr);
  });

  // H√†ng t·ªïng (n·∫øu c√≥)
  const tfootRow = table.querySelector('tfoot tr');
  if (tfootRow) {
    const totalArr = headersInfo.map((h, idx) => {
      if (idx === 0) {
        // √¥ ƒë·∫ßu ti√™n ghi "T·ªîNG C·ªòNG" (ho·∫∑c gi·ªØ text hi·ªán c√≥ n·∫øu c√≥)
        const td = tfootRow.children[1]; // v√¨ c·ªôt 0 l√† "X√≥a"
        const txt = (td?.textContent || '').trim();
        return txt || 'T·ªîNG C·ªòNG';
      }
      // t√¨m ƒë√∫ng TD c·ªßa c·ªôt hi·ªán t·∫°i trong tfoot (d·ªãch +1 v√¨ c√≥ c·ªôt "X√≥a")
      const td = tfootRow.children[idx + 1];
      const txt = (td?.textContent || '').trim();
      if (isNumericCol(h.original)) {
        const num = Number(txt.replace(/\./g, '').replace(/,/g, ''));
        return Number.isFinite(num) ? num : null;
      }
      return txt;
    });
    dataAoA.push(totalArr);
  }

  // T·∫°o workbook/sheet
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(dataAoA);

  // Autofilter + freeze header
  ws['!autofilter'] = { ref: XLSX.utils.encode_range({ s: { r:0, c:0 }, e: { r: 0, c: headers.length - 1 } }) };
  ws['!freeze'] = { xSplit: 0, ySplit: 1 };

  // ƒê·ªãnh d·∫°ng s·ªë / ng√†y
  const range = XLSX.utils.decode_range(ws['!ref']);
  for (let C = range.s.c; C <= range.e.c; ++C) {
    const orig = headersInfo[C].original;
    for (let R = 1; R <= range.e.r; ++R) {
      const cellAddr = XLSX.utils.encode_cell({ r: R, c: C });
      const cell = ws[cellAddr];
      if (!cell) continue;
      if (isNumericCol(orig) && typeof cell.v === 'number') {
        cell.t = 'n';
        cell.z = '#,##0';
      } else if (isDateCol(orig) && cell.v instanceof Date) {
        cell.t = 'd';
        cell.z = 'yyyy-mm-dd';
      }
    }
  }

  // Auto-fit c·ªôt
  const colWidths = headersInfo.map((h, idx) => {
    let maxLen = h.display.length;
    for (let r = 1; r < dataAoA.length; r++) {
      const v = dataAoA[r][idx];
      let len = 0;
      if (v == null) len = 0;
      else if (v instanceof Date) len = 10;
      else if (typeof v === 'number') len = String(v).length + 2;
      else len = String(v).length;
      if (len > maxLen) maxLen = len;
    }
    if (isNumericCol(h.original)) maxLen = Math.max(maxLen, 12);
    if (isDateCol(h.original))    maxLen = Math.max(maxLen, 10);
    return { wch: Math.min(Math.max(maxLen + 2, 10), 40) };
  });
  ws['!cols'] = colWidths;

  // Ghi file
  const sheetName = (cfg.name || 'Sheet').slice(0, 30);
  const filename = `BaoCao_${cfg.name?.replace(/\s/g, '_') || 'CongNo'}_${new Date().toISOString().slice(0,10)}.xlsx`;
  XLSX.utils.book_append_sheet(wb, ws, sheetName);
  XLSX.writeFile(wb, filename);
}

     // --- ƒê·ªìng b·ªô "S·ªë Ng√†y N·ª£ T·ªëi ƒêa" (dashboard) -> "H·∫°n tr·∫£ n·ª£" (form th√™m) ---
function syncGlobalDebtTermToForm() {
  const debtTermInput = document.querySelector('#add-form-khn input[data-field="H·∫°n tr·∫£ n·ª£"]');
  if (!debtTermInput) return;

  const v = getGlobalDebtTerm();     // lu√¥n l·∫•y theo dashboard, fallback 30
  debtTermInput.value = v;

  // b·∫Øn event ƒë·ªÉ t√≠nh l·∫°i "Ng√†y ph·∫£i tr·∫£"
  debtTermInput.dispatchEvent(new Event('input', { bubbles: true }));
}



    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('login-form').addEventListener('submit', handleLogin);
       document.querySelectorAll('.export-btn').forEach(btn => {
  btn.addEventListener('click', exportToExcel);
});

        document.getElementById('update-btn-khn').addEventListener('click', () => handleSaveChanges('khn'));
         // ‚¨á‚¨á‚¨á TH√äM ƒê√öNG V√ÄO ƒê√ÇY ‚¨á‚¨á‚¨á
  const clearTopBtn = document.getElementById('btn-clear-khn');
if (clearTopBtn){
  clearTopBtn.addEventListener('click', () => {
    const controlsHost = document.getElementById('controls-khn');
    if (controlsHost){
      // X√≥a n·ªôi dung c√°c √¥ filter
      controlsHost.querySelectorAll('.filters-panel .filter-input')
        .forEach(inp => inp.value = '');

      // ‚úÖ Reset l·∫°i checkbox: T·∫•t c·∫£ = tick, NVKD qu√° h·∫°n = b·ªè tick
      const allChk = controlsHost.querySelector('.filter-checkbox[data-role="all"]');
      const odChk  = controlsHost.querySelector('.filter-checkbox[data-role="overdue-sales"]');
      if (allChk) allChk.checked = true;
      if (odChk)  odChk.checked = false;
    }

    // X√≥a b·ªô l·ªçc t·∫°m t·ª´ form th√™m (n·∫øu c√≥)
    if (TEMP_FILTERS.khn) TEMP_FILTERS.khn = {};

    // √Åp l·∫°i l·ªçc v√† c·∫≠p nh·∫≠t
    filterTable('khn');
    updateVisibleRowCount('khn');
    showToast('ƒê√£ x√≥a b·ªô l·ªçc', 'success');
  });
}

  // ‚¨Ü‚¨Ü‚¨Ü H·∫æT PH·∫¶N TH√äM ‚¨Ü‚¨Ü‚¨Ü
        setupCurrencyInput(document.getElementById('max-debt-input'));
        setupCurrencyInput(document.getElementById('max-sales-debt-input'));

        const customDebtTermInput = document.getElementById('custom-debt-term-input');
if (customDebtTermInput) {
  if (!customDebtTermInput.value) customDebtTermInput.value = '30'; // m·∫∑c ƒë·ªãnh 30 l·∫ßn ƒë·∫ßu
  syncGlobalDebtTermToForm();                                      // ƒë·ªìng b·ªô xu·ªëng form ngay khi load
  // g√µ s·ªë ng√†y ·ªü dashboard -> ƒë·∫©y sang "H·∫°n tr·∫£ n·ª£" c·ªßa form th√™m
  customDebtTermInput.addEventListener('input', syncGlobalDebtTermToForm);
}



        const deliveryDatalist = document.getElementById('delivery-staff-list-options');
        if (deliveryDatalist) {
          deliveryDatalist.innerHTML = GIAO_HANG_NV_LIST
            .map(n => `<option value="${n}"></option>`)
            .join('');
        }
        
        initApp();
          // T·ª± vi·∫øt hoa ch·ªØ c√°i ƒë·∫ßu ti√™n khi ƒëang nh·∫≠p
  // Ch·ªâ vi·∫øt hoa khi blur (tho√°t √¥)
document.addEventListener('blur', (e) => {
  const el = e.target;
  if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
    const type = el.getAttribute('type');
    if (!type || type === 'text') {
      capitalizeFirstLetter(el);
    }
  }
}, true); // d√πng capture ƒë·ªÉ b·∫Øt c·∫£ blur bubbling


    });
    (function () {
  function getFocusable(container=document) {
    return Array.from(container.querySelectorAll(
      'input:not([type="hidden"]):not([disabled]), select:not([disabled]), textarea:not([disabled])'
    )).filter(el => el.offsetParent !== null);
  }

  function focusByDirection(fromEl, direction, container=document) {
    const focusables = getFocusable(container);
    const cur = fromEl.getBoundingClientRect();
    let best = null, bestScore = Infinity;

    focusables.forEach(el => {
      if (el === fromEl) return;
      const r = el.getBoundingClientRect();
      const dx = (r.left + r.right) / 2 - (cur.left + cur.right) / 2;
      const dy = (r.top + r.bottom) / 2 - (cur.top + cur.bottom) / 2;

      if (direction === 'right' && dx <= 4) return;
      if (direction === 'left'  && dx >= -4) return;
      if (direction === 'down'  && dy <= 4) return;
      if (direction === 'up'    && dy >= -4) return;

      const cross = (direction === 'left' || direction === 'right') ? Math.abs(dy) : Math.abs(dx);
      const dist = Math.hypot(dx, dy);
      const score = cross * 1000 + dist;

      if (score < bestScore) { bestScore = score; best = el; }
    });

    if (best) {
      best.focus({ preventScroll: true });
      if (best.select && (best.tagName === 'INPUT' || best.tagName === 'TEXTAREA')) {
        const len = best.value?.length ?? 0;
        best.setSelectionRange?.(len, len);
      }
    }
  }

  function focusNextPrev(fromEl, forward, container=document) {
    const list = getFocusable(container);
    const idx = list.indexOf(fromEl);
    const next = list[idx + (forward ? 1 : -1)];
    if (next) next.focus({ preventScroll: true });
  }

  document.addEventListener('keydown', (e) => {
  const active = document.activeElement;
  if (!active) return;

  // N·∫øu ƒëang trong textarea th√¨ ƒë·ªÉ Enter ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng (xu·ªëng d√≤ng)
  if (active.tagName === 'TEXTAREA') return;

  // Enter / Shift+Enter cho input, select
  if (e.key === 'Enter') {
    e.preventDefault();
    finalizeCurrency(active);
    focusNextPrev(active, !e.shiftKey);
    return;
  }

  // Arrow keys
  if (['ArrowRight','ArrowLeft','ArrowUp','ArrowDown'].includes(e.key)) {
    e.preventDefault();
    finalizeCurrency(active);
    if (e.key === 'ArrowRight') focusByDirection(active,'right');
    if (e.key === 'ArrowLeft')  focusByDirection(active,'left');
    if (e.key === 'ArrowUp')    focusByDirection(active,'up');
    if (e.key === 'ArrowDown')  focusByDirection(active,'down');
  }
}, true);


})();
// ƒë·∫£m b·∫£o b·∫•t k·ª≥ input decimal n√†o khi r·ªùi focus ƒë·ªÅu ƒë∆∞·ª£c format l·∫°i
document.addEventListener('focusout', (e) => {
  const t = e.target;
  if (t && t.getAttribute && t.getAttribute('inputmode') === 'decimal') {
    requestAnimationFrame(() => finalizeCurrency(t));
  }
}, true);



</script>
<style>
  /* ===== Compact dropdown panel for all input[list] ===== */
  #dl-panel{
    position: fixed;
    top: 0; left: 0;
    display: none;
    background: #0f172a;        /* n·ªÅn t·ªëi */
    color: #fff;
    border: 1px solid #334155;
    border-radius: 10px;
    padding: 4px 0;
    box-shadow: 0 16px 36px rgba(0,0,0,.35);
    z-index: 4000;
    font-size: 14px;

    /* ‚úÖ Ch·ªâ hi·ªÉn th·ªã t·ªëi ƒëa ~3‚Äì4 d√≤ng (80px) v√† c√≥ cu·ªôn */
    --opt-h: 20px;              /* chi·ªÅu cao m·ªói item (20px x 4 = 80px) */
    max-height: 80px;           /* y√™u c·∫ßu: 80px */
    overflow-y: auto;
  }
  #dl-panel .opt{
    height: var(--opt-h);
    line-height: var(--opt-h);
    padding: 0 10px;
    white-space: nowrap;
    cursor: pointer;
  }
  #dl-panel .opt:hover,
  #dl-panel .opt.active{ background:#1f2937; }

</style>

<script>
(function(){
  // ===== Mini datalist overlay (kh√¥ng ƒë·ª•ng login / logic kh√°c) =====
  const PANEL_ID = 'dl-panel';
  let panel, anchorInput = null, activeIndex = -1;

  function ensurePanel(){
    if (panel) return panel;
    panel = document.createElement('div');
    panel.id = PANEL_ID;
    document.body.appendChild(panel);
    return panel;
  }

  function getOptionsFromDatalist(input){
    const listId = input.getAttribute('list');
    if (!listId) return [];
    const dl = document.getElementById(listId);
    if (!dl) return [];
    return Array.from(dl.querySelectorAll('option'))
      .map(o => (o.getAttribute('value') ?? o.textContent ?? '').trim())
      .filter(Boolean);
  }

  function placePanelBelow(input){
    const r = input.getBoundingClientRect();
    const x = r.left + window.scrollX;
    const y = r.bottom + window.scrollY;
    const w = r.width;
    panel.style.minWidth = w + 'px';
    panel.style.left = x + 'px';
    panel.style.top  = y + 'px';
  }

  function renderPanel(items){
    const maxShow = 6; // ‚úÖ ch·ªâ hi·ªÉn th·ªã t·ªëi ƒëa 6 l·ª±a ch·ªçn
    const slice = items.slice(0, maxShow);
    panel.innerHTML = slice.map((t,i)=>`<div class="opt" data-idx="${i}">${escapeHtml(t)}</div>`).join('');
    activeIndex = slice.length ? 0 : -1;
    setActive(activeIndex);
  }

  function openPanelFor(input){
    const all = getOptionsFromDatalist(input);
    const q = (input.value || '').toLowerCase().trim();
    const filtered = q ? all.filter(v => v.toLowerCase().includes(q)) : all;

    // N·∫øu kh√¥ng c√≥ g√¨ ‚Üí ·∫©n
    if (!filtered.length){ hidePanel(); return; }

    ensurePanel();
    renderPanel(filtered);
    placePanelBelow(input);
    anchorInput = input;
    panel.style.display = 'block';
  }

  function hidePanel(){
    if (panel) panel.style.display = 'none';
    anchorInput = null;
    activeIndex = -1;
  }

  function setActive(idx){
    if (!panel) return;
    panel.querySelectorAll('.opt').forEach(el => el.classList.remove('active'));
    const el = panel.querySelector(`.opt[data-idx="${idx}"]`);
    if (el){
      el.classList.add('active');
      // ƒë·∫£m b·∫£o item active lu√¥n trong v√πng nh√¨n th·∫•y khi scroll
      el.scrollIntoView({ block:'nearest' });
    }
  }

  function commitActive(){
    if (!anchorInput || !panel) return;
    const el = panel.querySelector(`.opt[data-idx="${activeIndex}"]`);
    if (!el) return;
    anchorInput.value = el.textContent;
    anchorInput.dispatchEvent(new Event('input',{bubbles:true}));
    anchorInput.dispatchEvent(new Event('change',{bubbles:true}));
    hidePanel();
  }

  function escapeHtml(s){
    return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  // ===== G√°n s·ª± ki·ªán cho t·∫•t c·∫£ input[list] =====
  function bindDatalistInputs(){
    const inputs = Array.from(document.querySelectorAll('input[list]'));

    inputs.forEach(inp=>{
      // m·ªü panel khi focus ho·∫∑c g√µ
      inp.addEventListener('focus', ()=> openPanelFor(inp));
      inp.addEventListener('input', ()=> openPanelFor(inp));

      // ƒë√≥ng panel khi blur (tr·ªÖ 120ms cho ph√©p click ch·ªçn)
      inp.addEventListener('blur', ()=>{
        setTimeout(()=>{ if (document.activeElement !== panel) hidePanel(); }, 120);
      });

      // ƒëi·ªÅu h∆∞·ªõng b√†n ph√≠m
      inp.addEventListener('keydown', (e)=>{
        if (!panel || panel.style.display==='none') return;
        const opts = panel.querySelectorAll('.opt');
        if (!opts.length) return;

        if (e.key === 'ArrowDown'){
          e.preventDefault();
          activeIndex = (activeIndex + 1) % opts.length;
          setActive(activeIndex);
        } else if (e.key === 'ArrowUp'){
          e.preventDefault();
          activeIndex = (activeIndex - 1 + opts.length) % opts.length;
          setActive(activeIndex);
        } else if (e.key === 'Enter'){
          e.preventDefault();
          commitActive();
        } else if (e.key === 'Escape'){
          hidePanel();
        }
      });
    });
  }

  // click ch·ªçn item
  document.addEventListener('mousedown', (e)=>{
    if (!panel || panel.style.display==='none') return;
    const item = e.target.closest('#'+PANEL_ID+' .opt');
    if (item && anchorInput){
      activeIndex = parseInt(item.dataset.idx,10);
      commitActive();
    } else if (!e.target.closest('#'+PANEL_ID) && e.target !== anchorInput){
      hidePanel();
    }
  });

  // cu·ªôn / resize th√¨ reposition panel
  window.addEventListener('scroll', ()=>{ if (panel && panel.style.display==='block' && anchorInput) placePanelBelow(anchorInput); }, true);
  window.addEventListener('resize', ()=>{ if (panel && panel.style.display==='block' && anchorInput) placePanelBelow(anchorInput); });

  // Kh·ªüi t·∫°o sau khi trang ƒë√£ g·∫Øn s·ª± ki·ªán s·∫µn c√≥
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', bindDatalistInputs);
  } else {
    bindDatalistInputs();
  }
})();
</script>
<script>
/* Gi·ªõi h·∫°n datalist g·ªëc: ch·ªâ 6 k·∫øt qu·∫£ hi·ªÉn th·ªã.
   Ho·∫°t ƒë·ªông c·∫£ v·ªõi input[list] sinh ƒë·ªông sau n√†y. */
(function(){
  const TMP_SUFFIX = "__tmp6";
  function ensureTmpList(id){
    let tmp = document.getElementById(id + TMP_SUFFIX);
    if (!tmp){
      tmp = document.createElement('datalist');
      tmp.id = id + TMP_SUFFIX;
      document.body.appendChild(tmp);
    }
    return tmp;
  }
  function buildOptionsHTML(values){
    // ch·ªâ l·∫•y t·ªëi ƒëa 6 l·ª±a ch·ªçn
    return values.slice(0, 6).map(v => `<option value="${v}"></option>`).join('');
  }
  function getAllOptions(listId){
    const dl = document.getElementById(listId);
    if (!dl) return [];
    return Array.from(dl.querySelectorAll('option'))
      .map(o => (o.getAttribute('value') ?? o.textContent ?? '').trim())
      .filter(Boolean);
  }
  function filterVals(vals, q){
    if (!q) return vals;
    const s = q.toLowerCase();
    return vals.filter(v => v.toLowerCase().includes(s));
  }

  // L∆∞u datalist g·ªëc ƒë·ªÉ kh√¥i ph·ª•c sau khi blur
  document.addEventListener('focusin', (e)=>{
    const inp = e.target;
    if (!(inp instanceof HTMLInputElement)) return;
    const listId = inp.getAttribute('list');
    if (!listId) return;
    if (!inp.dataset._dl_original_list) inp.dataset._dl_original_list = listId;
  });

  // M·ªói l·∫ßn g√µ -> l·ªçc v√† chuy·ªÉn input sang datalist t·∫°m ch·ªâ c√≥ t·ªëi ƒëa 6 option
  document.addEventListener('input', (e)=>{
    const inp = e.target;
    if (!(inp instanceof HTMLInputElement)) return;
    const listId = inp.dataset._dl_original_list || inp.getAttribute('list');
    if (!listId) return;

    const all = getAllOptions(listId);
    if (!all.length) return;

    const filtered = filterVals(all, inp.value || '');
    const tmp = ensureTmpList(listId);
    tmp.innerHTML = buildOptionsHTML(filtered);

    // Tr·ªè input v√†o datalist t·∫°m (ch·ªâ 6 m·ª•c)
    inp.setAttribute('list', listId + TMP_SUFFIX);
  });

  // Khi blur -> tr·∫£ l·∫°i datalist g·ªëc
  document.addEventListener('focusout', (e)=>{
    const inp = e.target;
    if (!(inp instanceof HTMLInputElement)) return;
    const orig = inp.dataset._dl_original_list;
    if (orig) inp.setAttribute('list', orig);
  }, true);
})();
</script>

</body>
</html> 

<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Khách Hàng Nợ | Tổng kho Hà Hòa</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
      /* ================================
   HÀ HÒA – CLEAN DASHBOARD THEME
   - Nền xám nhẹ, card trắng
   - Header gradient nhẹ, không animate
   - Bảng rõ ràng, sticky header
   - Input pill, bóng nhẹ
   - KHÔNG lặp icon phễu
   ================================ */

/* Palette */
:root{
  --primary-color:#22c55e;
  --secondary-color:#f59e0b;
  --text-color:#0f172a;
  --muted:#64748b;
  --bg:#f3f4f6;
  --card:#ffffff;
  --border:#e5e7eb;
  --danger:#ef4444;
  --info:#0ea5e9;
}

/* Reset & base */
*{margin:0;padding:0;box-sizing:border-box;font-family:'Roboto',sans-serif;}
body{
  line-height:1.6;
  color:var(--text-color);
  background:var(--bg);              /* nền xám nhẹ */
  min-height:100vh;
}

/* Container (card trắng nổi) */
.container{
  max-width:1800px;margin:20px auto;padding:20px;border-radius:18px;
  background:var(--card);
  box-shadow:0 10px 28px rgba(2,6,23,.08);
  display:none;
}
.container.visible{display:block;}

/* ===== Header (gradient nhẹ, không animate) ===== */
/* ===== Header (gradient nhẹ, co giãn an toàn) ===== */
header{
  display:flex;
  align-items:center;
  justify-content:flex-start;   /* sắp xếp các item theo thứ tự + cho phép wrap */
  flex-wrap:wrap;               /* hẹp thì tự xuống dòng, không đè nhau */
  gap:16px;
  margin-bottom:20px;
  padding:18px;
  border-radius:16px;
  background:linear-gradient(135deg,#6366f1 0%,#22c55e 60%,#f59e0b 100%);
  color:#fff;
}

header img{
  height:88px;                  /* có thể chỉnh tùy giao diện */
  width:88px;
  border-radius:14px;
  object-fit:cover;
  border:2px solid rgba(255,255,255,.75);
  box-shadow:0 8px 20px rgba(0,0,0,.2);
  order:1;                      /* 1) logo */
}

.contact-info{
  font-size:14px;
  order:2;                      /* 2) địa chỉ + hotline */
  min-width:220px;              /* tránh bị bóp quá nhỏ */
}

.contact-info .address,
.contact-info .hotline{
  font-weight:700;
  font-size:16px;
}

/* KHÔNG absolute nữa, để trong luồng flex */
.header-title{
  order:3;                      /* 3) tiêu đề */
  flex:1;                       /* chiếm phần còn lại để căn giữa đẹp */
  text-align:center;
}
.header-title h1{font-size:24px;font-weight:800;margin:0;}
.header-title h2{font-size:18px;margin:0;opacity:.95;}

/* KHÔNG absolute nữa, đẩy về bên phải bằng margin-left:auto */
#user-info{
  order:4;                      /* 4) pill user ở cuối hàng */
  margin-left:auto;             /* tách sang phải */
  background:#fff;
  color:#111827;
  padding:6px 14px;
  border-radius:999px;
  font-size:14px;
  font-weight:600;
  box-shadow:0 6px 14px rgba(0,0,0,.12);
  white-space:nowrap;
}
#user-info #logout-btn{color:var(--danger);margin-left:8px}

/* Responsive: trên màn hẹp, cho tiêu đề chiếm trọn 1 dòng */
@media (max-width: 768px){
  header img{ height:72px; width:72px; }
  .header-title{
    flex-basis:100%;            /* tiêu đề xuống 1 dòng riêng */
    order:4;                    /* đặt tiêu đề dưới cùng cho đẹp trên mobile */
    margin-top:4px;
  }
  #user-info{ order:3; }        /* pill user nằm cùng hàng với logo/địa chỉ */
  .header-title h1{ font-size:20px; }
  .header-title h2{ font-size:16px; }
}

#user-info #logout-btn{color:var(--danger);margin-left:8px}

/* ===== Dashboard cards ===== */
.dashboard{
  display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px;margin-bottom:25px
}
.dashboard-card{
  border-radius:18px;padding:20px;background:#fff;
  box-shadow:0 8px 20px rgba(0,0,0,.06);transition:transform .15s ease, box-shadow .15s ease;
}
.dashboard-card:hover{transform:translateY(-2px);box-shadow:0 12px 26px rgba(0,0,0,.1)}
.dashboard-card h3{font-size:15px;color:#475569;margin-bottom:6px}
.dashboard-card p{font-size:22px;font-weight:800}
.dashboard-card:nth-child(1){border-top:4px solid #6366f1}
.dashboard-card:nth-child(2){border-top:4px solid #22c55e}
.dashboard-card:nth-child(3){border-top:4px solid #f59e0b}
.dashboard-card:nth-child(4){border-top:4px solid #ec4899}

/* Card kiểm soát hạn mức */
#max-debt-control-card{grid-column:1/-1;}
.debt-control-wrapper{display:flex;align-items:flex-end;gap:14px;flex-wrap:wrap;margin-top:10px}
.debt-control-group{flex:1;min-width:220px}
.debt-control-group label{
  font-size:11px;font-weight:800;letter-spacing:.2px;text-transform:uppercase;color:#334155;
  background:#f1f5f9;border:1px solid #e2e8f0;border-radius:999px;padding:4px 8px;display:inline-block;margin-bottom:6px
}
.debt-control-group input{
  width:100%;height:40px;border:1px solid var(--border);border-radius:12px;padding:8px 10px;background:#fff;
  transition:border-color .15s, box-shadow .15s
}
.debt-control-group input:focus{outline:none;border-color:#22c55e;box-shadow:0 0 0 4px rgba(34,197,94,.2)}

/* ===== Login ===== */
#login-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:1000;display:flex;align-items:center;justify-content:center}
#login-box{background:#fff;padding:40px;border-radius:18px;box-shadow:0 20px 40px rgba(0,0,0,.28);text-align:center;width:100%;max-width:350px}
#login-box h2{margin-bottom:25px;color:var(--primary-color)}
.input-group{margin-bottom:20px;text-align:left}
.input-group label{display:block;margin-bottom:6px;font-weight:700;color:#475569}
.input-group input{width:100%;padding:10px;border:1px solid var(--border);border-radius:12px;background:#fff}
#login-btn{width:100%;padding:12px;border:none;border-radius:12px;font-size:16px;font-weight:800;color:#fff;background:linear-gradient(90deg,#22c55e,#16a34a)}

/* ===== Toolbar ===== */
.action-btn{
  border:none;border-radius:12px;padding:10px 16px;font-size:14px;font-weight:700;color:#fff;
  display:inline-flex;align-items:center;gap:8px
}
.export-btn{background:linear-gradient(90deg,#6366f1,#22c55e)}
.update-btn{background:linear-gradient(90deg,#f59e0b,#f97316)}
.controls-wrapper .action-btn{height:38px;padding:0 14px}
.record-count{background:#eef2ff;color:#3730a3;font-weight:800;border-radius:999px;height:28px;display:inline-grid;place-items:center;padding:0 10px}

/* ===== Filters (pill) ===== */
.table-controls{
  background:#fff;border:1px solid rgba(2,6,23,.06);border-radius:14px;padding:14px;
  box-shadow:0 6px 16px rgba(2,6,23,.06);margin-bottom:12px
}
.filters-row{
  display:grid;gap:10px;grid-template-columns:120px repeat(auto-fit,minmax(180px,1fr));align-items:center
}
.filters-row .label{
  font-weight:800;color:#111827;display:flex;align-items:center;gap:8px
}
/* Quan trọng: KHÔNG tạo icon phễu bằng ::before nữa (để tránh trùng) */
/* .filters-row .label::before{ ... }  <-- ĐÃ GỠ */

/* Inputs */
/* Nhãn mini cho từng ô lọc */
.filters-row .field{ display:flex; flex-direction:column; gap:4px; }
.filters-row .field label{
  font-size:11px; font-weight:800; letter-spacing:.2px; text-transform:uppercase; color:#334155;
  background:#f1f5f9; border:1px solid #e2e8f0; border-radius:999px; padding:4px 8px; width:max-content;
}

.table-controls .filter-input{
  border:1px solid var(--border);background:#fff;height:38px;padding:8px 12px;border-radius:999px;
  box-shadow:0 1px 0 rgba(2,6,23,.04);transition:border-color .15s, box-shadow .15s
}
.table-controls .filter-input:focus{outline:none;border-color:#6366f1;box-shadow:0 0 0 4px rgba(99,102,241,.18)}

/* ===== Add panel ===== */
.add-panel{border:1px dashed var(--border);border-radius:12px;background:#fff;padding:10px}
.add-panel summary{font-size:15px;color:#0f172a;padding:6px 2px;cursor:pointer;display:flex;align-items:center;gap:6px}
.add-panel summary b{display:inline-flex;align-items:center;gap:6px}
.add-panel summary b::before{
  content:"+";display:inline-grid;place-items:center;width:20px;height:20px;border-radius:6px;background:#22c55e;color:#fff;font-weight:900;font-size:14px
}
.add-grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));margin-top:10px}
.add-grid .field label{
  font-size:12px;font-weight:900;letter-spacing:.2px;color:#334155;text-transform:uppercase;
  background:#f1f5f9;border:1px solid #e2e8f0;display:inline-block;padding:5px 8px;border-radius:999px;width:max-content;margin-bottom:4px
}
.add-grid .field input,
.add-grid .field select,
.add-grid .field textarea,
tbody td input, tbody td select, tbody td textarea{
  width:100%;border:1px solid var(--border);border-radius:12px;background:#fff;padding:10px 12px;font-size:14px;
  transition:border-color .15s,box-shadow .15s;background-clip:padding-box
}
.add-grid .field textarea, tbody td textarea{ 
  min-height:40px;            /* ✅ hạ xuống cho nhỏ lại */
  resize:vertical;
}

.add-grid .field input:focus,.add-grid .field select:focus,.add-grid .field textarea:focus,
tbody td input:focus,tbody td select:focus,tbody td textarea:focus{
  outline:none;border-color:#22c55e;box-shadow:0 0 0 4px rgba(34,197,94,.18)
}
::placeholder{color:#94a3b8}

/* ===== Bảng ===== */
.table-container{position:relative;overflow:auto;max-height:65vh;background:#fff;border-radius:12px;box-shadow:0 8px 20px rgba(2,6,23,.06)}
/* Cho phép bảng rộng hơn khung để kéo giãn thật sự */
table{
  border-collapse: collapse;
  width: max-content;     /* có thể nở rộng khi kéo */
  min-width: 100%;        /* vẫn không nhỏ hơn container */
  table-layout: fixed;    /* giữ nguyên độ rộng cột sau khi set */
}
thead th{ overflow: hidden; } /* tránh xuất hiện thanh cuộn trong TH */

/* Header sticky cho TẤT CẢ tiêu đề cột */
.table-container table thead th{
  position: sticky;
  top: 0;
  z-index: 60;                /* nổi trên ô dữ liệu */
  background: #4CAF50;        /* giữ nền khi dán */
  color:#fff;
  font-weight:800;
  letter-spacing:.2px;
  border-bottom:1px solid rgba(255,255,255,.28);
  padding:8px 10px;
  white-space:nowrap;
}
/* Sticky header chắc chắn đứng trên tbody và col-resizer */
.table-container { position: relative; }

.table-container table thead{
  position: sticky;
  top: 0;
  z-index: 150;          /* > tbody */
  background: #4CAF50;   /* phòng hở nền khi dán */
}

.table-container table thead th{
  position: sticky;
  top: 0;
  z-index: 160;          /* > .col-resizer (99) */
  background: #4CAF50;
}


.table-container table thead tr:first-child th + th{
  box-shadow: -1px 0 0 rgba(255,255,255,.45) inset;
}
.table-container table thead tr:first-child th:first-child{ width:56px; }
.table-container table thead tr:first-child th:not(:first-child){
  min-width:140px;
}



/* Tay nắm kéo cột */
.col-resizer{
  position:absolute; top:0; right:0; bottom:0;
  width:12px; cursor:col-resize; user-select:none; z-index:99;
}
.col-resizer::after{
  content:''; position:absolute; right:5px; top:20%; bottom:20%;
  width:2px; background:#e5e7eb;
}

body.resizing-col{ cursor:col-resize; user-select:none; }


th,td{border:0;border-bottom:1px solid #eef2f7}
tbody td{padding:8px 10px;vertical-align:middle}
tbody tr:nth-child(even){background:#f8fafc}
tbody tr:hover{background:#fffbe6}
tbody tr.row-new{background:#ecfdf5!important}
tbody tr.row-dirty{background:#fff7ed!important}
tbody tr.row-overdue:not(.debt-paid-off){background:#fee2e2!important}
tfoot{position:sticky;bottom:0;z-index:10}
tfoot td{background:#f0fdf4!important;color:#065f46;font-weight:800;padding:10px 12px!important;border-top:1px solid #e2e8f0}

/* Delete icon */
.delete-btn{cursor:pointer;color:var(--danger);font-weight:700;font-size:18px;line-height:1;opacity:.9}
.delete-btn:hover{transform:scale(1.06)}

/* Toast */
#toast-container{position:fixed;bottom:20px;right:20px;z-index:2000}
.toast{padding:12px 20px;border-radius:12px;color:#fff;font-weight:600;box-shadow:0 10px 20px rgba(0,0,0,.2);margin-top:8px}
.toast.success{background:#22c55e}
.toast.error{background:#ef4444}
.toast.warning{background:#f59e0b}

/* Footer */
footer{text-align:center;margin-top:30px;color:var(--muted);font-size:13px}

/* Responsive */
@media (max-width:900px){
  .add-grid{grid-template-columns:1fr}
  thead tr:first-child th:not(:first-child){min-width:200px}
}
.align-left  { text-align: left; }
.align-right { text-align: left; }
.align-center{ text-align: center; }
/* Compact filters */
.table-controls{ padding:10px }
.filters-row{
  gap:8px;
  grid-template-columns:120px repeat(auto-fit,minmax(140px,1fr));
  align-items:center;
}
.filters-row .label{ font-size:13px }
.table-controls .filter-input{
  height:32px;                 /* ↓ thấp hơn */
  font-size:13px;
  padding:6px 10px;
  border-radius:10px;          /* pill nhỏ hơn */
  min-width:0;                 /* tránh nở quá to */
}

/* Responsive: đẩy nhãn lên 1 dòng riêng khi hẹp */
@media (max-width: 1100px){
  .filters-row{
    grid-template-columns: repeat(3,minmax(0,1fr));
  }
  .filters-row .label{
    grid-column: 1 / -1;
    margin-bottom: 2px;
  }
}

/* Cho phép hàng lọc co lại theo cột, không phá bố cục */
.table-container{ overflow: auto }
/* Hàng tổng dưới cùng */
tfoot td:first-child{ width:56px }                  /* khớp cột Xóa */
tfoot td.total-label{
  white-space:nowrap;                               /* không xuống dòng */
  font-weight:800; color:#065f46;
  text-transform:uppercase; letter-spacing:.3px;
}
tfoot td{ vertical-align:middle }

/* Căn tiêu đề và cụm nút cùng 1 hàng */
.table-title{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  margin-bottom:10px;
}
.table-title h2{
  margin:0;
  font-size:22px;
  font-weight:800;
}

/* Cụm đếm bản ghi + nút nằm bên phải */
.table-title .controls-wrapper{
  margin-left:auto;              /* đẩy sang phải */
  display:flex;
  align-items:center;
  gap:8px;                       /* khoảng cách giữa pill & nút */
  white-space:nowrap;            /* tránh xuống dòng sớm */
}

/* Responsive: màn hình hẹp thì cho xuống dòng đẹp */
@media (max-width: 640px){
  .table-title{
    flex-direction:column;
    align-items:flex-start;
    gap:8px;
  }
  .table-title .controls-wrapper{
    margin-left:0;
    flex-wrap:wrap;
    white-space:normal;
  }
}

/* --- TÁCH KHỐI: Filters và Add-panel là 2 card riêng --- */
.table-controls{
  background: transparent;
  border: 0;
  box-shadow: none;
  padding: 0;                /* bỏ padding bọc ngoài để hết khoảng trắng */
}

/* Card cho khối Tìm kiếm */
.table-controls .filters-row{
  background: #fff;
  border: 1px solid rgba(2,6,23,.06);
  border-radius: 14px;
  box-shadow: 0 6px 16px rgba(2,6,23,.06);
  padding: 10px 12px;
  margin-bottom: 10px;       /* khoảng cách gọn giữa 2 khối */
  gap: 8px;                  /* giảm khoảng cách ô */
}

/* Card cho khối Thêm khoản nợ mới */
.table-controls .add-panel{
  background: #fff;
  border: 1px dashed var(--border);
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(2,6,23,.05);
  padding: 10px;             /* gọn hơn */
  margin-top: 0;             /* tránh cách xa filters */
}

/* Tối ưu khoảng trắng trong form thêm */
.table-controls .add-panel summary{ padding: 6px 2px; margin-bottom: 6px; }
.table-controls .add-grid{ gap: 10px; }             /* thu khoảng cách các field */
.table-controls .add-actions{ margin-top: 8px; }    /* gọn nút Thêm */
.table-controls .add-grid textarea{ min-height: 76px; } /* vừa mắt hơn */
/* Tách controls ra khỏi bảng, có khoảng cách gọn */
#controls-khn {
  margin-bottom: 12px;
}
.status-indicator {
  display: none !important;
}
/* Tiêu đề Tìm kiếm nằm riêng 1 dòng */
.filters-row .search-label {
  grid-column: 1 / -1;
  font-weight: 800;
  color: #111827;
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 6px;
  font-size: 14px;
}
.filters-grid {
  display: grid;
  gap: 10px;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
}
/* Card cho khối Tìm kiếm (gập/mở) */
.table-controls .filters-panel{
  background:#fff;
  border:1px solid rgba(2,6,23,.06);
  border-radius:14px;
  box-shadow:0 6px 16px rgba(2,6,23,.06);
  padding:8px 10px;
  margin-bottom:10px;
}

/* Header có icon kính lúp, bấm để gập/mở */
.filters-panel > summary.search-label{
  list-style:none;
  cursor:pointer;
  font-weight:800;
  color:#111827;
  display:flex;
  align-items:center;
  gap:6px;
  padding:6px 2px;
  margin-bottom:6px;
}
.filters-panel > summary.search-label::after{
  content:"▾";
  margin-left:auto;
  transition:transform .15s ease;
  opacity:.6;
}
.filters-panel[open] > summary.search-label::after{
  transform:rotate(180deg);
}

/* Lưới filter gọn, không tràn */
/* Mỗi field xếp label ở trên, input ở dưới */
.filters-grid .field{
  display: flex;
  flex-direction: column;
  gap: 4px;
  min-width: 0;
}

/* Giữ label gọn 1 dòng, không đẩy input lệch */
.filters-grid .field label{
  display: inline-flex;
  align-items: center;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  min-height: 24px;   /* có thể để 28px nếu thích cao hơn */
}

/* Ô nhập liệu full chiều ngang khối */
.filters-grid .field .filter-input{
  width: 100%;
}


/* Giữ label của từng ô lọc luôn 1 dòng, đồng nhất chiều cao */
.filters-grid .field label{
  white-space: nowrap;        /* không xuống dòng */
  overflow: hidden;           /* nếu dài thì ẩn phần dư */
  text-overflow: ellipsis;    /* hiện … nếu quá dài */
  min-height: 28px;           /* các chip cao bằng nhau */
  display: inline-flex;       /* căn giữa dọc cho text */
  align-items: center;        /* căn giữa dọc */
}
/* --- Nút + Thêm nằm bên phải tiêu đề "Thêm khoản nợ mới" --- */
.add-panel summary{
  display:inline-flex;   /* chỉ co theo nội dung */
  align-items:center;
  gap:12px;              /* khoảng cách giữa chữ và nút */
}
.add-panel .add-btn-inline{
  margin-left:0;         /* bỏ auto */
  height:28px;
  padding:0 10px;
  border-radius:8px;
  font-size:13px;
}

/* Ẩn khối actions cũ phía dưới (vì đã đưa nút lên summary) */
.add-panel .add-actions{
  display:none !important;
}
.add-panel .add-btn-inline i{ display:none !important; }
/* Ẩn nút Xóa lọc cũ ở dưới (nếu có render) */


/* màu nền đơn giản cho nút xóa lọc trên tiêu đề */
.clear-btn { background: linear-gradient(90deg, var(--info), #6366f1); }

/* Footer nút +Thêm ở cuối panel */
.add-panel .add-actions{
  display:flex !important;          /* bật lại nếu trước đó từng hidden */
  justify-content:flex-end;
  gap:8px;
  padding-top:10px;
  margin-top:8px;
  border-top:1px dashed var(--border);
}

/* Style nút dưới cùng – hơi cao, bo mềm */
.add-panel .add-actions .add-btn-bottom{
  height:36px;
  padding:0 14px;
  border-radius:10px;
  font-weight:800;
}

/* Mobile: cho nút full-width nhìn gọn */
@media (max-width: 768px){
  .add-panel .add-actions{ justify-content:stretch; }
  .add-panel .add-actions .add-btn-bottom{ width:100%; }
}

/* Luôn hiển thị 4 cột cho dashboard */
.dashboard {
  display: grid;
  grid-template-columns: repeat(4, 1fr); /* 4 cột bằng nhau */
  gap: 16px;
  margin-bottom: 20px;
}

/* Style nút +Thêm cạnh Ghi chú */
.add-panel .add-btn-bottom {
  margin-top: 6px;
  background: linear-gradient(90deg, #22c55e, #16a34a);
  color: #fff;
  font-weight: 700;
  font-size: 13px;
  padding: 6px 12px;
  border-radius: 8px;
  cursor: pointer;
  border: none;
}
.add-panel .add-btn-bottom:hover {
  opacity: 0.9;
}

/* Đặt nút +Thêm bên phải ô Ghi chú */
.note-field .note-input-wrap{
  display: flex;
  gap: 10px;
  align-items: flex-start;    /* nút căn theo đỉnh textarea */
}
.note-field textarea{
  flex: 1;
  resize: vertical;           /* cho phép kéo nhỏ/lớn */
  min-height: 40px;           /* ✅ để tối thiểu 40px (hoặc bỏ hẳn nếu muốn thu nhỏ tự do) */
}


/* Nút +Thêm bên phải */
.add-btn-right{
  white-space: nowrap;
  border: none;
  border-radius: 8px;
  padding: 10px 14px;
  font-weight: 800;
  cursor: pointer;
  background: linear-gradient(90deg,#22c55e,#16a34a);
  color: #fff;
  display: inline-flex;
  align-items: center;
  height: 40px;
}
.add-btn-right:hover{ opacity: .95; }

/* Vô hiệu style nút cũ dạng "dưới" nếu còn */
.add-btn-bottom{ display: none !important; }

/* Override cuối CSS */
.header-title h1 {
  font-size: 36px;
  font-weight: 900;
  line-height: 1.3;
}

@media (max-width: 768px) {
  .header-title h1 {
    font-size: 24px;  /* nhỏ lại trên mobile */
  }
}

#current-customer-debt-display {
  display: none !important;
}

</style>

</head>


<body>
    <div id="login-overlay">
        <div id="login-box">
            <h2>Đăng Nhập Hệ Thống</h2>
            <form id="login-form">
                <div class="input-group"> <label for="username">Tên đăng nhập</label> <input type="text" id="username" required> </div>
                <div class="input-group"> <label for="password">Mật khẩu</label> <input type="password" id="password" required> </div>
                <button type="submit" id="login-btn">Đăng Nhập</button>
                <p id="login-error"></p>
            </form>
        </div>
    </div>

    <div class="container">
       <header>
            <div id="user-info"></div>
            <img alt="Logo" src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Ff6c823b5.%E1%BA%A2nh.094646.jpg" />
            <div class="contact-info">
                <div class="address">Địa chỉ : Số 46 - Thanh Lũng - Quảng oai - TP Hà Nội</div>
                <div class="hotline">Hotline : 0969.250.323</div>
            </div>
            <div class="header-title">
                <h1>Nhà Phân Phối Hà Hoà</h1>
                <h2>Bảng Khách Hàng Nợ</h2>
            </div>
        </header>

        <div class="dashboard">
            <div class="dashboard-card"> <h3>Tổng Tiền Nợ</h3> <p id="dashboard-total-no">0</p> </div>
            <div class="dashboard-card"> <h3>Tổng Tiền Đã Trả</h3> <p id="dashboard-total-tra">0</p> </div>
            <div class="dashboard-card"> <h3>Giá Trị Hàng Thu Hồi</h3> <p id="dashboard-total-thuhoi">0</p> </div>
            <div class="dashboard-card summary"> <h3>Tổng Công Nợ Cuối Cùng</h3> <p id="dashboard-total-conlai">0</p> </div>
            
            <div class="dashboard-card" id="max-debt-control-card">
                <h3>Kiểm Soát Hạn Mức Nợ</h3>
                <div class="debt-control-wrapper">
                    <div class="debt-control-group">
                        <label for="max-debt-input">Hạn Mức Nợ Tối Đa Của Từng Khách Hàng(VNĐ)</label>
                        <input type="text" id="max-debt-input" inputmode="decimal" placeholder="Nhập hạn mức...">
                    </div>
                    <div class="debt-control-group">
                        <label for="custom-debt-term-input">Số Ngày Nợ Tối Đa Của Từng Khách Hàng</label>
                        <input type="number" id="custom-debt-term-input" placeholder="Nhập số ngày..." value="30">

                    </div>

                    <!-- NVKD limit in dashboard -->
                    <div class="debt-control-group">
                      <label for="max-sales-debt-input">Hạn Mức Nợ Tối Đa Của Từng NV Kinh Doanh (VNĐ)</label>
                      <input type="text" id="max-sales-debt-input" inputmode="decimal" placeholder="Nhập hạn mức...">
                    </div>

                    <div id="current-sales-debt-display" class="debt-control-group" style="display: none;">
                      <p class="debt-label">Nợ hiện tại của NVKD:</p>
                      <p id="current-sales-debt-value">0 VNĐ</p>
                    </div>

                    <div id="current-customer-debt-display" class="debt-control-group">
                        <p class="debt-label">Nợ hiện tại của KH:</p>
                        <p id="current-customer-debt-value">0 VNĐ</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="main-content-khn">
            <div class="table-title">
                <h2>Bảng Khách Hàng Nợ</h2>
                <div class="controls-wrapper">
                    <span id="count-khn" class="record-count">...</span>
                     <!-- Nút Xóa lọc mới đặt trên tiêu đề -->
    <button id="btn-clear-khn" class="action-btn clear-btn">
      <i class="fa fa-filter-circle-xmark"></i> Xóa lọc
    </button>
                    <button id="update-btn-khn" class="update-btn action-btn" disabled><i class="fas fa-save"></i> Lưu Thay Đổi</button>
                    <button class="export-btn action-btn" data-table-key="khn"><i class="fas fa-file-excel"></i> Tải Excel</button>
                </div>
            </div>
            <!-- Controls tách riêng, KHÔNG cuộn -->
<div id="controls-khn"></div>

<!-- Chỉ bảng nằm trong khung cuộn -->
<div class="table-container">
  <div id="container-khn">
    <p class="status-indicator">Đang tải dữ liệu...</p>
  </div>
</div>

        </div>

        <footer>
            <p>&copy; 2023 - Hệ thống quản lý Tổng kho Hà Hòa</p>
        </footer>
    </div>

    <div id="toast-container"></div>
    <datalist id="customer-list-options"></datalist>
    <datalist id="sales-person-list-options"></datalist>
    <datalist id="delivery-staff-list-options"></datalist>
    <datalist id="region-list-options"></datalist>
<datalist id="phone-list-options"></datalist>


   <script>
    const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbwZ73GdTFsSitoVqJKiZKIbU3wHM_qpjxQEbhlKTwi1V9GijNC8SPoRH9vVDD65xb9x/exec';
    const TABLE_CONFIG = {
        'khn': { name: 'Khách Hàng Nợ', containerId: 'container-khn', countId: 'count-khn', loaded: false, totalField: 'Số tiền nợ' },
        'khtn': { name: 'Khách hàng trả nợ', loaded: false, totalField: 'Số tiền trả nợ' },
        'hth': { name: 'Hàng thu hồi', loaded: false, totalField: 'Thành tiền' },
    };
    const headerMapping = { 'Giao hàng cho nợ': 'NV Giao hàng',  'NV cho nợ': 'NV Giao hàng', 'Người chịu trách nhiệm': 'NV Kinh doanh', 'Số tiền nợ': 'Tiền Nợ', 'Hạn trả nợ': 'Hạn Nợ', 'Ngày phải trả': 'Ngày đến hạn' };
    const HIDDEN_COLUMNS = ['id', 'id nợ'];
    const GIAO_HANG_NV_LIST = ['Hoa', 'Phong', 'minh', 'duy', 'Tuấn Lái xe', 'Hà (Nam)', 'Xuyến', 'Hoà', 'Hạnh', 'Hà (Nữ)'];
    const NV_GIAO_HANG_HEADERS = ['Giao hàng cho nợ']; // bỏ 'NV cho nợ'
    // Chỉ các cột trong danh sách này mới có ô lọc
const FILTERABLE_HEADERS = [
  'Tên Khách Hàng',
  'Khu vực',
  'Người chịu trách nhiệm',
  'SĐT',
  'Ngày nợ',
  'Ngày phải trả',
  'Giao hàng cho nợ',  // biến thể 1
  'NV cho nợ'          // biến thể 2
];


    const NUMERIC_COLUMNS_FOR_TOTAL = ['Số tiền nợ', 'Thành tiền', 'Số tiền trả nợ', 'Đơn giá', 'Số lượng', 'Hạn trả nợ', 'Số ngày'];
    const COLUMN_CONFIG = {
        'Người chịu trách nhiệm': { align: 'left', className: 'col-sales-staff' }, 'Địa chỉ': { align: 'left' }, 'Ghi chú': { align: 'left' }, 'Tên Khách Hàng': { align: 'left' }, 'Sản phẩm/Mặt hàng': { align: 'left' }, 'Tên sản phẩm': { align: 'left' }, 'SĐT': { align: 'left' }, 'Số tiền nợ': { align: 'right' }, 'Đơn giá': { align: 'right' }, 'Thành tiền': { align: 'right' }, 'Số tiền trả nợ': { align: 'right' }, 'Hạn trả nợ': { align: 'right' }, 'Số ngày': { align: 'right' }, 'Số lượng': { align: 'right' }, 'Ngày nợ': { align: 'center' }, 'Ngày trả': { align: 'center' }, 'Ngày thu hồi': { align: 'center' }, 'Ngày phải trả': { align: 'center' },
    };

    // === PHÂN QUYỀN (ADD) ===
    function normalizeVi(s='') {
      return s.normalize('NFD')
              .replace(/[\u0300-\u036f]/g, '')
              .replace(/đ/g,'d').replace(/Đ/g,'D')
              .toLowerCase().trim();
    }
    const ALLOWED_CREATORS_RAW = ['Hoa', 'Hanh', 'Xuyen']; // whitelist gốc
const ALLOWED_CREATORS = ALLOWED_CREATORS_RAW.map(normalizeVi); // so sánh không dấu, lowercase

// Danh sách tài khoản được full quyền chỉnh sửa
const FULL_EDIT_ACCOUNTS = ['hoa1975', 'xuyen', 'hanh'];

let currentPerms = { canCreate: false, canEditExisting: false, canDelete: false, isViewer: true, canEditDebtTerm: false };

function computePerms(displayName, username) {
  const nameNorm = normalizeVi(displayName || '');
  const userNorm = normalizeVi(username || '');

  // Admin: full quyền
  if (userNorm === 'admin') {
    return { canCreate: true, canEditExisting: true, canDelete: true, isViewer: false, canEditDebtTerm: true };
  }

  // 3 tài khoản đặc biệt: full quyền nhưng không được sửa "Số ngày nợ tối đa"
  if (FULL_EDIT_ACCOUNTS.includes(userNorm)) {
    return { canCreate: true, canEditExisting: true, canDelete: true, isViewer: false, canEditDebtTerm: false };
  }

  // Người thường theo whitelist cũ (chỉ tạo mới)
  const canCreate = ALLOWED_CREATORS.includes(nameNorm);
  return { canCreate, canEditExisting: false, canDelete: false, isViewer: !canCreate, canEditDebtTerm: false };
}


    // Áp quyền vào UI mỗi bảng
    function applyPermissions(tableKey) {
      const perms = currentPerms;
      const cfg = TABLE_CONFIG[tableKey];
      if (!cfg || !cfg.containerId) return;

      // Nút Lưu
      const saveBtn = document.getElementById(`update-btn-${tableKey}`);
      if (saveBtn) {
        // viewer không cần hiện nút
        saveBtn.style.display = perms.isViewer ? 'none' : 'inline-flex';
        saveBtn.disabled = perms.isViewer;
      }
      // Kiểm soát ô "Số ngày nợ tối đa" 
const debtTermInput = document.getElementById('custom-debt-term-input');
if (debtTermInput) {
  if (perms.canEditDebtTerm) {
    debtTermInput.removeAttribute('readonly');
    debtTermInput.removeAttribute('disabled');
  } else {
    debtTermInput.setAttribute('readonly', 'readonly');
    debtTermInput.style.backgroundColor = '#f3f4f6'; // màu xám nhạt để biết không sửa được
  }
}

      const container = document.getElementById(cfg.containerId);
      if (!container) return;

      // Ẩn/hiện form thêm ngoài bảng
      // Ẩn/hiện nút Thêm ở controls host (ngoài bảng)
let addBtn =
  document.getElementById(`btn-add-${tableKey}`) ||
  document.querySelector(`#controls-${tableKey} #btn-add-${tableKey}`) ||
  container.querySelector(`#btn-add-${tableKey}`);
if (addBtn) addBtn.style.display = perms.canCreate ? '' : 'none';


      // Khóa edit các dòng dữ liệu cũ (không cho sửa)
       // Khóa/mở khóa theo quyền
 // Khóa/mở khóa theo quyền
container.querySelectorAll('tbody tr[data-id]').forEach(tr => {
  tr.classList.remove('row-dirty');
  tr.querySelectorAll('input, select, textarea').forEach(el => {
    if (perms.canEditExisting) {
      el.removeAttribute('readonly');
      el.removeAttribute('disabled');
      // Với 3 tài khoản đặc biệt: không cho sửa "Hạn trả nợ"
      if (!perms.canEditDebtTerm && el.dataset.field === 'Hạn trả nợ') {
        if (el.tagName === 'SELECT') el.setAttribute('disabled', 'disabled');
        else el.setAttribute('readonly', 'readonly');
        el.style.backgroundColor = '#f3f4f6';
      }
    } else {
      if (el.tagName === 'SELECT') el.setAttribute('disabled', 'disabled');
      else el.setAttribute('readonly', 'readonly');
    }
  });
});

 // Hiện/ẩn nút xóa theo quyền
 container.querySelectorAll('.delete-btn').forEach(btn => {
  btn.style.display = perms.canDelete ? '' : 'none';
});


      
    }

    let originalTableData = {};
    let changeSet = { create: {}, update: {}, delete: {} };
    let nhanSuList = [];
    let customerList = [];
    // Bộ lọc tạm dùng cho form thêm (không ảnh hưởng ô lọc UI)
const TEMP_FILTERS = { khn: {} };


    function calculateCustomerTotalDebt(customerName) {
        if (!customerName) return 0;
        let totalDebt = 0, totalPaid = 0, totalReturned = 0;

        const getConsolidatedData = (tableKey) => {
            const originalData = originalTableData[tableKey]?.data || [];
            const createdData = Object.values(changeSet.create[tableKey] || {});
            const updatedData = changeSet.update[tableKey] || {};
            const deletedIds = new Set(changeSet.delete[tableKey] || []);
            let consolidated = [];
            originalData.forEach(row => {
                if (!deletedIds.has(row.id)) {
                    consolidated.push({ ...row, ...(updatedData[row.id] || {}) });
                }
            });
            consolidated.push(...createdData);
            return consolidated;
        };

        const allDebts = getConsolidatedData('khn');
        const customerDebtIds = new Set();
        
        allDebts.forEach(row => {
            if (row['Tên Khách Hàng'] === customerName) {
                totalDebt += parseFloat(String(row['Số tiền nợ'] || '0').replace(/\./g, '')) || 0;
                customerDebtIds.add(row.id);
            }
        });

        getConsolidatedData('khtn').forEach(row => {
            if (customerDebtIds.has(row['id nợ'])) {
                totalPaid += parseFloat(String(row['Số tiền trả nợ'] || '0').replace(/\./g, '')) || 0;
            }
        });

        getConsolidatedData('hth').forEach(row => {
            if (row['Tên Khách Hàng'] === customerName) {
                totalReturned += parseFloat(String(row['Thành tiền'] || '0').replace(/\./g, '')) || 0;
            }
        });
        
        return totalDebt - totalPaid - totalReturned;
    }

    function calculateSalespersonTotalDebt(salesName) {
        if (!salesName) return 0;

        const getConsolidatedData = (tableKey) => {
            const originalData = originalTableData[tableKey]?.data || [];
            const createdData = Object.values(changeSet.create[tableKey] || {});
            const updatedData = changeSet.update[tableKey] || {};
            const deletedIds = new Set(changeSet.delete[tableKey] || []);
            const consolidated = [];
            originalData.forEach(row => {
                if (!deletedIds.has(row.id)) {
                    consolidated.push({ ...row, ...(updatedData[row.id] || {}) });
                }
            });
            consolidated.push(...createdData);
            return consolidated;
        };

        const khn = getConsolidatedData('khn');   // bảng nợ
        const khtn = getConsolidatedData('khtn'); // bảng trả nợ

        // cộng trả nợ theo id nợ
        const paidByDebtId = {};
        khtn.forEach(p => {
            const idNo = p['id nợ'];
            const val = parseFloat(String(p['Số tiền trả nợ'] || '0').replace(/\./g, '')) || 0;
            paidByDebtId[idNo] = (paidByDebtId[idNo] || 0) + val;
        });

        // tổng nợ còn lại theo 'Người chịu trách nhiệm'
        let total = 0;
        khn.forEach(row => {
            if (row['Người chịu trách nhiệm'] === salesName) {
                const debtId = row.id;
                const totalDebt = parseFloat(String(row['Số tiền nợ'] || '0').replace(/\./g, '')) || 0;
                const paid = paidByDebtId[debtId] || 0;
                const remain = Math.max(0, totalDebt - paid);
                total += remain;
            }
        });
        return total;
    }

   function updateVisibleRowCount(tableKey) {
  const cfg = TABLE_CONFIG[tableKey];
  const container = document.getElementById(cfg.containerId);
  if (!container || !cfg.countId) return;

  const visibleRows = Array.from(
    container.querySelectorAll('tbody tr[data-id]')
  ).filter(tr => tr.style.display !== 'none' && !tr.classList.contains('debt-paid-off'));

  document.getElementById(cfg.countId).textContent = `${visibleRows.length} bản ghi`;
}

    
    function processAndMarkPaidDebts() {
        const khnData = originalTableData['khn']?.data;
        const khtnData = originalTableData['khtn']?.data;
        if (!khnData) return;
        const paidAmounts = {};
        (khtnData || []).forEach(p => { paidAmounts[p['id nợ']] = (paidAmounts[p['id nợ']] || 0) + (parseFloat(String(p['Số tiền trả nợ'] || '0').replace(/\./g, '')) || 0); });
        
        const khnTable = document.querySelector('#container-khn table');
        if (!khnTable) return;
        khnData.forEach(debt => {
            const totalDebt = parseFloat(String(debt['Số tiền nợ'] || '0').replace(/\./g, '')) || 0;
            const totalPaid = paidAmounts[debt.id] || 0;
            const row = khnTable.querySelector(`tr[data-id="${debt.id}"]`);
            if (row) {
                if (totalPaid >= totalDebt && totalDebt > 0) {
                    row.classList.add('debt-paid-off');
                } else {
                    row.classList.remove('debt-paid-off');
                }
            }
        });
    }

    function highlightOverdueRows() {
        const table = document.querySelector('#container-khn table');
        if (!table) return;
        const rows = table.querySelectorAll('tbody tr[data-id]');
        const today = new Date();
        today.setHours(0, 0, 0, 0); 

        rows.forEach(row => {
            if (row.classList.contains('debt-paid-off')) {
                row.classList.remove('row-overdue');
                return;
            }
            const dueDateInput = row.querySelector('[data-field="Ngày phải trả"]');
            if (dueDateInput && dueDateInput.value) {
                const dueDate = new Date(dueDateInput.value);
                if (dueDate < today) {
                    row.classList.add('row-overdue');
                } else {
                    row.classList.remove('row-overdue');
                }
            }
        });
    }

    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => { toast.remove(); }, 5000);
    }
    
    function createCellInput(originalHeader, value) {
        const formattedValue = value ?? '';
        let inputHtml = '';
        const textareaColumns = ['Ghi chú', 'Sản phẩm/Mặt hàng'];
        const config = COLUMN_CONFIG[originalHeader] || { align: 'left', className: '' };
        const cellClasses = `align-${config.align} ${config.className || ''}`.trim();
        if (originalHeader === 'Tên Khách Hàng') {
            inputHtml = `<input type="text" list="customer-list-options" data-field="${originalHeader}" value="${formattedValue}">`;
        } else if (textareaColumns.includes(originalHeader)) {
            inputHtml = `<textarea data-field="${originalHeader}">${formattedValue}</textarea>`;
        } else if (originalHeader === 'Giao hàng cho nợ') {
            const options = GIAO_HANG_NV_LIST.map(name => `<option value="${name}" ${name === formattedValue ? 'selected' : ''}>${name}</option>`).join('');
            inputHtml = `<select data-field="${originalHeader}"><option value="">-- Chọn --</option>${options}</select>`;
        } else if (originalHeader === 'NV cho nợ') {
            inputHtml = `<input type="text" list="delivery-staff-list-options" data-field="${originalHeader}" value="${formattedValue}" placeholder="Nhập tên NV giao hàng...">`;
        } else if (originalHeader === 'Người chịu trách nhiệm') {
            inputHtml = `<input type="text" list="sales-person-list-options" data-field="${originalHeader}" value="${formattedValue}">`;
        } else {
            switch (originalHeader) {
                case 'SĐT':
                    inputHtml = `<input type="tel" data-field="${originalHeader}" value="${formattedValue}" placeholder="Số điện thoại...">`;
                    break;
                case 'Ngày nợ':
                    inputHtml = `<input type="date" data-field="${originalHeader}" value="${formatDateForInput(formattedValue)}">`; break;
                case 'Ngày phải trả':
                    inputHtml = `<input type="date" data-field="${originalHeader}" value="${formatDateForInput(formattedValue)}" readonly>`; break;
                case 'Số tiền nợ': case 'Đơn giá': case 'Số lượng': {
    const cleanValue = String(formattedValue ?? '').replace(/[^\d]/g,'');
    const numericValue = cleanValue ? formatThousands(cleanValue) : '';
    inputHtml = `<input type="text" inputmode="decimal" data-field="${originalHeader}" value="${numericValue}">`;
    break;
}

                case 'Hạn trả nợ': {
  const currentValue = (formattedValue ?? '') || getGlobalDebtTerm(); // fallback theo dashboard
  inputHtml = `<input type="number" data-field="Hạn trả nợ" min="0" step="1" value="${currentValue}">`;
  break;
}

                default:
                    inputHtml = `<input type="text" data-field="${originalHeader}" value="${formattedValue}">`; break;
            }
        }
        return `<td class="${cellClasses}">${inputHtml}</td>`;
    }

    /* ==== MỚI: Toolbox bên ngoài (bộ lọc + form thêm) ==== */
    function createExternalControls(tableKey, headers, displayedHeaders) {
      const cfg = TABLE_CONFIG[tableKey];
      if (!cfg?.containerId) return;
      const controlsHost = document.getElementById(`controls-${tableKey}`);
if (!controlsHost) return;
 // ✅ Thêm dòng này để có container của bảng
  const container = document.getElementById(cfg.containerId);
// Nếu đã tạo rồi thì giữ nguyên
if (controlsHost.querySelector('.table-controls')) return;

const controls = document.createElement('div');
controls.className = 'table-controls';


      // ====== Bộ lọc (external) ======
    // ====== Bộ lọc (external) ======
const filters = document.createElement('details');
filters.className = 'filters-panel';
filters.open = true;
filters.innerHTML = `
  <summary class="search-label">
  <i class="fa fa-search"></i> Tìm kiếm
  <label style="margin-left:12px;display:inline-flex;align-items:center;gap:6px;font-size:13px;">
    <input type="checkbox" class="filter-checkbox" data-role="overdue-sales"> NVKD cho nợ quá hạn
  </label>
  <label style="margin-left:12px;display:inline-flex;align-items:center;gap:6px;font-size:13px;">
    <input type="checkbox" class="filter-checkbox" data-role="all" checked> Tất cả
  </label>
</summary>

  <div class="filters-grid">
    ${
      displayedHeaders
        .filter(h => FILTERABLE_HEADERS.includes(h))
        .map(h => {
          const ph = headerMapping[h] || h;

          // 1) 2 ô ngày
          if (h === 'Ngày nợ') {
            return `
              <div class="field">
                <label>Ngày nợ</label>
                <input class="filter-input" type="date" data-header="Ngày nợ" data-role="date-start">
              </div>`;
          }
          if (h === 'Ngày phải trả') {
            return `
              <div class="field">
                <label>Ngày đến hạn</label>
                <input class="filter-input" type="date" data-header="Ngày phải trả" data-role="date-end">
              </div>`;
          }

          // 2) Các ô cần autocomplete
          if (h === 'Tên Khách Hàng') {
            return `
              <div class="field">
                <label>${ph}</label>
                <input class="filter-input" data-header="${h}" list="customer-list-options" placeholder="${ph}...">
              </div>`;
          }
          if (h === 'Khu vực') {
            return `
              <div class="field">
                <label>${ph}</label>
                <input class="filter-input" data-header="${h}" list="region-list-options" placeholder="${ph}...">
              </div>`;
          }
          if (h === 'SĐT') {
            return `
              <div class="field">
                <label>${ph}</label>
                <input class="filter-input" type="tel" data-header="${h}" list="phone-list-options" placeholder="Số điện thoại...">
              </div>`;
          }
          if (h === 'Giao hàng cho nợ' || h === 'NV cho nợ') {
            return `
              <div class="field">
                <label>${ph}</label>
                <input class="filter-input" data-header="${h}" list="delivery-staff-list-options" placeholder="${ph}...">
              </div>`;
          }
          if (h === 'Người chịu trách nhiệm') {
            return `
              <div class="field">
                <label>${ph}</label>
                <input class="filter-input" data-header="${h}" list="sales-person-list-options" placeholder="${ph}...">
              </div>`;
          }

          // 3) Mặc định
          return `
            <div class="field">
              <label>${ph}</label>
              <input class="filter-input" data-header="${h}" placeholder="${ph}...">
            </div>`;
        })
        .join('')
    }
  </div>
`;







      // ====== Form thêm mới (external) ======
      const addPanel = document.createElement('div');
      addPanel.className = 'add-panel';
      addPanel.innerHTML = `
  <details open>
    <summary>
      <b>➕ Thêm khoản nợ mới</b>
    </summary>

    <div class="add-grid" id="add-form-${tableKey}">
      ${headers.map(h => {
        if (HIDDEN_COLUMNS.includes(h)) return `<input type="hidden" data-field="${h}">`;
        const disp = headerMapping[h] || h;

        // Ghi chú: có nút +Thêm đặt bên phải
if (h === 'Ghi chú') {
  return `<div class="field note-field">
            <label>${disp}</label>
            <div class="note-input-wrap">
              <textarea data-field="${h}" placeholder="${disp}..."></textarea>
              <button type="button" id="btn-add-${tableKey}"
                      class="action-btn update-btn add-btn-right">
                + Thêm
              </button>
            </div>
          </div>`;
}

// Sản phẩm/Mặt hàng: chỉ textarea (không có nút)
if (h === 'Sản phẩm/Mặt hàng') {
  return `<div class="field"><label>${disp}</label>
            <textarea data-field="${h}" placeholder="${disp}..."></textarea>
          </div>`;
}


        if (h === 'Địa chỉ') {
          return `<div class="field"><label>${disp}</label>
                    <input type="text" data-field="${h}" placeholder="${disp}..." autocomplete="street-address">
                  </div>`;
        }
        if (h === 'Tên Khách Hàng') {
          return `<div class="field"><label>${disp}</label>
                    <input type="text" list="customer-list-options" data-field="${h}" placeholder="Nhập tên Khách Hàng...">
                  </div>`;
        }
        if (NV_GIAO_HANG_HEADERS.includes(h)) {
          const o = GIAO_HANG_NV_LIST.map(n => `<option value="${n}">${n}</option>`).join('');
          return `<div class="field"><label>${disp}</label>
                    <select data-field="${h}"><option value="">-- Chọn --</option>${o}</select>
                  </div>`;
        }
        if (h === 'NV cho nợ') {
          return `<div class="field"><label>${disp}</label>
                    <input type="text" list="delivery-staff-list-options" data-field="${h}" placeholder="Nhập tên NV giao hàng...">
                  </div>`;
        }
        if (h === 'Người chịu trách nhiệm') {
          return `<div class="field"><label>${disp}</label>
                    <input type="text" list="sales-person-list-options" data-field="${h}" placeholder="${disp}...">
                  </div>`;
        }

        switch (h) {
          case 'SĐT':
            return `<div class="field"><label>${disp}</label>
                      <input type="tel" data-field="${h}" placeholder="Số điện thoại...">
                    </div>`;
          case 'Ngày nợ':
            return `<div class="field"><label>${disp}</label>
                      <input type="date" data-field="${h}" value="${new Date().toISOString().slice(0,10)}">
                    </div>`;
          case 'Hạn trả nợ':
            return `<div class="field"><label>${disp}</label>
                      <input type="number" data-field="Hạn trả nợ" placeholder="Ngày" value="30">
                    </div>`;
          case 'Ngày phải trả':
            return `<div class="field"><label>${disp}</label>
                      <input type="date" data-field="${h}" readonly>
                    </div>`;
          case 'Số tiền nợ':
          case 'Số lượng':
          case 'Đơn giá':
            return `<div class="field"><label>${disp}</label>
                      <input type="text" inputmode="decimal" data-field="${h}" placeholder="0">
                    </div>`;
          default:
            return `<div class="field"><label>${disp}</label>
                      <input type="text" data-field="${h}" placeholder="${disp}...">
                    </div>`;
        }
      }).join('')}
    </div>
  </details>
`;



      controls.appendChild(filters);
      controls.appendChild(addPanel);

      // Chèn controls lên đầu container
      controlsHost.appendChild(controls);
      syncGlobalDebtTermToForm();    // form vừa render xong -> kéo giá trị số ngày từ dashboard vào


      // Gắn sự kiện tìm kiếm
      controls.querySelectorAll('.filter-input').forEach(inp => {
        inp.addEventListener('input', () => filterTable(tableKey));
      });
      // Checkbox lọc quá hạn / tất cả
controls.querySelectorAll('.filter-checkbox').forEach(chk => {
  chk.addEventListener('change', () => {
    // Nếu tick “Tất cả” thì bỏ tick “NVKD cho nợ quá hạn”
    const host = document.getElementById(`controls-${tableKey}`);
    const allChk = host?.querySelector('.filter-checkbox[data-role="all"]');
    const overdueChk = host?.querySelector('.filter-checkbox[data-role="overdue-sales"]');
    if (chk.dataset.role === 'all' && allChk?.checked && overdueChk) overdueChk.checked = false;

    // Nếu tick “NVKD cho nợ quá hạn” thì bỏ tick “Tất cả”
    if (chk.dataset.role === 'overdue-sales' && overdueChk?.checked && allChk) allChk.checked = false;

    filterTable(tableKey);
  });
});


      // Tự động tính Ngày phải trả trong form khi đổi Ngày nợ/Hạn trả nợ
      const addForm = controls.querySelector(`#add-form-${tableKey}`);
      const ngayNo = addForm?.querySelector('[data-field="Ngày nợ"]');
      const hanNo  = addForm?.querySelector('[data-field="Hạn trả nợ"]');
      const ngayPhaiTra = addForm?.querySelector('[data-field="Ngày phải trả"]');
      function updateDueDateFromForm() {
        if (ngayNo && hanNo && ngayPhaiTra) {
          const due = calculateDueDate(ngayNo.value, hanNo.value);
          ngayPhaiTra.value = formatDateForInput(due);
        }
      }
      if (ngayNo)  ngayNo.addEventListener('input', updateDueDateFromForm);
      if (hanNo)   hanNo.addEventListener('input', updateDueDateFromForm);
      updateDueDateFromForm();
      

      // Hiển thị nợ hiện tại KH & NVKD khi gõ trong form
      const khInp = addForm?.querySelector('[data-field="Tên Khách Hàng"]');
if (khInp) {
  khInp.addEventListener('input', (e) => {
    const name = e.target.value.trim();

    // (1) Chỉ hiển thị nợ hiện tại nếu có phần tử
    const wrap = controls.querySelector('#current-customer-debt-display-ext');
    const valEl = controls.querySelector('#current-customer-debt-value-ext');
    if (wrap && valEl) {
      if (name) {
        const cur = calculateCustomerTotalDebt(name);
        valEl.textContent = `${cur.toLocaleString('vi-VN')} VNĐ`;
        wrap.style.display = 'block';
      } else {
        wrap.style.display = 'none';
      }
    }

    // (2) Đồng bộ filter + lọc bảng
    // (2) Thiết lập lọc tạm và lọc bảng
if (!TEMP_FILTERS.khn) TEMP_FILTERS.khn = {};
if (name) TEMP_FILTERS.khn['Tên Khách Hàng'] = name;
else delete TEMP_FILTERS.khn['Tên Khách Hàng'];

filterTable('khn');

  });
}

      const nvInp = addForm?.querySelector('[data-field="Người chịu trách nhiệm"]');
      if (nvInp) {
        nvInp.addEventListener('input', (e) => {
          const name = e.target.value.trim();
          const wrap = controls.querySelector('#current-sales-debt-display-ext');
          const valEl = controls.querySelector('#current-sales-debt-value-ext');
          if (name) {
            const cur = calculateSalespersonTotalDebt(name);
            valEl.textContent = `${cur.toLocaleString('vi-VN')} VNĐ`;
            wrap.style.display = 'block';
          } else {
            wrap.style.display = 'none';
          }
        });
      }

      // Định dạng tiền trong form
      addForm?.querySelectorAll('input[inputmode="decimal"]').forEach(setupCurrencyInput);
      // Khóa ô "Hạn trả nợ" cho 3 tài khoản đặc biệt
if (!currentPerms.canEditDebtTerm) {
  const hanNoInput = addForm?.querySelector('[data-field="Hạn trả nợ"]');
  if (hanNoInput) {
    hanNoInput.setAttribute('readonly', 'readonly');
    hanNoInput.style.backgroundColor = '#f3f4f6';
  }
}

      // Nút Thêm (form ngoài bảng)
      const addBtn = controls.querySelector(`#btn-add-${tableKey}`);
if (addBtn) {
  addBtn.addEventListener('click', (ev) => {
    ev.stopPropagation(); // chặn gập/mở <details> khi bấm nút
    submitNewRowFromExternalForm(tableKey, addForm, container);
  });
}



    }

    function submitNewRowFromExternalForm(tableKey, formEl, container) {
      if (!currentPerms.canCreate) {
        showToast('Bạn không có quyền thêm mới.', 'error');
        return;
      }
      const headers = originalTableData[tableKey].headers;
      const rowData = {};
      headers.forEach(h => {
        const i = formEl.querySelector(`[data-field="${h}"]`);
        if (i) rowData[h] = i.value.replace(/\./g, '');
      });

      // Hạn mức KH
      const maxDebtInput = document.getElementById('max-debt-input');
      const maxDebtValue = maxDebtInput ? (parseFloat(maxDebtInput.value.replace(/\./g, '')) || 0) : 0;
      if (maxDebtValue > 0) {
        const customerName = rowData['Tên Khách Hàng'];
        if (customerName) {
          const currentDebt = calculateCustomerTotalDebt(customerName);
          const newDebt = parseFloat(rowData['Số tiền nợ'] || '0') || 0;
          if (currentDebt + newDebt > maxDebtValue) {
            showToast(`Nợ của KH (${(currentDebt + newDebt).toLocaleString('vi-VN')}) vượt hạn mức (${maxDebtValue.toLocaleString('vi-VN')}). Không thể thêm!`, 'error');
            return;
          }
        }
      }

      // Hạn mức NVKD
      const maxSalesInput = document.getElementById('max-sales-debt-input');
      const maxSalesVal = maxSalesInput ? (parseFloat(maxSalesInput.value.replace(/\./g, '')) || 0) : 0;
      if (maxSalesVal > 0) {
        const salesName = rowData['Người chịu trách nhiệm'];
        if (salesName) {
          const currentSalesDebt = calculateSalespersonTotalDebt(salesName);
          const newDebt = parseFloat(rowData['Số tiền nợ'] || '0') || 0;
          if (currentSalesDebt + newDebt > maxSalesVal) {
            showToast(`Nợ của NVKD (${(currentSalesDebt + newDebt).toLocaleString('vi-VN')}) vượt hạn mức (${maxSalesVal.toLocaleString('vi-VN')}). Không thể thêm!`, 'error');
            return;
          }
        }
      }

      if (!rowData['Tên Khách Hàng']) {
        showToast('Vui lòng nhập Tên Khách Hàng.', 'warning');
        return;
      }

      rowData['Ngày phải trả'] = formatDateForServer(calculateDueDate(rowData['Ngày nợ'], rowData['Hạn trả nợ']));
      const tempId = crypto.randomUUID();
      rowData['id'] = tempId;

      if (!changeSet.create[tableKey]) changeSet.create[tableKey] = {};
      changeSet.create[tableKey][tempId] = rowData;

      // Chèn dòng mới vào tbody
      const table = container.querySelector('table');
      const tbody = table?.querySelector('tbody');
      if (tbody) {
        const cellsHtml = headers.map(h =>
          HIDDEN_COLUMNS.includes(h)
            ? `<td style="display: none;"></td>`
            : createCellInput(h, rowData[h])
        ).join('');
        const tr = document.createElement('tr');
        tr.dataset.id = tempId;
        tr.classList.add('row-new');
        tr.innerHTML = `<td class="align-center"><span class="delete-btn temp-delete-btn" data-id="${tempId}">&#10006;</span></td>` + cellsHtml;
        tr.querySelectorAll('input[inputmode="decimal"]').forEach(setupCurrencyInput);
        tbody.insertBefore(tr, tbody.firstChild); // lên đầu cho dễ thấy
      }

      // Reset form
      formEl.querySelectorAll('input, select, textarea').forEach(i => {
        const field = i.dataset.field;
        if (field === 'Ngày nợ') i.value = new Date().toISOString().slice(0, 10);
         else if (field === 'Hạn trả nợ') i.value = getGlobalDebtTerm();
        else if (i.tagName === 'SELECT') i.selectedIndex = 0;
        else if (!i.readOnly) i.value = '';
      });
      // Tính lại "Ngày phải trả" sau khi reset form
{
  const ngayNo = formEl.querySelector('[data-field="Ngày nợ"]');
  const hanNo  = formEl.querySelector('[data-field="Hạn trả nợ"]');
  const ngayPT = formEl.querySelector('[data-field="Ngày phải trả"]');
  if (ngayNo && hanNo && ngayPT) {
    const due = calculateDueDate(ngayNo.value, hanNo.value);
    ngayPT.value = formatDateForInput(due);
  }
}

      const csdExt = document.getElementById('current-sales-debt-display-ext');
      const ccdExt = document.getElementById('current-customer-debt-display-ext');
      if (csdExt) csdExt.style.display = 'none';
      if (ccdExt) ccdExt.style.display = 'none';

      setChangesMade(tableKey, true);
      updateTotals(tableKey);
      updateDashboard();
      updateVisibleRowCount(tableKey);
      highlightOverdueRows();
      updateVisibleRowCount(tableKey);  
    }
    /* ==== Hết phần mới ==== */

    function renderTable(tableKey, data) {
        const config = TABLE_CONFIG[tableKey];
        const container = document.getElementById(config.containerId);
        if (!container) return;

        if (tableKey === 'khn' && data.data) {
            const uniqueCustomers = {};
            data.data.slice().reverse().forEach(row => {
                if (row['Tên Khách Hàng'] && !uniqueCustomers[row['Tên Khách Hàng']]) uniqueCustomers[row['Tên Khách Hàng']] = {};
            });
            customerList = Object.keys(uniqueCustomers);
            document.getElementById('customer-list-options').innerHTML = customerList.map(c => `<option value="${c}"></option>`).join('');
        }
        // === Region & Phone datalist ===
const uniqueRegions = new Set();
const uniquePhones  = new Set();

data.data.forEach(row => {
  if (row['Khu vực']) uniqueRegions.add(String(row['Khu vực']).trim());
  if (row['SĐT'])     uniquePhones.add(String(row['SĐT']).trim());
});

const regionDL = document.getElementById('region-list-options');
if (regionDL) {
  regionDL.innerHTML = Array.from(uniqueRegions)
    .sort((a,b) => a.localeCompare(b, 'vi'))
    .map(v => `<option value="${v}"></option>`).join('');
}

const phoneDL = document.getElementById('phone-list-options');
if (phoneDL) {
  phoneDL.innerHTML = Array.from(uniquePhones)
    .sort()
    .map(v => `<option value="${v}"></option>`).join('');
}


        if (!data.data || !data.headers) {
            container.innerHTML = '<p class="status-indicator">Không có dữ liệu.</p>';
            return;
        }

        const headers = data.headers;
        const displayedHeaders = headers.filter(h => !HIDDEN_COLUMNS.includes(h));

        // TẠO TOOLBOX NGOÀI BẢNG (bộ lọc + form thêm)
        createExternalControls(tableKey, headers, displayedHeaders);

        // Dựng bảng (KHÔNG có hàng filter và input-row trong thead/tbody)
        const headerHtml = `
          <thead>
            <tr>
              <th style="width: 50px;">Xóa</th>
              ${displayedHeaders.map(h => `<th data-field="${h}">${headerMapping[h] || h}</th>`).join('')}

            </tr>
          </thead>
        `;

        const bodyHtml = `
          <tbody>
            ${data.data.map(row => {
              const rId = row['id'];
              row['Ngày phải trả'] = calculateDueDate(row['Ngày nợ'], row['Hạn trả nợ']);
              const cH = headers.map(h =>
                HIDDEN_COLUMNS.includes(h)
                  ? `<td style="display: none;">${row[h] || ''}</td>`
                  : createCellInput(h, row[h])
              ).join('');
              return `<tr data-id="${rId}">
                <td class="align-center"><span class="delete-btn" data-id="${rId}">&#10006;</span></td>${cH}
              </tr>`;
            }).join('')}
          </tbody>
        `;

        // Tạo phần tử table rồi append (giữ toolbox đã tạo)
        const tableEl = document.createElement('table');
        tableEl.innerHTML = `${headerHtml}${bodyHtml}<tfoot></tfoot>`;
        container.innerHTML = ''; // xóa sạch trước khi append
        container.appendChild(tableEl);
        makeColumnsResizable(tableEl);

        setupEventListeners(tableKey, container);
        updateTotals(tableKey);
        highlightOverdueRows();
        applyPermissions(tableKey);
    }

    function updateTotals(tableKey) {
  const container = document.getElementById(TABLE_CONFIG[tableKey].containerId);
  if (!container) return;
  const table = container.querySelector('table');
  if (!table) return;
  const tfoot = table.querySelector('tfoot');
  if (!tfoot) return;

  // Lấy headers hiển thị (đã bỏ cột Xóa bằng slice(1))
  const headers = Array.from(table.querySelectorAll('thead tr:first-child th'))
    .slice(1)
    .map(th => Object.keys(headerMapping).find(k => headerMapping[k] === th.textContent) || th.textContent);

  // Chỉ tính trên các dòng đang hiển thị và chưa “đã tất toán”
  const visibleRows = Array.from(table.querySelectorAll('tbody tr'))
    .filter(row => row.style.display !== 'none' && !row.classList.contains('debt-paid-off'));

  // Bắt đầu: 1 ô trống cho cột Xóa + 1 ô nhãn “Tổng cộng”
  let cells = ['<td></td>', '<td class="total-label align-left">Tổng cộng</td>'];

  // Duyệt từng header: cột 1 (đầu tiên) đã dùng cho nhãn → để trống,
  // các cột số thì tính tổng và căn phải.
  headers.forEach((header, idx) => {
    // idx === 0 đã dùng cho ô nhãn “Tổng cộng” rồi, bỏ qua
  if (idx === 0) { return; }
    if (NUMERIC_COLUMNS_FOR_TOTAL.includes(header) && header !== 'Hạn trả nợ') {
      const total = visibleRows.reduce((sum, row) => {
        const input = row.querySelector(`[data-field="${header}"]`);
        const val = input ? (input.value || '0').replace(/\./g, '') : '0';
        return sum + (parseFloat(val) || 0);
      }, 0);
      cells.push(`<td class="align-right">${total.toLocaleString('vi-VN')}</td>`);
    } else {
      cells.push('<td></td>');
    }
  });

  tfoot.innerHTML = `<tr>${cells.join('')}</tr>`;
}


    function setupEventListeners(tableKey, container) {
        if (!container) return;
        const table = container.querySelector('table'); if (!table) return;
        const tbody = table.querySelector('tbody');

        // Lọc: lấy từ toolbox (vì .filter-input đặt trong container)
            // Lọc: lấy filter từ controlsHost (ngoài bảng)
    const controlsHost = document.getElementById(`controls-${tableKey}`);
    if (controlsHost) {
      controlsHost.querySelectorAll('.filter-input')
        .forEach(input => input.addEventListener('input', () => filterTable(tableKey)));
    }

        // Edit cell (giữ nguyên — nhưng sẽ không hiệu lực vì canEditExisting=false)
        tbody.addEventListener('change', (e) => {
            const el = e.target; 
            const tr = el.closest('tr'); 
            if (tr && !tr.classList.contains('input-row')) handleCellEdit(e, tableKey); 
        });

        // Tính ngày phải trả khi đổi trường trong bảng
        const eventTrigger = (e) => {
            const el = e.target;
            const tr = el.closest('tr');
            if (!tr) return;

            if (el.tagName === 'INPUT' || el.tagName === 'SELECT') {
                const row = el.closest('tr');
                if (row) {
                    const ngayNoInput = row.querySelector('[data-field="Ngày nợ"]');
                    const hanTraNoInput = row.querySelector('[data-field="Hạn trả nợ"]');
                    const ngayPhaiTraInput = row.querySelector('[data-field="Ngày phải trả"]');
                    
                    if (ngayNoInput && hanTraNoInput && ngayPhaiTraInput) {
                        ngayPhaiTraInput.value = formatDateForInput(calculateDueDate(ngayNoInput.value, hanTraNoInput.value));
                    }
                }
            }
            if ((el.tagName === 'INPUT' && el.type === 'text' && !el.hasAttribute('inputmode')) || el.tagName === 'TEXTAREA') {
                capitalizeFirstLetter(el);
            }
        };
        tbody.addEventListener('input', eventTrigger);

        // Xóa tạm dòng mới (được thêm trước khi lưu)
        tbody.addEventListener('click', (e) => { 
            if (e.target.classList.contains('temp-delete-btn')) { 
                const tr = e.target.closest('tr'); 
                const rowId = tr.dataset.id; 
                if (changeSet.create[tableKey]?.[rowId]) delete changeSet.create[tableKey][rowId]; 
                tr.remove(); 
                updateTotals(tableKey); 
                updateDashboard(); 
                updateVisibleRowCount(tableKey); 
                setChangesMade(tableKey, hasPendingChanges(tableKey)); 
            } 
        });

        // Định dạng tiền trong tbody
        tbody.querySelectorAll('input[inputmode="decimal"]').forEach(setupCurrencyInput);

        // Nút xóa: chặn
        table.querySelectorAll('.delete-btn:not(.temp-delete-btn)').forEach(btn => btn.addEventListener('click', (e) => handleDeleteClick(e, tableKey)));
    }

    function handleCellEdit(e, tableKey) {
        if (!currentPerms.canEditExisting) return;

        const element = e.target; const tr = element.closest('tr'); const rowId = tr.dataset.id; const field = element.dataset.field;
        let newValue = (element.getAttribute('inputmode') === 'decimal') ? element.value.replace(/\./g, '') : element.value;
        if (!rowId) return;
        if (!changeSet.update[tableKey]) changeSet.update[tableKey] = {};
        if (!changeSet.update[tableKey][rowId]) {
            const rowDataFromDOM = {};
            originalTableData[tableKey].headers.forEach(h => {
                const cell = tr.querySelector(`[data-field="${h}"]`);
                if (cell) rowDataFromDOM[h] = cell.value.replace(/\./g, '');
                else { const originalRow = originalTableData[tableKey]?.data.find(r => r.id == rowId); if (originalRow) rowDataFromDOM[h] = originalRow[h]; }
            });
            changeSet.update[tableKey][rowId] = { ...rowDataFromDOM, id: rowId };
        }
        changeSet.update[tableKey][rowId][field] = newValue;
        tr.classList.add('row-dirty');
        setChangesMade(tableKey, true);
        updateTotals(tableKey);
        updateDashboard();
        highlightOverdueRows();
    }

    function handleDeleteClick(e, tableKey) {
  const btn = e.currentTarget || e.target;
  const rowId = btn?.dataset?.id;
  if (!rowId) return;

  if (!currentPerms.canDelete) {
    showToast('Bạn không có quyền xóa.', 'error');
    return;
  }

  if (!changeSet.delete[tableKey]) changeSet.delete[tableKey] = [];
  if (!changeSet.delete[tableKey].includes(rowId)) {
    changeSet.delete[tableKey].push(rowId);
  }

  const tr = btn.closest('tr');
  if (tr) tr.style.display = 'none';

  setChangesMade(tableKey, true);
  updateTotals(tableKey);
  updateDashboard();
  updateVisibleRowCount(tableKey);
  showToast('Đã đánh dấu xóa. Nhấn "Lưu Thay Đổi" để áp dụng.', 'success');
}


    async function handleSaveChanges(tableKey) {
        const updateBtn = document.getElementById('update-btn-khn');
        updateBtn.disabled = true; updateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang lưu...';
        const config = TABLE_CONFIG[tableKey];

        const cleanData = (data) => {
          return JSON.parse(JSON.stringify(data)).map(row => {
            Object.keys(row).forEach(key => {
              if (key === 'SĐT' && row[key]) {
                const phoneStr = String(row[key]).trim();
                row[key] = "'" + phoneStr; // để giữ số 0 đầu khi vào Sheet
              }
            });
            return row;
          });
        };

        const createDataAll = Object.values(changeSet.create[tableKey] || {});
        const updateDataAll = Object.values(changeSet.update[tableKey] || {});
        const deleteIdsAll = changeSet.delete[tableKey] || [];

        const createData = currentPerms.canCreate ? cleanData(createDataAll) : [];
        const updateData = currentPerms.canEditExisting ? cleanData(updateDataAll) : [];
        const deleteIds  = currentPerms.canDelete ? deleteIdsAll : [];

        const fetchPromises = [];
        if (createData.length > 0) {
          fetchPromises.push(fetch(API_BASE_URL, {
            method: 'POST', mode: 'no-cors',
            body: JSON.stringify({ tableName: config.name, action: 'create', data: createData })
          }));
        }
        if (updateData.length > 0) {
          fetchPromises.push(fetch(API_BASE_URL, {
            method: 'POST', mode: 'no-cors',
            body: JSON.stringify({ tableName: config.name, action: 'update', data: updateData })
          }));
        }
        if (deleteIds.length > 0) {
          fetchPromises.push(fetch(API_BASE_URL, {
            method: 'POST', mode: 'no-cors',
            body: JSON.stringify({ tableName: config.name, action: 'delete', data: { ids: deleteIds } })
          }));
        }

        try {
            await Promise.all(fetchPromises);
            showToast('Lưu thay đổi thành công!', 'success');
            changeSet = { create: {}, update: {}, delete: {} };
            Object.keys(TABLE_CONFIG).forEach(k => TABLE_CONFIG[k].loaded = false);
            await initApp(true);
        } catch (error) { showToast('Đã xảy ra lỗi khi lưu: ' + error.message, 'error');
        } finally { updateBtn.innerHTML = '<i class="fas fa-save"></i> Lưu Thay Đổi'; }
    }

    async function loadData(tableKey, onComplete) {
        const config = TABLE_CONFIG[tableKey];
        if (!config || (config.loaded && !hasPendingChanges(tableKey))) { if (onComplete) onComplete(); return; }
        if (config.containerId) document.getElementById(config.containerId).innerHTML = `<p class="status-indicator">Đang tải...</p>`;
        try {
            const response = await fetch(`${API_BASE_URL}?tableName=${encodeURIComponent(config.name)}`);
            if (!response.ok) throw new Error(`Lỗi mạng: ${response.statusText}`);
            originalTableData[tableKey] = await response.json();

            // Xử lý SĐT để đảm bảo giữ số 0 đầu
            if (originalTableData[tableKey] && originalTableData[tableKey].data) {
                originalTableData[tableKey].data.forEach(row => {
                    if (row['SĐT'] && typeof row['SĐT'] === 'number') {
                        row['SĐT'] = String(row['SĐT']).padStart(10, '0');
                    } else if (row['SĐT']) {
                        row['SĐT'] = String(row['SĐT']).trim();
                    }
                });
            }

            if (config.containerId) renderTable(tableKey, originalTableData[tableKey]);
            config.loaded = true;
            if (config.containerId) setChangesMade(tableKey, false);
        } catch (error) { 
            if (config.containerId) document.getElementById(config.containerId).innerHTML = `<p class="status-indicator error">Lỗi tải dữ liệu: ${error.message}</p>`;
        } finally { if (onComplete) onComplete(); }
    }

    async function fetchNhanSuAndLogin(username, password, errorEl, loginBtn) {
        try {
            const response = await fetch(`${API_BASE_URL}?tableName=Nhân sự`);
            if (!response.ok) throw new Error('Không thể tải dữ liệu người dùng.');
            const personnelData = await response.json();
            if (!personnelData || !personnelData.data) throw new Error('Dữ liệu người dùng không hợp lệ.');
            nhanSuList = [...new Set(personnelData.data.map(user => user['Họ và tên']))].filter(Boolean).sort();
            if (username && password) {
                const foundUser = personnelData.data.find(user => user['Tên đăng nhập'] === username && user['Passwword'] == password);
                if (foundUser) {  sessionStorage.setItem('loggedInUser', JSON.stringify({
   name: foundUser['Họ và tên'],
  username: foundUser['Tên đăng nhập']
 })); await initApp();
                } else { errorEl.textContent = 'Tên đăng nhập hoặc mật khẩu không đúng.'; }
            }
        } catch (error) { if(errorEl) errorEl.textContent = 'Lỗi kết nối hoặc không tìm thấy bảng Nhân sự.';
        } finally { if (loginBtn) { loginBtn.textContent = 'Đăng Nhập'; loginBtn.disabled = false; } }
    }

    async function handleLogin(e) { e.preventDefault(); const username = document.getElementById('username').value; const password = document.getElementById('password').value; const errorEl = document.getElementById('login-error'); const loginBtn = document.getElementById('login-btn'); errorEl.textContent = ''; loginBtn.textContent = 'Đang xử lý...'; loginBtn.disabled = true; await fetchNhanSuAndLogin(username, password, errorEl, loginBtn); }
    function handleLogout() { sessionStorage.removeItem('loggedInUser'); location.reload(); }

    async function initApp(isReload = false) {
        const user = JSON.parse(sessionStorage.getItem('loggedInUser'));
        if (user) {
            // === PHÂN QUYỀN (ADD) === tính quyền mọi lần
            currentPerms = computePerms(user.name, user.username);


            if (!isReload) {
                document.getElementById('login-overlay').style.display = 'none';
                document.querySelector('.container').classList.add('visible');
                const userInfoEl = document.getElementById('user-info');
                userInfoEl.innerHTML = `Xin chào, <strong>${user.name}</strong>! <a href="#" id="logout-btn">Đăng xuất</a>`;
                document.getElementById('logout-btn').addEventListener('click', handleLogout);
            }
            await fetchNhanSuAndLogin(); 
            const salesDatalist = document.getElementById('sales-person-list-options');
            if (salesDatalist && nhanSuList.length > 0) salesDatalist.innerHTML = nhanSuList.map(name => `<option value="${name}"></option>`).join('');
            await Promise.all([loadData('khn'), loadData('khtn'), loadData('hth')]);
            processAndMarkPaidDebts();
            updateDashboard();
            updateVisibleRowCount('khn');
            highlightOverdueRows();
            applyPermissions('khn');
            // Áp dụng quyền cho toàn bộ dashboard sau khi load xong
const debtTermInput = document.getElementById('custom-debt-term-input');
if (debtTermInput && !currentPerms.canEditDebtTerm) {
    debtTermInput.setAttribute('readonly', 'readonly');
    debtTermInput.style.backgroundColor = '#f3f4f6';
}

        } else {
            document.getElementById('login-overlay').style.display = 'flex';
        }
    }

    function setChangesMade(tableKey, madeChanges) { const btn = document.getElementById(`update-btn-${tableKey}`); if (btn) btn.disabled = !madeChanges; }
    function hasPendingChanges(tableKey) { return (Object.keys(changeSet.create[tableKey] || {}).length + Object.keys(changeSet.update[tableKey] || {}).length + (changeSet.delete[tableKey] || []).length) > 0; }
    
    function calculateGrandTotal(tableKey, filteredData = null) {
        const config = TABLE_CONFIG[tableKey];
        if (!config || !config.totalField) return 0;
        
        let sourceData;
        if(filteredData) {
            sourceData = filteredData;
        } else {
            const originalData = originalTableData[tableKey]?.data || [];
            const createdData = Object.values(changeSet.create[tableKey] || {});
            const updatedData = changeSet.update[tableKey] || {};
            const deletedIds = new Set(changeSet.delete[tableKey] || []);
            
            sourceData = [];
            originalData.forEach(row => {
                if (!deletedIds.has(row.id)) {
                    sourceData.push({ ...row, ...(updatedData[row.id] || {}) });
                }
            });
            sourceData.push(...createdData);
        }
        
        return sourceData.reduce((sum, row) => sum + (parseFloat(String(row[config.totalField] || '0').replace(/\./g, '')) || 0), 0);
    }
    
    function updateDashboard(filteredData = null) {
        const tN = calculateGrandTotal('khn', filteredData ? filteredData.khn : null);
        const tT = calculateGrandTotal('khtn', filteredData ? filteredData.khtn : null);
        const tTH = calculateGrandTotal('hth', filteredData ? filteredData.hth : null);
        document.getElementById('dashboard-total-no').textContent = tN.toLocaleString('vi-VN') + ' VNĐ';
        document.getElementById('dashboard-total-tra').textContent = tT.toLocaleString('vi-VN') + ' VNĐ';
        document.getElementById('dashboard-total-thuhoi').textContent = tTH.toLocaleString('vi-VN') + ' VNĐ';
        document.getElementById('dashboard-total-conlai').textContent = (tN - tT - tTH).toLocaleString('vi-VN') + ' VNĐ';
    }

    function calculateDueDate(s, d) { if (!s || d == null) return null; try { const sD = new Date(s); const dA = parseInt(d, 10); if (isNaN(sD.getTime()) || isNaN(dA)) return null; sD.setUTCDate(sD.getUTCDate() + dA); return sD; } catch (e) { return null; } }
    
    function filterTable(tableKey) {
  const container = document.getElementById(TABLE_CONFIG[tableKey].containerId);
  const tbody = container.querySelector('tbody');
  if (!tbody) return;

  const rows = Array.from(tbody.querySelectorAll('tr'));

// ❌ Bỏ chỗ lấy từ container
  // const allFilterInputs = Array.from(container.querySelectorAll('.filter-input'));

  // ✅ Lấy filter-input từ controlsHost (ngoài bảng)
  const controlsHost = document.getElementById(`controls-${tableKey}`);
  const allFilterInputs = controlsHost
    ? Array.from(controlsHost.querySelectorAll('.filter-input'))
    : [];
    // Lấy trạng thái 2 checkbox
const overdueChk = controlsHost?.querySelector('.filter-checkbox[data-role="overdue-sales"]');
const allChk     = controlsHost?.querySelector('.filter-checkbox[data-role="all"]');
const filterOverdue = !!overdueChk?.checked;
const filterAll     = !!allChk?.checked;
// Nếu bỏ tick cả 2 checkbox thì ẩn tất cả dòng và return
if (!filterOverdue && !filterAll) {
  rows.forEach(row => row.style.display = 'none');
  updateTotals(tableKey);
  updateDashboard({ khn: [], khtn: [], hth: [] });
  updateVisibleRowCount(tableKey);
  return;
}


  // --- tách lọc ngày & text ---
  const startInput = allFilterInputs.find(i => i.dataset.role === 'date-start');
  const endInput   = allFilterInputs.find(i => i.dataset.role === 'date-end');
  const startStr = startInput?.value || '';
  const endStr   = endInput?.value   || '';

  const textFilters = allFilterInputs
    .filter(i => !i.dataset.role) // không phải 2 ô ngày
    .map(i => ({ header: i.dataset.header, value: i.value.trim().toLowerCase() }));
    // Gộp thêm bộ lọc tạm từ form thêm (nếu có)
const tmp = TEMP_FILTERS[tableKey] || {};
Object.entries(tmp).forEach(([header, val]) => {
  if (val != null && String(val).trim() !== '') {
    textFilters.push({ header, value: String(val).trim().toLowerCase() });
  }
});


  const hasAnyText = textFilters.some(f => f.value !== '');
  const hasStart   = !!startStr;
  const hasEnd     = !!endStr;

  // helper so sánh ngày (yyyy-mm-dd) theo ngày, bỏ giờ
  const toYmd = d => (d ? new Date(d).toISOString().slice(0,10) : '');
  const parseSafe = s => (s ? new Date(s + 'T00:00:00') : null); // tránh lệch múi giờ

  const startDate = parseSafe(startStr);
  const endDate   = parseSafe(endStr);

  // --- lọc DOM theo điều kiện ---
  rows.forEach(row => {
    let ok = true;

    // 1) Lọc text (nếu có)
    if (ok && hasAnyText) {
      for (const f of textFilters) {
        if (!f.value) continue;
        const cell = row.querySelector(`[data-field="${f.header}"]`);
        const val = (cell ? (cell.value || cell.textContent) : '').toLowerCase();
        if (!val.includes(f.value)) { ok = false; break; }
      }
    }

    // 2) Lọc ngày theo 3 quy tắc
    if (ok && (hasStart || hasEnd)) {
      const startCell = row.querySelector('[data-field="Ngày nợ"]');
      const endCell   = row.querySelector('[data-field="Ngày phải trả"]');

      const rowStart = parseSafe(startCell?.value || startCell?.textContent || '');
      const rowEnd   = parseSafe(endCell?.value   || endCell?.textContent   || '');

      // Nếu thiếu dữ liệu ngày trong dòng thì coi là không khớp
      if (!rowStart || !rowEnd) ok = false;
      else {
        if (hasStart && !hasEnd) {
          // (1) Chỉ chọn Ngày nợ -> lấy các khoản nợ bắt đầu từ ngày đó trở đi
          ok = (rowStart >= startDate);
        } else if (!hasStart && hasEnd) {
          // (2) Chỉ chọn Ngày đến hạn -> chỉ đúng ngày đó (so sánh đúng YYYY-MM-DD)
          ok = (toYmd(rowEnd) === toYmd(endDate));
        } else {
          // (3) Chọn cả 2 -> bắt đầu >= start và kết thúc <= end
          ok = (rowStart >= startDate && rowEnd <= endDate);
        }
      }
    }
    // 3) Lọc “NVKD cho nợ quá hạn” (chỉ áp dụng khi không tick "Tất cả")
if (ok && filterOverdue && !filterAll) {
  const dueDateInput = row.querySelector('[data-field="Ngày phải trả"]');
  const nvkdInput = row.querySelector('[data-field="Người chịu trách nhiệm"]');
  const nvkd = nvkdInput ? (nvkdInput.value || nvkdInput.textContent || '').trim() : '';
  const today = new Date(); today.setHours(0,0,0,0);

  if (!nvkd || !dueDateInput?.value) {
    ok = false; // thiếu NVKD hoặc ngày đến hạn -> không tính quá hạn
  } else {
    const dueDate = new Date(dueDateInput.value);
    ok = (dueDate < today); // chỉ giữ dòng đã quá hạn
  }
}

    row.style.display = ok ? '' : 'none';
  });

  // --- cập nhật tổng & dashboard theo dữ liệu đã lọc ---
  updateTotals(tableKey);
  highlightOverdueRows();

  // Cập nhật dashboard dựa trên dữ liệu đã lọc (khi có bất kỳ filter)
  const anyFilterActive = hasAnyText || hasStart || hasEnd || (filterOverdue && !filterAll);


  if (anyFilterActive) {
    const visibleIds = new Set(
      rows.filter(r => r.style.display !== 'none' && !r.classList.contains('debt-paid-off'))
          .map(r => r.dataset.id)
    );
    const filteredKhn = (originalTableData.khn?.data || []).filter(r => visibleIds.has(r.id));
    const filteredDebtIds = new Set(filteredKhn.map(r => r.id));
    const filteredCustomerNames = new Set(filteredKhn.map(r => r['Tên Khách Hàng']));

    const filteredKhtn = (originalTableData.khtn?.data || []).filter(r => filteredDebtIds.has(r['id nợ']));
    const filteredHth  = (originalTableData.hth?.data  || []).filter(r => filteredCustomerNames.has(r['Tên Khách Hàng']));

    updateDashboard({ khn: filteredKhn, khtn: filteredKhtn, hth: filteredHth });
  } else {
    updateDashboard();
  }
    // cập nhật số bản ghi hiển thị
  updateVisibleRowCount(tableKey);

}


  function capitalizeFirstLetter(input) {
  if (!input || !input.value) return;

  // ⛔ Bỏ auto-viết hoa riêng cho ô "Ghi chú"
  const fieldName = (input.dataset && input.dataset.field) || '';
  if (fieldName === 'Ghi chú') return;

  // Viết hoa chữ cái đầu mỗi từ cho các ô còn lại
  input.value = input.value
    .split(' ')
    .map(word => {
      if (word.length === 0) return word;
      return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
    })
    .join(' ');
}


    function formatDateForInput(d) { if (!d) return ''; try { const dt = new Date(d); if (isNaN(dt.getTime())) return ''; return `${dt.getUTCFullYear()}-${String(dt.getUTCMonth() + 1).padStart(2, '0')}-${String(dt.getUTCDate()).padStart(2, '0')}`; } catch (e) { return ''; } }
    function formatDateForServer(d) { if (!d) return ''; try { const dt = new Date(d); if (isNaN(dt.getTime())) return ''; return `${String(dt.getUTCMonth() + 1).padStart(2, '0')}/${String(dt.getUTCDate()).padStart(2, '0')}/${dt.getUTCFullYear()}`; } catch (e) { return ''; } }
    // === helpers ===
const formatThousands = (s) =>
  String(s ?? '')
    .replace(/[^\d]/g, '')                // chỉ giữ số
    .replace(/\B(?=(\d{3})+(?!\d))/g, '.');  // chèn dấu "."
function finalizeCurrency(el){
  if (!el || !el.getAttribute || el.getAttribute('inputmode') !== 'decimal') return;
  const raw = String(el.value || '').replace(/[^\d]/g, '');
  el.value = raw ? raw.replace(/\B(?=(\d{3})+(?!\d))/g, '.') : '';
}
function getGlobalDebtTerm(){
  const g = document.getElementById('custom-debt-term-input');
  const n = g && g.value ? parseInt(g.value, 10) : 30;
  return Number.isFinite(n) ? String(n) : '30';
}




    function setupCurrencyInput(input) {
  if (!input || input.__currencyBound) return;
  input.__currencyBound = true;

  let composing = false;

  input.addEventListener('compositionstart', () => composing = true);
  input.addEventListener('compositionend',   () => { 
    composing = false; 
    formatRealtime(); 
  });

  // Format ngay khi gõ (real-time)
  const formatRealtime = () => {
    if (composing) return; // không format khi đang gõ tiếng Việt
    
    const cursorPos = input.selectionStart;
    const oldValue = input.value;
    const rawValue = oldValue.replace(/[^\d]/g, ''); // chỉ giữ số
    
    if (rawValue === '') {
      input.value = '';
      return;
    }
    
    // Format với dấu chấm
    const formattedValue = rawValue.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    
    if (formattedValue !== oldValue) {
      input.value = formattedValue;
      
      // Tính toán lại vị trí con trỏ
      const oldDots = (oldValue.slice(0, cursorPos).match(/\./g) || []).length;
      const newDots = (formattedValue.slice(0, cursorPos).match(/\./g) || []).length;
      const newCursorPos = cursorPos + (newDots - oldDots);
      
      // Đặt lại con trỏ
      input.setSelectionRange(newCursorPos, newCursorPos);
    }
  };

  // Format ngay khi gõ
  input.addEventListener('input', formatRealtime);

  // Chỉ format khi kết thúc nhập (giữ lại cho chắc chắn)
  const finalize = () => { if (!composing) finalizeCurrency(input); };

  input.addEventListener('blur', finalize);
  input.addEventListener('change', finalize);

  // Enter/Tab: format ngay
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' || e.key === 'Tab') {
      finalize();
    }
  });

  // Space: chặn chèn khoảng trắng + format ngay
  input.addEventListener('keydown', (e) => {
    if (e.key === ' ' || e.code === 'Space') {
      e.preventDefault();      // không cho thêm dấu cách vào ô
      finalize();              // format số (chèn dấu .)
    }
  });

  // Paste: format sau khi paste
  input.addEventListener('paste', () => {
    setTimeout(formatRealtime, 0);
  });

  // Format giá trị ban đầu (nếu có)
  finalizeCurrency(input);
}


// === Resizable columns (kéo giãn cột) — map theo tên field, không lệch cột ẩn ===
function makeColumnsResizable(table){
  if (!table) return;
  const headerThs = Array.from(table.querySelectorAll('thead th[data-field]'));

  headerThs.forEach((th, displayIdx) => {
    th.style.position = 'relative';      // để tay nắm bám đúng vào TH
    const field = th.dataset.field;

    const handle = document.createElement('div');
    handle.className = 'col-resizer';
    th.appendChild(handle);

    let startX = 0, startW = 0;

    const onMouseDown = (e) => {
      startX = e.pageX;
      startW = th.getBoundingClientRect().width;
      document.body.classList.add('resizing-col');
      document.addEventListener('mousemove', onMouseMove);
      document.addEventListener('mouseup', onMouseUp);
      e.preventDefault();
    };

    const onMouseMove = (e) => {
      const dx = e.pageX - startX;
      const newW = Math.max(100, startW + dx);
      th.style.width = newW + 'px';
      th.style.minWidth = newW + 'px';

      // Áp cho đúng TD của cột này
      table.querySelectorAll('tbody tr').forEach(tr => {
        const ctrl = tr.querySelector(`[data-field="${CSS.escape(field)}"]`);
        if (ctrl) {
          const td = ctrl.closest('td');
          td.style.width = newW + 'px';
          td.style.minWidth = newW + 'px';
        }
      });

      // Áp cho tfoot (cộng 1 vì cột 0 là "Xóa")
      const tfRow = table.querySelector('tfoot tr');
      if (tfRow && tfRow.children[displayIdx + 1]) {
        const td = tfRow.children[displayIdx + 1];
        td.style.width = newW + 'px';
        td.style.minWidth = newW + 'px';
      }
    };

    const onMouseUp = () => {
      document.body.classList.remove('resizing-col');
      document.removeEventListener('mousemove', onMouseMove);
      document.removeEventListener('mouseup', onMouseUp);
    };

    handle.addEventListener('mousedown', onMouseDown);
  });
}




function exportToExcel(e) {
  const tableKey = e.currentTarget.dataset.tableKey;
  if (!tableKey) return;

  const cfg = TABLE_CONFIG[tableKey];
  const container = document.getElementById(cfg.containerId);
  const table = container?.querySelector('table');
  if (!table) return showToast('Không tìm thấy bảng để xuất.', 'warning');

  // Lấy danh sách cột hiển thị (bỏ cột "Xóa")
  const ths = Array.from(table.querySelectorAll('thead tr:first-child th[data-field]'));
  const headersInfo = ths.map(th => ({
    display: (th.textContent || '').trim(),  // tên hiển thị trên file
    original: th.dataset.field               // tên cột gốc để tìm [data-field="..."]
  }));
  const headers = headersInfo.map(h => h.display);
  if (headers.length === 0) return showToast('Không có cột dữ liệu để xuất.', 'warning');

  // Xác định cột số / cột ngày dựa trên tên cột gốc
  const isNumericCol = (orig) => NUMERIC_COLUMNS_FOR_TOTAL.includes(orig);
  const isDateCol    = (orig) => orig.includes('Ngày');

  // Thu thập dữ liệu các hàng đang hiển thị
  const rows = Array.from(table.querySelectorAll('tbody tr'))
    .filter(tr => tr.style.display !== 'none' && !tr.classList.contains('debt-paid-off'));

  const dataAoA = [headers];

  rows.forEach(tr => {
    const rowArr = headersInfo.map(h => {
      const ctrl = tr.querySelector(`[data-field="${CSS.escape(h.original)}"]`);
      let raw = '';
      if (ctrl) {
        // input/select/textarea
        raw = (ctrl.value ?? ctrl.textContent ?? '').trim();
      } else {
        // fallback: lấy text của TD chứa control (rất hiếm khi cần)
        const td = Array.from(tr.children).find(td =>
          td.querySelector && td.querySelector(`[data-field="${CSS.escape(h.original)}"]`)
        );
        raw = (td?.textContent || '').trim();
      }

      if (isNumericCol(h.original)) {
        const num = Number(String(raw).replace(/\./g, '').replace(/,/g, ''));
        return Number.isFinite(num) ? num : null;
      }
      if (isDateCol(h.original)) {
        const d = new Date(raw);
        return isNaN(d.getTime()) ? raw : d;
      }
      return raw;
    });

    dataAoA.push(rowArr);
  });

  // Hàng tổng (nếu có)
  const tfootRow = table.querySelector('tfoot tr');
  if (tfootRow) {
    const totalArr = headersInfo.map((h, idx) => {
      if (idx === 0) {
        // ô đầu tiên ghi "TỔNG CỘNG" (hoặc giữ text hiện có nếu có)
        const td = tfootRow.children[1]; // vì cột 0 là "Xóa"
        const txt = (td?.textContent || '').trim();
        return txt || 'TỔNG CỘNG';
      }
      // tìm đúng TD của cột hiện tại trong tfoot (dịch +1 vì có cột "Xóa")
      const td = tfootRow.children[idx + 1];
      const txt = (td?.textContent || '').trim();
      if (isNumericCol(h.original)) {
        const num = Number(txt.replace(/\./g, '').replace(/,/g, ''));
        return Number.isFinite(num) ? num : null;
      }
      return txt;
    });
    dataAoA.push(totalArr);
  }

  // Tạo workbook/sheet
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(dataAoA);

  // Autofilter + freeze header
  ws['!autofilter'] = { ref: XLSX.utils.encode_range({ s: { r:0, c:0 }, e: { r: 0, c: headers.length - 1 } }) };
  ws['!freeze'] = { xSplit: 0, ySplit: 1 };

  // Định dạng số / ngày
  const range = XLSX.utils.decode_range(ws['!ref']);
  for (let C = range.s.c; C <= range.e.c; ++C) {
    const orig = headersInfo[C].original;
    for (let R = 1; R <= range.e.r; ++R) {
      const cellAddr = XLSX.utils.encode_cell({ r: R, c: C });
      const cell = ws[cellAddr];
      if (!cell) continue;
      if (isNumericCol(orig) && typeof cell.v === 'number') {
        cell.t = 'n';
        cell.z = '#,##0';
      } else if (isDateCol(orig) && cell.v instanceof Date) {
        cell.t = 'd';
        cell.z = 'yyyy-mm-dd';
      }
    }
  }

  // Auto-fit cột
  const colWidths = headersInfo.map((h, idx) => {
    let maxLen = h.display.length;
    for (let r = 1; r < dataAoA.length; r++) {
      const v = dataAoA[r][idx];
      let len = 0;
      if (v == null) len = 0;
      else if (v instanceof Date) len = 10;
      else if (typeof v === 'number') len = String(v).length + 2;
      else len = String(v).length;
      if (len > maxLen) maxLen = len;
    }
    if (isNumericCol(h.original)) maxLen = Math.max(maxLen, 12);
    if (isDateCol(h.original))    maxLen = Math.max(maxLen, 10);
    return { wch: Math.min(Math.max(maxLen + 2, 10), 40) };
  });
  ws['!cols'] = colWidths;

  // Ghi file
  const sheetName = (cfg.name || 'Sheet').slice(0, 30);
  const filename = `BaoCao_${cfg.name?.replace(/\s/g, '_') || 'CongNo'}_${new Date().toISOString().slice(0,10)}.xlsx`;
  XLSX.utils.book_append_sheet(wb, ws, sheetName);
  XLSX.writeFile(wb, filename);
}

     // --- Đồng bộ "Số Ngày Nợ Tối Đa" (dashboard) -> "Hạn trả nợ" (form thêm) ---
function syncGlobalDebtTermToForm() {
  const debtTermInput = document.querySelector('#add-form-khn input[data-field="Hạn trả nợ"]');
  if (!debtTermInput) return;

  const v = getGlobalDebtTerm();     // luôn lấy theo dashboard, fallback 30
  debtTermInput.value = v;

  // bắn event để tính lại "Ngày phải trả"
  debtTermInput.dispatchEvent(new Event('input', { bubbles: true }));
}



    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('login-form').addEventListener('submit', handleLogin);
       document.querySelectorAll('.export-btn').forEach(btn => {
  btn.addEventListener('click', exportToExcel);
});

        document.getElementById('update-btn-khn').addEventListener('click', () => handleSaveChanges('khn'));
         // ⬇⬇⬇ THÊM ĐÚNG VÀO ĐÂY ⬇⬇⬇
  const clearTopBtn = document.getElementById('btn-clear-khn');
if (clearTopBtn){
  clearTopBtn.addEventListener('click', () => {
    const controlsHost = document.getElementById('controls-khn');
    if (controlsHost){
      // Xóa nội dung các ô filter
      controlsHost.querySelectorAll('.filters-panel .filter-input')
        .forEach(inp => inp.value = '');

      // ✅ Reset lại checkbox: Tất cả = tick, NVKD quá hạn = bỏ tick
      const allChk = controlsHost.querySelector('.filter-checkbox[data-role="all"]');
      const odChk  = controlsHost.querySelector('.filter-checkbox[data-role="overdue-sales"]');
      if (allChk) allChk.checked = true;
      if (odChk)  odChk.checked = false;
    }

    // Xóa bộ lọc tạm từ form thêm (nếu có)
    if (TEMP_FILTERS.khn) TEMP_FILTERS.khn = {};

    // Áp lại lọc và cập nhật
    filterTable('khn');
    updateVisibleRowCount('khn');
    showToast('Đã xóa bộ lọc', 'success');
  });
}

  // ⬆⬆⬆ HẾT PHẦN THÊM ⬆⬆⬆
        setupCurrencyInput(document.getElementById('max-debt-input'));
        setupCurrencyInput(document.getElementById('max-sales-debt-input'));

        const customDebtTermInput = document.getElementById('custom-debt-term-input');
if (customDebtTermInput) {
  if (!customDebtTermInput.value) customDebtTermInput.value = '30'; // mặc định 30 lần đầu
  syncGlobalDebtTermToForm();                                      // đồng bộ xuống form ngay khi load
  // gõ số ngày ở dashboard -> đẩy sang "Hạn trả nợ" của form thêm
  customDebtTermInput.addEventListener('input', syncGlobalDebtTermToForm);
}



        const deliveryDatalist = document.getElementById('delivery-staff-list-options');
        if (deliveryDatalist) {
          deliveryDatalist.innerHTML = GIAO_HANG_NV_LIST
            .map(n => `<option value="${n}"></option>`)
            .join('');
        }
        
        initApp();
          // Tự viết hoa chữ cái đầu tiên khi đang nhập
  // Chỉ viết hoa khi blur (thoát ô)
document.addEventListener('blur', (e) => {
  const el = e.target;
  if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
    const type = el.getAttribute('type');
    if (!type || type === 'text') {
      capitalizeFirstLetter(el);
    }
  }
}, true); // dùng capture để bắt cả blur bubbling


    });
    (function () {
  function getFocusable(container=document) {
    return Array.from(container.querySelectorAll(
      'input:not([type="hidden"]):not([disabled]), select:not([disabled]), textarea:not([disabled])'
    )).filter(el => el.offsetParent !== null);
  }

  function focusByDirection(fromEl, direction, container=document) {
    const focusables = getFocusable(container);
    const cur = fromEl.getBoundingClientRect();
    let best = null, bestScore = Infinity;

    focusables.forEach(el => {
      if (el === fromEl) return;
      const r = el.getBoundingClientRect();
      const dx = (r.left + r.right) / 2 - (cur.left + cur.right) / 2;
      const dy = (r.top + r.bottom) / 2 - (cur.top + cur.bottom) / 2;

      if (direction === 'right' && dx <= 4) return;
      if (direction === 'left'  && dx >= -4) return;
      if (direction === 'down'  && dy <= 4) return;
      if (direction === 'up'    && dy >= -4) return;

      const cross = (direction === 'left' || direction === 'right') ? Math.abs(dy) : Math.abs(dx);
      const dist = Math.hypot(dx, dy);
      const score = cross * 1000 + dist;

      if (score < bestScore) { bestScore = score; best = el; }
    });

    if (best) {
      best.focus({ preventScroll: true });
      if (best.select && (best.tagName === 'INPUT' || best.tagName === 'TEXTAREA')) {
        const len = best.value?.length ?? 0;
        best.setSelectionRange?.(len, len);
      }
    }
  }

  function focusNextPrev(fromEl, forward, container=document) {
    const list = getFocusable(container);
    const idx = list.indexOf(fromEl);
    const next = list[idx + (forward ? 1 : -1)];
    if (next) next.focus({ preventScroll: true });
  }

  document.addEventListener('keydown', (e) => {
  const active = document.activeElement;
  if (!active) return;

  // Nếu đang trong textarea thì để Enter hoạt động bình thường (xuống dòng)
  if (active.tagName === 'TEXTAREA') return;

  // Enter / Shift+Enter cho input, select
  if (e.key === 'Enter') {
    e.preventDefault();
    finalizeCurrency(active);
    focusNextPrev(active, !e.shiftKey);
    return;
  }

  // Arrow keys
  if (['ArrowRight','ArrowLeft','ArrowUp','ArrowDown'].includes(e.key)) {
    e.preventDefault();
    finalizeCurrency(active);
    if (e.key === 'ArrowRight') focusByDirection(active,'right');
    if (e.key === 'ArrowLeft')  focusByDirection(active,'left');
    if (e.key === 'ArrowUp')    focusByDirection(active,'up');
    if (e.key === 'ArrowDown')  focusByDirection(active,'down');
  }
}, true);


})();
// đảm bảo bất kỳ input decimal nào khi rời focus đều được format lại
document.addEventListener('focusout', (e) => {
  const t = e.target;
  if (t && t.getAttribute && t.getAttribute('inputmode') === 'decimal') {
    requestAnimationFrame(() => finalizeCurrency(t));
  }
}, true);



</script>
</body>
</html>  

<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kh√°ch H√†ng Tr·∫£ N·ª£ | T·ªïng kho H√† H√≤a</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* ===============================
   H√† H√≤a ‚Äì Clean Modern Theme
   =============================== */

:root {
  --primary:#22c55e;
  --secondary:#f59e0b;
  --danger:#ef4444;
  --bg:#f3f4f6;
  --card:#ffffff;
  --muted:#64748b;
  --border:#e5e7eb;
}

*{margin:0;padding:0;box-sizing:border-box;font-family:'Roboto',sans-serif;}
body{background:var(--bg);color:#111827;line-height:1.5;}

/* Container */
.container{
  max-width:1800px;margin:20px auto;padding:20px;
  background:var(--card);
  border-radius:16px;
  box-shadow:0 8px 24px rgba(0,0,0,.08);
  display:none;
}
.container.visible{display:block;}

/* Header gradient */
/* ===== Header (gradient, co gi√£n an to√†n, kh√¥ng absolute) ===== */
header{
  display:flex;
  align-items:center;
  flex-wrap:wrap;              /* h·∫πp th√¨ t·ª± xu·ªëng d√≤ng */
  gap:16px;
  margin-bottom:20px;
  padding:16px;
  border-radius:14px;
  background:linear-gradient(90deg,#6366f1,#22c55e,#f59e0b);
  color:#fff;
  border:none;
}

/* Logo */
header img{
  height:88px;
  width:88px;
  border-radius:50%;
  border:3px solid #fff;
  box-shadow:0 6px 16px rgba(0,0,0,.2);
  flex-shrink:0;
  object-fit:cover;
  order:1;
}

/* Th√¥ng tin li√™n h·ªá */
.contact-info{
  font-size:14px;
  line-height:1.4;
  order:2;
  min-width:220px;
}
.contact-info .address{font-weight:600;}
.contact-info .hotline{font-weight:700;color:#fff;}

/* Ti√™u ƒë·ªÅ (kh√¥ng absolute, ƒë·ªÉ trong flex) */
.header-title{
  order:3;
  flex:1;
  text-align:center;
  margin-inline:8px;
}
.header-title h1{font-size:26px;font-weight:800;letter-spacing:.2px;margin:0;}
.header-title h2{font-size:20px;font-weight:600;opacity:.95;margin:0;}

/* User info pill (kh√¥ng absolute, d·∫°t ph·∫£i b·∫±ng margin-left:auto) */
#user-info{
  order:4;
  margin-left:auto;
  background:#fff;
  color:#111827;
  padding:6px 12px;
  border-radius:999px;
  font-size:14px;
  font-weight:600;
  box-shadow:0 4px 12px rgba(0,0,0,.12);
  white-space:nowrap;
}
#logout-btn{color:var(--danger);margin-left:8px;text-decoration:none;}

/* Responsive cho m√†n h·∫πp */
@media (max-width: 768px){
  header img{height:72px;width:72px}
  .header-title{
    flex-basis:100%;
    order:4;           /* ti√™u ƒë·ªÅ xu·ªëng d∆∞·ªõi c√πng cho g·ªçn */
    margin-top:4px;
  }
  #user-info{ order:3; }  /* pill user n·∫±m c√πng h√†ng logo/ƒë·ªãa ch·ªâ */
  .header-title h1{font-size:20px}
  .header-title h2{font-size:16px}
}


/* Dashboard cards */
.dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;margin-bottom:20px;}
.dashboard-card{
  background:#fff;padding:16px;border-radius:14px;
  border-left:5px solid var(--primary);
  box-shadow:0 4px 12px rgba(0,0,0,.06);
}
.dashboard-card h3{font-size:14px;color:var(--muted);margin-bottom:6px;}
.dashboard-card p{font-size:20px;font-weight:700;color:var(--primary);}
.dashboard-card.summary{border-left-color:#0ea5e9;}
.dashboard-card.summary p{color:#0ea5e9;}

/* Table controls (filters + add) */
.table-controls{
  display:grid;gap:10px;margin-bottom:12px;
  background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px;
}
.filters-row{display:grid;grid-template-columns:120px repeat(auto-fit,minmax(160px,1fr));gap:8px;align-items:center;}
.filters-row .label{font-weight:700;color:#111827;display:flex;align-items:center;gap:6px;}
.filter-input{
  border:1px solid var(--border);border-radius:999px;
  padding:6px 10px;font-size:13px;
}

/* Add panel */
.add-panel{border:1px dashed var(--border);border-radius:10px;padding:10px;background:#fafafa;}
.add-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:8px;margin-top:6px;}
.add-grid .field label{font-size:12px;font-weight:600;color:#374151;margin-bottom:4px;}
.add-grid .field input,.add-grid .field select{
  border:1px solid var(--border);border-radius:8px;padding:8px;font-size:13px;
}

/* Table */
/* Table (cho ph√©p k√©o gi√£n c·ªôt) */
.table-container{overflow:auto;max-height:65vh;background:#fff;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.06);}
table{
  border-collapse:collapse;
  font-size:13px;
  width:max-content;     /* cho ph√©p n·ªü ngang khi k√©o */
  min-width:100%;        /* kh√¥ng nh·ªè h∆°n khung */
  table-layout:fixed;    /* gi·ªØ width ƒë√£ set cho c·ªôt */
}
thead th{
  position:sticky; top:0; background:#22c55e; color:#fff;
  font-weight:700; padding:8px; text-align:center; white-space:nowrap;
}
/* Fix sticky header lu√¥n n·ªïi tr√™n resizer v√† tbody */
.table-container { 
  position: relative;             /* t·∫°o stacking context cho thead */
}

.table-container table thead {
  position: sticky;
  top: 0;
  z-index: 150;                   /* cao h∆°n tbody/resizer */
  background: #22c55e;            /* tr√πng m√†u header c·ªßa b·∫°n */
}

.table-container table thead th {
  position: sticky;
  top: 0;
  z-index: 160;                   /* cao h∆°n thead & .col-resizer (z-index:99) */
  background: #22c55e;            /* tr√°nh l·ªô n·ªÅn khi cu·ªôn */
}

thead th + th{ box-shadow:-1px 0 0 rgba(255,255,255,.45) inset; }

/* Tay n·∫Øm k√©o c·ªôt */
.col-resizer{
  position:absolute; top:0; right:0; bottom:0;
  width:12px; cursor:col-resize; user-select:none; z-index:99;
}
.col-resizer::after{
  content:''; position:absolute; right:5px; top:20%; bottom:20%;
  width:2px; background:#e5e7eb;
}

tbody td{padding:8px;border-bottom:1px solid #f1f5f9;}
tbody tr:nth-child(even){background:#fafafa;}
tbody tr:hover{background:#fffbe6;}
tfoot td {
  background:#f0fdf4;
  font-weight:800;
  padding:8px;
  color:#065f46;
  text-transform:uppercase;   /* In hoa ch·ªØ */
  text-align:center;          /* CƒÉn gi·ªØa */
  letter-spacing: .5px;       /* Kho·∫£ng c√°ch ch·ªØ ƒë·∫πp h∆°n */
}
tfoot td:first-child {
  white-space: nowrap;   /* kh√¥ng cho xu·ªëng d√≤ng */
  text-align: center;    /* cƒÉn gi·ªØa */
}


/* Inputs trong b·∫£ng */
tbody td input,tbody td select,tbody td textarea{
  width:100%;border:none;background:transparent;padding:6px;font-size:13px;
}
.align-left{text-align:left}.align-right{text-align:right}.align-center{text-align:center}

/* Buttons */
.action-btn{
  border:none;border-radius:8px;padding:8px 12px;
  font-size:13px;font-weight:600;cursor:pointer;
  display:inline-flex;align-items:center;gap:6px;color:#fff;
}
.update-btn{background:#f59e0b;}
.export-btn{background:#1d6f42;}
.update-btn:disabled{background:#ccc;cursor:not-allowed;}

/* Delete button */
.delete-btn{cursor:pointer;color:var(--danger);font-size:16px;font-weight:700;}
.delete-btn:hover{color:#a11;}

/* Login overlay */
#login-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:1000;}
#login-box{background:#fff;padding:30px;border-radius:12px;max-width:350px;width:100%;box-shadow:0 12px 28px rgba(0,0,0,.25);}
#login-box h2{margin-bottom:20px;color:var(--primary);}
.input-group{margin-bottom:16px;}
.input-group label{display:block;margin-bottom:4px;font-weight:600;}
.input-group input{width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;}
#login-btn{width:100%;padding:10px;border:none;border-radius:8px;background:var(--primary);color:#fff;font-weight:700;}

/* Toast */
#toast-container{position:fixed;bottom:20px;right:20px;display:flex;flex-direction:column;gap:10px;z-index:2000;}
.toast{padding:10px 16px;border-radius:8px;color:#fff;font-weight:600;box-shadow:0 4px 12px rgba(0,0,0,.2);}
.toast.success{background:#22c55e}.toast.error{background:#ef4444}.toast.warning{background:#f59e0b}

/* --- T√ÅCH KH·ªêI: Filters v√† Add-panel l√† 2 card ri√™ng --- */
.table-controls{
  background: transparent;
  border: 0;
  box-shadow: none;
  padding: 0; /* b·ªè padding b·ªçc ngo√†i ƒë·ªÉ h·∫øt kho·∫£ng tr·∫Øng */
}

/* Card cho kh·ªëi T√¨m ki·∫øm (g·∫≠p/m·ªü) */
.table-controls .filters-panel{
  background:#fff;
  border:1px solid rgba(2,6,23,.06);
  border-radius:14px;
  box-shadow:0 6px 16px rgba(2,6,23,.06);
  padding:8px 10px;
  margin-bottom:10px;
}

/* Header c√≥ icon k√≠nh l√∫p, b·∫•m ƒë·ªÉ g·∫≠p/m·ªü */
.filters-panel > summary.search-label{
  list-style:none;
  cursor:pointer;
  font-weight:800;
  color:#111827;
  display:flex;
  align-items:center;
  gap:6px;
  padding:6px 2px;
  margin-bottom:6px;
}
.filters-panel > summary.search-label::before{
  content:"";
  display:inline-flex;
  width:16px; height:16px;
  mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='black' viewBox='0 0 512 512'%3E%3Cpath d='M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352a144 144 0 1 0 0-288 144 144 0 1 0 0 288z'/%3E%3C/svg%3E") center / contain no-repeat;
  background:#111827;
  opacity:.7;
}
.filters-panel > summary.search-label::after{
  content:"‚ñæ";
  margin-left:auto;
  transition:transform .15s ease;
  opacity:.6;
}
.filters-panel[open] > summary.search-label::after{ transform:rotate(180deg); }

/* L∆∞·ªõi filter g·ªçn, kh√¥ng tr√†n */
.filters-grid{
  display:grid;
  gap:10px;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
}
.filters-grid .field{
  display:flex;
  flex-direction:column;
  gap:4px;
  min-width:0;
}
.filters-grid .field label{
  font-size:11px;
  font-weight:800;
  letter-spacing:.2px;
  text-transform:uppercase;
  color:#334155;
  background:#f1f5f9;
  border:1px solid #e2e8f0;
  border-radius:999px;
  padding:4px 8px;
  width:max-content;
}
.filters-grid .field .filter-input{
  width:100%;
  border:1px solid var(--border);
  background:#fff;
  height:32px;
  font-size:13px;
  padding:6px 10px;
  border-radius:10px;
}

/* Card cho kh·ªëi Th√™m thanh to√°n */
.table-controls .add-panel{
  background:#fff;
  border:1px dashed var(--border);
  border-radius:12px;
  box-shadow:0 4px 12px rgba(2,6,23,.05);
  padding:10px;
}

/* Ti√™u ƒë·ªÅ + N√∫t Th√™m n·∫±m tr√™n c√πng, n√∫t ·ªü b√™n ph·∫£i */
.add-panel > summary{
  list-style:none;
  cursor:default;
  display:flex;
  align-items:center;
  gap:10px;
  padding:6px 2px;
  margin-bottom:6px;
}
.add-panel > summary .title{
  display:inline-flex;
  align-items:center;
  gap:8px;
  font-weight:800;
  color:#111827;
}
.add-panel > summary .title::before{
  content:"+";
  display:inline-grid;
  place-items:center;
  width:20px; height:20px;
  border-radius:6px;
  background:#22c55e; color:#fff;
  font-weight:900; font-size:14px;
}
.add-panel .add-btn-inline{
  margin-left:auto;        /* ƒë·∫©y n√∫t sang ph·∫£i */
  height:28px;
  padding:0 10px;
  border-radius:8px;
  font-size:13px;
  border:none;
  background:#f59e0b;
  color:#fff;
  display:inline-flex;
  align-items:center;
  gap:6px;
}
/* N·∫øu kh√¥ng mu·ªën icon + trong n√∫t, ·∫©n ƒëi */
.add-panel .add-btn-inline i{ display:none; }

.add-grid{ display:grid; gap:10px; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); }
.add-grid .field label{
  font-size:12px;font-weight:600;color:#374151;margin-bottom:4px;
}
.add-grid .field input,.add-grid .field select{
  border:1px solid var(--border); border-radius:8px; padding:8px; font-size:13px;
}
#max-debt-control-card { display: none !important; }
/* --- Ti√™u ƒë·ªÅ b·∫£ng + c·ª•m n√∫t Save/Export n·∫±m c√πng h√†ng, n√∫t s√°t ph·∫£i --- */
.table-title{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  margin:12px 0;
}
.table-title h2{
  margin:0;
  font-size:20px;
  font-weight:800;
}
.table-title .controls-wrapper{
  margin-left:auto;          /* ƒë·∫©y c·ª•m n√∫t sang ph·∫£i */
  display:flex;
  align-items:center;
  gap:10px;
}
#count-khtn{ display:none; } /* ·∫®n d·∫•u "..." */
/* Kho·∫£ng c√°ch gi·ªØa c·ª•m filters (tr√™n) v√† ti√™u ƒë·ªÅ b·∫£ng (d∆∞·ªõi) */
#filters-khtn .table-controls{
  margin-bottom: 12px;
}
    </style>
</head>

<body>
    <div id="login-overlay">
        <div id="login-box">
            <h2>ƒêƒÉng Nh·∫≠p H·ªá Th·ªëng</h2>
            <form id="login-form">
                <div class="input-group"> <label for="username">T√™n ƒëƒÉng nh·∫≠p</label> <input type="text" id="username" required> </div>
                <div class="input-group"> <label for="password">M·∫≠t kh·∫©u</label> <input type="password" id="password" required> </div>
                <button type="submit" id="login-btn">ƒêƒÉng Nh·∫≠p</button>
                <p id="login-error"></p>
            </form>
        </div>
    </div>

    <div class="container">
        <header>
            <div id="user-info"></div>
            <img alt="Logo" src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Ff6c823b5.%E1%BA%A2nh.094646.jpg" />
            <div class="contact-info">
                <div class="address">ƒê·ªãa ch·ªâ : S·ªë 46 - Thanh L≈©ng - Qu·∫£ng oai - TP H√† N·ªôi</div>
                <div class="hotline">Hotline : 0969.250.323</div>
            </div>
            <div class="header-title">
                <h1>Nh√† Ph√¢n Ph·ªëi H√† Ho√†</h1>
                <h2>B·∫£ng Kh√°ch H√†ng Tr·∫£ N·ª£</h2>
            </div>
        </header>

        <div class="dashboard">
            <div class="dashboard-card"> <h3>T·ªïng Ti·ªÅn N·ª£</h3> <p id="dashboard-total-no">0</p> </div>
            <div class="dashboard-card"> <h3>T·ªïng Ti·ªÅn ƒê√£ Tr·∫£</h3> <p id="dashboard-total-tra">0</p> </div>
            <div class="dashboard-card"> <h3>Gi√° Tr·ªã H√†ng Thu H·ªìi</h3> <p id="dashboard-total-thuhoi">0</p> </div>
            <div class="dashboard-card summary"> <h3>T·ªïng C√¥ng N·ª£ Cu·ªëi C√πng</h3> <p id="dashboard-total-conlai">0</p> </div>
            <div class="dashboard-card" id="max-debt-control-card" style="grid-column: 1 / -1; border-left-color: var(--error-color);">
                <h3 style="color: var(--error-color);">Ki·ªÉm So√°t H·∫°n M·ª©c N·ª£</h3>
                <div style="display: flex; align-items: center; gap: 20px; margin-top: 10px; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 200px;">
                        <label for="max-debt-input" style="font-weight: 500; font-size: 14px; display: block; margin-bottom: 5px;">H·∫°n M·ª©c N·ª£ T·ªëi ƒêa C·ªßa T·ª´ng Kh√°ch H√†ng(VNƒê)</label>
                        <input type="text" id="max-debt-input" placeholder="Nh·∫≠p h·∫°n m·ª©c..." style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                    <div style="flex: 1; min-width: 200px;">
                        <label for="custom-debt-term-input" style="font-weight: 500; font-size: 14px; display: block; margin-bottom: 5px;">S·ªë Ng√†y N·ª£ T·ªëi ƒêa C·ªßa T·ª´ng Kh√°ch H√†ng</label>
                        <input type="number" id="custom-debt-term-input" placeholder="Nh·∫≠p s·ªë ng√†y..." style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                    
                    <div id="current-customer-debt-display" style="display: none; flex: 1; min-width: 200px; background-color: #f0f0f0; padding: 8px; border-radius: 4px;">
                        <p style="margin: 0; font-size: 14px; color: #333;">N·ª£ hi·ªán t·∫°i c·ªßa KH:</p>
                        <p id="current-customer-debt-value" style="margin: 0; font-size: 20px; font-weight: 700; color: var(--secondary-color);">0 VNƒê</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="main-content-khtn">
            <div id="filters-khtn"></div>
            <div class="table-title">
                <h2>B·∫£ng Kh√°ch H√†ng Tr·∫£ N·ª£</h2>
                <div class="controls-wrapper">
                    <span id="count-khtn" class="record-count">...</span>
                    <button id="update-btn-khtn" class="update-btn action-btn" disabled><i class="fas fa-save"></i> L∆∞u Thay ƒê·ªïi</button>
                    <button class="export-btn action-btn" data-table-key="khtn"><i class="fas fa-file-excel"></i> T·∫£i Excel</button>
                </div>
            </div>
            <div class="table-container" id="container-khtn">
                <p class="status-indicator">ƒêang t·∫£i d·ªØ li·ªáu...</p>
            </div>
        </div>

        <footer>
            <p>&copy; 2023 - H·ªá th·ªëng qu·∫£n l√Ω T·ªïng kho H√† H√≤a</p>
        </footer>
    </div>

    <div id="toast-container"></div>
    <datalist id="customer-list-options"></datalist>
    <datalist id="sales-person-list-options"></datalist>
    <datalist id="debt-list-options"></datalist>
<script>
  const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbwZ73GdTFsSitoVqJKiZKIbU3wHM_qpjxQEbhlKTwi1V9GijNC8SPoRH9vVDD65xb9x/exec';
  const TABLE_CONFIG = {
      'khn': { name: 'Kh√°ch H√†ng N·ª£', loaded: false, totalField: 'S·ªë ti·ªÅn n·ª£' },
      'khtn': { name: 'Kh√°ch h√†ng tr·∫£ n·ª£', containerId: 'container-khtn', countId: 'count-khtn', loaded: false, totalField: 'S·ªë ti·ªÅn tr·∫£ n·ª£' },
      'hth': { name: 'H√†ng thu h·ªìi', loaded: false, totalField: 'Th√†nh ti·ªÅn' },
  };

  /* ‚úì th√™m √°nh x·∫° cho c·∫£ hai t√™n c·ªôt ƒë·ªÉ hi·ªÉn th·ªã ƒë·ªìng nh·∫•t */
  const headerMapping = {
    'Giao h√†ng cho n·ª£': 'NV Giao h√†ng',
    'Giao h√†ng nh·∫≠n ti·ªÅn': 'NV Giao h√†ng',  // ‚Üê th√™m d√≤ng n√†y
    'Ng∆∞·ªùi ch·ªãu tr√°ch nhi·ªám': 'NV Kinh doanh(Ch·ªãu Tr√°ch Nhi·ªám)',
    'id n·ª£': 'ID N·ª£ G·ªëc',
    'S·ªë ti·ªÅn tr·∫£ n·ª£': 'S·ªë ti·ªÅn kh√°ch tr·∫£',
    'S·ªë ti·ªÅn n·ª£': 'S·ªë ti·ªÅn c√≤n n·ª£'
  };

  const HIDDEN_COLUMNS = ['id', 'id n·ª£'];
  const GIAO_HANG_NV_LIST = ['Hoa', 'Phong', 'minh', 'duy', 'Tu·∫•n L√°i xe', 'H√† (Nam)', 'Xuy·∫øn', 'Ho√†', 'H·∫°nh', 'H√† (N·ªØ)'];
  const NUMERIC_COLUMNS_FOR_TOTAL = ['S·ªë ti·ªÅn n·ª£', 'Th√†nh ti·ªÅn', 'S·ªë ti·ªÅn tr·∫£ n·ª£', 'ƒê∆°n gi√°', 'S·ªë l∆∞·ª£ng'];

  // === PH√ÇN QUY·ªÄN (ADD) ===
  const ALLOWED_CREATORS = ['hoa','hanh','xuyen']; // ch·ªâ 3 ng∆∞·ªùi n√†y ƒë∆∞·ª£c th√™m m·ªõi
  let currentPerms = { canCreate: false, canEditExisting: false, canDelete: false, isViewer: true };

  function normalizeVi(str='') {
    return str.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
  }
  function computePerms(displayName) {
  const session = JSON.parse(sessionStorage.getItem('loggedInUser') || '{}');
  const username = normalizeVi(session?.username || '');
  const name = normalizeVi(displayName || '');
  const isAdmin = username === 'admin' || name === 'admin';

  const canCreate = isAdmin || ALLOWED_CREATORS.includes(name);
  return {
    canCreate,
    canEditExisting: isAdmin,  // ‚úÖ Admin s·ª≠a d√≤ng c≈©
    canDelete: isAdmin,        // ‚úÖ Admin xo√° d√≤ng c≈©
    isViewer: !(canCreate || isAdmin)
  };
}

  function applyPermissions(tableKey) {
  const perms = currentPerms;
  const cfg = TABLE_CONFIG[tableKey];
  if (!cfg || !cfg.containerId) return;

  // N√∫t L∆∞u
  const saveBtn = document.getElementById(`update-btn-${tableKey}`);
  if (saveBtn) {
    saveBtn.style.display = perms.isViewer ? 'none' : 'inline-flex';
    saveBtn.disabled = perms.isViewer;
  }

  // container c·ªßa b·∫£ng + host c·ªßa filters
  const container = document.getElementById(cfg.containerId);
  const host = document.getElementById(`filters-${tableKey}`);
  if (!container) return;

  // ·∫®n/hi·ªán n√∫t "Th√™m theo KH" (n·∫±m trong host m·ªõi)
  const addBtn = (host || container).querySelector(`#btn-add-${tableKey}`);
  if (addBtn) addBtn.style.display = perms.canCreate ? '' : 'none';

  // Kho√° edit c√°c d√≤ng d·ªØ li·ªáu c≈©
  container.querySelectorAll('tbody tr[data-id]').forEach(tr => {
    const controls = tr.querySelectorAll('input, select, textarea');
    controls.forEach(el => {
      if (!perms.canEditExisting) {
        if (el.tagName === 'SELECT') el.setAttribute('disabled', 'disabled');
        else el.setAttribute('readonly', 'readonly');
      }
    });
  });

  // ·∫®n t·∫•t c·∫£ n√∫t xo√°
  container.querySelectorAll('.delete-btn:not(.temp-delete-btn)').forEach(btn => {
  btn.style.display = perms.canDelete ? '' : 'none';
});

}

  // === H·∫æT PH√ÇN QUY·ªÄN (ADD) ===

  let originalTableData = {};
  let changeSet = { create: {}, update: {}, delete: {} };
  let nhanSuList = [];
  let tempSelectedDebtIds = [];

  /* ‚úì helper: tr·∫£ v·ªÅ t√™n c·ªôt giao h√†ng ƒëang t·ªìn t·∫°i trong Sheet */
  function giaoHangHeader() {
    const hs = originalTableData['khtn']?.headers || [];
    return hs.includes('Giao h√†ng nh·∫≠n ti·ªÅn') ? 'Giao h√†ng nh·∫≠n ti·ªÅn' : 'Giao h√†ng cho n·ª£';
  }

  function calculateRemainingDebts() {
      const khnData = originalTableData['khn']?.data;
      if (!khnData) return;
      const paidAmounts = {};
      (originalTableData['khtn']?.data || []).forEach(p => { paidAmounts[p['id n·ª£']] = (paidAmounts[p['id n·ª£']] || 0) + (parseFloat(String(p['S·ªë ti·ªÅn tr·∫£ n·ª£'] || '0').replace(/\./g, '')) || 0); });
      Object.values(changeSet.create['khtn'] || {}).forEach(p => { paidAmounts[p['id n·ª£']] = (paidAmounts[p['id n·ª£']] || 0) + (parseFloat(String(p['S·ªë ti·ªÅn tr·∫£ n·ª£'] || '0').replace(/\./g, '')) || 0); });
      
      khnData.forEach(debt => {
          const totalDebt = parseFloat(String(debt['S·ªë ti·ªÅn n·ª£'] || '0').replace(/\./g, '')) || 0;
          const totalPaid = paidAmounts[debt.id] || 0;
          debt._conLai = totalDebt - totalPaid;
      });
      updateDebtDatalist();
  }

  function updateDebtDatalist() {
      const debtDatalist = document.getElementById('debt-list-options');
      const khnData = originalTableData['khn']?.data;
      if (!khnData || !debtDatalist) return;
      const customerNamesWithDebt = new Set(
          khnData.filter(debt => debt._conLai > 0).map(debt => debt['T√™n Kh√°ch H√†ng'])
      );
      debtDatalist.innerHTML = Array.from(customerNamesWithDebt).sort((a, b) => a.localeCompare(b, 'vi'))
          .map(name => `<option value="${name}"></option>`).join('');
  }

  function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => { toast.remove(); }, 5000);
  }
  
  function createCellInput(originalHeader, value) {
      const formattedValue = value ?? '';
      let inputHtml = '';
      const readonlyAttr = (['ƒê·ªãa ch·ªâ', 'Khu v·ª±c', 'SƒêT', 'S·ªë ti·ªÅn n·ª£', 'Ng√†y n·ª£', 'S·ªë ng√†y'].includes(originalHeader)) ? 'readonly' : '';

      // KHTN ‚Äî map 'T√™n Kh√°ch H√†ng' theo id n·ª£ n·∫øu c√≥ (gi·ªØ nguy√™n logic c≈©)
      if (originalHeader === 'T√™n Kh√°ch H√†ng') {
        const khn = originalTableData['khn']?.data || [];
        const debt = khn.find(d => String(d.id) === String(value));
        const displayValue = debt ? (debt['T√™n Kh√°ch H√†ng'] || '') : (value || '');
        inputHtml = `<input type="text" data-field="${originalHeader}" value="${displayValue}" readonly>`;
      
      } else if (['ƒê·ªãa ch·ªâ', 'Khu v·ª±c', 'Ghi ch√∫'].includes(originalHeader)) {
        inputHtml = `<textarea data-field="${originalHeader}" ${readonlyAttr}>${formattedValue}</textarea>`;

      /* ‚úì ƒë·ªïi sang input text cho c·∫£ hai t√™n c·ªôt giao h√†ng */
      } else if (originalHeader === 'Giao h√†ng cho n·ª£' || originalHeader === 'Giao h√†ng nh·∫≠n ti·ªÅn') {
        inputHtml = `<input type="text" data-field="${originalHeader}" value="${formattedValue}">`;

      } else if (originalHeader === 'Ng∆∞·ªùi ch·ªãu tr√°ch nhi·ªám') {
        inputHtml = `<input type="text" list="sales-person-list-options" data-field="${originalHeader}" value="${formattedValue}">`;
      } else if (['Ng√†y tr·∫£', 'Ng√†y n·ª£'].includes(originalHeader)) {
        inputHtml = `<input type="date" data-field="${originalHeader}" value="${formatDateForInput(formattedValue)}" ${readonlyAttr}>`;
      } else if (['S·ªë ti·ªÅn tr·∫£ n·ª£', 'S·ªë ti·ªÅn n·ª£'].includes(originalHeader)) {
        const numericValue = (Number(String(formattedValue).replace(/\./g, '')) || 0).toLocaleString('vi-VN');
        inputHtml = `<input type="text" inputmode="decimal" data-field="${originalHeader}" value="${numericValue}" ${readonlyAttr}>`;
      } else if (originalHeader === 'SƒêT') {
        inputHtml = `<input type="tel" data-field="${originalHeader}" value="${formattedValue}" ${readonlyAttr} placeholder="S·ªë ƒëi·ªán tho·∫°i...">`;
      } else {
        inputHtml = `<input type="text" data-field="${originalHeader}" value="${formattedValue}" ${readonlyAttr}>`;
      }
      return `<td>${inputHtml}</td>`;
  }

  /* ==== Toolbox (t√¨m ki·∫øm + th√™m theo KH) ==== */
  /* ==== Toolbox (t√¨m ki·∫øm + th√™m theo KH) ==== */
function createExternalControls(tableKey, displayedHeaders) {
  const cfg = TABLE_CONFIG[tableKey];
  if (!cfg) return;

  // Host cho filters n·∫±m TR√äN ti√™u ƒë·ªÅ
  const host = document.getElementById(`filters-${tableKey}`);
  if (!host) return;

  // Ch·ªâ t·∫°o 1 l·∫ßn
  if (host.querySelector('.table-controls')) return;

  const controls = document.createElement('div');
  controls.className = 'table-controls';

  const filters = document.createElement('details');
  filters.className = 'filters-panel';
  filters.open = true;
  filters.innerHTML = `
    <summary class="search-label">T√¨m ki·∫øm</summary>
    <div class="filters-grid">
      ${displayedHeaders.map(h => {
        const ph = headerMapping[h] || h;
        return `
          <div class="field">
            <label>${ph}</label>
            <input class="filter-input" data-header="${h}" placeholder="${ph}...">
          </div>`;
      }).join('')}
    </div>
  `;

  const addPanel = document.createElement('details');
  addPanel.className = 'add-panel';
  addPanel.open = true;
  addPanel.innerHTML = `
    <summary>
      <span class="title">Th√™m thanh to√°n theo Kh√°ch H√†ng</span>
      <button type="button" id="btn-add-${tableKey}" class="add-btn-inline">
        <i class="fa fa-plus"></i> Th√™m theo KH
      </button>
    </summary>

    <div class="add-grid">
      <div class="field">
        <label>Kh√°ch H√†ng (ch·ªâ hi·ªÉn th·ªã KH c√≤n n·ª£)</label>
        <input id="ext-khtn-customer" type="text" list="debt-list-options" placeholder="Ch·ªçn KH c√≥ n·ª£...">
      </div>
    </div>
  `;

  controls.appendChild(filters);
  controls.appendChild(addPanel);
  host.appendChild(controls);

  // L·ªçc
  controls.querySelectorAll('.filter-input').forEach(inp => {
    inp.addEventListener('input', () => filterTable(tableKey));
  });

  // Th√™m theo KH
  const khInput = controls.querySelector('#ext-khtn-customer');
  const addBtn  = controls.querySelector(`#btn-add-${tableKey}`);
  const triggerAdd = () => {
    const val = (khInput.value || '').trim();
    if (!val) { showToast('Vui l√≤ng ch·ªçn Kh√°ch H√†ng c√≤n n·ª£.', 'warning'); return; }
    handleCustomerNameSelectForPayment({ target: { value: val } });
    khInput.value = '';
  };
  addBtn.addEventListener('click', (e) => { e.stopPropagation(); triggerAdd(); });
  khInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') { e.preventDefault(); triggerAdd(); }
  });
}


  function renderTable(tableKey, data) {
      const config = TABLE_CONFIG[tableKey];
      const container = document.getElementById(config.containerId);
      if (!container) return;
      if (!data.data || !data.headers) { container.innerHTML = '<p class="status-indicator">Kh√¥ng c√≥ d·ªØ li·ªáu.</p>'; return; }
       container.innerHTML = '';
      let localHiddenColumns = [...HIDDEN_COLUMNS, 'Ng√†y n·ª£', 'S·ªë ng√†y'];
      const headers = data.headers;
      const displayedHeaders = headers.filter(h => !localHiddenColumns.includes(h));

      createExternalControls(tableKey, displayedHeaders);

      const headerHtml = `
        <thead>
          <tr>
            <th style="width:120px; min-width:120px; text-align:center;">X√≥a</th>
            ${displayedHeaders.map(h => `<th data-field="${h}">${headerMapping[h] || h}</th>`).join('')}
          </tr>
        </thead>`;

      const bodyHtml = `<tbody>${
          data.data.map(row => { 
              const rId = row['id']; 
              const cH = headers.map(h => {
                  if (localHiddenColumns.includes(h)) return `<td style="display: none;">${row[h] || ''}</td>`;
                  return createCellInput(h, row[h]);
              }).join('');
              return `<tr data-id="${rId}" data-id-no="${row['id n·ª£'] || ''}">
                        <td class="align-center"><span class="delete-btn" data-id="${rId}">&#10006;</span></td>
                        ${cH}
                      </tr>`;
          }).join('')
      }</tbody>`;

      const tableEl = document.createElement('table');
      tableEl.innerHTML = `${headerHtml}${bodyHtml}<tfoot></tfoot>`;
      container.appendChild(tableEl);

      makeColumnsResizable(tableEl);
      setupEventListeners(tableKey, container);

      updateTotals(tableKey);
      applyPermissions(tableKey);
  }
  
  function updateVisibleRowCount(tableKey) {
      const config = TABLE_CONFIG[tableKey];
      const container = document.getElementById(config.containerId);
      if (!container || !config.countId) return;
      const visibleRows = container.querySelectorAll('tbody tr:not([style*="display: none"])');
      document.getElementById(config.countId).textContent = `${visibleRows.length} b·∫£n ghi`;
  }

  function updateTotals(tableKey) {
      const container = document.getElementById(TABLE_CONFIG[tableKey].containerId); if (!container) return;
      const table = container.querySelector('table'); if (!table) return;
      const tfoot = table.querySelector('tfoot'); if (!tfoot) return;
      const headers = Array.from(table.querySelectorAll('thead tr:first-child th')).slice(1).map(th => Object.keys(headerMapping).find(key => headerMapping[key] === th.textContent) || th.textContent);
      const visibleRows = Array.from(table.querySelectorAll('tbody tr')).filter(row => row.style.display !== 'none');
      let totalRowHtml = '<td>T·ªïng c·ªông</td>';
      headers.forEach(header => {
          if (NUMERIC_COLUMNS_FOR_TOTAL.includes(header)) {
              const total = visibleRows.reduce((sum, row) => { const input = row.querySelector(`[data-field="${header}"]`); return sum + (parseFloat((input ? input.value || '0' : '0').replace(/\./g, '')) || 0); }, 0);
              totalRowHtml += `<td class="align-right">${total.toLocaleString('vi-VN')}</td>`;
          } else { totalRowHtml += '<td></td>'; }
      });
      tfoot.innerHTML = `<tr>${totalRowHtml}</tr>`;
  }

  function handleCustomerNameSelectForPayment(e) {
  if (!currentPerms.canCreate) {
    showToast('B·∫°n kh√¥ng c√≥ quy·ªÅn th√™m m·ªõi.', 'error');
    if (e.target && 'value' in e.target) e.target.value = '';
    return;
  }

  const customerName = (e.target?.value || '').trim();
  if (!customerName) return;

  const khnData = originalTableData['khn']?.data || [];
  const outstandingDebts = khnData.filter(d =>
    d['T√™n Kh√°ch H√†ng'] === customerName &&
    (d._conLai ?? 0) > 0 &&
    !tempSelectedDebtIds.includes(d.id)
  );
  if (outstandingDebts.length === 0) {
    showToast(`Kh√¥ng t√¨m th·∫•y kho·∫£n n·ª£ n√†o c√≤n l·∫°i cho "${customerName}".`, 'warning');
    if (e.target && 'value' in e.target) e.target.value = '';
    return;
  }

  // üîë Ch·ªâ g·ªôp khi 7 tr∆∞·ªùng ƒë·ªÅu gi·ªëng nhau
  const ghCol = giaoHangHeader(); // 'Giao h√†ng nh·∫≠n ti·ªÅn' ho·∫∑c 'Giao h√†ng cho n·ª£'
  const groups = {};
  for (const debt of outstandingDebts) {
    const key = [
      debt['T√™n Kh√°ch H√†ng'] || '',
      debt['Khu v·ª±c'] || '',
      debt['ƒê·ªãa ch·ªâ'] || '',
      debt['SƒêT'] || '',
      debt[ghCol] || '',
      debt['Ng∆∞·ªùi ch·ªãu tr√°ch nhi·ªám'] || '',
      debt['Ghi ch√∫'] || ''
    ].map(v => String(v).trim().toLowerCase()).join('||');

    if (!groups[key]) groups[key] = [];
    groups[key].push(debt);
  }

  Object.values(groups).forEach(debts => {
    const nvkd = debts[0]['Ng∆∞·ªùi ch·ªãu tr√°ch nhi·ªám'] || '(Ch∆∞a g√°n NVKD)';
    addPaymentRowForGroup(customerName, nvkd, debts);
  });

  if (e.target && 'value' in e.target) e.target.value = '';
}


  function addPaymentRowForGroup(customerName, nvkd, debts) {
  const tableKey = 'khtn';
  const headers = originalTableData[tableKey].headers;

  const ids = debts.map(d => d.id);
  const tongConLai = debts.reduce((s, d) => s + (d._conLai || 0), 0);

  tempSelectedDebtIds.push(...ids);
  calculateRemainingDebts();

  const tempId = crypto.randomUUID();
  const rowData = {};
  headers.forEach(h => rowData[h] = '');

  const ghCol = giaoHangHeader(); // ‚úÖ

  rowData['id'] = tempId;
  rowData['id n·ª£'] = ids.join(',');
  rowData['T√™n Kh√°ch H√†ng'] = customerName;
  rowData['Khu v·ª±c'] = debts[0]['Khu v·ª±c'] || '';
  rowData['ƒê·ªãa ch·ªâ'] = debts[0]['ƒê·ªãa ch·ªâ'] || '';
  rowData['SƒêT'] = debts[0]['SƒêT'] || '';
  rowData['S·ªë ti·ªÅn n·ª£'] = tongConLai;
  rowData['Ng√†y n·ª£'] = '';
  rowData[ghCol] = debts[0][ghCol] || '';     // ‚úÖ copy ƒë√∫ng NV Giao h√†ng
  rowData['Ng∆∞·ªùi ch·ªãu tr√°ch nhi·ªám'] = nvkd;
  rowData['Ghi ch√∫'] = debts[0]['Ghi ch√∫'] || ''; // ‚úÖ copy ƒë√∫ng Ghi ch√∫
  rowData['Ng√†y tr·∫£'] = formatDateForServer(new Date());
  rowData['S·ªë ti·ªÅn tr·∫£ n·ª£'] = '';

  if (!changeSet.create[tableKey]) changeSet.create[tableKey] = {};
  changeSet.create[tableKey][tempId] = rowData;

  const newTr = document.createElement('tr');
  newTr.dataset.id = tempId;
  newTr.dataset.idNo = rowData['id n·ª£'] || '';
  newTr.classList.add('row-new');

  let localHiddenColumns = [...HIDDEN_COLUMNS, 'Ng√†y n·ª£', 'S·ªë ng√†y'];
  const cellsHtml = headers.map(h => {
    if (localHiddenColumns.includes(h)) return `<td style="display: none;"></td>`;
    return createCellInput(h, rowData[h]);
  }).join('');

  newTr.innerHTML = `<td class="align-center"><span class="delete-btn temp-delete-btn" data-id="${tempId}">&#10006;</span></td>` + cellsHtml;
  newTr.querySelectorAll('input[inputmode="decimal"]').forEach(inp => setupCurrencyInput(inp, 'khtn'));

  const container = document.getElementById(TABLE_CONFIG[tableKey].containerId);
  const tbody = container.querySelector('tbody');
  tbody.insertBefore(newTr, tbody.firstChild);

  setChangesMade(tableKey, true);
  updateTotals(tableKey);
  updateDashboard();
  updateVisibleRowCount(tableKey);
}


  function addPaymentRowForDebt(debt) {
      const tableKey = 'khtn';
      const headers = originalTableData[tableKey].headers;
      const rowData = {};
      rowData['id n·ª£'] = debt.id;
      rowData['T√™n Kh√°ch H√†ng'] = debt['T√™n Kh√°ch H√†ng'];
      rowData['Khu v·ª±c'] = debt['Khu v·ª±c'];
      rowData['ƒê·ªãa ch·ªâ'] = debt['ƒê·ªãa ch·ªâ'];
      rowData['SƒêT'] = debt['SƒêT'];
      rowData['S·ªë ti·ªÅn n·ª£'] = debt['S·ªë ti·ªÅn n·ª£'];
      rowData['Ng√†y n·ª£'] = formatDateForServer(debt['Ng√†y n·ª£']);
      /* ‚úì d√πng ƒë√∫ng t√™n c·ªôt c√≥ s·∫µn, fallback n·∫øu kh√°c t√™n */
      const ghCol = giaoHangHeader();
      rowData[ghCol] = debt[ghCol] ?? debt['Giao h√†ng cho n·ª£'] ?? debt['Giao h√†ng nh·∫≠n ti·ªÅn'] ?? '';
      rowData['Ng∆∞·ªùi ch·ªãu tr√°ch nhi·ªám'] = debt['Ng∆∞·ªùi ch·ªãu tr√°ch nhi·ªám'];
      rowData['Ng√†y tr·∫£'] = formatDateForServer(new Date());
      rowData['S·ªë ti·ªÅn tr·∫£ n·ª£'] = debt._conLai;
if (rowData['Ng√†y tr·∫£'] && debt['Ng√†y n·ª£']) {
    const diffTime = Math.abs(new Date(rowData['Ng√†y tr·∫£']) - new Date(debt['Ng√†y n·ª£']));
    rowData['S·ªë ng√†y'] = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
}

      tempSelectedDebtIds.push(debt.id);
      calculateRemainingDebts();
      const tempId = crypto.randomUUID();
      rowData['id'] = tempId;
      if (!changeSet.create[tableKey]) changeSet.create[tableKey] = {};
      changeSet.create[tableKey][tempId] = rowData;

      const newTr = document.createElement('tr');
      newTr.dataset.id = tempId; newTr.dataset.idNo = rowData['id n·ª£'] || ''; newTr.classList.add('row-new');
      let localHiddenColumns = [...HIDDEN_COLUMNS, 'Ng√†y n·ª£', 'S·ªë ng√†y'];
      const cellsHtml = headers.map(h => {
          if (localHiddenColumns.includes(h)) return `<td style="display: none;"></td>`;
          const createCellValue = (h === 'T√™n Kh√°ch H√†ng') ? rowData['id n·ª£'] : rowData[h];
          return createCellInput(h, createCellValue);
      }).join('');
      newTr.innerHTML = `<td class="align-center"><span class="delete-btn temp-delete-btn" data-id="${tempId}">&#10006;</span></td>` + cellsHtml;
      newTr.querySelectorAll('input[inputmode="decimal"]').forEach(inp => setupCurrencyInput(inp, 'khtn'));

      const container = document.getElementById(TABLE_CONFIG[tableKey].containerId);
      const tbody = container.querySelector('tbody');
      tbody.insertBefore(newTr, tbody.firstChild);

      setChangesMade(tableKey, true);
      updateTotals(tableKey);
      updateDashboard();
      updateVisibleRowCount(tableKey);
  }

  function makeColumnsResizable(table){
    if (!table) return;
    const headerThs = Array.from(table.querySelectorAll('thead th[data-field]'));

    headerThs.forEach((th, displayIdx) => {
      th.style.position = 'relative';
      const field = th.dataset.field;

      const handle = document.createElement('div');
      handle.className = 'col-resizer';
      th.appendChild(handle);

      let startX = 0, startW = 0;

      const onMouseDown = (e) => {
        startX = e.pageX;
        startW = th.getBoundingClientRect().width;
        document.body.classList.add('resizing-col');
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
        e.preventDefault();
      };

      const onMouseMove = (e) => {
        const dx = e.pageX - startX;
        const newW = Math.max(100, startW + dx);
        th.style.width = newW + 'px';
        th.style.minWidth = newW + 'px';

        table.querySelectorAll('tbody tr').forEach(tr => {
          const ctrl = tr.querySelector(`[data-field="${CSS.escape(field)}"]`);
          if (ctrl) {
            const td = ctrl.closest('td');
            td.style.width = newW + 'px';
            td.style.minWidth = newW + 'px';
          }
        });

        const tfRow = table.querySelector('tfoot tr');
        if (tfRow && tfRow.children[displayIdx + 1]) {
          const td = tfRow.children[displayIdx + 1];
          td.style.width = newW + 'px';
          td.style.minWidth = newW + 'px';
        }
      };

      const onMouseUp = () => {
        document.body.classList.remove('resizing-col');
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
      };

      handle.addEventListener('mousedown', onMouseDown);
    });
  }

  function setupEventListeners(tableKey, container) {
      if (!container) return;
      const table = container.querySelector('table'); if (!table) return;
      const tbody = table.querySelector('tbody');

      

      tbody.addEventListener('change', (e) => { 
          const el = e.target; 
          const tr = el.closest('tr'); 
          if (tr) handleCellEdit(e, tableKey); 
      });
      tbody.addEventListener('input', (e) => { 
          if ((e.target.tagName === 'INPUT' && e.target.type === 'text' && !e.target.hasAttribute('inputmode')) || e.target.tagName === 'TEXTAREA') capitalizeFirstLetter(e.target); 
      });
      tbody.addEventListener('click', (e) => { 
          if (e.target.classList.contains('temp-delete-btn')) {
  const tr = e.target.closest('tr');
  const rowId = tr.dataset.id;
  const idNo = tr.dataset.idNo || '';

  if (idNo) {
    // g·ª° t·ª´ng id ra kh·ªèi tempSelectedDebtIds
    idNo.split(',')
        .map(s => s.trim())
        .filter(Boolean)
        .forEach(id => {
          tempSelectedDebtIds = tempSelectedDebtIds.filter(x => String(x) !== id);
        });

    // t√≠nh l·∫°i c√¥ng n·ª£ c√≤n l·∫°i r·ªìi c·∫≠p nh·∫≠t datalist
    calculateRemainingDebts();
  }

  if (changeSet.create[tableKey]?.[rowId]) {
    delete changeSet.create[tableKey][rowId];
  }

  tr.remove();
  updateTotals(tableKey);
  updateDashboard();
  updateVisibleRowCount(tableKey);
  setChangesMade(tableKey, hasPendingChanges(tableKey));
}

      });
      tbody.querySelectorAll('input[inputmode="decimal"]').forEach(inp => setupCurrencyInput(inp, tableKey));

      table.querySelectorAll('.delete-btn:not(.temp-delete-btn)').forEach(btn => btn.addEventListener('click', (e) => handleDeleteClick(e, tableKey)));
  }

  /* ‚úì phi√™n b·∫£n ghi nh·∫≠n: cho ph√©p l∆∞u thay ƒë·ªïi ·ªü d√≤ng m·ªõi */
  function handleCellEdit(e, tableKey) {
    const el = e.target;
    const tr = el.closest('tr');
    if (!tr) return;

    const rowId = tr.dataset.id;
    const field = el.dataset.field;
    if (!rowId || !field) return;

    let newValue = (el.getAttribute('inputmode') === 'decimal')
      ? String(el.value || '').replace(/\./g, '')
      : el.value;

    // D√íNG M·ªöI: c·∫≠p nh·∫≠t v√†o changeSet.create
    if (changeSet.create[tableKey] && changeSet.create[tableKey][rowId]) {
      changeSet.create[tableKey][rowId][field] = newValue;
      tr.classList.add('row-dirty');
      setChangesMade(tableKey, true);
      updateTotals(tableKey);
      updateDashboard();
      return;
    }

    // D√íNG C≈®: v·∫´n t√¥n tr·ªçng quy·ªÅn
    if (!currentPerms.canEditExisting) return;

    if (!changeSet.update[tableKey]) changeSet.update[tableKey] = {};
    if (!changeSet.update[tableKey][rowId]) {
      const rowDataFromDOM = {};
      originalTableData[tableKey].headers.forEach(h => {
        const cell = tr.querySelector(`[data-field="${h}"]`);
        let v = cell ? cell.value : (originalTableData[tableKey]?.data.find(r => r.id == rowId)?.[h]);
        if (cell && cell.getAttribute('inputmode') === 'decimal') v = v.replace(/\./g, '');
        rowDataFromDOM[h] = v;
      });
      changeSet.update[tableKey][rowId] = { ...rowDataFromDOM, id: rowId };
    }
    changeSet.update[tableKey][rowId][field] = newValue;
    tr.classList.add('row-dirty');
    setChangesMade(tableKey, true);
    updateTotals(tableKey);
    updateDashboard();
  }

  function handleDeleteClick(e, tableKey) { 
  if (!currentPerms.canDelete) {
    showToast('B·∫°n kh√¥ng c√≥ quy·ªÅn x√≥a.', 'error');
    return;
  }
  const btn = e.currentTarget || e.target;
  const rowId = btn?.dataset?.id;
  if (!rowId) return;

  if (!changeSet.delete[tableKey]) changeSet.delete[tableKey] = [];
  if (!changeSet.delete[tableKey].includes(rowId)) {
    changeSet.delete[tableKey].push(rowId);
  }

  const tr = btn.closest('tr');
  tr?.remove();

  setChangesMade(tableKey, true);
  updateTotals(tableKey);
  updateDashboard();
  updateVisibleRowCount(tableKey);
  showToast('ƒê√£ ƒë√°nh d·∫•u x√≥a. Nh·∫•n "L∆∞u Thay ƒê·ªïi" ƒë·ªÉ c·∫≠p nh·∫≠t.', 'success');
}


  function submitNewRow(tableKey) {
      if (!currentPerms.canCreate) {
        showToast('B·∫°n kh√¥ng c√≥ quy·ªÅn th√™m m·ªõi.', 'error');
        return;
      }
      showToast("Vui l√≤ng ch·ªçn m·ªôt kh√°ch h√†ng t·ª´ danh s√°ch ·ªü khung tr√™n ƒë·ªÉ th√™m thanh to√°n.", "warning");
  }

  async function handleSaveChanges(tableKey) {
      const invalidRows = document.querySelectorAll(`#container-${tableKey} tbody tr[data-is-invalid="true"]`);
      if (invalidRows.length > 0) {
          showToast('Vui l√≤ng s·ª≠a c√°c l·ªói nh·∫≠p li·ªáu (√¥ m√†u ƒë·ªè) tr∆∞·ªõc khi l∆∞u.', 'error');
          invalidRows[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
          return;
      }
      const updateBtn = document.getElementById('update-btn-khtn');
      updateBtn.disabled = true;
      updateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang l∆∞u...';

      const toNum = (v) => parseFloat(String(v || '0').replace(/\./g, '')) || 0;
      const deepClone = (o) => JSON.parse(JSON.stringify(o));
      const config = TABLE_CONFIG[tableKey];

      const khnRows = originalTableData['khn']?.data || [];
      const debtById = new Map(khnRows.map(r => [String(r.id), r]));
      const remaining = {};
      khnRows.forEach(d => { remaining[d.id] = toNum(d['S·ªë ti·ªÅn n·ª£']); });

      const khtnSaved = originalTableData['khtn']?.data || [];
      for (const p of khtnSaved) {
          const raw = String(p['id n·ª£'] || '').trim();
          const amount = toNum(p['S·ªë ti·ªÅn tr·∫£ n·ª£']);
          if (!raw || !amount) continue;

          const ids = raw.includes(',') ? raw.split(',').map(s => s.trim()).filter(Boolean) : [raw];

          let left = amount;
          const ordered = ids.slice().sort((a, b) => {
              const da = new Date(debtById.get(a)?.['Ng√†y n·ª£'] || 0);
              const db = new Date(debtById.get(b)?.['Ng√†y n·ª£'] || 0);
              return da - db;
          });
          for (const id of ordered) {
              if (left <= 0) break;
              const rem = remaining[id] ?? 0;
              const take = Math.min(rem, left);
              remaining[id] = rem - take;
              left -= take;
          }
      }

      const existingUpdates = Object.values(changeSet.update[tableKey] || {});
      const existingDeletes = changeSet.delete[tableKey] || [];
      const createsRaw = Object.values(changeSet.create[tableKey] || {});
      const expandedCreates = [];

      for (const row of createsRaw) {
          const ids = String(row['id n·ª£'] || '')
              .split(',')
              .map(s => s.trim())
              .filter(Boolean);

          let payLeft = toNum(row['S·ªë ti·ªÅn tr·∫£ n·ª£']);
          if (!payLeft || ids.length === 0) continue;

          const ordered = ids.slice().sort((a, b) => {
              const da = new Date(debtById.get(a)?.['Ng√†y n·ª£'] || 0);
              const db = new Date(debtById.get(b)?.['Ng√†y n·ª£'] || 0);
              return da - db;
          });

          for (const id of ordered) {
              if (payLeft <= 0) break;
              const rem = remaining[id] ?? 0;
              if (rem <= 0) continue;

              const take = Math.min(rem, payLeft);
              const one = deepClone(row);
              one['id n·ª£'] = id;
              one['S·ªë ti·ªÅn tr·∫£ n·ª£'] = take;

              const dNo = debtById.get(id)?.['Ng√†y n·ª£'];
              const dTra = row['Ng√†y tr·∫£'] || formatDateForServer(new Date());
              if (dNo && dTra) {
                  const diffTime = Math.abs(new Date(dTra) - new Date(dNo));
                  one['S·ªë ng√†y'] = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
              }

              expandedCreates.push(one);
              remaining[id] = rem - take;
              payLeft -= take;
          }
      }

      const idsToDeleteKhn = Object.keys(remaining).filter(id => (remaining[id] ?? 0) <= 0);

      const cleanData = (data) => {
          return deepClone(data).map(row => {
              Object.keys(row).forEach(key => {
                  if (key === 'SƒêT' && row[key]) {
                      const phoneStr = String(row[key]).trim();
                      row[key] = "'" + phoneStr;
                  }
              });
              return row;
          });
      };

      const fetchPromises = [];

      const createData = currentPerms.canCreate ? cleanData(expandedCreates) : [];
      if (createData.length > 0) {
          fetchPromises.push(fetch(API_BASE_URL, {
              method: 'POST', mode: 'no-cors',
              body: JSON.stringify({ tableName: config.name, action: 'create', data: createData })
          }));
      }

      const updateData = currentPerms.canEditExisting ? cleanData(existingUpdates) : [];
      if (updateData.length > 0) {
          fetchPromises.push(fetch(API_BASE_URL, {
              method: 'POST', mode: 'no-cors',
              body: JSON.stringify({ tableName: config.name, action: 'update', data: updateData })
          }));
      }

      const deleteIds = currentPerms.canDelete ? existingDeletes : [];
      if (deleteIds.length > 0) {
          fetchPromises.push(fetch(API_BASE_URL, {
              method: 'POST', mode: 'no-cors',
              body: JSON.stringify({ tableName: config.name, action: 'delete', data: { ids: deleteIds } })
          }));
      }

      if (idsToDeleteKhn.length > 0) {
          fetchPromises.push(fetch(API_BASE_URL, {
              method: 'POST', mode: 'no-cors',
              body: JSON.stringify({ tableName: TABLE_CONFIG['khn'].name, action: 'delete', data: { ids: idsToDeleteKhn } })
          }));
      }

      try {
          await Promise.all(fetchPromises);
          showToast('L∆∞u thay ƒë·ªïi th√†nh c√¥ng!', 'success');

          changeSet = { create: {}, update: {}, delete: {} };
          tempSelectedDebtIds = [];
          Object.keys(TABLE_CONFIG).forEach(k => TABLE_CONFIG[k].loaded = false);
          await initApp(true);
      } catch (error) {
          showToast('ƒê√£ x·∫£y ra l·ªói khi l∆∞u: ' + error.message, 'error');
      } finally {
          updateBtn.innerHTML = '<i class="fas fa-save"></i> L∆∞u Thay ƒê·ªïi';
      }
  }

  async function loadData(tableKey, onComplete) {
      const config = TABLE_CONFIG[tableKey];
      if (!config || (config.loaded && !hasPendingChanges(tableKey))) { if (onComplete) onComplete(); return; }
      if (config.containerId) document.getElementById(config.containerId).innerHTML = `<p class="status-indicator">ƒêang t·∫£i...</p>`;
      try {
          const response = await fetch(`${API_BASE_URL}?tableName=${encodeURIComponent(config.name)}`);
          if (!response.ok) throw new Error(`L·ªói m·∫°ng: ${response.statusText}`);
          originalTableData[tableKey] = await response.json();
          if (originalTableData[tableKey] && originalTableData[tableKey].data) {
              originalTableData[tableKey].data.forEach(row => {
                  if (row['SƒêT'] && typeof row['SƒêT'] === 'number') {
                      row['SƒêT'] = String(row['SƒêT']).padStart(10, '0');
                  } else if (row['SƒêT']) {
                      row['SƒêT'] = String(row['SƒêT']).trim();
                  }
              });
          }
          if (config.containerId) renderTable(tableKey, originalTableData[tableKey]);
          config.loaded = true;
          if (config.containerId) setChangesMade(tableKey, false);
      } catch (error) { if (config.containerId) document.getElementById(config.containerId).innerHTML = `<p class="status-indicator error">L·ªói t·∫£i d·ªØ li·ªáu: ${error.message}</p>`;
      } finally { if (onComplete) onComplete(); }
  }

  async function fetchNhanSuAndLogin(username, password, errorEl, loginBtn) {
      try {
          const response = await fetch(`${API_BASE_URL}?tableName=Nh√¢n s·ª±`);
          if (!response.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu ng∆∞·ªùi d√πng.');
          const personnelData = await response.json();
          if (!personnelData || !personnelData.data) throw new Error('D·ªØ li·ªáu ng∆∞·ªùi d√πng kh√¥ng h·ª£p l·ªá.');
          nhanSuList = [...new Set(personnelData.data.map(user => user['H·ªç v√† t√™n']))].filter(Boolean).sort();
          if (username && password) {
              const foundUser = personnelData.data.find(user => user['T√™n ƒëƒÉng nh·∫≠p'] === username && user['Passwword'] == password);
              if (foundUser) { sessionStorage.setItem('loggedInUser', JSON.stringify({
  name: foundUser['H·ªç v√† t√™n'],
  username: foundUser['T√™n ƒëƒÉng nh·∫≠p']
})); await initApp();
              } else { errorEl.textContent = 'T√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng.'; }
          }
      } catch (error) { if(errorEl) errorEl.textContent = 'L·ªói k·∫øt n·ªëi ho·∫∑c kh√¥ng t√¨m th·∫•y b·∫£ng Nh√¢n s·ª±.';
      } finally { if (loginBtn) { loginBtn.textContent = 'ƒêƒÉng Nh·∫≠p'; loginBtn.disabled = false; } }
  }

  async function handleLogin(e) { e.preventDefault(); const username = document.getElementById('username').value; const password = document.getElementById('password').value; const errorEl = document.getElementById('login-error'); const loginBtn = document.getElementById('login-btn'); errorEl.textContent = ''; loginBtn.textContent = 'ƒêang x·ª≠ l√Ω...'; loginBtn.disabled = true; await fetchNhanSuAndLogin(username, password, errorEl, loginBtn); }
  function handleLogout() { sessionStorage.removeItem('loggedInUser'); location.reload(); }

  async function initApp(isReload = false) {
      const user = JSON.parse(sessionStorage.getItem('loggedInUser'));
      if (user) {
          if (!isReload) {
              document.getElementById('login-overlay').style.display = 'none';
              document.querySelector('.container').classList.add('visible');
              const userInfoEl = document.getElementById('user-info');
              userInfoEl.innerHTML = `Xin ch√†o, <strong>${user.name}</strong>! <a href="#" id="logout-btn">ƒêƒÉng xu·∫•t</a>`;
              document.getElementById('logout-btn').addEventListener('click', handleLogout);
              currentPerms = computePerms(user.name);
          }
          await fetchNhanSuAndLogin(); 
          const salesDatalist = document.getElementById('sales-person-list-options');
          if (salesDatalist && nhanSuList.length > 0) salesDatalist.innerHTML = nhanSuList.map(name => `<option value="${name}"></option>`).join('');
          await Promise.all([loadData('khn'), loadData('khtn'), loadData('hth')]);
          calculateRemainingDebts();
          updateDashboard();
          applyPermissions('khtn');
      } else {
          document.getElementById('login-overlay').style.display = 'flex';
      }
  }

  function setChangesMade(tableKey, madeChanges) {
      const btn = document.getElementById(`update-btn-${tableKey}`);
      if (!btn) return;

      const container = document.getElementById(TABLE_CONFIG[tableKey].containerId);
      const hasInvalidRows = container.querySelectorAll('tbody tr[data-is-invalid="true"]').length > 0;

      btn.disabled = !madeChanges || hasInvalidRows;
  }
  function hasPendingChanges(tableKey) { return (Object.keys(changeSet.create[tableKey] || {}).length + Object.keys(changeSet.update[tableKey] || {}).length + (changeSet.delete[tableKey] || []).length) > 0; }
  
  function calculateGrandTotal(tableKey) {
      const config = TABLE_CONFIG[tableKey];
      if (!config || !config.totalField) return 0;
      const data = originalTableData[tableKey]?.data || [];
      const created = Object.values(changeSet.create[tableKey] || {});
      const updated = changeSet.update[tableKey] || {};
      const deleted = new Set(changeSet.delete[tableKey] || []);
      let total = 0;
      data.forEach(row => { if (!deleted.has(row.id)) { const finalRow = { ...row, ...(updated[row.id] || {}) }; total += parseFloat(String(finalRow[config.totalField] || '0').replace(/\./g, '')) || 0; } });
      created.forEach(row => { total += parseFloat(String(row[config.totalField] || '0').replace(/\./g, '')) || 0; });
      return total;
  }
  
  function updateDashboard() {
      const tN = calculateGrandTotal('khn');
      const tT = calculateGrandTotal('khtn');
      const tTH = calculateGrandTotal('hth');
      document.getElementById('dashboard-total-no').textContent = tN.toLocaleString('vi-VN') + ' VNƒê';
      document.getElementById('dashboard-total-tra').textContent = tT.toLocaleString('vi-VN') + ' VNƒê';
      document.getElementById('dashboard-total-thuhoi').textContent = tTH.toLocaleString('vi-VN') + ' VNƒê';
      document.getElementById('dashboard-total-conlai').textContent = (tN - tT - tTH).toLocaleString('vi-VN') + ' VNƒê';
  }

  function filterTable(tableKey) {
  const container = document.getElementById(TABLE_CONFIG[tableKey].containerId);
  const host = document.getElementById(`filters-${tableKey}`);          // ‚úÖ n∆°i ch·ª©a filters
  const filters = Array.from(host?.querySelectorAll('.filter-input')||[]);
      const tbody = container.querySelector('tbody');
      if (!tbody) return;
      const rows = tbody.querySelectorAll('tr');
      const filterValues = filters.map(f => ({ header: f.dataset.header, value: f.value.trim().toLowerCase() }));
      
      rows.forEach(row => {
          let matchesFilters = true;
          for (const filter of filterValues) {
              if (!filter.value) continue;
              const cell = row.querySelector(`[data-field="${filter.header}"]`);
              const cellValue = cell ? (cell.value || cell.textContent).toLowerCase() : '';
              if (!cellValue.includes(filter.value)) { matchesFilters = false; break; }
          }
          row.style.display = matchesFilters ? '' : 'none';
      });
      updateTotals(tableKey);
      updateVisibleRowCount(tableKey);
  }

  function capitalizeFirstLetter(input) { if (input.value.length > 0) input.value = input.value.charAt(0).toUpperCase() + input.value.slice(1); }
  function formatDateForInput(d) { if (!d) return ''; try { const dt = new Date(d); if (isNaN(dt.getTime())) return ''; return `${dt.getUTCFullYear()}-${String(dt.getUTCMonth() + 1).padStart(2, '0')}-${String(dt.getUTCDate()).padStart(2, '0')}`; } catch (e) { return ''; } }
  function formatDateForServer(d) { if (!d) return ''; try { const dt = new Date(d); if (isNaN(dt.getTime())) return ''; return `${String(dt.getUTCMonth() + 1).padStart(2, '0')}/${String(dt.getUTCDate()).padStart(2, '0')}/${dt.getUTCFullYear()}`; } catch (e) { return ''; } }

  // ==== Currency helpers (KHTN) ====
  const formatThousands = (s) =>
    String(s ?? '').replace(/[^\d]/g,'').replace(/\B(?=(\d{3})+(?!\d))/g,'.');

  function finalizeCurrencyKHTN(input, tableKey = 'khtn') {
    if (!input || input.getAttribute('inputmode') !== 'decimal') return;

    const tr = input.closest('tr');
    if (tr) { input.style.border=''; input.style.backgroundColor=''; delete tr.dataset.isInvalid; }

    const raw = String(input.value || '').replace(/[^\d]/g,'');
    const num = raw ? Number(raw) : 0;

    if (tr && input.dataset.field === 'S·ªë ti·ªÅn tr·∫£ n·ª£') {
      const debtCell = tr.querySelector('[data-field="S·ªë ti·ªÅn n·ª£"]');
      const max = debtCell ? Number(String(debtCell.value||'').replace(/[^\d]/g,'')) : 0;
      if (num > max) {
        input.style.border = '2px solid var(--danger)';
        input.style.backgroundColor = '#fff0f0';
        tr.dataset.isInvalid = 'true';
      }
    }

    input.value = raw ? formatThousands(raw) : '';

    if (!tr) return;
    const rowId = tr.dataset.id;
    const field = input.dataset.field;
    if (!rowId || !field) return;

    if (changeSet.create[tableKey]?.[rowId]) {
      changeSet.create[tableKey][rowId][field] = String(num);
    } else {
      if (!changeSet.update[tableKey]) changeSet.update[tableKey] = {};
      if (!changeSet.update[tableKey][rowId]) {
        const rowDataFromDOM = {};
        (originalTableData[tableKey]?.headers || []).forEach(h => {
          const cell = tr.querySelector(`[data-field="${h}"]`);
          let v = cell ? cell.value : (originalTableData[tableKey]?.data.find(r => r.id == rowId)?.[h]);
          if (cell && cell.getAttribute('inputmode') === 'decimal') v = v.replace(/[^\d]/g,'');
          rowDataFromDOM[h] = v;
        });
        changeSet.update[tableKey][rowId] = { ...rowDataFromDOM, id: rowId };
      }
      changeSet.update[tableKey][rowId][field] = String(num);
    }

    updateTotals(tableKey);
    updateDashboard();
    setChangesMade(tableKey, hasPendingChanges(tableKey));
  }

  function setupCurrencyInput(input, tableKey) {
    if (!input || input.__currencyBound) return;
    input.__currencyBound = true;

    let composing = false;
    input.addEventListener('compositionstart', () => composing = true);
    input.addEventListener('compositionend', () => { composing = false; });

    const finalize = () => { if (!composing) finalizeCurrencyKHTN(input, tableKey); };

    input.addEventListener('blur', finalize);
    input.addEventListener('change', finalize);
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === 'Tab') finalize();
    });

    finalize();
  }

  function exportToExcel(e) {
      const tableKey = e.currentTarget.dataset.tableKey;
      if (!tableKey || !originalTableData[tableKey]?.data) return showToast('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t.', 'warning');
      const container = document.getElementById(TABLE_CONFIG[tableKey].containerId);
      const visibleIds = new Set(Array.from(container.querySelectorAll('tbody tr'))
          .filter(tr => tr.style.display !== 'none')
          .map(tr => tr.dataset.id));
      const dataToExport = originalTableData[tableKey].data.filter(row => visibleIds.has(row.id));
      if(dataToExport.length === 0) return showToast('Kh√¥ng c√≥ d·ªØ li·ªáu n√†o ƒë∆∞·ª£c l·ªçc ƒë·ªÉ xu·∫•t.', 'warning');
      
      let localHiddenColumns = [...HIDDEN_COLUMNS, 'Ng√†y n·ª£', 'S·ªë ng√†y'];
      const headers = originalTableData[tableKey].headers.filter(h => !localHiddenColumns.includes(h));
      const headerRow = headers.map(h => headerMapping[h] || h);
      const dataRows = dataToExport.map(row => headers.map(h => {
          if (h === 'T√™n Kh√°ch H√†ng') {
              const debt = originalTableData['khn']?.data.find(d => d.id === row['id n·ª£']);
              return debt ? debt['T√™n Kh√°ch H√†ng'] : 'Kh√¥ng r√µ';
          }
          if (h === 'SƒêT' && row[h]) {
              return "'" + String(row[h]);
          }
          return row[h] ?? '';
      }));
      
      const csvContent = [headerRow, ...dataRows].map(r => r.map(c => `"${String(c ?? '').replace(/"/g, '""')}"`).join(',')).join('\n');
      const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `BaoCao_${TABLE_CONFIG[tableKey].name.replace(/\s/g, '_')}_${new Date().toISOString().slice(0, 10)}.csv`;
      document.body.appendChild(link); link.click(); document.body.removeChild(link);
  }

  document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('login-form').addEventListener('submit', handleLogin);
      document.querySelector('.export-btn').addEventListener('click', exportToExcel);
      document.getElementById('update-btn-khtn').addEventListener('click', () => handleSaveChanges('khtn'));
      setupCurrencyInput(document.getElementById('max-debt-input'));
      initApp();
  });

  /* Arrow & Enter navigation (kh√¥ng c·∫ßn Ctrl) */
  (function () {
    function getFocusable(container=document) {
      return Array.from(container.querySelectorAll(
        'input:not([type="hidden"]):not([disabled]), select:not([disabled]), textarea:not([disabled])'
      )).filter(el => el.offsetParent !== null);
    }

    function focusByDirection(fromEl, direction, container=document) {
      const focusables = getFocusable(container);
      const cur = fromEl.getBoundingClientRect();
      let best = null, bestScore = Infinity;

      focusables.forEach(el => {
        if (el === fromEl) return;
        const r = el.getBoundingClientRect();
        const dx = (r.left + r.right)/2 - (cur.left + cur.right)/2;
        const dy = (r.top + r.bottom)/2 - (cur.top + cur.bottom)/2;

        if (direction === 'right' && dx <= 4) return;
        if (direction === 'left'  && dx >= -4) return;
        if (direction === 'down'  && dy <= 4) return;
        if (direction === 'up'    && dy >= -4) return;

        const cross = (direction === 'left' || direction === 'right') ? Math.abs(dy) : Math.abs(dx);
        const dist = Math.hypot(dx, dy);
        const score = cross * 1000 + dist;

        if (score < bestScore) { bestScore = score; best = el; }
      });

      if (best) {
        best.focus({ preventScroll: true });
        if (best.select && (best.tagName === 'INPUT' || best.tagName === 'TEXTAREA')) {
          const len = best.value?.length ?? 0;
          best.setSelectionRange?.(len, len);
        }
      }
    }

    function focusNextPrev(fromEl, forward, container=document) {
      const list = getFocusable(container);
      const idx = list.indexOf(fromEl);
      const next = list[idx + (forward ? 1 : -1)];
      if (next) next.focus({ preventScroll: true });
    }

    document.addEventListener('keydown', (e) => {
      const active = document.activeElement;
      if (!active) return;

      if (e.key === 'Enter') {
        e.preventDefault();
        finalizeCurrencyKHTN(active); 
        focusNextPrev(active, !e.shiftKey);
        return;
      }

      if (['ArrowRight','ArrowLeft','ArrowUp','ArrowDown'].includes(e.key)) {
        e.preventDefault();
        finalizeCurrencyKHTN(active); 
        if (e.key === 'ArrowRight') focusByDirection(active, 'right');
        if (e.key === 'ArrowLeft')  focusByDirection(active, 'left');
        if (e.key === 'ArrowUp')    focusByDirection(active, 'up');
        if (e.key === 'ArrowDown')  focusByDirection(active, 'down');
      }
    }, true);
  })();

  document.addEventListener('focusout', (e) => {
    const t = e.target;
    if (t && t.getAttribute && t.getAttribute('inputmode') === 'decimal') {
      requestAnimationFrame(() => finalizeCurrencyKHTN(t));
    }
  }, true);
</script>

</body>
</html>

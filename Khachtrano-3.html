
<!-- hết code khách hàng nợ -->

<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Khách Hàng Trả Nợ | Tổng kho Hà Hòa</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
        /* ===============================
   Hà Hòa – Clean Modern Theme
   =============================== */

:root {
  --primary:#22c55e;
  --secondary:#f59e0b;
  --danger:#ef4444;
  --bg:#f3f4f6;
  --card:#ffffff;
  --muted:#64748b;
  --border:#e5e7eb;
}

*{margin:0;padding:0;box-sizing:border-box;font-family:'Roboto',sans-serif;}
body{background:var(--bg);color:#111827;line-height:1.5;}

/* Container */
.container{
  max-width:1800px;margin:20px auto;padding:20px;
  background:var(--card);
  border-radius:16px;
  box-shadow:0 8px 24px rgba(0,0,0,.08);
  display:none;
}
.container.visible{display:block;}

/* Header gradient */
/* ===== Header (gradient, co giãn an toàn, không absolute) ===== */
header{
  display:flex;
  align-items:center;
  flex-wrap:wrap;              /* hẹp thì tự xuống dòng */
  gap:16px;
  margin-bottom:20px;
  padding:16px;
  border-radius:14px;
  background:linear-gradient(90deg,#6366f1,#22c55e,#f59e0b);
  color:#fff;
  border:none;
}

/* Logo */
header img{
  height:88px;
  width:88px;
  border-radius:50%;
  border:3px solid #fff;
  box-shadow:0 6px 16px rgba(0,0,0,.2);
  flex-shrink:0;
  object-fit:cover;
  order:1;
}

/* Thông tin liên hệ */
.contact-info{
  font-size:14px;
  line-height:1.4;
  order:2;
  min-width:220px;
}
.contact-info .address{font-weight:600;}
.contact-info .hotline{font-weight:700;color:#fff;}

/* Tiêu đề (không absolute, để trong flex) */
.header-title{
  order:3;
  flex:1;
  text-align:center;
  margin-inline:8px;
}
.header-title h1{font-size:26px;font-weight:800;letter-spacing:.2px;margin:0;}
.header-title h2{font-size:20px;font-weight:600;opacity:.95;margin:0;}

/* User info pill (không absolute, dạt phải bằng margin-left:auto) */
#user-info{
  order:4;
  margin-left:auto;
  background:#fff;
  color:#111827;
  padding:6px 12px;
  border-radius:999px;
  font-size:14px;
  font-weight:600;
  box-shadow:0 4px 12px rgba(0,0,0,.12);
  white-space:nowrap;
}
#logout-btn{color:var(--danger);margin-left:8px;text-decoration:none;}

/* Responsive cho màn hẹp */
@media (max-width: 768px){
  header img{height:72px;width:72px}
  .header-title{
    flex-basis:100%;
    order:4;           /* tiêu đề xuống dưới cùng cho gọn */
    margin-top:4px;
  }
  #user-info{ order:3; }  /* pill user nằm cùng hàng logo/địa chỉ */
  .header-title h1{font-size:20px}
  .header-title h2{font-size:16px}
}


/* Dashboard cards */
.dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;margin-bottom:20px;}
.dashboard-card{
  background:#fff;padding:16px;border-radius:14px;
  border-left:5px solid var(--primary);
  box-shadow:0 4px 12px rgba(0,0,0,.06);
}
.dashboard-card h3{font-size:14px;color:var(--muted);margin-bottom:6px;}
.dashboard-card p{font-size:20px;font-weight:700;color:var(--primary);}
.dashboard-card.summary{border-left-color:#0ea5e9;}
.dashboard-card.summary p{color:#0ea5e9;}

/* Table controls (filters + add) */
.table-controls{
  display:grid;gap:10px;margin-bottom:12px;
  background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px;
}
.filters-row{display:grid;grid-template-columns:120px repeat(auto-fit,minmax(160px,1fr));gap:8px;align-items:center;}
.filters-row .label{font-weight:700;color:#111827;display:flex;align-items:center;gap:6px;}
.filter-input{
  border:1px solid var(--border);border-radius:999px;
  padding:6px 10px;font-size:13px;
}

/* Add panel */
.add-panel{border:1px dashed var(--border);border-radius:10px;padding:10px;background:#fafafa;}
.add-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:8px;margin-top:6px;}
.add-grid .field label{font-size:12px;font-weight:600;color:#374151;margin-bottom:4px;}
.add-grid .field input,.add-grid .field select{
  border:1px solid var(--border);border-radius:8px;padding:8px;font-size:13px;
}

/* Table */
/* Table (cho phép kéo giãn cột) */
.table-container{overflow:auto;max-height:65vh;background:#fff;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.06);}
table{
  border-collapse:collapse;
  font-size:15px;
  font-weight:600;
  width:max-content;     /* cho phép nở ngang khi kéo */
  min-width:100%;        /* không nhỏ hơn khung */
  table-layout:fixed;    /* giữ width đã set cho cột */
}
thead th{
  position:sticky; top:0; background:#22c55e; color:#fff;
  font-weight:800; padding:10px; text-align:center; white-space:nowrap;
  font-size:16px;
  z-index: 100;
}
/* Fix sticky header luôn nổi trên resizer và tbody */
.table-container { 
  position: relative;             /* tạo stacking context cho thead */
}

.table-container table thead {
  position: sticky;
  top: 0;
  z-index: 50;                    /* thấp hơn dropdown */
  background: #22c55e;            /* trùng màu header của bạn */
}

.table-container table thead th {
  position: sticky;
  top: 0;
  z-index: 50;                    /* thấp hơn dropdown */
  background: #22c55e;            /* tránh lộ nền khi cuộn */
}

thead th + th{ box-shadow:-1px 0 0 rgba(255,255,255,.45) inset; }

/* Tay nắm kéo cột */
.col-resizer{
  position:absolute; top:0; right:0; bottom:0;
  width:12px; cursor:col-resize; user-select:none; z-index:99;
}
.col-resizer::after{
  content:''; position:absolute; right:5px; top:20%; bottom:20%;
  width:2px; background:#e5e7eb;
}

tbody td{padding:10px;border-bottom:1px solid #f1f5f9;font-size:15px;font-weight:600;}
tbody tr:nth-child(even){background:#fafafa;}
tbody tr:hover{background:#fffbe6;}

/* Highlight new records with yellow background */
tbody tr.row-new {
  background-color: #fef3c7 !important;
  border-left: 4px solid #f59e0b;
}

tbody tr.row-new:hover {
  background-color: #fde68a !important;
}
tfoot td {
  background:#f0fdf4;
  font-weight:800;
  padding:8px;
  color:#065f46;
  text-transform:uppercase;   /* In hoa chữ */
  text-align:center;          /* Căn giữa */
  letter-spacing: .5px;       /* Khoảng cách chữ đẹp hơn */
}
tfoot td:first-child {
  white-space: nowrap;   /* không cho xuống dòng */
  text-align: center;    /* căn giữa */
}


/* Inputs trong bảng */
tbody td input,tbody td select,tbody td textarea{
  width:100%;border:none;background:transparent;padding:8px;font-size:15px;font-weight:600;
}
.align-left{text-align:left}.align-right{text-align:right}.align-center{text-align:center}

/* Buttons */
.action-btn{
  border:none;border-radius:8px;padding:10px 16px;
  font-size:15px;font-weight:700;cursor:pointer;
  display:inline-flex;align-items:center;gap:8px;color:#fff;
}
.update-btn{background:#f59e0b;}
.export-btn{background:#1d6f42;}
.update-btn:disabled{background:#ccc;cursor:not-allowed;}

/* Delete button */
.delete-btn{cursor:pointer;color:var(--danger);font-size:18px;font-weight:800;}
.delete-btn:hover{color:#a11;}

/* Login overlay */
#login-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:1000;}
#login-box{background:#fff;padding:30px;border-radius:12px;max-width:350px;width:100%;box-shadow:0 12px 28px rgba(0,0,0,.25);}
#login-box h2{margin-bottom:20px;color:var(--primary);}
.input-group{margin-bottom:16px;}
.input-group label{display:block;margin-bottom:4px;font-weight:600;}
.input-group input{width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;}
#login-btn{width:100%;padding:10px;border:none;border-radius:8px;background:var(--primary);color:#fff;font-weight:700;}

/* Toast */
#toast-container{position:fixed;bottom:20px;right:20px;display:flex;flex-direction:column;gap:10px;z-index:2000;}
.toast{padding:10px 16px;border-radius:8px;color:#fff;font-weight:600;box-shadow:0 4px 12px rgba(0,0,0,.2);}
.toast.success{background:#22c55e}.toast.error{background:#ef4444}.toast.warning{background:#f59e0b}

/* --- TÁCH KHỐI: Filters và Add-panel là 2 card riêng --- */
.table-controls{
  background: transparent;
  border: 0;
  box-shadow: none;
  padding: 0; /* bỏ padding bọc ngoài để hết khoảng trắng */
  overflow: visible;
  position: relative;
  z-index: 99996;
}

/* Card cho khối Tìm kiếm (gập/mở) */
.table-controls .filters-panel{
  background:#fff;
  border:1px solid rgba(2,6,23,.06);
  border-radius:14px;
  box-shadow:0 6px 16px rgba(2,6,23,.06);
  padding:8px 10px;
  margin-bottom:10px;
}

/* Header có icon kính lúp, bấm để gập/mở */
.filters-panel > summary.search-label{
  list-style:none;
  cursor:pointer;
  font-weight:800;
  color:#111827;
  display:flex;
  align-items:center;
  gap:6px;
  padding:6px 2px;
  margin-bottom:6px;
}
.filters-panel > summary.search-label::before{
  content:"";
  display:inline-flex;
  width:16px; height:16px;
  mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='black' viewBox='0 0 512 512'%3E%3Cpath d='M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352a144 144 0 1 0 0-288 144 144 0 1 0 0 288z'/%3E%3C/svg%3E") center / contain no-repeat;
  background:#111827;
  opacity:.7;
}
.filters-panel > summary.search-label::after{
  content:"▾";
  margin-left:auto;
  transition:transform .15s ease;
  opacity:.6;
}
.filters-panel[open] > summary.search-label::after{ transform:rotate(180deg); }

/* Lưới filter gọn, không tràn */
.filters-grid{
  display:grid;
  gap:10px;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
}
.filters-grid .field{
  display:flex;
  flex-direction:column;
  gap:4px;
  min-width:0;
}
.filters-grid .field label{
  font-size:13px;
  font-weight:800;
  letter-spacing:.2px;
  text-transform:uppercase;
  color:#334155;
  background:#f1f5f9;
  border:1px solid #e2e8f0;
  border-radius:999px;
  padding:6px 10px;
  width:max-content;
}
.filters-grid .field .filter-input{
  width:100%;
  border:1px solid var(--border);
  background:#fff;
  height:36px;
  font-size:14px;
  font-weight:600;
  padding:8px 12px;
  border-radius:10px;
}

/* Card cho khối Thêm thanh toán */
.table-controls .add-panel{
  background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
  border: 2px solid #0ea5e9;
  border-radius:12px;
  box-shadow:0 4px 12px rgba(14, 165, 233, 0.15);
  padding:10px;
  overflow: visible;
  position: relative;
  z-index: 99997;
}

/* Tiêu đề + Nút Thêm nằm trên cùng, nút ở bên phải */
.add-panel > summary{
  list-style:none;
  cursor:default;
  display:flex;
  align-items:center;
  gap:10px;
  padding:6px 2px;
  margin-bottom:6px;
}
.add-panel > summary .title{
  display:inline-flex;
  align-items:center;
  gap:8px;
  font-weight:800;
  color:#0c4a6e;
}
.add-panel > summary .title::before{
  content:"+";
  display:inline-grid;
  place-items:center;
  width:20px; height:20px;
  border-radius:6px;
  background:#0ea5e9; color:#fff;
  font-weight:900; font-size:14px;
}
.add-panel .add-btn-inline{
  margin-left:auto;        /* đẩy nút sang phải */
  height:28px;
  padding:0 10px;
  border-radius:8px;
  font-size:13px;
  border:none;
  background:#0ea5e9;
  color:#fff;
  display:inline-flex;
  align-items:center;
  gap:6px;
  box-shadow: 0 2px 4px rgba(14, 165, 233, 0.3);
}
/* Nếu không muốn icon + trong nút, ẩn đi */
.add-panel .add-btn-inline i{ display:none; }

.add-grid{ display:grid; gap:10px; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); }
.add-grid .field label{
  font-size:14px;font-weight:700;color:#0c4a6e;margin-bottom:6px;
}
.add-grid .field input,.add-grid .field select{
  border:2px solid #0ea5e9; border-radius:8px; padding:8px; font-size:13px;
  background: #fff;
  transition: all 0.3s ease;
}
.add-grid .field input:focus,.add-grid .field select:focus{
  border-color: #0284c7;
  box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
}

/* Custom dropdown with search styling */
.custom-dropdown-container {
  position: relative;
  width: 100%;
  z-index: 99999;
}

.customer-search-input {
  width: 100%;
  font-size: 15px;
  font-weight: 600;
  padding: 10px 40px 10px 12px;
  border: 2px solid #0ea5e9;
  border-radius: 10px;
  background: #fff;
  outline: none;
  transition: all 0.3s ease;
}

.customer-search-input:focus {
  border-color: #0284c7;
  box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
}

.customer-search-input::placeholder {
  color: #9ca3af;
  font-weight: 500;
}

/* Search icon */
.customer-search-input {
  background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3ccircle cx='11' cy='11' r='8'%3e%3c/circle%3e%3cpath d='m21 21-4.35-4.35'%3e%3c/path%3e%3c/svg%3e");
  background-repeat: no-repeat;
  background-position: right 12px center;
  background-size: 16px;
}

/* Dropdown list */
.custom-dropdown-list {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: #fff;
  border: 2px solid var(--border);
  border-top: none;
  border-radius: 0 0 10px 10px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  max-height: 200px;
  overflow-y: auto;
  z-index: 99999;
}

.custom-dropdown-list.show {
  display: block !important;
}

.dropdown-option {
  padding: 12px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  border-bottom: 1px solid #f1f5f9;
  transition: background-color 0.2s ease;
  display: flex;
  align-items: center;
  gap: 8px;
}

.dropdown-option:hover {
  background-color: #f8fafc;
}

.dropdown-option.selected {
  background-color: #e0f2fe;
  color: var(--primary);
}

.dropdown-option:last-child {
  border-bottom: none;
}

.customer-name {
  font-weight: 600;
  color: #1f2937;
  flex: 1;
}

.debt-amount {
  font-weight: 700;
  color: #dc2626;
  font-size: 13px;
  white-space: nowrap;
}

.no-results {
  padding: 12px;
  text-align: center;
  color: #6b7280;
  font-style: italic;
}

/* Debt search input styling */
.debt-search-input {
  width: 100%;
  font-size: 15px;
  font-weight: 600;
  padding: 10px 40px 10px 12px;
  border: 2px solid #0ea5e9;
  border-radius: 10px;
  background: #f9fafb;
  outline: none;
  transition: all 0.3s ease;
  cursor: pointer;
}

.debt-search-input:focus {
  border-color: #0284c7;
  box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
  background: #fff;
}

.debt-search-input::placeholder {
  color: #9ca3af;
  font-weight: 500;
}

/* Debt dropdown arrow */
.debt-search-input {
  background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
  background-repeat: no-repeat;
  background-position: right 12px center;
  background-size: 16px;
}

/* Staff input styling */
.staff-input {
  width: 100%;
  font-size: 15px;
  font-weight: 600;
  padding: 10px 12px;
  border: 2px solid #0ea5e9;
  border-radius: 10px;
  background: #f9fafb;
  outline: none;
  transition: all 0.3s ease;
  cursor: default;
}

.staff-input:focus {
  border-color: #0284c7;
  box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
  background: #fff;
}

.staff-input::placeholder {
  color: #9ca3af;
  font-weight: 500;
}

/* Payment section styling */
.payment-section {
  margin-top: 15px;
  padding: 15px;
  background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
  border-radius: 10px;
  border: 2px solid #f59e0b;
  box-shadow: 0 2px 8px rgba(245, 158, 11, 0.15);
}

.payment-mode-selector {
  margin-bottom: 15px;
}

.payment-mode-label {
  display: block;
  font-size: 14px;
  font-weight: 700;
  color: #92400e;
  margin-bottom: 8px;
}

.payment-mode-options {
  display: flex;
  gap: 20px;
}

.payment-mode-option {
  display: flex;
  align-items: center;
  gap: 6px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  color: #4b5563;
}

.payment-mode-option input[type="radio"] {
  margin: 0;
  cursor: pointer;
}

.payment-mode-option input[type="radio"]:checked + span {
  color: #f59e0b;
  font-weight: 700;
}

.payment-amount-section {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
}

.debt-amount-input {
  width: 100%;
  font-size: 15px;
  font-weight: 600;
  padding: 10px 12px;
  border: 2px solid #f59e0b;
  border-radius: 10px;
  background: #fef3c7;
  outline: none;
  color: #dc2626;
  cursor: default;
}

.payment-amount-input {
  width: 100%;
  font-size: 15px;
  font-weight: 600;
  padding: 10px 12px;
  border: 2px solid #f59e0b;
  border-radius: 10px;
  background: #fff;
  outline: none;
  transition: all 0.3s ease;
}

.payment-amount-input:focus {
  border-color: #d97706;
  box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
}

.payment-amount-input::placeholder {
  color: #9ca3af;
  font-weight: 500;
}

/* Ensure dropdown opens downward and is not clipped */
.add-grid .field {
  position: relative;
  z-index: 99998;
}

.customer-select-dropdown:focus {
  z-index: 101;
}

/* Override any parent overflow that might clip the dropdown */
.add-panel {
  overflow: visible !important;
}

.table-controls {
  overflow: visible !important;
}
#max-debt-control-card { display: none !important; }
/* --- Tiêu đề bảng + cụm nút Save/Export nằm cùng hàng, nút sát phải --- */
.table-title{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  margin:12px 0;
}
.table-title h2{
  margin:0;
  font-size:24px;
  font-weight:800;
}
.table-title .controls-wrapper{
  margin-left:auto;          /* đẩy cụm nút sang phải */
  display:flex;
  align-items:center;
  gap:10px;
}
#count-khtn{ display:none; } /* Ẩn dấu "..." */
/* Khoảng cách giữa cụm filters (trên) và tiêu đề bảng (dưới) */
#filters-khtn .table-controls{
  margin-bottom: 12px;
}
/* === OVERRIDE CUỐI: phóng to tiêu đề h1 trong header (KHTN) === */
.header-title h1{
  font-size: 36px !important;   /* to hơn trên desktop */
  font-weight: 900 !important;
  line-height: 1.25;
  letter-spacing: .2px;
  margin: 0;
}

/* to hơn nữa với màn rất rộng */
@media (min-width: 1280px){
  .header-title h1{ font-size: 42px !important; }
}

/* gọn trên mobile */
@media (max-width: 768px){
  .header-title h1{ font-size: 24px !important; }
}

/* (tuỳ chọn) cân lại size dòng phụ */
.header-title h2{
  font-size: 22px !important;
  font-weight: 700 !important;
}
@media (max-width: 768px){
  .header-title h2{ font-size: 16px !important; }
}

/* ===== BACKGROUND XANH TƯƠNG TỰ FILE KHÁCH HÀNG TRẢ NỢ ===== */

/* Nền xanh gradient cho toàn trang */
body {
  background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 50%, #93c5fd 100%) !important;
  min-height: 100vh;
}

/* Container trắng nổi trên nền xanh */
.container {
  max-width: 1800px;
  margin: 20px auto;
  padding: 20px;
  border-radius: 16px;
  background: #ffffff !important;  /* card trắng nổi */
  box-shadow: 0 8px 24px rgba(0,0,0,.08);
  display: none;
}

.container.visible {
  display: block;
}
    </style>
</head>

<body>
    <div id="login-overlay">
        <div id="login-box">
            <h2>Đăng Nhập Hệ Thống</h2>
            <form id="login-form">
                <div class="input-group"> <label for="username">Tên đăng nhập</label> <input type="text" id="username" required> </div>
                <div class="input-group"> <label for="password">Mật khẩu</label> <input type="password" id="password" required> </div>
                <button type="submit" id="login-btn">Đăng Nhập</button>
                <p id="login-error"></p>
            </form>
        </div>
    </div>

    <div class="container">
        <header>
            <div id="user-info"></div>
            <img alt="Logo" src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Ff6c823b5.%E1%BA%A2nh.094646.jpg" />
            <div class="contact-info">
                <div class="address">Địa chỉ : Số 46 - Thanh Lũng - Quảng oai - TP Hà Nội</div>
                <div class="hotline">Hotline : 0969.250.323</div>
            </div>
            <div class="header-title">
                <h1>Nhà Phân Phối Hà Hoà</h1>
                <h2>Bảng Khách Hàng Trả Nợ</h2>
            </div>
        </header>

        <div class="dashboard">
            <div class="dashboard-card"> <h3>Tổng Tiền Nợ</h3> <p id="dashboard-total-no">0</p> </div>
            <div class="dashboard-card"> <h3>Tổng Tiền Đã Trả</h3> <p id="dashboard-total-tra">0</p> </div>
            <div class="dashboard-card"> <h3>Giá Trị Hàng Thu Hồi</h3> <p id="dashboard-total-thuhoi">0</p> </div>
            <div class="dashboard-card summary"> <h3>Tổng Công Nợ Cuối Cùng</h3> <p id="dashboard-total-conlai">0</p> </div>
            <div class="dashboard-card" id="max-debt-control-card" style="grid-column: 1 / -1; border-left-color: var(--error-color);">
                <h3 style="color: var(--error-color);">Kiểm Soát Hạn Mức Nợ</h3>
                <div style="display: flex; align-items: center; gap: 20px; margin-top: 10px; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 200px;">
                        <label for="max-debt-input" style="font-weight: 500; font-size: 14px; display: block; margin-bottom: 5px;">Hạn Mức Nợ Tối Đa Của Từng Khách Hàng(VNĐ)</label>
                        <input type="text" id="max-debt-input" placeholder="Nhập hạn mức..." style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                    <div style="flex: 1; min-width: 200px;">
                        <label for="custom-debt-term-input" style="font-weight: 500; font-size: 14px; display: block; margin-bottom: 5px;">Số Ngày Nợ Tối Đa Của Từng Khách Hàng</label>
                        <input type="number" id="custom-debt-term-input" placeholder="Nhập số ngày..." style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                    
                    <div id="current-customer-debt-display" style="display: none; flex: 1; min-width: 200px; background-color: #f0f0f0; padding: 8px; border-radius: 4px;">
                        <p style="margin: 0; font-size: 14px; color: #333;">Nợ hiện tại của KH:</p>
                        <p id="current-customer-debt-value" style="margin: 0; font-size: 20px; font-weight: 700; color: var(--secondary-color);">0 VNĐ</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="main-content-khtn">
            <div id="filters-khtn"></div>
            <div class="table-title">
                <h2>Bảng Khách Hàng Trả Nợ</h2>
                <div class="controls-wrapper">
                    <span id="count-khtn" class="record-count">...</span>
                    <button id="update-btn-khtn" class="update-btn action-btn" disabled><i class="fas fa-save"></i> Lưu Thay Đổi</button>
                    <button class="export-btn action-btn" data-table-key="khtn"><i class="fas fa-file-excel"></i> Tải Excel</button>
                </div>
            </div>
            <div class="table-container" id="container-khtn">
                <p class="status-indicator">Đang tải dữ liệu...</p>
            </div>
        </div>

        
    </div>

    <div id="toast-container"></div>
    <datalist id="customer-list-options"></datalist>
    <datalist id="sales-person-list-options"></datalist>
    <datalist id="debt-list-options"></datalist>
    <!-- Datalist bổ sung cho ô lọc -->
<datalist id="delivery-staff-list-options"></datalist>
<datalist id="region-list-options"></datalist>
<datalist id="phone-list-options"></datalist>

<script>
  const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbwZ73GdTFsSitoVqJKiZKIbU3wHM_qpjxQEbhlKTwi1V9GijNC8SPoRH9vVDD65xb9x/exec';
  const TABLE_CONFIG = {
      'khn': { name: 'Khách Hàng Nợ', loaded: false, totalField: 'Số tiền nợ' },
      'khtn': { name: 'Khách hàng trả nợ', containerId: 'container-khtn', countId: 'count-khtn', loaded: false, totalField: 'Số tiền trả nợ' },
      'hth': { name: 'Hàng thu hồi', loaded: false, totalField: 'Thành tiền' },
  };

  /* ✓ thêm ánh xạ cho cả hai tên cột để hiển thị đồng nhất */
  const headerMapping = {
    'Giao hàng cho nợ': 'NV Giao hàng',
    'Giao hàng nhận tiền': 'NV Giao hàng',  // ← thêm dòng này
    'Người chịu trách nhiệm': 'NV Kinh doanh (Chịu Trách Nhiệm)',
    'id nợ': 'ID Nợ Gốc',
    'Số tiền trả nợ': 'Số tiền khách trả',
    'Số tiền nợ': 'Số tiền còn nợ',
    'NV cho nợ': 'NV Giao hàng',

  };

  const HIDDEN_COLUMNS = ['id', 'id nợ'];
  const GIAO_HANG_NV_LIST = ['Hoa', 'Phong', 'minh', 'duy', 'Tuấn Lái xe', 'Hà (Nam)', 'Xuyến', 'Hoà', 'Hạnh', 'Hà (Nữ)'];
  const NUMERIC_COLUMNS_FOR_TOTAL = ['Số tiền nợ', 'Thành tiền', 'Số tiền trả nợ', 'Đơn giá', 'Số lượng'];

  // === PHÂN QUYỀN (ADD) ===
  const ALLOWED_CREATORS = ['hoa','hanh','xuyen']; // chỉ 3 người này được thêm mới
  let currentPerms = { canCreate: false, canEditExisting: false, canDelete: false, isViewer: true };

  function normalizeVi(str='') {
    return str.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
  }
  function computePerms(displayName) {
  const session = JSON.parse(sessionStorage.getItem('loggedInUser') || '{}');
  const username = normalizeVi(session?.username || '');
  const name = normalizeVi(displayName || '');
  const isAdmin = username === 'admin' || name === 'admin';

  const canCreate = isAdmin || ALLOWED_CREATORS.includes(name);
  return {
    canCreate,
    canEditExisting: isAdmin,  // ✅ Admin sửa dòng cũ
    canDelete: isAdmin,        // ✅ Admin xoá dòng cũ
    isViewer: !(canCreate || isAdmin)
  };
}

  function applyPermissions(tableKey) {
  const perms = currentPerms;
  const cfg = TABLE_CONFIG[tableKey];
  if (!cfg || !cfg.containerId) return;

  // Nút Lưu
  const saveBtn = document.getElementById(`update-btn-${tableKey}`);
  if (saveBtn) {
    saveBtn.style.display = perms.isViewer ? 'none' : 'inline-flex';
    saveBtn.disabled = perms.isViewer;
  }

  // container của bảng + host của filters
  const container = document.getElementById(cfg.containerId);
  const host = document.getElementById(`filters-${tableKey}`);
  if (!container) return;

  // Ẩn/hiện nút "Thêm theo KH" (nằm trong host mới)
  const addBtn = (host || container).querySelector(`#btn-add-${tableKey}`);
  if (addBtn) addBtn.style.display = perms.canCreate ? '' : 'none';

  // Khoá edit các dòng dữ liệu cũ
  container.querySelectorAll('tbody tr[data-id]').forEach(tr => {
    const controls = tr.querySelectorAll('input, select, textarea');
    controls.forEach(el => {
      if (!perms.canEditExisting) {
        if (el.tagName === 'SELECT') el.setAttribute('disabled', 'disabled');
        else el.setAttribute('readonly', 'readonly');
      }
    });
  });

  // Ẩn tất cả nút xoá
  container.querySelectorAll('.delete-btn:not(.temp-delete-btn)').forEach(btn => {
  btn.style.display = perms.canDelete ? '' : 'none';
});

}

  // === HẾT PHÂN QUYỀN (ADD) ===

  let originalTableData = {};
  let changeSet = { create: {}, update: {}, delete: {} };
  let nhanSuList = [];
  let tempSelectedDebtIds = [];

  /* ✓ helper: trả về tên cột giao hàng đang tồn tại trong Sheet */
  function giaoHangHeader() {
    const hs = originalTableData['khtn']?.headers || [];
    return hs.includes('Giao hàng nhận tiền') ? 'Giao hàng nhận tiền' : 'Giao hàng cho nợ';
  }

  function calculateRemainingDebts() {
      const khnData = originalTableData['khn']?.data;
      if (!khnData) return;
      const paidAmounts = {};
      (originalTableData['khtn']?.data || []).forEach(p => { paidAmounts[p['id nợ']] = (paidAmounts[p['id nợ']] || 0) + (parseFloat(String(p['Số tiền trả nợ'] || '0').replace(/\./g, '')) || 0); });
      Object.values(changeSet.create['khtn'] || {}).forEach(p => { paidAmounts[p['id nợ']] = (paidAmounts[p['id nợ']] || 0) + (parseFloat(String(p['Số tiền trả nợ'] || '0').replace(/\./g, '')) || 0); });
      
      khnData.forEach(debt => {
  const totalDebt = parseFloat(String(debt['Số tiền nợ'] || '0').replace(/\./g, '')) || 0;
  const totalPaid = paidAmounts[debt.id] || 0;

  // luôn có số dương/0 để dùng cho lọc & datalist
  let remain = totalDebt - totalPaid;
  if (!isFinite(remain)) remain = totalDebt;   // fallback khi chưa có paid
  if (remain < 0) remain = 0;                  // chặn số âm

  debt._conLai = remain;
});

      updateDebtDatalist();
  }

  let customerDebtList = [];

  function updateDebtDatalist() {
      const debtDatalist = document.getElementById('debt-list-options');
      const khnData = originalTableData['khn']?.data;
      if (!khnData) return;
      const toNum = (v) => Number(String(v ?? '').replace(/[^\d]/g, '')) || 0;

// gom theo tên chuẩn hóa, tránh trùng, và chỉ lấy KH có "remain" > 0
const byNorm = new Map();
khnData.forEach(debt => {
  const remain = Number.isFinite(debt._conLai) ? Number(debt._conLai) : toNum(debt['Số tiền nợ']);
  if (remain > 0) {
    const name = String(debt['Tên Khách Hàng'] || '').trim();
    if (!name) return;
    const key = normalizeVi(name);
    if (!byNorm.has(key)) {
      byNorm.set(key, { 
        name, 
        remain: 0, 
        debtCount: 0,
        debts: []
      });
    }
    byNorm.get(key).remain += remain;
    byNorm.get(key).debtCount += 1;
    byNorm.get(key).debts.push(debt);
  }
});

// Store customer list globally for search functionality
customerDebtList = Array.from(byNorm.values())
  .sort((a, b) => a.name.localeCompare(b.name, 'vi'));

// Update datalist (for backward compatibility)
if (debtDatalist) {
  debtDatalist.innerHTML = customerDebtList
    .map(item => `<option value="${item.name}"></option>`)
  .join('');
}

// Update custom dropdown
updateCustomerDropdown();

// Update debt amount display if customer is already selected
const customerInput = document.getElementById('ext-khtn-customer-search');
if (customerInput && customerInput.value.trim()) {
  const selectedCustomerName = customerInput.value.trim();
  const selectedCustomer = customerDebtList.find(customer => 
    normalizeVi(customer.name) === normalizeVi(selectedCustomerName)
  );
  
  if (selectedCustomer) {
    const debtAmountInput = document.getElementById('ext-khtn-debt-amount');
    if (debtAmountInput) {
      const paymentMode = document.querySelector('input[name="payment-mode"]:checked')?.value;
      if (paymentMode === 'custom-amount') {
        debtAmountInput.value = selectedCustomer.remain.toLocaleString('vi-VN');
      }
    }
    
    // Cập nhật lại dropdown để hiển thị số tiền nợ mới
    updateCustomerDropdown();
  }
}

  }

  function updateCustomerDropdown() {
    const dropdown = document.getElementById('ext-khtn-customer-dropdown');
    if (!dropdown) return;

    const searchTerm = document.getElementById('ext-khtn-customer-search')?.value?.toLowerCase() || '';
    const filteredCustomers = customerDebtList.filter(customer => 
      normalizeVi(customer.name).includes(normalizeVi(searchTerm))
    );

    if (filteredCustomers.length === 0) {
      dropdown.innerHTML = '<div class="no-results">Không tìm thấy khách hàng nào</div>';
    } else {
      dropdown.innerHTML = filteredCustomers.map(customer => `
        <div class="dropdown-option" data-value="${customer.name}">
          <span class="customer-name">${customer.name} - còn nợ ${customer.remain.toLocaleString('vi-VN')} VNĐ - số đơn nợ là ${customer.debtCount}</span>
        </div>
      `).join('');
    }
  }

  function updateDebtDropdown() {
    const dropdown = document.getElementById('ext-khtn-debt-dropdown');
    const customerInput = document.getElementById('ext-khtn-customer-search');
    if (!dropdown || !customerInput) return;

    const selectedCustomerName = customerInput.value.trim();
    if (!selectedCustomerName) return;

    // Find customer in customerDebtList
    const selectedCustomer = customerDebtList.find(customer => 
      normalizeVi(customer.name) === normalizeVi(selectedCustomerName)
    );

    if (!selectedCustomer || !selectedCustomer.debts || selectedCustomer.debts.length === 0) {
      dropdown.innerHTML = '<div class="no-results">Không có đơn nợ nào</div>';
    } else {
      const toNum = (v) => Number(String(v ?? '').replace(/[^\d]/g, '')) || 0;
      
      dropdown.innerHTML = selectedCustomer.debts.map(debt => {
        const remain = Number.isFinite(debt._conLai) ? Number(debt._conLai) : toNum(debt['Số tiền nợ']);
        // Lấy NV Kinh doanh (Chịu Trách Nhiệm) thay vì NV Giao hàng
        const staff = debt['Người chịu trách nhiệm'] || debt['NV Kinh doanh (Chịu Trách Nhiệm)'] || '';
        const displayText = `Đơn ${debt.id} - Nợ: ${remain.toLocaleString('vi-VN')} VNĐ`;
        
        return `
          <div class="dropdown-option" data-value="${debt.id}" data-display="${displayText}" data-staff="${staff}">
            <span class="customer-name">${displayText}</span>
          </div>
        `;
      }).join('');
    }
  }

  function populateFilterDatalists() {
  const khn = originalTableData.khn?.data || [];
  const khtn = originalTableData.khtn?.data || [];
  const all = [...khn, ...khtn];

  // 1) Customers
  const customers = new Map(); // dùng Map để dedupe theo normalize nhưng giữ nguyên chữ hoa/thường gốc
  all.forEach(r => {
    const v = (r['Tên Khách Hàng'] || '').toString().trim();
    if (!v) return;
    const key = normalizeVi(v);
    if (!customers.has(key)) customers.set(key, v);
  });
  const customerDL = document.getElementById('customer-list-options');
  if (customerDL) {
    customerDL.innerHTML = Array.from(customers.values())
      .sort((a,b)=>a.localeCompare(b,'vi'))
      .map(v => `<option value="${v}"></option>`).join('');
  }

  // 2) NV KINH DOANH (lấy từ Nhân sự + dữ liệu thực tế trong 2 bảng)
  const salesMap = new Map();
  (Array.isArray(nhanSuList) ? nhanSuList : []).forEach(n => {
    const v = (n || '').toString().trim();
    if (!v) return;
    const key = normalizeVi(v);
    if (!salesMap.has(key)) salesMap.set(key, v);
  });
  const SALES_KEYS = ['Người chịu trách nhiệm', 'NV Kinh doanh (Chịu Trách Nhiệm)'];
  all.forEach(r => {
    SALES_KEYS.forEach(k => {
      const v = (r[k] || '').toString().trim();
      if (!v) return;
      const key = normalizeVi(v);
      if (!salesMap.has(key)) salesMap.set(key, v);
    });
  });
  const salesDL = document.getElementById('sales-person-list-options');
  if (salesDL) {
    salesDL.innerHTML = Array.from(salesMap.values())
      .sort((a,b)=>a.localeCompare(b,'vi'))
      .map(v => `<option value="${v}"></option>`).join('');
  }

  // 3) NV GIAO HÀNG (lấy từ mảng cứng + dữ liệu thực tế trong 2 bảng)
  const deliveryMap = new Map();
  (GIAO_HANG_NV_LIST || []).forEach(n => {
    const v = (n || '').toString().trim();
    if (!v) return;
    const key = normalizeVi(v);
    if (!deliveryMap.has(key)) deliveryMap.set(key, v);
  });
  const DELIVERY_KEYS = ['Giao hàng cho nợ', 'Giao hàng nhận tiền', 'NV cho nợ', 'NV Giao hàng'];
  all.forEach(r => {
    DELIVERY_KEYS.forEach(k => {
      const v = (r[k] || '').toString().trim();
      if (!v) return;
      const key = normalizeVi(v);
      if (!deliveryMap.has(key)) deliveryMap.set(key, v);
    });
  });
  const deliveryDL = document.getElementById('delivery-staff-list-options');
  if (deliveryDL) {
    deliveryDL.innerHTML = Array.from(deliveryMap.values())
      .sort((a,b)=>a.localeCompare(b,'vi'))
      .map(v => `<option value="${v}"></option>`).join('');
  }

  // 4) Region & Phone
  const regions = new Map();
  const phones  = new Map();
  all.forEach(r => {
    const kv = (r['Khu vực'] || '').toString().trim();
    if (kv) {
      const key = normalizeVi(kv);
      if (!regions.has(key)) regions.set(key, kv);
    }
    const ph = (r['SĐT'] || '').toString().trim();
    if (ph) {
      const key = ph.replace(/\D/g,''); // phone dedupe theo số
      if (!phones.has(key)) phones.set(key, ph);
    }
  });
  const regionDL = document.getElementById('region-list-options');
  if (regionDL) {
    regionDL.innerHTML = Array.from(regions.values())
      .sort((a,b)=>a.localeCompare(b,'vi'))
      .map(v => `<option value="${v}"></option>`).join('');
  }
  const phoneDL = document.getElementById('phone-list-options');
  if (phoneDL) {
    phoneDL.innerHTML = Array.from(phones.values())
      .sort()
      .map(v => `<option value="${v}"></option>`).join('');
  }
}



  function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => { toast.remove(); }, 5000);
  }
  
  function createCellInput(originalHeader, value) {
      const formattedValue = value ?? '';
      let inputHtml = '';
      const readonlyAttr = (['Địa chỉ', 'Khu vực', 'SĐT', 'Số tiền nợ', 'Ngày nợ', 'Số ngày'].includes(originalHeader)) ? 'readonly' : '';

      // KHTN — map 'Tên Khách Hàng' theo id nợ nếu có (giữ nguyên logic cũ)
      if (originalHeader === 'Tên Khách Hàng') {
        const khn = originalTableData['khn']?.data || [];
        const debt = khn.find(d => String(d.id) === String(value));
        const displayValue = debt ? (debt['Tên Khách Hàng'] || '') : (value || '');
        inputHtml = `<input type="text" data-field="${originalHeader}" value="${displayValue}" readonly>`;
      
      } else if (['Địa chỉ', 'Khu vực', 'Ghi chú'].includes(originalHeader)) {
        inputHtml = `<textarea data-field="${originalHeader}" ${readonlyAttr}>${formattedValue}</textarea>`;

      /* ✓ đổi sang input text cho cả hai tên cột giao hàng */
      } else if (
  originalHeader === 'Giao hàng cho nợ' ||
  originalHeader === 'Giao hàng nhận tiền' ||
  originalHeader === 'NV cho nợ' ||
  originalHeader === 'NV Giao hàng'
) {
  inputHtml = `<input type="text" list="delivery-staff-list-options" data-field="${originalHeader}" value="${formattedValue}">`;

} else if (
  originalHeader === 'Người chịu trách nhiệm' ||
  originalHeader === 'NV Kinh doanh (Chịu Trách Nhiệm)'
) {
  inputHtml = `<input type="text" list="sales-person-list-options" data-field="${originalHeader}" value="${formattedValue}">`;

      } else if (['Ngày trả', 'Ngày nợ'].includes(originalHeader)) {
        inputHtml = `<input type="date" data-field="${originalHeader}" value="${formatDateForInput(formattedValue)}" ${readonlyAttr}>`;
      } else if (['Số tiền trả nợ', 'Số tiền nợ'].includes(originalHeader)) {
        const numericValue = (Number(String(formattedValue).replace(/\./g, '')) || 0).toLocaleString('vi-VN');
        inputHtml = `<input type="text" inputmode="decimal" data-field="${originalHeader}" value="${numericValue}" ${readonlyAttr}>`;
      } else if (originalHeader === 'SĐT') {
        inputHtml = `<input type="tel" data-field="${originalHeader}" value="${formattedValue}" ${readonlyAttr} placeholder="Số điện thoại...">`;
      } else {
        inputHtml = `<input type="text" data-field="${originalHeader}" value="${formattedValue}" ${readonlyAttr}>`;
      }
      return `<td>${inputHtml}</td>`;
  }

  /* ==== Toolbox (tìm kiếm + thêm theo KH) ==== */
  /* ==== Toolbox (tìm kiếm + thêm theo KH) ==== */
function createExternalControls(tableKey, displayedHeaders) {
  const cfg = TABLE_CONFIG[tableKey];
  if (!cfg) return;

  // Host cho filters nằm TRÊN tiêu đề
  const host = document.getElementById(`filters-${tableKey}`);
  if (!host) return;

  // Chỉ tạo 1 lần
  if (host.querySelector('.table-controls')) return;

  const controls = document.createElement('div');
  controls.className = 'table-controls';

  const filters = document.createElement('details');
  filters.className = 'filters-panel';
  filters.open = true;
 filters.innerHTML = `
  <summary class="search-label">Tìm kiếm</summary>
  <div class="filters-grid">
    ${
      displayedHeaders.map(h => {
        const ph = headerMapping[h] || h;

        if (h === 'Tên Khách Hàng') {
          return `
            <div class="field">
              <label>${ph}</label>
              <input class="filter-input" data-header="${h}"
                     list="customer-list-options"
                     placeholder="${ph}...">
            </div>`;
        }
        const mapped = headerMapping[h] || h;

if (h === 'Người chịu trách nhiệm' || mapped === 'NV Kinh doanh (Chịu Trách Nhiệm)') {
  return `
    <div class="field">
      <label>${mapped}</label>
      <input class="filter-input" data-header="${h}"
             list="sales-person-list-options"
             placeholder="${mapped}...">
    </div>`;
}

       if (
  h === 'Giao hàng cho nợ' ||
  h === 'Giao hàng nhận tiền' ||
  h === 'NV cho nợ' ||
  mapped === 'NV Giao hàng'
) {
  const label = headerMapping[h] || mapped;
  return `
    <div class="field">
      <label>${label}</label>
      <input class="filter-input" data-header="${h}"
             list="delivery-staff-list-options"
             placeholder="${label}...">
    </div>`;
}

        if (h === 'Khu vực') {
          return `
            <div class="field">
              <label>${ph}</label>
              <input class="filter-input" data-header="${h}"
                     list="region-list-options"
                     placeholder="${ph}...">
            </div>`;
        }
        if (h === 'SĐT') {
          return `
            <div class="field">
              <label>${ph}</label>
              <input class="filter-input" data-header="${h}" type="tel"
                     list="phone-list-options"
                     placeholder="Số điện thoại...">
            </div>`;
        }

        return `
          <div class="field">
            <label>${ph}</label>
            <input class="filter-input" data-header="${h}" placeholder="${ph}...">
          </div>`;
      }).join('')
    }
  </div>
`;


  const addPanel = document.createElement('details');
  addPanel.className = 'add-panel';
  addPanel.open = true;
  addPanel.innerHTML = `
    <summary>
      <span class="title">Thêm thanh toán theo Khách Hàng</span>
      <button type="button" id="btn-add-${tableKey}" class="add-btn-inline">
        <i class="fa fa-plus"></i> Thêm theo KH
      </button>
    </summary>

    <div class="add-grid">
      <div class="field">
        <label>Khách Hàng (chỉ hiển thị KH còn nợ)</label>
        <div class="custom-dropdown-container">
          <input type="text" id="ext-khtn-customer-search" class="customer-search-input" placeholder="Tìm kiếm khách hàng..." autocomplete="off">
          <div id="ext-khtn-customer-dropdown" class="custom-dropdown-list" style="display: none;">
            <!-- Options will be populated by JavaScript -->
          </div>
        </div>
      </div>
      
      <div class="field">
        <label>Đơn nợ</label>
        <div class="custom-dropdown-container">
          <input type="text" id="ext-khtn-debt-search" class="debt-search-input" placeholder="Chọn đơn nợ..." autocomplete="off" readonly>
          <div id="ext-khtn-debt-dropdown" class="custom-dropdown-list" style="display: none;">
            <!-- Debt options will be populated by JavaScript -->
          </div>
        </div>
      </div>
      
      <div class="field">
        <label>NV cho nợ</label>
        <input type="text" id="ext-khtn-delivery-staff" class="staff-input" placeholder="Nhân viên giao hàng..." readonly>
      </div>
    </div>
    
    <div class="payment-section">
      <div class="payment-mode-selector">
        <label class="payment-mode-label">Chế độ thanh toán:</label>
        <div class="payment-mode-options">
          <label class="payment-mode-option">
            <input type="radio" name="payment-mode" value="by-debt" checked>
            <span>Trả theo đơn</span>
          </label>
          <label class="payment-mode-option">
            <input type="radio" name="payment-mode" value="custom-amount">
            <span>Trả số tiền tùy ý</span>
          </label>
        </div>
      </div>
      
      <div class="payment-amount-section">
        <div class="field">
          <label>Số tiền nợ</label>
          <input type="text" id="ext-khtn-debt-amount" class="debt-amount-input" placeholder="0" readonly>
        </div>
        
        <div class="field">
          <label>Số tiền trả</label>
          <input type="text" id="ext-khtn-payment-amount" class="payment-amount-input" placeholder="Nhập số tiền trả..." inputmode="decimal">
        </div>
      </div>
    </div>
  `;

  controls.appendChild(filters);
  controls.appendChild(addPanel);
  host.appendChild(controls);
  // === Format tiền cho 2 filter: "Số tiền nợ" & "Số tiền trả nợ"
const moneyFilters = controls.querySelectorAll(
  '.filter-input[data-header="Số tiền nợ"], .filter-input[data-header="Số tiền trả nợ"]'
);

moneyFilters.forEach(inp => {
  // bật kiểu nhập số
  inp.setAttribute('inputmode', 'decimal');

  // format realtime khi gõ
  const formatNow = () => liveFormatCurrency(inp);

  inp.addEventListener('input', formatNow);
  inp.addEventListener('paste', () => setTimeout(formatNow, 0));

  // rời ô / Enter / Tab cũng format lại
  const finalize = () => formatNow();
  inp.addEventListener('blur', finalize);
  inp.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' || e.key === 'Tab') finalize();
    if (e.key === ' ' || e.code === 'Space') { e.preventDefault(); finalize(); }
  });

  // format giá trị ban đầu nếu có
  formatNow();
});

  

  // Lọc
  controls.querySelectorAll('.filter-input').forEach(inp => {
    inp.addEventListener('input', () => filterTable(tableKey));
  });

  // Thêm theo KH
  const khInput = controls.querySelector('#ext-khtn-customer-search');
  const khDropdown = controls.querySelector('#ext-khtn-customer-dropdown');
  const debtInput = controls.querySelector('#ext-khtn-debt-search');
  const debtDropdown = controls.querySelector('#ext-khtn-debt-dropdown');
  const staffInput = controls.querySelector('#ext-khtn-delivery-staff');
  const debtAmountInput = controls.querySelector('#ext-khtn-debt-amount');
  const paymentAmountInput = controls.querySelector('#ext-khtn-payment-amount');
  const paymentModeRadios = controls.querySelectorAll('input[name="payment-mode"]');
  const addBtn  = controls.querySelector(`#btn-add-${tableKey}`);
  
  let selectedCustomer = '';
  let selectedDebt = '';
  let selectedCustomerData = null;
  let selectedDebtData = null;
  
  const triggerAdd = () => {
    if (!selectedCustomer) { 
      showToast('Vui lòng chọn Khách Hàng còn nợ.', 'warning'); 
      return; 
    }
    
    const paymentMode = controls.querySelector('input[name="payment-mode"]:checked').value;
    const paymentAmount = parseFloat(paymentAmountInput.value.replace(/[^\d]/g, '')) || 0;
    
    if (paymentMode === 'by-debt') {
      if (!selectedDebt) { 
        showToast('Vui lòng chọn Đơn nợ.', 'warning'); 
        return; 
      }
      if (paymentAmount <= 0) {
        showToast('Vui lòng nhập số tiền trả.', 'warning');
        return;
      }
    } else {
      if (paymentAmount <= 0) {
        showToast('Vui lòng nhập số tiền trả.', 'warning');
        return;
      }
    }
    
    // Xử lý thanh toán theo chế độ đã chọn
    if (paymentMode === 'by-debt') {
      handlePaymentByDebt();
    } else {
      handlePaymentCustomAmount();
    }
    
    // Reset form
    resetPaymentForm();
  };
  
  addBtn.addEventListener('click', (e) => { e.stopPropagation(); triggerAdd(); });
  
  // Customer search input events
  khInput.addEventListener('input', (e) => {
    const searchTerm = e.target.value;
    selectedCustomer = ''; // Reset selection when typing
    updateCustomerDropdown();
    khDropdown.style.display = searchTerm ? 'block' : 'none';
  });
  
  khInput.addEventListener('focus', () => {
    if (khInput.value) {
      updateCustomerDropdown();
      khDropdown.style.display = 'block';
    } else {
      updateCustomerDropdown();
      khDropdown.style.display = 'block';
    }
  });
  
  khInput.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      khDropdown.style.display = 'none';
      khInput.blur();
    } else if (e.key === 'Enter') {
      e.preventDefault();
      if (selectedCustomer) {
        triggerAdd();
      }
    }
  });
  
  // Customer dropdown option click events
  khDropdown.addEventListener('click', (e) => {
    const option = e.target.closest('.dropdown-option');
    if (option) {
      selectedCustomer = option.dataset.value;
      selectedCustomerData = customerDebtList.find(c => normalizeVi(c.name) === normalizeVi(selectedCustomer));
      khInput.value = selectedCustomer;
      khDropdown.style.display = 'none';
      
      // Update debt dropdown for selected customer
      updateDebtDropdown();
      
      // Reset payment form when customer changes
      debtInput.value = '';
      staffInput.value = '';
      debtAmountInput.value = '';
      paymentAmountInput.value = '';
      selectedDebt = '';
      selectedDebtData = null;
      
      // Update debt amount display based on payment mode
      const paymentMode = controls.querySelector('input[name="payment-mode"]:checked').value;
      if (paymentMode === 'custom-amount' && selectedCustomerData) {
        debtAmountInput.value = selectedCustomerData.remain.toLocaleString('vi-VN');
      }
      
      // Highlight selected option
      khDropdown.querySelectorAll('.dropdown-option').forEach(opt => opt.classList.remove('selected'));
      option.classList.add('selected');
    }
  });
  
  // Debt input events
  debtInput.addEventListener('click', () => {
    if (selectedCustomer) {
      updateDebtDropdown();
      debtDropdown.style.display = 'block';
    } else {
      showToast('Vui lòng chọn Khách Hàng trước.', 'warning');
    }
  });
  
  debtInput.addEventListener('focus', () => {
    if (selectedCustomer) {
      updateDebtDropdown();
      debtDropdown.style.display = 'block';
    }
  });
  
  // Debt dropdown option click events
  debtDropdown.addEventListener('click', (e) => {
    const option = e.target.closest('.dropdown-option');
    if (option) {
      selectedDebt = option.dataset.value;
      selectedDebtData = selectedCustomerData.debts.find(d => d.id === selectedDebt);
      debtInput.value = option.dataset.display;
      staffInput.value = option.dataset.staff || '';
      
      // Auto-fill debt amount and payment amount in "by-debt" mode
      const paymentMode = controls.querySelector('input[name="payment-mode"]:checked').value;
      if (paymentMode === 'by-debt' && selectedDebtData) {
        const toNum = (v) => Number(String(v ?? '').replace(/[^\d]/g, '')) || 0;
        const remain = Number.isFinite(selectedDebtData._conLai) ? Number(selectedDebtData._conLai) : toNum(selectedDebtData['Số tiền nợ']);
        debtAmountInput.value = remain.toLocaleString('vi-VN');
        paymentAmountInput.value = remain.toLocaleString('vi-VN');
      }
      
      debtDropdown.style.display = 'none';
      
      // Highlight selected option
      debtDropdown.querySelectorAll('.dropdown-option').forEach(opt => opt.classList.remove('selected'));
      option.classList.add('selected');
    }
  });
  
  // Payment mode change events
  paymentModeRadios.forEach(radio => {
    radio.addEventListener('change', (e) => {
      const mode = e.target.value;
      if (mode === 'by-debt') {
        debtInput.disabled = false;
        debtInput.style.cursor = 'pointer';
        debtInput.style.background = '#fff';
        paymentAmountInput.placeholder = 'Số tiền sẽ tự động điền...';
        paymentAmountInput.readOnly = true;
        paymentAmountInput.style.background = '#f3f4f6';
        paymentAmountInput.style.cursor = 'default';
      } else {
        debtInput.disabled = true;
        debtInput.style.cursor = 'not-allowed';
        debtInput.style.background = '#f9fafb';
        paymentAmountInput.placeholder = 'Nhập số tiền trả...';
        paymentAmountInput.readOnly = false;
        paymentAmountInput.style.background = '#fff';
        paymentAmountInput.style.cursor = 'text';
        // Reset debt selection when switching to custom amount
        selectedDebt = '';
        selectedDebtData = null;
        debtInput.value = '';
        staffInput.value = '';
        debtAmountInput.value = '';
        paymentAmountInput.value = '';
        
        // Fill total debt amount for custom payment mode
        if (selectedCustomerData) {
          debtAmountInput.value = selectedCustomerData.remain.toLocaleString('vi-VN');
        }
      }
    });
  });
  
  // Payment amount input formatting
  paymentAmountInput.addEventListener('input', (e) => {
    const value = e.target.value.replace(/[^\d]/g, '');
    const formatted = value ? Number(value).toLocaleString('vi-VN') : '';
    e.target.value = formatted;
  });
  
  // Functions for payment processing
  function handlePaymentByDebt() {
    if (!selectedDebtData) return;
    
    const paymentAmount = parseFloat(paymentAmountInput.value.replace(/[^\d]/g, '')) || 0;
    const debtAmount = parseFloat(selectedDebtData._conLai) || parseFloat(selectedDebtData['Số tiền nợ'].replace(/[^\d]/g, '')) || 0;
    
    if (paymentAmount > debtAmount) {
      showToast(`Số tiền trả không được vượt quá số tiền nợ (${debtAmount.toLocaleString('vi-VN')} VNĐ)`, 'warning');
      return;
    }
    
    // Tạo bản ghi thanh toán cho đơn cụ thể
    addPaymentRecord(selectedCustomer, selectedDebtData, paymentAmount);
  }
  
  function handlePaymentCustomAmount() {
    if (!selectedCustomerData) return;
    
    const paymentAmount = parseFloat(paymentAmountInput.value.replace(/[^\d]/g, '')) || 0;
    const totalDebt = selectedCustomerData.remain;
    
    if (paymentAmount > totalDebt) {
      showToast(`Số tiền trả không được vượt quá tổng nợ (${totalDebt.toLocaleString('vi-VN')} VNĐ)`, 'warning');
      return;
    }
    
    // Phân bổ thanh toán theo thứ tự đơn nợ
    distributePaymentAcrossDebts(selectedCustomerData, paymentAmount);
  }
  
  function addPaymentRecord(customerName, debtData, amount) {
    // Logic thêm bản ghi thanh toán cho 1 đơn cụ thể
    const tempId = crypto.randomUUID();
    const toNum = (v) => Number(String(v ?? '').replace(/[^\d]/g, '')) || 0;
    const remain = Number.isFinite(debtData._conLai) ? Number(debtData._conLai) : toNum(debtData['Số tiền nợ']);
    
    const rowData = {
      'id': tempId,
      'id nợ': debtData.id,
      'Tên Khách Hàng': customerName,
      'Khu vực': debtData['Khu vực'] || '',
      'Địa chỉ': debtData['Địa chỉ'] || '',
      'SĐT': debtData['SĐT'] || '',
      'Số tiền nợ': remain,
      'Số tiền trả nợ': amount,
      'Ngày trả': formatDateForServer(new Date()),
      [giaoHangHeader()]: debtData[giaoHangHeader()] || debtData['Giao hàng cho nợ'] || debtData['Giao hàng nhận tiền'] || '',
      'Người chịu trách nhiệm': debtData['Người chịu trách nhiệm'] || debtData['NV Kinh doanh (Chịu Trách Nhiệm)'] || '',
      'Ghi chú': debtData['Ghi chú'] || ''
    };
    
    // Thêm vào changeSet
    if (!changeSet.create[tableKey]) changeSet.create[tableKey] = {};
    changeSet.create[tableKey][tempId] = rowData;
    
    // Thêm vào bảng
    addRowToTable(rowData, tempId);
  }
  
  function distributePaymentAcrossDebts(customerData, totalPayment) {
    let remainingPayment = totalPayment;
    const toNum = (v) => Number(String(v ?? '').replace(/[^\d]/g, '')) || 0;
    const debts = customerData.debts.sort((a, b) => new Date(a['Ngày nợ']) - new Date(b['Ngày nợ']));
    
    for (const debt of debts) {
      if (remainingPayment <= 0) break;
      
      const debtAmount = Number.isFinite(debt._conLai) ? Number(debt._conLai) : toNum(debt['Số tiền nợ']);
      if (debtAmount <= 0) continue;
      
      const paymentForThisDebt = Math.min(remainingPayment, debtAmount);
      
      addPaymentRecord(customerData.name, {
        ...debt,
        _conLai: debtAmount
      }, paymentForThisDebt);
      
      remainingPayment -= paymentForThisDebt;
    }
  }
  
  function addRowToTable(rowData, tempId) {
    const container = document.getElementById(TABLE_CONFIG[tableKey].containerId);
    const tbody = container.querySelector('tbody');
    
    const newTr = document.createElement('tr');
    newTr.dataset.id = tempId;
    newTr.dataset.idNo = rowData['id nợ'] || '';
    newTr.classList.add('row-new');
    
    const headers = originalTableData[tableKey].headers;
    let localHiddenColumns = [...HIDDEN_COLUMNS, 'Ngày nợ', 'Số ngày'];
    const cellsHtml = headers.map(h => {
      if (localHiddenColumns.includes(h)) return `<td style="display: none;"></td>`;
      return createCellInput(h, rowData[h]);
    }).join('');
    
    newTr.innerHTML = `<td class="align-center"><span class="delete-btn temp-delete-btn" data-id="${tempId}">&#10006;</span></td>` + cellsHtml;
    newTr.querySelectorAll('input[inputmode="decimal"]').forEach(inp => setupCurrencyInput(inp, tableKey));
    
    tbody.insertBefore(newTr, tbody.firstChild);
    
    setChangesMade(tableKey, true);
    updateTotals(tableKey);
    updateDashboard();
    updateVisibleRowCount(tableKey);
    
    // Cập nhật lại số tiền nợ còn lại sau khi thêm bản ghi
    calculateRemainingDebts();
  }
  
  function resetPaymentForm() {
    khInput.value = '';
    debtInput.value = '';
    staffInput.value = '';
    debtAmountInput.value = '';
    paymentAmountInput.value = '';
    selectedCustomer = '';
    selectedDebt = '';
    selectedCustomerData = null;
    selectedDebtData = null;
    khDropdown.style.display = 'none';
    debtDropdown.style.display = 'none';
  }
  
  // Close dropdowns when clicking outside
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.custom-dropdown-container')) {
      khDropdown.style.display = 'none';
      debtDropdown.style.display = 'none';
    }
  });
}


  function renderTable(tableKey, data) {
      const config = TABLE_CONFIG[tableKey];
      const container = document.getElementById(config.containerId);
      if (!container) return;
      if (!data.data || !data.headers) { container.innerHTML = '<p class="status-indicator">Không có dữ liệu.</p>'; return; }
       container.innerHTML = '';
      let localHiddenColumns = [...HIDDEN_COLUMNS, 'Ngày nợ', 'Số ngày'];
      const headers = data.headers;
      const displayedHeaders = headers.filter(h => !localHiddenColumns.includes(h));

      createExternalControls(tableKey, displayedHeaders);

      const headerHtml = `
        <thead>
          <tr>
            <th style="width:120px; min-width:120px; text-align:center;">Xóa</th>
            ${displayedHeaders.map(h => `<th data-field="${h}">${headerMapping[h] || h}</th>`).join('')}
          </tr>
        </thead>`;

      const bodyHtml = `<tbody>${
          data.data.map(row => { 
              const rId = row['id']; 
              const cH = headers.map(h => {
                  if (localHiddenColumns.includes(h)) return `<td style="display: none;">${row[h] || ''}</td>`;
                  return createCellInput(h, row[h]);
              }).join('');
              return `<tr data-id="${rId}" data-id-no="${row['id nợ'] || ''}">
                        <td class="align-center"><span class="delete-btn" data-id="${rId}">&#10006;</span></td>
                        ${cH}
                      </tr>`;
          }).join('')
      }</tbody>`;

      const tableEl = document.createElement('table');
      tableEl.innerHTML = `${headerHtml}${bodyHtml}<tfoot></tfoot>`;
      container.appendChild(tableEl);

      makeColumnsResizable(tableEl);
      setupEventListeners(tableKey, container);

      updateTotals(tableKey);
      applyPermissions(tableKey);
      populateFilterDatalists();

  }
  
  function updateVisibleRowCount(tableKey) {
      const config = TABLE_CONFIG[tableKey];
      const container = document.getElementById(config.containerId);
      if (!container || !config.countId) return;
      const visibleRows = container.querySelectorAll('tbody tr:not([style*="display: none"])');
      document.getElementById(config.countId).textContent = `${visibleRows.length} bản ghi`;
  }

  function updateTotals(tableKey) {
      const container = document.getElementById(TABLE_CONFIG[tableKey].containerId); if (!container) return;
      const table = container.querySelector('table'); if (!table) return;
      const tfoot = table.querySelector('tfoot'); if (!tfoot) return;
      const headers = Array.from(table.querySelectorAll('thead tr:first-child th')).slice(1).map(th => Object.keys(headerMapping).find(key => headerMapping[key] === th.textContent) || th.textContent);
      const visibleRows = Array.from(table.querySelectorAll('tbody tr')).filter(row => row.style.display !== 'none');
      let totalRowHtml = '<td>Tổng cộng</td>';
      headers.forEach(header => {
          if (NUMERIC_COLUMNS_FOR_TOTAL.includes(header)) {
              const total = visibleRows.reduce((sum, row) => { const input = row.querySelector(`[data-field="${header}"]`); return sum + (parseFloat((input ? input.value || '0' : '0').replace(/\./g, '')) || 0); }, 0);
              totalRowHtml += `<td class="align-right">${total.toLocaleString('vi-VN')}</td>`;
          } else { totalRowHtml += '<td></td>'; }
      });
      tfoot.innerHTML = `<tr>${totalRowHtml}</tr>`;
  }

  function handleCustomerNameSelectForPayment(e) {
  if (!currentPerms.canCreate) {
    showToast('Bạn không có quyền thêm mới.', 'error');
    if (e.target && 'value' in e.target) e.target.value = '';
    return;
  }

  const customerName = (e.target?.value || '').trim();
  if (!customerName) return;

  // chuẩn hóa so khớp tên KH
const norm = (s) => normalizeVi(String(s || ''));
const inputNameNorm = norm(customerName);

const khnData = originalTableData['khn']?.data || [];
const toNum = (v) => Number(String(v ?? '').replace(/[^\d]/g, '')) || 0;

const outstandingDebts = khnData.filter(d => {

  const sameCustomer = norm(d['Tên Khách Hàng']) === inputNameNorm;

  // remain có fallback: ưu tiên _conLai; nếu thiếu thì dùng 'Số tiền nợ'
  const remain = Number.isFinite(d._conLai)
    ? Number(d._conLai)
    : toNum(d['Số tiền nợ']);

  const notPicked = !tempSelectedDebtIds.map(String).includes(String(d.id));
  return sameCustomer && remain > 0 && notPicked;
});


  if (outstandingDebts.length === 0) {
    showToast(`Không tìm thấy khoản nợ nào còn lại cho "${customerName}".`, 'warning');
    if (e.target && 'value' in e.target) e.target.value = '';
    return;
  }

  // 🔑 Chỉ gộp khi 7 trường đều giống nhau
  const ghCol = giaoHangHeader(); // 'Giao hàng nhận tiền' hoặc 'Giao hàng cho nợ'
  const groups = {};
  for (const debt of outstandingDebts) {
    const key = [
      debt['Tên Khách Hàng'] || '',
      debt['Khu vực'] || '',
      debt['Địa chỉ'] || '',
      debt['SĐT'] || '',
      debt[ghCol] || '',
      debt['Người chịu trách nhiệm'] || '',
      debt['Ghi chú'] || ''
    ].map(v => String(v).trim().toLowerCase()).join('||');

    if (!groups[key]) groups[key] = [];
    groups[key].push(debt);
  }

  Object.values(groups).forEach(debts => {
    const nvkd = debts[0]['Người chịu trách nhiệm'] || '(Chưa gán NVKD)';
    addPaymentRowForGroup(customerName, nvkd, debts);
  });

  if (e.target && 'value' in e.target) e.target.value = '';
}


  function addPaymentRowForGroup(customerName, nvkd, debts) {
  const tableKey = 'khtn';
  const headers = originalTableData[tableKey].headers;

  const ids = debts.map(d => d.id);
  const tongConLai = debts.reduce((s, d) => s + (d._conLai || 0), 0);

  tempSelectedDebtIds.push(...ids);
  calculateRemainingDebts();


  const tempId = crypto.randomUUID();
  const rowData = {};
  headers.forEach(h => rowData[h] = '');

  const ghCol = giaoHangHeader(); // ✅

  rowData['id'] = tempId;
  rowData['id nợ'] = ids.join(',');
  rowData['Tên Khách Hàng'] = customerName;
  rowData['Khu vực'] = debts[0]['Khu vực'] || '';
  rowData['Địa chỉ'] = debts[0]['Địa chỉ'] || '';
  rowData['SĐT'] = debts[0]['SĐT'] || '';
  rowData['Số tiền nợ'] = tongConLai;
  rowData['Ngày nợ'] = '';
 rowData[ghCol] = debts[0][ghCol]
  ?? debts[0]['Giao hàng cho nợ']
  ?? debts[0]['Giao hàng nhận tiền']
  ?? debts[0]['NV cho nợ']
  ?? '';

  rowData['Người chịu trách nhiệm'] = nvkd;
  rowData['Ghi chú'] = debts[0]['Ghi chú'] || ''; // ✅ copy đúng Ghi chú
  rowData['Ngày trả'] = formatDateForServer(new Date());
  rowData['Số tiền trả nợ'] = '';

  if (!changeSet.create[tableKey]) changeSet.create[tableKey] = {};
  changeSet.create[tableKey][tempId] = rowData;

  const newTr = document.createElement('tr');
  newTr.dataset.id = tempId;
  newTr.dataset.idNo = rowData['id nợ'] || '';
  newTr.classList.add('row-new');

  let localHiddenColumns = [...HIDDEN_COLUMNS, 'Ngày nợ', 'Số ngày'];
  const cellsHtml = headers.map(h => {
    if (localHiddenColumns.includes(h)) return `<td style="display: none;"></td>`;
    return createCellInput(h, rowData[h]);
  }).join('');

  newTr.innerHTML = `<td class="align-center"><span class="delete-btn temp-delete-btn" data-id="${tempId}">&#10006;</span></td>` + cellsHtml;
  newTr.querySelectorAll('input[inputmode="decimal"]').forEach(inp => setupCurrencyInput(inp, 'khtn'));

  const container = document.getElementById(TABLE_CONFIG[tableKey].containerId);
  const tbody = container.querySelector('tbody');
  tbody.insertBefore(newTr, tbody.firstChild);

  setChangesMade(tableKey, true);
  updateTotals(tableKey);
  updateDashboard();
  updateVisibleRowCount(tableKey);
}


  function addPaymentRowForDebt(debt) {
      const tableKey = 'khtn';
      const headers = originalTableData[tableKey].headers;
      const rowData = {};
      rowData['id nợ'] = debt.id;
      rowData['Tên Khách Hàng'] = debt['Tên Khách Hàng'];
      rowData['Khu vực'] = debt['Khu vực'];
      rowData['Địa chỉ'] = debt['Địa chỉ'];
      rowData['SĐT'] = debt['SĐT'];
      rowData['Số tiền nợ'] = debt['Số tiền nợ'];
      rowData['Ngày nợ'] = formatDateForServer(debt['Ngày nợ']);
      /* ✓ dùng đúng tên cột có sẵn, fallback nếu khác tên */
      const ghCol = giaoHangHeader();
      rowData[ghCol] = debt[ghCol] ?? debt['Giao hàng cho nợ'] ?? debt['Giao hàng nhận tiền'] ?? '';
      rowData['Người chịu trách nhiệm'] = debt['Người chịu trách nhiệm'];
      rowData['Ngày trả'] = formatDateForServer(new Date());
      rowData['Số tiền trả nợ'] = debt._conLai;
if (rowData['Ngày trả'] && debt['Ngày nợ']) {
    const diffTime = Math.abs(new Date(rowData['Ngày trả']) - new Date(debt['Ngày nợ']));
    rowData['Số ngày'] = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
}

      tempSelectedDebtIds.push(debt.id);
      calculateRemainingDebts();
      const tempId = crypto.randomUUID();
      rowData['id'] = tempId;
      if (!changeSet.create[tableKey]) changeSet.create[tableKey] = {};
      changeSet.create[tableKey][tempId] = rowData;

      const newTr = document.createElement('tr');
      newTr.dataset.id = tempId; newTr.dataset.idNo = rowData['id nợ'] || ''; newTr.classList.add('row-new');
      let localHiddenColumns = [...HIDDEN_COLUMNS, 'Ngày nợ', 'Số ngày'];
      const cellsHtml = headers.map(h => {
          if (localHiddenColumns.includes(h)) return `<td style="display: none;"></td>`;
          const createCellValue = (h === 'Tên Khách Hàng') ? rowData['id nợ'] : rowData[h];
          return createCellInput(h, createCellValue);
      }).join('');
      newTr.innerHTML = `<td class="align-center"><span class="delete-btn temp-delete-btn" data-id="${tempId}">&#10006;</span></td>` + cellsHtml;
      newTr.querySelectorAll('input[inputmode="decimal"]').forEach(inp => setupCurrencyInput(inp, 'khtn'));

      const container = document.getElementById(TABLE_CONFIG[tableKey].containerId);
      const tbody = container.querySelector('tbody');
      tbody.insertBefore(newTr, tbody.firstChild);

      setChangesMade(tableKey, true);
      updateTotals(tableKey);
      updateDashboard();
      updateVisibleRowCount(tableKey);
  }

  function makeColumnsResizable(table){
    if (!table) return;
    const headerThs = Array.from(table.querySelectorAll('thead th[data-field]'));

    headerThs.forEach((th, displayIdx) => {
      th.style.position = 'relative';
      const field = th.dataset.field;

      const handle = document.createElement('div');
      handle.className = 'col-resizer';
      th.appendChild(handle);

      let startX = 0, startW = 0;

      const onMouseDown = (e) => {
        startX = e.pageX;
        startW = th.getBoundingClientRect().width;
        document.body.classList.add('resizing-col');
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
        e.preventDefault();
      };

      const onMouseMove = (e) => {
        const dx = e.pageX - startX;
        const newW = Math.max(100, startW + dx);
        th.style.width = newW + 'px';
        th.style.minWidth = newW + 'px';

        table.querySelectorAll('tbody tr').forEach(tr => {
          const ctrl = tr.querySelector(`[data-field="${CSS.escape(field)}"]`);
          if (ctrl) {
            const td = ctrl.closest('td');
            td.style.width = newW + 'px';
            td.style.minWidth = newW + 'px';
          }
        });

        const tfRow = table.querySelector('tfoot tr');
        if (tfRow && tfRow.children[displayIdx + 1]) {
          const td = tfRow.children[displayIdx + 1];
          td.style.width = newW + 'px';
          td.style.minWidth = newW + 'px';
        }
      };

      const onMouseUp = () => {
        document.body.classList.remove('resizing-col');
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
      };

      handle.addEventListener('mousedown', onMouseDown);
    });
  }

  function setupEventListeners(tableKey, container) {
      if (!container) return;
      const table = container.querySelector('table'); if (!table) return;
      const tbody = table.querySelector('tbody');

      

      tbody.addEventListener('change', (e) => { 
          const el = e.target; 
          const tr = el.closest('tr'); 
          if (tr) handleCellEdit(e, tableKey); 
      });
      tbody.addEventListener('input', (e) => { 
          if ((e.target.tagName === 'INPUT' && e.target.type === 'text' && !e.target.hasAttribute('inputmode')) || e.target.tagName === 'TEXTAREA') capitalizeFirstLetter(e.target); 
      });
      tbody.addEventListener('click', (e) => { 
          if (e.target.classList.contains('temp-delete-btn')) {
  const tr = e.target.closest('tr');
  const rowId = tr.dataset.id;
  const idNo = tr.dataset.idNo || '';

  if (idNo) {
    // gỡ từng id ra khỏi tempSelectedDebtIds
    idNo.split(',')
        .map(s => s.trim())
        .filter(Boolean)
        .forEach(id => {
          tempSelectedDebtIds = tempSelectedDebtIds.filter(x => String(x) !== id);
        });

    // tính lại công nợ còn lại rồi cập nhật datalist
    calculateRemainingDebts();
  }

  if (changeSet.create[tableKey]?.[rowId]) {
    delete changeSet.create[tableKey][rowId];
  }

  tr.remove();
  updateTotals(tableKey);
  updateDashboard();
  updateVisibleRowCount(tableKey);
  setChangesMade(tableKey, hasPendingChanges(tableKey));
  
  // Cập nhật lại số tiền nợ còn lại sau khi xóa bản ghi
  calculateRemainingDebts();
}

      });
      tbody.querySelectorAll('input[inputmode="decimal"]').forEach(inp => setupCurrencyInput(inp, tableKey));

      table.querySelectorAll('.delete-btn:not(.temp-delete-btn)').forEach(btn => btn.addEventListener('click', (e) => handleDeleteClick(e, tableKey)));
  }

  /* ✓ phiên bản ghi nhận: cho phép lưu thay đổi ở dòng mới */
  function handleCellEdit(e, tableKey) {
    const el = e.target;
    const tr = el.closest('tr');
    if (!tr) return;

    const rowId = tr.dataset.id;
    const field = el.dataset.field;
    if (!rowId || !field) return;

    let newValue = (el.getAttribute('inputmode') === 'decimal')
      ? String(el.value || '').replace(/\./g, '')
      : el.value;

    // DÒNG MỚI: cập nhật vào changeSet.create
    if (changeSet.create[tableKey] && changeSet.create[tableKey][rowId]) {
      changeSet.create[tableKey][rowId][field] = newValue;
      tr.classList.add('row-dirty');
      setChangesMade(tableKey, true);
      updateTotals(tableKey);
      updateDashboard();
      return;
    }

    // DÒNG CŨ: vẫn tôn trọng quyền
    if (!currentPerms.canEditExisting) return;

    if (!changeSet.update[tableKey]) changeSet.update[tableKey] = {};
    if (!changeSet.update[tableKey][rowId]) {
      const rowDataFromDOM = {};
      originalTableData[tableKey].headers.forEach(h => {
        const cell = tr.querySelector(`[data-field="${h}"]`);
        let v = cell ? cell.value : (originalTableData[tableKey]?.data.find(r => r.id == rowId)?.[h]);
        if (cell && cell.getAttribute('inputmode') === 'decimal') v = v.replace(/\./g, '');
        rowDataFromDOM[h] = v;
      });
      changeSet.update[tableKey][rowId] = { ...rowDataFromDOM, id: rowId };
    }
    changeSet.update[tableKey][rowId][field] = newValue;
    tr.classList.add('row-dirty');
    setChangesMade(tableKey, true);
    updateTotals(tableKey);
    updateDashboard();
  }

  function handleDeleteClick(e, tableKey) { 
  if (!currentPerms.canDelete) {
    showToast('Bạn không có quyền xóa.', 'error');
    return;
  }
  const btn = e.currentTarget || e.target;
  const rowId = btn?.dataset?.id;
  if (!rowId) return;

  if (!changeSet.delete[tableKey]) changeSet.delete[tableKey] = [];
  if (!changeSet.delete[tableKey].includes(rowId)) {
    changeSet.delete[tableKey].push(rowId);
  }

  const tr = btn.closest('tr');
  tr?.remove();

  setChangesMade(tableKey, true);
  updateTotals(tableKey);
  updateDashboard();
  updateVisibleRowCount(tableKey);
  showToast('Đã đánh dấu xóa. Nhấn "Lưu Thay Đổi" để cập nhật.', 'success');
}


  function submitNewRow(tableKey) {
      if (!currentPerms.canCreate) {
        showToast('Bạn không có quyền thêm mới.', 'error');
        return;
      }
      showToast("Vui lòng chọn một khách hàng từ danh sách ở khung trên để thêm thanh toán.", "warning");
  }

  // Hàm thực hiện optimistic update ngay lập tức
  async function performOptimisticUpdate() {
      try {
          // Cập nhật dữ liệu trong originalTableData
          const khtnData = originalTableData['khtn']?.data || [];
          const khnData = originalTableData['khn']?.data || [];
          
          // Thêm dữ liệu trả nợ mới vào khtn (chỉ thêm nếu chưa có)
          const newPayments = Object.values(changeSet.create['khtn'] || {});
          if (newPayments.length > 0) {
              // Kiểm tra duplicate trước khi thêm
              const existingIds = new Set(khtnData.map(r => r.id));
              const uniqueNewPayments = newPayments.filter(p => !existingIds.has(p.id));
              originalTableData['khtn'].data = [...khtnData, ...uniqueNewPayments];
          }
          
          // Cập nhật số tiền còn nợ trong khn
          const toNum = (v) => parseFloat(String(v || '0').replace(/\./g, '')) || 0;
          const debtById = new Map(khnData.map(r => [String(r.id), r]));
          const remaining = {};
          khnData.forEach(d => { remaining[d.id] = toNum(d['Số tiền nợ']); });
          
          // Tính toán số tiền đã trả cho từng khoản nợ
          const khtnSaved = originalTableData['khtn']?.data || [];
          for (const p of khtnSaved) {
              const raw = String(p['id nợ'] || '').trim();
              const amount = toNum(p['Số tiền trả nợ']);
              if (!raw || !amount) continue;
              
              const ids = raw.includes(',') ? raw.split(',').map(s => s.trim()).filter(Boolean) : [raw];
              let left = amount;
              
              const ordered = ids.slice().sort((a, b) => {
                  const da = new Date(debtById.get(a)?.['Ngày nợ'] || 0);
                  const db = new Date(debtById.get(b)?.['Ngày nợ'] || 0);
                  return da.getTime() - db.getTime();
              });
              
              for (const id of ordered) {
                  if (left <= 0) break;
                  const current = remaining[id] || 0;
                  const deduct = Math.min(left, current);
                  remaining[id] = Math.max(0, current - deduct);
                  left -= deduct;
              }
          }
          
          // Cập nhật số tiền còn nợ trong originalTableData
          khnData.forEach(row => {
              const newRemaining = remaining[row.id] || 0;
              row['Số tiền nợ'] = newRemaining;
          });
          
          // Cập nhật giao diện
          updateDashboard();
          updateVisibleRowCount('khtn');
          
          // Bỏ thông báo để tránh spam
          
      } catch (error) {
          console.error('Lỗi optimistic update:', error);
          showToast('Có lỗi khi cập nhật dữ liệu: ' + error.message, 'error');
      }
  }

  // Hàm lưu vào Google Sheet ở background
  async function saveToGoogleSheetInBackground(originalState) {
      try {
          const toNum = (v) => parseFloat(String(v || '0').replace(/\./g, '')) || 0;
          const deepClone = (o) => JSON.parse(JSON.stringify(o));
          const config = TABLE_CONFIG['khtn'];

          const khnRows = originalTableData['khn']?.data || [];
          const debtById = new Map(khnRows.map(r => [String(r.id), r]));
          const remaining = {};
          khnRows.forEach(d => { remaining[d.id] = toNum(d['Số tiền nợ']); });

          const khtnSaved = originalTableData['khtn']?.data || [];
          for (const p of khtnSaved) {
              const raw = String(p['id nợ'] || '').trim();
              const amount = toNum(p['Số tiền trả nợ']);
              if (!raw || !amount) continue;

              const ids = raw.includes(',') ? raw.split(',').map(s => s.trim()).filter(Boolean) : [raw];

              let left = amount;
              const ordered = ids.slice().sort((a, b) => {
                  const da = new Date(debtById.get(a)?.['Ngày nợ'] || 0);
                  const db = new Date(debtById.get(b)?.['Ngày nợ'] || 0);
                  return da.getTime() - db.getTime();
              });

              for (const id of ordered) {
                  if (left <= 0) break;
                  const current = remaining[id] || 0;
                  const deduct = Math.min(left, current);
                  remaining[id] = Math.max(0, current - deduct);
                  left -= deduct;
              }
          }

          const idsToDeleteKhn = Object.keys(remaining).filter(id => remaining[id] <= 0);
          const khnToUpdate = khnRows.filter(r => remaining[r.id] > 0).map(r => ({
              ...r, 'Số tiền nợ': remaining[r.id]
          }));

          const createDataAll = Object.values(changeSet.create['khtn'] || {});
          const updateDataAll = Object.values(changeSet.update['khtn'] || {});
          const deleteIdsAll = changeSet.delete['khtn'] || [];

          // Loại bỏ duplicate trong createData dựa trên nội dung
          const existingRecords = originalTableData['khtn']?.data || [];
          const uniqueCreateData = createDataAll.filter(newRecord => {
              // Kiểm tra xem có bản ghi tương tự đã tồn tại chưa
              return !existingRecords.some(existingRecord => 
                  existingRecord['Tên Khách Hàng'] === newRecord['Tên Khách Hàng'] &&
                  existingRecord['Số tiền trả nợ'] === newRecord['Số tiền trả nợ'] &&
                  existingRecord['Ngày trả'] === newRecord['Ngày trả'] &&
                  existingRecord['SĐT'] === newRecord['SĐT']
              );
          });

          const createData = currentPerms.canCreate ? deepClone(uniqueCreateData) : [];
          const updateData = currentPerms.canEditExisting ? deepClone(updateDataAll) : [];
          const deleteIds = currentPerms.canDelete ? deleteIdsAll : [];

          const fetchPromises = [];
          if (createData.length > 0) {
              fetchPromises.push(fetch(API_BASE_URL, {
                  method: 'POST', mode: 'no-cors',
                  body: JSON.stringify({ tableName: config.name, action: 'create', data: createData })
              }));
          }
          if (updateData.length > 0) {
              fetchPromises.push(fetch(API_BASE_URL, {
                  method: 'POST', mode: 'no-cors',
                  body: JSON.stringify({ tableName: config.name, action: 'update', data: updateData })
              }));
          }
          if (deleteIds.length > 0) {
              fetchPromises.push(fetch(API_BASE_URL, {
                  method: 'POST', mode: 'no-cors',
                  body: JSON.stringify({ tableName: config.name, action: 'delete', data: { ids: deleteIds } })
              }));
          }
          if (khnToUpdate.length > 0) {
              fetchPromises.push(fetch(API_BASE_URL, {
                  method: 'POST', mode: 'no-cors',
                  body: JSON.stringify({ tableName: TABLE_CONFIG['khn'].name, action: 'update', data: khnToUpdate })
              }));
          }
          if (idsToDeleteKhn.length > 0) {
              fetchPromises.push(fetch(API_BASE_URL, {
                  method: 'POST', mode: 'no-cors',
                  body: JSON.stringify({ tableName: TABLE_CONFIG['khn'].name, action: 'delete', data: { ids: idsToDeleteKhn } })
              }));
          }

          // Thực hiện lưu ở background
          await Promise.all(fetchPromises);
          
          // Báo thành công trên tab đích
          if (window.parent && window.parent !== window) {
              window.parent.postMessage({
                  type: 'SAVE_SUCCESS',
                  message: '✅ Lưu thành công! Dữ liệu đã được đồng bộ với Google Sheet.'
              }, '*');
          }
          
          // Reset changeSet
          changeSet = { create: {}, update: {}, delete: {} };
          tempSelectedDebtIds = [];
          Object.keys(TABLE_CONFIG).forEach(k => TABLE_CONFIG[k].loaded = false);
          
      } catch (error) {
          console.error('Lỗi lưu background:', error);
          
          // Báo lỗi và cho phép thử lại
          if (window.parent && window.parent !== window) {
              window.parent.postMessage({
                  type: 'SAVE_ERROR',
                  message: '❌ Lưu thất bại: ' + error.message,
                  originalState: originalState
              }, '*');
          }
          
          // Khôi phục trạng thái ban đầu
          if (originalState) {
              originalTableData['khn'].data = originalState.khn;
              originalTableData['khtn'].data = originalState.khtn;
              originalTableData['hth'].data = originalState.hth;
          }
      }
  }

  async function handleSaveChanges(tableKey) {
      const invalidRows = document.querySelectorAll(`#container-${tableKey} tbody tr[data-is-invalid="true"]`);
      if (invalidRows.length > 0) {
          showToast('Vui lòng sửa các lỗi nhập liệu (ô màu đỏ) trước khi lưu.', 'error');
          invalidRows[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
          return;
      }
      
      // OPTIMISTIC UPDATE: Cập nhật giao diện ngay lập tức
      const updateBtn = document.getElementById('update-btn-khtn');
      updateBtn.disabled = true;
      updateBtn.innerHTML = '<i class="fas fa-sync fa-spin"></i> Đang xử lý...';
      
      // Lưu trạng thái ban đầu để có thể hoàn tác nếu cần
      const originalState = {
          khn: JSON.parse(JSON.stringify(originalTableData['khn']?.data || [])),
          khtn: JSON.parse(JSON.stringify(originalTableData['khtn']?.data || [])),
          hth: JSON.parse(JSON.stringify(originalTableData['hth']?.data || []))
      };
      
      // Thực hiện optimistic update ngay lập tức
      await performOptimisticUpdate();
      
      // Chuyển tab ngay lập tức
      setTimeout(() => {
          if (window.parent && window.parent !== window) {
              // Gửi message chuyển tab
              window.parent.postMessage({
                  type: 'SWITCH_TAB',
                  tabName: 'KhachHangNoTab'
              }, '*');
              
              // Gửi dữ liệu cập nhật
              const debtData = {
                  khn: originalTableData['khn']?.data || [],
                  khtn: originalTableData['khtn']?.data || [],
                  hth: originalTableData['hth']?.data || []
              };
              window.parent.postMessage({
                  type: 'UPDATE_DEBT_DATA',
                  debtData: debtData
              }, '*');
          }
      }, 50); // Giảm delay để tăng tốc độ

      // Lưu vào Google Sheet ở background (không chờ kết quả)
      saveToGoogleSheetInBackground(originalState);

      const toNum = (v) => parseFloat(String(v || '0').replace(/\./g, '')) || 0;
      const deepClone = (o) => JSON.parse(JSON.stringify(o));
      const config = TABLE_CONFIG[tableKey];

      const khnRows = originalTableData['khn']?.data || [];
      const debtById = new Map(khnRows.map(r => [String(r.id), r]));
      const remaining = {};
      khnRows.forEach(d => { remaining[d.id] = toNum(d['Số tiền nợ']); });

      const khtnSaved = originalTableData['khtn']?.data || [];
      for (const p of khtnSaved) {
          const raw = String(p['id nợ'] || '').trim();
          const amount = toNum(p['Số tiền trả nợ']);
          if (!raw || !amount) continue;

          const ids = raw.includes(',') ? raw.split(',').map(s => s.trim()).filter(Boolean) : [raw];

          let left = amount;
          const ordered = ids.slice().sort((a, b) => {
              const da = new Date(debtById.get(a)?.['Ngày nợ'] || 0);
              const db = new Date(debtById.get(b)?.['Ngày nợ'] || 0);
              return da - db;
          });
          for (const id of ordered) {
              if (left <= 0) break;
              const rem = remaining[id] ?? 0;
              const take = Math.min(rem, left);
              remaining[id] = rem - take;
              left -= take;
          }
      }

      const existingUpdates = Object.values(changeSet.update[tableKey] || {});
      const existingDeletes = changeSet.delete[tableKey] || [];
      const createsRaw = Object.values(changeSet.create[tableKey] || {});
      const expandedCreates = [];

      for (const row of createsRaw) {
          const ids = String(row['id nợ'] || '')
              .split(',')
              .map(s => s.trim())
              .filter(Boolean);

          let payLeft = toNum(row['Số tiền trả nợ']);
          if (!payLeft || ids.length === 0) continue;

          const ordered = ids.slice().sort((a, b) => {
              const da = new Date(debtById.get(a)?.['Ngày nợ'] || 0);
              const db = new Date(debtById.get(b)?.['Ngày nợ'] || 0);
              return da - db;
          });

          for (const id of ordered) {
              if (payLeft <= 0) break;
              const rem = remaining[id] ?? 0;
              if (rem <= 0) continue;

              const take = Math.min(rem, payLeft);
              const one = deepClone(row);
              one['id nợ'] = id;
              one['Số tiền trả nợ'] = take;

              const dNo = debtById.get(id)?.['Ngày nợ'];
              const dTra = row['Ngày trả'] || formatDateForServer(new Date());
              if (dNo && dTra) {
                  const diffTime = Math.abs(new Date(dTra) - new Date(dNo));
                  one['Số ngày'] = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
              }

              expandedCreates.push(one);
              remaining[id] = rem - take;
              payLeft -= take;
          }
      }

      const idsToDeleteKhn = Object.keys(remaining).filter(id => (remaining[id] ?? 0) <= 0);

      const cleanData = (data) => {
          return deepClone(data).map(row => {
              Object.keys(row).forEach(key => {
                  if (key === 'SĐT' && row[key]) {
                      const phoneStr = String(row[key]).trim();
                      row[key] = "'" + phoneStr;
                  }
              });
              return row;
          });
      };

      const fetchPromises = [];

      const createData = currentPerms.canCreate ? cleanData(expandedCreates) : [];
      if (createData.length > 0) {
          fetchPromises.push(fetch(API_BASE_URL, {
              method: 'POST', mode: 'no-cors',
              body: JSON.stringify({ tableName: config.name, action: 'create', data: createData })
          }));
      }

      const updateData = currentPerms.canEditExisting ? cleanData(existingUpdates) : [];
      if (updateData.length > 0) {
          fetchPromises.push(fetch(API_BASE_URL, {
              method: 'POST', mode: 'no-cors',
              body: JSON.stringify({ tableName: config.name, action: 'update', data: updateData })
          }));
      }

      const deleteIds = currentPerms.canDelete ? existingDeletes : [];
      if (deleteIds.length > 0) {
          fetchPromises.push(fetch(API_BASE_URL, {
              method: 'POST', mode: 'no-cors',
              body: JSON.stringify({ tableName: config.name, action: 'delete', data: { ids: deleteIds } })
          }));
      }

      if (idsToDeleteKhn.length > 0) {
          fetchPromises.push(fetch(API_BASE_URL, {
              method: 'POST', mode: 'no-cors',
              body: JSON.stringify({ tableName: TABLE_CONFIG['khn'].name, action: 'delete', data: { ids: idsToDeleteKhn } })
          }));
      }

      try {
          await Promise.all(fetchPromises);
          showToast('Lưu thay đổi thành công!', 'success');

          changeSet = { create: {}, update: {}, delete: {} };
          tempSelectedDebtIds = [];
          Object.keys(TABLE_CONFIG).forEach(k => TABLE_CONFIG[k].loaded = false);
          await initApp(true);
          
          // Tự động chuyển về tab "Khách hàng nợ" sau khi lưu thành công
          setTimeout(() => {
              if (window.parent && window.parent !== window) {
                  // Gửi message cập nhật dữ liệu real-time
                  const debtData = {
                      khn: originalTableData['khn']?.data || [],
                      khtn: originalTableData['khtn']?.data || [],
                      hth: originalTableData['hth']?.data || []
                  };
                  
                  // Gửi message cập nhật dữ liệu
                  window.parent.postMessage({
                      type: 'UPDATE_DEBT_DATA',
                      debtData: debtData
                  }, '*');
                  
                  // Gửi message chuyển tab
                  window.parent.postMessage({
                      type: 'SWITCH_TAB',
                      tabName: 'KhachHangNoTab'
                  }, '*');
              } else {
                  // Nếu không trong iframe, thử tìm và click tab
                  const tabBtn = document.querySelector('button[onclick*="KhachHangNoTab"]');
                  if (tabBtn) {
                      tabBtn.click();
                  }
              }
          }, 1000); // Đợi 1 giây để đảm bảo dữ liệu đã được cập nhật
          
      } catch (error) {
          showToast('Đã xảy ra lỗi khi lưu: ' + error.message, 'error');
      } finally {
          updateBtn.innerHTML = '<i class="fas fa-save"></i> Lưu Thay Đổi';
      }
  }

  async function loadData(tableKey, onComplete) {
      const config = TABLE_CONFIG[tableKey];
      if (!config || (config.loaded && !hasPendingChanges(tableKey))) { if (onComplete) onComplete(); return; }
      if (config.containerId) document.getElementById(config.containerId).innerHTML = `<p class="status-indicator">Đang tải...</p>`;
      try {
          const response = await fetch(`${API_BASE_URL}?tableName=${encodeURIComponent(config.name)}`);
          if (!response.ok) throw new Error(`Lỗi mạng: ${response.statusText}`);
          originalTableData[tableKey] = await response.json();
          if (originalTableData[tableKey] && originalTableData[tableKey].data) {
              originalTableData[tableKey].data.forEach(row => {
                  if (row['SĐT'] && typeof row['SĐT'] === 'number') {
                      row['SĐT'] = String(row['SĐT']).padStart(10, '0');
                  } else if (row['SĐT']) {
                      row['SĐT'] = String(row['SĐT']).trim();
                  }
              });
          }
          if (config.containerId) renderTable(tableKey, originalTableData[tableKey]);
          config.loaded = true;
          if (config.containerId) setChangesMade(tableKey, false);
      } catch (error) { if (config.containerId) document.getElementById(config.containerId).innerHTML = `<p class="status-indicator error">Lỗi tải dữ liệu: ${error.message}</p>`;
      } finally { if (onComplete) onComplete(); }
  }

  async function fetchNhanSuAndLogin(username, password, errorEl, loginBtn) {
      try {
          const response = await fetch(`${API_BASE_URL}?tableName=Nhân sự`);
          if (!response.ok) throw new Error('Không thể tải dữ liệu người dùng.');
          const personnelData = await response.json();
          if (!personnelData || !personnelData.data) throw new Error('Dữ liệu người dùng không hợp lệ.');
          nhanSuList = [...new Set(personnelData.data.map(user => user['Họ và tên']))].filter(Boolean).sort();
          if (username && password) {
              const foundUser = personnelData.data.find(user => user['Tên đăng nhập'] === username && user['Passwword'] == password);
              if (foundUser) { sessionStorage.setItem('loggedInUser', JSON.stringify({
  name: foundUser['Họ và tên'],
  username: foundUser['Tên đăng nhập']
})); await initApp();
              } else { errorEl.textContent = 'Tên đăng nhập hoặc mật khẩu không đúng.'; }
          }
      } catch (error) { if(errorEl) errorEl.textContent = 'Lỗi kết nối hoặc không tìm thấy bảng Nhân sự.';
      } finally { if (loginBtn) { loginBtn.textContent = 'Đăng Nhập'; loginBtn.disabled = false; } }
  }

  async function handleLogin(e) { e.preventDefault(); const username = document.getElementById('username').value; const password = document.getElementById('password').value; const errorEl = document.getElementById('login-error'); const loginBtn = document.getElementById('login-btn'); errorEl.textContent = ''; loginBtn.textContent = 'Đang xử lý...'; loginBtn.disabled = true; await fetchNhanSuAndLogin(username, password, errorEl, loginBtn); }
  function handleLogout() { sessionStorage.removeItem('loggedInUser'); location.reload(); }

  async function initApp(isReload = false) {
      const user = JSON.parse(sessionStorage.getItem('loggedInUser'));
      if (user) {
          if (!isReload) {
              document.getElementById('login-overlay').style.display = 'none';
              document.querySelector('.container').classList.add('visible');
              const userInfoEl = document.getElementById('user-info');
              userInfoEl.innerHTML = `Xin chào, <strong>${user.name}</strong>! <a href="#" id="logout-btn">Đăng xuất</a>`;
              document.getElementById('logout-btn').addEventListener('click', handleLogout);
              currentPerms = computePerms(user.name);
          }
          await fetchNhanSuAndLogin(); 
          const salesDatalist = document.getElementById('sales-person-list-options');
          if (salesDatalist && nhanSuList.length > 0) salesDatalist.innerHTML = nhanSuList.map(name => `<option value="${name}"></option>`).join('');
          await Promise.all([loadData('khn'), loadData('khtn'), loadData('hth')]);
calculateRemainingDebts();
populateFilterDatalists();   // ⬅️ chèn ở đây
updateDashboard();
applyPermissions('khtn');

      } else {
          document.getElementById('login-overlay').style.display = 'flex';
      }
  }

  function setChangesMade(tableKey, madeChanges) {
      const btn = document.getElementById(`update-btn-${tableKey}`);
      if (!btn) return;

      const container = document.getElementById(TABLE_CONFIG[tableKey].containerId);
      const hasInvalidRows = container.querySelectorAll('tbody tr[data-is-invalid="true"]').length > 0;

      btn.disabled = !madeChanges || hasInvalidRows;
  }
  function hasPendingChanges(tableKey) { return (Object.keys(changeSet.create[tableKey] || {}).length + Object.keys(changeSet.update[tableKey] || {}).length + (changeSet.delete[tableKey] || []).length) > 0; }
  
  function calculateGrandTotal(tableKey) {
      const config = TABLE_CONFIG[tableKey];
      if (!config || !config.totalField) return 0;
      const data = originalTableData[tableKey]?.data || [];
      const created = Object.values(changeSet.create[tableKey] || {});
      const updated = changeSet.update[tableKey] || {};
      const deleted = new Set(changeSet.delete[tableKey] || []);
      let total = 0;
      data.forEach(row => { if (!deleted.has(row.id)) { const finalRow = { ...row, ...(updated[row.id] || {}) }; total += parseFloat(String(finalRow[config.totalField] || '0').replace(/\./g, '')) || 0; } });
      created.forEach(row => { total += parseFloat(String(row[config.totalField] || '0').replace(/\./g, '')) || 0; });
      return total;
  }
  
  function updateDashboard() {
      const tN = calculateGrandTotal('khn');
      const tT = calculateGrandTotal('khtn');
      const tTH = calculateGrandTotal('hth');
      document.getElementById('dashboard-total-no').textContent = tN.toLocaleString('vi-VN') + ' VNĐ';
      document.getElementById('dashboard-total-tra').textContent = tT.toLocaleString('vi-VN') + ' VNĐ';
      document.getElementById('dashboard-total-thuhoi').textContent = tTH.toLocaleString('vi-VN') + ' VNĐ';
      document.getElementById('dashboard-total-conlai').textContent = (tN - tT - tTH).toLocaleString('vi-VN') + ' VNĐ';
  }

  function filterTable(tableKey) {
  const container = document.getElementById(TABLE_CONFIG[tableKey].containerId);
  const host = document.getElementById(`filters-${tableKey}`);          // ✅ nơi chứa filters
  const filters = Array.from(host?.querySelectorAll('.filter-input')||[]);
      const tbody = container.querySelector('tbody');
      if (!tbody) return;
      const rows = tbody.querySelectorAll('tr');
      const filterValues = filters.map(f => ({ header: f.dataset.header, value: f.value.trim().toLowerCase() }));
      
      rows.forEach(row => {
          let matchesFilters = true;
          for (const filter of filterValues) {
              if (!filter.value) continue;
              const cell = row.querySelector(`[data-field="${filter.header}"]`);
              const cellValue = cell ? (cell.value || cell.textContent).toLowerCase() : '';
              if (!cellValue.includes(filter.value)) { matchesFilters = false; break; }
          }
          row.style.display = matchesFilters ? '' : 'none';
      });
      updateTotals(tableKey);
      updateVisibleRowCount(tableKey);
  }

  function capitalizeFirstLetter(input) { if (input.value.length > 0) input.value = input.value.charAt(0).toUpperCase() + input.value.slice(1); }
  function formatDateForInput(d) { if (!d) return ''; try { const dt = new Date(d); if (isNaN(dt.getTime())) return ''; return `${dt.getUTCFullYear()}-${String(dt.getUTCMonth() + 1).padStart(2, '0')}-${String(dt.getUTCDate()).padStart(2, '0')}`; } catch (e) { return ''; } }
  function formatDateForServer(d) { if (!d) return ''; try { const dt = new Date(d); if (isNaN(dt.getTime())) return ''; return `${String(dt.getUTCMonth() + 1).padStart(2, '0')}/${String(dt.getUTCDate()).padStart(2, '0')}/${dt.getUTCFullYear()}`; } catch (e) { return ''; } }
  
  // ==== Currency helpers (KHTN) ====
  const formatThousands = (s) =>
    String(s ?? '').replace(/[^\d]/g,'').replace(/\B(?=(\d{3})+(?!\d))/g,'.');
   // Hiển thị dấu chấm NGAY KHI GÕ, không ghi vào changeSet, chỉ format hiển thị
function liveFormatCurrency(input){
  if (!input || input.getAttribute('inputmode') !== 'decimal') return;

  // nhớ vị trí con trỏ hiện tại
  const start = input.selectionStart ?? input.value.length;

  // số chữ số bên trái con trỏ trước khi format
  const leftDigits = input.value.slice(0, start).replace(/[^\d]/g, '');

  // format toàn chuỗi
  const digitsOnly = input.value.replace(/[^\d]/g, '');
  const formatted  = formatThousands(digitsOnly);
  input.value = formatted;

  // đưa con trỏ về đúng vị trí tương ứng sau khi đã có dấu chấm
  let pos = 0, seen = 0;
  for (let i = 0; i < formatted.length; i++) {
    if (/\d/.test(formatted[i])) seen++;
    if (seen >= leftDigits.length) { pos = i + 1; break; }
  }
  // nếu xóa hết, pos = 0
  if (leftDigits.length === 0) pos = 0;

  try { input.setSelectionRange(pos, pos); } catch (_) {}
}

  function finalizeCurrencyKHTN(input, tableKey = 'khtn') {
    if (!input || input.getAttribute('inputmode') !== 'decimal') return;

    const tr = input.closest('tr');
    if (tr) { input.style.border=''; input.style.backgroundColor=''; delete tr.dataset.isInvalid; }

    const raw = String(input.value || '').replace(/[^\d]/g,'');
    const num = raw ? Number(raw) : 0;

    if (tr && input.dataset.field === 'Số tiền trả nợ') {
      const debtCell = tr.querySelector('[data-field="Số tiền nợ"]');
      const max = debtCell ? Number(String(debtCell.value||'').replace(/[^\d]/g,'')) : 0;
      if (num > max) {
        input.style.border = '2px solid var(--danger)';
        input.style.backgroundColor = '#fff0f0';
        tr.dataset.isInvalid = 'true';
      }
    }

    input.value = raw ? formatThousands(raw) : '';

    if (!tr) return;
    const rowId = tr.dataset.id;
    const field = input.dataset.field;
    if (!rowId || !field) return;

    if (changeSet.create[tableKey]?.[rowId]) {
      changeSet.create[tableKey][rowId][field] = String(num);
    } else {
      if (!changeSet.update[tableKey]) changeSet.update[tableKey] = {};
      if (!changeSet.update[tableKey][rowId]) {
        const rowDataFromDOM = {};
        (originalTableData[tableKey]?.headers || []).forEach(h => {
          const cell = tr.querySelector(`[data-field="${h}"]`);
          let v = cell ? cell.value : (originalTableData[tableKey]?.data.find(r => r.id == rowId)?.[h]);
          if (cell && cell.getAttribute('inputmode') === 'decimal') v = v.replace(/[^\d]/g,'');
          rowDataFromDOM[h] = v;
        });
        changeSet.update[tableKey][rowId] = { ...rowDataFromDOM, id: rowId };
      }
      changeSet.update[tableKey][rowId][field] = String(num);
    }

    updateTotals(tableKey);
    updateDashboard();
    setChangesMade(tableKey, hasPendingChanges(tableKey));
  }

  function setupCurrencyInput(input, tableKey) {
  if (!input || input.__currencyBound) return;
  input.__currencyBound = true;

  let composing = false;

  input.addEventListener('compositionstart', () => composing = true);
  input.addEventListener('compositionend', () => { 
    composing = false; 
    formatRealtime(); 
  });

  // Format ngay khi gõ (real-time)
  const formatRealtime = () => {
    if (composing) return; // không format khi đang gõ tiếng Việt
    
    const cursorPos = input.selectionStart;
    const oldValue = input.value;
    const rawValue = oldValue.replace(/[^\d]/g, ''); // chỉ giữ số
    
    if (rawValue === '') {
      input.value = '';
      return;
    }
    
    // Format với dấu chấm
    const formattedValue = rawValue.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    
    if (formattedValue !== oldValue) {
      input.value = formattedValue;
      
      // Tính toán lại vị trí con trỏ
      const oldDots = (oldValue.slice(0, cursorPos).match(/\./g) || []).length;
      const newDots = (formattedValue.slice(0, cursorPos).match(/\./g) || []).length;
      const newCursorPos = cursorPos + (newDots - oldDots);
      
      // Đặt lại con trỏ
      input.setSelectionRange(newCursorPos, newCursorPos);
    }
  };

  // Format ngay khi gõ
  input.addEventListener('input', formatRealtime);

  // Chỉ format khi kết thúc nhập (giữ lại cho chắc chắn)
  const finalize = () => { if (!composing) finalizeCurrencyKHTN(input, tableKey); };

  input.addEventListener('blur', finalize);
  input.addEventListener('change', finalize);

  // Enter/Tab: format ngay
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' || e.key === 'Tab') {
      finalize();
    }
  });

  // Space: chặn chèn khoảng trắng + format ngay
  input.addEventListener('keydown', (e) => {
    if (e.key === ' ' || e.code === 'Space') {
      e.preventDefault();      // không cho thêm dấu cách vào ô
      finalize();              // format số (chèn dấu .)
    }
  });

  // Paste: format sau khi paste
  input.addEventListener('paste', () => {
    setTimeout(formatRealtime, 0);
  });

  // Format giá trị ban đầu (nếu có)
  liveFormatCurrency(input);
}


 function exportToExcel(e) {
  const tableKey = e.currentTarget.dataset.tableKey || 'khtn';
  const cfg = TABLE_CONFIG[tableKey];
  const container = document.getElementById(cfg.containerId);
  const table = container?.querySelector('table');
  if (!table) return showToast('Không tìm thấy bảng để xuất.', 'warning');

  // Lấy danh sách cột hiển thị (bỏ cột "Xóa")
  const ths = Array.from(table.querySelectorAll('thead tr:first-child th[data-field]'));
  const headersInfo = ths.map(th => ({
    display: (th.textContent || '').trim(), // tên hiển thị
    original: th.dataset.field              // tên cột gốc để tìm [data-field="..."]
  }));
  const headers = headersInfo.map(h => h.display);
  if (headers.length === 0) return showToast('Không có cột dữ liệu để xuất.', 'warning');

  // Cột số / cột ngày (dựa tên cột gốc)
  const isNumericCol = (orig) => NUMERIC_COLUMNS_FOR_TOTAL.includes(orig);
  const isDateCol    = (orig) => orig.includes('Ngày');

  // Lấy các dòng đang hiển thị
  const rows = Array.from(table.querySelectorAll('tbody tr'))
    .filter(tr => tr.style.display !== 'none');

  const dataAoA = [headers];

  // Đọc giá trị theo data-field (input/select/textarea)
  rows.forEach(tr => {
    const rowArr = headersInfo.map(h => {
      const ctrl = tr.querySelector(`[data-field="${CSS.escape(h.original)}"]`);
      let raw = ctrl ? (ctrl.value ?? ctrl.textContent ?? '') : '';
      raw = String(raw).trim();

      if (isNumericCol(h.original)) {
        const num = Number(raw.replace(/[^\d]/g, ''));
        return Number.isFinite(num) ? num : null;
      } else if (isDateCol(h.original)) {
        const d = new Date(raw);
        return isNaN(d.getTime()) ? raw : d;
      }
      return raw; // giữ nguyên string (ví dụ SĐT để không mất số 0 đầu)
    });
    dataAoA.push(rowArr);
  });

  // Hàng Tổng cộng (tfoot) nếu có
  const tfootRow = table.querySelector('tfoot tr');
  if (tfootRow) {
    const totalArr = headersInfo.map((h, idx) => {
      // +1 vì cột 0 là "Xóa"
      const td = tfootRow.children[idx + 1];
      const txt = (td?.textContent || '').trim();
      if (idx === 0) return txt || 'TỔNG CỘNG';
      if (isNumericCol(h.original)) {
        const num = Number(txt.replace(/[^\d]/g, ''));
        return Number.isFinite(num) ? num : null;
      }
      return txt;
    });
    dataAoA.push(totalArr);
  }

  // Tạo workbook/sheet
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(dataAoA);

  // Autofilter + freeze header
  ws['!autofilter'] = {
    ref: XLSX.utils.encode_range({ s: { r: 0, c: 0 }, e: { r: 0, c: headers.length - 1 } })
  };
  ws['!freeze'] = { xSplit: 0, ySplit: 1 };

  // Định dạng kiểu số/ngày
  const range = XLSX.utils.decode_range(ws['!ref']);
  for (let C = range.s.c; C <= range.e.c; ++C) {
    const orig = headersInfo[C].original;
    for (let R = 1; R <= range.e.r; ++R) {
      const addr = XLSX.utils.encode_cell({ r: R, c: C });
      const cell = ws[addr];
      if (!cell) continue;
      if (isNumericCol(orig) && typeof cell.v === 'number') {
        cell.t = 'n'; cell.z = '#,##0';
      } else if (isDateCol(orig) && cell.v instanceof Date) {
        cell.t = 'd'; cell.z = 'yyyy-mm-dd';
      }
    }
  }

  // Auto-fit độ rộng cột
  const colWidths = headersInfo.map((h, idx) => {
    let maxLen = h.display.length;
    for (let r = 1; r < dataAoA.length; r++) {
      const v = dataAoA[r][idx];
      let len = 0;
      if (v == null) len = 0;
      else if (v instanceof Date) len = 10;
      else if (typeof v === 'number') len = String(v).length + 2;
      else len = String(v).length;
      if (len > maxLen) maxLen = len;
    }
    if (isNumericCol(h.original)) maxLen = Math.max(maxLen, 12);
    if (isDateCol(h.original))    maxLen = Math.max(maxLen, 10);
    return { wch: Math.min(Math.max(maxLen + 2, 10), 40) };
  });
  ws['!cols'] = colWidths;

  // Ghi file
  const sheetName = (cfg.name || 'Sheet').slice(0, 30);
  const filename = `BaoCao_${cfg.name?.replace(/\s/g, '_') || 'KhachHangTraNo'}_${new Date().toISOString().slice(0,10)}.xlsx`;
  XLSX.utils.book_append_sheet(wb, ws, sheetName);
  XLSX.writeFile(wb, filename);
}


  document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('login-form').addEventListener('submit', handleLogin);
      document.querySelector('.export-btn').addEventListener('click', exportToExcel);
      document.getElementById('update-btn-khtn').addEventListener('click', () => handleSaveChanges('khtn'));
      setupCurrencyInput(document.getElementById('max-debt-input'));
      initApp();
  });

  /* Arrow & Enter navigation (không cần Ctrl) */
  (function () {
    function getFocusable(container=document) {
      return Array.from(container.querySelectorAll(
        'input:not([type="hidden"]):not([disabled]), select:not([disabled]), textarea:not([disabled])'
      )).filter(el => el.offsetParent !== null);
    }

    function focusByDirection(fromEl, direction, container=document) {
      const focusables = getFocusable(container);
      const cur = fromEl.getBoundingClientRect();
      let best = null, bestScore = Infinity;

      focusables.forEach(el => {
        if (el === fromEl) return;
        const r = el.getBoundingClientRect();
        const dx = (r.left + r.right)/2 - (cur.left + cur.right)/2;
        const dy = (r.top + r.bottom)/2 - (cur.top + cur.bottom)/2;

        if (direction === 'right' && dx <= 4) return;
        if (direction === 'left'  && dx >= -4) return;
        if (direction === 'down'  && dy <= 4) return;
        if (direction === 'up'    && dy >= -4) return;

        const cross = (direction === 'left' || direction === 'right') ? Math.abs(dy) : Math.abs(dx);
        const dist = Math.hypot(dx, dy);
        const score = cross * 1000 + dist;

        if (score < bestScore) { bestScore = score; best = el; }
      });

      if (best) {
        best.focus({ preventScroll: true });
        if (best.select && (best.tagName === 'INPUT' || best.tagName === 'TEXTAREA')) {
          const len = best.value?.length ?? 0;
          best.setSelectionRange?.(len, len);
        }
      }
    }

    function focusNextPrev(fromEl, forward, container=document) {
      const list = getFocusable(container);
      const idx = list.indexOf(fromEl);
      const next = list[idx + (forward ? 1 : -1)];
      if (next) next.focus({ preventScroll: true });
    }

    document.addEventListener('keydown', (e) => {
      const active = document.activeElement;
      if (!active) return;

      if (e.key === 'Enter') {
        e.preventDefault();
        finalizeCurrencyKHTN(active); 
        focusNextPrev(active, !e.shiftKey);
        return;
      }

      if (['ArrowRight','ArrowLeft','ArrowUp','ArrowDown'].includes(e.key)) {
        e.preventDefault();
        finalizeCurrencyKHTN(active); 
        if (e.key === 'ArrowRight') focusByDirection(active, 'right');
        if (e.key === 'ArrowLeft')  focusByDirection(active, 'left');
        if (e.key === 'ArrowUp')    focusByDirection(active, 'up');
        if (e.key === 'ArrowDown')  focusByDirection(active, 'down');
      }
    }, true);
  })();

  document.addEventListener('focusout', (e) => {
    const t = e.target;
    if (t && t.getAttribute && t.getAttribute('inputmode') === 'decimal') {
      requestAnimationFrame(() => finalizeCurrencyKHTN(t));
    }
  }, true);
</script>

</body>
</html> 
<!--code khách trả nợ đã hết--> 

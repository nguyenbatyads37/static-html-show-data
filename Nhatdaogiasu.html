<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thông Báo Kết Quả Học Tập</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
  <style>
    /* CSS không thay đổi, giữ nguyên như cũ */
    :root {
      --primary-color: #005a9e; /* Xanh coban */
      --secondary-color: #ff6f00;
      --text-color: #333;
      --light-text-color: #666;
      --bg-color: #f4f7f9;
      --card-bg-color: #ffffff;
      --border-color: #e0e0e0;
      --praise-color: #2e7d32;
      --criticism-color: #d32f2f;
      --homework-bg: #fff3e0;
      --homework-border: #ff9800;
    }

    body {
      font-family: 'Roboto', sans-serif;
      line-height: 1.6;
      color: var(--text-color);
      background-color: var(--bg-color);
      margin: 0;
      padding: 20px;
    }

    #report-content {
      max-width: 800px;
      margin: 0 auto;
      background-color: var(--card-bg-color);
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
      overflow: hidden; /* Để bo góc cho header */
    }

    .header-container {
      background-color: var(--primary-color);
      color: white;
      padding: 20px;
      text-align: center;
    }

    .header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 15px;
    }

    .logo {
      max-height: 65px; 
    }

    .company-name {
      font-weight: 700;
      font-size: 26px;
      flex-grow: 1;
    }

    .header-image {
      max-height: 65px; 
      border-radius: 50%;
      background: white;
      padding: 3px;
    }

    .announcement-title {
      width: 100%;
      font-size: 16px;
      margin-top: 15px;
      font-weight: 400;
      opacity: 0.9;
    }

    .container {
      padding: 30px;
    }

    h2 {
      font-size: 20px;
      font-weight: 700;
      color: var(--primary-color);
      border-bottom: 2px solid var(--border-color);
      padding-bottom: 10px;
      margin-top: 30px;
      margin-bottom: 15px;
    }

    h2:first-of-type {
      margin-top: 0;
    }

    .info-section {
      margin-bottom: 25px;
      padding: 20px;
      border-radius: 8px;
      background-color: var(--primary-color); /* Nền xanh coban */
      color: #ffffff; /* Chữ màu trắng */
    }

    .info-row {
      display: flex;
      margin-bottom: 8px;
      align-items: center;
    }
    .info-row:last-child {
      margin-bottom: 0;
    }

    .info-label {
      font-weight: 500;
      width: 100px;
      color: #e0e0e0; /* Màu trắng nhạt cho nhãn */
    }

    .info-content {
      flex: 1;
      font-size: 1.8em; /* Tăng kích thước chữ */
      font-weight: 900; /* Nét chữ rất đậm */
    }

    #lesson-content ul {
      padding-left: 20px;
      margin: 0;
    }
    
    #lesson-content li {
      margin-bottom: 8px;
      font-size: 1.4em; /* Cỡ chữ to hơn */
      font-weight: 700; /* Đậm hơn */
    }

    .intro-text {
      font-style: italic;
      color: var(--light-text-color);
      margin-bottom: 15px;
    }
    
    .praise {
      color: var(--praise-color);
      font-weight: 500;
      background-color: #e8f5e9;
      padding: 10px 15px;
      border-radius: 6px;
      border-left: 4px solid var(--praise-color);
    }

    .criticism {
      color: var(--criticism-color);
      font-weight: 500;
      background-color: #ffebee;
      padding: 10px 15px;
      border-radius: 6px;
      border-left: 4px solid var(--criticism-color);
    }
    
    .review-item {
        margin-bottom: 15px;
    }
    
    .review-item .info-label {
        width: 120px;
    }

    #homework {
      background-color: var(--homework-bg);
      border-left: 4px solid var(--homework-border);
      padding: 15px;
      border-radius: 6px;
      margin-top: 25px;
    }
    #homework strong {
        color: var(--primary-color);
    }


    .footer {
      text-align: center;
      margin-top: 30px;
      color: var(--light-text-color);
      font-size: 14px;
      border-top: 1px solid var(--border-color);
      padding-top: 20px;
    }
    .footer p {
      margin: 5px 0;
    }
    .footer strong {
      color: var(--primary-color);
    }


    #loading,
    #error {
      text-align: center;
      padding: 40px;
      font-size: 18px;
    }
    #error {
      color: var(--criticism-color);
      display: none;
    }

    .screenshot-btn {
      display: block;
      width: fit-content;
      margin: 25px auto 0;
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
      font-size: 16px;
      transition: background-color 0.3s, box-shadow 0.3s;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    .screenshot-btn:hover {
      background-color: #00487e;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
    }

    @media (max-width: 600px) {
      body {
        padding: 10px;
      }
      .container {
        padding: 20px;
      }
      .header {
        flex-direction: column;
        gap: 10px;
      }
      .company-name {
        font-size: 22px;
      }
      .info-row {
        flex-direction: column;
        align-items: flex-start;
      }
      .info-label {
        margin-bottom: 3px;
        width: auto;
      }
       .info-content {
        font-size: 1.5em; /* Giảm nhẹ cỡ chữ trên mobile */
      }
    }
  </style>
</head>

<body>
  <div id="loading">Đang tải dữ liệu báo cáo...</div>
  <div id="error"></div>

  <div id="report-content" style="display: none;">
    <div class="header-container">
      <div class="header">
        <img
          src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2F051a69a8.%E1%BA%A2nh.091946.png"
          class="logo">
        <div class="company-name">NHẤT ĐẠO GIA SƯ</div>
        <img
          src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2F051a69a8.%E1%BA%A2nh.091946.png"
          class="header-image">
      </div>
       <div class="announcement-title">Trân trọng thông báo kết quả học tập ngày: <span id="report-date">...</span></div>
    </div>

    <div class="container">
      <div class="info-section">
        <div class="info-row">
          <div class="info-label">Học sinh:</div>
          <div class="info-content" id="student-name">Đang tải...</div>
        </div>
        <div class="info-row">
          <div class="info-label">Lớp:</div>
          <div class="info-content" id="class-subject">Đang tải...</div>
        </div>
      </div>

      <h2>BÀI HỌC HÔM NAY</h2>
      <p class="intro-text">Buổi học hôm nay Gia sư đã tập trung vào các nội dung sau:</p>
      <div id="lesson-content">
        <ul>
          <li>Đang tải...</li>
        </ul>
      </div>

      <h2>NHẬN XÉT CỦA GIA SƯ</h2>
      <p class="intro-text">Sau buổi học, tôi có một số nhận xét về tình hình học tập của em như sau:</p>

      <div class="review-item">
        <div class="info-label">Lời khen:</div>
        <div class="praise" id="praise">Đang tải...</div>
      </div>

      <div class="review-item">
        <div class="info-label">Lời nhắc nhở:</div>
        <div class="criticism" id="reminder">Đang tải...</div>
      </div>

      <div id="homework"><strong>Bài tập về nhà:</strong> Đang tải...</div>

      <div class="footer">
        <p><strong>Trung tâm Gia Sư Nhất Đạo</strong></p>
        <p>Điện thoại: 0965 601 055</p>
      </div>
    </div>
  </div>

  <button id="screenshot-btn" class="screenshot-btn" style="display: none;">Chụp màn hình báo cáo</button>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
   <script>
  async function loadData() {
    const loading = document.getElementById('loading');
    const error = document.getElementById('error');
    const reportContent = document.getElementById('report-content');
    const screenshotBtn = document.getElementById('screenshot-btn');
    
    const baseUrl = 'https://script.google.com/macros/s/AKfycbw3D7_Ok1MFQusdrVB2hlzm9xk9Pz0CihaAcmZDynNt8KvhRL_3wplChIhOIFV4gTUJ/exec';
    
    const id = new URLSearchParams(window.location.search).get('id');

    if (!id) {
        showError("Không tìm thấy ID báo cáo trong địa chỉ URL.");
        loading.style.display = 'none';
        return;
    }
    
    const url = `${baseUrl}?id=${id}`;

    try {
      const res = await fetch(url);

      if (!res.ok) {
          throw new Error(`Yêu cầu API thất bại với mã trạng thái ${res.status}`);
      }

      // --- THAY ĐỔI BẮT ĐẦU TỪ ĐÂY ---

      // 1. Đọc toàn bộ JSON trả về
      const responseJson = await res.json(); 

      // 2. Kiểm tra trạng thái thành công từ API
      if (!responseJson.success) {
        throw new Error("API báo cáo không thành công hoặc không tìm thấy dữ liệu.");
      }
      
      // 3. Lấy dữ liệu từ key "data" và chọn phần tử đầu tiên trong mảng
      //    Lưu ý: Nếu key không phải là "data", bạn cần thay đổi nó ở đây.
      const data = responseJson.data[0]; 

      // --- KẾT THÚC THAY ĐỔI ---

      if (!data || Object.keys(data).length === 0) {
          throw new Error("Không tìm thấy dữ liệu cho ID này hoặc dữ liệu trả về bị lỗi.");
      }
      
      document.getElementById('report-date').innerText = data["Ngày"] || 'N/A';
      document.getElementById('student-name').innerText = data["Học sinh"] || 'N/A';
      document.getElementById('class-subject').innerText = data["Lớp"] || 'N/A';
      
      const formatToList = (text) => {
          if (!text || text.trim() === '') return '<ul><li>Không có.</li></ul>';
          return `<ul><li>${text.replace(/\n/g, '</li><li>')}</li></ul>`;
      };

      document.getElementById('lesson-content').innerHTML = formatToList(data["Nội Dung bài"]);
      document.getElementById('praise').innerText = data["Điểm mạnh"] || 'Không có.';
      document.getElementById('reminder').innerText = data["Điểm yếu"] || 'Không có.';
      document.getElementById('homework').innerHTML = `<strong>Bài tập về nhà:</strong> ${data["BTVN"] || 'Không có.'}`;

      reportContent.style.display = 'block';
      screenshotBtn.style.display = 'block';

    } catch (err) {
      showError("Lỗi khi tải dữ liệu: " + err.message);
    } finally {
      loading.style.display = 'none';
    }
  }

  function showError(msg) {
    const error = document.getElementById('error');
    error.innerText = msg;
    error.style.display = 'block';
  }

  document.addEventListener('DOMContentLoaded', loadData);

  // Phần code chụp màn hình không thay đổi
  document.getElementById('screenshot-btn').addEventListener('click', async () => {
    const report = document.getElementById('report-content');
    const button = document.getElementById('screenshot-btn');
    
    button.style.display = 'none';

    try {
      const canvas = await html2canvas(report, { 
          useCORS: true,
          scale: 2 
      });

      canvas.toBlob(async (blob) => {
        if (navigator.clipboard && window.ClipboardItem) {
          try {
            await navigator.clipboard.write([
              new ClipboardItem({ 'image/png': blob })
            ]);
            alert('Đã sao chép hình ảnh vào bộ nhớ tạm!');
          } catch (cErr) {
            console.warn('Không thể tự động sao chép vào clipboard. Lỗi:', cErr);
            alert('Không thể tự động sao chép ảnh. Vui lòng tải ảnh về.');
          }
        } else {
          console.warn('Clipboard API không được hỗ trợ trên trình duyệt này.');
        }

        const studentName = document.getElementById('student-name').innerText.trim().replace(/ /g, '_');
        const reportDate = document.getElementById('report-date').innerText.trim();
        const link = document.createElement('a');
        link.download = `Bao_cao_${studentName}_${reportDate}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
      });
    } catch (err) {
      showError('Lỗi khi chụp ảnh: ' + err.message);
    } finally {
        button.style.display = 'block';
    }
  });
</script>
</body>

</html>





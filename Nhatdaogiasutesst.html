<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thông Báo Kết Quả Học Tập</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    /* === CSS VỚI GIAO DIỆN GIẤY NOTE === */
    :root {
      --primary-color: #005a9e;
      --text-color: #333;
      --light-text-color: #666;
      --bg-color: #f4f7f9;
      --border-color: #e0e0e0;
      --praise-color: #2e7d32;
      --criticism-color: #d32f2f;
      --homework-bg: #fff3e0;
      --homework-border: #ff9800;
      
      /* MÀU MỚI */
      --note-bg-color: #fffacd; /* Màu vàng giấy note */
      --line-color: #e0e0e0;   /* Màu dòng kẻ */
    }

    body {
      font-family: 'Roboto', sans-serif;
      line-height: 1.6;
      color: var(--text-color);
      background-color: var(--bg-color);
      margin: 0;
      padding: 20px;
    }

    #report-content {
      max-width: 800px;
      margin: 0 auto;
      border-radius: 8px; /* Giảm bo góc để giống tờ giấy hơn */
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      border: 1px solid #ccc;
      
      /* --- HIỆU ỨNG GIẤY NOTE --- */
      background-color: var(--note-bg-color);
      line-height: 1.8; /* Giãn dòng để khớp với dòng kẻ */
      background-image: repeating-linear-gradient(
        to bottom,
        transparent 0,
        transparent 27px, /* Khoảng trống */
        var(--line-color) 28px /* Dòng kẻ 1px */
      );
      background-size: 100% 28px; /* Chiều cao của mỗi cặp (khoảng trống + dòng kẻ) */
      /* --- HẾT HIỆU ỨNG GIẤY NOTE --- */
    }

    .header-container {
      background-color: var(--primary-color);
      color: white;
      padding: 20px;
      text-align: center;
      /* Bỏ hiệu ứng dòng kẻ cho phần header */
      background-image: none; 
    }

    .header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 15px;
    }

    .logo, .header-image {
      max-height: 50px;
    }

    .company-name {
      font-weight: 700;
      font-size: 26px;
      flex-grow: 1;
    }

    .announcement-title {
      width: 100%;
      font-size: 16px;
      margin-top: 15px;
      font-weight: 400;
      opacity: 0.9;
    }

    .container {
      padding: 30px;
    }

    h2 {
      font-size: 20px;
      font-weight: 700;
      color: var(--primary-color);
      border-bottom: 2px solid var(--border-color);
      padding-bottom: 10px;
      margin-bottom: 15px;
      /* Thêm khoảng cách giữa các mục */
      margin-top: 40px; 
    }
    /* Tiêu đề đầu tiên không cần khoảng cách trên */
    h2:first-of-type {
        margin-top: 0;
    }

    .info-section {
      margin-bottom: 25px;
      padding: 15px;
      border-radius: 8px;
      /* Cần có màu nền để che dòng kẻ phía sau */
      background-color: var(--note-bg-color);
      border: 1px solid #ddd;
    }

    .info-row {
      display: flex;
      margin-bottom: 8px;
    }
    .info-row:last-child {
      margin-bottom: 0;
    }

    .info-label {
      font-weight: 500;
      width: 100px;
      color: var(--light-text-color);
    }

    .info-content {
      flex: 1;
    }
    
    #lesson-content ul {
      padding-left: 20px;
      margin: 0;
    }

    #lesson-content li {
      margin-bottom: 8px;
    }

    .intro-text {
      font-style: italic;
      color: var(--light-text-color);
      margin-bottom: 15px;
    }
    
    .review-grid {
        display: flex;
        gap: 20px;
        margin-top: 15px;
        flex-wrap: wrap;
    }

    .praise, .criticism {
        flex: 1;
        min-height: 150px;
        border-radius: 12px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        /* Các ô này đã có background-color nên sẽ tự che dòng kẻ */
    }
    
    .praise {
        color: var(--praise-color);
        background-color: #e8f5e9;
        border: 2px solid var(--praise-color);
    }

    .criticism {
        color: var(--criticism-color);
        background-color: #ffebee;
        border: 2px solid var(--criticism-color);
    }
    
    .praise strong, .criticism strong {
        font-size: 1.2em;
        font-weight: 700;
        text-align: center;
        margin-bottom: 15px;
    }

    .praise ul, .criticism ul {
        padding-left: 20px;
        margin: 0;
    }

    .praise li, .criticism li {
        margin-bottom: 8px;
    }
    .praise li:last-child, .criticism li:last-child {
        margin-bottom: 0;
    }

    #homework {
      background-color: var(--homework-bg);
      border: 1px solid var(--homework-border);
      padding: 15px;
      border-radius: 6px;
      margin-top: 25px;
    }
    #homework strong {
        color: var(--primary-color);
    }

    .footer {
      text-align: center;
      margin-top: 30px;
      color: var(--light-text-color);
      font-size: 14px;
      border-top: 1px solid var(--border-color);
      padding-top: 20px;
    }
    .footer p { margin: 5px 0; }
    .footer strong { color: var(--primary-color); }

    #loading, #error {
      text-align: center;
      padding: 40px;
      font-size: 18px;
      background: white; /* Cho thông báo lỗi có nền riêng */
    }
    #error {
      color: var(--criticism-color);
      display: none;
    }

    .screenshot-btn {
      display: block;
      width: fit-content;
      margin: 25px auto 0;
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
      font-size: 16px;
      transition: background-color 0.3s, box-shadow 0.3s;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    .screenshot-btn:hover {
      background-color: #00487e;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
    }

    @media (max-width: 600px) {
      body { padding: 10px; }
      .container { padding: 20px 15px; }
      .header { flex-direction: column; gap: 10px; }
      .company-name { font-size: 22px; }
      .info-row { flex-direction: column; align-items: flex-start; }
      .info-label { margin-bottom: 3px; width: auto; }
      .review-grid {
          flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div id="test-notice"></div>
  <div id="loading">Đang tải dữ liệu báo cáo...</div>
  <div id="error"></div>
  <div id="report-content" style="display: none;">
    <div class="header-container">
      <div class="header">
        <img src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2F051a69a8.%E1%BA%A2nh.091946.png" class="logo">
        <div class="company-name">NHẤT ĐẠO GIA SƯ</div>
        <img src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2F051a69a8.%E1%BA%A2nh.091946.png" class="header-image">
      </div>
      <div class="announcement-title">Trân trọng thông báo kết quả học tập ngày: <span id="report-date">...</span></div>
    </div>

    <!-- CẤU TRÚC HTML ĐÃ ĐƯỢC ĐƠN GIẢN HÓA -->
    <div class="container">
      <div class="info-section">
        <div class="info-row">
          <div class="info-label">Học sinh:</div>
          <div class="info-content" id="student-name">Đang tải...</div>
        </div>
        <div class="info-row">
          <div class="info-label">Lớp:</div>
          <div class="info-content" id="class-subject">Đang tải...</div>
        </div>
      </div>

      <h2>BÀI HỌC HÔM NAY</h2>
      <p class="intro-text">Buổi học hôm nay Gia sư đã tập trung vào các nội dung sau:</p>
      <div class="info-content" id="lesson-content">
        <ul><li>Đang tải...</li></ul>
      </div>

      <h2>NHẬN XÉT CỦA GIA SƯ</h2>
      <p class="intro-text">Sau buổi học, tôi có một số nhận xét về tình hình học tập của em như sau:</p>
      <div class="review-grid">
          <div class="praise" id="praise">
              <!-- Nội dung lời khen -->
          </div>
          <div class="criticism" id="reminder">
              <!-- Nội dung nhắc nhở -->
          </div>
      </div>

      <div id="homework"><strong>Bài tập về nhà:</strong> Đang tải...</div>

      <div class="footer">
        <p><strong>Trung tâm Gia Sư Nhất Đạo</strong></p>
        <p>Điện thoại: 0965 601 055</p>
      </div>
    </div>
  </div>

  <button id="screenshot-btn" class="screenshot-btn" style="display: none;">Chụp màn hình báo cáo</button>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <script>
    // JavaScript không thay đổi
    function showError(msg) {
        const errorEl = document.getElementById('error');
        const loadingEl = document.getElementById('loading');
        errorEl.innerText = msg;
        errorEl.style.display = 'block';
        loadingEl.style.display = 'none';
    }
    function populateElement(id, content, isHtml = false) {
        const element = document.getElementById(id);
        if (element) {
            if (isHtml) {
                element.innerHTML = content;
            } else {
                element.innerText = content;
            }
        }
    }
    function formatTextToList(text) {
        if (!text || text.trim() === '') {
            return '<ul><li>Không có nội dung.</li></ul>';
        }
        const lines = text.split('\n').filter(line => line.trim() !== '');
        const listItems = lines.map(line => `<li>${line.trim()}</li>`).join('');
        return `<ul>${listItems}</ul>`;
    }

    function formatCommaTextToList(text, title) {
        let content;
        if (!text || text.trim() === '') {
            content = `<p style="text-align: center;"><em>Không có.</em></p>`;
        } else {
            const items = text.split(',')
                              .map(item => item.trim())
                              .filter(item => item !== '');
            
            const listItems = items.map(item => `<li>${item}</li>`).join('');
            content = `<ul>${listItems}</ul>`;
        }
        return `<strong>${title}</strong>${content}`;
    }

    async function loadReportData() {
        const reportContentEl = document.getElementById('report-content');
        const screenshotBtnEl = document.getElementById('screenshot-btn');
        const loadingEl = document.getElementById('loading');
        const params = new URLSearchParams(window.location.search);
        let reportId = params.get('id');
        if (!reportId) {
            reportId = '2d32f251'; 
            const noticeEl = document.getElementById('test-notice');
            noticeEl.innerHTML = `<div style="background-color: #fff3cd; color: #856404; padding: 15px; margin: 0 auto 20px auto; max-width: 770px; border-radius: 8px; text-align: center; border: 1px solid #ffeeba;"><b>Bạn đang ở chế độ xem thử.</b><br>Để xem báo cáo khác, hãy thêm コード> ?id=MÃ_BÁO_CÁO</code> vào cuối địa chỉ web.</div>`;
        }
        const apiUrl = 'https://script.google.com/macros/s/AKfycbw51hN5ky8LCIJG732gCU5sZx8Gg9W-39bh0s3NyGMWhtMWWRR96UnOHCmjfJoZdVE/exec';
        try {
            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error(`Kết nối tới máy chủ thất bại: ${response.status}`);
            const allData = await response.json();
            const reportData = allData.data.find(item => item.id == reportId);
            
            if (!reportData) throw new Error(`Không tìm thấy dữ liệu cho báo cáo có mã: ${reportId}`);
            
            populateElement('report-date', reportData["Ngày"] || 'Chưa cập nhật');
            populateElement('student-name', reportData["Học sinh"] || 'Chưa cập nhật');
            populateElement('class-subject', reportData["Lớp"] || 'Chưa cập nhật');
            
            populateElement('praise', formatCommaTextToList(reportData["Điểm mạnh"], "Lời khen"), true);
            populateElement('reminder', formatCommaTextToList(reportData["Điểm yếu"], "Lời nhắc nhở"), true);

            populateElement('lesson-content', formatTextToList(reportData["Nội Dung bài"]), true);
            populateElement('homework', `<strong>Bài tập về nhà:</strong><br>${reportData["BTVN"] || 'Không có.'}`, true);
            reportContentEl.style.display = 'block';
            screenshotBtnEl.style.display = 'block';
        } catch (err) {
            console.error("Chi tiết lỗi:", err); 
            showError("Đã xảy ra lỗi khi tải dữ liệu báo cáo. " + err.message);
        } finally {
            loadingEl.style.display = 'none';
        }
    }
    async function captureReport() {
        const reportEl = document.getElementById('report-content');
        const buttonEl = document.getElementById('screenshot-btn');
        buttonEl.style.display = 'none';
        try {
            const canvas = await html2canvas(reportEl, { useCORS: true, scale: 2 });
            const studentName = document.getElementById('student-name').innerText.trim().replace(/ /g, '_');
            const reportDate = document.getElementById('report-date').innerText.trim().replace(/\//g, '-');
            const fileName = `Bao_cao_${studentName}_${reportDate}.png`;
            const link = document.createElement('a');
            link.download = fileName;
            link.href = canvas.toDataURL('image/png');
            link.click();
            if (navigator.clipboard && navigator.clipboard.write) {
                canvas.toBlob(blob => {
                    navigator.clipboard.write([ new ClipboardItem({ 'image/png': blob }) ])
                        .then(() => alert('Đã tải ảnh về và sao chép hình ảnh vào bộ nhớ tạm!'))
                        .catch(clipErr => {
                            console.warn('Không thể sao chép vào clipboard:', clipErr);
                            alert('Đã tải ảnh về! (Không thể tự động sao chép ảnh).');
                        });
                });
            } else {
                 alert('Đã tải ảnh về!');
            }
        } catch (err) {
            console.error("Lỗi chụp màn hình:", err);
            showError('Đã xảy ra lỗi khi chụp ảnh: ' + err.message);
        } finally {
            buttonEl.style.display = 'block'; 
        }
    }
    document.addEventListener('DOMContentLoaded', loadReportData);
    document.getElementById('screenshot-btn').addEventListener('click', captureReport);
  </script>
</body>
</html>

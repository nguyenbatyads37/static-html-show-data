<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giấy Đề Nghị Tạm Ứng</title>
    <style>
        body { font-family: "Times New Roman", Times, serif; margin: 0; padding: 20px; background-color: #f0f0f0; display: flex; justify-content: center; line-height: 1.5; }
        .a4-page { width: 210mm; min-height: 297mm; padding: 20mm; background: white; box-shadow: 0 0 10px rgba(0,0,0,0.1); box-sizing: border-box; }
        .header { display: flex; justify-content: space-between; text-align: center; margin-bottom: 10px; }
        .header-left, .header-right { width: 50%; }
        .company-name { font-weight: bold; text-transform: uppercase; font-size: 13pt; }
        .motto { font-weight: bold; font-size: 12pt; }
        .sub-motto { font-weight: bold; font-size: 11pt; border-bottom: 1px solid black; display: inline-block; padding-bottom: 3px; }
        .address-info { font-size: 10pt; margin-top: 5px; border-bottom: 1px solid #ccc; padding-bottom: 10px; margin-bottom: 10px; }
        .date-line { text-align: right; font-style: italic; margin: 10px 0; }
        .title { text-align: center; font-weight: bold; font-size: 18pt; margin-top: 20px; margin-bottom: 5px; }
        .subject { text-align: center; font-weight: bold; font-style: italic; margin-bottom: 20px; }
        .content-section { margin-bottom: 10px; text-align: justify; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        table, th, td { border: 1px solid black; }
        th, td { padding: 8px; vertical-align: middle; }
        th { text-align: center; text-transform: uppercase; font-weight: bold; background-color: #eee; }
        .col-money { text-align: right; font-weight: bold; white-space: nowrap; }
        .footer { margin-top: 30px; display: flex; flex-direction: column; align-items: flex-end; text-align: center; padding-right: 20px; }
        .signature-space { height: 80px; }
        .bank-info { margin-top: 15px; background-color: #f9f9f9; padding: 10px; border: 1px dashed #999; font-size: 10pt; }
        @media print {
            body { background: white; padding: 0; }
            .a4-page { box-shadow: none; margin: 0; width: 100%; }
        }
    </style>
</head>
<body>

<div class="a4-page">
    <div class="header">
        <div class="header-left">
            <div class="company-name">CÔNG TY CỔ PHẦN NỘI THẤT NHÔM KÍNH</div>
            <div class="company-name">ĐÀ NẴNG ALUMINIUM</div>
        </div>
        <div class="header-right">
            <div class="motto">CỘNG HÒA XÃ HỘI CHỦ NGHĨA VIỆT NAM</div>
            <div class="sub-motto">Độc Lập – Tự Do – Hạnh Phúc</div>
        </div>
    </div>

    <div class="address-info">
        <span>Địa chỉ: 64 Đặng Văn Ngữ - Khuê Trung - Cẩm Lệ - Đà Nẵng</span>
    </div>

    <div class="date-line">
        Đà Nẵng, Ngày <span id="ngay">...</span> tháng <span id="thang">...</span> năm <span id="nam">...</span>.
    </div>

    <div class="title">GIẤY ĐỀ NGHỊ TẠM ỨNG</div>
    <div class="subject">(V/v: tạm ứng đợt <span id="dot_subject">...</span>)</div>

    <div class="content-section">
        Kính gởi: <strong>ANH SINH</strong><br>
        Địa chỉ: <span id="diachi">...</span>
    </div>

    <div class="content-section">
        Căn cứ theo hợp đồng thi công số: <span id="sohd1" style="font-weight: bold;">...</span> và thực tế thi công tại công trình. Hôm nay bên em xin đề nghị tạm ứng đợt <span id="dot_body">...</span> với nội dung và số tiền như sau:
    </div>

    <!-- BẢNG GIÁ TRỊ -->
    <table>
        <thead>
            <tr>
                <th style="width: 60%;">NỘI DUNG</th>
                <th style="width: 40%;">SỐ TIỀN (VNĐ)</th>
            </tr>
        </thead>
        <tbody id="payment-table-body">
            <!-- JS sẽ điền dữ liệu vào đây -->
        </tbody>
    </table>

    <div class="content-section">
        Số tiền trên kính đề nghị quý công ty thanh toán như sau:
    </div>

    <div class="bank-info">
        <strong>Hình thức:</strong> Chuyển khoản<br>
        <strong>Thông tin chuyển tiền:</strong><br>
        - Chủ tài khoản: Công ty cổ phần Nội Thất Nhôm Kính Đà Nẵng Aluminium<br>
        - STK: <strong>190590</strong> tại ngân hàng Techcombank – CN Đà Nẵng
    </div>

    <div class="footer">
        <div style="font-weight: bold; text-transform: uppercase;">CÔNG TY CP NỘI THẤT NHÔM KÍNH</div>
        <div style="font-weight: bold; text-transform: uppercase;">ĐÀ NẴNG ALUMINIUM</div>
        <div style="font-weight: bold; margin-top: 10px;">Giám đốc</div>
        <div class="signature-space"></div>
    </div>
</div>

<script>
    // === 1. HÀM TIỆN ÍCH ===
    const urlParams = new URLSearchParams(window.location.search);
    const formatter = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' });

    function getParam(key, defaultVal) { 
        return urlParams.get(key) || defaultVal; 
    }

    // Hàm chuyển chuỗi "100.000.000" thành số 100000000 (Xóa mọi ký tự không phải số)
    function cleanNumber(str) {
        if (!str) return 0;
        // Xóa tất cả ký tự không phải số (ví dụ dấu chấm, dấu phẩy, chữ cái)
        const cleanStr = str.toString().replace(/[^0-9]/g, '');
        return parseInt(cleanStr) || 0;
    }

    // === 2. ĐIỀN THÔNG TIN CƠ BẢN ===
    const now = new Date();
    document.getElementById('ngay').textContent = getParam('ngay', now.getDate());
    document.getElementById('thang').textContent = getParam('thang', now.getMonth() + 1);
    document.getElementById('nam').textContent = getParam('nam', now.getFullYear());
    document.getElementById('diachi').textContent = getParam('diachi', 'TP. Đà Nẵng');
    
    const soHD = getParam('sohd', 'HĐTC-01/2025');
    document.getElementById('sohd1').textContent = soHD;

    // === 3. XỬ LÝ TIỀN VÀ BẢNG (CORE LOGIC) ===
    
    // Lấy TỔNG TIỀN (Sử dụng hàm cleanNumber để tránh lỗi format)
    // Ví dụ URL: tongtien=500.000.000 vẫn chạy tốt
    const rawTongTien = cleanNumber(getParam('tongtien', '0'));

    // Lấy chuỗi TẠM ỨNG
    const rawTamUngStr = getParam('tamung', '');
    // Tách chuỗi và làm sạch số liệu
    const arrTamUng = rawTamUngStr.split('_c_')
        .map(str => cleanNumber(str))
        .filter(num => num > 0); // Chỉ lấy số lớn hơn 0

    // Xác định đợt hiện tại
    const currentDot = arrTamUng.length > 0 ? arrTamUng.length : 1;
    document.getElementById('dot_subject').textContent = currentDot;
    document.getElementById('dot_body').textContent = currentDot;

    // Xây dựng nội dung bảng
    const tbody = document.getElementById('payment-table-body');
    let html = '';
    let totalPaid = 0;

    // --- DÒNG 1: TỔNG GIÁ TRỊ HỢP ĐỒNG ---
    html += `
        <tr>
            <td>
                Hợp đồng thi công số: <b>${soHD}</b><br>
                <i>(Tổng giá trị hợp đồng)</i>
            </td>
            <td class="col-money">${formatter.format(rawTongTien)}</td>
        </tr>
    `;

    // --- CÁC DÒNG TẠM ỨNG ---
    if (arrTamUng.length > 0) {
        arrTamUng.forEach((amount, index) => {
            totalPaid += amount;
            const dot = index + 1;
            // Nếu là dòng cuối cùng thì thêm chữ (Đợt này)
            const note = (index === arrTamUng.length - 1) ? " (Đợt này)" : "";
            
            html += `
                <tr>
                    <td>Đề nghị tạm ứng đợt ${dot} ${note}</td>
                    <td class="col-money">${formatter.format(amount)}</td>
                </tr>
            `;
        });
    } else {
        // Trường hợp chưa nhập tạm ứng
        html += `<tr><td>Đề nghị tạm ứng đợt 1</td><td class="col-money">0 ₫</td></tr>`;
    }

    // --- DÒNG ĐỌC SỐ TIỀN BẰNG CHỮ (Cho đợt này) ---
    const currentAmount = (arrTamUng.length > 0) ? arrTamUng[arrTamUng.length - 1] : 0;
    if (currentAmount > 0) {
        html += `
            <tr>
                <td colspan="2" style="text-align: center; font-style: italic;">
                    (Bằng chữ: ${DocTienBangChu(currentAmount)})
                </td>
            </tr>
        `;
    }

    // --- DÒNG CÒN LẠI ---
    const remaining = rawTongTien - totalPaid;
    html += `
        <tr style="background-color: #ffffcc;">
            <td>
                <b>GIÁ TRỊ CẦN THANH TOÁN TIẾP THEO (CÒN LẠI)</b><br>
                <i>(= Tổng HĐ - Tổng các đợt đã ứng)</i>
            </td>
            <td class="col-money" style="color: red; font-size: 1.1em;">
                ${formatter.format(remaining)}
            </td>
        </tr>
    `;

    tbody.innerHTML = html;


    // === 4. HÀM ĐỌC SỐ THÀNH CHỮ ===
    function DocTienBangChu(SoTien) {
        if(SoTien <= 0) return "Không đồng";
        var Lan = 0; var i = 0; var so = 0; var KetQua = ""; var tmp = ""; var ViTri = new Array();
        if (SoTien > 8999999999999999) return "Số quá lớn!";
        ViTri[5] = Math.floor(SoTien / 1000000000000000); if (isNaN(ViTri[5])) ViTri[5] = "0";
        SoTien = SoTien - parseFloat(ViTri[5].toString()) * 1000000000000000;
        ViTri[4] = Math.floor(SoTien / 1000000000000); if (isNaN(ViTri[4])) ViTri[4] = "0";
        SoTien = SoTien - parseFloat(ViTri[4].toString()) * 1000000000000;
        ViTri[3] = Math.floor(SoTien / 1000000000); if (isNaN(ViTri[3])) ViTri[3] = "0";
        SoTien = SoTien - parseFloat(ViTri[3].toString()) * 1000000000;
        ViTri[2] = parseInt(SoTien / 1000000); if (isNaN(ViTri[2])) ViTri[2] = "0";
        ViTri[1] = parseInt((SoTien % 1000000) / 1000); if (isNaN(ViTri[1])) ViTri[1] = "0";
        ViTri[0] = parseInt(SoTien % 1000); if (isNaN(ViTri[0])) ViTri[0] = "0";
        if (ViTri[5] > 0) Lan = 5; else if (ViTri[4] > 0) Lan = 4; else if (ViTri[3] > 0) Lan = 3; else if (ViTri[2] > 0) Lan = 2; else if (ViTri[1] > 0) Lan = 1; else Lan = 0;
        for (i = Lan; i >= 0; i--) {
            tmp = DocSo3ChuSo(ViTri[i]); KetQua += tmp;
            if (ViTri[i] > 0) KetQua += Tien[i];
            if ((i > 0) && (tmp.length > 0)) KetQua += ',';
        }
        if (KetQua.substring(KetQua.length - 1) == ',') KetQua = KetQua.substring(0, KetQua.length - 1);
        KetQua = KetQua.substring(1, 2).toUpperCase() + KetQua.substring(2);
        return KetQua + " đồng ./.";
    }
    var Tien = new Array("", " nghìn", " triệu", " tỷ", " nghìn tỷ", " triệu tỷ");
    var ChuSo = new Array(" không", " một", " hai", " ba", " bốn", " năm", " sáu", " bảy", " tám", " chín");
    function DocSo3ChuSo(baso) {
        var tram, chuc, donvi; var KetQua = "";
        tram = parseInt(baso / 100); chuc = parseInt((baso % 100) / 10); donvi = baso % 10;
        if (tram == 0 && chuc == 0 && donvi == 0) return "";
        if (tram != 0) { KetQua += ChuSo[tram] + " trăm"; if ((chuc == 0) && (donvi != 0)) KetQua += " linh"; }
        if ((chuc != 0) && (chuc != 1)) { KetQua += ChuSo[chuc] + " mươi"; if ((chuc == 0) && (donvi != 0)) KetQua = KetQua + " linh"; }
        if (chuc == 1) KetQua += " mười";
        switch (donvi) {
            case 1: if ((chuc != 0) && (chuc != 1)) KetQua += " mốt"; else KetQua += ChuSo[donvi]; break;
            case 5: if (chuc == 0) KetQua += ChuSo[donvi]; else KetQua += " lầm"; break;
            default: if (donvi != 0) KetQua += ChuSo[donvi]; break;
        }
        return KetQua;
    }
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giấy Đề Nghị Tạm Ứng</title>
    <style>
        body {
            font-family: "Times New Roman", Times, serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            line-height: 1.5;
        }

        .a4-page {
            width: 210mm;
            min-height: 297mm;
            padding: 20mm;
            background: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
            position: relative;
        }

        .a4-page::before {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 400px;
            height: 400px;
            background-image: url('https://www.appsheet.com/template/gettablefileurl?appName=Upcode-325045268&tableName=D%E1%BB%B1%20%C3%A1n&fileName=D%E1%BB%B1%20%C3%A1n_Images%2F96a60fd9.%E1%BA%A2nh%20Logo.090208.jpg');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            opacity: 0.15;
            pointer-events: none;
            z-index: 0;
        }

        .a4-page>* {
            position: relative;
            z-index: 1;
        }

        .header {
            display: flex;
            justify-content: space-between;
            text-align: center;
            margin-bottom: 10px;
        }

        .header-left,
        .header-right {
            width: 50%;
        }

        .company-name {
            font-weight: bold;
            text-transform: uppercase;
            font-size: 11pt;
        }

        .motto {
            font-weight: bold;
            font-size: 11pt;
        }

        .sub-motto {
            font-weight: bold;
            font-size: 11pt;
            border-bottom: 1px solid black;
            display: inline-block;
            padding-bottom: 3px;
        }

        .address-date-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 10pt;
            border-bottom: 1px solid #ccc;
            padding-bottom: 10px;
            margin-bottom: 10px;
            margin-top: 5px;
        }

        .address-info {
            text-align: left;
        }

        .date-line {
            text-align: right;
            font-style: italic;
        }

        .title {
            text-align: center;
            font-weight: bold;
            font-size: 18pt;
            margin-top: 20px;
            margin-bottom: 5px;
        }

        .subject {
            text-align: center;
            font-weight: bold;
            font-style: italic;
            margin-bottom: 20px;
        }

        .content-section {
            margin-bottom: 10px;
            text-align: justify;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        table,
        th,
        td {
            border: 1px solid black;
        }

        th,
        td {
            padding: 8px;
            vertical-align: middle;
        }

        th {
            text-align: center;
            text-transform: uppercase;
            font-weight: bold;
            background-color: #eee;
        }

        .col-money {
            text-align: right;
            font-weight: bold;
            white-space: nowrap;
        }

        .footer {
            margin-top: 30px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            text-align: center;
            padding-right: 20px;
        }

        .signature-space {
            height: 80px;
        }

        .bank-info {
            margin-top: 15px;
            background-color: #f9f9f9;
            padding: 10px;
            border: 1px dashed #999;
            font-size: 10pt;
        }
    </style>
</head>

<body>

    <div class="a4-page">
        <div class="header">
            <div class="header-left">
                <div class="company-name">CÔNG TY CỔ PHẦN NỘI THẤT NHÔM KÍNH</div>
                <div class="company-name">ĐÀ NẴNG ALUMINIUM</div>
            </div>
            <div class="header-right">
                <div class="motto">CỘNG HÒA XÃ HỘI CHỦ NGHĨA VIỆT NAM</div>
                <div class="sub-motto">Độc Lập – Tự Do – Hạnh Phúc</div>
            </div>
        </div>

        <div class="address-date-row">
            <div class="address-info">
                <span>Địa chỉ: 64 Đặng Văn Ngữ - Khuê Trung - Cẩm Lệ - Đà Nẵng</span>
            </div>
            <div class="date-line">
                Đà Nẵng, Ngày <span id="ngay">...</span> tháng <span id="thang">...</span> năm <span
                    id="nam">...</span>.
            </div>
        </div>

        <div class="title">GIẤY ĐỀ NGHỊ TẠM ỨNG</div>
        <div class="subject">(V/v: tạm ứng đợt <span id="dot_subject">...</span>)</div>

        <div class="content-section">
            Kính gởi: <strong>ANH SINH</strong><br>
            Địa chỉ: <span id="diachi">...</span>
        </div>

        <div class="content-section">
            Căn cứ theo hợp đồng thi công số: <span id="sohd1" style="font-weight: bold;">...</span> và thực tế thi công
            tại công trình. Hôm nay bên em xin đề nghị tạm ứng đợt <span id="dot_body">...</span> với nội dung và số
            tiền như sau:
        </div>

        <!-- BẢNG DỮ LIỆU -->
        <table>
            <thead>
                <tr>
                    <th style="width: 60%;">NỘI DUNG</th>
                    <th style="width: 40%;">SỐ TIỀN (VNĐ)</th>
                </tr>
            </thead>
            <tbody id="bang_du_lieu">
                <!-- Dữ liệu sẽ hiển thị ở đây -->
            </tbody>
        </table>

        <div class="content-section">
            Số tiền trên kính đề nghị quý công ty thanh toán như sau:
        </div>

        <div class="bank-info">
            <strong>Hình thức:</strong> Chuyển khoản<br>
            <strong>Thông tin chuyển tiền:</strong><br>
            - Chủ tài khoản: Công ty cổ phần Nội Thất Nhôm Kính Đà Nẵng Aluminium<br>
            - STK: <strong>190590</strong> tại ngân hàng Techcombank – CN Đà Nẵng
        </div>

        <div class="footer">
            <div style="font-weight: bold; text-transform: uppercase;">CÔNG TY CP NỘI THẤT NHÔM KÍNH</div>
            <div style="font-weight: bold; text-transform: uppercase;">ĐÀ NẴNG ALUMINIUM</div>
            <div style="font-weight: bold; margin-top: 10px;">Giám đốc</div>
            <div class="signature-space"></div>
        </div>
    </div>

    <script>
        // 1. Lấy thông tin URL
        const params = new URLSearchParams(window.location.search);

        // DEBUG: In ra toàn bộ URL để kiểm tra
        console.log("=== DEBUG PHIẾU TẠM ỨNG ===");
        console.log("Full URL:", window.location.href);
        console.log("URL Search:", window.location.search);

        // In ra tất cả các parameters
        console.log("\n=== TẤT CẢ PARAMETERS ===");
        for (let [key, value] of params.entries()) {
            console.log(`${key} = "${value}"`);
        }

        // Hàm làm sạch số (loại bỏ chữ, dấu chấm phẩy)
        function cleanNumber(str) {
            if (!str) return 0;
            return parseInt(str.toString().replace(/[^0-9]/g, '')) || 0;
        }

        // Hàm định dạng tiền tệ
        const fmt = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' });

        // 2. Lấy dữ liệu
        const ngay = params.get('ngay') || new Date().getDate();
        const thang = params.get('thang') || (new Date().getMonth() + 1);
        const nam = params.get('nam') || new Date().getFullYear();
        const sohd = params.get('sohd') || '...';
        const diachi = params.get('diachi') || '...';

        // Xử lý Tiền (Quan trọng)
        const tongTienStr = params.get('tongtien') || '0';
        const tamUngStr = params.get('tamung') || ''; // Chuỗi dạng "100_c_200"

        console.log("\n=== DỮ LIỆU THÔ ===");
        console.log("tongTienStr:", tongTienStr);
        console.log("tamUngStr:", tamUngStr);

        const tongTien = cleanNumber(tongTienStr);

        // Tách mảng tạm ứng
        let arrTamUng = [];
        if (tamUngStr.includes('_c_')) {
            arrTamUng = tamUngStr.split('_c_');
            console.log("Split by '_c_':", arrTamUng);
        } else if (tamUngStr.length > 0) {
            // Trường hợp chỉ có 1 số, không có dấu _c_
            arrTamUng = [tamUngStr];
            console.log("Single value:", arrTamUng);
        }

        // Chuyển mảng chuỗi thành mảng số
        arrTamUng = arrTamUng.map(s => cleanNumber(s)).filter(n => n > 0);

        // 3. DEBUG: Kiểm tra xem code có nhận được số không?
        console.log("\n=== DỮ LIỆU SAU KHI XỬ LÝ ===");
        console.log("Tổng tiền (số):", tongTien);
        console.log("Mảng tạm ứng (số):", arrTamUng);
        console.log("Tổng đã ứng:", arrTamUng.reduce((sum, val) => sum + val, 0));

        // 4. Hiển thị thông tin Header
        document.getElementById('ngay').innerText = ngay;
        document.getElementById('thang').innerText = thang;
        document.getElementById('nam').innerText = nam;
        document.getElementById('diachi').innerText = diachi;
        document.getElementById('sohd1').innerText = sohd;

        const dotHienTai = arrTamUng.length > 0 ? arrTamUng.length : 1;
        document.getElementById('dot_subject').innerText = dotHienTai;
        document.getElementById('dot_body').innerText = dotHienTai;

        // 5. Vẽ Bảng
        const tbody = document.getElementById('bang_du_lieu');
        let html = '';
        let daUng = 0;

        // Dòng 1: Tổng HĐ
        html += `<tr><td>Hợp đồng thi công số: <b>${sohd}</b></td><td class="col-money">${fmt.format(tongTien)}</td></tr>`;

        // Các dòng tạm ứng
        if (arrTamUng.length > 0) {
            arrTamUng.forEach((tien, index) => {
                daUng += tien;
                html += `<tr><td>Tạm ứng đợt ${index + 1}</td><td class="col-money">${fmt.format(tien)}</td></tr>`;
            });
        } else {
            html += `<tr><td colspan="2" style="text-align:center; color:#999; font-style:italic;">⚠️ Chưa có thông tin tạm ứng từ URL</td></tr>`;
        }

        // Dòng bằng chữ (Đợt này)
        const tienDotNay = arrTamUng.length > 0 ? arrTamUng[arrTamUng.length - 1] : 0;
        if (tienDotNay > 0) {
            html += `<tr><td colspan="2" style="text-align:center; font-style:italic;">(Bằng chữ: ${DocTienBangChu(tienDotNay)})</td></tr>`;
        }

        // Dòng còn lại
        const conLai = tongTien - daUng;
        html += `<tr style="background-color:#ffffe0"><td><b>CÒN LẠI CẦN THANH TOÁN</b></td><td class="col-money" style="color:red">${fmt.format(conLai)}</td></tr>`;

        tbody.innerHTML = html;

        console.log("\n=== BẢNG ĐÃ RENDER ===");
        console.log("HTML Generated:", html.substring(0, 200) + "...");

        // Hàm đọc số (Rút gọn)
        function DocTienBangChu(n) { if (n <= 0) return "Không đồng"; var t = ["", " nghìn", " triệu", " tỷ", " nghìn tỷ", " triệu tỷ"], e = [" không", " một", " hai", " ba", " bốn", " năm", " sáu", " bảy", " tám", " chín"]; function o(n) { var o = "", a = Math.floor(n / 100), r = Math.floor(n % 100 / 10), c = n % 10; return 0 == a && 0 == r && 0 == c ? "" : "" != o && (o += e[a] + " trăm", 0 == r && 0 != c && (o += " linh")), (0 != r && 1 != r && (o += e[r] + " mươi", 0 == r && 0 != c && (o += " linh")), 1 == r && (o += " mười"), 1 == c ? o += 0 != r && 1 != r ? " mốt" : e[c] : 5 == c ? o += 0 == r ? e[c] : " lầm" : 0 != c && (o += e[c]), o) } var a = "", r = 0, c = n, u = new Array; if (n > 8999999999999999) return "Số quá lớn!"; u[5] = Math.floor(c / 1e15), isNaN(u[5]) && (u[5] = "0"), c -= parseFloat(u[5].toString()) * 1e15, u[4] = Math.floor(c / 1e12), isNaN(u[4]) && (u[4] = "0"), c -= parseFloat(u[4].toString()) * 1e12, u[3] = Math.floor(c / 1e9), isNaN(u[3]) && (u[3] = "0"), c -= parseFloat(u[3].toString()) * 1e9, u[2] = parseInt(c / 1e6), isNaN(u[2]) && (u[2] = "0"), u[1] = parseInt(c % 1e6 / 1e3), isNaN(u[1]) && (u[1] = "0"), u[0] = parseInt(c % 1e3), isNaN(u[0]) && (u[0] = "0"), u[5] > 0 ? r = 5 : u[4] > 0 ? r = 4 : u[3] > 0 ? r = 3 : u[2] > 0 ? r = 2 : u[1] > 0 ? r = 1 : r = 0; for (var i = r; i >= 0; i--) { var l = o(u[i]); a += l, u[i] > 0 && (a += t[i]), i > 0 && l.length > 0 && (a += ",") } return "," == a.substring(a.length - 1) && (a = a.substring(0, a.length - 1)), a.substring(1, 2).toUpperCase() + a.substring(2) + " đồng ./."; }
    </script>

</body>

</html>

<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Báo cáo tổng hợp</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <!-- Thư viện Chart.js và plugin Datalabels -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

  <style>
    /* --- BASE STYLES --- */
    :root {
        --primary-color: #4A6E23;
        --primary-light: #8BC34A;
        --primary-dark: #2E4617;
        --secondary-color: #FFC107;
        --accent-color: #2196F3;
        --text-dark: #333;
        --text-medium: #555;
        --text-light: #777;
        --bg-light: #f8f9fa;
        --border-color: #e0e0e0;
        --success-color: #4CAF50;
        --warning-color: #FF9800;
        --danger-color: #F44336;
        --font-main: 'Roboto', Arial, sans-serif;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body { 
        font-family: var(--font-main); 
        padding: 20px; 
        background-color: var(--bg-light);
        font-weight: 500;
        color: var(--text-dark);
        line-height: 1.6;
    }

    /* --- LAYOUT & CONTAINERS --- */
    .header { 
        display: flex; 
        align-items: center; 
        margin-bottom: 20px; 
        padding-bottom: 15px;
        border-bottom: 1px solid var(--border-color);
    }
    .header img { height: 70px; width: 70px; margin-right: 20px; border-radius: 8px; object-fit: cover; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .header h2 { margin: 0; color: var(--primary-color); font-size: 1.8em; font-weight: 700; }
    
    .report-container { display: flex; flex-wrap: wrap; gap: 20px; align-items: flex-start; max-width: 1800px; margin: 0 auto; }

    /* --- TAB STYLES --- */
    .tab { overflow: hidden; border: 1px solid var(--border-color); background-color: #f1f1f1; border-radius: 8px; margin-bottom: 20px; }
    .tab button { background-color: inherit; float: left; border: none; outline: none; cursor: pointer; padding: 14px 20px; transition: background-color 0.3s; font-size: 16px; font-weight: 600; color: var(--text-medium); }
    .tab button:hover { background-color: #ddd; }
    .tab button.active { background-color: var(--primary-color); color: white; }
    .tab-content { display: none; padding: 6px 12px; border-top: none; animation: fadeIn 0.5s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* --- TABLE STYLES --- */
    .table-responsive-container { overflow-x: auto; margin-bottom: 30px; border-radius: 8px; box-shadow: 0 2px 15px rgba(0,0,0,0.05); }
    table { width: 100%; border-collapse: separate; border-spacing: 0; table-layout: auto; margin-top: 20px; background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.05); font-size: 0.95em; }
    th, td { border: 1px solid var(--border-color); padding: 12px 15px; white-space: nowrap; vertical-align: middle; }
    th { text-align: center !important; background: var(--primary-light); color: white; font-weight: 700; font-size: 1.05em; text-transform: uppercase; letter-spacing: 0.5px; position: sticky; top: 0; z-index: 1; }
    td { text-align: right !important; font-weight: 500; }
    .text-left { text-align: left !important; }
    .text-center { text-align: center !important; }

    tbody tr { cursor: pointer; transition: all 0.2s ease; }
    tbody tr:not(.row-selected):hover { background-color: rgba(139, 195, 74, 0.08); }
    tbody tr.row-selected, tbody tr.row-selected:hover { background-color: #FFF59D !important; color: var(--text-dark) !important; font-weight: 600; }
    
    tr.total-row, tr.total-row:hover, tfoot tr, tfoot tr:hover { background: #fffde7; font-size: 1.05em; color: var(--text-dark); border-top: 2px solid var(--primary-light); font-weight: 600; cursor: default; }
    .total-label, tfoot td[colspan] { text-align: left !important; font-weight: 700; }
    .total-value, tfoot td:not([colspan]) { text-align: right !important; font-weight: 700; }
    
    .bg-green { background-color: var(--success-color) !important; color: white; font-weight: 600; }
    .bg-yellow { background-color: var(--warning-color) !important; color: var(--text-dark); font-weight: 600; }

    .top-1, .top-2, .top-3 { border-left: 5px solid; font-weight: 700 !important; }
    .top-1 { background-color: #fffbeb; border-color: #FFD700; /* Gold */ }
    .top-2 { background-color: #f5f7fa; border-color: #C0C0C0; /* Silver */ }
    .top-3 { background-color: #fff5eb; border-color: #CD7F32; /* Bronze */ }

    /* --- SIDEBAR STYLES --- */
    .sidebar { width: 280px; flex-shrink: 0; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 15px rgba(0,0,0,0.05); position: sticky; top: 20px; max-height: calc(100vh - 40px); overflow-y: auto; }
    .main-detailed { flex-grow: 1; min-width: 0; width: calc(100% - 300px); }
    .sidebar h3 { background: var(--primary-color); color: #fff; padding: 12px 15px; margin: 20px 0 10px; border-radius: 6px; font-size: 1.1em; font-weight: 600; }
    .sidebar label { display: block; margin: 12px 0; font-size: 0.95em; color: var(--text-medium); font-weight: 500; }
    .sidebar .indent { margin-left: 20px; }
    .sidebar input[type="date"] { width: 100%; box-sizing: border-box; padding: 10px 12px; margin: 6px 0 12px; border: 1px solid var(--border-color); border-radius: 6px; font-weight: 500; font-size: 0.95em; }
    .sidebar input[type="checkbox"] { margin-right: 8px; transform: scale(1.1); vertical-align: middle; }
    
    /* --- DAILY BREAKDOWN (TAB 1) --- */
    .daily-breakdown h3 { margin: 30px 0 15px; background: #f8f9fa; padding: 12px 15px; border-left: 4px solid var(--primary-color); border-radius: 0 6px 6px 0; font-size: 1.2em; color: var(--primary-dark); }
    
    /* --- LOADING OVERLAY --- */
    #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.85); display: flex; justify-content: center; align-items: center; z-index: 9999; font-size: 1.2em; color: var(--primary-color); transition: all 0.3s ease; visibility: hidden; opacity: 0; backdrop-filter: blur(3px); }
    #loading-overlay.visible { visibility: visible; opacity: 1; }

    /* --- STYLES TAB 2: BÁO CÁO THEO NGÀY (BIỂU ĐỒ) --- */
    .daily-report-layout { display: flex; gap: 20px; }
    .daily-report-layout .sidebar { width: 260px; }
    .daily-report-layout .main-content { flex-grow: 1; }
    .main-daily h2 { color: var(--primary-dark); text-align: center; margin-bottom: 20px; font-weight: 700; font-size: 28px; }

    .chart-toggle-controls { margin: 20px 0; padding: 10px; background: #eee; border-radius: 8px; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }
    .chart-toggle-controls label { font-size: 15px; cursor: pointer; }
    .chart-toggle-controls .toggle-all { font-weight: bold; }

    .charts-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .chart-wrapper { background: #fff; padding: 15px; border-radius: 12px; box-shadow: 0 6px 12px rgba(0,0,0,0.1); }
    .chart-wrapper canvas { width: 100% !important; height: 350px !important; }
    #date-summary-body tr { cursor: pointer; }

    /* --- CSS CHO MODAL CHI TIẾT NGÀY --- */
    .modal { display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
    .modal-content { background-color: #fefefe; margin: auto; padding: 25px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 95%; max-width: 1400px; max-height: 90vh; display: flex; flex-direction: column; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; padding-bottom: 15px; margin-bottom: 15px; }
    .modal-header h2 { margin: 0; color: var(--primary-dark); font-size: 24px; }
    .close-button { color: #aaa; font-size: 30px; font-weight: bold; cursor: pointer; }
    .close-button:hover, .close-button:focus { color: black; text-decoration: none; }
    .modal-body { overflow-y: auto; }
    #modal-summary-table th { cursor: pointer; position: relative; }
    #modal-summary-table th .sort-icon { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-size: 0.8em; opacity: 0.4; transition: opacity 0.2s; }
    #modal-summary-table th:hover .sort-icon { opacity: 0.8; }
    #modal-summary-table th.sorted .sort-icon { opacity: 1; }
    #modal-summary-table th .sort-icon.asc::after { content: " ▲"; }
    #modal-summary-table th .sort-icon.desc::after { content: " ▼"; }
    
    @media (max-width: 1200px) {
        .report-container, .daily-report-layout { flex-direction: column; }
        .sidebar, .daily-report-layout .sidebar { width: 100%; position: static; max-height: none; }
        .main-detailed, .daily-report-layout .main-content { width: 100%; }
        .charts-container { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  
  <div id="loading-overlay">Đang tải dữ liệu...</div>
  
  <div class="header"> 
      <img src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Ff930e667.%E1%BA%A2nh.025539.jpg" alt="Logo"> 
      <h2 id="report-title">DỮ LIỆU TỔNG HỢP</h2> 
  </div>

  <!-- Tab Buttons -->
  <div class="tab">
    <button class="tab-links" onclick="openTab(event, 'DetailedReport')" id="defaultOpen">Báo cáo Chi tiết</button>
    <button class="tab-links" onclick="openTab(event, 'DailyReport')">Báo cáo theo Ngày</button>
  </div>

  <!-- NỘI DUNG CHO TAB BÁO CÁO CHI TIẾT (CODE GỐC) -->
  <div id="DetailedReport" class="tab-content">
    <div class="report-container">
        <!-- Sidebar lọc bên trái -->
        <div class="sidebar">
          <h3>Bộ lọc</h3>
          <label>Từ ngày:<input type="date" id="start-date"></label> 
          <label>Đến ngày:<input type="date" id="end-date"></label>
          
          <h3>Sản phẩm</h3> 
          <label><input type="checkbox" id="product-all" checked> Tất cả</label> 
          <div id="product-options" class="indent"></div>
          
          <h3>Ca</h3> 
          <label><input type="checkbox" id="ca-all" checked> Tất cả</label> 
          <div id="ca-options" class="indent"></div>
          
          <h3>Team</h3> 
          <label><input type="checkbox" id="team-all" checked> Tất cả</label> 
          <div id="team-options" class="indent"></div>
          
          <h3>Thị trường</h3> 
          <label><input type="checkbox" id="market-all" checked> Tất cả</label> 
          <div id="market-options" class="indent"></div>
        </div>
        
        <!-- Nội dung chính bên phải -->
        <div class="main-detailed">
          <div class="table-responsive-container">
            <table id="summary-table">
              <thead>
                <tr>
                  <th>STT</th><th>Chi nhánh</th><th>Team</th><th>Sale</th>
                  <th>Số Mess</th><th>Số Đơn</th><th>Phản hồi</th><th>DS Chốt</th><th>Tỉ lệ chốt</th>
                </tr>
              </thead>
              <tbody id="summary-body"></tbody>
              <tfoot id="summary-foot"></tfoot>
            </table>
          </div>
          <div id="daily-breakdown"></div>
        </div>
    </div>
  </div>

  <!-- NỘI DUNG CHO TAB BÁO CÁO THEO NGÀY (MỚI) -->
  <div id="DailyReport" class="tab-content">
      <div class="main-daily">
        <h2>Báo cáo hiệu suất theo ngày</h2>
        <div class="daily-report-layout">
          <!-- Sidebar bộ lọc cho Tab 2 -->
          <div class="sidebar">
            <h3>Bộ lọc</h3>
            <label for="start-date-tab2">Từ ngày:</label>
            <input type="date" id="start-date-tab2">
            
            <label for="end-date-tab2">Đến ngày:</label>
            <input type="date" id="end-date-tab2">
            
            <h3>Sản phẩm</h3>
            <label><input type="checkbox" id="product-all-tab2" checked> Tất cả</label>
            <div id="product-options-tab2" class="indent"></div>
            
            <h3>Thị trường</h3>
            <label><input type="checkbox" id="market-all-tab2" checked> Tất cả</label>
            <div id="market-options-tab2" class="indent"></div>
          </div>

          <!-- Nội dung chính cho Tab 2 -->
          <div class="main-content">
            <!-- Bảng tổng hợp theo ngày -->
            <div class="table-responsive-container">
              <table id="date-summary-table">
                <thead> 
                  <tr> 
                    <th>Ngày</th><th>Tổng Số Mess</th><th>Tổng Số Đơn</th><th>DS Chốt</th><th>Tỉ lệ chốt TB</th> 
                  </tr> 
                </thead>
                <tbody id="date-summary-body"></tbody>
              </table>
            </div>

            <!-- Các nút bật/tắt biểu đồ -->
            <div class="chart-toggle-controls">
                <label class="toggle-all"><input type="checkbox" id="toggle-all-charts" checked> Chọn/Bỏ chọn tất cả</label>
                <label><input type="checkbox" class="chart-toggle" data-chart="messChart" checked> Tổng Mess</label>
                <label><input type="checkbox" class="chart-toggle" data-chart="donChart" checked> Tổng Đơn</label>
                <label><input type="checkbox" class="chart-toggle" data-chart="dsChotChart" checked> DS Chốt</label>
                <label><input type="checkbox" class="chart-toggle" data-chart="rateChart" checked> Tỉ lệ chốt</label>
                <label><input type="checkbox" class="chart-toggle" data-chart="productSalesChart" checked> DS theo Sản phẩm</label>
                <label><input type="checkbox" class="chart-toggle" data-chart="marketSalesChart" checked> DS theo Thị trường</label>
            </div>

            <!-- Vùng chứa các biểu đồ -->
            <div class="charts-container">
              <div class="chart-wrapper" data-chart="messChart"><canvas id="messChart"></canvas></div>
              <div class="chart-wrapper" data-chart="donChart"><canvas id="donChart"></canvas></div>
              <div class="chart-wrapper" data-chart="dsChotChart"><canvas id="dsChotChart"></canvas></div>
              <div class="chart-wrapper" data-chart="rateChart"><canvas id="rateChart"></canvas></div>
              <div class="chart-wrapper" data-chart="productSalesChart"><canvas id="productSalesChart"></canvas></div>
              <div class="chart-wrapper" data-chart="marketSalesChart"><canvas id="marketSalesChart"></canvas></div>
            </div>
          </div>
        </div>
      </div>
  </div>

  <!-- Cấu trúc HTML cho Modal chi tiết ngày -->
  <div id="daily-detail-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modal-title">Chi tiết ngày</h2>
          <span class="close-button">&times;</span>
        </div>
        <div class="modal-body">
          <div class="table-responsive-container">
            <table id="modal-summary-table">
              <thead>
                <tr>
                    <th>STT <span class="sort-icon"></span></th> 
                    <th>Team <span class="sort-icon"></span></th> 
                    <th>Sale <span class="sort-icon"></span></th>
                    <th>Sản phẩm <span class="sort-icon"></span></th>
                    <th>Thị trường <span class="sort-icon"></span></th>
                    <th>Số Mess <span class="sort-icon"></span></th> 
                    <th>Số Đơn <span class="sort-icon"></span></th> 
                    <th>Phản hồi <span class="sort-icon"></span></th> 
                    <th>DS Chốt <span class="sort-icon"></span></th>
                    <th>Tỉ lệ chốt <span class="sort-icon"></span></th> 
                </tr>
              </thead>
              <tbody id="modal-summary-body"></tbody>
              <tfoot id="modal-summary-foot"></tfoot>
            </table>
          </div>
        </div>
      </div>
  </div>


<script>
// --- KHAI BÁO BIẾN TOÀN CỤC ---
let rawData = [];
let employeeData = [];
let isRestrictedView = false;
let allowedNames = [];
let charts = {}; // Lưu các đối tượng biểu đồ của Tab 2
let currentModalSummaryList = []; // Lưu dữ liệu đang hiển thị trong modal của Tab 2
let modalSortState = { column: null, direction: 'asc' }; // Lưu trạng thái sắp xếp của bảng modal

const loader = document.getElementById('loading-overlay');
const showLoader = () => loader.classList.add('visible');
const hideLoader = () => loader.classList.remove('visible');

// Định nghĩa các cột có thể sắp xếp trong modal của Tab 2
const columnSortKeys = {
    // 0 là STT, không sắp xếp
    1: { prop: 'team', type: 'string' },
    2: { prop: 'name', type: 'string' },
    3: { prop: 'sanPham', type: 'string' },
    4: { prop: 'thiTruong', type: 'string' },
    5: { prop: 'mess', type: 'number' },
    6: { prop: 'don', type: 'number' },
    7: { prop: 'phanHoi', type: 'number' },
    8: { prop: 'chot', type: 'number' },
    9: { prop: (s) => s.mess ? s.don / s.mess : 0, type: 'number' }, // Tỉ lệ chốt
};


// --- CÁC HÀM TIỆN ÍCH ---
const formatDate = v => { const d = new Date(v); if (isNaN(d.getTime())) return v; return `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`; };
const formatCurrency = v => Number(v||0).toLocaleString('vi-VN',{style:'currency',currency:'VND'});
const formatNumber = v => Number(v||0).toLocaleString('vi-VN');
const formatPercent = v => { if (v === null || v === undefined || !isFinite(v)) return '0.00%'; return `${(Number(v||0) * 100).toFixed(2)}%`; };
const handleCheckbox = (masterId, childClass, target) => { if (target.id === masterId) { document.querySelectorAll(`.${childClass}`).forEach(cb => cb.checked = target.checked); } else if (target.classList.contains(childClass)) { document.getElementById(masterId).checked = [...document.querySelectorAll(`.${childClass}`)].every(cb => cb.checked); } };


// --- KHỞI TẠO VÀ QUẢN LÝ TAB ---
document.addEventListener('DOMContentLoaded', () => {
    addEventListeners(); // Gắn sự kiện cho Tab 1
    addTab2EventListeners(); // Gắn sự kiện cho Tab 2
    setDefaultDates(); // Đặt ngày mặc định cho cả 2 tab
    fetchAndProcessData(); 
    document.getElementById("defaultOpen").click(); // Mở tab mặc định
});

function openTab(evt, tabName) {
    let i, tabcontent, tablinks;
    tabcontent = document.getElementsByClassName("tab-content");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
    }
    tablinks = document.getElementsByClassName("tab-links");
    for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
    }
    document.getElementById(tabName).style.display = "block";
    evt.currentTarget.className += " active";

    // Khởi tạo tab báo cáo theo ngày khi được chọn
    if (tabName === 'DailyReport') {
        initializeDailyReportTab();
    }
}


// --- LOGIC CHO TAB 1: BÁO CÁO CHI TIẾT ---

function getUrlParameter(name) {
    return new URLSearchParams(window.location.search).get(name);
}

function setDefaultDates() {
    const today = new Date();
    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    const formatDateForInput = (date) => date.toISOString().split('T')[0];

    // Đặt ngày cho Tab 1
    document.getElementById('start-date').value = formatDateForInput(firstDay);
    document.getElementById('end-date').value = formatDateForInput(lastDay);
    // Đặt ngày cho Tab 2
    document.getElementById('start-date-tab2').value = formatDateForInput(firstDay);
    document.getElementById('end-date-tab2').value = formatDateForInput(lastDay);
}

function addEventListeners() {
  document.getElementById('DetailedReport').addEventListener('change', (e) => {
    if (e.target.matches('input[type="checkbox"], input[type="date"]')) {
      handleFiltersTab1(e.target);
    }
  });

  document.getElementById('summary-body').addEventListener('click', function(e) {
      const row = e.target.closest('tbody tr');
      if (!row) return;
      const isAlreadySelected = row.classList.contains('row-selected');
      document.querySelectorAll('#summary-body tr.row-selected').forEach(selectedRow => {
          selectedRow.classList.remove('row-selected');
      });
      if (!isAlreadySelected) {
          row.classList.add('row-selected');
      }
  });
}

function fetchAndProcessData() {
    showLoader();
    const salesDataUrl = 'https://script.google.com/macros/s/AKfycbzd8KdWC7PVuv7ttnQLV7oIxmAgWWdLfs3laMDoL7w5GhvCWd_71_Xc33e-GaUSiG_3/exec';
    const employeeDataUrl = 'https://script.google.com/macros/s/AKfycbzwOv7UFwrqzf88QJL1QrxLKcnnnSIQ_PSmF0SO8LboqWI5li3vF3W8_-8s-A8lNGaR/exec';

    Promise.all([
        fetch(salesDataUrl).then(res => res.json()),
        fetch(employeeDataUrl).then(res => res.json())
    ])
    .then(([salesResult, employeeResult]) => {
        employeeData = employeeResult;
        const employeeBranchMap = {};
        employeeData.forEach(emp => {
            const name = (emp.ho_va_ten || '').trim();
            if (name) employeeBranchMap[name] = (emp.chi_nhanh || '').trim();
        });

        rawData = salesResult
            .filter(r => r.ten && String(r.ten).trim() !== '' && r.team && String(r.team).trim() !== '')
            .map(r => ({
                ...r, 
                ten: (r.ten || '').trim(), 
                team: (r.team || '').trim(),
                chiNhanh: employeeBranchMap[(r.ten || '').trim()] || 'Không xác định',
                soMessCmt: +r.soMess || 0,
                soDon: +r.donMess || 0,
                dsChot: +r.doanhSoMess || 0,
                phanHoi: +r.phanHoi || 0,
                ngay: new Date(r.ngay) // Chuyển đổi ngày thành đối tượng Date
            }));

        const idFromUrl = getUrlParameter('id');
        if (idFromUrl) {
            const currentUser = employeeData.find(emp => emp.idnv === idFromUrl);
            if (currentUser) {
                isRestrictedView = true; 
                const cleanName = (currentUser.ho_va_ten || '').trim();
                const restrictedChiNhanh = (currentUser.chi_nhanh || '').trim();
                
                if (currentUser.vi_tri === "Leader") {
                    document.getElementById('report-title').textContent = `DỮ LIỆU CHI NHÁNH ${restrictedChiNhanh}`;
                    allowedNames = employeeData.filter(emp => (emp.chi_nhanh || '').trim() === restrictedChiNhanh).map(emp => (emp.ho_va_ten || '').trim());
                } else {
                    document.getElementById('report-title').textContent = `DỮ LIỆU CÁ NHÂN - ${cleanName}`;
                    allowedNames = [cleanName];
                }
            } else {
                isRestrictedView = true; 
                allowedNames = [];
                alert(`ID "${idFromUrl}" không hợp lệ hoặc không tồn tại.`);
            }
        }
        
        const dataForFilters = isRestrictedView ? rawData.filter(r => allowedNames.includes(r.ten)) : rawData;
        populateAllFilters(dataForFilters); 
        applyFiltersTab1();

    }).catch(err => { 
        console.error("Lỗi khi tải dữ liệu:", err); 
        alert('Không thể tải dữ liệu. Vui lòng kiểm tra lại đường link hoặc kết nối mạng.'); 
    }).finally(() => {
        hideLoader();
    });
}

function populateAllFilters(data) {
    const populate = (key, containerId, className, containerIdTab2) => {
        const container = document.getElementById(containerId);
        const containerTab2 = document.getElementById(containerIdTab2);
        const uniqueValues = [...new Set(data.map(r => r[key]).filter(val => val !== null && val !== undefined && val !== ''))].sort();
        
        const html = uniqueValues.map(val => `<label><input type='checkbox' class='${className}' value='${val}' checked> ${val}</label>`).join('');
        if(container) container.innerHTML = html;
        if(containerTab2) containerTab2.innerHTML = html.replace(new RegExp(className, 'g'), className + '-tab2'); // Tạo class riêng cho Tab 2
    };
    
    populate('sanPham', 'product-options', 'filter-product', 'product-options-tab2');
    populate('thiTruong', 'market-options', 'filter-market', 'market-options-tab2');
    populate('ca', 'ca-options', 'filter-ca');
    populate('team', 'team-options', 'filter-team');
}

function getFilteredDataTab1() {
    const sdVal = document.getElementById('start-date').value;
    const edVal = document.getElementById('end-date').value;
    const sd = sdVal ? new Date(sdVal + 'T00:00:00') : null; 
    const ed = edVal ? new Date(edVal + 'T23:59:59') : null;

    const getSelected = (allId, cbClass) => !document.getElementById(allId).checked ? [...document.querySelectorAll(`.${cbClass}:checked`)].map(cb => cb.value) : null;
    const selP = getSelected('product-all', 'filter-product');
    const selM = getSelected('market-all', 'filter-market');
    const selCa = getSelected('ca-all', 'filter-ca');
    const selT = getSelected('team-all', 'filter-team');

    return rawData.filter(r => {
        if (isRestrictedView && !allowedNames.includes(r.ten)) return false;
        
        const isDateOk = (!sd || r.ngay >= sd) && (!ed || r.ngay <= ed);
        const isProductOk = !selP || selP.includes(r.sanPham);
        const isMarketOk = !selM || selM.includes(r.thiTruong);
        const isCaOk = !selCa || selCa.includes(String(r.ca));
        const isTeamOk = !selT || selT.includes(String(r.team));
        
        return isDateOk && isProductOk && isMarketOk && isCaOk && isTeamOk;
    });
}

function handleFiltersTab1(target) { 
    showLoader(); 
    setTimeout(() => { 
        handleCheckbox('product-all', 'filter-product', target); 
        handleCheckbox('ca-all', 'filter-ca', target); 
        handleCheckbox('team-all', 'filter-team', target); 
        handleCheckbox('market-all', 'filter-market', target); 
        applyFiltersTab1(); 
        hideLoader(); 
    }, 10); 
}

function applyFiltersTab1() {
    const filtered = getFilteredDataTab1();
    renderSummary(filtered); 
    renderDailyBreakdown(filtered);
}

function renderSummary(data) {
    const summaryData = {};
    data.forEach(r => {
        if (!summaryData[r.ten]) summaryData[r.ten] = { chiNhanh: r.chiNhanh, team: r.team, mess: 0, don: 0, chot: 0, phanHoi: 0 };
        summaryData[r.ten].mess += r.soMessCmt;
        summaryData[r.ten].don += r.soDon;
        summaryData[r.ten].chot += r.dsChot;
        summaryData[r.ten].phanHoi += r.phanHoi;
    });

    const flatList = Object.keys(summaryData).map(name => ({ name, chiNhanh: summaryData[name].chiNhanh, team: summaryData[name].team, data: summaryData[name] }))
        .sort((a, b) => b.data.chot - a.data.chot || a.name.localeCompare(b.name));
    
    document.getElementById('summary-body').innerHTML = flatList.map((item, index) => {
        const s = item.data, rate = s.mess ? s.don / s.mess : 0;
        const rateClass = rate >= 0.1 ? 'bg-green' : (rate > 0.05 ? 'bg-yellow' : '');
        let rowClass = index < 3 ? `top-${index + 1}` : '';
        return `<tr class="${rowClass}">
            <td class="text-center">${index + 1}</td> <td class="text-left">${item.chiNhanh}</td> <td class="text-left">${item.team}</td> <td class="text-left">${item.name}</td>
            <td>${formatNumber(s.mess)}</td> <td>${formatNumber(s.don)}</td> <td>${formatNumber(s.phanHoi)}</td> <td>${formatCurrency(s.chot)}</td> <td class="${rateClass}">${formatPercent(rate)}</td>
        </tr>`;
    }).join('');
    
    const total = flatList.reduce((acc, item) => ({ mess: acc.mess + item.data.mess, don: acc.don + item.data.don, chot: acc.chot + item.data.chot, phanHoi: acc.phanHoi + item.data.phanHoi }), { mess: 0, don: 0, chot: 0, phanHoi: 0 });
    document.getElementById('summary-foot').innerHTML = `<tr class="total-row">
        <td class="total-label" colspan="4">TỔNG CỘNG</td> <td class="total-value">${formatNumber(total.mess)}</td> <td class="total-value">${formatNumber(total.don)}</td>
        <td class="total-value">${formatNumber(total.phanHoi)}</td> <td class="total-value">${formatCurrency(total.chot)}</td> <td class="total-value">${formatPercent(total.mess ? total.don / total.mess : 0)}</td>
    </tr>`;
}

function renderDailyBreakdown(data) { 
    const container = document.getElementById('daily-breakdown'); 
    if (data.length === 0) { container.innerHTML = '<h3>Không có dữ liệu chi tiết để hiển thị.</h3>'; return; }
    
    const groupedByDate = {};
    data.forEach(r => { (groupedByDate[formatDate(r.ngay)] = groupedByDate[formatDate(r.ngay)] || []).push(r); });
    
    container.innerHTML = Object.keys(groupedByDate).sort((a,b) => new Date(b.split('/').reverse().join('-')) - new Date(a.split('/').reverse().join('-'))).map(date => {
        let total = { mess: 0, don: 0, chot: 0, phanHoi: 0 };
        const rowsHtml = groupedByDate[date].sort((a, b) => a.ten.localeCompare(b.ten) || b.dsChot - a.dsChot).map(r => {
            total.mess += r.soMessCmt; total.don += r.soDon; total.chot += r.dsChot; total.phanHoi += r.phanHoi;
            return`<tr>
                <td class="text-left">${r.ten}</td> <td class="text-left">${r.chiNhanh}</td> <td class="text-left">${r.ca}</td>
                <td class="text-left">${r.sanPham}</td> <td class="text-left">${r.thiTruong}</td>
                <td>${formatNumber(r.soMessCmt)}</td> <td>${formatNumber(r.soDon)}</td> <td>${formatNumber(r.phanHoi)}</td> <td>${formatCurrency(r.dsChot)}</td> <td class="text-left">${r.team}</td>
            </tr>`;
        }).join('');
        
        const footHtml=`<tr class='total-row'>
            <td colspan='5' class='total-label'>Tổng</td> <td class='total-value'>${formatNumber(total.mess)}</td>
            <td class='total-value'>${formatNumber(total.don)}</td> <td class='total-value'>${formatNumber(total.phanHoi)}</td> <td class='total-value'>${formatCurrency(total.chot)}</td> <td></td>
        </tr>`;
        
        return `<h3>Chi tiết ngày: ${date}</h3><div class="table-responsive-container"><table><thead><tr>
            <th>Tên</th><th>Chi nhánh</th><th>Ca</th><th>Sản phẩm</th><th>Thị trường</th>
            <th>Mess</th><th>Đơn</th><th>Phản hồi</th><th>DS Chốt</th><th>Team</th>
        </tr></thead><tbody>${rowsHtml}</tbody><tfoot>${footHtml}</tfoot></table></div>`;
    }).join('');
}


// --- LOGIC CHO TAB 2: BÁO CÁO THEO NGÀY ---

function addTab2EventListeners() {
    const modal = document.getElementById('daily-detail-modal');
    const closeBtn = document.querySelector('.close-button');
    
    closeBtn.onclick = () => { modal.style.display = "none"; };
    window.onclick = (event) => { if (event.target == modal) { modal.style.display = "none"; } };

    document.getElementById('date-summary-body').addEventListener('click', (e) => {
        const row = e.target.closest('tr');
        if (row) showDailyDetailModal(row.cells[0].textContent.trim());
    });

    document.getElementById('modal-summary-table').querySelector('thead').addEventListener('click', (e) => {
        const th = e.target.closest('th');
        if (th && th.cellIndex !== 0) sortModalTable(th.cellIndex);
    });
    
    document.getElementById('DailyReport').addEventListener('change', (e) => {
        if (e.target.matches('input[type="checkbox"], input[type="date"]')) {
            handleTab2Filters(e.target);
        }
    });
}

function initializeDailyReportTab() {
    if (!charts.dsChotChart) initAllCharts();
    applyDailyFilters();
}

function handleTab2Filters(target) { 
    showLoader(); 
    setTimeout(() => { 
        if (target.id === 'toggle-all-charts' || target.classList.contains('chart-toggle')) {
            if (target.id === 'toggle-all-charts') document.querySelectorAll('.chart-toggle').forEach(cb => cb.checked = target.checked);
            else document.getElementById('toggle-all-charts').checked = [...document.querySelectorAll('.chart-toggle')].every(cb => cb.checked);
            toggleChartVisibility(); 
        } else {
            handleCheckbox('product-all-tab2', 'filter-product-tab2', target); 
            handleCheckbox('market-all-tab2', 'filter-market-tab2', target); 
            applyDailyFilters();
        }
        hideLoader();
    }, 10); 
}

function getFilteredDataTab2() {
    const sdVal = document.getElementById('start-date-tab2').value;
    const edVal = document.getElementById('end-date-tab2').value;
    const sd = sdVal ? new Date(sdVal + 'T00:00:00') : null;
    const ed = edVal ? new Date(edVal + 'T23:59:59') : null;

    const getSelected = (allId, cbClass) => !document.getElementById(allId).checked ? [...document.querySelectorAll(`.${cbClass}:checked`)].map(cb => cb.value) : null;
    const selP = getSelected('product-all-tab2', 'filter-product-tab2');
    const selM = getSelected('market-all-tab2', 'filter-market-tab2');

    return rawData.filter(r => {
        if (isRestrictedView && !allowedNames.includes(r.ten)) return false;
        const isDateOk = (!sd || r.ngay >= sd) && (!ed || r.ngay <= ed);
        const isProductOk = !selP || selP.includes(r.sanPham);
        const isMarketOk = !selM || selM.includes(r.thiTruong);
        return isDateOk && isProductOk && isMarketOk;
    });
}

function applyDailyFilters() { 
    if (!rawData.length) return; 
    const filtered = getFilteredDataTab2(); 
    renderDailyTable(filtered); 
    renderAllDailyCharts(filtered); 
}

function renderDailyTable(data) { 
    const daily = {}; 
    data.forEach(r => { 
        const dateKey = formatDate(r.ngay); 
        if (!daily[dateKey]) daily[dateKey] = { mess: 0, don: 0, chot: 0 }; 
        daily[dateKey].mess += r.soMessCmt; 
        daily[dateKey].don += r.soDon; 
        daily[dateKey].chot += r.dsChot; 
    }); 

    document.getElementById('date-summary-body').innerHTML = Object.keys(daily)
        .sort((a,b) => new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-')))
        .map(d => { 
            const day = daily[d]; 
            const avg = day.mess ? day.don / day.mess : 0; 
            return `<tr>
                      <td class="text-left"><b>${d}</b></td>
                      <td>${formatNumber(day.mess)}</td>
                      <td>${formatNumber(day.don)}</td>
                      <td>${formatCurrency(day.chot)}</td>
                      <td>${formatPercent(avg)}</td>
                    </tr>`; 
        }).join(''); 
}

// --- CÁC HÀM XỬ LÝ MODAL (TAB 2) ---

function showDailyDetailModal(dateString) {
    document.getElementById('modal-title').textContent = `Báo cáo chi tiết ngày ${dateString}`;
    const dataForDay = getFilteredDataTab2().filter(r => formatDate(r.ngay) === dateString);

    // Nhóm dữ liệu theo Tên, Sản phẩm, Thị trường để tránh trùng lặp
    const summaryMap = {};
    dataForDay.forEach(r => {
        const key = `${r.ten}|${r.team}|${r.sanPham}|${r.thiTruong}`;
        if (!summaryMap[key]) {
            summaryMap[key] = {
                name: r.ten, team: r.team, sanPham: r.sanPham, thiTruong: r.thiTruong,
                mess: 0, don: 0, phanHoi: 0, chot: 0
            };
        }
        summaryMap[key].mess += r.soMessCmt;
        summaryMap[key].don += r.soDon;
        summaryMap[key].phanHoi += r.phanHoi;
        summaryMap[key].chot += r.dsChot;
    });
    currentModalSummaryList = Object.values(summaryMap);
    
    modalSortState = { column: 8, direction: 'desc' }; // Sắp xếp theo DS Chốt giảm dần
    sortModalTable(modalSortState.column, true); // Sắp xếp và render
    
    document.getElementById('daily-detail-modal').style.display = 'flex';
}

function renderModalSummaryTable(dataList) {
    let total = { mess: 0, don: 0, phanHoi: 0, chot: 0 };
    const bodyHtml = dataList.map((item, index) => {
        total.mess += item.mess; total.don += item.don; total.phanHoi += item.phanHoi; total.chot += item.chot;
        const rate = item.mess ? item.don / item.mess : 0;
        return `<tr>
            <td class="text-center">${index + 1}</td>
            <td class="text-left">${item.team}</td> <td class="text-left">${item.name}</td>
            <td class="text-left">${item.sanPham || ''}</td> <td class="text-left">${item.thiTruong || ''}</td>
            <td>${formatNumber(item.mess)}</td> <td>${formatNumber(item.don)}</td> <td>${formatNumber(item.phanHoi)}</td>
            <td>${formatCurrency(item.chot)}</td> <td>${formatPercent(rate)}</td>
        </tr>`;
    }).join('');
    
    const totalRate = total.mess ? total.don / total.mess : 0;
    const footHtml = `<tr>
        <td colspan="5" class="total-label">TỔNG CỘNG</td>
        <td class="total-value">${formatNumber(total.mess)}</td> <td class="total-value">${formatNumber(total.don)}</td>
        <td class="total-value">${formatNumber(total.phanHoi)}</td> <td class="total-value">${formatCurrency(total.chot)}</td>
        <td class="total-value">${formatPercent(totalRate)}</td>
    </tr>`;
    
    document.getElementById('modal-summary-body').innerHTML = bodyHtml;
    document.getElementById('modal-summary-foot').innerHTML = footHtml;
    updateSortIcons(modalSortState.column, modalSortState.direction);
}

function sortModalTable(columnIndex, isInitialSort = false) {
    const sortInfo = columnSortKeys[columnIndex];
    if (!sortInfo) return;

    if (!isInitialSort) {
        if (modalSortState.column === columnIndex) {
            modalSortState.direction = modalSortState.direction === 'asc' ? 'desc' : 'asc';
        } else {
            modalSortState.column = columnIndex;
            modalSortState.direction = 'asc';
        }
    }

    currentModalSummaryList.sort((a, b) => {
        const valA = (typeof sortInfo.prop === 'function') ? sortInfo.prop(a) : a[sortInfo.prop];
        const valB = (typeof sortInfo.prop === 'function') ? sortInfo.prop(b) : b[sortInfo.prop];
        
        let comparison = 0;
        if (sortInfo.type === 'string') {
            comparison = String(valA || '').localeCompare(String(valB || ''));
        } else {
            comparison = (valA || 0) - (valB || 0);
        }
        return modalSortState.direction === 'asc' ? comparison : -comparison;
    });
    
    renderModalSummaryTable(currentModalSummaryList);
}

function updateSortIcons(sortedColumnIndex, direction) {
    document.querySelectorAll('#modal-summary-table thead th').forEach((th, index) => {
        const icon = th.querySelector('.sort-icon');
        if (icon) {
            icon.className = 'sort-icon'; th.classList.remove('sorted');
            if (index === sortedColumnIndex) {
                th.classList.add('sorted');
                icon.classList.add(direction);
            }
        }
    });
}

// --- CÁC HÀM XỬ LÝ BIỂU ĐỒ (TAB 2) ---

function toggleChartVisibility() { 
    document.querySelectorAll('.chart-toggle').forEach(cb => { 
        const wrapper = document.querySelector(`.chart-wrapper[data-chart="${cb.dataset.chart}"]`); 
        if(wrapper) wrapper.style.display = cb.checked ? 'block' : 'none';
    }); 
}

function initAllCharts() {
    const createChart = (ctxId, config) => new Chart(document.getElementById(ctxId).getContext('2d'), config);
    charts.messChart = createChart('messChart', getLineChartConfig('Tổng Số Mess', v => formatNumber(v))); 
    charts.donChart = createChart('donChart', getLineChartConfig('Tổng Số Đơn', v => formatNumber(v)));
    charts.dsChotChart = createChart('dsChotChart', getLineChartConfig('DS Chốt (VND)', v => formatCurrency(v))); 
    charts.rateChart = createChart('rateChart', getLineChartConfig('Tỉ lệ chốt (%)', v => formatPercent(v))); 
    charts.productSalesChart = createChart('productSalesChart', getBarChartConfig('DS theo Sản phẩm')); 
    charts.marketSalesChart = createChart('marketSalesChart', getBarChartConfig('DS theo Thị trường'));
    toggleChartVisibility();
}

function renderAllDailyCharts(data) {
    if (!Object.keys(charts).length) return;
    
    const daily = {}; 
    data.forEach(r => { 
        const dateKey = formatDate(r.ngay); 
        if (!daily[dateKey]) daily[dateKey] = { mess: 0, don: 0, chot: 0 }; 
        daily[dateKey].mess += r.soMessCmt; 
        daily[dateKey].don += r.soDon; 
        daily[dateKey].chot += r.dsChot; 
    });
    
    const labels = Object.keys(daily).sort((a,b) => new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-')));
    const colors = getChartColors();
    
    updateChart(charts.messChart, 'Tổng Mess', labels, labels.map(d => daily[d].mess), colors.mess);
    updateChart(charts.donChart, 'Tổng Đơn', labels, labels.map(d => daily[d].don), colors.don);
    updateChart(charts.dsChotChart, 'DS Chốt', labels, labels.map(d => daily[d].chot), colors.dsChot);
    updateChart(charts.rateChart, 'Tỉ lệ chốt', labels, labels.map(d => daily[d].mess ? (daily[d].don / daily[d].mess) : 0), colors.rate);

    const productSales = {}, marketSales = {}; 
    data.forEach(r => { 
        if (r.sanPham) productSales[r.sanPham] = (productSales[r.sanPham] || 0) + r.dsChot; 
        if (r.thiTruong) marketSales[r.thiTruong] = (marketSales[r.thiTruong] || 0) + r.dsChot; 
    });
    const sortedProducts = Object.entries(productSales).sort((a,b) => b[1] - a[1]); 
    const sortedMarkets = Object.entries(marketSales).sort((a,b) => b[1] - a[1]);
    updateChart(charts.productSalesChart, 'DS theo SP', sortedProducts.map(p=>p[0]), sortedProducts.map(p=>p[1]), colors.product, 'bar');
    updateChart(charts.marketSalesChart, 'DS theo TT', sortedMarkets.map(m=>m[0]), sortedMarkets.map(m=>m[1]), colors.market, 'bar');
}

// Các hàm tiện ích và cấu hình cho biểu đồ
function getChartColors() { return { mess: { border: '#FF9800', fill: 'rgba(255, 152, 0, 0.2)' }, don: { border: '#009688', fill: 'rgba(0, 150, 136, 0.2)' }, dsChot: { border: '#4CAF50', fill: 'rgba(76, 175, 80, 0.2)' }, rate: { border: '#F44336', fill: 'rgba(244, 67, 54, 0.2)' }, product: { border: '#607D8B' }, market: { border: '#795548' } }; }
function getLineChartConfig(yTitle, formatter) { Chart.register(ChartDataLabels); return { type: 'line', options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: ${formatter(ctx.raw)}` } }, datalabels: { align: 'top', anchor: 'end', formatter: (v, ctx) => v > 0 ? formatter(v) : '', font: { weight: 'bold', size: 10 }, padding: 4, color: (ctx) => ctx.dataset.borderColor } }, interaction: { intersect: false, mode: 'index' }, scales: { x: { grid: { display: false } }, y: { title: { display: true, text: yTitle }, ticks: { callback: formatter } } }, elements: { line: { tension: 0.3 } } } }; }
function getBarChartConfig(title) { Chart.register(ChartDataLabels); return { type: 'bar', options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { title: { display: true, text: title, font: {size: 16, weight: 'bold'} }, legend: { display: false }, tooltip: { callbacks: { label: (ctx) => formatCurrency(ctx.parsed.x) } }, datalabels: { anchor: 'end', align: 'right', offset: 4, color: '#333', font: { weight: '600' }, formatter: v => Number(v/1000000).toFixed(1) + 'tr' } }, scales: { x: { display: false }, y: { grid: { display: false } } } } }; }
function updateChart(chart, label, labels, data, colors, type = 'line') { chart.data.labels = labels; chart.data.datasets = [{ label, data, backgroundColor: type === 'line' ? colors.fill : colors.border, borderColor: colors.border, type, fill: type === 'line', borderWidth: type === 'line' ? 2 : 1 }]; chart.update('none'); }
</script>
</body>
</html>

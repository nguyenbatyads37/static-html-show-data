<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Báo cáo học tập</title>
  <style>
    :root {
      --primary-color: #a71d2a;
      --secondary-color: #8c1a1a;
      --accent-color: #d62828;
      --light-color: #f8f1f1;
      --success-color: #2a9d8f;
      --warning-color: #e9c46a;
      --danger-color: #e63946;
      --text-color: #333333;
      --text-light: #6c757d;
      --border-radius: 8px;
      --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background-color: #e9ebee;
      color: var(--text-color);
      line-height: 1.6;
      display: flex;
    }

    /* --- GIAO DIỆN MỚI --- */
    .controls-panel {
      width: 280px;
      height: 100vh;
      background-color: #ffffff;
      padding: 25px;
      box-shadow: 2px 0 15px rgba(0, 0, 0, 0.1);
      position: fixed;
      top: 0;
      left: 0;
      z-index: 10;
      display: flex;
      flex-direction: column;
    }

    .controls-panel h2 {
      color: var(--primary-color);
      border-bottom: 2px solid var(--primary-color);
      padding-bottom: 10px;
      margin-bottom: 20px;
    }

    .controls-panel .control-group {
      margin-bottom: 20px;
    }

    .controls-panel label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-color);
    }

    .controls-panel select,
    .controls-panel button {
      width: 100%;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 16px;
    }

    .controls-panel select:disabled {
      background-color: #f5f5f5;
      cursor: not-allowed;
    }

    .controls-panel button {
      background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
      transition: var(--transition);
    }

    .controls-panel button:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }

    .report-wrapper {
      margin-left: 280px; /* Bằng với chiều rộng của panel */
      width: calc(100% - 280px);
      padding: 40px 20px;
      background-color: #f8f1f1;
    }
    
    .placeholder {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100%;
        color: var(--text-light);
        font-size: 1.2rem;
        text-align: center;
    }

    .trf-container {
      width: 100%;
      max-width: 900px;
      margin: 0 auto;
      background-color: white;
      padding: 40px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(167, 29, 42, 0.2);
      display: none; /* Ẩn ban đầu */
    }

    .trf-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 8px;
      background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(167, 29, 42, 0.1);
    }

    .header-left h1 { margin: 0; font-size: 28px; font-weight: 600; color: var(--primary-color); letter-spacing: -0.5px; }
    .header-left p { margin-top: 8px; color: var(--text-light); font-size: 15px; }
    .logo-group img { max-height: 80px; transition: var(--transition); }
    .logo-group:hover img { transform: scale(1.05); }

    .section-title {
      background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 12px 20px;
      font-weight: 500;
      margin: 30px 0 15px 0;
      font-size: 16px;
      border-radius: var(--border-radius);
      letter-spacing: 0.5px;
      box-shadow: 0 2px 8px rgba(167, 29, 42, 0.2);
    }
    
    .chart-container {
        position: relative;
        height: 400px;
        width: 100%;
        max-width: 820px;
        margin: 20px auto 30px;
        padding: 15px;
        border: 1px solid #f0d6d9;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
    }

    .candidate-details, .test-results, .score-table, .data-table { width: 100%; border-collapse: collapse; margin-bottom: 25px; }
    .candidate-details td, .candidate-details th, .test-results td, .test-results th, .score-table td, .score-table th, .data-table td, .data-table th { border: 1px solid #f0d6d9; padding: 12px; }
    .candidate-details th { background-color: #fdf3f4; text-align: left; width: 150px; font-weight: 500; color: var(--secondary-color); }
    .candidate-photo { width: 100px; height: 120px; background: linear-gradient(135deg, #f8f1f1 0%, #f0d6d9 100%); display: inline-block; text-align: center; line-height: 120px; color: var(--text-light); font-size: 14px; border-radius: 4px; position: relative; overflow: hidden; border: 1px solid #f0d6d9; }
    .score-table th, .data-table th { background-color: var(--primary-color); color: white; font-weight: 500; letter-spacing: 0.5px; text-align: center; }
    .score-table td { font-weight: 500; font-size: 16px; text-align: center; }
    .score-table tr:nth-child(even), .data-table tr:nth-child(even) { background-color: #fdf3f4; }
    .stamp-signature { display: flex; justify-content: space-between; margin-top: 50px; align-items: flex-end; }
    .stamp { width: 150px; height: 100px; border: 1px dashed var(--primary-color); text-align: center; line-height: 100px; color: var(--primary-color); border-radius: 4px; background-color: #fdf3f4; font-size: 13px; opacity: 0.8; }
    .signature { width: 200px; border-bottom: 1px solid var(--primary-color); text-align: center; color: var(--primary-color); padding-bottom: 5px; margin-bottom: 5px; }
    .signature::after { content: "Ký tên"; display: block; font-size: 12px; color: var(--primary-color); margin-top: 5px; }
    .center-text { text-align: center; }
    .no-data { text-align: center; color: var(--text-light); font-style: italic; padding: 20px; }
    .report-section { border: 1px solid #f0d6d9; padding: 25px; margin-bottom: 30px; background-color: white; border-radius: var(--border-radius); box-shadow: var(--box-shadow); }
    .report-section h2 { margin-top: 0; margin-bottom: 15px; color: var(--primary-color); font-weight: 600; font-size: 20px; border-bottom: 1px solid #f0d6d9; padding-bottom: 10px; }
    .report-section .item-title { color: var(--primary-color); font-weight: 600; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="controls-panel">
        <h2>Chọn Báo Cáo</h2>
        <div class="control-group">
            <label for="class-select">Chọn Lớp:</label>
            <select id="class-select">
                <option value="">Đang tải danh sách lớp...</option>
            </select>
        </div>
        <div class="control-group">
            <label for="student-select">Chọn Học Sinh:</label>
            <select id="student-select" disabled>
                <option value="">Vui lòng chọn lớp trước</option>
            </select>
        </div>
        <button id="view-report-btn">Xem Báo Cáo</button>
    </div>

    <div class="report-wrapper">
        <div class="placeholder" id="report-placeholder">
            <p>Vui lòng chọn Lớp và Học Sinh từ bảng điều khiển bên trái để xem báo cáo.</p>
        </div>
        <div class="trf-container" id="report-container">
            <div class="header">
                <div class="header-left">
                    <h1>BÁO CÁO KẾT QUẢ HỌC TẬP</h1>
                    <p><strong>Trung tâm khoa bảng - Lớp thầy DR.Henry Đàm trân trọng thông báo!</strong></p>
                </div>
                <div class="logo-group">
                    <img src="https://github.com/nguyenbatyads37/static-html-show-data/blob/main/KHOA%20B%E1%BA%A2NG%201-01.jpg?raw=true" alt="Logo">
                </div>
            </div>

            <div class="section-title">THÔNG TIN HỌC VIÊN</div>
            <table class="candidate-details">
                <tr>
                    <td rowspan="4" style="width: 150px; text-align:center;">
                    <div class="candidate-photo"></div>
                    </td>
                    <th>Họ và tên</th>
                    <td id="student-name">[Tên học sinh]</td>
                </tr>
                <tr>
                    <th>Lớp</th>
                    <td id="student-class">[Tên lớp]</td>
                </tr>
                <tr>
                    <th>Xếp hạng</th>
                    <td id="student-id">[Chưa có]</td>
                </tr>
                <tr>
                    <th>Ngày báo cáo</th>
                    <td id="report-date">[Ngày báo cáo]</td>
                </tr>
            </table>

            <table class="score-table">
                <tr>
                    <th>Chuyên cần TB</th>
                    <th>Điểm KT TB</th>
                    <th>Điểm BTVN TB</th>
                    <th>% Tích lũy</th>
                </tr>
                <tr>
                    <td id="attendance">[Chưa có]</td>
                    <td id="test-score">[Chưa có]</td>
                    <td id="homework">[Chưa có]</td>
                    <td id="stars">[Chưa có]</td>
                </tr>
            </table>

            <div class="section-title">CHI TIẾT HỌC TẬP</div>
            <table class="data-table">
                <thead>
                    <tr>
                    <th style="width: 50px;">STT</th>
                    <th>Ngày</th>
                    <th>Chuyên cần</th>
                    <th>Điểm TB kiểm tra ngày</th>
                    <th>Trạng thái</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr class="no-data-row">
                    <td colspan="5" class="no-data">Không có dữ liệu học tập</td>
                    </tr>
                </tbody>
            </table>

            <div class="section-title">ĐIỂM KIỂM TRA CÁC NGÀY</div>
            <table class="data-table">
                <thead>
                    <tr>
                    <th style="width: 50px;">STT</th>
                    <th>Ngày kiểm tra</th>
                    <th>Tên Bài Kiểm Tra</th>
                    <th>Điểm</th>
                    </tr>
                </thead>
                <tbody id="testScoreBody">
                    <tr class="no-data-row">
                    <td colspan="4" class="no-data">Không có dữ liệu điểm kiểm tra</td>
                    </tr>
                </tbody>
            </table>

            <div class="section-title">BIỂU ĐỒ TIẾN BỘ HỌC TẬP</div>
            <div class="chart-container">
                <canvas id="progressChart"></canvas>
            </div>

            <div class="report-section">
                <h2>BÁO CÁO TỔNG KẾT</h2>
                <div id="comment">
                    <p><i>(Dữ liệu nhận xét tổng kết không có trong nguồn dữ liệu Web App)</i></p>
                </div>
            </div>
            
            <div class="stamp-signature">
                <div class="stamp">CON DẤU</div>
                <div class="signature">NGƯỜI LẬP BÁO CÁO</div>
            </div>
        </div>
    </div>
  <script>
    // Biến toàn cục để lưu trữ toàn bộ dữ liệu
    let allStudentData = [];

    function normalizeDate(dateStr) {
      if (!dateStr) return '';
      try {
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return dateStr;
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
      } catch (e) {
        return dateStr;
      }
    }

    function drawChart(data) {
      const chartContainer = document.querySelector('.chart-container');
      if (!data || data.length === 0) {
        chartContainer.style.display = 'none';
        return;
      }
      const validData = data.filter(item => item.diem !== null && !isNaN(item.diem));
      if (validData.length === 0) {
        chartContainer.style.display = 'none';
        return;
      }
      
      chartContainer.style.display = 'block';
      const labels = validData.map(item => `${item.ngay} - ${item.tenBaiKiemTra}`);
      const scores = validData.map(item => item.diem);
      
      try {
        const ctx = document.getElementById('progressChart').getContext('2d');
        if (window.myChart instanceof Chart) window.myChart.destroy();
        
        window.myChart = new Chart(ctx, {
          type: 'line',
          data: { labels: labels, datasets: [{ label: 'Điểm bài kiểm tra', data: scores, backgroundColor: 'rgba(214, 40, 40, 0.1)', borderColor: 'rgba(214, 40, 40, 1)', borderWidth: 2, pointBackgroundColor: 'rgba(214, 40, 40, 1)', pointRadius: 5, tension: 0.3, fill: true }] },
          options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label || ''}: ${ctx.parsed.y.toFixed(0)} %` } } },
            scales: { y: { beginAtZero: true, max: 100, title: { display: true, text: 'Điểm số (%)', font: { size: 14, weight: 'bold' } }, ticks: { callback: (val) => val + ' %' } }, x: { title: { display: true, text: 'Ngày kiểm tra', font: { size: 14, weight: 'bold' } } } }
          }
        });
      } catch (e) {
        console.error('Lỗi khi vẽ biểu đồ:', e);
        chartContainer.style.display = 'none';
      }
    }

    function renderReport(studentRecords) {
        document.getElementById('report-placeholder').style.display = 'none';
        document.getElementById('report-container').style.display = 'block';

        const studentName = studentRecords[0]['Tên HS'];
        studentRecords.sort((a, b) => new Date(a['Ngày']) - new Date(b['Ngày']));

        document.getElementById('student-name').textContent = studentName;
        document.getElementById('student-class').textContent = studentRecords[0]['Lớp'] || '[Chưa có]';
        document.getElementById('report-date').textContent = new Date().toLocaleDateString('vi-VN');

        const allTestData = [];
        const dailyLearningData = [];
        let totalAttendanceRaw = 0;
        let attendanceCount = 0;

        studentRecords.forEach(record => {
            const recordDate = normalizeDate(record['Ngày']);
            let dailyScores = [];
            
            for (const key in record) {
                if (!isNaN(key) && record[key] !== "" && record[key] !== "-" && record[key] !== null) {
                    const score = parseFloat(record[key]);
                    if (!isNaN(score)) {
                        const scoreAsPercent = score * 100;
                        allTestData.push({ ngay: recordDate, tenBaiKiemTra: 'Bài ' + key, diem: scoreAsPercent });
                        dailyScores.push(scoreAsPercent);
                    }
                }
            }

            let dailyAvgScore = null;
            if (dailyScores.length > 0) dailyAvgScore = dailyScores.reduce((a, b) => a + b, 0) / dailyScores.length;

            const attendanceRaw = parseFloat(record['Chuyên cần']);
            let attendancePercentText = 'N/A';
            if (!isNaN(attendanceRaw)) {
                totalAttendanceRaw += attendanceRaw;
                attendanceCount++;
                attendancePercentText = (attendanceRaw * 100).toFixed(0) + ' %';
            }

            dailyLearningData.push({ ngay: recordDate, chuyenCan: attendancePercentText, diemTB: dailyAvgScore, trangThai: record['Nhận xét lớp'] || '' });
        });

        document.getElementById('tableBody').innerHTML = dailyLearningData.map((item, index) => `<tr><td class="center-text">${index + 1}</td><td>${item.ngay}</td><td class="center-text">${item.chuyenCan}</td><td class="center-text">${item.diemTB !== null ? item.diemTB.toFixed(0) + ' %' : 'N/A'}</td><td>${item.trangThai}</td></tr>`).join('');
        document.getElementById('testScoreBody').innerHTML = allTestData.map((item, index) => `<tr><td class="center-text">${index + 1}</td><td>${item.ngay}</td><td>${item.tenBaiKiemTra}</td><td class="center-text">${item.diem.toFixed(0)} %</td></tr>`).join('');
        if (attendanceCount > 0) document.getElementById('attendance').textContent = ((totalAttendanceRaw / attendanceCount) * 100).toFixed(0) + ' %';
        if (allTestData.length > 0) document.getElementById('test-score').textContent = (allTestData.reduce((s, i) => s + i.diem, 0) / allTestData.length).toFixed(0) + ' %';
        document.getElementById('homework').textContent = '100 %';
        drawChart(allTestData);
    }
    
    function populateClassSelector() {
        const classSelect = document.getElementById('class-select');
        const uniqueClasses = [...new Set(allStudentData.map(record => record['Lớp']))].sort();
        
        classSelect.innerHTML = '<option value="">-- Chọn một lớp --</option>';
        uniqueClasses.forEach(className => {
            const option = document.createElement('option');
            option.value = className;
            option.textContent = className;
            classSelect.appendChild(option);
        });
    }

    function populateStudentSelector(className) {
        const studentSelect = document.getElementById('student-select');
        if (!className) {
            studentSelect.innerHTML = '<option value="">Vui lòng chọn lớp trước</option>';
            studentSelect.disabled = true;
            return;
        }

        const studentsInClass = allStudentData.filter(record => record['Lớp'] === className);
        const uniqueStudents = [...new Set(studentsInClass.map(record => record['Tên HS']))].sort();

        studentSelect.innerHTML = '<option value="">-- Chọn một học sinh --</option>';
        uniqueStudents.forEach(studentName => {
            const option = document.createElement('option');
            option.value = studentName;
            option.textContent = studentName;
            studentSelect.appendChild(option);
        });
        studentSelect.disabled = false;
    }

    // --- HÀM KHỞI TẠO CHÍNH ---
    function init() {
      const webAppUrl = 'https://script.google.com/macros/s/AKfycbxM_mtnAoNHa_JAgswNnIllHLkWXc8MwIB3juuSn_tpRKq1UoFu6vlUkpR4lrgmuSQ/exec';
      const script = document.createElement('script');
      script.src = `${webAppUrl}?callback=handleDataResponse`; 
      script.onerror = () => document.body.innerHTML = '<h1>Lỗi: Không thể tải dữ liệu từ Google Script.</h1>';
      document.body.appendChild(script);

      document.getElementById('class-select').addEventListener('change', (e) => {
          populateStudentSelector(e.target.value);
      });

      document.getElementById('view-report-btn').addEventListener('click', () => {
          const className = document.getElementById('class-select').value;
          const studentName = document.getElementById('student-select').value;

          if (!className || !studentName) {
              alert('Vui lòng chọn Lớp và Tên Học Sinh.');
              return;
          }

          const studentRecords = allStudentData.filter(record => record['Tên HS'] === studentName && record['Lớp'] === className);
          if (studentRecords.length > 0) {
              renderReport(studentRecords);
          } else {
              alert('Không tìm thấy dữ liệu cho học sinh đã chọn.');
          }
      });
    }

    // Hàm callback toàn cục để nhận dữ liệu từ JSONP
    function handleDataResponse(apiData) {
        if (apiData.ok) {
            allStudentData = apiData.data['Điểm danh'];
            populateClassSelector();
        } else {
            console.error("Lỗi dữ liệu từ API:", apiData);
            document.getElementById('class-select').innerHTML = '<option value="">Lỗi tải dữ liệu</option>';
        }
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Báo cáo học tập</title>
  <style>
    :root {
      --primary-color: #a71d2a;
      --secondary-color: #8c1a1a;
      --accent-color: #d62828;
      --light-color: #f8f1f1;
      --success-color: #2a9d8f;
      --warning-color: #e9c46a;
      --danger-color: #e63946;
      --text-color: #333333;
      --text-light: #6c757d;
      --border-radius: 8px;
      --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      margin: 0;
      padding: 40px 20px;
      background-color: #f8f1f1;
      color: var(--text-color);
      line-height: 1.6;
    }

    .trf-container {
      width: 100%;
      max-width: 900px;
      margin: 0 auto;
      background-color: white;
      padding: 40px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(167, 29, 42, 0.2);
    }

    .trf-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 8px;
      background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(167, 29, 42, 0.1);
    }

    .header-left h1 {
      margin: 0;
      font-size: 28px;
      font-weight: 600;
      color: var(--primary-color);
      letter-spacing: -0.5px;
    }

    .header-left p {
      margin-top: 8px;
      color: var(--text-light);
      font-size: 15px;
    }

    .logo-group img {
      max-height: 80px;
      transition: var(--transition);
    }

    .logo-group:hover img {
      transform: scale(1.05);
    }

    .section-title {
      background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 12px 20px;
      font-weight: 500;
      margin: 30px 0 15px 0;
      font-size: 16px;
      border-radius: var(--border-radius);
      letter-spacing: 0.5px;
      box-shadow: 0 2px 8px rgba(167, 29, 42, 0.2);
    }

    .candidate-details,
    .test-results {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 25px;
    }

    .candidate-details td,
    .candidate-details th,
    .test-results td,
    .test-results th {
      border: 1px solid #f0d6d9;
      padding: 12px;
    }

    .candidate-details th {
      background-color: #fdf3f4;
      text-align: left;
      width: 150px;
      font-weight: 500;
      color: var(--secondary-color);
    }

    .candidate-photo {
      width: 100px;
      height: 120px;
      background: linear-gradient(135deg, #f8f1f1 0%, #f0d6d9 100%);
      display: inline-block;
      margin-bottom: 10px;
      text-align: center;
      line-height: 120px;
      color: var(--text-light);
      font-size: 14px;
      border-radius: 4px;
      box-shadow: inset 0 0 10px rgba(167, 29, 42, 0.05);
      position: relative;
      overflow: hidden;
      border: 1px solid #f0d6d9;
    }

    .candidate-photo::after {
      content: var(--content, "Ảnh học sinh");
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      background: rgba(167, 29, 42, 0.05);
      padding: 3px 0;
      font-size: 12px;
      color: var(--primary-color);
    }

    .score-table {
      border-collapse: collapse;
      width: 100%;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(167, 29, 42, 0.05);
    }

    .score-table th,
    .score-table td {
      border: 1px solid #f0d6d9;
      padding: 12px;
      text-align: center;
    }

    .score-table th {
      background-color: var(--primary-color);
      color: white;
      font-weight: 500;
      letter-spacing: 0.5px;
    }

    .score-table td {
      font-weight: 500;
      font-size: 16px;
    }

    .score-table tr:nth-child(even) {
      background-color: #fdf3f4;
    }

    .stamp-signature {
      display: flex;
      justify-content: space-between;
      margin-top: 50px;
      align-items: flex-end;
    }

    .stamp {
      width: 150px;
      height: 100px;
      border: 1px dashed var(--primary-color);
      text-align: center;
      line-height: 100px;
      color: var(--primary-color);
      border-radius: 4px;
      background-color: #fdf3f4;
      font-size: 13px;
      opacity: 0.8;
    }

    .signature {
      width: 200px;
      border-bottom: 1px solid var(--primary-color);
      text-align: center;
      color: var(--primary-color);
      padding-bottom: 5px;
      margin-bottom: 5px;
    }

    .signature::after {
      content: "Ký tên";
      display: block;
      font-size: 12px;
      color: var(--primary-color);
      margin-top: 5px;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 30px;
      box-shadow: 0 1px 3px rgba(167, 29, 42, 0.05);
    }

    .data-table th,
    .data-table td {
      border: 1px solid #f0d6d9;
      padding: 12px;
      text-align: left;
    }

    .data-table th {
      background-color: var(--primary-color);
      color: white;
      text-align: center;
      font-weight: 500;
      letter-spacing: 0.5px;
    }

    .data-table tr:nth-child(even) {
      background-color: #fdf3f4;
    }

    .center-text {
      text-align: center;
    }

    .data-table td,
    .data-table th {
      white-space: normal;
      overflow-wrap: break-word;
      word-wrap: break-word;
      vertical-align: middle;
    }

    .empty-row {
      display: none;
    }

    .no-data {
      text-align: center;
      color: var(--text-light);
      font-style: italic;
      padding: 20px;
    }

    #progressChart {
      margin: 20px 0 30px;
      background-color: white;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      border: 1px solid #f0d6d9;
      width: 100%;
      max-width: 800px;
      height: 400px;
    }

    .report-section {
      border: 1px solid #f0d6d9;
      padding: 25px;
      margin-bottom: 30px;
      background-color: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      position: relative;
    }

    .report-section h2 {
      margin-top: 0;
      margin-bottom: 15px;
      color: var(--primary-color);
      font-weight: 600;
      font-size: 20px;
      border-bottom: 1px solid #f0d6d9;
      padding-bottom: 10px;
    }

    .report-section .item-title {
      color: var(--primary-color);
      font-weight: 600;
    }

    .comment-stamp {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-15deg);
      opacity: 0.4;
      z-index: 100;
      pointer-events: none;
    }

    .comment-stamp img {
      width: 390px;
      height: auto;
      filter: sepia(0.3) brightness(1.1);
    }

    .data-table tr:hover {
      background-color: #f9e3e5;
    }

    .score-excellent {
      color: var(--success-color);
      font-weight: 600;
    }

    .score-good {
      color: #2a9d8f;
    }

    .score-average {
      color: var(--warning-color);
    }

    .score-poor {
      color: var(--danger-color);
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .trf-container {
      animation: fadeIn 0.5s ease-out;
    }

    .section-title {
      animation: fadeIn 0.6s ease-out;
    }

    @media (max-width: 768px) {
      .trf-container { padding: 25px; }
      .header { flex-direction: column; text-align: center; }
      .logo-group { margin-top: 20px; }
      .header-left h1 { font-size: 24px; }
      .stamp-signature { flex-direction: column; align-items: center; gap: 20px; }
      .candidate-details td:first-child { display: none; }
    }
    @media print {
      @page { size: A4; margin: 0; }
      body { background-color: white !important; padding: 40px 20px !important; margin: 0 !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
      .trf-container { width: 100% !important; max-width: 900px !important; margin: 0 auto !important; padding: 40px !important; border: 1px solid rgba(167, 29, 42, 0.2) !important; box-shadow: none !important; }
      .trf-container::before { background: linear-gradient(90deg, var(--primary-color), var(--accent-color)) !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
      .section-title { background: linear-gradient(to right, var(--primary-color), var(--secondary-color)) !important; color: white !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
      .candidate-details th, .score-table th, .data-table th { background-color: var(--primary-color) !important; color: white !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
      .candidate-details th { background-color: #fdf3f4 !important; color: var(--secondary-color) !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
      .score-table tr:nth-child(even), .data-table tr:nth-child(even) { background-color: #fdf3f4 !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
      .comment-stamp { opacity: 0.4 !important; }
      .no-print { display: none !important; }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="trf-container">
    <div class="header">
      <div class="header-left">
        <h1>BÁO CÁO KẾT QUẢ HỌC TẬP</h1>
        <p><strong>Trung tâm khoa bảng - Lớp thầy DR.Henry Đàm trân trọng thông báo!</strong></p>
      </div>
      <div class="logo-group">
        <img
          src="https://github.com/nguyenbatyads37/static-html-show-data/blob/main/KHOA%20B%E1%BA%A2NG%201-01.jpg?raw=true"
          alt="Logo">
      </div>
    </div>

    <div class="section-title">THÔNG TIN HỌC VIÊN</div>
    <table class="candidate-details">
      <tr>
        <td rowspan="4" style="width: 150px; text-align:center;">
          <div class="candidate-photo"></div>
        </td>
        <th>Họ và tên</th>
        <td id="student-name">[Tên học sinh]</td>
      </tr>
      <tr>
        <th>Lớp</th>
        <td id="student-class">[Tên lớp]</td>
      </tr>
      <tr>
        <th>Xếp hạng</th>
        <td id="student-id">[Chưa có]</td>
      </tr>
      <tr>
        <th>Ngày báo cáo</th>
        <td id="report-date">[Ngày báo cáo]</td>
      </tr>
    </table>

    <table class="score-table">
      <tr>
        <th>Chuyên cần</th>
        <th>Điểm kiểm tra</th>
        <th>Điểm BTVN</th>
        <th>% Tích lũy</th>
      </tr>
      <tr>
        <td id="attendance">[Chưa có]</td>
        <td id="test-score">[Chưa có]</td>
        <td id="homework">[Chưa có]</td>
        <td id="stars">[Chưa có]</td>
      </tr>
    </table>

    <div class="section-title">CHI TIẾT HỌC TẬP</div>
    <table class="data-table">
      <thead>
        <tr>
          <th style="width: 50px;">STT</th>
          <th>Ngày</th>
          <th>Chuyên cần</th>
          <th>Điểm TB kiểm tra ngày</th>
          <th>Trạng thái</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        <tr class="no-data-row">
          <td colspan="5" class="no-data">Không có dữ liệu học tập</td>
        </tr>
      </tbody>
    </table>

    <div class="section-title">ĐIỂM KIỂM TRA CÁC NGÀY</div>
    <table class="data-table">
      <thead>
        <tr>
          <th style="width: 50px;">STT</th>
          <th>Ngày kiểm tra</th>
          <th>Tên Bài Kiểm Tra</th>
          <th>Điểm</th>
        </tr>
      </thead>
      <tbody id="testScoreBody">
        <tr class="no-data-row">
          <td colspan="4" class="no-data">Không có dữ liệu điểm kiểm tra</td>
        </tr>
      </tbody>
    </table>

    <div class="section-title">BIỂU ĐỒ TIẾN BỘ HỌC TẬP</div>
    <canvas id="progressChart" width="800" height="400"></canvas>

    <div class="report-section">
      <h2>BÁO CÁO TỔNG KẾT</h2>
      <div id="comment">
        <p><i>(Dữ liệu nhận xét tổng kết không có trong nguồn dữ liệu Web App)</i></p>
      </div>
    </div>
    
    <div class="comment-stamp" id="commentStamp" style="display:none;">
      <img src="" alt="Con dấu">
    </div>

    <div class="stamp-signature">
      <div class="stamp">CON DẤU</div>
      <div class="signature">NGƯỜI LẬP BÁO CÁO</div>
    </div>
  </div>
  <script>
    function normalizeDate(dateStr) {
      if (!dateStr) return '';
      try {
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return dateStr;
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
      } catch (e) {
        return dateStr;
      }
    }

    function drawChart(data) {
      const chartElement = document.getElementById('progressChart');
      if (!data || data.length === 0) {
        chartElement.style.display = 'none';
        return;
      }
      const validData = data.filter(item => item.diem !== null && !isNaN(item.diem));
      if (validData.length === 0) {
        chartElement.style.display = 'none';
        return;
      }
      
      chartElement.style.display = 'block';
      const labels = validData.map(item => [item.ngay, item.tenBaiKiemTra]);
      const scores = validData.map(item => item.diem);
      
      try {
        const ctx = chartElement.getContext('2d');
        if (window.myChart instanceof Chart) window.myChart.destroy();
        
        window.myChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'Điểm bài kiểm tra',
              data: scores,
              backgroundColor: 'rgba(214, 40, 40, 0.1)',
              borderColor: 'rgba(214, 40, 40, 1)',
              borderWidth: 2,
              pointBackgroundColor: 'rgba(214, 40, 40, 1)',
              pointRadius: 5,
              tension: 0.3,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: { beginAtZero: true, max: 10, title: { display: true, text: 'Điểm số', font: { size: 14, weight: 'bold' } } },
              x: { title: { display: true, text: 'Ngày kiểm tra', font: { size: 14, weight: 'bold' } } }
            }
          }
        });
      } catch (e) {
        console.error('Lỗi khi vẽ biểu đồ:', e);
        chartElement.style.display = 'none';
      }
    }

    function init() {
      const params = new URLSearchParams(window.location.search);
      const studentName = params.get('name');
      
      if (!studentName) {
          document.body.innerHTML = `
            <div style="text-align: center; padding: 50px; font-family: sans-serif;">
              <h1>Lỗi: Không tìm thấy tên học sinh.</h1>
              <p>Vui lòng thêm <strong>?name=TênHọcSinh</strong> vào cuối địa chỉ URL.</p>
              <p>Ví dụ: .../report.html?name=Lê Thế Long</p>
            </div>`;
          return;
      }

      const webAppUrl = 'https://script.google.com/a/macros/nashimart.io.vn/s/AKfycby5NgcQIiC-zG6DyI8XuFuMWmhevZTk7vATAKnSXrjn9placXBAnShP3KcQyo9dH29FIg/exec';

      fetch(webAppUrl)
        .then(response => {
          if (!response.ok) throw new Error('Network response was not ok');
          return response.json();
        })
        .then(apiData => {
          if (!apiData.ok || !apiData.data || !apiData.data['Điểm danh']) {
            throw new Error("Dữ liệu không hợp lệ từ API Google Script");
          }
          
          const allRecords = apiData.data['Điểm danh'];
          const studentRecords = allRecords.filter(record => record['Tên HS'] === studentName);

          if (studentRecords.length === 0) {
            document.body.innerHTML = `
            <div style="text-align: center; padding: 50px; font-family: sans-serif;">
              <h1>Không tìm thấy dữ liệu cho học sinh: ${studentName}</h1>
              <p>Vui lòng kiểm tra lại tên trên URL.</p>
            </div>`;
            return;
          }
          
          // Sắp xếp các bản ghi theo ngày
          studentRecords.sort((a, b) => new Date(a['Ngày']) - new Date(b['Ngày']));

          // --- 1. Điền thông tin cơ bản ---
          document.getElementById('student-name').textContent = studentName;
          document.getElementById('student-class').textContent = studentRecords[0]['Lớp'] || '[Chưa có]';
          document.getElementById('report-date').textContent = new Date().toLocaleDateString('vi-VN');

          // --- 2. Xử lý dữ liệu cho các bảng và biểu đồ ---
          const allTestData = [];
          const dailyLearningData = [];
          let totalAttendance = 0;
          let attendanceCount = 0;

          studentRecords.forEach(record => {
            const recordDate = normalizeDate(record['Ngày']);
            let dailyScores = [];
            
            // Lấy điểm kiểm tra chi tiết
            for (const key in record) {
              if (!isNaN(key) && record[key] !== "" && record[key] !== "-" && record[key] !== null) {
                const score = parseFloat(record[key]);
                allTestData.push({
                  ngay: recordDate,
                  tenBaiKiemTra: 'Bài ' + key,
                  diem: score
                });
                dailyScores.push(score);
              }
            }

            // Tính điểm trung bình của ngày đó
            let dailyAvgScore = null;
            if (dailyScores.length > 0) {
                const sum = dailyScores.reduce((a, b) => a + b, 0);
                dailyAvgScore = (sum / dailyScores.length).toFixed(2);
            }

            // Thêm vào bảng chi tiết học tập
            dailyLearningData.push({
                ngay: recordDate,
                chuyenCan: record['Chuyên cần'] || 'N/A',
                diemTB: dailyAvgScore,
                trangThai: record['Nhận xét lớp'] || ''
            });
            
            // Tính tổng chuyên cần
            const attendance = parseFloat(record['Chuyên cần']);
            if(!isNaN(attendance)) {
                totalAttendance += attendance;
                attendanceCount++;
            }
          });

          // --- 3. Hiển thị dữ liệu lên các bảng ---
          // Bảng chi tiết học tập
          const tableBody = document.getElementById('tableBody');
          tableBody.innerHTML = dailyLearningData.map((item, index) => `
            <tr>
              <td class="center-text">${index + 1}</td>
              <td>${item.ngay}</td>
              <td class="center-text">${item.chuyenCan}</td>
              <td class="center-text">${item.diemTB !== null ? item.diemTB : 'N/A'}</td>
              <td>${item.trangThai}</td>
            </tr>
          `).join('');
          
          // Bảng điểm kiểm tra chi tiết
          const testScoreBody = document.getElementById('testScoreBody');
          testScoreBody.innerHTML = allTestData.map((item, index) => `
            <tr>
              <td class="center-text">${index + 1}</td>
              <td>${item.ngay}</td>
              <td>${item.tenBaiKiemTra}</td>
              <td class="center-text">${item.diem}</td>
            </tr>
          `).join('');

          // --- 4. Tính toán và hiển thị điểm tổng hợp ---
          if (attendanceCount > 0) {
              document.getElementById('attendance').textContent = (totalAttendance / attendanceCount).toFixed(2);
          }
          if (allTestData.length > 0) {
              const totalScore = allTestData.reduce((sum, item) => sum + item.diem, 0);
              document.getElementById('test-score').textContent = (totalScore / allTestData.length).toFixed(2);
          }

          // --- 5. Vẽ biểu đồ ---
          drawChart(allTestData);
        })
        .catch(error => {
          console.error('Lỗi khi lấy hoặc xử lý dữ liệu:', error);
          document.body.innerHTML = `
            <div style="text-align: center; padding: 50px; font-family: sans-serif;">
              <h1>Đã xảy ra lỗi khi tải dữ liệu từ Web App.</h1>
              <p>Vui lòng kiểm tra lại đường dẫn Web App và thử lại sau.</p>
              <p><i>Chi tiết lỗi: ${error.message}</i></p>
            </div>`;
        });
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>B√°o c√°o t·ªïng h·ª£p</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    /* --- C√ÄI ƒê·∫∂T CHUNG & TABS - T√îNG M√ÄU XANH L√Å C√ÇY --- */
    :root {
        --primary-color: #2d7c2d; /* M√†u xanh l√° c√¢y ƒë·∫≠m ch·ªß ƒë·∫°o */
        --primary-light: #4CAF50; /* M√†u xanh l√° c√¢y s√°ng h∆°n */
        --primary-dark: #1b4b1b;
        --secondary-color: #FFC107;
        --text-dark: #333;
        --text-medium: #555;
        --bg-light: #f4f4f4;
        --border-color: #e0e0e0;
        --font-main: 'Roboto', Arial, sans-serif;
        --gold: #FFD700;
        --silver: #C0C0C0;
        --bronze: #CD7F32;
        --danger-color: #e74c3c;
        --warning-color: #f39c12;
        --info-color: #1abc9c;
    }
    
    body { 
        font-family: var(--font-main); 
        padding: 20px; 
        background-color: var(--bg-light); 
        color: var(--text-dark);
        line-height: 1.6;
    }
    
    .tab-container { 
        overflow: hidden; 
        border-bottom: 2px solid var(--border-color); 
        margin-bottom: 30px; 
        background-color: #fff;
        padding: 0 10px;
        border-radius: 8px 8px 0 0;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .tab-container button {
      background-color: transparent; float: left; border: none; outline: none; cursor: pointer;
      padding: 14px 20px; transition: all 0.3s ease; font-size: 17px; font-weight: 500;
      color: var(--text-medium); border-bottom: 3px solid transparent; margin-right: 5px;
    }
    .tab-container button:hover { background-color: #f9f9f9; color: var(--primary-dark); }
    .tab-container button.active { color: var(--primary-color); font-weight: 700; border-bottom-color: var(--primary-color); }
    .tab-content { display: none; padding: 6px 12px; border-top: none; animation: fadeIn 0.5s; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* --- STYLES CHUNG CHO B·∫¢NG & CƒÇN L·ªÄ --- */
    .table-responsive-container { overflow-x: auto; margin-bottom: 25px; }
    table { 
        width: 100%; border-collapse: collapse; table-layout: auto; 
        margin-top: 20px; background: #fff; border-radius: 8px; overflow: hidden; 
        box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    }
    th, td { border: 1px solid var(--border-color); padding: 12px 15px; white-space: nowrap; vertical-align: middle; }
    
    th { text-align: center !important; font-weight: 500; }
    td { text-align: right !important; }
    .text-left { text-align: left !important; }
    .text-center { text-align: center !important; }

    tbody tr { transition: all 0.25s ease-in-out; }
    tbody tr:not(.total-row):not(.row-selected):not(.highlight):hover { transform: translateY(-2px) scale(1.005); box-shadow: 0 8px 20px rgba(0,0,0,0.08); z-index: 10; background-color: #fcfcfc; }
    tbody tr:nth-child(even) { background-color: #f9f9f9; }
    
    tr.total-row { background: #e8f5e9 !important; font-weight: 700; font-size: 1.05em; color: var(--text-dark) !important; border-top: 3px solid var(--primary-color); }
    tr.total-row, tr.total-row:hover { transform: none; box-shadow: none; }
    .total-label { text-align: left !important; }

    .header { display: flex; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); }
    .header img { height: 70px; width: 70px; margin-right: 20px; border-radius: 8px; object-fit: cover; }
    .header h2 { margin: 0; color: var(--primary-color); font-size: 1.8em; font-weight: 700; }
    
    /* === TAB 1, 2, 3: B√ÅO C√ÅO C≈® === */
    .sidebar { flex-shrink: 0; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 15px rgba(0,0,0,0.05); }
    .sidebar h3 { background: var(--primary-color); color: #fff; padding: 12px 15px; margin: 20px 0 10px; border-radius: 6px; font-size: 1.1em; }
    .sidebar label { display: block; margin: 12px 0; font-size: 0.95em; color: var(--text-medium); }
    .sidebar .indent { margin-left: 20px; }
    .sidebar input[type="date"] { width: 100%; box-sizing: border-box; padding: 10px 12px; margin: 6px 0 12px; border: 1px solid var(--border-color); border-radius: 6px; }
    #CostReport .report-container, #ChartReport .report-container { display: flex; gap: 20px; }
    #CostReport .sidebar, #ChartReport .sidebar { width: 260px; }
    #CostReport .main-detailed, #ChartReport .main-detailed { flex-grow: 1; }
    #CostReport th.green-header, #ChartReport th.green-header, #SaleReport th { background: var(--primary-light); color: white; }
    #CostReport th.yellow-header, #ChartReport th.yellow-header { background: var(--secondary-color); color: var(--text-dark); }
    .daily-breakdown h3 { margin-top: 30px; background: #f0f0f0; padding: 10px; border-left: 5px solid var(--primary-color); border-radius: 4px; }
    #ChartReport .charts-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    #ChartReport .chart-wrapper { background: #fff; padding: 15px; border-radius: 12px; box-shadow: 0 6px 12px rgba(0,0,0,0.1); }
    #ChartReport .chart-wrapper canvas { width: 100% !important; height: 400px !important; }
    #ChartReport .chart-toggle-controls { margin: 20px 0; padding: 10px; background: #eee; border-radius: 8px; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }
    #SaleReport .report-container { display: flex; flex-wrap: nowrap; gap: 20px; align-items: flex-start; max-width: 1800px; margin: 0 auto; }
    #SaleReport tbody tr { cursor: pointer; }
    #SaleReport tbody tr.row-selected, #SaleReport tbody tr.row-selected:hover { background-color: #FFF59D !important; color: var(--text-dark) !important; font-weight: 600; }
    @media (max-width: 1200px) { #SaleReport .report-container { flex-direction: column; } #SaleReport .sidebar, #SaleReport .main-detailed { width: 100%; position: static; max-height: none; } }
    
    /* === TAB 4: B√ÅO C√ÅO HI·ªÜU QU·∫¢ MKT (M·ªöI) === */
    #MktReport .report-header { text-align: center; margin-bottom: 20px; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    #MktReport .report-title { font-size: 22px; font-weight: 700; color: var(--text-dark); margin-bottom: 5px; }
    #MktReport .report-date { color: var(--text-medium); font-size: 16px; }
    #MktReport .filter-container { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 20px; padding: 15px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); align-items: center; }
    #MktReport .filter-group { display: flex; align-items: center; gap: 10px; }
    #MktReport label { font-weight: 500; color: var(--text-dark); }
    #MktReport input[type="date"], #MktReport select { padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 4px; font-family: inherit; background-color: #fff; }
    #MktReport button { background-color: var(--primary-color); color: white; border: none; cursor: pointer; font-weight: 600; transition: background-color 0.2s; padding: 8px 15px; border-radius: 4px; }
    #MktReport button:hover { background-color: var(--primary-dark); }
    #MktReport th { background-color: var(--primary-light); color: white; }
    #MktReport .highlight { background-color: #e8f5e9 !important; font-weight: 600; }
    #MktReport .section-title { font-size: 20px; font-weight: 600; color: var(--primary-dark); margin: 25px 0 15px 0; padding-bottom: 8px; border-bottom: 2px solid var(--primary-color); }
    #MktReport .error-message, #MktReport .loading { color: var(--text-medium); text-align: center; padding: 20px; font-size: 18px; font-weight: 500;}
    @media (max-width: 768px) { #MktReport .filter-container { flex-direction: column; align-items: flex-start; } }

    /* === TAB 5: B√ÅO C√ÅO NH√ÇN S·ª∞ (T√≠ch h·ª£p) === */
    #StaffReport .report-container { display: flex; gap: 25px; }
    #StaffReport .sidebar { flex: 0 0 300px; background: white; border-radius: 8px; padding: 20px; height: fit-content; box-shadow: 0 4px 12px rgba(0,0,0,0.06); }
    #StaffReport .sidebar h3 { font-size: 1.3rem; color: var(--text-dark); margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid var(--primary-color); }
    #StaffReport .sidebar label { font-weight: 500; margin-bottom: 5px; display: block; font-size: 0.95rem; }
    #StaffReport .sidebar input[type="date"], #StaffReport .sidebar select { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 15px; transition: all 0.3s ease; }
    #StaffReport .sidebar input[type="date"]:focus, #StaffReport .sidebar select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(45, 124, 45, 0.2); outline: none; }
    #StaffReport .sidebar button { width: 100%; padding: 12px; background: linear-gradient(90deg, var(--primary-color), var(--primary-light)); color: white; border: none; border-radius: 6px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; margin-top: 10px; }
    #StaffReport .main-detailed { flex: 1; min-width: 0; }
    #StaffReport .header { display: flex; align-items: center; background: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.06); margin-bottom: 25px; }
    #StaffReport h3.report-title { font-size: 1.8rem; font-weight: 600; color: var(--text-dark); margin-bottom: 25px; }
    #StaffReport .section-title { font-size: 1.5rem; color: var(--text-dark); padding-bottom: 10px; margin-bottom: 20px; border-bottom: 2px solid #f0f0f0; }
    #StaffReport .sortable-header { cursor: pointer; user-select: none; position: relative; }
    #StaffReport .sortable-header:hover { background-color: #e8f5e9; }
    #StaffReport .sortable-header::after { content: ' \f0dc'; font-family: 'Font Awesome 6 Free'; font-weight: 900; color: #aaa; opacity: 0.5; position: absolute; right: 8px; }
    #StaffReport .sortable-header.sorted-desc::after { content: ' \f0dd'; opacity: 1; color: var(--primary-color); }
    #StaffReport .sortable-header.sorted-asc::after { content: ' \f0de'; opacity: 1; color: var(--primary-color); }
    #StaffReport .clickable-staff-row:hover { background-color: #e8f5e9; cursor: pointer; }
    #StaffReport .highlighted-row { background-color: var(--primary-color) !important; color: white !important; font-weight: bold; }
    #StaffReport .daily-summary-row { background-color: #f3faf4; font-weight: bold; cursor: pointer; }
    #StaffReport .daily-summary-row:hover { background-color: #e8f5e9; }
    #StaffReport .expand-icon { margin-right: 10px; width: 1em; display: inline-block; transition: transform 0.2s ease-in-out; font-size: 0.8em; }
    #StaffReport .daily-summary-row.expanded .expand-icon { transform: rotate(90deg); }
    #StaffReport .details-container-row { display: none; }
    #StaffReport .details-container-row td { padding: 0 !important; border: 0 !important; }
    #StaffReport .nested-table-container { padding: 15px 20px; background-color: #fdfdfd; border-top: 2px solid var(--primary-color); }
    #StaffReport .chart-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px; }
    #StaffReport .chart-container { background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.06); padding: 20px; }
    #StaffReport .chart-title { font-size: 1.2rem; font-weight: 600; margin-bottom: 15px; color: var(--text-dark); display: flex; align-items: center; }
    #StaffReport .chart-title i { margin-right: 10px; font-size: 1.4rem; color: var(--primary-color); }
    #StaffReport .chart-wrapper { position: relative; height: 300px; width: 100%; }
    #StaffReport #daily-trend-chart-container { height: 400px; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.06); }
    #staff-placeholder { text-align: center; padding: 40px; font-size: 1.2rem; color: var(--text-medium); background: #fff; border-radius: 8px; }
    
    /* --- HI·ªÜU ·ª®NG CHUNG --- */
    .bg-green { background-color: #e8f5e9 !important; color: #2e7d32; }
    .bg-yellow { background-color: #fffde7 !important; color: #f57f17; }
    .top-1, .top-2, .top-3 { font-weight: 700 !important; }
    .top-1 td:first-child::before, .top-2 td:first-child::before, .top-3 td:first-child::before { margin-right: 8px; font-size: 1.1em; }
    .top-1 { background-color: #fffbeb !important; border-left: 5px solid var(--gold); }
    .top-1 td:first-child::before { content: "ü•á"; }
    .top-2 { background-color: #f5f7fa !important; border-left: 5px solid var(--silver); }
    .top-2 td:first-child::before { content: "ü•à"; }
    .top-3 { background-color: #fff5eb !important; border-left: 5px solid var(--bronze); }
    .top-3 td:first-child::before { content: "ü•â"; }
    
    /* --- CH·ªà B√ÅO ƒêANG T·∫¢I (C·∫¨P NH·∫¨T) --- */
    @keyframes pulse {
        0%, 100% { transform: scale(1); opacity: 0.6; }
        50% { transform: scale(1.05); opacity: 0.8; }
    }
    #loading-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255, 255, 255, 0.9); display: flex; justify-content: center; align-items: center;
      z-index: 9999;
      transition: all 0.3s ease; visibility: hidden; opacity: 0; backdrop-filter: blur(4px);
    }
    #loading-overlay.visible { visibility: visible; opacity: 1; }
    .loading-content { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
    .loading-logo { max-width: 200px; width: 40vw; height: auto; animation: pulse 2s infinite ease-in-out; }
    .loading-text { margin-top: 20px; font-size: 1.3em; font-weight: 500; color: var(--primary-color); }
  </style>
</head>
<body>
  
  <div id="loading-overlay">
    <div class="loading-content">
      <img src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Ff930e667.%E1%BA%A2nh.025539.jpg" alt="Loading..." class="loading-logo">
      <div class="loading-text">ƒêang t·∫£i d·ªØ li·ªáu...</div>
    </div>
  </div>

  <div class="tab-container">
    <button class="tablinks" onclick="openTab(event, 'CostReport')" id="defaultOpen">B√°o c√°o chi ph√≠</button>
    <button class="tablinks" onclick="openTab(event, 'SaleReport')">B√°o c√°o Sale</button>
    <button class="tablinks" onclick="openTab(event, 'ChartReport')">B√°o c√°o Bi·ªÉu ƒë·ªì</button>
    <button class="tablinks" onclick="openTab(event, 'MktReport')">B√°o c√°o Hi·ªáu qu·∫£ MKT</button>
    <button class="tablinks" onclick="openTab(event, 'StaffReport')">B√°o c√°o Nh√¢n s·ª±</button>
  </div>
  
  <!-- ======================= TAB 1: B√ÅO C√ÅO CHI PH√ç ======================= -->
  <div id="CostReport" class="tab-content">
     <div class="report-container">
        <div class="sidebar">
          <h3>Ng√†y</h3> <label>T·ª´ ng√†y:<input type="date" id="start-date-tab1"></label> <label>ƒê·∫øn ng√†y:<input type="date" id="end-date-tab1"></label>
          <h3>S·∫£n ph·∫©m</h3> <label><input type="checkbox" id="product-all-tab1" checked> T·∫•t c·∫£</label> <div id="product-options-tab1"></div>
          <h3>Ca</h3> <label><input type="checkbox" id="ca-all-tab1" checked> T·∫•t c·∫£</label> <div id="ca-options-tab1"></div>
          <h3>Team</h3> <label><input type="checkbox" id="team-all-tab1" checked> T·∫•t c·∫£</label> <div id="team-options-tab1"></div>
          <h3>Th·ªã tr∆∞·ªùng</h3> <label><input type="checkbox" id="market-all-tab1" checked> T·∫•t c·∫£</label> <div id="market-options-tab1"></div>
        </div>
        <div class="main-detailed">
          <div class="header"> <img src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Ff930e667.%E1%BA%A2nh.025539.jpg" alt="Logo"> <h2>D·ªÆ LI·ªÜU CHI PH√ç ADS</h2> </div>
          <div class="table-responsive-container">
            <table id="summary-table-cost">
              <thead>
                <tr>
                  <th class="green-header">STT</th> <th class="green-header">Team</th> <th class="green-header">Marketing</th>
                  <th class="green-header">S·ªë Mess</th> <th class="green-header">CPQC</th> <th class="green-header">S·ªë ƒê∆°n</th>
                  <th class="green-header">DS Ch·ªët</th> <th class="yellow-header">T·ªâ l·ªá ch·ªët</th> <th class="yellow-header">Gi√° Mess</th>
                  <th class="yellow-header">CPS</th> <th class="yellow-header">%CP/DS</th> <th class="yellow-header">Gi√° TB ƒê∆°n</th>
                </tr>
              </thead>
              <tbody id="summary-body-cost"></tbody>
              <tfoot id="summary-foot-cost"></tfoot>
            </table>
          </div>
          <div class="table-responsive-container">
            <table id="kpi-summary-table">
                <thead>
                  <tr>
                    <th class="green-header">STT</th><th class="green-header">Team</th><th class="green-header">Marketing</th>
                    <th class="green-header">CPQC</th><th class="green-header">DS Ch·ªët</th><th class="green-header">DS ƒêi</th>
                    <th class="green-header">DS Sau Ship</th><th class="green-header">DS Th√†nh C√¥ng</th>
                    <th class="yellow-header">%CP/DS</th><th class="yellow-header">% KPI</th>
                  </tr>
                </thead>
                <tbody id="kpi-summary-body"></tbody>
                <tfoot id="kpi-summary-foot"></tfoot>
            </table>
          </div>
          <div class="daily-breakdown" id="daily-breakdown-cost"></div>
        </div>
    </div>
  </div>

  <!-- ======================= TAB 2: B√ÅO C√ÅO SALE ======================= -->
  <div id="SaleReport" class="tab-content">
      <div class="report-container">
          <div class="sidebar">
            <h3>B·ªô l·ªçc</h3>
            <label>T·ª´ ng√†y:<input type="date" id="start-date-sale"></label> 
            <label>ƒê·∫øn ng√†y:<input type="date" id="end-date-sale"></label>
            <h3>S·∫£n ph·∫©m</h3> <label><input type="checkbox" id="product-all-sale" checked> T·∫•t c·∫£</label> <div id="product-options-sale" class="indent"></div>
            <h3>Ca</h3> <label><input type="checkbox" id="ca-all-sale" checked> T·∫•t c·∫£</label> <div id="ca-options-sale" class="indent"></div>
            <h3>Team</h3> <label><input type="checkbox" id="team-all-sale" checked> T·∫•t c·∫£</label> <div id="team-options-sale" class="indent"></div>
            <h3>Th·ªã tr∆∞·ªùng</h3> <label><input type="checkbox" id="market-all-sale" checked> T·∫•t c·∫£</label> <div id="market-options-sale" class="indent"></div>
          </div>
          <div class="main-detailed">
            <div class="header"> <img src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Ff930e667.%E1%BA%A2nh.025539.jpg" alt="Logo"> <h2>D·ªÆ LI·ªÜU T·ªîNG H·ª¢P SALE</h2> </div>
            <div class="table-responsive-container">
              <table id="summary-table-sale">
                <thead>
                  <tr><th>STT</th> <th>Team</th> <th>Sale</th> <th>S·ªë Mess</th><th>S·ªë ƒê∆°n</th> <th>Ph·∫£n h·ªìi</th> <th>DS Ch·ªët</th> <th>T·ªâ l·ªá ch·ªët</th></tr>
                </thead>
                <tbody id="summary-body-sale"></tbody>
                <tfoot id="summary-foot-sale"></tfoot>
              </table>
            </div>
            <div class="daily-breakdown" id="daily-breakdown-sale"></div>
          </div>
      </div>
  </div>
    
  <!-- ======================= TAB 3: B√ÅO C√ÅO BI·ªÇU ƒê·ªí ======================= -->
  <div id="ChartReport" class="tab-content">
      <div class="report-container">
        <div class="sidebar">
          <h3>Ng√†y</h3> <label>T·ª´ ng√†y:<input type="date" id="start-date-tab3"></label> <label>ƒê·∫øn ng√†y:<input type="date" id="end-date-tab3"></label>
          <h3>S·∫£n ph·∫©m</h3> <label><input type="checkbox" id="product-all-tab3" checked> T·∫•t c·∫£</label> <div id="product-options-tab3"></div>
          <h3>Th·ªã tr∆∞·ªùng</h3> <label><input type="checkbox" id="market-all-tab3" checked> T·∫•t c·∫£</label> <div id="market-options-tab3"></div>
        </div>
        <div class="main-detailed">
          <div class="header"> <img src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Ff930e667.%E1%BA%A2nh.025539.jpg" alt="Logo"> <h2>B√ÅO C√ÅO HI·ªÜU SU·∫§T THEO NG√ÄY</h2> </div>
          <div class="table-responsive-container">
            <table id="date-summary-table">
              <thead> <tr> <th>Ng√†y</th><th>T·ªïng CPQC</th><th>DS Ch·ªët</th><th>T·ªâ l·ªá ch·ªët TB</th> <th>Gi√° Mess</th><th>CPS</th><th>%CP/DS</th> </tr> </thead>
              <tbody id="date-summary-body"></tbody>
            </table>
          </div>
          <div class="chart-toggle-controls">
              <label class="toggle-all"><input type="checkbox" id="toggle-all-charts" checked> Ch·ªçn/B·ªè ch·ªçn t·∫•t c·∫£</label>
              <label><input type="checkbox" class="chart-toggle" data-chart="cpqcChart" checked> CPQC</label>
              <label><input type="checkbox" class="chart-toggle" data-chart="dsChotChart" checked> DS Ch·ªët</label>
              <label><input type="checkbox" class="chart-toggle" data-chart="rateChart" checked> T·ªâ l·ªá ch·ªët</label>
              <label><input type="checkbox" class="chart-toggle" data-chart="messChart" checked> Gi√° Mess</label>
              <label><input type="checkbox" class="chart-toggle" data-chart="cpsChart" checked> CPS</label>
              <label><input type="checkbox" class="chart-toggle" data-chart="cpDsRatioChart" checked> %CP/DS</label>
              <label><input type="checkbox" class="chart-toggle" data-chart="productSalesChart" checked> DS theo S·∫£n ph·∫©m</label>
              <label><input type="checkbox" class="chart-toggle" data-chart="marketSalesChart" checked> DS theo Th·ªã tr∆∞·ªùng</label>
          </div>
          <div class="charts-container">
            <div class="chart-wrapper" data-chart="cpqcChart"><canvas id="cpqcChart"></canvas></div>
            <div class="chart-wrapper" data-chart="dsChotChart"><canvas id="dsChotChart"></canvas></div>
            <div class="chart-wrapper" data-chart="rateChart"><canvas id="rateChart"></canvas></div>
            <div class="chart-wrapper" data-chart="messChart"><canvas id="messChart"></canvas></div>
            <div class="chart-wrapper" data-chart="cpsChart"><canvas id="cpsChart"></canvas></div>
            <div class="chart-wrapper" data-chart="cpDsRatioChart"><canvas id="cpDsRatioChart"></canvas></div>
            <div class="chart-wrapper" data-chart="productSalesChart"><canvas id="productSalesChart"></canvas></div>
            <div class="chart-wrapper" data-chart="marketSalesChart"><canvas id="marketSalesChart"></canvas></div>
          </div>
        </div>
      </div>
  </div>

  <!-- ======================= TAB 4: B√ÅO C√ÅO HI·ªÜU QU·∫¢ MKT (M·ªöI) ======================= -->
  <div id="MktReport" class="tab-content">
      <div class="report-header">
          <div class="report-title">TH·ªêNG K√ä HI·ªÜU QU·∫¢ MARKETING THEO S·∫¢N PH·∫®M & TH·ªä TR∆Ø·ªúNG</div>
          <div class="report-date" id="report-date-mkt"></div>
      </div>
      <div class="filter-container">
          <div class="filter-group"> <label for="start-date-mkt">T·ª´ ng√†y:</label> <input type="date" id="start-date-mkt"> </div>
          <div class="filter-group"> <label for="end-date-mkt">ƒê·∫øn ng√†y:</label> <input type="date" id="end-date-mkt"> </div>
          <div class="filter-group"> <label for="market-filter-mkt">Th·ªã tr∆∞·ªùng:</label> <select id="market-filter-mkt"></select> </div>
          <div class="filter-group"> <label for="team-filter-mkt">Team:</label> <select id="team-filter-mkt"></select> </div>
          <div class="filter-group"> <label for="ca-filter-mkt">Ca:</label> <select id="ca-filter-mkt"></select> </div>
          <button id="apply-filter-mkt">√Åp d·ª•ng</button>
      </div>
      <div id="loading-mkt" class="loading">ƒêang t·∫£i d·ªØ li·ªáu...</div>
      <div id="error-message-mkt" class="error-message" style="display: none;"></div>
      <div id="non-asia-market-mkt" style="display: none;">
          <div class="section-title">TH·ªä TR∆Ø·ªúNG NGO√ÄI CH√ÇU √Å</div>
          <table id="non-asia-table-mkt">
              <thead><tr><th>S·∫£n ph·∫©m</th><th>Th·ªã tr∆∞·ªùng</th><th class="text-right">CPQC</th><th class="text-center">S·ªë ƒë∆°n</th><th class="text-right">DS Ch·ªët</th><th class="text-center">%CP/DS</th><th class="text-right">CPS</th><th class="text-right">Gi√° ƒë∆°n TB</th><th class="text-center">T·ªâ l·ªá ch·ªët</th></tr></thead>
              <tbody id="non-asia-body-mkt"></tbody>
          </table>
      </div>
      <div id="asia-market-mkt" style="display: none;">
          <div class="section-title">TH·ªä TR∆Ø·ªúNG CH√ÇU √Å</div>
          <table id="asia-table-mkt">
              <thead><tr><th>S·∫£n ph·∫©m</th><th>Th·ªã tr∆∞·ªùng</th><th class="text-right">CPQC</th><th class="text-center">S·ªë ƒë∆°n</th><th class="text-right">DS Ch·ªët</th><th class="text-center">%CP/DS</th><th class="text-right">CPS</th><th class="text-right">Gi√° ƒë∆°n TB</th><th class="text-center">T·ªâ l·ªá ch·ªët</th></tr></thead>
              <tbody id="asia-body-mkt"></tbody>
          </table>
      </div>
      <div id="summary-mkt" style="display: none;">
          <div class="section-title">T·ªîNG H·ª¢P T·∫§T C·∫¢ TH·ªä TR∆Ø·ªúNG</div>
          <table id="summary-table-mkt">
              <thead><tr><th>S·∫£n ph·∫©m</th><th></th><th class="text-right">CPQC</th><th class="text-center">S·ªë ƒë∆°n</th><th class="text-right">DS Ch·ªët</th><th class="text-center">%CP/DS</th><th class="text-right">CPS</th><th class="text-right">Gi√° ƒë∆°n TB</th><th class="text-center">T·ªâ l·ªá ch·ªët</th></tr></thead>
              <tbody id="summary-body-mkt"></tbody>
          </table>
      </div>
  </div>

  <!-- ======================= TAB 5: B√ÅO C√ÅO NH√ÇN S·ª∞ (T√çCH H·ª¢P) ======================= -->
  <div id="StaffReport" class="tab-content">
      <div class="report-container">
          <div class="sidebar">
              <h3>B·ªô l·ªçc chi ti·∫øt</h3>
              <label for="start-date-staff">T·ª´ ng√†y:</label> <input type="date" id="start-date-staff">
              <label for="end-date-staff">ƒê·∫øn ng√†y:</label> <input type="date" id="end-date-staff">
              <label for="team-filter-staff">Ch·ªçn Team (gi·ªØ Ctrl/Cmd ƒë·ªÉ ch·ªçn nhi·ªÅu):</label> <select id="team-filter-staff" multiple size="6"></select>
              <label for="staff-filter-staff">Ch·ªçn ƒë·ªëi t∆∞·ª£ng xem:</label> <select id="staff-filter-staff"></select>
              <button id="apply-filter-staff">Xem B√°o c√°o</button>
          </div>
          <div class="main-detailed">
              <div class="header">
                  <img src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Ff930e667.%E1%BA%A2nh.025539.jpg" alt="Logo">
                  <h2>B√ÅO C√ÅO HI·ªÜU SU·∫§T NH√ÇN S·ª∞</h2>
              </div>
  
              <div id="staff-content-wrapper">
                  <div id="staff-placeholder"><p>Vui l√≤ng ch·ªçn Team v√† ƒë·ªëi t∆∞·ª£ng xem b√°o c√°o.</p></div>
              
                  <div id="staff-results-container" style="display: none;">
                      <h3 id="staff-report-title" class="report-title"></h3>
                      <div id="staff-summary-container">
                          <h4 class="section-title">T·ªïng h·ª£p hi·ªáu su·∫•t trong k·ª≥ (Click v√†o nh√¢n s·ª± ƒë·ªÉ xem bi·ªÉu ƒë·ªì)</h4>
                          <div class="table-responsive-container"> <table id="staff-summary-table"></table> </div>
                      </div>
                      <div id="staff-daily-breakdown-container">
                          <h4 class="section-title">Chi ti·∫øt hi·ªáu su·∫•t theo ng√†y</h4>
                           <div class="table-responsive-container"> <div id="daily-breakdown-table-wrapper"></div> </div>
                      </div>
                      <div id="daily-comparison-container" style="display: none;">
                        <h4 class="section-title">Xu H∆∞·ªõng Doanh S·ªë Ch·ªët To√†n Team Theo Ng√†y</h4>
                        <div id="daily-trend-chart-container"><canvas id="teamDailyTrendChart"></canvas></div>
                      </div>
                      <h4 class="section-title">Bi·ªÉu ƒë·ªì t·ªïng quan</h4>
                      <div id="charts-container-staff" class="chart-grid">
                          <div class="chart-container" data-chart="doughnut" style="display: none;">
                            <div id="doughnut-chart-title" class="chart-title"><i class="fas fa-chart-pie"></i>T·ªâ L·ªá ƒê√≥ng G√≥p Doanh S·ªë</div>
                            <div class="chart-wrapper"><canvas id="teamDoughnutChart"></canvas></div>
                          </div>
                          <div class="chart-container" data-chart="line" style="display: none;"> <div class="chart-title"><i class="fas fa-chart-line"></i>Xu H∆∞·ªõng Doanh S·ªë C√° Nh√¢n</div> <div class="chart-wrapper"><canvas id="staffLineChart"></canvas></div> </div>
                          <div class="chart-container" data-chart="combo" style="display: none;"> <div class="chart-title"><i class="fas fa-chart-area"></i>Doanh S·ªë & T·ªâ l·ªá Ch·ªët C√° Nh√¢n</div> <div class="chart-wrapper"><canvas id="staffComboChart"></canvas></div> </div>
                      </div>
                  </div>
              </div>
          </div>
      </div>
  </div>

<!-- ======================= B·ªî SUNG TH∆Ø VI·ªÜN JAVASCRIPT (QUAN TR·ªåNG) ======================= -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {

        const loader = document.getElementById('loading-overlay');
        const showLoader = () => loader.classList.add('visible');
        const hideLoader = () => loader.classList.remove('visible');

        /**
         * B·∫£ng m√†u t∆∞∆°i t·∫Øn cho c√°c bi·ªÉu ƒë·ªì
         */
        const chartColorPalette = {
            border: [
                '#36A2EB', // Bright Blue
                '#FF6384', // Bright Pink
                '#4BC0C0', // Teal
                '#FFCD56', // Yellow
                '#9966FF', // Purple
                '#FF9F40', // Orange
                '#20c997', // Green-Cyan
                '#6f42c1'  // Indigo
            ],
            background: [
                'rgba(54, 162, 235, 0.2)',
                'rgba(255, 99, 132, 0.2)',
                'rgba(75, 192, 192, 0.2)',
                'rgba(255, 205, 86, 0.2)',
                'rgba(153, 102, 255, 0.2)',
                'rgba(255, 159, 64, 0.2)',
                'rgba(32, 201, 151, 0.2)',
                'rgba(111, 66, 193, 0.2)'
            ],
            getColorPair: function(index) {
                const i = index % this.border.length;
                return { b: this.border[i], f: this.background[i] };
            }
        };

        window.openTab = function(evt, tabName) {
            document.querySelectorAll(".tab-content").forEach(tc => tc.style.display = "none");
            document.querySelectorAll(".tablinks").forEach(tl => tl.classList.remove("active"));
            const targetTab = document.getElementById(tabName);
            if(targetTab) targetTab.style.display = "block";
            evt.currentTarget.classList.add("active");

            if (tabName === 'CostReport' && !costReportApp.isInitialized) { costReportApp.init(); } 
            else if (tabName === 'SaleReport' && !saleReportApp.isInitialized) { saleReportApp.init(); }
            else if (tabName === 'ChartReport' && !chartReportApp.isInitialized) { chartReportApp.init(); }
            else if (tabName === 'MktReport' && !mktReportApp.isInitialized) { mktReportApp.init(); }
            else if (tabName === 'StaffReport' && !staffReportApp.isInitialized) { staffReportApp.init(); }
        }
        
        const formatUtils = {
            formatDate: v => { if (!v) return ''; const d = new Date(v); return isNaN(d.getTime()) ? v : `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`},
            formatCurrency: v => Number(v||0).toLocaleString('vi-VN',{style:'currency',currency:'VND'}),
            formatNumber: v => Number(v||0).toLocaleString('vi-VN'),
            formatPercent: v => !isFinite(v)?'0.00%':`${(Number(v||0)*100).toFixed(2)}%`,
            formatPriceShort: v => { const n=Number(v||0); return n>=1e6?(n/1e6).toFixed(1)+'tr':(n>=1e3?(n/1e3).toFixed(0)+'k':n.toLocaleString('vi-VN'))}
        };
        
        function handleCheckbox(masterId, childClass, target) {
            if(target.id === masterId) document.querySelectorAll(`.${childClass}`).forEach(cb => cb.checked = target.checked);
            else if(target.classList.contains(childClass)) document.getElementById(masterId).checked = [...document.querySelectorAll(`.${childClass}`)].every(cb => cb.checked);
        }
        
        // ===================================================================
        // =========== MODULE CHO B√ÅO C√ÅO CHI PH√ç (TAB 1) ====================
        // ===================================================================
        const costReportApp = {
            isInitialized: false, rawData: [], groupChildren: { 'Ch√¢u √Å': ['H√†n Qu·ªëc','Nh·∫≠t B·∫£n','VN'], 'Ngo√†i Ch√¢u √Å': ['√öc','US', 'Canada'] },
            init: function() { this.addEventListeners(); this.setDefaultDates(); this.fetchData(); this.isInitialized = true; },
            addEventListeners: function() { document.getElementById('CostReport').addEventListener('change', e => e.target.matches('input')&&this.handleFilters(e.target)); },
            setDefaultDates: function() { const t=new Date(),s=new Date(t.getFullYear(),t.getMonth(),1),e=new Date(t.getFullYear(),t.getMonth()+1,0),f=d=>d.toISOString().split('T')[0]; document.getElementById('start-date-tab1').value=f(s);document.getElementById('end-date-tab1').value=f(e);},
            fetchData: function() {
                showLoader();
                fetch('https://script.google.com/macros/s/AKfycbwGwSBxeXplEzAM-jJDPaXPkiWjNyKmpR70o6nCY5_ynqoF-3WA1gvF91RIQQfDZ9fvAQ/exec')
                    .then(res => res.json()).then(data => {
                        this.rawData = data.map(r => ({...r, team:r.team||'Kh√°c', ten:r.ten||'N/A', dsChot:+r.dsChot||0, cpqc:+r.cpqc||0, soDon:+r.soDon||0, soMessCmt:+r.soMessCmt||0, doanhsoTC:+r.doanhsoTC||0, doanhSo:+r.doanhSo||0, doanhSoSauShip:+r.doanhSoSauShip||0, kpis:+r.kpis||0 }));
                        this.populateAllFilters(this.rawData); this.applyFilters();
                    }).catch(err => { console.error("L·ªói Cost Data:", err); alert('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu chi ph√≠.'); }).finally(hideLoader);
            },
            populateAllFilters: function(data) { const pS=new Set(),cS=new Set(),tS=new Set(),mS=new Set(); data.forEach(r=>{if(r.sanPham)pS.add(r.sanPham);if(r.ca)cS.add(r.ca);if(r.team)tS.add(r.team);if(r.thiTruong)mS.add(r.thiTruong);}); document.getElementById('product-options-tab1').innerHTML=Array.from(pS).sort().map(p=>`<label class='indent'><input type='checkbox' class='filter-product-tab1' value='${p}' checked> ${p}</label>`).join('');const mH=Object.keys(this.groupChildren).map(g=>`<label><input type='checkbox' class='filter-market-tab1' value='${g}' checked> ${g}</label>`+this.groupChildren[g].map(c=>`<label class='indent'><input type='checkbox' class='filter-market-tab1' value='${c}' checked> ${c}</label>`).join('')).join('');const oM=Array.from(mS).filter(m=>!Object.values(this.groupChildren).flat().map(c=>(c||'').toLowerCase()).includes((m||'').toLowerCase())).sort().map(m=>`<label><input type='checkbox' class='filter-market-tab1' value='${m}' checked> ${m}</label>`).join('');document.getElementById('market-options-tab1').innerHTML=mH+oM;document.getElementById('ca-options-tab1').innerHTML=Array.from(cS).sort().map(c=>`<label class='indent'><input type='checkbox' class='filter-ca-tab1' value='${c}' checked> ${c}</label>`).join('');document.getElementById('team-options-tab1').innerHTML=Array.from(tS).sort().map(t=>`<label class='indent'><input type='checkbox' class='filter-team-tab1' value='${t}' checked> ${t}</label>`).join('');},
            getFilteredData: function() { const sV=document.getElementById('start-date-tab1').value,eV=document.getElementById('end-date-tab1').value,pA=document.getElementById('product-all-tab1').checked,sP=pA?null:[...document.querySelectorAll(`.filter-product-tab1:checked`)].map(c=>c.value),mA=document.getElementById('market-all-tab1').checked,sM=mA?null:[...document.querySelectorAll(`.filter-market-tab1:checked`)].map(c=>c.value),cA=document.getElementById('ca-all-tab1').checked,sC=!cA?[...document.querySelectorAll(`.filter-ca-tab1:checked`)].map(c=>c.value):null,tA=document.getElementById('team-all-tab1').checked,sT=!tA?[...document.querySelectorAll(`.filter-team-tab1:checked`)].map(c=>c.value):null; return this.rawData.filter(r=>{if(!r.ngay)return false;const d=new Date(r.ngay);if(isNaN(d.getTime()))return false;const dS=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;const dO=(!sV||dS>=sV)&&(!eV||dS<=eV);const pO=!sP||sP.includes(r.sanPham);const mG=this.getGroup((r.thiTruong||'').trim().toLowerCase());const mO=!sM||sM.includes(mG)||sM.includes(r.thiTruong);const cO=!sC||sC.includes(r.ca);const tO=!sT||sT.includes(r.team);return dO&&pO&&mO&&cO&&tO;});},
            getGroup: function(n){for(let g in this.groupChildren){if(this.groupChildren[g].map(c=>(c||'').toLowerCase()).includes(n))return g;}return n.charAt(0).toUpperCase()+n.slice(1);},
            handleFilters: function(t){showLoader();setTimeout(()=>{handleCheckbox('product-all-tab1','filter-product-tab1',t);handleCheckbox('ca-all-tab1','filter-ca-tab1',t);handleCheckbox('team-all-tab1','filter-team-tab1',t);handleCheckbox('market-all-tab1','filter-market-tab1',t);this.applyFilters();hideLoader();},10);},
            applyFilters: function(){const f=this.getFilteredData();this.renderSummaryCost(f);this.renderKpiSummary(f);this.renderDailyBreakdownCost(f);},
            renderSummaryCost: function(d){const sD={};d.forEach(r=>{const n=r.ten;if(!sD[n])sD[n]={team:r.team,mess:0,don:0,chot:0,cpqc:0};sD[n].mess+=r.soMessCmt;sD[n].don+=r.soDon;sD[n].chot+=r.dsChot;sD[n].cpqc+=r.cpqc;});const fL=Object.keys(sD).map(n=>({name:n,team:sD[n].team,data:sD[n]})).sort((a,b)=>b.data.chot-a.data.chot);let t={mess:0,don:0,chot:0,cpqc:0};let bH=fL.map((i,x)=>{const s=i.data;t.mess+=s.mess;t.don+=s.don;t.chot+=s.chot;t.cpqc+=s.cpqc;const r=s.mess?s.don/s.mess:0,pm=s.mess?s.cpqc/s.mess:0,pd=s.don?s.cpqc/s.don:0,pc=s.chot?s.cpqc/s.chot:0,pdt=s.don?s.chot/s.don:0;const rC=r>0.1?'bg-green':(r>0.05?'bg-yellow':'');let R=x===0?'top-1':(x===1?'top-2':(x===2?'top-3':''));return `<tr class="${R}"><td class="text-center">${x+1}</td><td class="text-left">${i.team}</td><td class="text-left">${i.name}</td><td>${formatUtils.formatNumber(s.mess)}</td><td>${formatUtils.formatCurrency(s.cpqc)}</td><td>${formatUtils.formatNumber(s.don)}</td><td>${formatUtils.formatCurrency(s.chot)}</td><td class="${rC}">${formatUtils.formatPercent(r)}</td><td>${formatUtils.formatCurrency(pm)}</td><td>${formatUtils.formatCurrency(pd)}</td><td>${formatUtils.formatPercent(pc)}</td><td>${formatUtils.formatCurrency(pdt)}</td></tr>`;}).join('');const tR=t.mess?t.don/t.mess:0,tP=t.mess?t.cpqc/t.mess:0,tD=t.don?t.cpqc/t.don:0,tC=t.chot?t.cpqc/t.chot:0,tT=t.don?t.chot/t.don:0;const fH=`<tr class="total-row"><td class="total-label" colspan="3">T·ªîNG C·ªòNG</td><td>${formatUtils.formatNumber(t.mess)}</td><td>${formatUtils.formatCurrency(t.cpqc)}</td><td>${formatUtils.formatNumber(t.don)}</td><td>${formatUtils.formatCurrency(t.chot)}</td><td>${formatUtils.formatPercent(tR)}</td><td>${formatUtils.formatCurrency(tP)}</td><td>${formatUtils.formatCurrency(tD)}</td><td>${formatUtils.formatPercent(tC)}</td><td>${formatUtils.formatCurrency(tT)}</td></tr>`;document.getElementById('summary-body-cost').innerHTML=bH;document.getElementById('summary-foot-cost').innerHTML=fH;},
            renderKpiSummary: function(d){const sM={};d.forEach(r=>{const m=r.ten;if(!sM[m])sM[m]={cpqc:0,dsChot:0,dsDi:0,dsSauShip:0,dsThanhCong:0,kpiValue:r.kpis,team:r.team};sM[m].cpqc+=r.cpqc;sM[m].dsChot+=r.dsChot;sM[m].dsDi+=r.doanhSo;sM[m].dsSauShip+=r.doanhSoSauShip;sM[m].dsThanhCong+=r.doanhsoTC;});const sK=Object.keys(sM).sort((a,b)=>sM[b].dsChot-sM[a].dsChot);let t={cpqc:0,dsChot:0,dsDi:0,dsSauShip:0,dsThanhCong:0,kpis:0};let bH=sK.map((m,i)=>{const s=sM[m];t.cpqc+=s.cpqc;t.dsChot+=s.dsChot;t.dsDi+=s.dsDi;t.dsSauShip+=s.dsSauShip;t.dsThanhCong+=s.dsThanhCong;t.kpis+=s.kpiValue;const c=s.dsSauShip?s.cpqc/s.dsSauShip:0,k=s.kpiValue?s.dsSauShip/s.kpiValue:0;let R=i===0?'top-1':(i===1?'top-2':(i===2?'top-3':''));return `<tr class="${R}"><td class="text-center">${i+1}</td><td class="text-left">${s.team}</td><td class="text-left">${m}</td><td>${formatUtils.formatCurrency(s.cpqc)}</td><td>${formatUtils.formatCurrency(s.dsChot)}</td><td>${formatUtils.formatCurrency(s.dsDi)}</td><td>${formatUtils.formatCurrency(s.dsSauShip)}</td><td>${formatUtils.formatCurrency(s.dsThanhCong)}</td><td>${formatUtils.formatPercent(c)}</td><td>${formatUtils.formatPercent(k)}</td></tr>`;}).join('');const tC=t.dsSauShip?t.cpqc/t.dsSauShip:0;const tK=t.kpis?t.dsSauShip/t.kpis:0;const fH=`<tr class="total-row"><td class="total-label" colspan="3">T·ªîNG C·ªòNG</td><td>${formatUtils.formatCurrency(t.cpqc)}</td><td>${formatUtils.formatCurrency(t.dsChot)}</td><td>${formatUtils.formatCurrency(t.dsDi)}</td><td>${formatUtils.formatCurrency(t.dsSauShip)}</td><td>${formatUtils.formatCurrency(t.dsThanhCong)}</td><td>${formatUtils.formatPercent(tC)}</td><td>${formatUtils.formatPercent(tK)}</td></tr>`;document.getElementById('kpi-summary-body').innerHTML=bH;document.getElementById('kpi-summary-foot').innerHTML=fH;},
            renderDailyBreakdownCost: function(d){const c=document.getElementById('daily-breakdown-cost');c.innerHTML='';const g={};d.forEach(r=>{const D=formatUtils.formatDate(r.ngay);(g[D]||(g[D]=[])).push(r);});Object.keys(g).sort((a,b)=>new Date(b.split('/').reverse().join('-'))-new Date(a.split('/').reverse().join('-'))).forEach(dt=>{let m=0,D=0,ch=0,pc=0;const sD=g[dt].sort((a,b)=>((a.ten||'').localeCompare(b.ten||''))||(b.dsChot-a.dsChot));const rH=sD.map(r=>{m+=r.soMessCmt;D+=r.soDon;ch+=r.dsChot;pc+=r.cpqc;return`<tr><td class="text-center">${r.id}</td><td class="text-left">${r.ten}</td><td class="text-left">${r.ca}</td><td class="text-left">${r.page}</td><td class="text-left">${r.sanPham}</td><td class="text-left">${r.thiTruong}</td><td>${formatUtils.formatNumber(r.soMessCmt)}</td><td>${formatUtils.formatNumber(r.soDon)}</td><td>${formatUtils.formatCurrency(r.dsChot)}</td><td>${formatUtils.formatCurrency(r.cpqc)}</td><td class="text-left">${r.team}</td></tr>`}).join('');const fH=`<tr class='total-row'><td colspan='6' class='total-label'>T·ªïng</td><td>${formatUtils.formatNumber(m)}</td><td>${formatUtils.formatNumber(D)}</td><td>${formatUtils.formatCurrency(ch)}</td><td>${formatUtils.formatCurrency(pc)}</td><td></td></tr>`;const tH=`<div class="table-responsive-container"><table><thead><tr><th>ID</th><th>T√™n</th><th>Ca</th><th>Page</th><th>S·∫£n ph·∫©m</th><th>Th·ªã tr∆∞·ªùng</th><th>Mess</th><th>ƒê∆°n</th><th>DS Ch·ªët</th><th>CPQC</th><th>Team</th></tr></thead><tbody>${rH}</tbody><tfoot>${fH}</tfoot></table></div>`;c.innerHTML+=`<div class="daily-breakdown"><h3>Chi ti·∫øt ng√†y: ${dt}</h3>${tH}</div>`;});}
        };

        // ===================================================================
        // =========== MODULE CHO B√ÅO C√ÅO SALE (TAB 2) =======================
        // ===================================================================
        const saleReportApp = {
            isInitialized: false, rawData: [],
            init: function() { this.addEventListeners(); this.setDefaultDates(); this.fetchAndProcessData(); this.isInitialized = true; },
            addEventListeners: function() { document.getElementById('SaleReport').addEventListener('change', e => e.target.matches('input')&&this.handleFilters(e.target)); document.getElementById('SaleReport').addEventListener('click', e => { const r=e.target.closest('tbody tr');if(!r||r.classList.contains('total-row'))return;const s=r.classList.contains('row-selected');document.querySelectorAll('#SaleReport tbody tr.row-selected').forEach(R=>R.classList.remove('row-selected'));if(!s)r.classList.add('row-selected');});},
            setDefaultDates: function() { const t=new Date(),s=new Date(t.getFullYear(),t.getMonth(),1),e=new Date(t.getFullYear(),t.getMonth()+1,0),f=d=>d.toISOString().split('T')[0];document.getElementById('start-date-sale').value=f(s);document.getElementById('end-date-sale').value=f(e);},
            fetchAndProcessData: function() { showLoader(); fetch('https://script.google.com/macros/s/AKfycbzd8KdWC7PVuv7ttnQLV7oIxmAgWWdLfs3laMDoL7w5GhvCWd_71_Xc33e-GaUSiG_3/exec').then(res=>res.json()).then(rS=>{this.rawData=rS.filter(r=>r.trangThai&&String(r.trangThai).trim()!==''&&r.ten&&String(r.ten).trim()!==''&&r.team&&String(r.team).trim()!=='').map(r=>({...r,ten:(r.ten||'').trim(),team:(r.team||'').trim(),soMessCmt:+r.soMess||0,soDon:+r.donMess||0,dsChot:+r.doanhSoMess||0,phanHoi:+r.phanHoi||0}));this.populateAllFilters(this.rawData);this.applyFilters();}).catch(err=>{console.error("L·ªói Sale Data:",err);alert('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu Sale.');}).finally(hideLoader);},
            populateAllFilters: function(d){const p=(k,c,n)=>{const C=document.getElementById(c),u=[...new Set(d.map(r=>r[k]).filter(v=>v!=null&&v!==''))].sort();C.innerHTML=u.map(v=>`<label><input type='checkbox' class='${n}' value='${v}' checked> ${v}</label>`).join('');};p('sanPham','product-options-sale','filter-product-sale');p('thiTruong','market-options-sale','filter-market-sale');p('ca','ca-options-sale','filter-ca-sale');p('team','team-options-sale','filter-team-sale');},
            getFilteredData: function(){const sV=document.getElementById('start-date-sale').value,eV=document.getElementById('end-date-sale').value,s=sV?new Date(sV+'T00:00:00'):null,e=eV?new Date(eV+'T23:59:59'):null;const g=(m,c)=>document.getElementById(m).checked?null:[...document.querySelectorAll(`.${c}:checked`)].map(b=>b.value);const sP=g('product-all-sale','filter-product-sale'),sM=g('market-all-sale','filter-market-sale'),sC=g('ca-all-sale','filter-ca-sale'),sT=g('team-all-sale','filter-team-sale');return this.rawData.filter(r=>{const d=new Date(r.ngay);return((!s||d>=s)&&(!e||d<=e))&&(!sP||sP.includes(r.sanPham))&&(!sM||sM.includes(r.thiTruong))&&(!sC||sC.includes(String(r.ca)))&&(!sT||sT.includes(String(r.team)));});},
            handleFilters: function(t){showLoader();setTimeout(()=>{handleCheckbox('product-all-sale','filter-product-sale',t);handleCheckbox('ca-all-sale','filter-ca-sale',t);handleCheckbox('team-all-sale','filter-team-sale',t);handleCheckbox('market-all-sale','filter-market-sale',t);this.applyFilters();hideLoader();},10);},
            applyFilters: function(){const f=this.getFilteredData();this.renderSummarySale(f);this.renderDailyBreakdownSale(f);},
            renderSummarySale: function(d){const sD={};d.forEach(r=>{const n=r.ten;if(!sD[n])sD[n]={team:r.team,mess:0,don:0,chot:0,phanHoi:0};sD[n].mess+=r.soMessCmt;sD[n].don+=r.soDon;sD[n].chot+=r.dsChot;sD[n].phanHoi+=r.phanHoi;});const fL=Object.keys(sD).map(n=>({name:n,team:sD[n].team,data:sD[n]})).sort((a,b)=>b.data.chot-a.data.chot||a.name.localeCompare(b.name));let bH=fL.map((i,x)=>{const s=i.data;const r=s.mess?s.don/s.mess:0;let R=x===0?'top-1':(x===1?'top-2':(x===2?'top-3':''));return `<tr class="${R}"><td class="text-center">${x+1}</td><td class="text-left">${i.team}</td><td class="text-left">${i.name}</td><td>${formatUtils.formatNumber(s.mess)}</td><td>${formatUtils.formatNumber(s.don)}</td><td>${formatUtils.formatNumber(s.phanHoi)}</td><td>${formatUtils.formatCurrency(s.chot)}</td><td class="${r>=0.1?'bg-green':(r>0.05?'bg-yellow':'')}">${formatUtils.formatPercent(r)}</td></tr>`;}).join('');const t=fL.reduce((a,i)=>({mess:a.mess+i.data.mess,don:a.don+i.data.don,chot:a.chot+i.data.chot,phanHoi:a.phanHoi+i.data.phanHoi}),{mess:0,don:0,chot:0,phanHoi:0});const tR=t.mess?t.don/t.mess:0;const fH=`<tr class="total-row"><td class="total-label" colspan="3">T·ªîNG C·ªòNG</td><td>${formatUtils.formatNumber(t.mess)}</td><td>${formatUtils.formatNumber(t.don)}</td><td>${formatUtils.formatNumber(t.phanHoi)}</td><td>${formatUtils.formatCurrency(t.chot)}</td><td>${formatUtils.formatPercent(tR)}</td></tr>`;document.getElementById('summary-body-sale').innerHTML=bH;document.getElementById('summary-foot-sale').innerHTML=fH;},
            renderDailyBreakdownSale: function(d){const c=document.getElementById('daily-breakdown-sale');c.innerHTML='';if(d.length===0)return;const g={};d.forEach(r=>{const D=formatUtils.formatDate(r.ngay);(g[D]=g[D]||[]).push(r);});const sD=Object.keys(g).sort((a,b)=>new Date(b.split('/').reverse().join('-'))-new Date(a.split('/').reverse().join('-')));sD.forEach(dt=>{let t={mess:0,don:0,chot:0,phanHoi:0};const SD=g[dt].sort((a,b)=>a.ten.localeCompare(b.ten)||(b.dsChot-a.dsChot));const rH=SD.map(r=>{t.mess+=r.soMessCmt;t.don+=r.soDon;t.chot+=r.dsChot;t.phanHoi+=r.phanHoi;return`<tr><td class="text-left">${r.ten}</td><td class="text-left">${r.ca}</td><td class="text-left">${r.sanPham}</td><td class="text-left">${r.thiTruong}</td><td>${formatUtils.formatNumber(r.soMessCmt)}</td><td>${formatUtils.formatNumber(r.soDon)}</td><td>${formatUtils.formatNumber(r.phanHoi)}</td><td>${formatUtils.formatCurrency(r.dsChot)}</td><td class="text-left">${r.team}</td></tr>`}).join('');const fH=`<tr class='total-row'><td colspan='4' class='total-label'>T·ªïng</td><td>${formatUtils.formatNumber(t.mess)}</td><td>${formatUtils.formatNumber(t.don)}</td><td>${formatUtils.formatNumber(t.phanHoi)}</td><td>${formatUtils.formatCurrency(t.chot)}</td><td></td></tr>`;const tH=`<div class="table-responsive-container"><table><thead><tr><th>T√™n</th><th>Ca</th><th>S·∫£n ph·∫©m</th><th>Th·ªã tr∆∞·ªùng</th><th>Mess</th><th>ƒê∆°n</th><th>Ph·∫£n h·ªìi</th><th>DS Ch·ªët</th><th>Team</th></tr></thead><tbody>${rH}</tbody><tfoot>${fH}</tfoot></table></div>`;c.innerHTML+=`<div class="daily-breakdown"><h3>Chi ti·∫øt ng√†y: ${dt}</h3>${tH}</div>`;});}
        };
        
        // ===================================================================
        // =========== MODULE CHO B√ÅO C√ÅO BI·ªÇU ƒê·ªí (TAB 3) ===================
        // ===================================================================
        const chartReportApp = {
            isInitialized: false, rawData: [], charts: {}, groupChildren: { 'Ch√¢u √Å': ['H√†n Qu·ªëc','Nh·∫≠t B·∫£n','VN'], 'Ngo√†i Ch√¢u √Å': ['√öc','US', 'Canada'] },
            init: function() { this.addEventListeners(); this.setDefaultDates(); this.fetchData(); this.isInitialized = true; },
            addEventListeners: function() { document.getElementById('ChartReport').addEventListener('change', e => e.target.matches('input')&&this.handleFilters(e.target)); },
            setDefaultDates: function() { const t=new Date(),s=new Date(t.getFullYear(),t.getMonth(),1),e=new Date(t.getFullYear(),t.getMonth()+1,0),f=d=>d.toISOString().split('T')[0];document.getElementById('start-date-tab3').value=f(s);document.getElementById('end-date-tab3').value=f(e);},
            fetchData: function() {
                showLoader();
                fetch('https://script.google.com/macros/s/AKfycbwGwSBxeXplEzAM-jJDPaXPkiWjNyKmpR70o6nCY5_ynqoF-3WA1gvF91RIQQfDZ9fvAQ/exec')
                    .then(res => res.json()).then(data => {
                        this.rawData = data.map(r => ({...r, dsChot:+r.dsChot||0, cpqc:+r.cpqc||0, soDon:+r.soDon||0, soMessCmt:+r.soMessCmt||0}));
                        this.populateAllFilters(this.rawData);
                        this.initAllCharts(); this.applyFilters();
                    }).catch(err => { console.error("L·ªói Chart Data:", err); alert('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu bi·ªÉu ƒë·ªì.'); }).finally(hideLoader);
            },
            populateAllFilters: function(data){const pS=new Set(),mS=new Set();data.forEach(r=>{if(r.sanPham)pS.add(r.sanPham);if(r.thiTruong)mS.add(r.thiTruong);});document.getElementById('product-options-tab3').innerHTML=Array.from(pS).sort().map(p=>`<label class='indent'><input type='checkbox' class='filter-product-tab3' value='${p}' checked> ${p}</label>`).join('');const mH=Object.keys(this.groupChildren).map(g=>`<label><input type='checkbox' class='filter-market-tab3' value='${g}' checked> ${g}</label>`+this.groupChildren[g].map(c=>`<label class='indent'><input type='checkbox' class='filter-market-tab3' value='${c}' checked> ${c}</label>`).join('')).join('');const oM=Array.from(mS).filter(m=>!Object.values(this.groupChildren).flat().map(c=>(c||'').toLowerCase()).includes((m||'').toLowerCase())).sort().map(m=>`<label><input type='checkbox' class='filter-market-tab3' value='${m}' checked> ${m}</label>`).join('');document.getElementById('market-options-tab3').innerHTML=mH+oM;},
            getFilteredData: function(){const sV=document.getElementById('start-date-tab3').value,eV=document.getElementById('end-date-tab3').value,pA=document.getElementById('product-all-tab3').checked,sP=pA?null:[...document.querySelectorAll(`.filter-product-tab3:checked`)].map(c=>c.value),mA=document.getElementById('market-all-tab3').checked,sM=mA?null:[...document.querySelectorAll(`.filter-market-tab3:checked`)].map(c=>c.value);return this.rawData.filter(r=>{if(!r.ngay)return false;const d=new Date(r.ngay);if(isNaN(d.getTime()))return false;const dS=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;const dO=(!sV||dS>=sV)&&(!eV||dS<=eV);const pO=!sP||sP.includes(r.sanPham);const mG=costReportApp.getGroup((r.thiTruong||'').trim().toLowerCase());const mO=!sM||sM.includes(mG)||sM.includes(r.thiTruong);return dO&&pO&&mO;});},
            handleFilters: function(t){showLoader();setTimeout(()=>{if(t.id==='toggle-all-charts'||t.classList.contains('chart-toggle')){if(t.id==='toggle-all-charts')document.querySelectorAll('.chart-toggle').forEach(c=>c.checked=t.checked);else document.getElementById('toggle-all-charts').checked=[...document.querySelectorAll('.chart-toggle')].every(c=>c.checked);this.toggleChartVisibility();hideLoader();return;}handleCheckbox('product-all-tab3','filter-product-tab3',t);handleCheckbox('market-all-tab3','filter-market-tab3',t);this.applyFilters();hideLoader();},10);},
            applyFilters: function(){if(!this.rawData.length)return;const f=this.getFilteredData();this.renderDailyTable(f);this.renderAllDailyCharts(f);},
            renderDailyTable: function(d){const D={};d.forEach(r=>{const k=formatUtils.formatDate(r.ngay);if(!D[k])D[k]={cpqc:0,don:0,mess:0,chot:0};D[k].cpqc+=r.cpqc;D[k].don+=r.soDon;D[k].mess+=r.soMessCmt;D[k].chot+=r.dsChot;});let bH=Object.keys(D).sort((a,b)=>new Date(a.split('/').reverse().join('-'))-new Date(b.split('/').reverse().join('-'))).map(d=>{const y=D[d];const a=y.mess?y.don/y.mess:0,g=y.mess?y.cpqc/y.mess:0,c=y.don?y.cpqc/y.don:0,p=y.chot?y.cpqc/y.chot:0;return`<tr><td class="text-left"><b>${d}</b></td><td>${formatUtils.formatPriceShort(y.cpqc)}</td><td>${formatUtils.formatPriceShort(y.chot)}</td><td>${formatUtils.formatPercent(a)}</td><td>${formatUtils.formatPriceShort(g)}</td><td>${formatUtils.formatPriceShort(c)}</td><td>${formatUtils.formatPercent(p)}</td></tr>`;}).join('');document.getElementById('date-summary-body').innerHTML=bH;},
            toggleChartVisibility: function(){document.querySelectorAll('.chart-toggle').forEach(c=>{const n=c.dataset.chart,w=document.querySelector(`#ChartReport .chart-wrapper[data-chart="${n}"]`);if(w){w.style.display=c.checked?'block':'none';}});},
            initAllCharts: function(){ Chart.register(ChartDataLabels); const c=(i,C)=>new Chart(document.getElementById(i).getContext('2d'),C);this.charts.cpqcChart=c('cpqcChart',this.getLineChartConfig('CPQC (VND)'));this.charts.dsChotChart=c('dsChotChart',this.getLineChartConfig('DS Ch·ªët (VND)'));this.charts.rateChart=c('rateChart',this.getLineChartConfig('T·ªâ l·ªá ch·ªët',v=>formatUtils.formatPercent(v/100)));this.charts.messChart=c('messChart',this.getLineChartConfig('Gi√° Mess (VND)'));this.charts.cpsChart=c('cpsChart',this.getLineChartConfig('CPS (VND)'));this.charts.cpDsRatioChart=c('cpDsRatioChart',this.getLineChartConfig('%CP/DS',v=>formatUtils.formatPercent(v/100)));this.charts.productSalesChart=c('productSalesChart',this.getBarChartConfig());this.charts.marketSalesChart=c('marketSalesChart',this.getBarChartConfig());this.toggleChartVisibility();},
            renderAllDailyCharts: function(d){if(!Object.keys(this.charts).length)return;const D={};d.forEach(r=>{const k=formatUtils.formatDate(r.ngay);if(!D[k])D[k]={cpqc:0,don:0,mess:0,chot:0};D[k].cpqc+=r.cpqc;D[k].don+=r.soDon;D[k].mess+=r.soMessCmt;D[k].chot+=r.dsChot;});const l=Object.keys(D).sort((a,b)=>new Date(a.split('/').reverse().join('-'))-new Date(b.split('/').reverse().join('-')));
                this.updateChart(this.charts.cpqcChart,'CPQC',l,l.map(d=>D[d].cpqc),chartColorPalette.getColorPair(0));
                this.updateChart(this.charts.dsChotChart,'DS Ch·ªët',l,l.map(d=>D[d].chot),chartColorPalette.getColorPair(1));
                this.updateChart(this.charts.rateChart,'T·ªâ l·ªá ch·ªët',l,l.map(d=>(D[d].mess?D[d].don/D[d].mess:0)*100),chartColorPalette.getColorPair(2));
                this.updateChart(this.charts.messChart,'Gi√° Mess',l,l.map(d=>D[d].mess?D[d].cpqc/D[d].mess:0),chartColorPalette.getColorPair(3));
                this.updateChart(this.charts.cpsChart,'CPS',l,l.map(d=>D[d].don?D[d].cpqc/D[d].don:0),chartColorPalette.getColorPair(4));
                this.updateChart(this.charts.cpDsRatioChart,'%CP/DS',l,l.map(d=>(D[d].chot?D[d].cpqc/D[d].chot:0)*100),chartColorPalette.getColorPair(5));
                const pS={},mS={};d.forEach(r=>{if(r.sanPham)pS[r.sanPham]=(pS[r.sanPham]||0)+r.dsChot;if(r.thiTruong)mS[r.thiTruong]=(mS[r.thiTruong]||0)+r.dsChot;});const sP=Object.entries(pS).sort((a,b)=>b[1]-a[1]),sM=Object.entries(mS).sort((a,b)=>b[1]-a[1]);
                this.updateChart(this.charts.productSalesChart,'DS theo SP',sP.map(p=>p[0]),sP.map(p=>p[1]),chartColorPalette.getColorPair(6),'bar');
                this.updateChart(this.charts.marketSalesChart,'DS theo TT',sM.map(m=>m[0]),sM.map(m=>m[1]),chartColorPalette.getColorPair(7),'bar');},
            getLineChartConfig: function(y,f=formatUtils.formatPriceShort){return{type:'line',options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'},tooltip:{callbacks:{label:c=>`${c.dataset.label}: ${f(c.raw)}`}},datalabels:{display: false}},scales:{y:{ticks:{callback:f}}}}};},
            getBarChartConfig: function(){return{type:'bar',options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>`${c.parsed.x.toLocaleString()} VND`}},datalabels:{anchor:'end',align:'right',offset:8,color:'#333',font:{weight:'600'},formatter:formatUtils.formatPriceShort}},scales:{x:{ticks: {display: false}},y:{grid:{display:false}}}}};},
            updateChart: function(c,l,L,d,C,t='line'){c.data.labels=L;c.data.datasets=[this.createDataset(l,d,C,t)];c.update('none');},
            createDataset: function(l,d,c,t='line'){const i=t==='line';return{label:l,data:d,backgroundColor:i?c.f:c.b,borderColor:c.b,type:t,fill:i,tension:0.4,borderWidth:i?3:1,pointRadius:i?5:undefined,pointBackgroundColor:'#fff',pointBorderWidth:2,borderRadius:i?0:4};}
        };

        // ===================================================================
        // =========== MODULE CHO B√ÅO C√ÅO HI·ªÜU QU·∫¢ MKT (TAB 4) ==============
        // ===================================================================
        const mktReportApp = {
            isInitialized: false, allData: [], marketGroups: { 'Ch√¢u √Å': ['H√†n Qu·ªëc', 'Nh·∫≠t B·∫£n', 'VN'], 'Ngo√†i Ch√¢u √Å': ['√öc', 'US', 'Canada'] },
            init: function() { this.addEventListeners(); this.setDefaultDates(); this.loadData(); this.isInitialized = true; },
            addEventListeners: function() { document.getElementById('apply-filter-mkt').addEventListener('click', () => this.applyFilters()); },
            setDefaultDates: function() { const today = new Date(); const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1); document.getElementById('start-date-mkt').value = this.formatDateInput(firstDayOfMonth); document.getElementById('end-date-mkt').value = this.formatDateInput(today); },
            loadData: function() {
                const loadingElement = document.getElementById('loading-mkt'), errorElement = document.getElementById('error-message-mkt');
                if (loadingElement) loadingElement.style.display = 'block'; if (errorElement) errorElement.style.display = 'none';
                fetch('https://script.google.com/macros/s/AKfycbwGwSBxeXplEzAM-jJDPaXPkiWjNyKmpR70o6nCY5_ynqoF-3WA1gvF91RIQQfDZ9fvAQ/exec')
                    .then(res => res.json()).then(data => {
                        if (loadingElement) loadingElement.style.display = 'none';
                        this.allData = data.map(r => ({ ...r, cpqc: +r.cpqc || 0, soDon: +r.soDon || 0, dsChot: +r.dsChot || 0, soMessCmt: +r.soMessCmt || 0, team: r.team || 'Kh√°c', thiTruong: r.thiTruong || 'Kh√°c' }));
                        this.populateFilters(); this.applyFilters();
                    }).catch(err => { console.error('Error fetching Mkt data:', err); if (loadingElement) loadingElement.style.display = 'none'; if (errorElement) { errorElement.textContent = `L·ªói khi t·∫£i d·ªØ li·ªáu: ${err.message}`; errorElement.style.display = 'block'; } });
            },
            populateFilters: function() {
                const markets = [...new Set(this.allData.map(r => r.thiTruong).filter(Boolean))].sort(), teams = [...new Set(this.allData.map(r => r.team).filter(Boolean))].sort(), shifts = [...new Set(this.allData.map(r => r.ca).filter(ca => ca != null && ca !== ''))].sort((a, b) => a - b);
                const marketSelect = document.getElementById('market-filter-mkt'), teamSelect = document.getElementById('team-filter-mkt'), shiftSelect = document.getElementById('ca-filter-mkt');
                marketSelect.innerHTML = '<option value="">T·∫•t c·∫£ Th·ªã tr∆∞·ªùng</option>' + markets.map(m => `<option value="${m}">${m}</option>`).join('');
                teamSelect.innerHTML = '<option value="">T·∫•t c·∫£ Team</option>' + teams.map(t => `<option value="${t}">${t}</option>`).join('');
                shiftSelect.innerHTML = '<option value="">T·∫•t c·∫£ Ca</option>' + shifts.map(s => `<option value="${s}">${s}</option>`).join('');
            },
            applyFilters: function() {
                const startDateInput = document.getElementById('start-date-mkt').value, endDateInput = document.getElementById('end-date-mkt').value, selectedMarket = document.getElementById('market-filter-mkt').value, selectedTeam = document.getElementById('team-filter-mkt').value, selectedCa = document.getElementById('ca-filter-mkt').value;
                document.getElementById('report-date-mkt').textContent = `T·ª´ ng√†y ${formatUtils.formatDate(startDateInput)} ƒë·∫øn ng√†y ${formatUtils.formatDate(endDateInput)}`;
                const startDate = startDateInput ? new Date(startDateInput + 'T00:00:00') : null, endDate = endDateInput ? new Date(endDateInput + 'T23:59:59') : null;
                const filteredData = this.allData.filter(record => {
                    if (!record.ngay) return false; const recordDate = new Date(record.ngay); if (isNaN(recordDate.getTime())) return false;
                    const dateMatch = (!startDate || recordDate >= startDate) && (!endDate || recordDate <= endDate), marketMatch = !selectedMarket || record.thiTruong === selectedMarket, teamMatch = !selectedTeam || record.team === selectedTeam, caMatch = !selectedCa || String(record.ca) === selectedCa;
                    return dateMatch && marketMatch && teamMatch && caMatch;
                });
                this.processAndDisplayData(filteredData);
            },
            processAndDisplayData: function(data) {
                const processedData = { nonAsiaMarket: [], asiaMarket: [], summary: data };
                data.forEach(record => { let region = null; for (const group in this.marketGroups) { if (this.marketGroups[group].includes(record.thiTruong)) { region = group; break; } } if (region === 'Ngo√†i Ch√¢u √Å') processedData.nonAsiaMarket.push(record); else if (region === 'Ch√¢u √Å') processedData.asiaMarket.push(record); });
                this.displayTable(processedData.nonAsiaMarket, 'non-asia', true); this.displayTable(processedData.asiaMarket, 'asia', true); this.displayTable(processedData.summary, 'summary', false);
            },
            displayTable: function(data, prefix, showMarket) {
                let container; if (prefix === 'summary') container = document.getElementById('summary-mkt'); else container = document.getElementById(`${prefix}-market-mkt`);
                const tableBody = document.getElementById(`${prefix}-body-mkt`);
                if (container && tableBody) { if (data && data.length > 0) { container.style.display = 'block'; this.renderTable(data, tableBody, showMarket); } else { container.style.display = 'block'; tableBody.innerHTML = `<tr><td colspan="9" class="text-center">Kh√¥ng c√≥ d·ªØ li·ªáu ph√π h·ª£p v·ªõi b·ªô l·ªçc.</td></tr>`; } }
            },
            renderTable: function(data, tableBody, showMarket) {
                tableBody.innerHTML = ''; const productGroups = {};
                data.forEach(record => { const productKey = record.sanPham || 'Kh√¥ng x√°c ƒë·ªãnh', marketKey = showMarket ? (record.thiTruong || 'Kh√¥ng x√°c ƒë·ªãnh') : '_'; if (!productGroups[productKey]) productGroups[productKey] = {}; if (!productGroups[productKey][marketKey]) productGroups[productKey][marketKey] = { cpqc: 0, soDon: 0, dsChot: 0, soMessCmt: 0 }; const group = productGroups[productKey][marketKey]; group.cpqc += record.cpqc; group.soDon += record.soDon; group.dsChot += record.dsChot; group.soMessCmt += record.soMessCmt; });
                const grandTotal = { cpqc: 0, soDon: 0, dsChot: 0, soMessCmt: 0 };
                Object.keys(productGroups).sort().forEach(product => { const markets = productGroups[product], productTotal = { cpqc: 0, soDon: 0, dsChot: 0, soMessCmt: 0 }; Object.keys(markets).sort().forEach(market => { const marketData = markets[market]; tableBody.appendChild(this.createRow(product, market, marketData, showMarket)); productTotal.cpqc += marketData.cpqc; productTotal.soDon += marketData.soDon; productTotal.dsChot += marketData.dsChot; productTotal.soMessCmt += marketData.soMessCmt; }); if (showMarket && Object.keys(markets).length > 1) tableBody.appendChild(this.createRow(product, 'T·ªïng', productTotal, showMarket, 'highlight')); grandTotal.cpqc += productTotal.cpqc; grandTotal.soDon += productTotal.soDon; grandTotal.dsChot += productTotal.dsChot; grandTotal.soMessCmt += productTotal.soMessCmt; });
                if (Object.keys(productGroups).length > 0) tableBody.appendChild(this.createRow('T·ªîNG C·ªòNG', '', grandTotal, showMarket, 'total-row'));
            },
            createRow: function(productName, marketName, data, showMarket, className = '') {
                const tr = document.createElement('tr'); if (className) tr.className = className;
                const costPercent = data.dsChot ? data.cpqc / data.dsChot : 0, cps = data.soDon ? data.cpqc / data.soDon : 0, avgOrderValue = data.soDon ? data.dsChot / data.soDon : 0, closingRate = data.soMessCmt ? data.soDon / data.soMessCmt : 0;
                const rateClass = closingRate > 0.1 ? 'bg-green' : (closingRate > 0.05 ? 'bg-yellow' : '');
                let html = `<td class="text-left">${productName}</td><td class="text-left">${marketName}</td><td>${formatUtils.formatCurrency(data.cpqc)}</td><td class="text-center">${formatUtils.formatNumber(data.soDon)}</td><td>${formatUtils.formatCurrency(data.dsChot)}</td><td class="text-center">${formatUtils.formatPercent(costPercent)}</td><td>${formatUtils.formatCurrency(cps)}</td><td>${formatUtils.formatCurrency(avgOrderValue)}</td><td class="text-center ${rateClass}">${formatUtils.formatPercent(closingRate)}</td>`;
                tr.innerHTML = html; return tr;
            },
            formatDateInput: function(date) { const year = date.getFullYear(), month = String(date.getMonth() + 1).padStart(2, '0'), day = String(date.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; }
        };

        // ===================================================================
        // =========== MODULE CHO B√ÅO C√ÅO NH√ÇN S·ª∞ (TAB 5) ====================
        // ===================================================================
        const staffReportApp = {
            isInitialized: false, 
            allData: [], 
            charts: {}, 
            fullReportData: [],
            currentTeamMembers: [], 
            currentDailyData: {},

            init: function() { this.addEventListeners(); this.setDefaultDates(); this.fetchData(); this.isInitialized = true; },
            
            addEventListeners: function() {
                document.getElementById('team-filter-staff').addEventListener('change', () => this.updateStaffFilter());
                document.getElementById('apply-filter-staff').addEventListener('click', () => this.applyFilters());
                document.getElementById('staff-summary-container').addEventListener('click', (e) => { const staffRow = e.target.closest('.clickable-staff-row'); if (staffRow) { this.handleStaffRowClick(staffRow); } else { this.handleTableSort(e, 'staff-summary-table'); } });
                document.getElementById('daily-breakdown-table-wrapper').addEventListener('click', (e) => { const summaryRow = e.target.closest('.daily-summary-row'); const header = e.target.closest('.sortable-header'); if (summaryRow && !header) { this.toggleDayDetails(summaryRow); } else if (header) { const nestedTable = header.closest('.nested-table-container'); if (nestedTable) { this.handleTableSort(e, 'nested', nestedTable.dataset.date); } else { this.handleTableSort(e, 'daily-breakdown'); } } });
            },

            setChartVisibility: function({ doughnut, line, combo }) {
                document.querySelector('#StaffReport .chart-container[data-chart="doughnut"]').style.display = doughnut ? 'block' : 'none';
                document.querySelector('#StaffReport .chart-container[data-chart="line"]').style.display = line ? 'block' : 'none';
                document.querySelector('#StaffReport .chart-container[data-chart="combo"]').style.display = combo ? 'block' : 'none';
            },
            
            handleStaffRowClick: function(row) {
                const staffName = row.dataset.staffName; if (!staffName) return;
                showLoader();
                setTimeout(() => {
                    document.querySelectorAll('#staff-summary-table .clickable-staff-row').forEach(r => r.classList.remove('highlighted-row'));
                    row.classList.add('highlighted-row');
                    const staffData = this.fullReportData.filter(r => r.ten === staffName);
                    this.setChartVisibility({ doughnut: false, line: true, combo: true }); // RULE 1
                    this.renderIndividualCharts(staffData);
                    document.getElementById('charts-container-staff').scrollIntoView({ behavior: 'smooth', block: 'center' });
                    hideLoader();
                }, 10);
            },

            toggleDayDetails: function(summaryRow) {
                const dateKey = summaryRow.dataset.date;
                const detailsRow = document.querySelector(`#StaffReport .details-container-row[data-date='${dateKey}']`);
                const isExpanded = summaryRow.classList.toggle('expanded');
                if (isExpanded) {
                    this.setChartVisibility({ doughnut: true, line: false, combo: false }); // RULE 2
                    detailsRow.style.display = 'table-row';
                    if (!detailsRow.querySelector('td').innerHTML) { this.renderNestedTable(detailsRow.querySelector('td'), dateKey, this.currentDailyData[dateKey].members); }
                    this.updateDoughnutChart('daily', this.currentDailyData[dateKey].members, dateKey);
                    document.querySelector('#StaffReport .chart-container[data-chart="doughnut"]').scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else {
                    this.setChartVisibility({ doughnut: true, line: false, combo: false }); // RULE 2 (COLLAPSE)
                    detailsRow.style.display = 'none';
                    this.updateDoughnutChart('overall', this.fullReportData);
                }
            },
            
            fetchData: function() {
                showLoader();
                fetch('https://script.google.com/macros/s/AKfycbwGwSBxeXplEzAM-jJDPaXPkiWjNyKmpR70o6nCY5_ynqoF-3WA1gvF91RIQQfDZ9fvAQ/exec')
                .then(res => res.json())
                .then(data => {
                    const startOfToday = new Date(); startOfToday.setHours(0, 0, 0, 0);
                    this.allData = data.filter(r => r.ngay && new Date(r.ngay) < startOfToday)
                                       .map(r => ({ ...r, team: String(r.team || 'Kh√°c').trim(), ten: String(r.ten || 'N/A').trim(), soMessCmt: +r.soMessCmt || 0, soDon: +r.soDon || 0, dsChot: +r.dsChot || 0, cpqc: +r.cpqc || 0 }));
                    this.populateTeamFilter(); this.updateStaffFilter(); this.initCharts();
                }).catch(err => { console.error("L·ªói Staff Data:", err); document.getElementById('staff-placeholder').innerHTML = `<p style="color: red;">L·ªói: Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu.<br>H√£y ki·ªÉm tra k·∫øt n·ªëi m·∫°ng v√† th·ª≠ l·∫°i.</p>`; }).finally(hideLoader);
            },
            
            applyFilters: function() {
                showLoader();
                setTimeout(() => { 
                    const startDateInput = document.getElementById('start-date-staff').value, 
                          endDateInput = document.getElementById('end-date-staff').value, 
                          selectedTeams = Array.from(document.getElementById('team-filter-staff').selectedOptions).map(opt => opt.value), 
                          selectedTarget = document.getElementById('staff-filter-staff').value;
                          
                    const placeholder = document.getElementById('staff-placeholder'), 
                          resultsContainer = document.getElementById('staff-results-container'), 
                          dailyComparisonContainer = document.getElementById('daily-comparison-container');
                          
                    if (selectedTeams.length === 0 || !selectedTarget) { 
                        placeholder.style.display = 'block'; 
                        resultsContainer.style.display = 'none'; 
                        hideLoader(); 
                        return; 
                    }
                    
                    // *** UPDATED DATE FILTERING LOGIC ***
                    const startDateObj = startDateInput ? new Date(startDateInput) : null;
                    const endDateObj = endDateInput ? new Date(endDateInput) : null;
                    if (startDateObj) startDateObj.setHours(0, 0, 0, 0); // Set to start of day
                    if (endDateObj) endDateObj.setHours(23, 59, 59, 999); // Set to end of day

                    const dateFilteredData = this.allData.filter(r => {
                        if (!r.ngay) return false;
                        const recordDate = new Date(r.ngay);
                        if (isNaN(recordDate.getTime())) return false; // Check for invalid date
                        
                        const isAfterStart = !startDateObj || recordDate >= startDateObj;
                        const isBeforeEnd = !endDateObj || recordDate <= endDateObj;
                        return isAfterStart && isBeforeEnd;
                    });
                    // *** END OF UPDATED LOGIC ***

                    const isFullTeamView = selectedTarget === '__FULL_TEAM__';

                    if (isFullTeamView) {
                        this.currentTeamMembers = [...new Set(this.allData.filter(r => selectedTeams.includes(r.team)).map(r => r.ten))].sort();
                        this.fullReportData = dateFilteredData.filter(r => selectedTeams.includes(r.team));
                    } else {
                        this.currentTeamMembers = [];
                        this.fullReportData = dateFilteredData.filter(r => r.ten === selectedTarget);
                    }

                    if ( (isFullTeamView && this.currentTeamMembers.length === 0) || (!isFullTeamView && this.fullReportData.length === 0 && selectedTarget) ) { 
                        placeholder.style.display = 'block'; 
                        placeholder.innerHTML = `<p>Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu cho l·ª±a ch·ªçn c·ªßa b·∫°n.</p>`; 
                        resultsContainer.style.display = 'none'; 
                    } else { 
                        const reportTitle = isFullTeamView ? `B√°o c√°o Team: ${selectedTeams.join(', ')}` : `B√°o c√°o chi ti·∫øt: ${selectedTarget}`;
                        placeholder.style.display = 'none'; 
                        resultsContainer.style.display = 'block'; 
                        document.getElementById('staff-report-title').textContent = reportTitle;
                        
                        this.updateChartVisibility(isFullTeamView);
                        
                        this.renderSummaryTable(this.fullReportData, isFullTeamView, this.currentTeamMembers);
                        this.renderDailyBreakdownTable(this.fullReportData, isFullTeamView);
                        
                        if (isFullTeamView) { 
                            dailyComparisonContainer.style.display = 'block'; 
                            this.renderTeamTrendChart(this.fullReportData); 
                            this.renderTeamCharts(this.fullReportData); 
                        } else { 
                            dailyComparisonContainer.style.display = 'none'; 
                            this.renderIndividualCharts(this.fullReportData); 
                        }
                    }
                    hideLoader();
                }, 10);
            },
            
            calculateMetrics: (dataset) => { const totals = dataset.reduce((acc, r) => { acc.mess += r.soMessCmt; acc.don += r.soDon; acc.chot += r.dsChot; acc.cpqc += r.cpqc; return acc; }, { mess: 0, don: 0, chot: 0, cpqc: 0 }); return { ...totals, tiLeChot: totals.mess ? totals.don / totals.mess : 0, giaMess: totals.mess ? totals.cpqc / totals.mess : 0, cps: totals.don ? totals.cpqc / totals.don : 0, cpDsRatio: totals.chot ? totals.cpqc / totals.chot : 0, giaTbDon: totals.don ? totals.chot / totals.don : 0, }; },
            
            initCharts: function() {
                Chart.register(ChartDataLabels);
                Object.values(this.charts).forEach(c => c.destroy && c.destroy());
                const baseOptions = { responsive: true, maintainAspectRatio: false };
                this.charts.doughnut = new Chart(document.getElementById('teamDoughnutChart'), { type: 'doughnut', data: { datasets: [{ backgroundColor: chartColorPalette.border }] }, options: { ...baseOptions, cutout: '70%', plugins: { legend: { position: 'bottom' }, datalabels: { color: '#fff', font: { weight: 'bold' }, formatter: (v, ctx) => { const sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0); return sum > 0 ? `${((v / sum) * 100).toFixed(0)}%` : '0%'; } } } } });
                this.charts.line = new Chart(document.getElementById('staffLineChart'), { type: 'line', data: {}, options: { ...baseOptions, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } } });
                this.charts.combo = new Chart(document.getElementById('staffComboChart'), { type: 'bar', data: {}, options: { ...baseOptions, scales: { y: { type: 'linear', position: 'left', title: { display: true, text: 'Doanh s·ªë' } }, y1: { type: 'linear', position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: 'T·ªâ l·ªá ch·ªët (%)' } } } } });
                this.charts.teamTrend = new Chart(document.getElementById('teamDailyTrendChart'), { type: 'line', data: {}, options: { ...baseOptions, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (ctx) => `DS Ch·ªët: ${formatUtils.formatCurrency(ctx.raw)}` } } }, scales: { y: { ticks: { callback: (val) => new Intl.NumberFormat('vi-VN', { notation: "compact", maximumFractionDigits: 1 }).format(val) } } } } });
            },
            
            updateChartVisibility: function(isFullTeamView) {
                if (isFullTeamView) {
                    this.setChartVisibility({ doughnut: true, line: false, combo: false });
                } else {
                    this.setChartVisibility({ doughnut: false, line: true, combo: true });
                }
            },

            renderTeamCharts: function(data) { this.updateDoughnutChart('overall', data); },
            updateDoughnutChart: function(mode, data, dateKey = null) {
                if (!this.charts.doughnut) return; let memberMetrics;
                const titleEl = document.getElementById('doughnut-chart-title');
                const iconEl = titleEl.querySelector('i');
                if (mode === 'daily') { memberMetrics = Object.entries(data).map(([name, records]) => ({ name, metrics: this.calculateMetrics(records) })); titleEl.innerHTML = `<i class="fas fa-search-dollar" style="color: ${chartColorPalette.border[3]};"></i> Ph√¢n t√≠ch DS Ch·ªët ng√†y ${formatUtils.formatDate(dateKey)}`; } 
                else { memberMetrics = Object.entries(data.reduce((acc, r) => { (acc[r.ten] = acc[r.ten] || []).push(r); return acc; }, {})).map(([name, records]) => ({ name, metrics: this.calculateMetrics(records) })); titleEl.innerHTML = `<i class="fas fa-chart-pie" style="color: ${chartColorPalette.border[4]};"></i>T·ªâ L·ªá ƒê√≥ng G√≥p Doanh S·ªë`; }
                memberMetrics = memberMetrics.filter(item => item.metrics.chot > 0).sort((a, b) => b.metrics.chot - a.metrics.chot);
                const chart = this.charts.doughnut; chart.data.labels = memberMetrics.map(m => m.name); chart.data.datasets[0].data = memberMetrics.map(m => m.metrics.chot); chart.data.datasets[0].backgroundColor = chartColorPalette.border; chart.update();
            },
            
            renderTeamTrendChart: function(data) { 
                const dailyData = data.reduce((acc, r) => { const date = formatUtils.formatDate(r.ngay); if (!acc[date]) acc[date] = { dsChot: 0, dateObj: new Date(r.ngay) }; acc[date].dsChot += r.dsChot; return acc; }, {}); 
                const sortedDailyData = Object.entries(dailyData).sort(([, a], [, b]) => a.dateObj - b.dateObj); 
                const colorPair = chartColorPalette.getColorPair(0);
                this.charts.teamTrend.data.labels = sortedDailyData.map(([date]) => date); 
                this.charts.teamTrend.data.datasets = [{ label: 'T·ªïng DS Ch·ªët', data: sortedDailyData.map(([, data]) => data.dsChot), borderColor: colorPair.b, backgroundColor: colorPair.f, fill: true, tension: 0.3 }]; 
                this.charts.teamTrend.update(); 
            },
            
            renderSummaryTable: function(data, isFullTeamView, allStaffInTeam = [], sortKey = 'chot', sortDir = 'desc') {
                const table = document.getElementById('staff-summary-table');
                const createRowHtml = (metrics, label, staffName, rowClass) => { const rateClass = metrics.tiLeChot > 0.1 ? 'bg-green' : (metrics.tiLeChot > 0.05 ? 'bg-yellow' : ''); return `<tr class="${rowClass}" data-staff-name="${staffName || ''}"><td>${label}</td><td>${formatUtils.formatNumber(metrics.mess)}</td><td>${formatUtils.formatCurrency(metrics.cpqc)}</td><td>${formatUtils.formatNumber(metrics.don)}</td><td>${formatUtils.formatCurrency(metrics.chot)}</td><td class="${rateClass}">${formatUtils.formatPercent(metrics.tiLeChot)}</td><td>${formatUtils.formatCurrency(metrics.giaMess)}</td><td>${formatUtils.formatCurrency(metrics.cps)}</td><td>${formatUtils.formatPercent(metrics.cpDsRatio)}</td><td>${formatUtils.formatCurrency(metrics.giaTbDon)}</td></tr>`; };
                const headerHtml = `<thead><tr><th class="sortable-header" data-sort="name">Th√†nh vi√™n</th><th class="sortable-header" data-sort="mess">S·ªë Mess</th><th class="sortable-header" data-sort="cpqc">CPQC</th><th class="sortable-header" data-sort="don">S·ªë ƒê∆°n</th><th class="sortable-header" data-sort="chot">DS Ch·ªët</th><th class="sortable-header" data-sort="tiLeChot">T·ªâ l·ªá ch·ªët</th><th class="sortable-header" data-sort="giaMess">Gi√° Mess</th><th class="sortable-header" data-sort="cps">CPS</th><th class="sortable-header" data-sort="cpDsRatio">%CP/DS</th><th class="sortable-header" data-sort="giaTbDon">Gi√° TB ƒê∆°n</th></tr></thead>`;
                let bodyHtml = '';

                if (isFullTeamView) {
                    const memberPerformanceData = data.reduce((acc, r) => { (acc[r.ten] = acc[r.ten] || []).push(r); return acc; }, {});
                    const zeroMetrics = { mess: 0, don: 0, chot: 0, cpqc: 0, tiLeChot: 0, giaMess: 0, cps: 0, cpDsRatio: 0, giaTbDon: 0 };
                    
                    let memberMetrics = allStaffInTeam.map(staffName => {
                        const performanceRecords = memberPerformanceData[staffName];
                        const metrics = performanceRecords ? this.calculateMetrics(performanceRecords) : { ...zeroMetrics };
                        return { name: staffName, metrics: metrics };
                    });

                    memberMetrics.sort((a, b) => { const valA = sortKey === 'name' ? a.name : a.metrics[sortKey]; const valB = sortKey === 'name' ? b.name : b.metrics[sortKey]; if (typeof valA === 'string') return sortDir === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA); return sortDir === 'asc' ? valA - valB : valB - valA; });
                    
                    let memberRowsHtml = memberMetrics.map(item => createRowHtml(item.metrics, item.name, item.name, 'clickable-staff-row')).join('');
                    const totalMetrics = this.calculateMetrics(data);
                    bodyHtml = `<tbody>${createRowHtml(totalMetrics, 'T·ªîNG C·ªòNG TEAM', '', 'total-row')}${memberRowsHtml}</tbody>`; 
                } else {
                    const metrics = this.calculateMetrics(data); 
                    bodyHtml = `<tbody>${createRowHtml(metrics, data[0]?.ten || 'T·ªïng c·ªông', '', '')}</tbody>`; 
                }
                table.innerHTML = headerHtml + bodyHtml; 
                table.querySelector(`#StaffReport th[data-sort="${sortKey}"]`)?.classList.add(sortDir === 'desc' ? 'sorted-desc' : 'sorted-asc');
            },
            
            renderDailyBreakdownTable: function(data, isFullTeamView, sortKey = 'dateObj', sortDir = 'desc') {
                const wrapper = document.getElementById('daily-breakdown-table-wrapper');
                const createHeader = (isTeamView) => `<thead><tr><th class="sortable-header" data-sort="dateObj">${isTeamView ? 'Ng√†y' : 'Ng√†y'}</th><th class="sortable-header" data-sort="chot">DS Ch·ªët</th><th class="sortable-header" data-sort="don">S·ªë ƒê∆°n</th><th class="sortable-header" data-sort="mess">S·ªë Mess</th><th class="sortable-header" data-sort="tiLeChot">T·ªâ l·ªá ch·ªët</th><th class="sortable-header" data-sort="cpqc">CPQC</th><th class="sortable-header" data-sort="cps">CPS</th></tr></thead>`;
                const createRowContent = (metrics) => { const rateClass = metrics.tiLeChot > 0.1 ? 'bg-green' : (metrics.tiLeChot > 0.05 ? 'bg-yellow' : ''); return `<td>${formatUtils.formatCurrency(metrics.chot)}</td><td>${formatUtils.formatNumber(metrics.don)}</td><td>${formatUtils.formatNumber(metrics.mess)}</td><td class="${rateClass}">${formatUtils.formatPercent(metrics.tiLeChot)}</td><td>${formatUtils.formatCurrency(metrics.cpqc)}</td><td>${formatUtils.formatCurrency(metrics.cps)}</td>`; };
                const dailyGroupedData = data.reduce((acc, r) => { const dateKey = new Date(r.ngay).toISOString().split('T')[0]; if (!acc[dateKey]) acc[dateKey] = { members: {}, dateObj: new Date(r.ngay) }; if (!acc[dateKey].members[r.ten]) acc[dateKey].members[r.ten] = []; acc[dateKey].members[r.ten].push(r); return acc; }, {});
                this.currentDailyData = dailyGroupedData; let dailyArray = Object.entries(dailyGroupedData).map(([dateKey, value]) => ({ dateKey, dateObj: value.dateObj, metrics: this.calculateMetrics(Object.values(value.members).flat()) }));
                dailyArray.sort((a, b) => { const valA = sortKey === 'dateObj' ? a.dateObj.getTime() : a.metrics[sortKey]; const valB = sortKey === 'dateObj' ? b.dateObj.getTime() : b.metrics[sortKey]; return sortDir === 'desc' ? valB - valA : valA - valB; });
                let bodyHtml = dailyArray.map(item => { const rowHtml = `<tr class="daily-summary-row" data-date="${item.dateKey}"><td><i class="fas fa-chevron-right expand-icon"></i> ${formatUtils.formatDate(item.dateKey)}</td>${createRowContent(item.metrics)}</tr>`; const detailsRow = `<tr class="details-container-row" data-date="${item.dateKey}"><td colspan="7"></td></tr>`; return isFullTeamView ? rowHtml + detailsRow : rowHtml.replace('<tr class="daily-summary-row"', '<tr'); }).join('');
                wrapper.innerHTML = `<table>${createHeader(isFullTeamView)}<tbody>${bodyHtml}</tbody></table>`; wrapper.querySelector(`#StaffReport th[data-sort="${sortKey}"]`)?.classList.add(sortDir === 'desc' ? 'sorted-desc' : 'sorted-asc');
            },
            
            renderNestedTable: function(container, dateKey, memberData, sortKey = 'chot', sortDir = 'desc') {
                const createNestedHeader = () => `<thead><tr><th class="sortable-header" data-sort="name">Th√†nh vi√™n</th><th class="sortable-header" data-sort="chot">DS Ch·ªët</th><th class="sortable-header" data-sort="don">S·ªë ƒê∆°n</th><th class="sortable-header" data-sort="tiLeChot">T·ªâ l·ªá ch·ªët</th></tr></thead>`;
                const createNestedRow = (metrics, name) => { const rateClass = metrics.tiLeChot > 0.1 ? 'bg-green' : (metrics.tiLeChot > 0.05 ? 'bg-yellow' : ''); return `<td>${name}</td><td>${formatUtils.formatCurrency(metrics.chot)}</td><td>${formatUtils.formatNumber(metrics.don)}</td><td class="${rateClass}">${formatUtils.formatPercent(metrics.tiLeChot)}</td>`; };
                let memberArray = Object.entries(memberData).map(([name, records]) => ({ name, metrics: this.calculateMetrics(records) }));
                memberArray.sort((a, b) => { const valA = sortKey === 'name' ? a.name : a.metrics[sortKey]; const valB = sortKey === 'name' ? b.name : b.metrics[sortKey]; if (typeof valA === 'string') return sortDir === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA); return sortDir === 'asc' ? valA - valB : valB - valA; });
                const bodyHtml = memberArray.map(item => `<tr>${createNestedRow(item.metrics, item.name)}</tr>`).join('');
                container.innerHTML = `<div class="nested-table-container" data-date="${dateKey}"><table>${createNestedHeader()}<tbody>${bodyHtml}</tbody></table></div>`; container.querySelector(`#StaffReport th[data-sort="${sortKey}"]`)?.classList.add(sortDir === 'desc' ? 'sorted-desc' : 'sorted-asc');
            },
            
            handleTableSort: function(event, tableType, dateKey = null) { 
                const header = event.target.closest('.sortable-header'); if (!header) return; 
                const sortKey = header.dataset.sort; if (!sortKey) return; 
                let currentSortDir = 'desc'; 
                if (header.classList.contains('sorted-desc')) { currentSortDir = 'asc'; } 
                showLoader(); 
                setTimeout(() => { 
                    if (tableType === 'staff-summary-table') { 
                        this.renderSummaryTable(this.fullReportData, true, this.currentTeamMembers, sortKey, currentSortDir); 
                    } else if (tableType === 'daily-breakdown') { 
                        this.renderDailyBreakdownTable(this.fullReportData, true, sortKey, currentSortDir); 
                    } else if (tableType === 'nested' && dateKey) { 
                        const detailsRow = document.querySelector(`#StaffReport .details-container-row[data-date='${dateKey}'] td`); 
                        this.renderNestedTable(detailsRow, dateKey, this.currentDailyData[dateKey].members, sortKey, currentSortDir); 
                    } 
                    hideLoader(); 
                }, 10); 
            },
            
            renderIndividualCharts: function(data) { 
                const dailyData = Object.entries(data.reduce((acc,r) => { const date = formatUtils.formatDate(r.ngay); if (!acc[date]) acc[date] = { mess: 0, don: 0, chot: 0, dateObj: new Date(r.ngay) }; acc[date].chot += r.dsChot; acc[date].don += r.soDon; acc[date].mess += r.soMessCmt; return acc; }, {})).sort((a,b) => a[1].dateObj - b[1].dateObj).reduce((acc,[key,val]) => ({...acc, [key]:val}), {}); 
                const sortedDates = Object.keys(dailyData);
                const lineCP = chartColorPalette.getColorPair(1);
                const barCP = chartColorPalette.getColorPair(2);
                const comboLineCP = chartColorPalette.getColorPair(3);
                
                document.querySelector('#StaffReport .chart-container[data-chart="line"] i').style.color = lineCP.b;
                document.querySelector('#StaffReport .chart-container[data-chart="combo"] i').style.color = barCP.b;

                this.charts.line.data.labels = sortedDates; 
                this.charts.line.data.datasets = [{ label: 'DS Ch·ªët', data: sortedDates.map(d => dailyData[d].chot), borderColor: lineCP.b, backgroundColor: lineCP.f, fill: true, tension: 0.3 }]; 
                this.charts.line.update(); 
                
                this.charts.combo.data.labels = sortedDates; 
                this.charts.combo.data.datasets = [ 
                    { type: 'bar', label: 'Doanh s·ªë', data: sortedDates.map(d => dailyData[d].chot), backgroundColor: barCP.b, yAxisID: 'y' }, 
                    { type: 'line', label: 'T·ªâ l·ªá ch·ªët', data: sortedDates.map(d => (dailyData[d].mess > 0 ? dailyData[d].don / dailyData[d].mess : 0)), borderColor: comboLineCP.b, backgroundColor: comboLineCP.f, tension: 0.3, yAxisID: 'y1' } 
                ]; 
                this.charts.combo.options.scales.y1.ticks = { callback: value => `${(value * 100).toFixed(0)}%` }; 
                this.charts.combo.update(); 
            },
        
            populateTeamFilter: function() { const teams = [...new Set(this.allData.map(r => r.team))].sort(); document.getElementById('team-filter-staff').innerHTML = teams.map(t => `<option value="${t}">${t}</option>`).join(''); },
            updateStaffFilter: function() { const selectedTeams = Array.from(document.getElementById('team-filter-staff').selectedOptions).map(opt => opt.value); const staffSelect = document.getElementById('staff-filter-staff'); staffSelect.innerHTML = ''; if (selectedTeams.length === 0) { staffSelect.innerHTML = '<option value="">-- Vui l√≤ng ch·ªçn Team --</option>'; return; } staffSelect.innerHTML = '<option value="__FULL_TEAM__">-- XEM B√ÅO C√ÅO TO√ÄN TEAM --</option>'; const staffInTeams = this.allData.filter(r => selectedTeams.includes(r.team)); const staffNames = [...new Set(staffInTeams.map(r => r.ten))].sort(); staffSelect.innerHTML += staffNames.map(name => `<option value="${name}">${name}</option>`).join(''); },
            setDefaultDates: function() { const today = new Date(); const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1); const formatDate = d => d.toISOString().split('T')[0]; document.getElementById('start-date-staff').value = formatDate(firstDayOfMonth); document.getElementById('end-date-staff').value = formatDate(today); },
        };

        document.getElementById("defaultOpen").click();
    });
</script>
</body>
</html>


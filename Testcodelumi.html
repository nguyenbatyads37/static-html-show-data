<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Báo cáo chi phí tổng hợp</title>
  <style>
    /* --- CÀI ĐẶT CHUNG & TABS --- */
    body { font-family: Arial, sans-serif; padding: 20px; background-color: #f4f4f4; }
    .tab-container { overflow: hidden; border-bottom: 2px solid #ccc; margin-bottom: 20px; }
    .tab-container button {
      background-color: #f1f1f1; float: left; border: none; outline: none; cursor: pointer;
      padding: 14px 20px; transition: 0.3s; font-size: 17px; font-weight: bold;
      border-radius: 8px 8px 0 0; margin-right: 5px;
    }
    .tab-container button:hover { background-color: #ddd; }
    .tab-container button.active { background-color: #2d7c2d; color: white; }
    .tab-content { display: none; padding: 6px 12px; border-top: none; }

    /* --- STYLES CHUNG CHO BẢNG --- */
    table { width: 100%; border-collapse: collapse; table-layout: auto; /* Cho phép tự điều chỉnh độ rộng */ margin-top: 20px; background: #fff; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; white-space: nowrap; /* Giữ nội dung trên 1 hàng trừ khi quá dài */ }
    th.green-header { background: #a5d6a7; }
    th.yellow-header { background: #fff59d; }
    tr.total-row { background: #f1f1f1; font-weight: bold; }
    
    /* --- STYLES TAB 1: BÁO CÁO CHI TIẾT --- */
    .report-container { display: flex; }
    .sidebar { width: 260px; flex-shrink: 0; border: 1px solid #ccc; padding: 10px; background: #f9f9f9; box-sizing: border-box; }
    .sidebar h3 { background: #2d7c2d; color: #fff; padding: 5px; margin-top: 10px; font-size: 16px; }
    .sidebar label { display: block; margin: 6px 0; font-size: 14px; }
    .sidebar .indent { margin-left: 16px; }
    .sidebar input[type="date"] { width: 100%; box-sizing: border-box; padding: 4px; margin: 4px 0 10px; }
    .main-detailed { flex-grow: 1; margin-left: 20px; }
    .header { display: flex; align-items: center; margin-bottom: 10px; }
    .header img { height: 60px; margin-right: 10px; }
    .header h2 { margin: 0; color: #2d7c2d; }
    #kpi-summary-table { margin-top: 30px; }
    .daily-breakdown h3 { margin-top: 20px; background: #f0f0f0; padding: 8px; border: 1px solid #ccc; }

    /* --- STYLES TAB 2: BÁO CÁO THEO NGÀY --- */
    .daily-report-layout { display: flex; gap: 20px; }
    .daily-report-layout .sidebar { width: 260px; }
    .daily-report-layout .main-content { flex-grow: 1; }
    .main-daily h2 { color: #2d7c2d; text-align: center; margin-bottom: 10px; }
    .chart-toggle-controls { margin: 20px 0; padding: 10px; background: #eee; border-radius: 8px; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }
    .chart-toggle-controls label { font-size: 14px; }
    .chart-toggle-controls .toggle-all { font-weight: bold; }
    .charts-container { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }
    .chart-wrapper { flex: 1 1 48%; min-width: 400px; background: #fff; padding: 15px; border-radius: 12px; box-shadow: 0 6px 12px rgba(0,0,0,0.1); }
    .chart-wrapper canvas { width: 100% !important; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
</head>
<body>

  <div class="tab-container">
    <button class="tablinks" onclick="openTab(event, 'DetailedReport')" id="defaultOpen">Báo cáo chi tiết</button>
    <button class="tablinks" onclick="openTab(event, 'DailyReport')">Báo cáo theo ngày</button>
  </div>

  <!-- NỘI DUNG TAB 1 -->
  <div id="DetailedReport" class="tab-content">
    <div class="report-container">
        <div class="sidebar">
          <h3>Ngày</h3>
          <label>Từ ngày:<input type="date" id="start-date-tab1"></label>
          <label>Đến ngày:<input type="date" id="end-date-tab1"></label>
          <h3>Sản phẩm</h3>
          <label><input type="checkbox" id="product-all-tab1" checked> Tất cả</label>
          <div id="product-options-tab1"></div>
          <h3>Ca</h3>
          <label><input type="checkbox" id="ca-all-tab1" checked> Tất cả</label>
          <div id="ca-options-tab1"></div>
          <h3>Team</h3>
          <label><input type="checkbox" id="team-all-tab1" checked> Tất cả</label>
          <div id="team-options-tab1"></div>
          <h3>Thị trường</h3>
          <label><input type="checkbox" id="market-all-tab1" checked> Tất cả</label>
          <div id="market-options-tab1"></div>
        </div>
        <div class="main-detailed">
          <div class="header">
            <img src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Ff930e667.%E1%BA%A2nh.025539.jpg" alt="Logo">
            <h2>DỮ LIỆU CHI PHÍ ADS</h2>
          </div>
          <table id="summary-table">
            <thead>
              <tr>
                <th class="green-header">Nhân sự</th><th class="green-header">Mess+Cmt</th><th class="green-header">Đơn</th>
                <th class="green-header">DS Chốt</th><th class="green-header">CPQC</th><th class="yellow-header">Tỉ lệ chốt</th>
                <th class="yellow-header">Giá Mess</th><th class="yellow-header">CPS</th><th class="yellow-header">CPQC/DS chốt</th>
                <th class="yellow-header">Giá đơn hàng</th>
              </tr>
            </thead>
            <tbody id="summary-body"></tbody><tfoot id="summary-foot"></tfoot>
          </table>
          <table id="kpi-summary-table">
              <thead>
                  <tr>
                      <th class="green-header" style="width: 5%;">STT</th><th class="green-header">MKT</th><th class="green-header">CPQC</th>
                      <th class="green-header">Doanh số thực</th><th class="green-header">DS đã đi</th><th class="green-header">DS thành công</th>
                      <th class="green-header">DS sau ship</th><th class="yellow-header">% CP/DS</th><th class="yellow-header">% KPI</th>
                  </tr>
              </thead>
              <tbody id="kpi-summary-body"></tbody><tfoot id="kpi-summary-foot"></tfoot>
          </table>
          <div id="daily-breakdown"></div>
        </div>
    </div>
  </div>

  <!-- NỘI DUNG TAB 2 -->
  <div id="DailyReport" class="tab-content">
    <div class="main-daily">
      <h2>Báo cáo hiệu suất theo ngày</h2>
      <div class="daily-report-layout">
        <div class="sidebar">
          <h3>Ngày</h3>
          <label>Từ ngày:<input type="date" id="start-date-tab2"></label>
          <label>Đến ngày:<input type="date" id="end-date-tab2"></label>
          <h3>Sản phẩm</h3>
          <label><input type="checkbox" id="product-all-tab2" checked> Tất cả</label>
          <div id="product-options-tab2"></div>
          <h3>Thị trường</h3>
          <label><input type="checkbox" id="market-all-tab2" checked> Tất cả</label>
          <div id="market-options-tab2"></div>
        </div>
        <div class="main-content">
          <table id="date-summary-table">
            <thead>
              <tr>
                <th>Ngày</th><th>Tổng CPQC</th><th>DS Chốt</th><th>Tỉ lệ chốt TB</th>
                <th>Giá Mess</th><th>CPS</th><th>%CPQC/DS chốt</th>
              </tr>
            </thead>
            <tbody id="date-summary-body"></tbody>
          </table>
          <div class="chart-toggle-controls">
              <label class="toggle-all"><input type="checkbox" id="toggle-all-charts" checked> Chọn/Bỏ chọn tất cả</label>
              <label><input type="checkbox" class="chart-toggle" data-chart="cpqcChart" checked> CPQC</label>
              <label><input type="checkbox" class="chart-toggle" data-chart="dsChotChart" checked> DS Chốt</label>
              <label><input type="checkbox" class="chart-toggle" data-chart="rateChart" checked> Tỉ lệ chốt</label>
              <label><input type="checkbox" class="chart-toggle" data-chart="messChart" checked> Giá Mess</label>
              <label><input type="checkbox" class="chart-toggle" data-chart="cpsChart" checked> CPS</label>
              <label><input type="checkbox" class="chart-toggle" data-chart="cpqcDsRatioChart" checked> %CPQC/DS chốt</label>
              <label><input type="checkbox" class="chart-toggle" data-chart="productSalesChart" checked> DS theo SP</label>
              <label><input type="checkbox" class="chart-toggle" data-chart="marketSalesChart" checked> DS theo TT</label>
          </div>
          <div class="charts-container">
            <div class="chart-wrapper" data-chart="cpqcChart"><canvas id="cpqcChart"></canvas></div>
            <div class="chart-wrapper" data-chart="dsChotChart"><canvas id="dsChotChart"></canvas></div>
            <div class="chart-wrapper" data-chart="rateChart"><canvas id="rateChart"></canvas></div>
            <div class="chart-wrapper" data-chart="messChart"><canvas id="messChart"></canvas></div>
            <div class="chart-wrapper" data-chart="cpsChart"><canvas id="cpsChart"></canvas></div>
            <div class="chart-wrapper" data-chart="cpqcDsRatioChart"><canvas id="cpqcDsRatioChart"></canvas></div>
            <div class="chart-wrapper" data-chart="productSalesChart"><canvas id="productSalesChart"></canvas></div>
            <div class="chart-wrapper" data-chart="marketSalesChart"><canvas id="marketSalesChart"></canvas></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- BIẾN TOÀN CỤC VÀ KHAI BÁO ---
    let rawData = [];
    const groupChildren = {
      'Châu Á': ['Hàn Quốc','Nhật Bản','VN'],
      'Ngoài Châu Á': ['Úc','US'],
      'EU': ['Anh','Đức']
    };
    let charts = {}; // Object to hold all chart instances

    // --- LOGIC CHUNG ---
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById("defaultOpen").click();
      addEventListeners();
      fetchData();
    });

    function openTab(evt, tabName) {
      document.querySelectorAll(".tab-content").forEach(tc => tc.style.display = "none");
      document.querySelectorAll(".tablinks").forEach(tl => tl.classList.remove("active"));
      document.getElementById(tabName).style.display = "block";
      evt.currentTarget.classList.add("active");
      if (tabName === 'DailyReport' && !charts.cpqcChart) { // Khởi tạo nếu chưa có
          initAllCharts();
          applyDailyFilters();
      }
    }

    function addEventListeners() {
      document.body.addEventListener('change', (e) => {
        if (e.target.closest('#DetailedReport')) {
          handleTab1Filters(e.target);
        } else if (e.target.closest('#DailyReport')) {
          handleTab2Filters(e.target);
        }
      });
    }
    
    function fetchData() {
        fetch('https://script.google.com/macros/s/AKfycbzTjGSkbsvE_y-J2ocpcNYJtlLGMZ_3a8vQ-LAc9-WYPlf4rcW2cRE4Huvidhu7ZC-Q/exec')
        .then(res => res.json())
        .then(data => {
          rawData = data;
          populateAllFilters(data);
          applyTab1Filters(); // Render tab 1 mặc định
          if (document.getElementById('DailyReport').style.display === 'block') {
             applyDailyFilters(); // Render tab 2 nếu nó active
          }
        }).catch(err => {
          console.error(err);
          alert('Không thể tải dữ liệu từ Google Sheet. Vui lòng kiểm tra lại đường dẫn hoặc thử lại sau.');
        });
    }

    // --- HÀM HELPER ---
    function normalize(s) { return (s||'').trim().toLowerCase(); }
    function capitalize(s) { return s.charAt(0).toUpperCase()+s.slice(1); }
    function getGroup(norm) {
      for (let g in groupChildren) { if (groupChildren[g].map(normalize).includes(norm)) return g; }
      return capitalize(norm);
    }
    function formatDate(v) {
      const d = new Date(v); if (isNaN(d)) return v;
      return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
    }
    function formatCurrency(v) { return Number(v||0).toLocaleString('vi-VN',{style:'currency',currency:'VND'}); }
    function formatPriceShort(v) {
      const num = Number(v || 0);
      if (num >= 1000000) return (num / 1000000).toFixed(1) + 'tr';
      if (num >= 1000) return (num / 1000).toFixed(0) + 'k';
      return num.toLocaleString('vi-VN');
    }
    function formatPercent(v) { return `${(Number(v||0) * 100).toFixed(2)}%`; }

    function getFilteredData(startDateId, endDateId, productCbId, productOptionsClass, marketCbId, marketOptionsClass) {
        const sdVal = document.getElementById(startDateId).value;
        const edVal = document.getElementById(endDateId).value;
        const sd = sdVal ? new Date(sdVal) : null;
        const ed = edVal ? new Date(edVal) : null;
        if (ed) ed.setHours(23, 59, 59, 999);

        const pAll = document.getElementById(productCbId) ? document.getElementById(productCbId).checked : true;
        const selP = pAll ? null : [...document.querySelectorAll(`.${productOptionsClass}:checked`)].map(cb => cb.value);

        const mAll = document.getElementById(marketCbId) ? document.getElementById(marketCbId).checked : true;
        const selM = mAll ? null : [...document.querySelectorAll(`.${marketOptionsClass}:checked`)].map(cb => cb.value);

        // Filters for Ca and Team only exist on Tab 1
        const cAll = document.getElementById('ca-all-tab1') ? document.getElementById('ca-all-tab1').checked : true;
        const selCa = cAll ? null : [...document.querySelectorAll('.filter-ca-tab1:checked')].map(cb => cb.value);

        const tAll = document.getElementById('team-all-tab1') ? document.getElementById('team-all-tab1').checked : true;
        const selT = tAll ? null : [...document.querySelectorAll('.filter-team-tab1:checked')].map(cb => cb.value);

        return rawData.filter(r => {
            const d = new Date(r.ngay);
            const okD = (!sd || d >= sd) && (!ed || d <= ed);
            const okP = !selP || selP.includes(r.sanPham);
            const grp = getGroup(normalize(r.thiTruong));
            const okM = !selM || selM.includes(grp) || selM.includes(r.thiTruong);
            const okCa = !document.getElementById('ca-all-tab1') || !selCa || selCa.includes(r.ca);
            const okT = !document.getElementById('team-all-tab1') || !selT || selT.includes(r.team);
            return okD && okP && okM && okCa && okT;
        });
    }

    // --- LOGIC BỘ LỌC VÀ KHỞI TẠO ---
    function populateAllFilters(data) {
        const prodSet=new Set(), caSet=new Set(), teamSet=new Set(), mktSet=new Set();
        data.forEach(r=>{ if(r.sanPham) prodSet.add(r.sanPham); if(r.ca) caSet.add(r.ca); if(r.team) teamSet.add(r.team); if(r.thiTruong) mktSet.add(r.thiTruong); });

        const productHtml = Array.from(prodSet).sort().map(p => `<label><input type='checkbox' class='filter-product-tab1' value='${p}' checked> ${p}</label>`).join('');
        document.getElementById('product-options-tab1').innerHTML = productHtml;
        document.getElementById('product-options-tab2').innerHTML = productHtml.replaceAll('filter-product-tab1', 'filter-product-tab2');

        const marketHtml = Object.keys(groupChildren).map(grp => 
            `<label><input type='checkbox' class='filter-market-tab1' value='${grp}' checked> ${grp}</label>` + 
            groupChildren[grp].map(ch => `<label class='indent'><input type='checkbox' class='filter-market-tab1' value='${ch}' checked> ${ch}</label>`).join('')
        ).join('');
        const otherMarkets = Array.from(mktSet).filter(m => !Object.values(groupChildren).flat().includes(m))
            .map(m => `<label><input type='checkbox' class='filter-market-tab1' value='${m}' checked> ${m}</label>`).join('');
        document.getElementById('market-options-tab1').innerHTML = marketHtml + otherMarkets;
        document.getElementById('market-options-tab2').innerHTML = (marketHtml + otherMarkets).replaceAll('filter-market-tab1', 'filter-market-tab2');

        document.getElementById('ca-options-tab1').innerHTML = Array.from(caSet).sort().map(c => `<label class='indent'><input type='checkbox' class='filter-ca-tab1' value='${c}' checked> ${c}</label>`).join('');
        document.getElementById('team-options-tab1').innerHTML = Array.from(teamSet).sort().map(t => `<label class='indent'><input type='checkbox' class='filter-team-tab1' value='${t}' checked> ${t}</label>`).join('');
    }
    
    function handleCheckbox(masterId, childClass, target) {
        if (target.id === masterId) {
            document.querySelectorAll(`.${childClass}`).forEach(cb => cb.checked = target.checked);
        } else if (target.classList.contains(childClass)) {
            const allChecked = [...document.querySelectorAll(`.${childClass}`)].every(cb => cb.checked);
            document.getElementById(masterId).checked = allChecked;
        }
    }

    // --- LOGIC TAB 1 ---
    function handleTab1Filters(target) {
        handleCheckbox('product-all-tab1', 'filter-product-tab1', target);
        handleCheckbox('ca-all-tab1', 'filter-ca-tab1', target);
        handleCheckbox('team-all-tab1', 'filter-team-tab1', target);
        handleCheckbox('market-all-tab1', 'filter-market-tab1', target);
        applyTab1Filters();
    }
    function applyTab1Filters() {
        const filtered = getFilteredData('start-date-tab1', 'end-date-tab1', 'product-all-tab1', 'filter-product-tab1', 'market-all-tab1', 'filter-market-tab1');
        renderSummary(filtered);
        renderKpiSummary(filtered);
        renderDailyBreakdown(filtered);
    }
    function renderSummary(data) {
        const sum={}, tot={mess:0,don:0,chot:0,cpqc:0};
        data.forEach(r=>{
            const n=r.ten||'N/A',m=+r.soMessCmt||0,d=+r.soDon||0,c=+r.dsChot||0,p=+r.cpqc||0;
            if(!sum[n]) sum[n]={mess:0,don:0,chot:0,cpqc:0};
            sum[n].mess+=m; sum[n].don+=d; sum[n].chot+=c; sum[n].cpqc+=p;
            tot.mess+=m; tot.don+=d; tot.chot+=c; tot.cpqc+=p;
        });
        let bodyHtml = Object.keys(sum).sort().map(n => {
            const s=sum[n];
            const rate=s.mess? s.don/s.mess:0;
            const pm=s.mess? s.cpqc/s.mess:0;
            const pd=s.don? s.cpqc/s.don:0;
            const pc=s.chot? s.cpqc/s.chot:0;
            const pdt=s.don? s.cpqc/s.don:0; // Using soDon as donHangThuc for now
            return `<tr><td>${n}</td><td>${s.mess}</td><td>${s.don}</td><td>${formatCurrency(s.chot)}</td><td>${formatCurrency(s.cpqc)}</td><td>${formatPercent(rate)}</td><td>${formatCurrency(pm)}</td><td>${formatCurrency(pd)}</td><td>${formatPercent(pc)}</td><td>${formatCurrency(pdt)}</td></tr>`;
        }).join('');
        const rateTot=tot.mess?tot.don/tot.mess:0, pmTot=tot.mess?tot.cpqc/tot.mess:0, pdTot=tot.don?tot.cpqc/tot.don:0, pcTot=tot.chot?tot.cpqc/tot.chot:0, pdtTot=tot.don?tot.cpqc/tot.don:0;
        let footHtml = `<tr class='total-row'><td>Tổng</td><td>${tot.mess}</td><td>${tot.don}</td><td>${formatCurrency(tot.chot)}</td><td>${formatCurrency(tot.cpqc)}</td><td>${formatPercent(rateTot)}</td><td>${formatCurrency(pmTot)}</td><td>${formatCurrency(pdTot)}</td><td>${formatPercent(pcTot)}</td><td>${formatCurrency(pdtTot)}</td></tr>`;
        document.getElementById('summary-body').innerHTML = bodyHtml;
        document.getElementById('summary-foot').innerHTML = footHtml;
    }
    function renderKpiSummary(data) {
        const sum = {}, total = { cpqc: 0, dsThuc: 0, dsDaDi: 0, dsThanhCong: 0, dsSauShip: 0, dsChot: 0 };
        data.forEach(r => {
            const mkt = r.ten || 'N/A';
            if (!sum[mkt]) sum[mkt] = { cpqc: 0, dsThuc: 0, dsDaDi: 0, dsThanhCong: 0, dsSauShip: 0, dsChot: 0 };
            const cpqc = +r.cpqc || 0, dsChot = +r.dsChot || 0, dsThanhCong = +r.dsThanhCong || 0, tienShip = +r.tienShip || 0;
            const dsSauShip = dsThanhCong - tienShip;
            sum[mkt].cpqc += cpqc; sum[mkt].dsThuc += dsSauShip; sum[mkt].dsDaDi += dsChot; sum[mkt].dsThanhCong += dsThanhCong; sum[mkt].dsSauShip += dsSauShip; sum[mkt].dsChot += dsChot;
            total.cpqc += cpqc; total.dsThuc += dsSauShip; total.dsDaDi += dsChot; total.dsThanhCong += dsThanhCong; total.dsSauShip += dsSauShip; total.dsChot += dsChot;
        });
        let bodyHtml = Object.keys(sum).sort().map((mkt, i) => {
            const s = sum[mkt]; const cp_ds = s.dsChot ? s.cpqc / s.dsChot : 0; const kpi = s.cpqc ? s.dsSauShip / s.cpqc : 0;
            return `<tr><td>${i+1}</td><td>${mkt}</td><td>${formatCurrency(s.cpqc)}</td><td>${formatCurrency(s.dsThuc)}</td><td>${formatCurrency(s.dsDaDi)}</td><td>${formatCurrency(s.dsThanhCong)}</td><td>${formatCurrency(s.dsSauShip)}</td><td>${formatPercent(cp_ds)}</td><td>${kpi.toFixed(2)}x</td></tr>`;
        }).join('');
        const total_cp_ds = total.dsChot ? total.cpqc / total.dsChot : 0, total_kpi = total.cpqc ? total.dsSauShip / total.cpqc : 0;
        let footHtml = `<tr class="total-row"><td colspan="2">Tổng</td><td>${formatCurrency(total.cpqc)}</td><td>${formatCurrency(total.dsThuc)}</td><td>${formatCurrency(total.dsDaDi)}</td><td>${formatCurrency(total.dsThanhCong)}</td><td>${formatCurrency(total.dsSauShip)}</td><td>${formatPercent(total_cp_ds)}</td><td>${total_kpi.toFixed(2)}x</td></tr>`;
        document.getElementById('kpi-summary-body').innerHTML = bodyHtml;
        document.getElementById('kpi-summary-foot').innerHTML = footHtml;
    }
    function renderDailyBreakdown(data) {
      const c=document.getElementById('daily-breakdown');c.innerHTML='';const grpObj={};data.forEach(r=>{const d=formatDate(r.ngay);(grpObj[d]||(grpObj[d]=[])).push(r);});Object.keys(grpObj).sort((a,b)=>new Date(b.split('/').reverse().join('-'))-new Date(a.split('/').reverse().join('-'))).forEach(date=>{let m=0,d=0,ch=0,pc=0;const rowsHtml=grpObj[date].map(r=>{m+=+r.soMessCmt||0;d+=+r.soDon||0;ch+=+r.dsChot||0;pc+=+r.cpqc||0;return`<tr><td>${r.id}</td><td>${r.ten}</td><td>${r.ca}</td><td>${r.page}</td><td>${r.sanPham}</td><td>${r.thiTruong}</td><td>${r.soMessCmt}</td><td>${r.soDon}</td><td>${formatCurrency(r.dsChot)}</td><td>${formatCurrency(r.cpqc)}</td><td>${r.team}</td></tr>`}).join('');const footHtml=`<tr class='total-row'><td colspan='6'>Tổng</td><td>${m}</td><td>${d}</td><td>${formatCurrency(ch)}</td><td>${formatCurrency(pc)}</td><td></td></tr>`;c.innerHTML+=`<h3>${date}</h3><table><thead><tr><th>ID</th><th>Tên</th><th>Ca</th><th>Page</th><th>Sản phẩm</th><th>Thị trường</th><th>Mess</th><th>Đơn</th><th>DS Chốt</th><th>CPQC</th><th>Team</th></tr></thead><tbody>${rowsHtml}</tbody><tfoot>${footHtml}</tfoot></table>`;});
    }

    // --- LOGIC TAB 2 ---
    function handleTab2Filters(target) {
        handleCheckbox('product-all-tab2', 'filter-product-tab2', target);
        handleCheckbox('market-all-tab2', 'filter-market-tab2', target);
        if (target.id === 'toggle-all-charts') {
            document.querySelectorAll('.chart-toggle').forEach(cb => cb.checked = target.checked);
        }
        if (target.classList.contains('chart-toggle')) {
            document.getElementById('toggle-all-charts').checked = [...document.querySelectorAll('.chart-toggle')].every(cb => cb.checked);
        }
        if (target.classList.contains('chart-toggle') || target.id === 'toggle-all-charts') {
            toggleChartVisibility();
        } else {
            applyDailyFilters();
        }
    }
    function applyDailyFilters() {
        if (!rawData.length) return;
        const filtered = getFilteredData('start-date-tab2', 'end-date-tab2', 'product-all-tab2', 'filter-product-tab2', 'market-all-tab2', 'filter-market-tab2');
        renderDailyTable(filtered);
        renderAllDailyCharts(filtered);
    }
    function renderDailyTable(data) {
        const daily = {};
        data.forEach(r => {
            const dateKey = formatDate(r.ngay);
            if (!daily[dateKey]) daily[dateKey] = { cpqc: 0, don: 0, mess: 0, chot: 0 };
            daily[dateKey].cpqc += +r.cpqc || 0;
            daily[dateKey].don += +r.soDon || 0;
            daily[dateKey].mess += +r.soMessCmt || 0;
            daily[dateKey].chot += +r.dsChot || 0;
        });
        let tbodyHtml = Object.keys(daily).sort((a,b) => new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-')))
          .map(d => {
              const day = daily[d];
              const avg = day.mess ? day.don / day.mess : 0;
              const giaMess = day.mess ? day.cpqc / day.mess : 0;
              const cps = day.don ? day.cpqc / day.don : 0;
              const cpqcRatio = day.chot ? day.cpqc / day.chot : 0;
              return `<tr><td><b>${d}</b></td><td>${formatPriceShort(day.cpqc)}</td><td>${formatPriceShort(day.chot)}</td><td>${formatPercent(avg)}</td><td>${formatPriceShort(giaMess)}</td><td>${formatPriceShort(cps)}</td><td>${formatPercent(cpqcRatio)}</td></tr>`;
          }).join('');
        document.getElementById('date-summary-body').innerHTML = tbodyHtml;
    }
    function initAllCharts() {
        const createChart = (ctxId, type, indexAxis = 'x') => {
            const chartConfig = getChartConfig(type, indexAxis);
            const ctx = document.getElementById(ctxId).getContext('2d');
            return new Chart(ctx, chartConfig);
        };
        charts.cpqcChart = createChart('cpqcChart', 'line');
        charts.dsChotChart = createChart('dsChotChart', 'line');
        charts.rateChart = createChart('rateChart', 'line');
        charts.messChart = createChart('messChart', 'line');
        charts.cpsChart = createChart('cpsChart', 'line');
        charts.cpqcDsRatioChart = createChart('cpqcDsRatioChart', 'line');
        charts.productSalesChart = createChart('productSalesChart', 'bar', 'y');
        charts.marketSalesChart = createChart('marketSalesChart', 'bar', 'y');
        toggleChartVisibility();
    }
    function renderAllDailyCharts(data) {
        if (!charts.cpqcChart) return; // Don't render if not initialized
        // Line chart data
        const daily = {};
        data.forEach(r => {
            const dateKey = formatDate(r.ngay);
            if (!daily[dateKey]) daily[dateKey] = { cpqc: 0, don: 0, mess: 0, chot: 0 };
            daily[dateKey].cpqc += +r.cpqc || 0; daily[dateKey].don += +r.soDon || 0;
            daily[dateKey].mess += +r.soMessCmt || 0; daily[dateKey].chot += +r.dsChot || 0;
        });
        const labels = Object.keys(daily).sort((a,b) => new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-')));
        updateChart(charts.cpqcChart, 'CPQC', labels, labels.map(d => daily[d].cpqc), getChartColors().cpqc, 'VND', formatPriceShort);
        updateChart(charts.dsChotChart, 'DS Chốt', labels, labels.map(d => daily[d].chot), getChartColors().dsChot, 'VND', formatPriceShort);
        updateChart(charts.rateChart, 'Tỉ lệ chốt TB', labels, labels.map(d => daily[d].mess ? (daily[d].don / daily[d].mess) : 0), getChartColors().rate, '%', v => formatPercent(v));
        updateChart(charts.messChart, 'Giá Mess', labels, labels.map(d => daily[d].mess ? (daily[d].cpqc / daily[d].mess) : 0), getChartColors().mess, 'VND', formatPriceShort);
        updateChart(charts.cpsChart, 'CPS', labels, labels.map(d => daily[d].don ? (daily[d].cpqc / daily[d].don) : 0), getChartColors().cps, 'VND', formatPriceShort);
        updateChart(charts.cpqcDsRatioChart, '%CPQC/DS chốt', labels, labels.map(d => daily[d].chot ? (daily[d].cpqc / daily[d].chot) : 0), getChartColors().cpqcDsRatio, '%', v => formatPercent(v));

        // Bar chart data
        const productSales = {}, marketSales = {};
        data.forEach(r => {
            const ds = +r.dsChot || 0;
            if (r.sanPham) productSales[r.sanPham] = (productSales[r.sanPham] || 0) + ds;
            if (r.thiTruong) marketSales[r.thiTruong] = (marketSales[r.thiTruong] || 0) + ds;
        });
        const sortedProducts = Object.entries(productSales).sort((a,b) => b[1] - a[1]);
        const sortedMarkets = Object.entries(marketSales).sort((a,b) => b[1] - a[1]);
        updateChart(charts.productSalesChart, 'DS Chốt theo SP', sortedProducts.map(p=>p[0]), sortedProducts.map(p=>p[1]), getChartColors().product, 'VND', formatPriceShort);
        updateChart(charts.marketSalesChart, 'DS Chốt theo TT', sortedMarkets.map(m=>m[0]), sortedMarkets.map(m=>m[1]), getChartColors().market, 'VND', formatPriceShort);
    }
    function toggleChartVisibility() {
        document.querySelectorAll('.chart-toggle').forEach(checkbox => {
            const chartName = checkbox.dataset.chart;
            const wrapper = document.querySelector(`.chart-wrapper[data-chart="${chartName}"]`);
            if (wrapper) {
                wrapper.style.display = checkbox.checked ? 'block' : 'none';
            }
        });
    }

    // --- CHART CONFIGURATION & HELPERS ---
    function getChartConfig(type = 'line', indexAxis = 'x') {
        const isBar = type === 'bar';
        return {
            type: type, data: { labels: [], datasets: [{}] },
            options: {
                responsive: true, maintainAspectRatio: false, indexAxis: indexAxis,
                plugins: {
                    legend: { display: !isBar, labels: { font: { weight: 'bold' } } },
                    datalabels: {
                        anchor: isBar ? 'end' : 'end', align: isBar ? 'end' : 'top',
                        font: { weight: 'bold' }, color: '#333',
                        backgroundColor: 'rgba(255, 255, 255, 0.7)', borderRadius: 4, padding: 4
                    },
                    tooltip: { backgroundColor: 'rgba(0,0,0,0.8)', boxPadding: 8 }
                },
                scales: {
                    [indexAxis]: { grid: { drawOnChartArea: !isBar } },
                    [indexAxis === 'x' ? 'y' : 'x']: { grid: { drawOnChartArea: true }, ticks: { callback: v => formatPriceShort(v) } }
                }
            }
        };
    }
    function getChartColors() {
        return {
            cpqc: { border: '#36A2EB', gradientStart: 'rgba(54, 162, 235, 0.6)', gradientEnd: 'rgba(54, 162, 235, 0.05)' },
            dsChot: { border: '#2ECC71', gradientStart: 'rgba(46, 204, 113, 0.6)', gradientEnd: 'rgba(46, 204, 113, 0.05)' },
            rate: { border: '#FF6384', gradientStart: 'rgba(255, 99, 132, 0.6)', gradientEnd: 'rgba(255, 99, 132, 0.05)' },
            mess: { border: '#FF9F40', gradientStart: 'rgba(255, 159, 64, 0.6)', gradientEnd: 'rgba(255, 159, 64, 0.05)' },
            cps: { border: '#4BC0C0', gradientStart: 'rgba(75, 192, 192, 0.6)', gradientEnd: 'rgba(75, 192, 192, 0.05)' },
            cpqcDsRatio: { border: '#9B59B6', gradientStart: 'rgba(155, 89, 182, 0.6)', gradientEnd: 'rgba(155, 89, 182, 0.05)' },
            product: { border: '#34495E', gradientStart: 'rgba(52, 73, 94, 0.8)', gradientEnd: 'rgba(52, 73, 94, 0.5)' },
            market: { border: '#E74C3C', gradientStart: 'rgba(231, 76, 60, 0.8)', gradientEnd: 'rgba(231, 76, 60, 0.5)' },
        };
    }
    function updateChart(chart, label, labels, data, colors, yLabelText, formatter) {
        const isLine = chart.config.type === 'line';
        let backgroundColor = colors.border;
        if (isLine) {
            const gradient = chart.ctx.createLinearGradient(0, 0, 0, chart.height);
            gradient.addColorStop(0, colors.gradientStart);
            gradient.addColorStop(1, colors.gradientEnd);
            backgroundColor = gradient;
        }
        chart.data.labels = labels;
        chart.data.datasets[0] = {
            label: label, data: data, backgroundColor: backgroundColor,
            borderColor: colors.border, borderWidth: isLine ? 3 : 1,
            fill: isLine, tension: 0.4,
            pointBackgroundColor: colors.border, pointBorderColor: '#fff',
            pointBorderWidth: 2, pointRadius: 5
        };
        chart.options.scales.y.title.text = yLabelText;
        chart.options.plugins.datalabels.formatter = formatter;
        chart.update();
    }
  </script>
</body>
</html>

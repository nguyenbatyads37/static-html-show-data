<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>B√°o C√°o MKT LumiGlobal</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0;
      background-image: url('https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Ff930e667.%E1%BA%A2nh.025539.jpg');
      background-size: cover; background-attachment: fixed; background-position: center; color: #333;
    }
    .container {
      width: 100%; min-height: 100vh; margin: 0;
      background-color: rgba(255, 255, 255, 0.95);
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
      padding: 20px; box-sizing: border-box;
    }
    .header {
      display: flex; align-items: center; margin-bottom: 20px;
      padding-bottom: 15px; border-bottom: 2px solid #0056b3;
    }
    .logo { height: 60px; margin-right: 20px; }
    h1 { color: #0056b3; margin: 0; font-weight: 600; }
    table {
      width: 100%; border-collapse: collapse; margin-top: 20px;
      background-color: white; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      table-layout: fixed;
    }
    th, td {
      border: 1px solid #ddd; padding: 12px;
      text-align: left; word-wrap: break-word;
    }
    th {
      background-color: #0056b3; color: white; font-weight: 500;
      position: sticky; top: 0; z-index: 1;
    }
    th:nth-child(1), td:nth-child(1) { width: 5%; } th:nth-child(2), td:nth-child(2) { width: 11%; }
    th:nth-child(3), td:nth-child(3) { width: 9%; } th:nth-child(4), td:nth-child(4) { width: 8%; }
    th:nth-child(5), td:nth-child(5) { width: 10%; } th:nth-child(6), td:nth-child(6) { width: 9%; }
    th:nth-child(7), td:nth-child(7) { width: 15%; } th:nth-child(8), td:nth-child(8) { width: 11%; }
    th:nth-child(9), td:nth-child(9) { width: 7%; } th:nth-child(10), td:nth-child(10) { width: 8%; }
    th:nth-child(11), td:nth-child(11) { width: 7%; }
    tr:nth-child(even) { background-color: #f9f9f9; }
    tr:hover { background-color: #f1f1f1; }
    input, textarea, button, select {
      box-sizing: border-box; padding: 8px; border: 1px solid #ddd;
      border-radius: 4px; width: 100%; font-family: inherit; font-size: 14px;
    }
    input[readonly] { background-color: #f5f5f5; }
    .hidden { display: none; }
    .form-actions { margin-top: 20px; display: flex; gap: 10px; }
    .submit-btn, .share-btn, .add-row-btn {
      padding: 10px 20px; font-size: 16px; border: none;
      color: white; border-radius: 5px; cursor: pointer;
      transition: background-color 0.3s;
    }
    .submit-btn { background-color: #007bff; }
    .submit-btn:hover { background-color: #0056b3; }
    .share-btn { background-color: #6c757d; }
    .share-btn:hover { background-color: #5a6268; }
    .add-row-btn { background-color: #28a745; margin-bottom: 15px; }
    .add-row-btn:hover { background-color: #218838; }
    #responseMessage.success { color: green; font-weight: bold; }
    #responseMessage.error { color: red; font-weight: bold; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <img src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Ff930e667.%E1%BA%A2nh.025539.jpg" alt="LumiGlobal Logo" class="logo">
      <h1>B√°o C√°o MKT LumiGlobal</h1>
    </div>

    <button id="addRow" type="button" class="add-row-btn">‚ûï Th√™m d√≤ng tr·ªëng</button>

    <form id="dataForm">
      <table id="dataTable">
        <thead>
          <tr>
            <th>H√†nh ƒë·ªông</th><th>T√™n</th><th>Ng√†y</th><th>Ca</th><th>S·∫£n ph·∫©m</th><th>Th·ªã tr∆∞·ªùng</th><th>Page</th>
            <th>TKQC</th><th>CPQC</th><th>Via log</th><th>S·ªë Mess+Cmt</th>
            <th class="hidden">id</th><th class="hidden">Team</th><th class="hidden">id NS</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="form-actions">
          <button type="submit" id="submitBtn" class="submit-btn">üöÄ G·ª≠i b√°o c√°o</button>
          <button type="button" id="getShareLinkBtn" class="share-btn">üîó L·∫•y Link Chia S·∫ª</button>
      </div>
    </form>
    <p id="responseMessage"></p>
  </div>

  <script>
    const addRowBtn = document.getElementById('addRow');
    const tbody = document.querySelector('#dataTable tbody');
    const form = document.getElementById('dataForm');
    const respMsg = document.getElementById('responseMessage');
    const getShareLinkBtn = document.getElementById('getShareLinkBtn');
    
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzn1xZCMptrE3SKEFhTW-tV8aGg_AVZcGh03W_0BHCsMa9SOXKRue3zZD8Zr5LY-iwp/exec';

    const productList = [ "Kem body", "CF FG", "CB BAKU", "Bakuchiol", "C√† ph√™", "N√°m", "K·∫πo D√¢u", "Serum S√¢m", "K·∫πo D√¢u New", "Body TBN", "Baku TBN", "DG", "K·∫πo T√°o" ];
    const marketList = ["Nh·∫≠t", "H√†n", "Canada", "US", "√öc", "Anh"];
    const shiftList = ["H·∫øt ca", "Gi·ªØa ca", "Ca Chi·ªÅu"];
    
    // THAY ƒê·ªîI 1: T√ÅI S·ª¨ D·ª§NG DANH S√ÅCH NH√ÇN VI√äN G·ªêC
    const originalEmployeeList = [ "Ph·∫°m Ti·∫øn Th√†nh", "L√™ ƒê√¨nh To·∫£n", "Tr·∫ßn Qu·ªëc Kh·∫£i", "M·∫°nh C∆∞·ªùng", "Nguy·ªÖn Th·ªã Hi·∫øu", "V≈© Vi·∫øt Anh", "L·ª•c Tr·∫ßn Minh Tr√≠", "ƒêo√†n Ng·ªçc Hu√¢n", "Nguy·ªÖn Hi·ªÅn L∆∞∆°ng", "Tr·∫ßn Huy H√πng", "Nguy·ªÖn Anh Tu·∫•n", "Tr·∫ßn Ti·∫øn", "Nguy·ªÖn Th·ªã Nh∆∞ Qu·ª≥nh", "Nguy·ªÖn Quang Tr∆∞·ªùng" ];

    // THAY ƒê·ªîI 2: Bi·∫øn `tenpage` l√† ngu·ªìn d·ªØ li·ªáu ch√≠nh cho Page v√† TKQC
    const tenpage = {
        "Ph·∫°m Ti·∫øn Th√†nh": {
            pages: ["Page Th√†nh 1", "Page Th√†nh 2 - Skincare", "Page chung A"],
            tkqc: ["tcm 300", "tcm 393(1)", "tcm 431(1)", "tcm 449(1)", "lumi hn 05(1)", "lumi hn 14(1)", "lumi hn 21", "lumi hn 29", "lumi hn 52", "lumi hn 53", "lumi hn 54", "lumi hn 60", "lumi hn 68", "lumi hn 75", "lumi hn 82", "lumi hn 83"]
        },
        "L√™ ƒê√¨nh To·∫£n": {
            pages: ["Page To·∫£n - Th·ªùi trang", "Page To·∫£n 2", "Page chung B"],
            tkqc: ["tcm 365(1)", "tcm 386(1)", "tcm 389-b(1)", "tcm 427-b", "lumi hn 07(1)", "lumi hn 26", "lumi hn 40"]
        },
        "Tr·∫ßn Qu·ªëc Kh·∫£i": {
            pages: ["Page Kh·∫£i 1", "Page Kh·∫£i 2"],
            tkqc: ["tcm 369-b(1)", "tcm 380(1)", "tcm 387(1)", "tcm 455", "lumi hn 02(1)", "lumi hn 12", "lumi hn 16(1)", "lumi hn 35", "lumi hn 47", "lumi hn 48"]
        },
        // B·∫°n c√≥ th·ªÉ th√™m c√°c nh√¢n vi√™n kh√°c v√†o ƒë√¢y ƒë·ªÉ h·ªç c√≥ s·∫µn Page/TKQC
    };

    // THAY ƒê·ªîI 3: T·∫†O DANH S√ÅCH NH√ÇN VI√äN CU·ªêI C√ôNG
    // G·ªôp danh s√°ch t·ª´ `tenpage` v√† danh s√°ch g·ªëc, sau ƒë√≥ lo·∫°i b·ªè c√°c t√™n tr√πng l·∫∑p.
    const employeeList = [...new Set([...Object.keys(tenpage), ...originalEmployeeList])];


    const numberFormatter = new Intl.NumberFormat('vi-VN');
    function formatNumber(value) { /* ... */ }
    function getToday() { /* ... */ }

    // H√†m createRow s·ª≠ d·ª•ng `employeeList` ƒë√£ ƒë∆∞·ª£c t·ªïng h·ª£p
    function createRow(data = {}, insertAfter = null) {
      const tr = document.createElement('tr');
      const uniqueId = `id_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
      
      tr.innerHTML = `
        <td class="action-buttons"><button type="button" class="removeRow" title="X√≥a d√≤ng n√†y">‚ùå</button></td>
        <td><select name="T√™n" class="editable name-select"><option value="">-- Ch·ªçn t√™n --</option>${employeeList.map(name => `<option value="${name}" ${data.T√™n === name ? 'selected' : ''}>${name}</option>`).join('')}</select></td>
        <td><input name="Ng√†y" type="date" value="${data.Ng√†y || getToday()}" class="editable"></td>
        <td><select name="ca" class="editable">${shiftList.map(shift => `<option value="${shift}" ${data.ca === shift ? 'selected' : ''}>${shift}</option>`).join('')}</select></td>
        <td><input name="S·∫£n_ph·∫©m" list="productList" value="${data.S·∫£n_ph·∫©m || ''}" class="editable"><datalist id="productList">${productList.map(product => `<option value="${product}">`).join('')}</datalist></td>
        <td><input name="Th·ªã_tr∆∞·ªùng" list="marketList" value="${data.Th·ªã_tr∆∞·ªùng || ''}" class="editable"><datalist id="marketList">${marketList.map(market => `<option value="${market}">`).join('')}</datalist></td>
        <td><select name="page" class="editable page-select"><option value="">-- Ch·ªçn Page --</option></select></td>
        <td><input name="TKQC" class="editable tkqc-input" list="tkqc-datalist-${uniqueId}" value="${data.TKQC || ''}" placeholder="Ch·ªçn ho·∫∑c nh·∫≠p m·ªõi..."><datalist id="tkqc-datalist-${uniqueId}"></datalist></td>
        <td><input type="text" inputmode="numeric" class="editable cpqc-display" placeholder="Nh·∫≠p chi ph√≠"><input type="hidden" name="CPQC" class="cpqc-hidden" value="${data.CPQC || ''}"></td>
        <td><input name="Via_log" value="${data.Via_log || ''}" class="editable"></td>
        <td><input name="S·ªë_Mess_Cmt" value="${data.S·ªë_Mess_Cmt || ''}" class="editable" type="number" step="1"></td>
        <td class="hidden"><input name="id" value="${data.id || uniqueId}" readonly></td><td class="hidden"><input name="Team" value="" readonly></td><td class="hidden"><input name="id_NS" value="" readonly></td>
      `;
      const cpqcDisplay = tr.querySelector('.cpqc-display');
      const cpqcHidden = tr.querySelector('.cpqc-hidden');
      cpqcDisplay.value = formatNumber(cpqcHidden.value);
      cpqcDisplay.addEventListener('input', () => {
        const rawValue = cpqcDisplay.value.replace(/\D/g, ''); cpqcHidden.value = rawValue;
        const currentCursor = cpqcDisplay.selectionStart; const originalLength = cpqcDisplay.value.length;
        cpqcDisplay.value = formatNumber(rawValue); const newLength = cpqcDisplay.value.length;
        cpqcDisplay.setSelectionRange(currentCursor + (newLength - originalLength), currentCursor + (newLength - originalLength));
      });
      tr.querySelector('.removeRow').addEventListener('click', () => tr.remove());
      const nameSelect = tr.querySelector('.name-select');
      const pageSelect = tr.querySelector('.page-select');
      const tkqcDatalist = tr.querySelector(`#tkqc-datalist-${uniqueId}`);
      
      nameSelect.addEventListener('change', function() {
        const selectedName = this.value;
        const mktData = tenpage[selectedName]; // D√≤ trong tenpage
        pageSelect.innerHTML = '<option value="">-- Ch·ªçn Page --</option>';
        tkqcDatalist.innerHTML = '';
        if (mktData) { // N·∫øu t√¨m th·∫•y t√™n trong tenpage th√¨ m·ªõi ƒëi·ªÅn data
          if (mktData.pages && mktData.pages.length > 0) {
            mktData.pages.forEach(page => {
              const option = document.createElement('option'); option.value = page; option.textContent = page; pageSelect.appendChild(option);
            });
          }
          if (mktData.tkqc) {
            mktData.tkqc.forEach(tkqc => {
              const option = document.createElement('option'); option.value = tkqc; tkqcDatalist.appendChild(option);
            });
          }
        }
      });
      
      if (data.T√™n) {
        nameSelect.dispatchEvent(new Event('change'));
        pageSelect.value = data.page || '';
      }
      if (insertAfter) { tbody.insertBefore(tr, insertAfter.nextSibling); } 
      else { tbody.appendChild(tr); }
      return tr;
    }

    // C√°c h√†m c√≤n l·∫°i kh√¥ng thay ƒë·ªïi v√† ho·∫°t ƒë·ªông ch√≠nh x√°c
    addRowBtn.addEventListener('click', () => { createRow().querySelector('[name="T√™n"]').focus(); });
    function initializeRowsFromUrl() { /* ... */ }
    function generateShareLink() { /* ... */ }
    getShareLinkBtn.addEventListener('click', () => { /* ... */ });
    form.addEventListener('submit', e => { e.preventDefault(); /* ... */ });

    // --- D√°n l·∫°i c√°c h√†m kh√¥ng ƒë·ªïi ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh to√†n v·∫πn ---
    function formatNumber(value) { if (!value) return ''; const cleanValue = String(value).replace(/\D/g, ''); if (cleanValue === '') return ''; return numberFormatter.format(cleanValue); }
    function getToday() { return new Date().toISOString().split('T')[0]; }
    function initializeRowsFromUrl() {
        tbody.innerHTML = ''; const urlParams = new URLSearchParams(window.location.search); const dataParam = urlParams.get('data'); let rowsCreated = 0;
        if (dataParam) {
            const rowsData = dataParam.split('_a_');
            rowsData.forEach(rowString => {
                if (rowString.trim() === '') return;
                const fields = rowString.split('_b_');
                const rowDataObject = {
                    id: fields[0] ? decodeURIComponent(fields[0]) : '', T√™n: fields[1] ? decodeURIComponent(fields[1]) : '',
                    S·∫£n_ph·∫©m: fields[2] ? decodeURIComponent(fields[2]) : '', Th·ªã_tr∆∞·ªùng: fields[3] ? decodeURIComponent(fields[3]) : '',
                    page: fields[4] ? decodeURIComponent(fields[4]) : '', TKQC: fields[5] ? decodeURIComponent(fields[5]) : '',
                    CPQC: fields[6] ? decodeURIComponent(fields[6]) : ''
                };
                createRow(rowDataObject); rowsCreated++;
            });
        }
        if (rowsCreated === 0) { createRow(); }
    }
    function generateShareLink() {
        const allRows = Array.from(tbody.querySelectorAll('tr'));
        if (allRows.length === 0) { respMsg.className = 'error'; respMsg.innerText = 'Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ t·∫°o link.'; return null; }
        const dataStrings = allRows.map(tr => {
            const fields = [
                tr.querySelector('[name="id"]').value, tr.querySelector('[name="T√™n"]').value, tr.querySelector('[name="S·∫£n_ph·∫©m"]').value,
                tr.querySelector('[name="Th·ªã_tr∆∞·ªùng"]').value, tr.querySelector('[name="page"]').value, tr.querySelector('[name="TKQC"]').value,
                tr.querySelector('[name="CPQC"]').value
            ].map(field => encodeURIComponent(field || ''));
            return fields.join('_b_');
        });
        const finalDataString = dataStrings.join('_a_'); const baseUrl = window.location.origin + window.location.pathname;
        return `${baseUrl}?data=${finalDataString}`;
    }
    getShareLinkBtn.addEventListener('click', () => {
        const link = generateShareLink();
        if (link) {
            navigator.clipboard.writeText(link).then(() => {
                respMsg.className = 'success'; respMsg.innerText = 'ƒê√£ sao ch√©p link v√†o b·ªô nh·ªõ t·∫°m!';
                setTimeout(() => { if (respMsg.innerText === 'ƒê√£ sao ch√©p link v√†o b·ªô nh·ªõ t·∫°m!') { respMsg.innerText = ''; respMsg.className = ''; } }, 3000);
            }).catch(err => { respMsg.className = 'error'; respMsg.innerText = 'L·ªói khi sao ch√©p link: ' + err; });
        }
    });

    initializeRowsFromUrl();
  </script>
</body>
</html>
















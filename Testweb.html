<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>B√°o C√°o MKT LumiGlobal</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-image: url('https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Ff930e667.%E1%BA%A2nh.025539.jpg');
      background-size: cover;
      background-attachment: fixed;
      background-position: center;
      color: #333;
    }
    
    .container {
      max-width: 1800px;
      margin: 20px auto;
      background-color: rgba(255, 255, 255, 0.9);
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
      padding: 20px;
      overflow-x: auto;
    }
    
    .header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #0056b3;
    }
    
    .logo {
      height: 60px;
      margin-right: 20px;
    }
    
    h1 {
      color: #0056b3;
      margin: 0;
      font-weight: 600;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background-color: white;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      min-width: 1600px;
    }
    
    th, td {
      border: 1px solid #ddd;
      padding: 15px;
      text-align: left;
      vertical-align: top;
    }
    
    th {
      background-color: #0056b3;
      color: white;
      font-weight: 500;
      position: sticky;
      top: 0;
      font-size: 14px;
    }
    
    th:nth-child(1), td:nth-child(1) { width: 120px; min-width: 120px; }
    th:nth-child(2), td:nth-child(2) { width: 180px; min-width: 180px; }
    th:nth-child(3), td:nth-child(3) { width: 140px; min-width: 140px; }
    th:nth-child(4), td:nth-child(4) { width: 120px; min-width: 120px; }
    th:nth-child(5), td:nth-child(5) { width: 180px; min-width: 180px; }
    th:nth-child(6), td:nth-child(6) { width: 150px; min-width: 150px; }
    th:nth-child(7), td:nth-child(7) { width: 250px; min-width: 250px; }
    th:nth-child(8), td:nth-child(8) { width: 180px; min-width: 180px; }
    th:nth-child(9), td:nth-child(9) { width: 120px; min-width: 120px; }
    th:nth-child(10), td:nth-child(10) { width: 140px; min-width: 140px; }
    th:nth-child(11), td:nth-child(11) { width: 160px; min-width: 160px; }
    
    tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    
    tr:hover {
      background-color: #f1f1f1;
    }
    
    input, textarea, button, select {
      box-sizing: border-box;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: 100%;
      font-family: inherit;
      font-size: 14px;
      min-height: 40px;
    }
    
    input[readonly] {
      background-color: #f5f5f5;
    }
    
    button {
      background-color: #0056b3;
      color: white;
      border: none;
      padding: 10px 15px;
      cursor: pointer;
      border-radius: 4px;
      font-weight: 500;
      transition: background-color 0.3s;
      white-space: nowrap;
      min-height: 40px;
    }
    
    button:hover {
      background-color: #003d82;
    }
    
    .action-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .action-buttons button {
      padding: 8px 12px;
      min-width: 40px;
      flex: none;
    }
    
    .add-row-btn {
      background-color: #28a745;
      margin-bottom: 15px;
      padding: 12px 20px;
      font-size: 16px;
    }
    
    .add-row-btn:hover {
      background-color: #218838;
    }
    
    .submit-btn {
      background-color: #dc3545;
      margin-top: 20px;
      padding: 15px 25px;
      font-size: 18px;
      font-weight: bold;
    }
    
    .submit-btn:hover {
      background-color: #c82333;
    }
    
    #responseMessage {
      margin-top: 15px;
      padding: 15px;
      border-radius: 4px;
      text-align: center;
      font-size: 16px;
    }
    
    .success {
      background-color: #d4edda;
      color: #155724;
    }
    
    .error {
      background-color: #f8d7da;
      color: #721c24;
    }
    
    .hidden {
      display: none;
    }
    
    .addSimilar {
      background-color: #17a2b8;
      min-width: 35px;
      padding: 8px;
    }
    
    .addSimilar:hover {
      background-color: #138496;
    }
    
    .removeRow {
      background-color: #6c757d;
    }
    
    .removeRow:hover {
      background-color: #5a6268;
    }
    
    .editable {
      background-color: #fff !important;
    }
    
    select {
      appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 18px;
      padding-right: 35px;
    }
    
    .page-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .page-container select {
      min-width: 180px;
      flex: 1;
    }
    
    .page-container button {
      flex: none;
      min-width: 40px;
      width: 40px;
    }
    
    .market-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .market-container input {
      flex: 1;
    }
    
    .market-container button {
      flex: none;
      min-width: 40px;
      width: 40px;
    }
    
    @media (max-width: 1200px) {
      .container {
        margin: 10px;
        padding: 15px;
      }
      
      th, td {
        padding: 10px;
        font-size: 13px;
      }
      
      input, select, button {
        padding: 8px;
        font-size: 13px;
        min-height: 36px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <img src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Ff930e667.%E1%BA%A2nh.025539.jpg" alt="LumiGlobal Logo" class="logo">
      <h1>B√°o C√°o MKT LumiGlobal</h1>
    </div>

    <button id="addRow" type="button" class="add-row-btn">‚ûï Th√™m d√≤ng tr·ªëng</button>

    <form id="dataForm">
      <table id="dataTable">
        <thead>
          <tr>
            <th>H√†nh ƒë·ªông</th>
            <th>T√™n</th>
            <th>Ng√†y</th>
            <th>Ca</th>
            <th>S·∫£n ph·∫©m</th>
            <th>Th·ªã tr∆∞·ªùng</th>
            <th>Page</th>
            <th>TKQC</th>
            <th>CPQC</th>
            <th>Via log</th>
            <th>S·ªë Mess+Cmt</th>
            <th class="hidden">id</th>
            <th class="hidden">Team</th>
            <th class="hidden">id NS</th>
          </tr>
        </thead>
        <tbody>
          <!-- C√°c d√≤ng s·∫Ω ƒë∆∞·ª£c th√™m t·ª± ƒë·ªông v√†o ƒë√¢y -->
        </tbody>
      </table>
      <button type="submit" id="submitBtn" class="submit-btn">üöÄ G·ª≠i b√°o c√°o</button>
    </form>

    <p id="responseMessage"></p>
  </div>

  <script>
    const addRowBtn = document.getElementById('addRow');
    const tbody = document.querySelector('#dataTable tbody');
    const form = document.getElementById('dataForm');
    const respMsg = document.getElementById('responseMessage');
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxYhaBqZfunQD_d6nY9E8Gq5d43S3T4iGxbHUSpNa_4bWY30e3pb5JgQWTwpPapziE/exec';

    // C√°c danh s√°ch s·∫Ω ƒë∆∞·ª£c l·∫•y t·ª´ API
    let employeeList = [];
    let tkqcData = {};
    let pageData = {};

    // Danh s√°ch s·∫£n ph·∫©m
    const productList = [
      "Kem body", "CF FG", "CB BAKU", "Bakuchiol", "C√† ph√™", "N√°m", 
      "K·∫πo D√¢u", "Serum S√¢m", "K·∫πo D√¢u New", "Body TBN", "Baku TBN", "DG", "K·∫πo T√°o"
    ];

    // Danh s√°ch th·ªã tr∆∞·ªùng
    const marketList = ["Nh·∫≠t", "H√†n", "Canada", "US", "√öc", "Anh"];

    // Danh s√°ch ca
    const shiftList = ["H·∫øt ca", "Gi·ªØa ca", "Ca Chi·ªÅu"];

    // L·∫•y danh s√°ch nh√¢n vi√™n, TKQC v√† Page t·ª´ API
    async function loadEmployeeData() {
      try {
        const response = await fetch(SCRIPT_URL + '?action=getData');
        const data = await response.json();
        
        if (data && data.status === "success") {
          // X·ª≠ l√Ω d·ªØ li·ªáu nh√¢n vi√™n
          if (data.data && data.data.employees) {
            employeeList = data.data.employees;
          }
          
          // X·ª≠ l√Ω d·ªØ li·ªáu TKQC
          if (data.data && data.data.tkqcData) {
            tkqcData = data.data.tkqcData;
          }

          // X·ª≠ l√Ω d·ªØ li·ªáu Page
          if (data.data && data.data.pageData) {
            pageData = data.data.pageData;
          }
          
          console.log('ƒê√£ t·∫£i d·ªØ li·ªáu:', {
            employees: employeeList,
            tkqcData: tkqcData,
            pageData: pageData
          });
        } else {
          throw new Error(data.message || 'Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu t·ª´ server');
        }
      } catch (error) {
        console.error('L·ªói khi t·∫£i d·ªØ li·ªáu:', error);
        // S·ª≠ d·ª•ng d·ªØ li·ªáu m·∫´u n·∫øu API kh√¥ng ho·∫°t ƒë·ªông
        employeeList = [
          "Ph·∫°m Ti·∫øn Th√†nh", "L√™ ƒê√¨nh To·∫£n", "Tr·∫ßn Qu·ªëc Kh·∫£i", "M·∫°nh C∆∞·ªùng",
          "Nguy·ªÖn Th·ªã Hi·∫øu", "V≈© Vi·∫øt Anh", "L·ª•c Tr·∫ßn Minh Tr√≠", "ƒêo√†n Ng·ªçc Hu√¢n",
          "Nguy·ªÖn Hi·ªÅn L∆∞∆°ng", "Tr·∫ßn Huy H√πng", "Nguy·ªÖn Anh Tu·∫•n", "Tr·∫ßn Ti·∫øn",
          "Nguy·ªÖn Th·ªã Nh∆∞ Qu·ª≥nh", "Nguy·ªÖn Quang Tr∆∞·ªùng"
        ];
        
        tkqcData = {
          "Ph·∫°m Ti·∫øn Th√†nh": ["tcm 393(1)", "lumi hn 05(1)", "lumi hn 06", "lumi hn 53", "lumi hn 54", "lumi hn 68", "lumi hn 75", "lumi hn 82", "lumi hn 83"],
          "L√™ ƒê√¨nh To·∫£n": ["tcm 427-b", "lumi hn 26", "lumi hn 40"],
          "Tr·∫ßn Qu·ªëc Kh·∫£i": ["tcm 369-b(1)", "tcm 380(1)", "tcm 455", "lumi hn 12", "lumi hn 35", "lumi hn 47", "lumi hn 48"],
          "M·∫°nh C∆∞·ªùng": ["tcm 376-b", "tcm 378(1)", "tcm 394(1)", "tcm 407(1)", "tcm 442(1)", "lumi hn 04", "lumi hn 24", "lumi hn 50", "lumi hn 63"],
        };

        pageData = {
          "Ph·∫°m Ti·∫øn Th√†nh": ["Page ABC", "Page XYZ", "Page 123"],
          "L√™ ƒê√¨nh To·∫£n": ["Page DEF", "Page UVW"],
          "Tr·∫ßn Qu·ªëc Kh·∫£i": ["Page GHI", "Page RST"],
          "M·∫°nh C∆∞·ªùng": ["Page JKL", "Page OPQ"]
        };
      }
    }

    // Format date as YYYY-MM-DD
    function formatDate(date) {
      const d = new Date(date);
      let month = '' + (d.getMonth() + 1);
      let day = '' + d.getDate();
      const year = d.getFullYear();

      if (month.length < 2) month = '0' + month;
      if (day.length < 2) day = '0' + day;

      return [year, month, day].join('-');
    }

    // Get today's date
    function getToday() {
      return formatDate(new Date());
    }

    // T·∫°o m·ªôt d√≤ng m·ªõi
    function createRow(data = {}, insertAfter = null) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="action-buttons">
          <button type="button" class="removeRow" title="X√≥a d√≤ng">‚ùå</button>
        </td>
        <td>
          <select name="T√™n" class="editable name-select" required>
            <option value="">-- Ch·ªçn t√™n --</option>
            ${employeeList.map(name => 
              `<option value="${name}" ${data.T√™n === name ? 'selected' : ''}>${name}</option>`
            ).join('')}
          </select>
        </td>
        <td><input name="Ng√†y" type="date" value="${data.Ng√†y || getToday()}" class="editable" required></td>
        <td>
          <select name="ca" class="editable" required>
            <option value="">-- Ch·ªçn ca --</option>
            ${shiftList.map(shift => 
              `<option value="${shift}" ${data.ca === shift ? 'selected' : ''}>${shift}</option>`
            ).join('')}
          </select>
        </td>
        <td>
          <input name="S·∫£n_ph·∫©m" list="productList" value="${data.S·∫£n_ph·∫©m || ''}" class="editable" placeholder="Nh·∫≠p ho·∫∑c ch·ªçn s·∫£n ph·∫©m">
          <datalist id="productList">
            ${productList.map(product => `<option value="${product}">`).join('')}
          </datalist>
        </td>
        <td>
          <div class="market-container">
            <input name="Th·ªã_tr∆∞·ªùng" list="marketList" value="${data.Th·ªã_tr∆∞·ªùng || ''}" class="editable" placeholder="Nh·∫≠p th·ªã tr∆∞·ªùng">
            <datalist id="marketList">
              ${marketList.map(market => `<option value="${market}">`).join('')}
            </datalist>
            <button type="button" class="addSimilar addSimilarMarket" title="Th√™m d√≤ng t∆∞∆°ng t·ª± t·ª´ th·ªã tr∆∞·ªùng">‚ûï</button>
          </div>
        </td>
        <td>
          <div class="page-container">
            <select name="page" class="editable page-select">
              <option value="">-- Ch·ªçn Page --</option>
              ${data.T√™n && pageData[data.T√™n] ? pageData[data.T√™n].map(page => 
                `<option value="${page}" ${data.page === page ? 'selected' : ''}>${page}</option>`
              ).join('') : ''}
            </select>
            <button type="button" class="addSimilar addSimilarPage" title="Th√™m d√≤ng t∆∞∆°ng t·ª± t·ª´ page">‚ûï</button>
          </div>
        </td>
        <td>
          <select name="TKQC" class="editable tkqc-select">
            <option value="">-- Ch·ªçn TKQC --</option>
            ${data.T√™n && tkqcData[data.T√™n] ? tkqcData[data.T√™n].map(tkqc => 
              `<option value="${tkqc}" ${data.TKQC === tkqc ? 'selected' : ''}>${tkqc}</option>`
            ).join('') : ''}
          </select>
        </td>
        <td><input name="CPQC" value="${data.CPQC || ''}" placeholder="Chi ph√≠ QC"></td>
        <td><input name="Via_log" value="${data.Via_log || ''}" placeholder="Via log"></td>
        <td><input name="S·ªë_Mess_Cmt" value="${data.S·ªë_Mess_Cmt || ''}" placeholder="S·ªë Mess+Cmt"></td>
        <td class="hidden"><input name="id" value="${data.id || 'id_' + Date.now()}" readonly></td>
        <td class="hidden"><input name="Team" value="${data.Team || 'MKT'}" readonly></td>
        <td class="hidden"><input name="id_NS" value="${data.id_NS || ''}" readonly></td>
      `;

      // X·ª≠ l√Ω s·ª± ki·ªán x√≥a d√≤ng
      tr.querySelector('.removeRow').addEventListener('click', () => {
        if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a d√≤ng n√†y?')) {
          tr.remove();
        }
      });
      
      // X·ª≠ l√Ω khi ch·ªçn t√™n nh√¢n vi√™n
      const nameSelect = tr.querySelector('.name-select');
      nameSelect.addEventListener('change', function() {
        const selectedName = this.value;
        const tkqcSelect = tr.querySelector('.tkqc-select');
        const pageSelect = tr.querySelector('.page-select');
        
        // C·∫≠p nh·∫≠t TKQC
        tkqcSelect.innerHTML = '<option value="">-- Ch·ªçn TKQC --</option>';
        if (selectedName && tkqcData[selectedName]) {
          tkqcData[selectedName].forEach(tkqc => {
            const option = document.createElement('option');
            option.value = tkqc;
            option.textContent = tkqc;
            tkqcSelect.appendChild(option);
          });
        }

        // C·∫≠p nh·∫≠t Page
        pageSelect.innerHTML = '<option value="">-- Ch·ªçn Page --</option>';
        if (selectedName && pageData[selectedName]) {
          pageData[selectedName].forEach(page => {
            const option = document.createElement('option');
            option.value = page;
            option.textContent = page;
            pageSelect.appendChild(option);
          });
        }
      });
      
      // N√∫t th√™m d√≤ng t·ª´ th·ªã tr∆∞·ªùng
      tr.querySelector('.addSimilarMarket').addEventListener('click', () => {
        const newRow = createRow({
          id: 'id_' + Date.now(),
          T√™n: tr.querySelector('[name="T√™n"]').value,
          Ng√†y: tr.querySelector('[name="Ng√†y"]').value,
          ca: tr.querySelector('[name="ca"]').value,
          S·∫£n_ph·∫©m: tr.querySelector('[name="S·∫£n_ph·∫©m"]').value,
          Th·ªã_tr∆∞·ªùng: tr.querySelector('[name="Th·ªã_tr∆∞·ªùng"]').value,
          Team: 'MKT'
        }, tr);
        
        // Focus v√†o √¥ page c·ªßa d√≤ng m·ªõi
        const pageSelect = newRow.querySelector('[name="page"]');
        if (pageSelect) pageSelect.focus();
      });
      
      // N√∫t th√™m d√≤ng t·ª´ page
      tr.querySelector('.addSimilarPage').addEventListener('click', () => {
        const newRow = createRow({
          id: 'id_' + Date.now(),
          T√™n: tr.querySelector('[name="T√™n"]').value,
          Ng√†y: tr.querySelector('[name="Ng√†y"]').value,
          ca: tr.querySelector('[name="ca"]').value,
          S·∫£n_ph·∫©m: tr.querySelector('[name="S·∫£n_ph·∫©m"]').value,
          Th·ªã_tr∆∞·ªùng: tr.querySelector('[name="Th·ªã_tr∆∞·ªùng"]').value,
          page: tr.querySelector('[name="page"]').value,
          TKQC: tr.querySelector('[name="TKQC"]').value,
          Team: 'MKT'
        }, tr);
        
        // Focus v√†o √¥ CPQC c·ªßa d√≤ng m·ªõi
        const cpqcInput = newRow.querySelector('[name="CPQC"]');
        if (cpqcInput) cpqcInput.focus();
      });

      // Th√™m d√≤ng v√†o b·∫£ng
      if (insertAfter) {
        tbody.insertBefore(tr, insertAfter.nextSibling);
      } else {
        tbody.appendChild(tr);
      }
      return tr;
    }

    // Th√™m d√≤ng tr·ªëng khi nh·∫•n n√∫t
    addRowBtn.addEventListener('click', () => {
      const newRow = createRow({ 
        id: 'id_' + Date.now(),
        Team: 'MKT'
      });
      
      // Focus v√†o √¥ ƒë·∫ßu ti√™n c√≥ th·ªÉ edit c·ªßa d√≤ng m·ªõi
      const firstEditable = newRow.querySelector('.name-select');
      if (firstEditable) firstEditable.focus();
    });

    // X·ª≠ l√Ω submit form
    form.addEventListener('submit', e => {
      e.preventDefault();
      
      // L·∫•y t·∫•t c·∫£ d·ªØ li·ªáu t·ª´ c√°c d√≤ng
      const allRows = Array.from(tbody.querySelectorAll('tr')).map(tr => {
        const obj = {};
        tr.querySelectorAll('input, textarea, select').forEach(inp => {
          if (inp.name) {
            obj[inp.name] = inp.value.trim();
          }
        });
        return obj;
      });
      
      // Ki·ªÉm tra c√≥ d√≤ng n√†o kh√¥ng
      if (!allRows.length) {
        respMsg.className = 'error';
        respMsg.innerText = 'Ch∆∞a c√≥ d√≤ng n√†o ƒë·ªÉ g·ª≠i!';
        return;
      }
      
      // Ki·ªÉm tra c√°c tr∆∞·ªùng b·∫Øt bu·ªôc
      let hasError = false;
      allRows.forEach((row, index) => {
        if (!row.T√™n || !row.Ng√†y || !row.ca) {
          hasError = true;
          respMsg.className = 'error';
          respMsg.innerText = `D√≤ng ${index + 1}: Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß T√™n, Ng√†y v√† Ca!`;
        }
      });
      
      if (hasError) return;
      
      // Hi·ªÉn th·ªã loading
      respMsg.className = '';
      respMsg.style.color = '#0056b3';
      respMsg.innerText = 'ƒêang g·ª≠i b√°o c√°o...';
      
      console.log('D·ªØ li·ªáu g·ª≠i ƒëi:', allRows);
      
      const payload = new URLSearchParams({ 
        rows: JSON.stringify(allRows),
        action: 'submit'
      });
      
      fetch(SCRIPT_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: payload
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(json => {
        console.log('Ph·∫£n h·ªìi t·ª´ server:', json);
        respMsg.className = json.error ? 'error' : 'success';
        respMsg.innerText = json.error ? 'L·ªói: ' + json.error : (json.message || 'G·ª≠i b√°o c√°o th√†nh c√¥ng!');
        
        if (!json.error) {
          // X√≥a t·∫•t c·∫£ d√≤ng v√† th√™m d√≤ng m·ªõi
          tbody.innerHTML = '';
          createRow({ 
            id: 'id_' + Date.now(),
            Team: 'MKT'
          });
        }
      })
      .catch(err => {
        console.error('L·ªói g·ª≠i:', err);
        respMsg.className = 'error';
        respMsg.innerText = 'L·ªói g·ª≠i: ' + err.message;
      });
    });

    // T·ª± ƒë·ªông th√™m d√≤ng ƒë·∫ßu ti√™n khi t·∫£i trang
    window.addEventListener('load', async () => {
      await loadEmployeeData();
      createRow({ 
        id: 'id_' + Date.now(),
        Team: 'MKT'
      });
    });
  </script>
</body>
</html>
















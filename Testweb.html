// Đặt mã này vào file Code.gs của bạn
function doPost(e) {
  try {
    // 1. Phân tích dữ liệu JSON từ request
    var data = JSON.parse(e.postData.contents);
    var rows = data.rows; 
    
    // 2. Mở trang tính
    // Thay 'Sheet1' bằng tên trang tính thực tế của bạn, ví dụ 'FormEntries'
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Sheet1"); 
    
    // 3. Lấy tiêu đề để đảm bảo ghi đúng cột
    // Tiêu đề trong Sheet phải là: name, email, message, dogf
    var headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    var headerMap = {};
    headers.forEach(function(h, i) { headerMap[h.toLowerCase().trim()] = i; });

    // 4. Chuẩn bị dữ liệu để ghi
    var valuesToAppend = rows.map(function(rowData) {
      var newRow = new Array(headers.length); // Tạo một mảng trống
      for (var key in rowData) {
        var normalizedKey = key.toLowerCase().trim();
        if (headerMap.hasOwnProperty(normalizedKey)) {
          var colIndex = headerMap[normalizedKey];
          newRow[colIndex] = rowData[key];
        }
      }
      return newRow;
    });
    
    // 5. Ghi dữ liệu vào trang tính
    if (valuesToAppend.length > 0) {
      sheet.getRange(sheet.getLastRow() + 1, 1, valuesToAppend.length, headers.length).setValues(valuesToAppend);
    }

    // 6. Trả về phản hồi thành công (CỰC KỲ QUAN TRỌNG ĐỂ TRÁNH LỖI CORS)
    return ContentService
      .createTextOutput(JSON.stringify({ "status": "success", "message": "Đã nhận và xử lý " + rows.length + " dòng." }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    // 7. Trả về phản hồi lỗi nếu có vấn đề
    return ContentService
      .createTextOutput(JSON.stringify({ "status": "error", "message": error.message }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}













<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Form G·ª≠i D·ªØ Li·ªáu (ƒê√£ s·ª≠a l·ªói)</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 1600px; margin: 20px auto; padding: 0 20px; }
    h2 { text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; table-layout: fixed; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; font-size: 14px; vertical-align: top; }
    th { background-color: #f2f2f2; font-weight: bold; }
    input, select { width: 100%; box-sizing: border-box; font-size: 14px; padding: 4px; border: 1px solid #ddd; border-radius: 3px;}
    input:disabled { background-color: #f5f5f5; cursor: not-allowed; }
    button { padding: 8px 15px; font-size: 14px; cursor: pointer; border: none; border-radius: 4px; }
    #addRow { background-color: #28a745; color: white; margin-bottom: 15px; }
    #submitBtn { background-color: #007bff; color: white; margin-top: 15px; width: 100%; font-weight: bold; }
    .removeRow { background-color: #dc3545; color: white; padding: 4px 8px; font-size: 12px; }
    #responseMessage { text-align: center; font-weight: bold; margin-top: 15px; }
    .idcol { display: none; }
    #dataTable th:nth-child(1) { width: 5%; } #dataTable th:nth-child(3) { width: 10%; } #dataTable th:nth-child(4) { width: 8%; } #dataTable th:nth-child(5) { width: 7%; } #dataTable th:nth-child(6) { width: 8%; } #dataTable th:nth-child(7) { width: 7%; } #dataTable th:nth-child(8) { width: 8%; } #dataTable th:nth-child(9) { width: 10%; } #dataTable th:nth-child(10) { width: 6%; }
  </style>
</head>
<body>
  <h2>G·ª≠i Nhi·ªÅu D√≤ng D·ªØ Li·ªáu</h2>
  <button id="addRow" type="button">‚ûï Th√™m d√≤ng</button>
  <form id="dataForm">
    <table id="dataTable">
      <thead>
        <tr>
          <th>H√†nh ƒë·ªông</th>
          <th class="idcol">id</th>
          <th>T√™n</th>
          <th>Ng√†y</th>
          <th>Ca</th>
          <th>S·∫£n ph·∫©m</th>
          <th>Th·ªã tr∆∞·ªùng</th>
          <th>Page</th>
          <th>TKQC</th>
          <th>CPQC</th>
          <th>Via log</th>
          <th>S·ªë Mess+Cmt</th>
          <th>S·ªë ƒë∆°n</th>
          <th>DS Ch·ªët</th>
          <th>S·ªë ƒë∆°n Ho√†n/H·ªßy</th>
          <th>DS sau Ho√†n/H·ªßy</th>
          <th>S·ªë ƒë∆°n sau ho√†n hu·ª∑</th>
          <th>Team</th>
          <th>id NS</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button type="submit" id="submitBtn">üöÄ G·ª≠i t·∫•t c·∫£</button>
  </form>
  <p id="responseMessage"></p>

  <datalist id="productList"><option value="Kem body"></option><option value="CF FG"></option><option value="CB BAKU"></option><option value="Bakuchiol"></option><option value="C√† ph√™"></option><option value="N√°m"></option><option value="K·∫πo D√¢u"></option><option value="Serum S√¢m"></option><option value="K·∫πo D√¢u New"></option><option value="Body TBN"></option><option value="Baku TBN"></option><option value="DG"></option><option value="K·∫πo T√°o"></option></datalist>
  <datalist id="marketList"><option value="Nh·∫≠t"></option><option value="H√†n"></option><option value="Canada"></option><option value="US"></option><option value="√öc"></option><option value="Anh"></option></datalist>

  <script>
    const addRowBtn = document.getElementById('addRow');
    const tbody = document.querySelector('#dataTable tbody');
    const form = document.getElementById('dataForm');
    const respMsg = document.getElementById('responseMessage');
    let rowCounter = 0;

    const tkqcToNameMap = {
      'tcm 369-b(1)': 'Tr·∫ßn Qu·ªëc Kh·∫£i', 'tcm 376-b': 'M·∫°nh C∆∞·ªùng', 'tcm 378(1)': 'M·∫°nh C∆∞·ªùng', 'tcm 380(1)': 'Tr·∫ßn Qu·ªëc Kh·∫£i', 'tcm 393(1)': 'Ph·∫°m Ti·∫øn Th√†nh', 'tcm 394(1)': 'M·∫°nh C∆∞·ªùng', 'tcm 399-b': 'L·ª•c Tr·∫ßn Minh Tr√≠', 'tcm 407(1)': 'M·∫°nh C∆∞·ªùng', 'tcm 410-b(1)': 'Nguy·ªÖn Hi·ªÅn L∆∞∆°ng', 'tcm 413-b': 'Nguy·ªÖn Th·ªã Hi·∫øu', 'tcm 427-b': 'L√™ ƒê√¨nh To·∫£n', 'tcm 434-b(1)': 'Nguy·ªÖn Hi·ªÅn L∆∞∆°ng', 'tcm 440(1)': 'Nguy·ªÖn Th·ªã Hi·∫øu', 'tcm 442(1)': 'M·∫°nh C∆∞·ªùng', 'tcm 443(1)': 'Nguy·ªÖn Th·ªã Hi·∫øu', 'tcm 449(1)': 'Ph·∫°m Ti·∫øn Th√†nh', 'tcm 455': 'Tr·∫ßn Qu·ªëc Kh·∫£i', 'tcm  395': 'Nguy·ªÖn Anh Tu·∫•n', 'tcm 426-b': 'Tr·∫ßn Ti·∫øn', 'tcm 403': '', 'lumi hn 01': 'Tr·∫ßn Huy H√πng', 'lumi hn 03(1)': 'ƒêo√†n Ng·ªçc Hu√¢n', 'lumi hn 04': 'M·∫°nh C∆∞·ªùng', 'lumi hn 05(1)': 'Ph·∫°m Ti·∫øn Th√†nh', 'lumi hn 06': 'Ph·∫°m Ti·∫øn Th√†nh', 'lumi hn 08 hold': 'Nguy·ªÖn Th·ªã Nh∆∞ Qu·ª≥nh', 'lumi hn 10': 'Nguy·ªÖn Th·ªã Hi·∫øu', 'lumi hn 12': 'Tr·∫ßn Qu·ªëc Kh·∫£i', 'lumi hn 19': 'L·ª•c Tr·∫ßn Minh Tr√≠', 'lumi hn 23(hold)': 'Nguy·ªÖn Th·ªã Hi·∫øu', 'lumi hn 24': 'M·∫°nh C∆∞·ªùng', 'lumi hn 25': 'Nguy·ªÖn Th·ªã Hi·∫øu', 'lumi hn 26': 'L√™ ƒê√¨nh To·∫£n', 'lumi hn 27': 'L·ª•c Tr·∫ßn Minh Tr√≠', 'lumi hn 30': 'Nguy·ªÖn Th·ªã Nh∆∞ Qu·ª≥nh', 'lumi hn 33': 'Nguy·ªÖn Th·ªã Hi·∫øu', 'lumi  hn 34': 'L·ª•c Tr·∫ßn Minh Tr√≠', 'lumi hn 35': 'Tr·∫ßn Qu·ªëc Kh·∫£i', 'lumi hn 37': 'V≈© Vi·∫øt Anh', 'lumi hn 40': 'L√™ ƒê√¨nh To·∫£n', 'lumi hn 42': 'ƒêo√†n Ng·ªçc Hu√¢n', 'lumi hn 44': 'L·ª•c Tr·∫ßn Minh Tr√≠', 'lumi hn 45': 'L·ª•c Tr·∫ßn Minh Tr√≠', 'lumi hn 46': 'V≈© Vi·∫øt Anh', 'lumi hn 47': 'Tr·∫ßn Qu·ªëc Kh·∫£i', 'lumi hn 48': 'Tr·∫ßn Qu·ªëc Kh·∫£i', 'lumi hn 49': 'L·ª•c Tr·∫ßn Minh Tr√≠', 'lumi hn 50': 'M·∫°nh C∆∞·ªùng', 'lumi hn 51': 'ƒêo√†n Ng·ªçc Hu√¢n', 'lumi hn 53': 'Ph·∫°m Ti·∫øn Th√†nh', 'lumi hn 54': 'Ph·∫°m Ti·∫øn Th√†nh', 'lumi hn 55': 'Nguy·ªÖn Quang Tr∆∞·ªùng', 'c∆∞·ªùng test 01': 'Test team C∆∞·ªùng', 'lumi hn 61': 'Nguy·ªÖn Th·ªã Hi·∫øu', 'lumi hn 62': 'L·ª•c Tr·∫ßn Minh Tr√≠', 'lumi hn 63': 'M·∫°nh C∆∞·ªùng', 'lumi hn 64': 'L·ª•c Tr·∫ßn Minh Tr√≠', 'lumi hn 65 -7': 'L·ª•c Tr·∫ßn Minh Tr√≠', 'lumi hn 70-7': 'Nguy·ªÖn Th·ªã Hi·∫øu', 'lumi hn 66': 'Nguy·ªÖn Hi·ªÅn L∆∞∆°ng', 'lumi hn 67': 'Tr·∫ßn Huy H√πng', 'lumi hn 71': 'ƒêo√†n Ng·ªçc Hu√¢n', 'lumi hn 72': 'Nguy·ªÖn Quang Tr∆∞·ªùng', 'lumi hn 74': 'V≈© Vi·∫øt Anh', 'lumi hn 75': 'Ph·∫°m Ti·∫øn Th√†nh', 'lumi hn 76': 'Tr·∫ßn Ti·∫øn', 'lumi hn 77': 'Nguy·ªÖn Th·ªã Nh∆∞ Qu·ª≥nh', 'lumi hn 78': 'Nguy·ªÖn Anh Tu·∫•n', 'lumi hn 79': 'Nguy·ªÖn Hi·ªÅn L∆∞∆°ng', 'lumi hn 81': 'Nguy·ªÖn Hi·ªÅn L∆∞∆°ng', 'lumi hn 82': 'Ph·∫°m Ti·∫øn Th√†nh', 'lumi hn 83': 'Ph·∫°m Ti·∫øn Th√†nh', 'lumi hn 85 mst': 'Tr·∫ßn Huy H√πng', 'lmi hn 84 mst': 'Nguy·ªÖn Hi·ªÅn L∆∞∆°ng'
    };
    
    const nameToTkqcMap = {};
    for (const tkqc in tkqcToNameMap) {
        const name = tkqcToNameMap[tkqc];
        if (name) {
            if (!nameToTkqcMap[name]) nameToTkqcMap[name] = [];
            nameToTkqcMap[name].push(tkqc);
        }
    }

    function createRow(data = {}) {
      rowCounter++;
      const tr = document.createElement('tr');
      const today = new Date().toISOString().split('T')[0];
      const tkqcListId = `tkqcList-row-${rowCounter}`;

      tr.innerHTML = `
        <td><button type="button" class="removeRow">‚ùå</button></td>
        <td class="idcol"><input name="id" value="${data.id || ''}"></td>
        <td><select name="name"><option value="">-- Ch·ªçn T√™n --</option></select></td>
        <td><input name="ngay" type="date" value="${data.ngay || today}"></td>
        <td><select name="ca"><option value="">--Ch·ªçn Ca--</option><option value="H·∫øt ca">H·∫øt ca</option><option value="Gi·ªØa ca">Gi·ªØa ca</option><option value="Ca Chi·ªÅu">Ca Chi·ªÅu</option></select></td>
        <td><input name="sanpham" list="productList" value="${data.sanpham || ''}"></td>
        <td><input name="thitruong" list="marketList" value="${data.thitruong || ''}"></td>
        <td><input name="page" value="${data.page || ''}"></td>
        <td><input name="tkqc" list="${tkqcListId}" placeholder="Ch·ªçn T√™n tr∆∞·ªõc" disabled><datalist id="${tkqcListId}"></datalist></td>
        <td><input name="cpqc" type="number" value="${data.cpqc || ''}"></td>
        <td><input name="vialog" value="${data.vialog || ''}"></td>
        <td><input name="messcmt" type="number" value="${data.messcmt || ''}"></td>
        <td><input name="sodon" type="number" value="${data.sodon || ''}"></td>
        <td><input name="dschot" type="number" value="${data.dschot || ''}"></td>
        <td><input name="donhuy" type="number" value="${data.donhuy || ''}"></td>
        <td><input name="dssauhh" type="number" value="${data.dssauhh || ''}"></td>
        <td><input name="sosauhh" type="number" value="${data.sosauhh || ''}"></td>
        <td><input name="team" value="${data.team || ''}"></td>
        <td><input name="idns" value="${data.idns || ''}"></td>
      `;
      
      tr.querySelector('.removeRow').addEventListener('click', () => tr.remove());
      tbody.appendChild(tr);

      const nameSelect = tr.querySelector('select[name="name"]');
      const tkqcInput = tr.querySelector('input[name="tkqc"]');
      const tkqcDatalist = tr.querySelector(`#${tkqcListId}`);

      Object.keys(nameToTkqcMap).sort().forEach(name => {
          nameSelect.innerHTML += `<option value="${name}">${name}</option>`;
      });

      nameSelect.addEventListener('change', (e) => {
          const selectedName = e.target.value;
          tkqcInput.value = '';
          tkqcDatalist.innerHTML = '';
          if (selectedName && nameToTkqcMap[selectedName]) {
              tkqcInput.disabled = false;
              tkqcInput.placeholder = 'Nh·∫≠p ho·∫∑c ch·ªçn TKQC';
              nameToTkqcMap[selectedName].forEach(tkqc => {
                  tkqcDatalist.innerHTML += `<option value="${tkqc}"></option>`;
              });
          } else {
              tkqcInput.disabled = true;
              tkqcInput.placeholder = 'Ch·ªçn T√™n tr∆∞·ªõc';
          }
      });
      
      // *** ƒê√ÇY L√Ä PH·∫¶N QUAN TR·ªåNG ƒê·ªÇ ƒêI·ªÄN S·∫¥N D·ªÆ LI·ªÜU ***
      // N√≥ s·∫Ω t·ª± ƒëi·ªÅn gi√° tr·ªã t·ª´ object `data` v√†o c√°c √¥ input/select
      for (const key in data) {
          const element = tr.querySelector(`[name="${key}"]`);
          if (element) {
              element.value = data[key];
              // K√≠ch ho·∫°t s·ª± ki·ªán 'change' ƒë·ªÉ c·∫≠p nh·∫≠t c√°c √¥ ph·ª• thu·ªôc (nh∆∞ TKQC)
              if (element.name === 'name') {
                  element.dispatchEvent(new Event('change'));
                  // C·∫ßn m·ªôt kho·∫£ng tr·ªÖ nh·ªè ƒë·ªÉ datalist c·ªßa TKQC ƒë∆∞·ª£c c·∫≠p nh·∫≠t tr∆∞·ªõc khi set gi√° tr·ªã
                  setTimeout(() => {
                      const tkqcElement = tr.querySelector('[name="tkqc"]');
                      if(tkqcElement) tkqcElement.value = data['tkqc'] || '';
                  }, 0);
              }
          }
      }
    }
    
    // *** M·ªöI: H√ÄM ƒê·ªåC D·ªÆ LI·ªÜU T·ª™ URL ƒê·ªÇ ƒêI·ªÄN S·∫¥N FORM ***
    function prefillFormFromUrl() {
        const params = new URLSearchParams(window.location.search);
        const rowsParam = params.get('rows');
        if (rowsParam) {
            try {
                const rowsData = JSON.parse(rowsParam);
                if (Array.isArray(rowsData) && rowsData.length > 0) {
                    tbody.innerHTML = ''; // X√≥a d√≤ng tr·ªëng m·∫∑c ƒë·ªãnh
                    rowsData.forEach(rowData => createRow(rowData));
                } else {
                    createRow(); // N·∫øu d·ªØ li·ªáu kh√¥ng h·ª£p l·ªá, t·∫°o d√≤ng tr·ªëng
                }
            } catch (e) {
                console.error("L·ªói khi ƒë·ªçc d·ªØ li·ªáu t·ª´ URL:", e);
                createRow(); // N·∫øu l·ªói, t·∫°o d√≤ng tr·ªëng
            }
        } else {
            createRow(); // N·∫øu kh√¥ng c√≥ tham s·ªë 'rows', t·∫°o d√≤ng tr·ªëng
        }
    }

    document.addEventListener('DOMContentLoaded', prefillFormFromUrl);
    addRowBtn.addEventListener('click', () => createRow());

    // *** PH·∫¶N G·ª¨I D·ªÆ LI·ªÜU ƒê√É ƒê∆Ø·ª¢C S·ª¨A L·∫†I ƒê√öNG ***
    form.addEventListener('submit', e => {
      e.preventDefault(); // *** C·ª∞C K·ª≤ QUAN TR·ªåNG: NgƒÉn form t·ª± g·ª≠i ƒëi v√† t·∫£i l·∫°i trang ***
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      respMsg.innerText = 'ƒêang g·ª≠i d·ªØ li·ªáu...';
      respMsg.style.color = 'orange';

      const allRows = Array.from(tbody.querySelectorAll('tr')).map(tr => {
        const rowData = {};
        tr.querySelectorAll('input, select').forEach(el => {
          if (el.name) rowData[el.name] = el.value;
        });
        return rowData;
      });

      if (!allRows.length) {
        respMsg.style.color = 'red';
        respMsg.innerText = 'Ch∆∞a c√≥ d√≤ng n√†o ƒë·ªÉ g·ª≠i!';
        submitBtn.disabled = false;
        return;
      }
      
      const scriptURL = 'https://script.google.com/macros/s/AKfycbx3FBVxpPbcPavMUtfLsbq0VNbnjjnL__F-eJXiVmAbYaiU7XLQbCDAfhsGu2Rh3MVFMA/exec'; 
      
      fetch(scriptURL, {
        method: 'POST', // G·ª≠i b·∫±ng POST
        mode: 'cors',    // Ch·∫ø ƒë·ªô CORS
        headers: { 'Content-Type': 'application/json' }, // B√°o cho server bi·∫øt ƒë√¢y l√† JSON
        body: JSON.stringify({ rows: allRows }) // D·ªØ li·ªáu ƒë∆∞·ª£c ƒë·∫∑t trong body
      })
      .then(response => {
          if (!response.ok) { // N·∫øu server tr·∫£ v·ªÅ l·ªói (v√≠ d·ª• 4xx, 5xx)
             throw new Error(`L·ªói m·∫°ng: ${response.statusText}`);
          }
          return response.json(); // Chuy·ªÉn ƒë·ªïi ph·∫£n h·ªìi th√†nh JSON
      })
      .then(data => {
          console.log('Success:', data);
          respMsg.style.color = 'green';
          respMsg.innerText = data.message || 'G·ª≠i th√†nh c√¥ng!';
          tbody.innerHTML = ''; 
          createRow(); 
          submitBtn.disabled = false;
      })
      .catch(error => {
          console.error('Error!', error);
          respMsg.style.color = 'red';
          respMsg.innerText = `ƒê√£ x·∫£y ra l·ªói khi g·ª≠i: ${error.message}. Vui l√≤ng ki·ªÉm tra Console (F12).`;
          submitBtn.disabled = false;
      });
    });
  </script>
</body>
</html>













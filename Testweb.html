<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Form G·ª≠i Nhi·ªÅu D√≤ng</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 1000px; margin: 30px auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border: 1px solid #ccc; padding: 6px; vertical-align: middle; }
    input, textarea, button { box-sizing: border-box; }
    input[readonly] { background: #f5f5f5; }
    button { cursor: pointer; }
    #responseMessage { margin-top: 12px; font-weight: bold; }
    .addSimilar { margin-left: 4px; }
    .editable { background: #fff !important; }
  </style>
</head>
<body>
  <h2>Th√™m / Ch·ªânh s·ª≠a nhi·ªÅu d√≤ng</h2>
  <button id="addRow" type="button">‚ûï Th√™m d√≤ng tr·ªëng</button>

  <form id="dataForm">
    <table id="dataTable">
      <thead>
        <tr>
          <th>id</th>
          <th>T√™n</th>
          <th>Ng√†y</th>
          <th>Ca</th>
          <th>Page</th>
          <th>TKQC</th>
          <th>Via log</th>
          <th>S·ªë Mess+Cmt</th>
          <th>CPQC</th>
          <th>S·∫£n ph·∫©m</th>
          <th>Th·ªã tr∆∞·ªùng</th>
          <th>S·ªë ƒë∆°n</th>
          <th>DS Ch·ªët</th>
          <th>S·ªë ƒë∆°n Ho√†n/H·ªßy</th>
          <th>DS sau Ho√†n/H·ªßy</th>
          <th>S·ªë ƒë∆°n sau ho√†n hu·ª∑</th>
          <th>Team</th>
          <th>id NS</th>
          <th>H√†nh ƒë·ªông</th>
        </tr>
      </thead>
      <tbody>
        <!-- C√°c d√≤ng s·∫Ω ƒë∆∞·ª£c th√™m t·ª± ƒë·ªông v√†o ƒë√¢y -->
      </tbody>
    </table>
    <button type="submit" id="submitBtn">üöÄ G·ª≠i t·∫•t c·∫£</button>
  </form>

  <p id="responseMessage"></p>

  <script>
    const addRowBtn = document.getElementById('addRow');
    const tbody     = document.querySelector('#dataTable tbody');
    const form      = document.getElementById('dataForm');
    const respMsg   = document.getElementById('responseMessage');
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxIjM0XaM1FvQoquodYmuoCnWO-RBTko6z1PnE3rHEOcfr2Xih48jkzCa1pWus8QuntTQ/exec';

    // T·∫°o m·ªôt d√≤ng m·ªõi, data = object v·ªõi key tr√πng name attribute
    function createRow(data = {}) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input name="id"           value="${data.id         || ''}" readonly></td>
        <td><input name="T√™n"          value="${data.T√™n        || ''}" class="editable"></td>
        <td><input name="Ng√†y"   type="date"  value="${data.Ng√†y       || ''}" readonly></td>
        <td><input name="ca"           value="${data.ca         || ''}" readonly></td>
        <td>
          <div style="display:flex; align-items:center;">
            <input name="page"         value="${data.page       || ''}" class="editable">
            <button type="button" class="addSimilarPage">‚ûï</button>
          </div>
        </td>
        <td><input name="TKQC"         value="${data.TKQC       || ''}"></td>
        <td><input name="Via_log"      value="${data.Via_log    || ''}"></td>
        <td><input name="S·ªë_Mess_Cmt"  value="${data.S·ªë_Mess_Cmt|| ''}"></td>
        <td><input name="CPQC"         value="${data.CPQC       || ''}"></td>
        <td><input name="S·∫£n_ph·∫©m"     value="${data.S·∫£n_ph·∫©m   || ''}" readonly></td>
        <td>
          <div style="display:flex; align-items:center;">
            <input name="Th·ªã_tr∆∞·ªùng"   value="${data.Th·ªã_tr∆∞·ªùng || ''}" readonly>
            <button type="button" class="addSimilarMarket">‚ûï</button>
          </div>
        </td>
        <td><input name="S·ªë_ƒë∆°n"       value="${data.S·ªë_ƒë∆°n    || ''}" readonly></td>
        <td><input name="DS_Ch·ªët"      value="${data.DS_Ch·ªët   || ''}" readonly></td>
        <td><input name="S·ªë_ƒë∆°n_Ho√†n_H·ªßy"   value="${data.S·ªë_ƒë∆°n_Ho√†n_H·ªßy   || ''}" readonly></td>
        <td><input name="DS_sau_Ho√†n_H·ªßy"   value="${data.DS_sau_Ho√†n_H·ªßy   || ''}" readonly></td>
        <td><input name="S·ªë_ƒë∆°n_sau_ho√†n_h·ªßy" value="${data.S·ªë_ƒë∆°n_sau_ho√†n_h·ªßy|| ''}" readonly></td>
        <td><input name="Team"         value="${data.Team       || ''}" readonly></td>
        <td><input name="id_NS"        value="${data.id_NS      || ''}" readonly></td>
        <td><button type="button" class="removeRow">‚ùå</button></td>
      `;
      // x√≥a row
      tr.querySelector('.removeRow').addEventListener('click', () => tr.remove());
      
      // n√∫t ‚ûï th·ªã tr∆∞·ªùng: clone th·ªã tr∆∞·ªùng + s·∫£n ph·∫©m, c√°c tr∆∞·ªùng nh·∫≠p ƒë·ªÉ tr·ªëng
      tr.querySelector('.addSimilarMarket').addEventListener('click', () => {
        const prod   = tr.querySelector('[name="S·∫£n_ph·∫©m"]').value;
        const market = tr.querySelector('[name="Th·ªã_tr∆∞·ªùng"]').value;
        const newId  = 'id_' + Date.now();
        createRow({ 
          id: newId,
          S·∫£n_ph·∫©m: prod,
          Th·ªã_tr∆∞·ªùng: market,
          // C√°c tr∆∞·ªùng kh√°c ƒë·ªÉ tr·ªëng
          TKQC: '',
          Via_log: '',
          S·ªë_Mess_Cmt: '',
          CPQC: '',
          page: ''
        });
      });
      
      // n√∫t ‚ûï page: clone page v√† c√°c tr∆∞·ªùng nh·∫≠p li·ªáu
      tr.querySelector('.addSimilarPage').addEventListener('click', () => {
        const page = tr.querySelector('[name="page"]').value;
        const tkqc = tr.querySelector('[name="TKQC"]').value;
        const via = tr.querySelector('[name="Via_log"]').value;
        const mess = tr.querySelector('[name="S·ªë_Mess_Cmt"]').value;
        const cpqc = tr.querySelector('[name="CPQC"]').value;
        const newId  = 'id_' + Date.now();
        createRow({ 
          id: newId,
          page: page,
          TKQC: tkqc,
          Via_log: via,
          S·ªë_Mess_Cmt: mess,
          CPQC: cpqc,
          // C√°c tr∆∞·ªùng kh√°c gi·ªØ nguy√™n n·∫øu c√≥
          ...data
        });
      });
      
      tbody.appendChild(tr);
    }

    // Prefill: n·∫øu c√≥ ?rows=JSON th√¨ parse v√† danh s√°ch
    (()=>{
      const params = new URLSearchParams(window.location.search);
      const rowsParam = params.get('rows');
      if (rowsParam) {
        try {
          const arr = JSON.parse(decodeURIComponent(rowsParam));
          if (Array.isArray(arr)) arr.forEach(r => createRow(r));
        } catch(e){
          console.warn('Kh√¥ng parse ƒë∆∞·ª£c rows param:', e);
        }
      }
    })();

    // th√™m d√≤ng tr·ªëng (ch·ªâ c√°c tr∆∞·ªùng nh·∫≠p li·ªáu c√≥ th·ªÉ s·ª≠a)
    addRowBtn.addEventListener('click', () => {
      createRow({ id: 'id_' + Date.now() });
    });

    // submit
    form.addEventListener('submit', e => {
      e.preventDefault();
      const allRows = Array.from(tbody.querySelectorAll('tr')).map(tr => {
        const obj = {};
        tr.querySelectorAll('input, textarea').forEach(inp => {
          obj[inp.name] = inp.value;
        });
        return obj;
      });
      if (!allRows.length) {
        respMsg.style.color = 'red';
        return respMsg.innerText = 'Ch∆∞a c√≥ d√≤ng n√†o ƒë·ªÉ g·ª≠i!';
      }
      const payload = new URLSearchParams({ rows: JSON.stringify(allRows) });
      fetch(SCRIPT_URL, {
        method: 'POST',
        body: payload
      })
      .then(r => r.json())
      .then(json => {
        if (json.error) {
          respMsg.style.color = 'red';
          respMsg.innerText = 'L·ªói: ' + json.error;
        } else {
          respMsg.style.color = 'green';
          respMsg.innerText = json.message;
          tbody.innerHTML = '';
        }
      })
      .catch(err => {
        respMsg.style.color = 'red';
        respMsg.innerText = 'L·ªói g·ª≠i: ' + err;
      });
    });
  </script>
</body>
</html>
















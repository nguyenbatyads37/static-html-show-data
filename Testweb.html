<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Form G·ª≠i Nhi·ªÅu D√≤ng</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 1000px; margin: 30px auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border: 1px solid #ccc; padding: 6px; vertical-align: middle; }
    input, button { box-sizing: border-box; }
    button { cursor: pointer; padding: 2px 6px; font-size: 14px; }
    .idcol { display: none; }
    #responseMessage { margin-top: 12px; font-weight: bold; }
    .addSimilar, .addSimilarPage { margin-left: 6px; background: #e0f7fa; border: 1px solid #00acc1; border-radius: 4px; }
  </style>
</head>
<body>
  <h2>Th√™m / Ch·ªânh s·ª≠a nhi·ªÅu d√≤ng</h2>
  <button id="addRow" type="button">‚ûï Th√™m d√≤ng tr·ªëng</button>

  <!-- Datalist cho g·ª£i √Ω -->
  <datalist id="caList">
    <option value="H·∫øt ca"><option value="Gi·ªØa ca"><option value="Ca Chi·ªÅu">
  </datalist>
  <datalist id="productList">
    <option value="Kem body"><option value="CF FG"><option value="CB BAKU"><option value="Bakuchiol">
    <option value="C√† ph√™"><option value="N√°m"><option value="K·∫πo D√¢u"><option value="Serum S√¢m">
    <option value="K·∫πo D√¢u New"><option value="Body TBN"><option value="Baku TBN"><option value="DG">
    <option value="K·∫πo T√°o">
  </datalist>
  <datalist id="marketList">
    <option value="Nh·∫≠t"><option value="H√†n"><option value="Canada"><option value="US">
    <option value="√öc"><option value="Anh">
  </datalist>

  <form id="dataForm">
    <table id="dataTable">
      <thead>
        <tr>
          <th>H√†nh ƒë·ªông</th>
          <th class="idcol">id</th>
          <th>T√™n</th>
          <th>Ng√†y</th>
          <th>Ca</th>
          <th>S·∫£n ph·∫©m</th>
          <th>Th·ªã tr∆∞·ªùng</th>
          <th>Page</th>
          <th>TKQC</th>
          <th>CPQC</th>
          <th>Via log</th>
          <th>S·ªë Mess+Cmt</th>
          <th>S·ªë ƒë∆°n</th>
          <th>DS Ch·ªët</th>
          <th>S·ªë ƒë∆°n Ho√†n/H·ªßy</th>
          <th>DS sau Ho√†n/H·ªßy</th>
          <th>S·ªë ƒë∆°n sau ho√†n hu·ª∑</th>
          <th>Team</th>
          <th>id NS</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button type="submit" id="submitBtn">üöÄ G·ª≠i t·∫•t c·∫£</button>
  </form>

  <p id="responseMessage"></p>

  <script>
    const addRowBtn = document.getElementById('addRow');
    const tbody     = document.querySelector('#dataTable tbody');
    const form      = document.getElementById('dataForm');
    const respMsg   = document.getElementById('responseMessage');
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxIjM0XaM1FvQoquodYmuoCnWO-RBTko6z1PnE3rHEOcfr2Xih48jkzCa1pWus8QuntTQ/exec';

    function createRow(data = {}) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><button type="button" class="removeRow">‚ùå</button></td>
        <td class="idcol"><input name="id" value="${data.id||''}" readonly></td>
        <td><input name="T√™n" value="${data.T√™n||''}"></td>
        <td><input name="Ng√†y" type="date" value="${data.Ng√†y||''}"></td>
        <td><input name="ca" list="caList" value="${data.ca||''}"></td>
        <td><input name="S·∫£n_ph·∫©m" list="productList" value="${data.S·∫£n_ph·∫©m||''}"></td>
        <td>
          <div style="display:flex; align-items:center;">
            <input name="Th·ªã_tr∆∞·ªùng" list="marketList" value="${data.Th·ªã_tr∆∞·ªùng||''}">
            <button type="button" class="addSimilar">‚ûï</button>
          </div>
        </td>
        <td>
          <div style="display:flex; align-items:center;">
            <input name="page" value="${data.page||''}">
            <button type="button" class="addSimilarPage">‚ûï</button>
          </div>
        </td>
        <td><input name="TKQC" value="${data.TKQC||''}"></td>
        <td><input name="CPQC" value="${data.CPQC||''}"></td>
        <td><input name="Via_log" value="${data.Via_log||''}"></td>
        <td><input name="S·ªë_Mess_Cmt" value="${data.S·ªë_Mess_Cmt||''}"></td>
        <td><input name="S·ªë_ƒë∆°n" value="${data.S·ªë_ƒë∆°n||''}" ${data['S·ªë_ƒë∆°n']?'readonly':''}></td>
        <td><input name="DS_Ch·ªët" value="${data['DS_Ch·ªët']||''}" ${data['DS_Ch·ªët']?'readonly':''}></td>
        <td><input name="S·ªë_ƒë∆°n_Ho√†n_H·ªßy" value="${data['S·ªë_ƒë∆°n_Ho√†n_H·ªßy']||''}" ${data['S·ªë_ƒë∆°n_Ho√†n_H·ªßy']?'readonly':''}></td>
        <td><input name="DS_sau_Ho√†n_H·ªßy" value="${data['DS_sau_Ho√†n_H·ªßy']||''}" ${data['DS_sau_Ho√†n_H·ªßy']?'readonly':''}></td>
        <td><input name="S·ªë_ƒë∆°n_sau_ho√†n_h·ªßy" value="${data['S·ªë_ƒë∆°n_sau_ho√†n_h·ªßy']||''}" ${data['S·ªë_ƒë∆°n_sau_ho√†n_h·ªßy']?'readonly':''}></td>
        <td><input name="Team" value="${data.Team||''}" ${data.Team?'readonly':''}></td>
        <td><input name="id_NS" value="${data.id_NS||''}" ${data.id_NS?'readonly':''}></td>
      `;
      tr.querySelector('.removeRow').addEventListener('click', () => tr.remove());
      tr.querySelector('.addSimilar').addEventListener('click', () => {
        const newData = { id: 'id_'+Date.now(), S·∫£n_ph·∫©m: tr.querySelector('[name="S·∫£n_ph·∫©m"]').value, Th·ªã_tr∆∞·ªùng: tr.querySelector('[name="Th·ªã_tr∆∞·ªùng"]').value };
        createRow(newData);
      });
      tr.querySelector('.addSimilarPage').addEventListener('click', () => {
        const newData = {};
        tr.querySelectorAll('input').forEach(inp => newData[inp.name] = inp.value);
        newData.id = 'id_'+Date.now();
        createRow(newData);
      });
      tbody.appendChild(tr);
    }

    // Prefill t·ª´ URL
    (() => {
      const params = new URLSearchParams(window.location.search);
      const rowsParam = params.get('rows');
      if (rowsParam) {
        try {
          const arr = JSON.parse(decodeURIComponent(rowsParam));
          if (Array.isArray(arr)) arr.forEach(r => createRow(r));
        } catch (e) { console.warn('Kh√¥ng parse ƒë∆∞·ª£c rows param:', e); }
      }
      // N·∫øu ch∆∞a c√≥ d√≤ng n√†o, th√™m 1 d√≤ng m·∫∑c ƒë·ªãnh
      if (!tbody.children.length) {
        createRow({ id: 'id_'+Date.now() });
      }
    })();

    addRowBtn.addEventListener('click', () => createRow({ id: 'id_'+Date.now() }));

    form.addEventListener('submit', e => {
      e.preventDefault();
      const allRows = Array.from(tbody.querySelectorAll('tr')).map(tr => {
        const obj = {}; tr.querySelectorAll('input').forEach(inp => obj[inp.name] = inp.value); return obj;
      });
      if (!allRows.length) { respMsg.style.color = 'red'; return respMsg.innerText = 'Ch∆∞a c√≥ d√≤ng n√†o ƒë·ªÉ g·ª≠i!'; }
      fetch(SCRIPT_URL, { method: 'POST', body: new URLSearchParams({ rows: JSON.stringify(allRows) }) })
        .then(r => r.json())
        .then(json => { respMsg.style.color = json.error?'red':'green'; respMsg.innerText = json.error?'L·ªói: '+json.error:json.message; if(!json.error) tbody.innerHTML=''; })
        .catch(err => { respMsg.style.color = 'red'; respMsg.innerText = 'L·ªói g·ª≠i: '+err; });
    });
  </script>
</body>
</html>









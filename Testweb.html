<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>B√°o C√°o MKT LumiGlobal</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-image: url('https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Ff930e667.%E1%BA%A2nh.025539.jpg');
      background-size: cover;
      background-attachment: fixed;
      background-position: center;
      color: #333;
    }
    
    .container {
      width: 100%; 
      min-height: 100vh;
      margin: 0;
      background-color: rgba(255, 255, 255, 0.95);
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
      padding: 20px;
      box-sizing: border-box;
    }
    
    .header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #0056b3;
    }
    
    .logo {
      height: 60px;
      margin-right: 20px;
    }
    
    h1 {
      color: #0056b3;
      margin: 0;
      font-weight: 600;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background-color: white;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      table-layout: fixed;
    }
    
    th, td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: left;
      word-wrap: break-word;
    }
    
    th {
      background-color: #0056b3;
      color: white;
      font-weight: 500;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    
    /* Widths are for VISIBLE columns */
    th:nth-child(1), td:nth-child(1) { width: 5%; }  /* H√†nh ƒë·ªông */
    th:nth-child(2), td:nth-child(2) { width: 11%; } /* T√™n */
    th:nth-child(3), td:nth-child(3) { width: 9%; }  /* Ng√†y */
    th:nth-child(4), td:nth-child(4) { width: 8%; }  /* Ca */
    th:nth-child(5), td:nth-child(5) { width: 10%; } /* S·∫£n ph·∫©m */
    th:nth-child(6), td:nth-child(6) { width: 9%; }  /* Th·ªã tr∆∞·ªùng */
    th:nth-child(7), td:nth-child(7) { width: 15%; } /* Page */
    th:nth-child(8), td:nth-child(8) { width: 11%; } /* TKQC */
    th:nth-child(9), td:nth-child(9) { width: 7%; }  /* CPQC */
    th:nth-child(10), td:nth-child(10) { width: 8%; } /* Via log */
    th:nth-child(11), td:nth-child(11) { width: 7%; } /* S·ªë Mess+Cmt */
    
    tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    
    tr:hover {
      background-color: #f1f1f1;
    }
    
    input, textarea, button, select {
      box-sizing: border-box;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: 100%;
      font-family: inherit;
      font-size: 14px;
    }
    
    input[readonly] {
      background-color: #f5f5f5;
    }
    
    button {
      background-color: #0056b3;
      color: white;
      border: none;
      padding: 8px 15px;
      cursor: pointer;
      border-radius: 4px;
      font-weight: 500;
      transition: background-color 0.3s;
      white-space: nowrap;
    }
    
    button:hover {
      background-color: #003d82;
    }
    
    .action-buttons {
      display: flex;
      gap: 5px;
    }
    
    .action-buttons button {
      padding: 5px 10px;
      min-width: 30px;
    }
    
    .add-row-btn {
      background-color: #28a745;
      margin-bottom: 15px;
    }
    
    .add-row-btn:hover {
      background-color: #218838;
    }
    
    .submit-btn {
      background-color: #dc3545;
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 16px;
    }
    
    .submit-btn:hover {
      background-color: #c82333;
    }
    
    #responseMessage {
      margin-top: 15px;
      padding: 10px;
      border-radius: 4px;
      text-align: center;
    }
    
    .success {
      background-color: #d4edda;
      color: #155724;
    }
    
    .error {
      background-color: #f8d7da;
      color: #721c24;
    }
    
    .hidden {
      display: none;
    }
    
    .addSimilar {
      background-color: #17a2b8;
    }
    
    .addSimilar:hover {
      background-color: #138496;
    }
    
    .removeRow {
      background-color: #6c757d;
    }
    
    .removeRow:hover {
      background-color: #5a6268;
    }
    
    .editable {
      background-color: #fff !important;
    }
    
    select {
      appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 8px center;
      background-size: 15px;
      padding-right: 25px;
    }
    
    .page-container, .market-container {
      display: flex;
      align-items: center;
      gap: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <img src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Ff930e667.%E1%BA%A2nh.025539.jpg" alt="LumiGlobal Logo" class="logo">
      <h1>B√°o C√°o MKT LumiGlobal</h1>
    </div>

    <button id="addRow" type="button" class="add-row-btn">‚ûï Th√™m d√≤ng tr·ªëng</button>

    <form id="dataForm">
      <table id="dataTable">
        <thead>
          <tr>
            <th>H√†nh ƒë·ªông</th>
            <th>T√™n</th>
            <th>Ng√†y</th>
            <th>Ca</th>
            <th>S·∫£n ph·∫©m</th>
            <th>Th·ªã tr∆∞·ªùng</th>
            <th>Page</th>
            <th>TKQC</th>
            <th>CPQC</th>
            <th>Via log</th>
            <th>S·ªë Mess+Cmt</th>
            <th class="hidden">id</th>
            <th class="hidden">Team</th>
            <th class="hidden">id NS</th>
          </tr>
        </thead>
        <tbody>
          <!-- C√°c d√≤ng s·∫Ω ƒë∆∞·ª£c th√™m t·ª± ƒë·ªông v√†o ƒë√¢y -->
        </tbody>
      </table>
      <button type="submit" id="submitBtn" class="submit-btn">üöÄ G·ª≠i b√°o c√°o</button>
    </form>

    <p id="responseMessage"></p>
  </div>

  <script>
    const addRowBtn = document.getElementById('addRow');
    const tbody = document.querySelector('#dataTable tbody');
    const form = document.getElementById('dataForm');
    const respMsg = document.getElementById('responseMessage');
    
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby3GWaoNiRVsjgceLF7RKNE-J9tx_v4AyHnFp7PAo5di-ZlBHFcf31OrYUcIp0BAsOnFQ/exec';

    // Danh s√°ch data
    const productList = [ "Kem body", "CF FG", "CB BAKU", "Bakuchiol", "C√† ph√™", "N√°m", "K·∫πo D√¢u", "Serum S√¢m", "K·∫πo D√¢u New", "Body TBN", "Baku TBN", "DG", "K·∫πo T√°o" ];
    const marketList = ["Nh·∫≠t", "H√†n", "Canada", "US", "√öc", "Anh"];
    const shiftList = ["H·∫øt ca", "Gi·ªØa ca", "Ca Chi·ªÅu"];
    const employeeList = [ "Ph·∫°m Ti·∫øn Th√†nh", "L√™ ƒê√¨nh To·∫£n", "Tr·∫ßn Qu·ªëc Kh·∫£i", "M·∫°nh C∆∞·ªùng", "Nguy·ªÖn Th·ªã Hi·∫øu", "V≈© Vi·∫øt Anh", "L·ª•c Tr·∫ßn Minh Tr√≠", "ƒêo√†n Ng·ªçc Hu√¢n", "Nguy·ªÖn Hi·ªÅn L∆∞∆°ng", "Tr·∫ßn Huy H√πng", "Nguy·ªÖn Anh Tu·∫•n", "Tr·∫ßn Ti·∫øn", "Nguy·ªÖn Th·ªã Nh∆∞ Qu·ª≥nh", "Nguy·ªÖn Quang Tr∆∞·ªùng" ];
    
    // <<<<< DANH S√ÅCH TKQC ƒê√É ƒê∆Ø·ª¢C C·∫¨P NH·∫¨T <<<<<
    const tkqcData = {
      "Ph·∫°m Ti·∫øn Th√†nh": ["tcm 300", "tcm 393(1)", "tcm 431(1)", "tcm 449(1)", "lumi hn 05(1)", "lumi hn 14(1)", "lumi hn 21", "lumi hn 29", "lumi hn 52", "lumi hn 53", "lumi hn 54", "lumi hn 60", "lumi hn 68", "lumi hn 75", "lumi hn 82", "lumi hn 83"],
      "L√™ ƒê√¨nh To·∫£n": ["tcm 365(1)", "tcm 386(1)", "tcm 389-b(1)", "tcm 427-b", "lumi hn 07(1)", "lumi hn 26", "lumi hn 40"],
      "Tr·∫ßn Qu·ªëc Kh·∫£i": ["tcm 369-b(1)", "tcm 380(1)", "tcm 387(1)", "tcm 455", "lumi hn 02(1)", "lumi hn 12", "lumi hn 16(1)", "lumi hn 35", "lumi hn 47", "lumi hn 48"],
      "M·∫°nh C∆∞·ªùng": ["tcm 372-b", "tcm 376-b", "tcm 378(1)", "tcm 394(1)", "tcm 407(1)", "tcm 418(1)", "tcm 442(1)", "lumi hn 04", "lumi hn 06", "lumi hn 24", "lumi hn 28", "lumi hn 50", "lumi hn 63"],
      "Nguy·ªÖn Th·ªã Hi·∫øu": ["tcm 381(1)", "tcm 406(1)", "tcm 413-b", "tcm 440(1)", "tcm 443(1)", "lumi hn 10", "lumi hn 23(hold)", "lumi hn 25", "lumi hn 32", "lumi hn 33", "lumi hn 61", "lumi hn 70-7"],
      "V≈© Vi·∫øt Anh": ["tcm 390", "tcm 450(1)", "lumi hn 31", "lumi hn 37", "lumi hn 46", "lumi hn 74"],
      "L·ª•c Tr·∫ßn Minh Tr√≠": ["tcm 399-b", "tcm 456", "lumi hn 19", "lumi hn 27", "lumi  hn 34", "lumi hn 38", "lumi hn 44", "lumi hn 45", "lumi hn 49", "lumi hn 62", "lumi hn 64", "lumi hn 65 -7"],
      "ƒêo√†n Ng·ªçc Hu√¢n": ["tcm 400-b(1)", "lumi hn 03(1)", "lumi hn 15(1)", "lumi hn 42", "lumi hn 51", "lumi hn 71"],
      "Nguy·ªÖn Hi·ªÅn L∆∞∆°ng": ["tcm 410-b(1)", "tcm 430-b", "tcm 434-b(1)", "lumi hn 13(1)", "lumi hn 41", "lumi hn 57", "lumi hn 66", "lumi hn 79", "lumi hn 81", "lumi hn 84 mst"],
      "Tr·∫ßn Huy H√πng": ["tcm 429-b(1)", "tcm 438(1)", "lumi hn 01", "lumi hn 17(1)", "lumi hn 36", "lumi hn 58", "lumi hn 59", "lumi hn 67", "lumi hn 73", "lumi hn 85 mst"],
      "Nguy·ªÖn Anh Tu·∫•n": ["tcm  395", "lumi hn 11", "lumi hn 78"],
      "Tr·∫ßn Ti·∫øn": ["tcm 426-b", "lumi hn 76"],
      "Nguy·ªÖn Th·ªã Nh∆∞ Qu·ª≥nh": ["lumi hn 08 hold", "lumi hn 22", "lumi hn 30", "lumi hn 77"],
      "Nguy·ªÖn Quang Tr∆∞·ªùng": ["lumi hn 09", "lumi hn 55", "lumi hn 56", "lumi hn 72"]
    };

    function formatDate(date) {
      const d = new Date(date);
      let month = '' + (d.getMonth() + 1);
      let day = '' + d.getDate();
      const year = d.getFullYear();
      if (month.length < 2) month = '0' + month;
      if (day.length < 2) day = '0' + day;
      return [year, month, day].join('-');
    }

    function getToday() {
      return formatDate(new Date());
    }

    // T·∫°o m·ªôt d√≤ng m·ªõi
    function createRow(data = {}, insertAfter = null) {
      const tr = document.createElement('tr');
      const uniqueId = `id_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
      
      tr.innerHTML = `
        <td class="action-buttons">
          <button type="button" class="removeRow" title="X√≥a d√≤ng n√†y">‚ùå</button>
        </td>
        <td>
          <select name="T√™n" class="editable name-select">
            <option value="">-- Ch·ªçn t√™n --</option>
            ${employeeList.map(name => `<option value="${name}" ${data.T√™n === name ? 'selected' : ''}>${name}</option>`).join('')}
          </select>
        </td>
        <td><input name="Ng√†y" type="date" value="${data.Ng√†y || getToday()}" class="editable"></td>
        <td>
          <select name="ca" class="editable">
            ${shiftList.map(shift => `<option value="${shift}" ${data.ca === shift ? 'selected' : ''}>${shift}</option>`).join('')}
          </select>
        </td>
        <td>
          <input name="S·∫£n_ph·∫©m" list="productList" value="${data.S·∫£n_ph·∫©m || ''}" class="editable">
          <datalist id="productList">${productList.map(product => `<option value="${product}">`).join('')}</datalist>
        </td>
        <td>
          <div class="market-container">
            <input name="Th·ªã_tr∆∞·ªùng" list="marketList" value="${data.Th·ªã_tr∆∞·ªùng || ''}" class="editable">
            <datalist id="marketList">${marketList.map(market => `<option value="${market}">`).join('')}</datalist>
            <button type="button" class="addSimilar addSimilarMarket" title="Th√™m d√≤ng m·ªõi v·ªõi c√πng Th·ªã tr∆∞·ªùng">‚ûï</button>
          </div>
        </td>
        <td>
          <div class="page-container">
            <input name="page" value="${data.page || ''}" class="editable">
            <button type="button" class="addSimilar addSimilarPage" title="Th√™m d√≤ng m·ªõi v·ªõi c√πng Page & TKQC">‚ûï</button>
          </div>
        </td>
        <td>
          <select name="TKQC" class="editable tkqc-select">
            <option value="">-- Ch·ªçn TKQC --</option>
            ${data.T√™n && tkqcData[data.T√™n] ? tkqcData[data.T√™n].map(tkqc => `<option value="${tkqc}" ${data.TKQC === tkqc ? 'selected' : ''}>${tkqc}</option>`).join('') : ''}
          </select>
        </td>
        <td><input name="CPQC" value="${data.CPQC || ''}" class="editable" type="number" step="any"></td>
        <td><input name="Via_log" value="${data.Via_log || ''}" class="editable"></td>
        <td><input name="S·ªë_Mess_Cmt" value="${data.S·ªë_Mess_Cmt || ''}" class="editable" type="number" step="1"></td>
        <td class="hidden"><input name="id" value="${data.id || uniqueId}" readonly></td>
        <td class="hidden"><input name="Team" value="${data.Team || ''}" readonly></td>
        <td class="hidden"><input name="id_NS" value="${data.id_NS || ''}" readonly></td>
      `;

      tr.querySelector('.removeRow').addEventListener('click', () => tr.remove());
      
      const nameSelect = tr.querySelector('.name-select');
      const tkqcSelect = tr.querySelector('.tkqc-select');
      nameSelect.addEventListener('change', function() {
        const selectedName = this.value;
        tkqcSelect.innerHTML = '<option value="">-- Ch·ªçn TKQC --</option>';
        if (selectedName && tkqcData[selectedName]) {
          tkqcData[selectedName].forEach(tkqc => {
            const option = document.createElement('option');
            option.value = tkqc; option.textContent = tkqc;
            tkqcSelect.appendChild(option);
          });
        }
      });
      if (nameSelect.value) {
          nameSelect.dispatchEvent(new Event('change'));
          tkqcSelect.value = data.TKQC || '';
      }
      
      tr.querySelector('.addSimilarMarket').addEventListener('click', () => {
        const newRow = createRow({ T√™n: tr.querySelector('[name="T√™n"]').value, Ng√†y: tr.querySelector('[name="Ng√†y"]').value, ca: tr.querySelector('[name="ca"]').value, S·∫£n_ph·∫©m: tr.querySelector('[name="S·∫£n_ph·∫©m"]').value, Th·ªã_tr∆∞·ªùng: tr.querySelector('[name="Th·ªã_tr∆∞·ªùng"]').value, }, tr);
        newRow.querySelector('[name="page"]').focus();
      });
      
      tr.querySelector('.addSimilarPage').addEventListener('click', () => {
        const newRow = createRow({ T√™n: tr.querySelector('[name="T√™n"]').value, Ng√†y: tr.querySelector('[name="Ng√†y"]').value, ca: tr.querySelector('[name="ca"]').value, S·∫£n_ph·∫©m: tr.querySelector('[name="S·∫£n_ph·∫©m"]').value, Th·ªã_tr∆∞·ªùng: tr.querySelector('[name="Th·ªã_tr∆∞·ªùng"]').value, page: tr.querySelector('[name="page"]').value, TKQC: tr.querySelector('[name="TKQC"]').value, }, tr);
        newRow.querySelector('[name="CPQC"]').focus();
      });

      if (insertAfter) {
        tbody.insertBefore(tr, insertAfter.nextSibling);
      } else {
        tbody.appendChild(tr);
      }
      return tr;
    }

    addRowBtn.addEventListener('click', () => {
      const newRow = createRow();
      newRow.querySelector('[name="T√™n"]').focus();
    });

    form.addEventListener('submit', e => {
      e.preventDefault();
      
      const submitButton = document.getElementById('submitBtn');
      submitButton.disabled = true; submitButton.textContent = 'ƒêang g·ª≠i...';
      respMsg.className = ''; respMsg.textContent = '';

      const allRows = Array.from(tbody.querySelectorAll('tr')).map(tr => {
        const obj = {};
        tr.querySelectorAll('input, textarea, select').forEach(inp => { obj[inp.name] = inp.value; });
        if (!obj['T√™n'] || !obj['S·∫£n_ph·∫©m'] || !obj['Th·ªã_tr∆∞·ªùng'] || !obj['page']) {
           obj._invalid = true;
        }
        return obj;
      });
      
      const validRows = allRows.filter(row => !row._invalid);
      const invalidRowCount = allRows.length - validRows.length;

      if (invalidRowCount > 0) {
          respMsg.className = 'error';
          respMsg.innerText = `L·ªói: C√≥ ${invalidRowCount} d√≤ng thi·∫øu th√¥ng tin (T√™n, S·∫£n ph·∫©m, Th·ªã tr∆∞·ªùng, Page). Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß.`;
          submitButton.disabled = false; submitButton.textContent = 'üöÄ G·ª≠i b√°o c√°o';
          return;
      }

      if (!validRows.length) {
        respMsg.className = 'error'; respMsg.innerText = 'Ch∆∞a c√≥ d√≤ng n√†o h·ª£p l·ªá ƒë·ªÉ g·ª≠i!';
        submitButton.disabled = false; submitButton.textContent = 'üöÄ G·ª≠i b√°o c√°o';
        return;
      }
      
      const payload = new URLSearchParams({ rows: JSON.stringify(validRows) });
      fetch(SCRIPT_URL, { method: 'POST', body: payload })
      .then(r => r.json())
      .then(json => {
        if (json.error) {
            respMsg.className = 'error'; respMsg.innerText = 'L·ªói t·ª´ server: ' + json.error;
        } else {
            respMsg.className = 'success'; respMsg.innerText = json.message;
            tbody.innerHTML = '';
            createRow();
        }
      })
      .catch(err => {
        respMsg.className = 'error'; respMsg.innerText = 'L·ªói k·∫øt n·ªëi: ' + err;
      })
      .finally(() => {
        submitButton.disabled = false; submitButton.textContent = 'üöÄ G·ª≠i b√°o c√°o';
      });
    });

    function initializeRowsFromUrl() {
        tbody.innerHTML = ''; 
        const urlParams = new URLSearchParams(window.location.search);
        const dataParam = urlParams.get('data');
        let rowsCreated = 0;
        if (dataParam) {
            const rowsData = dataParam.split('_a_');
            rowsData.forEach(rowString => {
                if (rowString.trim() === '') return;
                const fields = rowString.split('_b_');
                const rowDataObject = {
                    id:          fields[0] ? decodeURIComponent(fields[0]) : '',
                    T√™n:         fields[1] ? decodeURIComponent(fields[1]) : '',
                    S·∫£n_ph·∫©m:   fields[2] ? decodeURIComponent(fields[2]) : '',
                    Th·ªã_tr∆∞·ªùng:  fields[3] ? decodeURIComponent(fields[3]) : '',
                    page:        fields[4] ? decodeURIComponent(fields[4]) : '',
                    TKQC:        fields[5] ? decodeURIComponent(fields[5]) : '',
                };
                createRow(rowDataObject);
                rowsCreated++;
            });
        }
        if (rowsCreated === 0) {
            createRow();
        }
    }

    initializeRowsFromUrl();
    
  </script>
</body>
</html>
















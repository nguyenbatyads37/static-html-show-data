<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>B√°o C√°o MKT LumiGlobal</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0;
      background-image: linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)), url('https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Ff930e667.%E1%BA%A2nh.025539.jpg');
      background-size: cover; background-attachment: fixed; background-position: center; color: #333;
    }
    .container {
      width: 100%; min-height: 100vh; margin: 0;
      background-color: rgba(255, 255, 255, 0.97);
      box-shadow: 0 0 25px rgba(0, 0, 0, 0.3);
      padding: 20px; box-sizing: border-box;
    }
    .header {
      display: flex; align-items: center; margin-bottom: 20px;
      padding-bottom: 15px; border-bottom: 2px solid #0056b3;
    }
    .logo { height: 60px; margin-right: 20px; }
    h1 { color: #0056b3; margin: 0; font-weight: 600; }
    table {
      width: 100%; border-collapse: collapse; margin-top: 20px;
      background-color: white; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      table-layout: fixed;
    }
    th, td {
      border: 1px solid #ddd; padding: 8px;
      text-align: left; word-wrap: break-word; vertical-align: middle;
    }
    th {
      background-color: #0056b3; color: white; font-weight: 500;
      position: sticky; top: 0; z-index: 1; padding: 12px 8px;
    }
    th:nth-child(1), td:nth-child(1) { width: 5%; } th:nth-child(2), td:nth-child(2) { width: 11%; }
    th:nth-child(3), td:nth-child(3) { width: 9%; } th:nth-child(4), td:nth-child(4) { width: 8%; }
    th:nth-child(5), td:nth-child(5) { width: 10%; } th:nth-child(6), td:nth-child(6) { width: 11%; }
    th:nth-child(7), td:nth-child(7) { width: 16%; } th:nth-child(8), td:nth-child(8) { width: 11%; }
    th:nth-child(9), td:nth-child(9) { width: 7%; } th:nth-child(10), td:nth-child(10){ width: 8%; }
    th:nth-child(11), td:nth-child(11){ width: 7%; }
    tr:nth-child(even) { background-color: #f9f9f9; }
    tr:hover { background-color: #f1f1f1; }
    input, textarea, button, select {
      box-sizing: border-box; padding: 8px; border: 1px solid #ddd;
      border-radius: 4px; width: 100%; font-family: inherit; font-size: 14px;
    }
    input[readonly] { background-color: #f5f5f5; }
    .hidden { display: none; }
    .form-actions { margin-top: 20px; display: flex; gap: 10px; }
    .submit-btn, .add-row-btn {
      padding: 10px 20px; font-size: 16px; border: none;
      color: white; border-radius: 5px; cursor: pointer;
      transition: background-color 0.3s;
    }
    .submit-btn { background-color: #007bff; }
    .submit-btn:hover { background-color: #0056b3; }
    .add-row-btn { background-color: #28a745; margin-bottom: 15px; }
    .add-row-btn:hover { background-color: #218838; }
    #responseMessage { margin-top: 15px; font-weight: bold; }
    #responseMessage.success { color: green; }
    #responseMessage.error { color: red; }
    .action-buttons { text-align: center; }
    .action-buttons .removeRow { background-color: #dc3545; padding: 8px; width: 100%; }
    .action-buttons .removeRow:hover { background-color: #c82333; }
    .input-with-button { display: flex; align-items: center; gap: 5px; }
    .input-with-button > input, .input-with-button > select { flex-grow: 1; }
    .input-with-button > button {
      flex-shrink: 0; width: 38px; padding: 8px 0; background-color: #17a2b8;
    }
    .input-with-button > button:hover { background-color: #138496; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <img src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Ff930e667.%E1%BA%A2nh.025539.jpg" alt="LumiGlobal Logo" class="logo">
      <h1>B√°o C√°o MKT LumiGlobal</h1>
    </div>

    <button id="addRow" type="button" class="add-row-btn">‚ûï Th√™m d√≤ng tr·ªëng</button>

    <form id="dataForm">
      <table id="dataTable">
        <thead>
          <tr>
            <th>H√†nh ƒë·ªông</th><th>T√™n</th><th>Ng√†y</th><th>Ca</th><th>S·∫£n ph·∫©m</th><th>Th·ªã tr∆∞·ªùng</th><th>Page</th>
            <th>TKQC</th><th>CPQC</th><th>Via log</th><th>S·ªë Mess+Cmt</th>
            <th class="hidden">id</th><th class="hidden">Team</th><th class="hidden">id NS</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="form-actions">
          <button type="submit" id="submitBtn" class="submit-btn">üöÄ G·ª≠i b√°o c√°o</button>
      </div>
    </form>
    <p id="responseMessage"></p>
  </div>

  <script>
    const addRowBtn = document.getElementById('addRow');
    const tbody = document.querySelector('#dataTable tbody');
    const form = document.getElementById('dataForm');
    const respMsg = document.getElementById('responseMessage');
    
    // !!! ƒê√É C·∫¨P NH·∫¨T URL SCRIPT C·ª¶A B·∫†N V√ÄO ƒê√ÇY !!!
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbymq2r3DcJt2Faj-ZswVkQTeyLy3zcknkicmINUNYXPL0IkWlO1Sb1LRKyGFzpfUqov/exec';

    const productList = [ "Kem body", "CF FG", "CB BAKU", "Bakuchiol", "C√† ph√™", "N√°m", "K·∫πo D√¢u", "Serum S√¢m", "K·∫πo D√¢u New", "Body TBN", "Baku TBN", "DG", "K·∫πo T√°o" ];
    const marketList = ["Nh·∫≠t", "H√†n", "Canada", "US", "√öc", "Anh"];
    const shiftList = ["H·∫øt ca", "Gi·ªØa ca", "Ca Chi·ªÅu"];

    const tenpage = {
        "Ph·∫°m Ti·∫øn Th√†nh": { pages: [], tkqc: ["tcm 300", "tcm 393(1)", "tcm 431(1)", "tcm 449(1)", "lumi hn 05(1)", "lumi hn 14(1)", "lumi hn 21", "lumi hn 29", "lumi hn 52", "lumi hn 53", "lumi hn 54", "lumi hn 60", "lumi hn 68", "lumi hn 75", "lumi hn 82", "lumi hn 83"] },
        "L√™ ƒê√¨nh To·∫£n": { pages: [], tkqc: ["tcm 365(1)", "tcm 386(1)", "tcm 389-b(1)", "tcm 427-b", "lumi hn 07(1)", "lumi hn 26", "lumi hn 40"] },
        "Tr·∫ßn Qu·ªëc Kh·∫£i": { pages: [], tkqc: ["tcm 369-b(1)", "tcm 380(1)", "tcm 387(1)", "tcm 455", "lumi hn 02(1)", "lumi hn 12", "lumi hn 16(1)", "lumi hn 35", "lumi hn 47", "lumi hn 48"] },
        "M·∫°nh C∆∞·ªùng": { pages: [], tkqc: ["tcm 372-b", "tcm 376-b", "tcm 378(1)", "tcm 394(1)", "tcm 407(1)", "tcm 418(1)", "tcm 442(1)", "lumi hn 04", "lumi hn 06", "lumi hn 24", "lumi hn 28", "lumi hn 50", "lumi hn 63", "c∆∞·ªùng test 01"] },
        "Nguy·ªÖn Th·ªã Hi·∫øu": { pages: [], tkqc: ["tcm 381(1)", "tcm 406(1)", "tcm 413-b", "tcm 440(1)", "tcm 443(1)", "lumi hn 10", "lumi hn 23(hold)", "lumi hn 25", "lumi hn 32", "lumi hn 33", "lumi hn 61", "lumi hn 70-7"] },
        "V≈© Vi·∫øt Anh": { pages: [], tkqc: ["tcm 390", "tcm 450(1)", "lumi hn 31", "lumi hn 37", "lumi hn 46", "lumi hn 74"] },
        "L·ª•c Tr·∫ßn Minh Tr√≠": { pages: [], tkqc: ["tcm 399-b", "tcm 456", "lumi hn 19", "lumi hn 27", "lumi  hn 34", "lumi hn 38", "lumi hn 44", "lumi hn 45", "lumi hn 49", "lumi hn 62", "lumi hn 64", "lumi hn 65 -7"] },
        "ƒêo√†n Ng·ªçc Hu√¢n": { pages: [], tkqc: ["tcm 400-b(1)", "lumi hn 03(1)", "lumi hn 15(1)", "lumi hn 42", "lumi hn 51", "lumi hn 71"] },
        "Nguy·ªÖn Hi·ªÅn L∆∞∆°ng": { pages: [], tkqc: ["tcm 410-b(1)", "tcm 430-b", "tcm 434-b(1)", "lumi hn 13(1)", "lumi hn 41", "lumi hn 57", "lumi hn 66", "lumi hn 79", "lumi hn 81", "lumi hn 84 mst", "l∆∞∆°ng test 01"] },
        "Tr·∫ßn Huy H√πng": { pages: [], tkqc: ["tcm 429-b(1)", "tcm 438(1)", "lumi hn 01", "lumi hn 17(1)", "lumi hn 36", "lumi hn 58", "lumi hn 59", "lumi hn 67", "lumi hn 73", "lumi hn 85 mst"] },
        "Nguy·ªÖn Anh Tu·∫•n": { pages: [], tkqc: ["tcm  395", "lumi hn 11", "lumi hn 78"] },
        "Tr·∫ßn Ti·∫øn": { pages: [], tkqc: ["tcm 426-b", "lumi hn 76"] },
        "Nguy·ªÖn Th·ªã Nh∆∞ Qu·ª≥nh": { pages: [], tkqc: ["lumi hn 08 hold", "lumi hn 22", "lumi hn 30", "lumi hn 77"] },
        "Nguy·ªÖn Quang Tr∆∞·ªùng": { pages: [], tkqc: ["lumi hn 09", "lumi hn 55", "lumi hn 56", "lumi hn 72"] }
    };
    
    const pageDataRaw = `
FitGum 20X Collagen Chia Coffee - JAPAN - 100% FDA 01	Tr·∫ßn Qu·ªëc Kh·∫£i
50X CA Store Legit - Body Lotion Venature Glutathione	Tr·∫ßn Huy H√πng
50X JAPAN Store Legit - Body Lotion Venature Glutathione	Tr·∫ßn Huy H√πng
50X US Store Legit - Body Lotion Venature Glutathione 	Tr·∫ßn Huy H√πng
Anna Store - Venature Bakuchiol Retinol In Japan 	Nguy·ªÖn Th·ªã Hi·∫øu
    `;
    
    pageDataRaw.trim().split('\n').forEach(line => {
        const parts = line.split('\t');
        if (parts.length === 2) {
            let pageName = parts[0].trim().replace(/^"|"$/g, '').trim();
            let mktName = parts[1].trim();
            if (pageName && mktName && tenpage[mktName]) {
                tenpage[mktName].pages.push(pageName);
            }
        }
    });

    const employeeList = Object.keys(tenpage);

    const numberFormatter = new Intl.NumberFormat('vi-VN');
    function formatNumber(value) { if (!value) return ''; const cleanValue = String(value).replace(/\D/g, ''); if (cleanValue === '') return ''; return numberFormatter.format(cleanValue); }
    function getToday() { return new Date().toISOString().split('T')[0]; }

    function createRow(data = {}, insertAfter = null) {
      const tr = document.createElement('tr');
      const uniqueId = `id_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
      
      tr.innerHTML = `
        <td class="action-buttons"><button type="button" class="removeRow" title="X√≥a d√≤ng n√†y">‚ùå</button></td>
        <td><select name="T√™n" class="editable name-select"><option value="">-- Ch·ªçn t√™n --</option>${employeeList.map(name => `<option value="${name}" ${data.T√™n === name ? 'selected' : ''}>${name}</option>`).join('')}</select></td>
        <td><input name="Ng√†y" type="date" value="${data.Ng√†y || getToday()}" class="editable"></td>
        <td><select name="ca" class="editable">${shiftList.map(shift => `<option value="${shift}" ${data.ca === shift ? 'selected' : ''}>${shift}</option>`).join('')}</select></td>
        <td><input name="S·∫£n_ph·∫©m" list="productList" value="${data.S·∫£n_ph·∫©m || ''}" class="editable" placeholder="Ch·ªçn ho·∫∑c nh·∫≠p..."><datalist id="productList">${productList.map(product => `<option value="${product}">`).join('')}</datalist></td>
        <td>
            <div class="input-with-button">
                <input name="Th·ªã_tr∆∞·ªùng" list="marketList" value="${data.Th·ªã_tr∆∞·ªùng || ''}" class="editable" placeholder="Ch·ªçn ho·∫∑c nh·∫≠p...">
                <button type="button" class="addSimilarMarket" title="Th√™m d√≤ng v·ªõi c√πng Th·ªã tr∆∞·ªùng">‚ûï</button>
            </div>
            <datalist id="marketList">${marketList.map(market => `<option value="${market}">`).join('')}</datalist>
        </td>
        <td>
            <div class="input-with-button">
                <select name="page" class="editable page-select"><option value="">-- Ch·ªçn Page --</option></select>
                <button type="button" class="addSimilarPage" title="Th√™m d√≤ng v·ªõi c√πng Page">‚ûï</button>
            </div>
        </td>
        <td><input name="TKQC" class="editable tkqc-input" list="tkqc-datalist-${uniqueId}" value="${data.TKQC || ''}" placeholder="Ch·ªçn ho·∫∑c nh·∫≠p m·ªõi..."><datalist id="tkqc-datalist-${uniqueId}"></datalist></td>
        <td><input type="text" inputmode="numeric" class="editable cpqc-display" placeholder="Nh·∫≠p chi ph√≠"><input type="hidden" name="CPQC" class="cpqc-hidden" value="${data.CPQC || ''}"></td>
        <td><input name="Via_log" value="${data.Via_log || ''}" class="editable"></td>
        <td><input name="S·ªë_Mess_Cmt" value="${data.S·ªë_Mess_Cmt || ''}" class="editable" type="number" step="1"></td>
        <td class="hidden"><input name="id" value="${data.id || uniqueId}" readonly></td>
        <td class="hidden"><input name="Team" value="" readonly></td>
        <td class="hidden"><input name="id_NS" value="" readonly></td>
      `;
      
      const cpqcDisplay = tr.querySelector('.cpqc-display');
      const cpqcHidden = tr.querySelector('.cpqc-hidden');
      cpqcDisplay.value = formatNumber(cpqcHidden.value);
      cpqcDisplay.addEventListener('input', () => {
        const rawValue = cpqcDisplay.value.replace(/\D/g, ''); 
        cpqcHidden.value = rawValue;
        const currentCursor = cpqcDisplay.selectionStart; 
        const originalLength = cpqcDisplay.value.length;
        cpqcDisplay.value = formatNumber(rawValue); 
        const newLength = cpqcDisplay.value.length;
        cpqcDisplay.setSelectionRange(currentCursor + (newLength - originalLength), currentCursor + (newLength - originalLength));
      });

      tr.querySelector('.removeRow').addEventListener('click', () => tr.remove());
      
      tr.querySelector('.addSimilarMarket').addEventListener('click', () => {
        const newRow = createRow({
          id: 'id_' + Date.now(),
          T√™n: tr.querySelector('[name="T√™n"]').value,
          Ng√†y: tr.querySelector('[name="Ng√†y"]').value,
          ca: tr.querySelector('[name="ca"]').value,
          S·∫£n_ph·∫©m: tr.querySelector('[name="S·∫£n_ph·∫©m"]').value,
          Th·ªã_tr∆∞·ªùng: tr.querySelector('[name="Th·ªã_tr∆∞·ªùng"]').value,
        }, tr);
        newRow.querySelector('[name="page"]').focus();
      });

      tr.querySelector('.addSimilarPage').addEventListener('click', () => {
        const newRow = createRow({
          id: 'id_' + Date.now(),
          T√™n: tr.querySelector('[name="T√™n"]').value,
          Ng√†y: tr.querySelector('[name="Ng√†y"]').value,
          ca: tr.querySelector('[name="ca"]').value,
          S·∫£n_ph·∫©m: tr.querySelector('[name="S·∫£n_ph·∫©m"]').value,
          Th·ªã_tr∆∞·ªùng: tr.querySelector('[name="Th·ªã_tr∆∞·ªùng"]').value,
          page: tr.querySelector('[name="page"]').value,
          TKQC: tr.querySelector('[name="TKQC"]').value,
          CPQC: tr.querySelector('.cpqc-hidden').value,
          Via_log: tr.querySelector('[name="Via_log"]').value,
          S·ªë_Mess_Cmt: ''
        }, tr);
        newRow.querySelector('[name="S·ªë_Mess_Cmt"]').focus();
      });

      const nameSelect = tr.querySelector('.name-select');
      const pageSelect = tr.querySelector('.page-select');
      const tkqcDatalist = tr.querySelector(`#tkqc-datalist-${uniqueId}`);
      
      nameSelect.addEventListener('change', function() {
        const selectedName = this.value;
        const mktData = tenpage[selectedName];
        pageSelect.innerHTML = '<option value="">-- Ch·ªçn Page --</option>';
        tkqcDatalist.innerHTML = '';
        if (mktData) { 
          if (mktData.pages && mktData.pages.length > 0) {
            mktData.pages.sort().forEach(page => {
              const option = document.createElement('option'); option.value = page; option.textContent = page; pageSelect.appendChild(option);
            });
          }
          if (mktData.tkqc) {
            mktData.tkqc.sort().forEach(tkqc => {
              const option = document.createElement('option'); option.value = tkqc; tkqcDatalist.appendChild(option);
            });
          }
        }
      });
      
      if (data.T√™n) { nameSelect.dispatchEvent(new Event('change')); pageSelect.value = data.page || ''; }
      if (insertAfter) { tbody.insertBefore(tr, insertAfter.nextSibling); } else { tbody.appendChild(tr); }
      return tr;
    }

    addRowBtn.addEventListener('click', () => { createRow().querySelector('[name="T√™n"]').focus(); });
    
    // ƒê√É KH√îI PH·ª§C L·∫†I LOGIC G·ª¨I D·ªÆ LI·ªÜU
    form.addEventListener('submit', e => { 
      e.preventDefault(); 
      submitBtn.disabled = true;
      submitBtn.textContent = 'ƒêang g·ª≠i...';
      respMsg.textContent = '';
      respMsg.className = '';

      const allRows = Array.from(tbody.querySelectorAll('tr')).map(tr => {
        const rowObject = {};
        tr.querySelectorAll('input[name], select[name]').forEach(input => { rowObject[input.name] = input.value; });
        return rowObject;
      });

      if (allRows.length === 0) {
          respMsg.textContent = 'Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ g·ª≠i.'; respMsg.className = 'error';
          submitBtn.disabled = false; submitBtn.textContent = 'üöÄ G·ª≠i b√°o c√°o';
          return;
      }
      
      const payload = new URLSearchParams({ rows: JSON.stringify(allRows) });

      fetch(SCRIPT_URL, { method: 'POST', body: payload })
        .then(res => res.json())
        .then(response => {
          if (response.success) {
              respMsg.textContent = response.message || 'G·ª≠i b√°o c√°o th√†nh c√¥ng!'; respMsg.className = 'success';
              tbody.innerHTML = ''; 
              createRow(); 
          } else {
              throw new Error(response.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh t·ª´ m√°y ch·ªß.');
          }
        })
        .catch(err => {
          respMsg.textContent = 'ƒê√£ x·∫£y ra l·ªói khi g·ª≠i: ' + err.message; respMsg.className = 'error';
        })
        .finally(() => {
          submitBtn.disabled = false; submitBtn.textContent = 'üöÄ G·ª≠i b√°o c√°o';
        });
    });

    createRow(); 
  </script>
</body>
</html>
















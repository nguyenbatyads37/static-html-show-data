<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>B√°o C√°o MKT LumiGlobal</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-image: url('https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Ff930e667.%E1%BA%A2nh.025539.jpg');
      background-size: cover;
      background-attachment: fixed;
      background-position: center;
      color: #333;
    }
    
    .container {
      width: 100%; 
      min-height: 100vh;
      margin: 0;
      background-color: rgba(255, 255, 255, 0.95);
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
      padding: 20px;
      box-sizing: border-box;
    }
    
    .header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #0056b3;
    }
    
    .logo {
      height: 60px;
      margin-right: 20px;
    }
    
    h1 {
      color: #0056b3;
      margin: 0;
      font-weight: 600;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background-color: white;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      table-layout: fixed;
    }
    
    th, td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: left;
      word-wrap: break-word;
    }
    
    th {
      background-color: #0056b3;
      color: white;
      font-weight: 500;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    
    th:nth-child(1), td:nth-child(1) { width: 5%; }  /* H√†nh ƒë·ªông */
    th:nth-child(2), td:nth-child(2) { width: 11%; } /* T√™n */
    th:nth-child(3), td:nth-child(3) { width: 9%; }  /* Ng√†y */
    th:nth-child(4), td:nth-child(4) { width: 8%; }  /* Ca */
    th:nth-child(5), td:nth-child(5) { width: 10%; } /* S·∫£n ph·∫©m */
    th:nth-child(6), td:nth-child(6) { width: 9%; }  /* Th·ªã tr∆∞·ªùng */
    th:nth-child(7), td:nth-child(7) { width: 15%; } /* Page */
    th:nth-child(8), td:nth-child(8) { width: 11%; } /* TKQC */
    th:nth-child(9), td:nth-child(9) { width: 7%; }  /* CPQC */
    th:nth-child(10), td:nth-child(10) { width: 8%; } /* Via log */
    th:nth-child(11), td:nth-child(11) { width: 7%; } /* S·ªë Mess+Cmt */
    
    tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    
    tr:hover {
      background-color: #f1f1f1;
    }
    
    input, textarea, button, select {
      box-sizing: border-box;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: 100%;
      font-family: inherit;
      font-size: 14px;
    }
    
    input[readonly] {
      background-color: #f5f5f5;
    }
    
    .hidden {
      display: none;
    }
    /* C√°c style kh√°c gi·ªØ nguy√™n */
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <img src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Ff930e667.%E1%BA%A2nh.025539.jpg" alt="LumiGlobal Logo" class="logo">
      <h1>B√°o C√°o MKT LumiGlobal</h1>
    </div>

    <button id="addRow" type="button" class="add-row-btn">‚ûï Th√™m d√≤ng tr·ªëng</button>

    <form id="dataForm">
      <table id="dataTable">
        <thead>
          <tr>
            <th>H√†nh ƒë·ªông</th>
            <th>T√™n</th>
            <th>Ng√†y</th>
            <th>Ca</th>
            <th>S·∫£n ph·∫©m</th>
            <th>Th·ªã tr∆∞·ªùng</th>
            <th>Page</th>
            <th>TKQC</th>
            <th>CPQC</th>
            <th>Via log</th>
            <th>S·ªë Mess+Cmt</th>
            <th class="hidden">id</th>
            <th class="hidden">Team</th>
            <th class="hidden">id NS</th>
          </tr>
        </thead>
        <tbody>
          <!-- C√°c d√≤ng s·∫Ω ƒë∆∞·ª£c th√™m t·ª± ƒë·ªông v√†o ƒë√¢y -->
        </tbody>
      </table>
      <button type="submit" id="submitBtn" class="submit-btn">üöÄ G·ª≠i b√°o c√°o</button>
    </form>

    <p id="responseMessage"></p>
  </div>

  <script>
    const addRowBtn = document.getElementById('addRow');
    const tbody = document.querySelector('#dataTable tbody');
    const form = document.getElementById('dataForm');
    const respMsg = document.getElementById('responseMessage');
    
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzn1xZCMptrE3SKEFhTW-tV8aGg_AVZcGh03W_0BHCsMa9SOXKRue3zZD8Zr5LY-iwp/exec';

    // Danh s√°ch data
    const productList = [ "Kem body", "CF FG", "CB BAKU", "Bakuchiol", "C√† ph√™", "N√°m", "K·∫πo D√¢u", "Serum S√¢m", "K·∫πo D√¢u New", "Body TBN", "Baku TBN", "DG", "K·∫πo T√°o" ];
    const marketList = ["Nh·∫≠t", "H√†n", "Canada", "US", "√öc", "Anh"];
    const shiftList = ["H·∫øt ca", "Gi·ªØa ca", "Ca Chi·ªÅu"];
    const employeeList = [ "Ph·∫°m Ti·∫øn Th√†nh", "L√™ ƒê√¨nh To·∫£n", "Tr·∫ßn Qu·ªëc Kh·∫£i", "M·∫°nh C∆∞·ªùng", "Nguy·ªÖn Th·ªã Hi·∫øu", "V≈© Vi·∫øt Anh", "L·ª•c Tr·∫ßn Minh Tr√≠", "ƒêo√†n Ng·ªçc Hu√¢n", "Nguy·ªÖn Hi·ªÅn L∆∞∆°ng", "Tr·∫ßn Huy H√πng", "Nguy·ªÖn Anh Tu·∫•n", "Tr·∫ßn Ti·∫øn", "Nguy·ªÖn Th·ªã Nh∆∞ Qu·ª≥nh", "Nguy·ªÖn Quang Tr∆∞·ªùng" ];
    const tkqcData = { "Ph·∫°m Ti·∫øn Th√†nh": ["tcm 300", "tcm 393(1)", "tcm 431(1)", "tcm 449(1)", "lumi hn 05(1)", "lumi hn 14(1)", "lumi hn 21", "lumi hn 29", "lumi hn 52", "lumi hn 53", "lumi hn 54", "lumi hn 60", "lumi hn 68", "lumi hn 75", "lumi hn 82", "lumi hn 83"], "L√™ ƒê√¨nh To·∫£n": ["tcm 365(1)", "tcm 386(1)", "tcm 389-b(1)", "tcm 427-b", "lumi hn 07(1)", "lumi hn 26", "lumi hn 40"], "Tr·∫ßn Qu·ªëc Kh·∫£i": ["tcm 369-b(1)", "tcm 380(1)", "tcm 387(1)", "tcm 455", "lumi hn 02(1)", "lumi hn 12", "lumi hn 16(1)", "lumi hn 35", "lumi hn 47", "lumi hn 48"], "M·∫°nh C∆∞·ªùng": ["tcm 372-b", "tcm 376-b", "tcm 378(1)", "tcm 394(1)", "tcm 407(1)", "tcm 418(1)", "tcm 442(1)", "lumi hn 04", "lumi hn 06", "lumi hn 24", "lumi hn 28", "lumi hn 50", "lumi hn 63", "c∆∞·ªùng test 01"], "Nguy·ªÖn Th·ªã Hi·∫øu": ["tcm 381(1)", "tcm 406(1)", "tcm 413-b", "tcm 440(1)", "tcm 443(1)", "lumi hn 10", "lumi hn 23(hold)", "lumi hn 25", "lumi hn 32", "lumi hn 33", "lumi hn 61", "lumi hn 70-7"], "V≈© Vi·∫øt Anh": ["tcm 390", "tcm 450(1)", "lumi hn 31", "lumi hn 37", "lumi hn 46", "lumi hn 74"], "L·ª•c Tr·∫ßn Minh Tr√≠": ["tcm 399-b", "tcm 456", "lumi hn 19", "lumi hn 27", "lumi  hn 34", "lumi hn 38", "lumi hn 44", "lumi hn 45", "lumi hn 49", "lumi hn 62", "lumi hn 64", "lumi hn 65 -7"], "ƒêo√†n Ng·ªçc Hu√¢n": ["tcm 400-b(1)", "lumi hn 03(1)", "lumi hn 15(1)", "lumi hn 42", "lumi hn 51", "lumi hn 71"], "Nguy·ªÖn Hi·ªÅn L∆∞∆°ng": ["tcm 410-b(1)", "tcm 430-b", "tcm 434-b(1)", "lumi hn 13(1)", "lumi hn 41", "lumi hn 57", "lumi hn 66", "lumi hn 79", "lumi hn 81", "lumi hn 84 mst", "l∆∞∆°ng test 01"], "Tr·∫ßn Huy H√πng": ["tcm 429-b(1)", "tcm 438(1)", "lumi hn 01", "lumi hn 17(1)", "lumi hn 36", "lumi hn 58", "lumi hn 59", "lumi hn 67", "lumi hn 73", "lumi hn 85 mst"], "Nguy·ªÖn Anh Tu·∫•n": ["tcm  395", "lumi hn 11", "lumi hn 78"], "Tr·∫ßn Ti·∫øn": ["tcm 426-b", "lumi hn 76"], "Nguy·ªÖn Th·ªã Nh∆∞ Qu·ª≥nh": ["lumi hn 08 hold", "lumi hn 22", "lumi hn 30", "lumi hn 77"], "Nguy·ªÖn Quang Tr∆∞·ªùng": ["lumi hn 09", "lumi hn 55", "lumi hn 56", "lumi hn 72"] };
    let pageData = { "Ph·∫°m Ti·∫øn Th√†nh": ["Page Th√†nh 1", "Page Th√†nh 2 - Skincare", "Page chung A"], "L√™ ƒê√¨nh To·∫£n": ["Page To·∫£n - Th·ªùi trang", "Page To·∫£n 2", "Page chung B"], "Tr·∫ßn Qu·ªëc Kh·∫£i": ["Page Kh·∫£i 1"], "M·∫°nh C∆∞·ªùng": ["Page C∆∞·ªùng M·ªπ ph·∫©m", "Page C∆∞·ªùng 2"] };

    const numberFormatter = new Intl.NumberFormat('vi-VN');
    function formatNumber(value) {
        if (!value) return '';
        const cleanValue = String(value).replace(/\D/g, '');
        if (cleanValue === '') return '';
        return numberFormatter.format(cleanValue);
    }

    function getToday() { return new Date().toISOString().split('T')[0]; }

    function createRow(data = {}, insertAfter = null) {
      const tr = document.createElement('tr');
      const uniqueId = `id_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
      
      tr.innerHTML = `
        <td class="action-buttons">
          <button type="button" class="removeRow" title="X√≥a d√≤ng n√†y">‚ùå</button>
        </td>
        <td>
          <select name="T√™n" class="editable name-select">
            <option value="">-- Ch·ªçn t√™n --</option>
            ${employeeList.map(name => `<option value="${name}" ${data.T√™n === name ? 'selected' : ''}>${name}</option>`).join('')}
          </select>
        </td>
        <td><input name="Ng√†y" type="date" value="${data.Ng√†y || getToday()}" class="editable"></td>
        <td>
          <select name="ca" class="editable">
            ${shiftList.map(shift => `<option value="${shift}" ${data.ca === shift ? 'selected' : ''}>${shift}</option>`).join('')}
          </select>
        </td>
        <td>
          <input name="S·∫£n_ph·∫©m" list="productList" value="${data.S·∫£n_ph·∫©m || ''}" class="editable">
          <datalist id="productList">${productList.map(product => `<option value="${product}">`).join('')}</datalist>
        </td>
        <td>
          <div class="market-container">
            <input name="Th·ªã_tr∆∞·ªùng" list="marketList" value="${data.Th·ªã_tr∆∞·ªùng || ''}" class="editable">
            <datalist id="marketList">${marketList.map(market => `<option value="${market}">`).join('')}</datalist>
          </div>
        </td>
        <td>
          <select name="page" class="editable page-select">
            <option value="">-- Ch·ªçn Page --</option>
          </select>
        </td>
        <!-- THAY ƒê·ªîI 1: Chuy·ªÉn √¥ TKQC th√†nh input + datalist -->
        <td>
          <input name="TKQC" class="editable tkqc-input" list="tkqc-datalist-${uniqueId}" value="${data.TKQC || ''}" placeholder="Ch·ªçn ho·∫∑c nh·∫≠p m·ªõi...">
          <datalist id="tkqc-datalist-${uniqueId}">
            <!-- C√°c option s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JS -->
          </datalist>
        </td>
        <td>
          <input type="text" inputmode="numeric" class="editable cpqc-display" placeholder="Nh·∫≠p chi ph√≠">
          <input type="hidden" name="CPQC" class="cpqc-hidden" value="${data.CPQC || ''}">
        </td>
        <td><input name="Via_log" value="${data.Via_log || ''}" class="editable"></td>
        <td><input name="S·ªë_Mess_Cmt" value="${data.S·ªë_Mess_Cmt || ''}" class="editable" type="number" step="1"></td>
        <td class="hidden"><input name="id" value="${data.id || uniqueId}" readonly></td>
        <td class="hidden"><input name="Team" value="${data.Team || ''}" readonly></td>
        <td class="hidden"><input name="id_NS" value="${data.id_NS || ''}" readonly></td>
      `;

      const cpqcDisplay = tr.querySelector('.cpqc-display');
      const cpqcHidden = tr.querySelector('.cpqc-hidden');
      cpqcDisplay.value = formatNumber(cpqcHidden.value);
      cpqcDisplay.addEventListener('input', () => {
        const rawValue = cpqcDisplay.value.replace(/\D/g, '');
        cpqcHidden.value = rawValue;
        const currentCursor = cpqcDisplay.selectionStart;
        const originalLength = cpqcDisplay.value.length;
        cpqcDisplay.value = formatNumber(rawValue);
        const newLength = cpqcDisplay.value.length;
        cpqcDisplay.setSelectionRange(currentCursor + (newLength - originalLength), currentCursor + (newLength - originalLength));
      });

      tr.querySelector('.removeRow').addEventListener('click', () => tr.remove());
      
      const nameSelect = tr.querySelector('.name-select');
      const pageSelect = tr.querySelector('.page-select');
      // THAY ƒê·ªîI 2: L·∫•y ra c√°c element m·ªõi c·ªßa TKQC
      const tkqcInput = tr.querySelector('.tkqc-input');
      const tkqcDatalist = tr.querySelector(`#tkqc-datalist-${uniqueId}`);


      nameSelect.addEventListener('change', function() {
        const selectedName = this.value;
        
        // THAY ƒê·ªîI 3: C·∫≠p nh·∫≠t datalist cho TKQC thay v√¨ select
        tkqcDatalist.innerHTML = ''; // X√≥a c√°c g·ª£i √Ω c≈©
        if (selectedName && tkqcData[selectedName]) {
          tkqcData[selectedName].forEach(tkqc => {
            const option = document.createElement('option');
            option.value = tkqc;
            tkqcDatalist.appendChild(option);
          });
        }

        // C·∫≠p nh·∫≠t Page (gi·ªØ nguy√™n)
        pageSelect.innerHTML = '<option value="">-- Ch·ªçn Page --</option>';
        if (selectedName && pageData[selectedName]) {
          pageData[selectedName].forEach(page => {
            const option = document.createElement('option');
            option.value = page; option.textContent = page;
            pageSelect.appendChild(option);
          });
        }
      });

      // THAY ƒê·ªîI 4: Khi t·∫£i d·ªØ li·ªáu, kh√¥ng c·∫ßn g√°n gi√° tr·ªã cho input n·ªØa v√¨ ƒë√£ l√†m trong HTML
      if (nameSelect.value) {
          nameSelect.dispatchEvent(new Event('change'));
          // Ph·∫£i ch·ªù event 'change' ch·∫°y xong m·ªõi g√°n gi√° tr·ªã ƒë∆∞·ª£c
          // Gi√° tr·ªã cho tkqcInput ƒë√£ ƒë∆∞·ª£c g√°n s·∫µn trong HTML `value="${data.TKQC || ''}"`
          pageSelect.value = data.page || '';
      }

      if (insertAfter) { tbody.insertBefore(tr, insertAfter.nextSibling); } 
      else { tbody.appendChild(tr); }
      return tr;
    }

    // C√°c h√†m addRowBtn, form.submit, initializeRowsFromUrl kh√¥ng thay ƒë·ªïi
    addRowBtn.addEventListener('click', () => {
      const newRow = createRow();
      newRow.querySelector('[name="T√™n"]').focus();
    });

    form.addEventListener('submit', e => {
      e.preventDefault();
      const submitButton = document.getElementById('submitBtn');
      submitButton.disabled = true; submitButton.textContent = 'ƒêang g·ª≠i...';
      respMsg.className = ''; respMsg.textContent = '';
      const allRows = Array.from(tbody.querySelectorAll('tr')).map(tr => {
        const obj = {};
        tr.querySelectorAll('input, textarea, select').forEach(inp => { obj[inp.name] = inp.value; });
        // C·∫≠p nh·∫≠t ƒëi·ªÅu ki·ªán ki·ªÉm tra, th√™m TKQC v√†o
        if (!obj['T√™n'] || !obj['S·∫£n_ph·∫©m'] || !obj['Th·ªã_tr∆∞·ªùng'] || !obj['page'] || !obj['TKQC']) {
           obj._invalid = true;
        }
        return obj;
      });
      const validRows = allRows.filter(row => !row._invalid);
      const invalidRowCount = allRows.length - validRows.length;
      if (invalidRowCount > 0) {
          respMsg.className = 'error';
          respMsg.innerText = `L·ªói: C√≥ ${invalidRowCount} d√≤ng thi·∫øu th√¥ng tin. Vui l√≤ng ki·ªÉm tra l·∫°i c√°c c·ªôt b·∫Øt bu·ªôc.`;
          submitButton.disabled = false; submitButton.textContent = 'üöÄ G·ª≠i b√°o c√°o';
          return;
      }
      if (!validRows.length) {
        respMsg.className = 'error'; respMsg.innerText = 'Ch∆∞a c√≥ d√≤ng n√†o h·ª£p l·ªá!';
        submitButton.disabled = false; submitButton.textContent = 'üöÄ G·ª≠i b√°o c√°o';
        return;
      }
      const payload = new URLSearchParams({ rows: JSON.stringify(validRows) });
      fetch(SCRIPT_URL, { method: 'POST', body: payload })
      .then(r => r.json())
      .then(json => {
        if (json.error) {
            respMsg.className = 'error'; respMsg.innerText = 'L·ªói t·ª´ server: ' + json.error;
        } else {
            respMsg.className = 'success'; respMsg.innerText = json.message;
            tbody.innerHTML = '';
            createRow();
        }
      })
      .catch(err => {
        respMsg.className = 'error'; respMsg.innerText = 'L·ªói k·∫øt n·ªëi: ' + err;
      })
      .finally(() => {
        submitButton.disabled = false; submitButton.textContent = 'üöÄ G·ª≠i b√°o c√°o';
      });
    });

    function initializeRowsFromUrl() {
        tbody.innerHTML = ''; 
        const urlParams = new URLSearchParams(window.location.search);
        const dataParam = urlParams.get('data');
        let rowsCreated = 0;
        if (dataParam) {
            const rowsData = dataParam.split('_a_');
            rowsData.forEach(rowString => {
                if (rowString.trim() === '') return;
                const fields = rowString.split('_b_');
                const rowDataObject = {
                    id:          fields[0] ? decodeURIComponent(fields[0]) : '',
                    T√™n:         fields[1] ? decodeURIComponent(fields[1]) : '',
                    S·∫£n_ph·∫©m:   fields[2] ? decodeURIComponent(fields[2]) : '',
                    Th·ªã_tr∆∞·ªùng:  fields[3] ? decodeURIComponent(fields[3]) : '',
                    page:        fields[4] ? decodeURIComponent(fields[4]) : '',
                    TKQC:        fields[5] ? decodeURIComponent(fields[5]) : '',
                    CPQC:        fields[6] ? decodeURIComponent(fields[6]) : ''
                };
                createRow(rowDataObject);
                rowsCreated++;
            });
        }
        if (rowsCreated === 0) {
            createRow();
        }
    }

    initializeRowsFromUrl();
    
  </script>
</body>
</html>
















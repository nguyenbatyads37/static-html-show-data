<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Form G·ª≠i D·ªØ Li·ªáu (N√¢ng C·∫•p)</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 30px auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; vertical-align: middle; }
    th { background-color: #f2f2f2; }
    input, textarea { width: 100%; box-sizing: border-box; padding: 6px; border-radius: 3px; border: 1px solid #ddd; }
    button { padding: 6px 12px; margin: 0; cursor: pointer; border-radius: 4px; border: 1px solid transparent; }
    #addRow { background-color: #28a745; color: white; margin-bottom: 15px; }
    #submitBtn { background-color: #007bff; color: white; width: 100%; margin-top: 15px; font-weight: bold; }
    #submitBtn:disabled { background-color: #6c757d; cursor: not-allowed; }
    #responseMessage { margin-top: 12px; font-weight: bold; text-align: center; }
    .action-cell { display: flex; gap: 5px; justify-content: center; }
    .removeRow { background-color: #dc3545; color: white; }
    .addSimilar { background-color: #17a2b8; color: white; }
  </style>
</head>
<body>
  <h2>Th√™m / Ch·ªânh s·ª≠a nhi·ªÅu d√≤ng</h2>
  <button id="addRow" type="button">‚ûï Th√™m d√≤ng tr·ªëng</button>

  <form id="dataForm">
    <table id="dataTable">
      <thead>
        <tr>
          <th>T√™n</th>
          <th>Email</th>
          <th>Message</th>
          <th>Dogf</th>
          <th style="width: 15%;">H√†nh ƒë·ªông</th>
        </tr>
      </thead>
      <tbody>
        <!-- C√°c d√≤ng s·∫Ω ƒë∆∞·ª£c th√™m t·ª± ƒë·ªông v√†o ƒë√¢y -->
      </tbody>
    </table>
    <button type="submit" id="submitBtn">üöÄ G·ª≠i t·∫•t c·∫£</button>
  </form>

  <p id="responseMessage"></p>

  <script>
    const addRowBtn = document.getElementById('addRow');
    const tbody     = document.querySelector('#dataTable tbody');
    const form      = document.getElementById('dataForm');
    const respMsg   = document.getElementById('responseMessage');
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxIjM0XaM1FvQoquodYmuoCnWO-RBTko6z1PnE3rHEOcfr2Xih48jkzCa1pWus8QuntTQ/exec';

    // H√†m t·∫°o m·ªôt d√≤ng m·ªõi trong b·∫£ng
    function createRow(data = {}) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input name="name"    value="${data.name || ''}"    required></td>
        <td><input name="email"   type="email" value="${data.email || ''}"   required></td>
        <td><textarea name="message" rows="2">${data.message || ''}</textarea></td>
        <td><input name="dogf"    value="${data.dogf || ''}" placeholder="D·ªØ li·ªáu ph·ª•..."></td>
        <td>
          <div class="action-cell">
            <button type="button" class="addSimilar" title="Sao ch√©p d√≤ng n√†y">‚ûï</button>
            <button type="button" class="removeRow" title="X√≥a d√≤ng n√†y">‚ùå</button>
          </div>
        </td>
      `;
      
      // S·ª± ki·ªán x√≥a d√≤ng
      tr.querySelector('.removeRow').addEventListener('click', () => tr.remove());
      
      // N√ÇNG C·∫§P: S·ª± ki·ªán sao ch√©p d√≤ng
      tr.querySelector('.addSimilar').addEventListener('click', () => {
        const currentRowData = {
          name:    tr.querySelector('[name="name"]').value,
          email:   tr.querySelector('[name="email"]').value,
          message: tr.querySelector('[name="message"]').value,
          dogf:    tr.querySelector('[name="dogf"]').value
        };
        createRow(currentRowData); // T·∫°o d√≤ng m·ªõi v·ªõi d·ªØ li·ªáu v·ª´a sao ch√©p
      });

      tbody.appendChild(tr);
    }

    // H√†m ƒë·ªçc d·ªØ li·ªáu t·ª´ URL ƒë·ªÉ ƒëi·ªÅn s·∫µn v√†o form
    function prefillFromUrl() {
      const params = new URLSearchParams(window.location.search);
      const rowsParam = params.get('rows');

      if (rowsParam) { // ∆Øu ti√™n tham s·ªë 'rows' ch·ª©a m·∫£ng JSON
        try {
          const arr = JSON.parse(decodeURIComponent(rowsParam));
          if (Array.isArray(arr) && arr.length > 0) {
            arr.forEach(r => createRow(r));
            return; // D·ª´ng l·∫°i sau khi ƒë√£ x·ª≠ l√Ω
          }
        } catch (e) {
          console.warn('Kh√¥ng th·ªÉ ph√¢n t√≠ch tham s·ªë "rows":', e);
        }
      } else if (params.has('name')) { // X·ª≠ l√Ω tham s·ªë ƒë∆°n l·∫ª
        createRow({
          name:    params.get('name')    || '',
          email:   params.get('email')   || '',
          message: params.get('message') || '',
          dogf:    params.get('dogf')    || ''
        });
        return; // D·ª´ng l·∫°i sau khi ƒë√£ x·ª≠ l√Ω
      }
      
      // N·∫øu kh√¥ng c√≥ d·ªØ li·ªáu t·ª´ URL, t·∫°o m·ªôt d√≤ng tr·ªëng
      createRow();
    }
    
    // G·ªåI C√ÅC H√ÄM KH·ªûI T·∫†O
    document.addEventListener('DOMContentLoaded', prefillFromUrl);
    addRowBtn.addEventListener('click', () => createRow());

    // N√ÇNG C·∫§P: X·ª≠ l√Ω s·ª± ki·ªán SUBMIT m·ªôt c√°ch ·ªïn ƒë·ªãnh
    form.addEventListener('submit', e => {
      e.preventDefault(); // NgƒÉn form t·∫£i l·∫°i trang

      // Ki·ªÉm tra xem form c√≥ h·ª£p l·ªá kh√¥ng (d·ª±a v√†o 'required', 'type="email"')
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }
      
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      respMsg.style.color = 'orange';
      respMsg.innerText = 'ƒêang g·ª≠i d·ªØ li·ªáu...';

      const allRows = Array.from(tbody.querySelectorAll('tr')).map(tr => ({
        name:    tr.querySelector('[name="name"]').value,
        email:   tr.querySelector('[name="email"]').value,
        message: tr.querySelector('[name="message"]').value,
        dogf:    tr.querySelector('[name="dogf"]').value
      }));

      if (!allRows.length) {
        respMsg.style.color = 'red';
        respMsg.innerText = 'Ch∆∞a c√≥ d√≤ng n√†o ƒë·ªÉ g·ª≠i!';
        submitBtn.disabled = false;
        return;
      }
      
      // S·ª¨A L·ªñI: G·ª≠i d·ªØ li·ªáu b·∫±ng ph∆∞∆°ng th·ª©c POST JSON ƒë√∫ng chu·∫©n
      fetch(SCRIPT_URL, {
        method: 'POST',
        mode: 'cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ rows: allRows })
      })
      .then(r => r.json())
      .then(json => {
        if (json.status === "error") { // Gi·∫£ s·ª≠ server tr·∫£ v·ªÅ {status: 'error', ...}
          throw new Error(json.message);
        }
        respMsg.style.color = 'green';
        respMsg.innerText = json.message || "G·ª≠i th√†nh c√¥ng!";
        tbody.innerHTML = ''; // X√≥a c√°c d√≤ng ƒë√£ g·ª≠i
        createRow(); // N√ÇNG C·∫§P: T·∫°o l·∫°i m·ªôt d√≤ng tr·ªëng m·ªõi
      })
      .catch(err => {
        respMsg.style.color = 'red';
        respMsg.innerText = 'L·ªói: ' + err.message;
      })
      .finally(() => {
        submitBtn.disabled = false; // Lu√¥n b·∫≠t l·∫°i n√∫t sau khi ho√†n th√†nh
      });
    });
  </script>
</body>
</html>













<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>B√°o C√°o MKT LumiGlobal</title>
  <style>
    :root {
      --primary-color: #0056b3;
      --primary-color-dark: #003d82;
      --success-color: #28a745;
      --danger-color: #dc3545;
      --info-color: #17a2b8;
      --light-gray: #f8f9fa;
      --medium-gray: #ddd;
      --dark-gray: #333;
      --border-radius: 6px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--light-gray);
      color: var(--dark-gray);
      line-height: 1.6;
    }
    
    .container {
      max-width: 95vw;
      margin: 2rem auto;
      background-color: white;
      border-radius: var(--border-radius);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      padding: 2rem;
    }
    
    .header {
      display: flex;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1.5rem;
      border-bottom: 2px solid var(--primary-color);
    }
    
    .logo {
      height: 60px;
      margin-right: 1.5rem;
    }
    
    h1 {
      color: var(--primary-color);
      margin: 0;
      font-weight: 600;
      font-size: 2rem;
    }
    
    .table-wrapper {
      overflow-x: auto;
      border: 1px solid var(--medium-gray);
      border-radius: var(--border-radius);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      background-color: white;
    }
    
    th, td {
      border: 1px solid var(--medium-gray);
      padding: 0.8rem 1rem;
      text-align: left;
      vertical-align: middle;
      white-space: nowrap;
    }
    
    th {
      background-color: var(--primary-color);
      color: white;
      font-weight: 500;
      position: sticky;
      top: 0;
      z-index: 2; /* [ƒê√É THAY ƒê·ªîI] TƒÉng z-index ƒë·ªÉ header lu√¥n ·ªü tr√™n */
    }

    tr:nth-child(even) { background-color: var(--light-gray); }
    tr:hover { background-color: #e9ecef; }
    
    input, textarea, button, select {
      box-sizing: border-box;
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--medium-gray);
      border-radius: var(--border-radius);
      width: 100%;
      font-family: inherit;
      font-size: 0.95rem;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    
    td input, td select {
        white-space: normal;
        height: auto;
        min-height: 38px;
    }
    
    input:focus, select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(0, 86, 179, 0.2);
        outline: none;
    }

    button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 500;
    }
    button:hover { background-color: var(--primary-color-dark); }

    /* [M·ªöI] CSS cho h·ªá th·ªëng autocomplete t√πy ch·ªânh */
    .autocomplete {
        position: relative;
        display: inline-block;
        width: 100%;
    }

    .autocomplete-items {
        position: absolute;
        border: 1px solid var(--medium-gray);
        border-bottom: none;
        border-top: none;
        z-index: 99;
        top: 100%;
        left: 0;
        right: 0;
        background-color: white;
        box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        border-radius: 0 0 var(--border-radius) var(--border-radius);
        max-height: 250px;
        overflow-y: auto;
    }

    .autocomplete-items div {
        padding: 10px;
        cursor: pointer;
        border-bottom: 1px solid #e9ecef;
        /* ƒê√¢y l√† ph·∫ßn quan tr·ªçng ƒë·ªÉ ch·ªØ xu·ªëng d√≤ng */
        white-space: normal;
        word-wrap: break-word;
        line-height: 1.4;
    }

    .autocomplete-items div:hover {
        background-color: #e9ecef;
    }

    .autocomplete-active {
        background-color: var(--primary-color) !important;
        color: #ffffff;
    }
    
    .action-buttons { display: flex; gap: 0.5rem; justify-content: center; }
    .action-buttons button { padding: 0.4rem 0.6rem; }
    .add-row-btn { background-color: var(--success-color); margin-bottom: 1.5rem; padding: 0.75rem 1.5rem; font-size: 1.1rem; }
    .add-row-btn:hover { background-color: #218838; }
    .submit-btn { background-color: var(--danger-color); margin-top: 1.5rem; padding: 0.75rem 1.5rem; font-size: 1.1rem; }
    .submit-btn:hover { background-color: #c82333; }
    #responseMessage { margin-top: 1.5rem; padding: 1rem; border-radius: var(--border-radius); text-align: center; font-weight: bold; }
    .success { background-color: #d4edda; color: #155724; }
    .error { background-color: #f8d7da; color: #721c24; }
    .error-cell { background-color: #f8d7da !important; border: 1px solid var(--danger-color) !important; }
    .hidden { display: none; }
    .addSimilar { background-color: var(--info-color); }
    .addSimilar:hover { background-color: #138496; }
    .removeRow { background-color: #6c757d; }
    .removeRow:hover { background-color: #5a6268; }
    .input-container { display: flex; align-items: center; gap: 0.5rem; }
    .input-container .autocomplete { flex-grow: 1; }
    .input-container .addSimilar { flex-shrink: 0; width: 38px; height: 38px; padding: 0; font-size: 1.2rem; }
    .status { background: #e9ecef; padding: 10px; margin: 10px 0; border-radius: 4px; font-size: 14px; color: #495057; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <img src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Ff930e667.%E1%BA%A2nh.025539.jpg" alt="LumiGlobal Logo" class="logo">
      <h1>B√°o C√°o MKT LumiGlobal</h1>
    </div>

    <div class="status" id="status">ƒê√£ s·∫µn s√†ng - Click "Th√™m d√≤ng tr·ªëng" ƒë·ªÉ b·∫Øt ƒë·∫ßu</div>

    <button id="addRowBtn" type="button" class="add-row-btn">‚ûï Th√™m d√≤ng tr·ªëng</button>
    
    <form id="dataForm" novalidate>
      <div class="table-wrapper">
        <table id="dataTable">
          <thead>
            <tr>
              <th>H√†nh ƒë·ªông</th>
              <th>T√™n</th>
              <th>Ng√†y</th>
              <th>Ca</th>
              <th>S·∫£n ph·∫©m</th>
              <th>Th·ªã tr∆∞·ªùng</th>
              <th>Page</th>
              <th>TKQC</th>
              <th>CPQC</th>
              <th>Via log</th>
              <th>S·ªë Mess+Cmt</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <!-- Rows will be added here -->
          </tbody>
        </table>
      </div>
      <button type="submit" id="submitBtn" class="submit-btn">üöÄ G·ª≠i b√°o c√°o</button>
    </form>

    <div id="responseMessage"></div>
  </div>

  <script>
    // Data (kh√¥ng ƒë·ªïi)
    const employeeList = ["Ph·∫°m Ti·∫øn Th√†nh","L√™ ƒê√¨nh To·∫£n","Tr·∫ßn Qu·ªëc Kh·∫£i","M·∫°nh C∆∞·ªùng","Nguy·ªÖn Th·ªã Hi·∫øu","V≈© Vi·∫øt Anh","L·ª•c Tr·∫ßn Minh Tr√≠","ƒêo√†n Ng·ªçc Hu√¢n","Nguy·ªÖn Hi·ªÅn L∆∞∆°ng","Tr·∫ßn Huy H√πng","Nguy·ªÖn Anh Tu·∫•n","Tr·∫ßn Ti·∫øn","Nguy·ªÖn Th·ªã Nh∆∞ Qu·ª≥nh","Nguy·ªÖn Quang Tr∆∞·ªùng"];
    const productList = ["Kem body","CF FG","CB BAKU","Bakuchiol","C√† ph√™","N√°m","K·∫πo D√¢u","Serum S√¢m","K·∫πo D√¢u New","Body TBN","Baku TBN","DG","K·∫πo T√°o"];
    const marketList = ["Nh·∫≠t","H√†n","Canada","US","√öc","Anh"];
    const shiftList = ["H·∫øt ca","Gi·ªØa ca","Ca Chi·ªÅu"];
    const tkqcData = { "L√™ ƒê√¨nh To·∫£n": ["lumi hn 07(1)","tcm 365(1)","tcm 386(1)","tcm 389-b(1)","tcm 427-b"], "L·ª•c Tr·∫ßn Minh Tr√≠": ["tcm 399-b","tcm 456"], "M·∫°nh C∆∞·ªùng": ["lumi hn 04","lumi hn 06","tcm 372-b","tcm 376-b","tcm 378(1)","tcm 394(1)","tcm 407(1)","tcm 418(1)","tcm 442(1)"], "Nguy·ªÖn Anh Tu·∫•n": ["lumi hn 11","tcm  395"], "Nguy·ªÖn Hi·ªÅn L∆∞∆°ng": ["lumi hn 13(1)","tcm 410-b(1)","tcm 430-b","tcm 434-b(1)"], "Nguy·ªÖn Quang Tr∆∞·ªùng": ["lumi hn 09"], "Nguy·ªÖn Th·ªã Hi·∫øu": ["lumi hn 10","tcm 381(1)","tcm 406(1)","tcm 413-b","tcm 440(1)","tcm 443(1)"], "Nguy·ªÖn Th·ªã Nh∆∞ Qu·ª≥nh": ["lumi hn 08 hold"], "Ph·∫°m Ti·∫øn Th√†nh": ["lumi hn 05(1)","lumi hn 14(1)","tcm 300","tcm 393(1)","tcm 431(1)","tcm 449(1)"], "Tr·∫ßn Huy H√πng": ["lumi hn 01","tcm 429-b(1)","tcm 438(1)"], "Tr·∫ßn Qu·ªëc Kh·∫£i": ["lumi hn 02(1)","lumi hn 12","tcm 369-b(1)","tcm 380(1)","tcm 387(1)","tcm 455"], "Tr·∫ßn Ti·∫øn": ["tcm 426-b"], "V≈© Vi·∫øt Anh": ["tcm 390","tcm 450(1)"], "ƒêo√†n Ng·ªçc Hu√¢n": ["lumi hn 03(1)","tcm 400-b(1)"] };
    const pageData = { "Tr·∫ßn Qu·ªëc Kh·∫£i": ["FitGum 20X Collagen Chia Coffee - JAPAN - 100% FDA 01","Body Lotion Venature Glutathione - CA -100% FDA"], "Tr·∫ßn Huy H√πng": ["50X CA Store Legit - Body Lotion Venature Glutathione","AUS Store Legit - Venature Bakuchiol"], "Nguy·ªÖn Th·ªã Hi·∫øu": ["Anna Store - Venature Bakuchiol Retinol In Japan","Anna Store 2 In JP - Venature Glutathione Body Lotion"], "Nguy·ªÖn Hi·ªÅn L∆∞∆°ng": ["Bakuchiol Retinol Anti-Aging Serum In US - Natural Products","Bakuchiol Retinol In Australia - Beauty Support"], "ƒêo√†n Ng·ªçc Hu√¢n": ["Bakuchiol Retinol in AU.inc - Skin rejuvenation store","Bakuchiol Retinol In Canada - Skin rejuvenation store"], "M·∫°nh C∆∞·ªùng": ["Bakuchiol Retinol Serum - Beauty Skin Australia","Bakuchiol Retinol Serum - Beauty Skin Canada"], "Nguy·ªÖn Quang Tr∆∞·ªùng": ["Bakuchiol Retinol Serum - Online Shop in Japan","Bakuchiol Retinol Serum - Online Shop USA"], "Ph·∫°m Ti·∫øn Th√†nh": ["Bakuchiol Retinol Serum - Top Skincare Store AU","Bakuchiol Retinol Serum - Top Skincare Store CA"], "Nguy·ªÖn Th·ªã Nh∆∞ Qu·ª≥nh": ["Bakuchiol Retinol Serum + Cream CA - Genuine Cosmetics","Barley Apple Cider Vitamins Gummies Canada - Genuine Store"], "V≈© Vi·∫øt Anh": ["FitGum 20X Collagen Chia Coffee in Japan - Genuine NO.1","FitGum 20X Collagen Chia Coffee in USA - Genuine NO.1"], "L·ª•c Tr·∫ßn Minh Tr√≠": ["Fitgum Collagen Chia Coffee - Store Mintres in Japan","Fitgum Collagen Chia Coffee - Store Mintres in US"] };

    // DOM elements v√† c√°c bi·∫øn (kh√¥ng ƒë·ªïi)
    const tableBody = document.getElementById('tableBody');
    const addRowBtn = document.getElementById('addRowBtn');
    const form = document.getElementById('dataForm');
    const statusDiv = document.getElementById('status');
    const respMsg = document.getElementById('responseMessage');
    let rowCounter = 0;

    // C√°c h√†m ti·ªán √≠ch (c√≥ thay ƒë·ªïi)
    function updateStatus(message) { /* ... kh√¥ng ƒë·ªïi ... */ }
    function formatCurrency(input) { /* ... kh√¥ng ƒë·ªïi ... */ }
    window.formatCurrency = formatCurrency;
    function getToday() { /* ... kh√¥ng ƒë·ªïi ... */ }
    function escapeHtml(str) { /* ... kh√¥ng ƒë·ªïi ... */ }
    function createOptions(list, selectedValue = '') { /* ... kh√¥ng ƒë·ªïi ... */ }
    function createDatalistOptions(list) { /* ... kh√¥ng ƒë·ªïi ... */ }

    // [M·ªöI] H·ªá th·ªëng autocomplete t√πy ch·ªânh
    function initAutocomplete(input, dataArray) {
        let currentFocus;
        input.addEventListener("input", function(e) {
            let listContainer, optionDiv, i, val = this.value;
            closeAllLists();
            if (!val) { return false;}
            currentFocus = -1;
            
            listContainer = document.createElement("DIV");
            listContainer.setAttribute("id", this.id + "autocomplete-list");
            listContainer.setAttribute("class", "autocomplete-items");
            this.parentNode.appendChild(listContainer);
            
            for (i = 0; i < dataArray.length; i++) {
                if (dataArray[i].toUpperCase().includes(val.toUpperCase())) {
                    optionDiv = document.createElement("DIV");
                    optionDiv.innerHTML = dataArray[i].replace(new RegExp(val, "gi"), "<strong>$&</strong>");
                    optionDiv.dataset.value = dataArray[i];
                    optionDiv.addEventListener("click", function(e) {
                        input.value = this.dataset.value;
                        closeAllLists();
                    });
                    listContainer.appendChild(optionDiv);
                }
            }
        });
        
        input.addEventListener("keydown", function(e) {
            let x = document.getElementById(this.id + "autocomplete-list");
            if (x) x = x.getElementsByTagName("div");
            if (e.keyCode == 40) { // Down
                currentFocus++;
                addActive(x);
            } else if (e.keyCode == 38) { // Up
                currentFocus--;
                addActive(x);
            } else if (e.keyCode == 13) { // Enter
                e.preventDefault();
                if (currentFocus > -1) {
                    if (x) x[currentFocus].click();
                }
            }
        });

        function addActive(x) {
            if (!x) return false;
            removeActive(x);
            if (currentFocus >= x.length) currentFocus = 0;
            if (currentFocus < 0) currentFocus = (x.length - 1);
            x[currentFocus].classList.add("autocomplete-active");
        }

        function removeActive(x) {
            for (let i = 0; i < x.length; i++) {
                x[i].classList.remove("autocomplete-active");
            }
        }
    }

    function closeAllLists(elmnt) {
        const items = document.getElementsByClassName("autocomplete-items");
        for (let i = 0; i < items.length; i++) {
            if (elmnt != items[i] && elmnt != items[i].parentNode.getElementsByTagName("input")[0]) {
                items[i].parentNode.removeChild(items[i]);
            }
        }
    }
    
    document.addEventListener("click", function (e) {
        closeAllLists(e.target);
    });

    function updateEmployeeData(employeeName, row) {
        const tkqcInput = row.querySelector('.tkqc-input');
        const pageInput = row.querySelector('.page-input');
        
        tkqcInput.value = '';
        pageInput.value = '';
        
        const tkqcList = tkqcData[employeeName] || [];
        const pageList = pageData[employeeName] || [];

        // [ƒê√É THAY ƒê·ªîI] Kh·ªüi t·∫°o autocomplete cho c√°c √¥ input
        initAutocomplete(tkqcInput, tkqcList);
        initAutocomplete(pageInput, pageList);
        
        updateStatus(`C·∫≠p nh·∫≠t d·ªØ li·ªáu cho ${employeeName}: ${tkqcList.length} TKQC, ${pageList.length} Page`);
    }

    function addNewRow(data = {}) {
      rowCounter++;
      const rowId = `row${rowCounter}`;
      
      const row = document.createElement('tr');
      row.dataset.rowId = rowId;
      
      // [ƒê√É THAY ƒê·ªîI] Lo·∫°i b·ªè <datalist> v√† b·ªçc input Page, TKQC trong div.autocomplete
      row.innerHTML = `
        <td class="action-buttons">
          <button type="button" class="removeRow" onclick="removeRow(this)">‚ùå</button>
        </td>
        <td><select name="T√™n" onchange="updateEmployeeData(this.value, this.closest('tr'))"><option value="">-- Ch·ªçn t√™n --</option>${createOptions(employeeList, data.T√™n)}</select></td>
        <td><input name="Ng√†y" type="date" value="${data.Ng√†y || getToday()}"></td>
        <td><select name="ca"><option value="">-- Ch·ªçn ca --</option>${createOptions(shiftList, data.ca)}</select></td>
        <td><div class="autocomplete"><input name="S·∫£n_ph·∫©m" value="${escapeHtml(data.S·∫£n_ph·∫©m || '')}"></div></td>
        <td><div class="input-container"><div class="autocomplete"><input name="Th·ªã_tr∆∞·ªùng" value="${escapeHtml(data.Th·ªã_tr∆∞·ªùng || '')}"></div><button type="button" class="addSimilar" onclick="addSimilarRow(this, false)">‚ûï</button></div></td>
        <td><div class="input-container"><div class="autocomplete"><input name="page" class="page-input" value="${escapeHtml(data.page || '')}"></div><button type="button" class="addSimilar" onclick="addSimilarRow(this, true)">‚ûï</button></div></td>
        <td><div class="autocomplete"><input name="TKQC" class="tkqc-input" value="${escapeHtml(data.TKQC || '')}"></div></td>
        <td><input name="CPQC" type="text" value="${data.CPQC || ''}" oninput="formatCurrency(this)"></td>
        <td><input name="Via_log" value="${escapeHtml(data.Via_log || '')}"></td>
        <td><input name="S·ªë_Mess_Cmt" type="number" value="${data.S·ªë_Mess_Cmt || ''}"></td>
        <td class="hidden"><input name="id" value="${data.id || 'id_' + Date.now() + rowCounter}" readonly></td>
        <td class="hidden"><input name="Team" value="${data.Team || ''}"></td>
        <td class="hidden"><input name="id_NS" value="${data.id_NS || ''}"></td>
      `;

      tableBody.appendChild(row);

      // [ƒê√É THAY ƒê·ªîI] Kh·ªüi t·∫°o autocomplete cho c√°c √¥ tƒ©nh h∆°n
      initAutocomplete(row.querySelector('[name="S·∫£n_ph·∫©m"]'), productList);
      initAutocomplete(row.querySelector('[name="Th·ªã_tr∆∞·ªùng"]'), marketList);

      // N·∫øu c√≥ d·ªØ li·ªáu t√™n t·ª´ tr∆∞·ªõc (t·∫£i t·ª´ URL), g·ªçi updateEmployeeData ƒë·ªÉ load autocomplete ƒë·ªông
      if (data.T√™n) {
        updateEmployeeData(data.T√™n, row);
      }
      
      const cpqcInput = row.querySelector('[name="CPQC"]');
      if (cpqcInput.value) { formatCurrency(cpqcInput); }

      updateStatus(`ƒê√£ th√™m d√≤ng ${rowCounter}`);
      return row;
    }

    // C√°c h√†m kh√°c kh√¥ng ƒë·ªïi ho·∫∑c thay ƒë·ªïi nh·ªè
    function removeRow(button) { /* ... kh√¥ng ƒë·ªïi ... */ }
    function addSimilarRow(button, keepPageData) { /* ... kh√¥ng ƒë·ªïi ... */ }
    window.updateEmployeeData = updateEmployeeData;
    window.removeRow = removeRow;
    window.addSimilarRow = addSimilarRow;
    function validateForm() { /* ... kh√¥ng ƒë·ªïi ... */ }
    function parseUrlData(dataString) { /* ... kh√¥ng ƒë·ªïi ... */ }
    function loadDataFromUrl() { /* ... kh√¥ng ƒë·ªïi ... */ }
    function handleSubmit(e) { /* ... kh√¥ng ƒë·ªïi ... */ }
    addRowBtn.addEventListener('click', () => addNewRow());
    form.addEventListener('submit', handleSubmit);
    document.addEventListener('DOMContentLoaded', () => {
      updateStatus('·ª®ng d·ª•ng ƒë√£ s·∫µn s√†ng');
      if (!loadDataFromUrl()) addNewRow();
    });
  </script>
</body>
</html>

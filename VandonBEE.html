<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Quản lý đơn hàng BEE</title>
  <style>
    :root {
      --filter-row-height: 38px;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      background-color: #f5f5f5;
      color: #333;
      margin: 0;
      user-select: none; 
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #2c3e50;
    }
    /* --- CSS MỚI CHO BỘ LỌC CHÍNH --- */
    .main-filters {
      display: flex;
      gap: 20px;
      align-items: center;
      margin-bottom: 15px;
      padding: 15px;
      background: #fff;
      border-radius: 5px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      flex-wrap: wrap;
    }
    .filter-group {
      display: flex;
      flex-direction: column;
    }
    .filter-group label {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 5px;
      color: #555;
    }
    .filter-group select, .filter-group input {
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    .tab-container {
      margin-bottom: 15px;
      padding: 5px;
      background: #fff;
      border-radius: 5px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .tab-btn {
      padding: 8px 15px;
      cursor: pointer;
      background-color: #ecf0f1;
      color: #2c3e50;
      border: 1px solid #bdc3c7;
      border-radius: 4px;
      font-size: 14px;
      transition: all 0.3s;
    }
    .tab-btn:hover {
      background-color: #dfe6e9;
    }
    .tab-btn.active {
      background-color: #3498db;
      color: white;
      border-color: #2980b9;
      font-weight: bold;
    }
    .tab-btn.tracking-tab {
      background-color: #e74c3c;
      color: white;
    }
    .tab-btn.tracking-tab.active {
      background-color: #c0392b;
    }
    .controls {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      align-items: center;
      background: #fff;
      padding: 10px 15px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .table-wrapper {
      position: relative;
      overflow: auto;
      max-height: 65vh;
      background: white;
      border-radius: 0 0 5px 5px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 1800px;
      font-size: 14px;
    }
    thead {
      position: sticky;
      top: 0;
      z-index: 10;
    }
    th, td {
      border: 1px solid #e0e0e0;
      padding: 8px 12px;
      text-align: left;
      white-space: nowrap;
      background-color: white;
    }
    th {
      background-color: #3498db;
      color: white;
      position: sticky;
      top: var(--filter-row-height);
      z-index: 20;
      font-weight: 500;
    }
    #filterRow th {
        top: 0;
        background-color: #f2f6fa;
        padding: 4px 8px;
    }
    .filter-input {
      width: 100%;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 3px;
      font-size: 13px;
    }
    td.editable {
      background-color: #fffbe8;
      user-select: text; 
    }
    button {
      padding: 6px 12px;
      cursor: pointer;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 13px;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #2980b9;
    }
    #downloadExcel {
        background-color: #16a085;
    }
    #downloadExcel:hover {
        background-color: #1abc9c;
    }
    .status { font-size: 0.85em; margin-left: 8px; color: #27ae60; }
    .error-status { color: #e74c3c; }
    .highlight { background-color: #ffeb3b !important; }
    .no-data { text-align: center; padding: 20px; color: #7f8c8d; font-style: italic; }
    .refresh-btn { background-color: #2ecc71; }
    .refresh-btn:hover { background-color: #27ae60; }
    .refresh-icon { margin-right: 5px; }
    .fixed-column { position: sticky; left: 0; z-index: 5; background-color: white; }
    th.fixed-column { z-index: 30; background-color: #3498db; }
    #filterRow th.fixed-column { z-index: 40; background-color: #f2f6fa; }
    .date-input { border: none; background: transparent; width: 100%; font-family: inherit; font-size: inherit; user-select: text; }
    .note-highlight { background-color: #fff2a8; }
    .status-ok { background-color: #d4edda; color: #155724; font-weight: bold; }
    .status-cancel { background-color: #f8d7da; color: #721c24; font-weight: bold; }
    td.cell-selected { background-color: rgba(52, 152, 219, 0.4) !important; outline: 1px solid #3498db; outline-offset: -1px; }
  </style>
</head>
<body>
  <h2>QUẢN LÝ ĐƠN HÀNG BEE</h2>

  <!-- BỘ LỌC CHÍNH -->
  <div id="mainFilters" class="main-filters">
    <div class="filter-group">
        <label for="filterMarket">Thị trường</label>
        <select id="filterMarket">
            <option value="">Tất cả</option>
        </select>
    </div>
    <div class="filter-group">
        <label for="filterProduct">Sản phẩm</label>
        <select id="filterProduct">
            <option value="">Tất cả</option>
        </select>
    </div>
    <div class="filter-group">
        <label for="filterDateFrom">Từ ngày</label>
        <input type="date" id="filterDateFrom">
    </div>
    <div class="filter-group">
        <label for="filterDateTo">Tới ngày</label>
        <input type="date" id="filterDateTo">
    </div>
  </div>

  <div id="tabContainer" class="tab-container">
    <!-- Các tab theo Khu vực sẽ được tạo ở đây -->
  </div>
  
  <div class="controls">
    <div>
      <button id="refreshData" class="refresh-btn">
        <span class="refresh-icon">↻</span> Load dữ liệu
      </button>
      <button id="updateAll">Cập nhật tất cả thay đổi</button>
      <!-- NÚT TẢI EXCEL MỚI -->
      <button id="downloadExcel">Tải Excel</button>
    </div>
    <div>
      <button id="toggleTrackingView" class="tab-btn tracking-tab">Xem đơn có mã Tracking</button>
    </div>
  </div>
  
  <div class="table-wrapper" id="tableContainer">
    <table>
      <thead>
        <tr id="filterRow"></tr>
        <tr>
          <th class="fixed-column">Mã đơn hàng</th>
          <th>Ngày lên đơn</th>
          <th>Name*</th>
          <th>Phone*</th>
          <th>Add</th>
          <th>City</th>
          <th>State</th>
          <th>Khu vực</th>
          <th>Zipcode</th>
          <th>Mặt hàng</th>
          <th>Tên mặt hàng 1</th>
          <th>Số lượng mặt hàng 1</th>
          <th>Tên mặt hàng 2</th>
          <th>Số lượng mặt hàng 2</th>
          <th>Quà tặng</th>
          <th>Số lượng quà kèm</th>
          <th>Giá bán</th>
          <th>Loại tiền thanh toán</th>
          <th>Tổng tiền VNĐ</th>
          <th>Hình thức thanh toán</th>
          <th>Ghi chú</th>
          <th>Ghi chú vận đơn</th>
          <th>Kết quả check</th>
          <th>Mã Tracking</th>
          <th>Ngày đóng hàng</th>
          <th>Trạng thái giao hàng</th>
          <th>Thời gian giao dự kiến</th>
          <th>Phí ship nội địa Mỹ (usd)</th>
          <th>Phí xử lý đơn đóng hàng-Lưu kho(usd)</th>
          <th>GHI CHÚ</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <script>
    const POST_URL = 'https://script.google.com/macros/s/AKfycbzNeQSd_fUNicLT8VyVg90Di9NpAZxCagmBLFboJZ5I64qjqHBHM7uOZalO11mJdAxN/exec';
    
    const displayColumns = ["Mã đơn hàng", "Ngày lên đơn", "Name*", "Phone*", "Add", "City", "State", "Khu vực", "Zipcode", "Mặt hàng", "Tên mặt hàng 1", "Số lượng mặt hàng 1", "Tên mặt hàng 2", "Số lượng mặt hàng 2", "Quà tặng", "Số lượng quà kèm", "Giá bán", "Loại tiền thanh toán", "Tổng tiền VNĐ", "Hình thức thanh toán", "Ghi chú", "Ghi chú vận đơn", "Kết quả check", "Mã Tracking", "Ngày đóng hàng", "Trạng thái giao hàng", "Thời gian giao dự kiến", "Phí ship nội địa Mỹ (usd)", "Phí xử lý đơn đóng hàng-Lưu kho(usd)", "GHI CHÚ"];
    
    // *** THAY ĐỔI: Sửa lại mapping cho đúng. Vui lòng kiểm tra tên cột chính xác trong Google Sheet.
    // Tôi đoán tên cột là "Kết quả check đặt trước", nếu sai, bạn hãy sửa lại ở đây.
    const columnMapping = {
      "Ghi chú vận đơn": "ngày hẹn đẩy đơn",
      "Kết quả check": "Kết quả check đặt trước" 
    };

    const editableCols = ["Mã Tracking", "Ngày đóng hàng", "Trạng thái giao hàng", "Thời gian giao dự kiến", "Phí ship nội địa Mỹ (usd)", "Phí xử lý đơn đóng hàng-Lưu kho(usd)", "GHI CHÚ"];
    
    let allData = [], initialFilteredData = [], filteredData = [];
    let changedRows = new Set(), activeRegion = 'all', filterValues = {}, showTrackingOrders = false;

    // --- CÁC HÀM UTILITY ---
    function formatDate(dateString) { if (!dateString) return ''; try { const date = new Date(dateString.includes('Z') ? dateString : dateString + 'Z'); if (isNaN(date.getTime())) return dateString; const day = String(date.getDate()).padStart(2, '0'); const month = String(date.getMonth() + 1).padStart(2, '0'); const year = date.getFullYear(); return `${day}/${month}/${year}`; } catch (e) { return dateString; } }
    function parseDateToISO(dateString) { if (!dateString) return ''; const parts = dateString.split('/'); if (parts.length !== 3) return dateString; try { const day = parseInt(parts[0], 10); const month = parseInt(parts[1], 10) - 1; const year = parseInt(parts[2], 10); const date = new Date(Date.UTC(year, month, day)); if (isNaN(date.getTime())) return dateString; return date.toISOString(); } catch (e) { return dateString; } }

    // --- XỬ LÝ DỮ LIỆU VÀ BỘ LỌC ---
    function handleData(response) {
      document.getElementById('refreshData').innerHTML = '<span class="refresh-icon">↻</span> Load dữ liệu';
      allData = []; changedRows = new Set();
      if (response.error) { document.getElementById('tableBody').innerHTML = `<tr><td colspan="${displayColumns.length}" class="error-status">Lỗi: ${response.error}</td></tr>`; return; }
      const data = response.rows || response.data || response;
      if (!Array.isArray(data) || data.length === 0) { document.getElementById('tableBody').innerHTML = `<tr><td colspan="${displayColumns.length}" class="no-data">Không có dữ liệu</td></tr>`; return; }
      allData = data;
      filterInitialData();
      createTabs(initialFilteredData);
      populateMainFilters(initialFilteredData); // *** MỚI: Populate bộ lọc chính
      setupColumnFilters();
      applyAllFilters();
    }
    
    function filterInitialData() {
        initialFilteredData = allData.filter(row => {
            const carrier = row["Đơn vị vận chuyển"] || row["Đơn_vị_vận_chuyển"];
            const trackingCode = row["Mã Tracking"] || row["Mã_Tracking"] || '';
            if (showTrackingOrders) { return carrier?.toString().toUpperCase() === "BEE" && trackingCode?.trim() !== ''; } 
            else { return carrier?.toString().toUpperCase() === "BEE" && !trackingCode?.trim(); }
        });
    }

    function populateMainFilters(data) {
        const marketFilter = document.getElementById('filterMarket');
        const productFilter = document.getElementById('filterProduct');
        
        const markets = [...new Set(data.map(row => row["Khu vực"]).filter(Boolean))].sort();
        const products = [...new Set(data.map(row => row["Mặt hàng"]).filter(Boolean))].sort();

        marketFilter.innerHTML = '<option value="">Tất cả Thị trường</option>';
        productFilter.innerHTML = '<option value="">Tất cả Sản phẩm</option>';

        markets.forEach(market => {
            marketFilter.innerHTML += `<option value="${market}">${market}</option>`;
        });
        products.forEach(product => {
            productFilter.innerHTML += `<option value="${product}">${product}</option>`;
        });
    }

    function applyAllFilters() {
        let dataToRender = [...initialFilteredData];

        // 1. Áp dụng bộ lọc chính
        const market = document.getElementById('filterMarket').value;
        const product = document.getElementById('filterProduct').value;
        const dateFrom = document.getElementById('filterDateFrom').value;
        const dateTo = document.getElementById('filterDateTo').value;

        if (market) { dataToRender = dataToRender.filter(row => row["Khu vực"] === market); }
        if (product) { dataToRender = dataToRender.filter(row => row["Mặt hàng"] === product); }
        if (dateFrom) {
            const from = new Date(dateFrom);
            from.setHours(0, 0, 0, 0);
            dataToRender = dataToRender.filter(row => row["Ngày lên đơn"] && new Date(row["Ngày lên đơn"]) >= from);
        }
        if (dateTo) {
            const to = new Date(dateTo);
            to.setHours(23, 59, 59, 999);
            dataToRender = dataToRender.filter(row => row["Ngày lên đơn"] && new Date(row["Ngày lên đơn"]) <= to);
        }

        // 2. Áp dụng bộ lọc tab khu vực
        if (activeRegion !== 'all') { dataToRender = dataToRender.filter(row => row["Khu vực"] === activeRegion); }

        // 3. Áp dụng bộ lọc theo cột
        const activeFilters = Object.entries(filterValues).filter(([_, val]) => val.trim() !== '');
        if (activeFilters.length > 0) {
            dataToRender = dataToRender.filter(row => {
                return activeFilters.every(([col, filterValue]) => {
                    const dataKey = columnMapping[col] || col;
                    const cellValue = row[dataKey] ?? row[dataKey.replace(/ /g, '_')] ?? '';
                    return String(cellValue).toLowerCase().includes(filterValue.toLowerCase());
                });
            });
        }
        
        filteredData = dataToRender;
        renderTable(filteredData);
    }
    
    // --- RENDER GIAO DIỆN ---
    function renderTable(data) {
        const container = document.getElementById('tableBody');
        container.innerHTML = '';
        if (data.length === 0) { container.innerHTML = `<tr><td colspan="${displayColumns.length}" class="no-data">Không có dữ liệu phù hợp</td></tr>`; return; }

        data.forEach((row, rowIndex) => {
            const tr = document.createElement('tr');
            displayColumns.forEach(col => {
                const td = document.createElement('td');
                const dataKey = columnMapping[col] || col;
                // *** THAY ĐỔI: Ưu tiên tìm key đã map, sau đó là key gốc, cuối cùng là key với dấu gạch dưới
                let value = row[dataKey] ?? row[col] ?? row[col.replace(/ /g, '_')] ?? '';
                
                if (["Ngày lên đơn", "Ngày đóng hàng"].includes(col)) { value = formatDate(value); }
                td.textContent = value;
                
                if (col === "Mã đơn hàng") td.classList.add('fixed-column');
                if (col === "Ghi chú vận đơn" && value) { td.classList.add('note-highlight'); }
                if (col === "Kết quả check") {
                    const checkValue = String(value).trim().toUpperCase();
                    if (checkValue === 'OK') td.classList.add('status-ok');
                    else if (checkValue.includes('HỦY')) td.classList.add('status-cancel');
                }

                if (editableCols.includes(col)) {
                    if (col === "Ngày đóng hàng") { const input = document.createElement('input'); input.type = 'text'; input.className = 'date-input'; input.value = value; input.placeholder = 'dd/mm/yyyy'; input.addEventListener('input', () => { td.classList.add('highlight'); changedRows.add(rowIndex); }); input.addEventListener('blur', () => { if (!/^\d{2}\/\d{2}\/\d{4}$/.test(input.value) && input.value !== '') { alert('Vui lòng nhập ngày theo định dạng dd/mm/yyyy'); input.focus(); } }); td.innerHTML = ''; td.appendChild(input); } else { td.contentEditable = 'true'; }
                    td.classList.add('editable');
                    td.addEventListener('input', () => { if (col !== "Ngày đóng hàng") { td.classList.add('highlight'); changedRows.add(rowIndex); } });
                }
                tr.appendChild(td);
            });
            container.appendChild(tr);
        });
        setupPasteHandler();
        setupMultiSelectAndCopy();
    }

    function createTabs(data) { const tabContainer = document.getElementById('tabContainer'); tabContainer.innerHTML = ''; const regions = [...new Set(data.map(row => row["Khu vực"]).filter(Boolean))].sort(); const createTab = (name, value) => { const button = document.createElement('button'); button.className = 'tab-btn'; button.textContent = name; button.dataset.region = value; if (value === activeRegion) { button.classList.add('active'); } button.addEventListener('click', () => { activeRegion = value; document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active')); button.classList.add('active'); applyAllFilters(); }); return button; }; tabContainer.appendChild(createTab('Tất cả', 'all')); regions.forEach(region => tabContainer.appendChild(createTab(region, region))); }
    function setupColumnFilters() { const filterRow = document.getElementById('filterRow'); filterRow.innerHTML = ''; filterValues = {}; displayColumns.forEach((col, index) => { const th = document.createElement('th'); if (index === 0) { th.classList.add('fixed-column'); } const input = document.createElement('input'); input.type = 'text'; input.className = 'filter-input'; input.placeholder = `Lọc ${col}`; input.dataset.column = col; input.addEventListener('input', () => { filterValues[col] = input.value; applyAllFilters(); }); th.appendChild(input); filterRow.appendChild(th); }); }
    
    // --- CÁC HÀM ĐIỀU KHIỂN ---
    function setupControls() {
        document.getElementById('refreshData').addEventListener('click', refreshData);
        document.getElementById('updateAll').addEventListener('click', updateAllChangedRows);
        document.getElementById('toggleTrackingView').addEventListener('click', toggleTrackingView);
        // *** MỚI: Gắn sự kiện cho bộ lọc chính
        document.getElementById('filterMarket').addEventListener('change', applyAllFilters);
        document.getElementById('filterProduct').addEventListener('change', applyAllFilters);
        document.getElementById('filterDateFrom').addEventListener('change', applyAllFilters);
        document.getElementById('filterDateTo').addEventListener('change', applyAllFilters);
        document.getElementById('downloadExcel').addEventListener('click', downloadAsExcel);
    }
    
    function refreshData() { const btn = document.getElementById('refreshData'); btn.innerHTML = '<span class="loading"></span> Đang tải...'; activeRegion = 'all'; filterValues = {}; document.getElementById('tabContainer').innerHTML = ''; document.getElementById('filterRow').innerHTML = ''; document.getElementById('mainFilters').querySelectorAll('input, select').forEach(el => el.value = ''); loadData(); }
    function toggleTrackingView() { const btn = document.getElementById('toggleTrackingView'); showTrackingOrders = !showTrackingOrders; if (showTrackingOrders) { btn.textContent = 'Xem đơn chưa có mã Tracking'; btn.classList.add('active'); } else { btn.textContent = 'Xem đơn có mã Tracking'; btn.classList.remove('active'); } activeRegion = 'all'; filterValues = {}; filterInitialData(); createTabs(initialFilteredData); populateMainFilters(initialFilteredData); setupColumnFilters(); applyAllFilters(); }
    function loadData() { const container = document.getElementById('tableBody'); container.innerHTML = `<tr><td colspan="${displayColumns.length}" style="text-align: center;">Đang tải...</td></tr>`; const script = document.createElement('script'); script.src = 'https://script.google.com/macros/s/AKfycbwEd7eA6NAUMtbEpcEPJQWeX-zsJRE1mnTVVBD23NoKrnXYwOLvuNef2mIbJ7-NMNbe/exec?callback=handleData&rand=' + Math.random(); const oldScript = document.querySelector('script[src^="https://script.google.com"]'); if (oldScript) document.body.removeChild(oldScript); document.body.appendChild(script); }

    // --- CẬP NHẬT, DÁN, CHỌN, SAO CHÉP DỮ LIỆU ---
    // (Các hàm updateAllChangedRows, sendRows, setupPasteHandler, setupMultiSelectAndCopy không đổi, để ngắn gọn tôi sẽ ẩn đi)
    function updateAllChangedRows() { if(changedRows.size===0){alert('Không có thay đổi');return} const statusEl=document.createElement('span');statusEl.className='status';document.getElementById('updateAll').appendChild(statusEl);sendRows(Array.from(changedRows),statusEl)}
    function sendRows(rowIndexes,statusEl){statusEl.innerHTML='<span class="loading"></span> Đang gửi...';const rowsToSend=[];const tableBody=document.querySelector('tbody');rowIndexes.forEach(rowIndex=>{const originalRowData=filteredData[rowIndex];if(!originalRowData)return;const domRow=tableBody.rows[rowIndex];if(!domRow)return;const updatedRowData={...originalRowData};displayColumns.forEach((col,colIndex)=>{if(editableCols.includes(col)){const cell=domRow.cells[colIndex];let value;if(col==="Ngày đóng hàng"&&cell.querySelector('input')){value=cell.querySelector('input').value.trim();value=parseDateToISO(value)}else{value=cell.textContent.trim()}updatedRowData[col]=value}});rowsToSend.push(updatedRowData);Array.from(domRow.cells).forEach(cell=>{if(cell.classList.contains('highlight')){cell.classList.remove('highlight')}})});fetch(POST_URL,{method:'POST',mode:'cors',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:new URLSearchParams({rows:JSON.stringify(rowsToSend)})}).then(r=>r.json()).then(json=>{if(json.message){statusEl.textContent=`Thành công: ${json.message}`;changedRows.clear()}else{statusEl.textContent=json.error||'Lỗi';statusEl.classList.add('error-status')}setTimeout(()=>{statusEl.remove()},4000)}).catch(e=>{statusEl.textContent='Lỗi: '+e.message;statusEl.classList.add('error-status');setTimeout(()=>{statusEl.remove()},4000)})}
    function setupPasteHandler(){document.addEventListener('paste',e=>{const activeElement=document.activeElement;const isEditableCell=activeElement.classList.contains('editable')||(activeElement.tagName==='INPUT'&&activeElement.parentElement.classList.contains('editable'));if(!isEditableCell)return;e.preventDefault();const pasteData=e.clipboardData.getData('text/plain');if(!pasteData)return;const rows=pasteData.split('\n').map(row=>row.split('\t'));const tableBody=document.querySelector('tbody');if(!tableBody)return;let startRow=Array.from(tableBody.rows).findIndex(row=>Array.from(row.cells).some(cell=>cell===activeElement||cell.contains(activeElement)));let startCol=-1;if(startRow>=0){const cells=Array.from(tableBody.rows[startRow].cells);startCol=cells.findIndex(cell=>cell===activeElement||cell.contains(activeElement))}if(startRow<0||startCol<0)return;for(let i=0;i<rows.length;i++){const rowIndex=startRow+i;if(rowIndex>=tableBody.rows.length)break;const rowData=rows[i];for(let j=0;j<rowData.length;j++){const colIndex=startCol+j;if(colIndex>=tableBody.rows[rowIndex].cells.length)break;const cell=tableBody.rows[rowIndex].cells[colIndex];if(cell.classList.contains('editable')){if(displayColumns[colIndex]==="Ngày đóng hàng"&&cell.querySelector('input')){cell.querySelector('input').value=rowData[j]}else{cell.textContent=rowData[j]}cell.classList.add('highlight');changedRows.add(rowIndex)}}}})}
    function setupMultiSelectAndCopy(){const tableBody=document.getElementById('tableBody');if(!tableBody)return;let isSelecting=!1,startCell=null,lastClickedCell=null;const clearSelection=()=>{document.querySelectorAll('td.cell-selected').forEach(cell=>{cell.classList.remove('cell-selected')})};const selectCells=(start,end)=>{clearSelection();const minRow=Math.min(start.rowIndex,end.rowIndex);const maxRow=Math.max(start.rowIndex,end.rowIndex);const minCol=Math.min(start.cellIndex,end.cellIndex);const maxCol=Math.max(start.cellIndex,end.cellIndex);for(let i=minRow;i<=maxRow;i++){for(let j=minCol;j<=maxCol;j++){const cell=tableBody.rows[i]?.cells[j];if(cell){cell.classList.add('cell-selected')}}}};tableBody.addEventListener('mousedown',e=>{if(e.button!==0||e.target.isContentEditable||e.target.tagName==='INPUT'){return}const cell=e.target.closest('td');if(!cell)return;e.preventDefault();if(e.shiftKey&&lastClickedCell){selectCells(lastClickedCell,cell)}else{isSelecting=!0;clearSelection();startCell=cell;lastClickedCell=cell;cell.classList.add('cell-selected')}});tableBody.addEventListener('mousemove',e=>{if(!isSelecting||!startCell)return;const cell=e.target.closest('td');if(cell){selectCells(startCell,cell)}});document.addEventListener('mouseup',()=>{isSelecting=!1});document.addEventListener('copy',e=>{const selectedCells=document.querySelectorAll('td.cell-selected');if(selectedCells.length===0){return}e.preventDefault();const rows=new Map();selectedCells.forEach(cell=>{const rowIndex=cell.parentElement.rowIndex;if(!rows.has(rowIndex)){rows.set(rowIndex,[])}const input=cell.querySelector('input');const text=input?input.value:cell.textContent;rows.get(rowIndex).push({colIndex:cell.cellIndex,text:text})});const sortedRows=[...rows.entries()].sort((a,b)=>a[0]-b[0]);const copyText=sortedRows.map(([rowIndex,cells])=>{return cells.sort((a,b)=>a.colIndex-b.colIndex).map(cell=>cell.text).join('\t')}).join('\n');e.clipboardData.setData('text/plain',copyText)})}
    
    // --- HÀM MỚI: TẢI FILE EXCEL (CSV) ---
    function downloadAsExcel() {
        if (filteredData.length === 0) {
            alert("Không có dữ liệu để tải về.");
            return;
        }

        const sanitizeCsvCell = (cell) => {
            if (cell === null || cell === undefined) return '';
            let str = String(cell);
            // Nếu cell chứa dấu phẩy, dấu nháy kép hoặc ký tự xuống dòng, bao nó trong dấu nháy kép
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                // Thay thế mọi dấu nháy kép bên trong bằng hai dấu nháy kép
                str = str.replace(/"/g, '""');
                return `"${str}"`;
            }
            return str;
        };

        const headers = displayColumns.map(sanitizeCsvCell).join(',');

        const rows = filteredData.map(row => {
            return displayColumns.map(col => {
                const dataKey = columnMapping[col] || col;
                let value = row[dataKey] ?? row[col] ?? row[col.replace(/ /g, '_')] ?? '';
                if (["Ngày lên đơn", "Ngày đóng hàng"].includes(col)) {
                    value = formatDate(value); // Đảm bảo ngày có định dạng dd/mm/yyyy
                }
                return sanitizeCsvCell(value);
            }).join(',');
        }).join('\n');

        // BOM (Byte Order Mark) để Excel mở file UTF-8 đúng cách (hiển thị tiếng Việt)
        const BOM = '\uFEFF';
        const csvContent = BOM + headers + '\n' + rows;

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            const today = new Date();
            const dateStr = `${today.getFullYear()}${(today.getMonth()+1).toString().padStart(2,'0')}${today.getDate().toString().padStart(2,'0')}`;
            link.setAttribute("href", url);
            link.setAttribute("download", `BaoCaoDonHang_${dateStr}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    }

    // --- KHỞI TẠO ---
    setupControls();
  </script>

  <script src="https://script.google.com/macros/s/AKfycbwEd7eA6NAUMtbEpcEPJQWeX-zsJRE1mnTVVBD23NoKrnXYwOLvuNef2mIbJ7-NMNbe/exec?callback=handleData"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Quản lý đơn hàng BEE</title>
  <style>
    :root {
      --filter-row-height: 38px; /* Chiều cao của hàng bộ lọc */
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      background-color: #f5f5f5;
      color: #333;
      margin: 0;
      /* Ngăn chặn việc chọn văn bản mặc định của trình duyệt khi kéo chuột */
      user-select: none; 
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #2c3e50;
    }
    .tab-container {
      margin-bottom: 15px;
      padding: 5px;
      background: #fff;
      border-radius: 5px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .tab-btn {
      padding: 8px 15px;
      cursor: pointer;
      background-color: #ecf0f1;
      color: #2c3e50;
      border: 1px solid #bdc3c7;
      border-radius: 4px;
      font-size: 14px;
      transition: all 0.3s;
    }
    .tab-btn:hover {
      background-color: #dfe6e9;
    }
    .tab-btn.active {
      background-color: #3498db;
      color: white;
      border-color: #2980b9;
      font-weight: bold;
    }
    .tab-btn.tracking-tab {
      background-color: #e74c3c;
      color: white;
    }
    .tab-btn.tracking-tab.active {
      background-color: #c0392b;
    }
    .controls {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      align-items: center;
      background: #fff;
      padding: 10px 15px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .table-wrapper {
      position: relative;
      overflow: auto;
      max-height: 70vh;
      background: white;
      border-radius: 0 0 5px 5px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 1800px; /* Tăng chiều rộng tối thiểu để chứa cột mới */
      font-size: 14px;
    }
    thead {
      position: sticky;
      top: 0;
      z-index: 10;
    }
    th, td {
      border: 1px solid #e0e0e0;
      padding: 8px 12px;
      text-align: left;
      white-space: nowrap;
      background-color: white;
    }
    th {
      background-color: #3498db;
      color: white;
      position: sticky;
      top: var(--filter-row-height); /* Dính bên dưới hàng bộ lọc */
      z-index: 20;
      font-weight: 500;
    }
    #filterRow th {
        top: 0; /* Hàng bộ lọc dính trên cùng */
        background-color: #f2f6fa;
        padding: 4px 8px;
    }
    .filter-input {
      width: 100%;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 3px;
      font-size: 13px;
    }
    td.editable {
      background-color: #fffbe8;
      /* Cho phép chọn văn bản trong ô có thể chỉnh sửa */
      user-select: text; 
    }
    button {
      padding: 6px 12px;
      cursor: pointer;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 13px;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #2980b9;
    }
    .status {
      font-size: 0.85em;
      margin-left: 8px;
      color: #27ae60;
    }
    .error-status {
      color: #e74c3c;
    }
    .highlight {
      background-color: #ffeb3b !important; /* Dùng !important để ghi đè các style khác */
    }
    .no-data {
      text-align: center;
      padding: 20px;
      color: #7f8c8d;
      font-style: italic;
    }
    .refresh-btn {
      background-color: #2ecc71;
    }
    .refresh-btn:hover {
      background-color: #27ae60;
    }
    .refresh-icon {
      margin-right: 5px;
    }
    .fixed-column {
      position: sticky;
      left: 0;
      z-index: 5;
      background-color: white;
    }
    th.fixed-column {
      z-index: 30;
      background-color: #3498db;
    }
    #filterRow th.fixed-column {
        z-index: 40; /* Phải cao hơn các th khác */
        background-color: #f2f6fa;
    }
    .date-input {
      border: none;
      background: transparent;
      width: 100%;
      font-family: inherit;
      font-size: inherit;
      user-select: text; /* Cho phép chọn văn bản trong input */
    }
    .note-highlight {
        background-color: #fff2a8; /* Màu vàng nhạt cho ghi chú */
    }
    .status-ok {
        background-color: #d4edda; /* Màu xanh lá nhạt */
        color: #155724;
        font-weight: bold;
    }
    .status-cancel {
        background-color: #f8d7da; /* Màu đỏ nhạt */
        color: #721c24;
        font-weight: bold;
    }

    /* --- CSS MỚI CHO TÍNH NĂNG CHỌN NHIỀU Ô --- */
    td.cell-selected {
      background-color: rgba(52, 152, 219, 0.4) !important;
      outline: 1px solid #3498db;
      outline-offset: -1px;
    }
  </style>
</head>
<body>
  <h2>QUẢN LÝ ĐƠN HÀNG BEE</h2>

  <div id="tabContainer" class="tab-container">
    <!-- Các tab theo Khu vực sẽ được tạo ở đây -->
  </div>
  
  <div class="controls">
    <div>
      <button id="refreshData" class="refresh-btn">
        <span class="refresh-icon">↻</span> Load dữ liệu
      </button>
      <button id="updateAll">Cập nhật tất cả thay đổi</button>
    </div>
    <div>
      <button id="toggleTrackingView" class="tab-btn tracking-tab">Xem đơn có mã Tracking</button>
    </div>
  </div>
  
  <div class="table-wrapper" id="tableContainer">
    <table>
      <thead>
        <tr id="filterRow">
            <!-- Các ô lọc sẽ được tạo ở đây -->
        </tr>
        <tr>
          <th class="fixed-column">Mã đơn hàng</th>
          <th>Ngày lên đơn</th>
          <th>Name*</th>
          <th>Phone*</th>
          <th>Add</th>
          <th>City</th>
          <th>State</th>
          <th>Khu vực</th>
          <th>Zipcode</th>
          <th>Mặt hàng</th>
          <th>Tên mặt hàng 1</th>
          <th>Số lượng mặt hàng 1</th>
          <th>Tên mặt hàng 2</th>
          <th>Số lượng mặt hàng 2</th>
          <th>Quà tặng</th>
          <th>Số lượng quà kèm</th>
          <th>Giá bán</th>
          <th>Loại tiền thanh toán</th>
          <th>Tổng tiền VNĐ</th>
          <th>Hình thức thanh toán</th>
          <th>Ghi chú</th>
          <th>Ghi chú vận đơn</th>
          <th>Kết quả check</th>
          <th>Mã Tracking</th>
          <th>Ngày đóng hàng</th>
          <th>Trạng thái giao hàng</th>
          <th>Thời gian giao dự kiến</th>
          <th>Phí ship nội địa Mỹ (usd)</th>
          <th>Phí xử lý đơn đóng hàng-Lưu kho(usd)</th>
          <th>GHI CHÚ</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        <!-- Dữ liệu sẽ được thêm vào đây -->
      </tbody>
    </table>
  </div>

  <script>
    const POST_URL = 'https://script.google.com/macros/s/AKfycbzNeQSd_fUNicLT8VyVg90Di9NpAZxCagmBLFboJZ5I64qjqHBHM7uOZalO11mJdAxN/exec';
    
    const displayColumns = [
      "Mã đơn hàng", "Ngày lên đơn", "Name*", "Phone*", "Add", "City", "State", "Khu vực", "Zipcode", 
      "Mặt hàng", "Tên mặt hàng 1", "Số lượng mặt hàng 1", "Tên mặt hàng 2", "Số lượng mặt hàng 2", 
      "Quà tặng", "Số lượng quà kèm", "Giá bán", "Loại tiền thanh toán", "Tổng tiền VNĐ", 
      "Hình thức thanh toán", "Ghi chú", "Ghi chú vận đơn", "Kết quả check", "Mã Tracking", "Ngày đóng hàng", "Trạng thái giao hàng", 
      "Thời gian giao dự kiến", "Phí ship nội địa Mỹ (usd)", "Phí xử lý đơn đóng hàng-Lưu kho(usd)", "GHI CHÚ"
    ];
    
    const columnMapping = {
      "Ghi chú vận đơn": "ngày hẹn đẩy đơn",
      "Kết quả check": "Kết quả check"
    };

    const editableCols = [
      "Mã Tracking", "Ngày đóng hàng", "Trạng thái giao hàng", 
      "Thời gian giao dự kiến", "Phí ship nội địa Mỹ (usd)", 
      "Phí xử lý đơn đóng hàng-Lưu kho(usd)", "GHI CHÚ"
    ];
    
    let allData = [];
    let initialFilteredData = []; 
    let filteredData = []; 
    let changedRows = new Set();
    let activeRegion = 'all';
    let filterValues = {}; 
    let showTrackingOrders = false;

    // Các hàm utility (formatDate, parseDateToISO)
    function formatDate(dateString) { if (!dateString) return ''; try { const date = new Date(dateString.includes('Z') ? dateString : dateString + 'Z'); if (isNaN(date.getTime())) return dateString; const day = String(date.getDate()).padStart(2, '0'); const month = String(date.getMonth() + 1).padStart(2, '0'); const year = date.getFullYear(); return `${day}/${month}/${year}`; } catch (e) { return dateString; } }
    function parseDateToISO(dateString) { if (!dateString) return ''; const parts = dateString.split('/'); if (parts.length !== 3) return dateString; try { const day = parseInt(parts[0], 10); const month = parseInt(parts[1], 10) - 1; const year = parseInt(parts[2], 10); const date = new Date(year, month, day); if (isNaN(date.getTime())) return dateString; return date.toISOString(); } catch (e) { return dateString; } }
    
    // Xử lý dữ liệu và các bộ lọc
    function handleData(response) { document.getElementById('refreshData').innerHTML = '<span class="refresh-icon">↻</span> Load dữ liệu'; allData = []; changedRows = new Set(); if (response.error) { document.getElementById('tableBody').innerHTML = `<tr><td colspan="${displayColumns.length}" class="error-status">Lỗi: ${response.error}</td></tr>`; return; } const data = response.rows || response.data || response; if (!Array.isArray(data) || data.length === 0) { document.getElementById('tableBody').innerHTML = `<tr><td colspan="${displayColumns.length}" class="no-data">Không có dữ liệu đơn hàng nào</td></tr>`; return; } allData = data; filterInitialData(); createTabs(initialFilteredData); setupColumnFilters(); applyAllFilters(); }
    function filterInitialData() { initialFilteredData = allData.filter(row => { const carrier = row["Đơn vị vận chuyển"] || row["Đơn_vị_vận_chuyển"]; const trackingCode = row["Mã Tracking"] || row["Mã_Tracking"] || ''; if (showTrackingOrders) { return carrier && carrier.toString().toUpperCase() === "BEE" && trackingCode && trackingCode.toString().trim() !== ''; } else { return carrier && carrier.toString().toUpperCase() === "BEE" && (!trackingCode || trackingCode.toString().trim() === ''); } }); }
    function createTabs(data) { const tabContainer = document.getElementById('tabContainer'); tabContainer.innerHTML = ''; const regions = [...new Set(data.map(row => row["Khu vực"]).filter(Boolean))].sort(); const createTab = (name, value) => { const button = document.createElement('button'); button.className = 'tab-btn'; button.textContent = name; button.dataset.region = value; if (value === activeRegion) { button.classList.add('active'); } button.addEventListener('click', () => { activeRegion = value; document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active')); button.classList.add('active'); applyAllFilters(); }); return button; }; tabContainer.appendChild(createTab('Tất cả', 'all')); regions.forEach(region => tabContainer.appendChild(createTab(region, region))); }
    function setupColumnFilters() { const filterRow = document.getElementById('filterRow'); filterRow.innerHTML = ''; filterValues = {}; displayColumns.forEach((col, index) => { const th = document.createElement('th'); if (index === 0) { th.classList.add('fixed-column'); } const input = document.createElement('input'); input.type = 'text'; input.className = 'filter-input'; input.placeholder = `Lọc ${col}`; input.dataset.column = col; input.addEventListener('input', () => { filterValues[col] = input.value; applyAllFilters(); }); th.appendChild(input); filterRow.appendChild(th); }); }
    function applyAllFilters() { let dataToRender = [...initialFilteredData]; if (activeRegion !== 'all') { dataToRender = dataToRender.filter(row => row["Khu vực"] === activeRegion); } const activeFilters = Object.entries(filterValues).filter(([col, val]) => val.trim() !== ''); if (activeFilters.length > 0) { dataToRender = dataToRender.filter(row => { return activeFilters.every(([col, filterValue]) => { const dataKey = columnMapping[col] || col; const cellValue = row[dataKey] !== undefined ? row[dataKey] : row[dataKey.replace(/ /g, '_')] !== undefined ? row[dataKey.replace(/ /g, '_')] : ''; return String(cellValue).toLowerCase().includes(filterValue.toLowerCase()); }); }); } filteredData = dataToRender; renderTable(filteredData); }

    function renderTable(data) {
      const container = document.getElementById('tableBody');
      container.innerHTML = '';

      if (data.length === 0) {
        container.innerHTML = `<tr><td colspan="${displayColumns.length}" class="no-data">Không có dữ liệu phù hợp với bộ lọc</td></tr>`;
        return;
      }

      data.forEach((row, rowIndex) => {
        const tr = document.createElement('tr');
        displayColumns.forEach(col => {
          const td = document.createElement('td');
          const dataKey = columnMapping[col] || col;
          let value = row[dataKey] !== undefined ? row[dataKey] : row[dataKey.replace(/ /g, '_')] !== undefined ? row[dataKey.replace(/ /g, '_')] : '';
          
          if (col === "Ngày lên đơn" || col === "Ngày đóng hàng") { value = formatDate(value); }
          td.textContent = value !== null && value !== undefined ? value : '';
          
          if (col === "Mã đơn hàng") td.classList.add('fixed-column');
          if (col === "Ghi chú vận đơn" && value) { td.classList.add('note-highlight'); }
          if (col === "Kết quả check") { const checkValue = String(value).trim().toUpperCase(); if (checkValue === 'OK') { td.classList.add('status-ok'); } else if (checkValue === 'HỦY') { td.classList.add('status-cancel'); } }

          if (editableCols.includes(col)) {
            if (col === "Ngày đóng hàng") { const input = document.createElement('input'); input.type = 'text'; input.className = 'date-input'; input.value = value; input.placeholder = 'dd/mm/yyyy'; input.addEventListener('input', () => { td.classList.add('highlight'); changedRows.add(rowIndex); }); input.addEventListener('blur', () => { if (!/^\d{2}\/\d{2}\/\d{4}$/.test(input.value) && input.value !== '') { alert('Vui lòng nhập ngày theo định dạng dd/mm/yyyy'); input.focus(); } }); td.innerHTML = ''; td.appendChild(input); } else { td.contentEditable = 'true'; }
            td.classList.add('editable');
            td.addEventListener('input', () => { if (col !== "Ngày đóng hàng") { td.classList.add('highlight'); changedRows.add(rowIndex); } });
          }
          tr.appendChild(td);
        });
        container.appendChild(tr);
      });
      setupPasteHandler();
      // *** THAY ĐỔI: Gọi hàm thiết lập chọn nhiều ô sau khi render bảng
      setupMultiSelectAndCopy();
    }

    // Các hàm điều khiển và tải dữ liệu
    function setupControls() { document.getElementById('refreshData').addEventListener('click', refreshData); document.getElementById('updateAll').addEventListener('click', updateAllChangedRows); document.getElementById('toggleTrackingView').addEventListener('click', toggleTrackingView); }
    function refreshData() { const btn = document.getElementById('refreshData'); btn.innerHTML = '<span class="loading"></span> Đang tải...'; activeRegion = 'all'; filterValues = {}; document.getElementById('tabContainer').innerHTML = ''; document.getElementById('filterRow').innerHTML = ''; loadData(); }
    function toggleTrackingView() { const btn = document.getElementById('toggleTrackingView'); showTrackingOrders = !showTrackingOrders; if (showTrackingOrders) { btn.textContent = 'Xem đơn chưa có mã Tracking'; btn.classList.add('active'); } else { btn.textContent = 'Xem đơn có mã Tracking'; btn.classList.remove('active'); } activeRegion = 'all'; filterValues = {}; filterInitialData(); createTabs(initialFilteredData); setupColumnFilters(); applyAllFilters(); }
    function loadData() { const container = document.getElementById('tableBody'); container.innerHTML = `<tr><td colspan="${displayColumns.length}" style="text-align: center; padding: 20px;">Đang tải dữ liệu...</td></tr>`; const script = document.createElement('script'); script.src = 'https://script.google.com/macros/s/AKfycbwEd7eA6NAUMtbEpcEPJQWeX-zsJRE1mnTVVBD23NoKrnXYwOLvuNef2mIbJ7-NMNbe/exec?callback=handleData&rand=' + Math.random(); const oldScript = document.querySelector('script[src^="https://script.google.com"]'); if (oldScript) document.body.removeChild(oldScript); document.body.appendChild(script); }
    
    // Cập nhật và dán dữ liệu (đã có từ trước)
    function updateAllChangedRows() { if (changedRows.size === 0) { alert('Không có thay đổi nào để cập nhật'); return; } const statusEl = document.createElement('span'); statusEl.className = 'status'; document.getElementById('updateAll').appendChild(statusEl); sendRows(Array.from(changedRows), statusEl); }
    function sendRows(rowIndexes, statusEl) { statusEl.innerHTML = '<span class="loading"></span> Đang gửi...'; const rowsToSend = []; const tableBody = document.querySelector('tbody'); rowIndexes.forEach(rowIndex => { const originalRowData = filteredData[rowIndex]; if (!originalRowData) return; const domRow = tableBody.rows[rowIndex]; if (!domRow) return; const updatedRowData = { ...originalRowData }; displayColumns.forEach((col, colIndex) => { if (editableCols.includes(col)) { const cell = domRow.cells[colIndex]; let value; if (col === "Ngày đóng hàng" && cell.querySelector('input')) { value = cell.querySelector('input').value.trim(); value = parseDateToISO(value); } else { value = cell.textContent.trim(); } updatedRowData[col] = value; } }); rowsToSend.push(updatedRowData); Array.from(domRow.cells).forEach(cell => { if (cell.classList.contains('highlight')) { cell.classList.remove('highlight'); } }); }); fetch(POST_URL, { method: 'POST', mode: 'cors', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: new URLSearchParams({ rows: JSON.stringify(rowsToSend) }) }).then(r => r.json()).then(json => { if (json.message) { statusEl.textContent = `Thành công: ${json.message}`; changedRows.clear(); } else { statusEl.textContent = json.error || 'Cập nhật không thành công'; statusEl.classList.add('error-status'); } setTimeout(() => { statusEl.remove(); }, 4000); }).catch(e => { statusEl.textContent = 'Lỗi: ' + e.message; statusEl.classList.add('error-status'); setTimeout(() => { statusEl.remove(); }, 4000); }); }
    function setupPasteHandler() { document.addEventListener('paste', (e) => { const activeElement = document.activeElement; const isEditableCell = activeElement.classList.contains('editable') || (activeElement.tagName === 'INPUT' && activeElement.parentElement.classList.contains('editable')); if (!isEditableCell) return; e.preventDefault(); const pasteData = e.clipboardData.getData('text/plain'); if (!pasteData) return; const rows = pasteData.split('\n').map(row => row.split('\t')); const tableBody = document.querySelector('tbody'); if (!tableBody) return; let startRow = Array.from(tableBody.rows).findIndex(row => Array.from(row.cells).some(cell => cell === activeElement || cell.contains(activeElement)) ); let startCol = -1; if (startRow >= 0) { const cells = Array.from(tableBody.rows[startRow].cells); startCol = cells.findIndex(cell => cell === activeElement || cell.contains(activeElement)); } if (startRow < 0 || startCol < 0) return; for (let i = 0; i < rows.length; i++) { const rowIndex = startRow + i; if (rowIndex >= tableBody.rows.length) break; const rowData = rows[i]; for (let j = 0; j < rowData.length; j++) { const colIndex = startCol + j; if (colIndex >= tableBody.rows[rowIndex].cells.length) break; const cell = tableBody.rows[rowIndex].cells[colIndex]; if (cell.classList.contains('editable')) { if (displayColumns[colIndex] === "Ngày đóng hàng" && cell.querySelector('input')) { cell.querySelector('input').value = rowData[j]; } else { cell.textContent = rowData[j]; } cell.classList.add('highlight'); changedRows.add(rowIndex); } } } }); }
    
    // --- LOGIC MỚI CHO TÍNH NĂNG CHỌN VÀ SAO CHÉP NHIỀU Ô ---
    function setupMultiSelectAndCopy() {
        const tableBody = document.getElementById('tableBody');
        if (!tableBody) return;

        let isSelecting = false;
        let startCell = null;
        let lastClickedCell = null;

        const clearSelection = () => {
            document.querySelectorAll('td.cell-selected').forEach(cell => {
                cell.classList.remove('cell-selected');
            });
        };

        const selectCells = (start, end) => {
            clearSelection();
            const minRow = Math.min(start.rowIndex, end.rowIndex);
            const maxRow = Math.max(start.rowIndex, end.rowIndex);
            const minCol = Math.min(start.cellIndex, end.cellIndex);
            const maxCol = Math.max(start.cellIndex, end.cellIndex);

            for (let i = minRow; i <= maxRow; i++) {
                for (let j = minCol; j <= maxCol; j++) {
                    const cell = tableBody.rows[i]?.cells[j];
                    if (cell) {
                        cell.classList.add('cell-selected');
                    }
                }
            }
        };

        tableBody.addEventListener('mousedown', (e) => {
            // Chỉ bắt đầu chọn nếu click bằng chuột trái và không phải vào input/contentEditable
            if (e.button !== 0 || e.target.isContentEditable || e.target.tagName === 'INPUT') {
                return;
            }

            const cell = e.target.closest('td');
            if (!cell) return;

            e.preventDefault(); // Ngăn chặn hành vi chọn văn bản mặc định

            if (e.shiftKey && lastClickedCell) {
                // Xử lý Shift + Click
                selectCells(lastClickedCell, cell);
            } else {
                // Xử lý click chuột bình thường hoặc bắt đầu kéo
                isSelecting = true;
                clearSelection();
                startCell = cell;
                lastClickedCell = cell;
                cell.classList.add('cell-selected');
            }
        });

        tableBody.addEventListener('mousemove', (e) => {
            if (!isSelecting || !startCell) return;
            const cell = e.target.closest('td');
            if (cell) {
                selectCells(startCell, cell);
            }
        });

        document.addEventListener('mouseup', () => {
            isSelecting = false;
        });
        
        document.addEventListener('copy', (e) => {
            const selectedCells = document.querySelectorAll('td.cell-selected');
            if (selectedCells.length === 0) {
                // Nếu không có ô nào được chọn bởi logic của chúng ta, hãy để trình duyệt xử lý (ví dụ: sao chép văn bản bên trong ô editable)
                return; 
            }

            e.preventDefault(); // Ngăn chặn hành vi sao chép mặc định

            const rows = new Map();
            selectedCells.forEach(cell => {
                const rowIndex = cell.parentElement.rowIndex;
                if (!rows.has(rowIndex)) {
                    rows.set(rowIndex, []);
                }
                // Lấy text từ input nếu có, nếu không thì lấy textContent
                const input = cell.querySelector('input');
                const text = input ? input.value : cell.textContent;
                rows.get(rowIndex).push({ colIndex: cell.cellIndex, text: text });
            });

            const sortedRows = [...rows.entries()].sort((a, b) => a[0] - b[0]);
            
            const copyText = sortedRows.map(([rowIndex, cells]) => {
                return cells.sort((a, b) => a.colIndex - b.colIndex)
                             .map(cell => cell.text)
                             .join('\t');
            }).join('\n');

            e.clipboardData.setData('text/plain', copyText);
        });
    }


    // Khởi tạo
    setupControls();
  </script>

  <script src="https://script.google.com/macros/s/AKfycbwEd7eA6NAUMtbEpcEPJQWeX-zsJRE1mnTVVBD23NoKrnXYwOLvuNef2mIbJ7-NMNbe/exec?callback=handleData"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Báo cáo chi phí tổng hợp</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    /* --- CÀI ĐẶT CHUNG & TABS --- */
    body { font-family: 'Roboto', Arial, sans-serif; padding: 20px; background-color: #f4f4f4; color: #333; font-size: 16px; }
    .tab-container { overflow: hidden; border-bottom: 2px solid #ccc; margin-bottom: 20px; }
    .tab-container button {
      background-color: #f1f1f1; float: left; border: none; outline: none; cursor: pointer;
      padding: 14px 20px; transition: 0.3s; font-size: 17px; font-weight: 500;
      border-radius: 8px 8px 0 0; margin-right: 5px;
    }
    .tab-container button:hover { background-color: #ddd; }
    .tab-container button.active { background-color: #2d7c2d; color: white; }
    .tab-content { display: none; padding: 6px 12px; border-top: none; animation: fadeIn 0.5s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* --- STYLES CHUNG CHO BẢNG & CĂN LỀ --- */
    .table-responsive-container { overflow-x: auto; margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; table-layout: auto; background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    th, td { border: 1px solid #e0e0e0; padding: 12px 14px; white-space: nowrap; vertical-align: middle; transition: background-color 0.2s; font-size: 15px; }
    th { text-align: center !important; font-size: 16px; }
    td { text-align: right !important; }
    .text-left { text-align: left !important; }
    .text-center { text-align: center !important; }

    /* CẢI THIỆN KHẢ NĂNG ĐỌC BẢNG */
    tbody tr:nth-child(even) { background-color: #f9f9f9; }
    tbody tr:not(.team-header-row):not(.team-detail-row):not(.daily-detail-row):hover { background-color: #eff5fb; }
    
    th.green-header { background: #4CAF50; color: white; font-weight: 700; }
    th.yellow-header { background: #FFC107; color: #424242; font-weight: 700; }
    
    /* STYLE CHO DÒNG TỔNG CỘNG */
    tr.total-row, tr.total-row:hover { 
      background: #fffde7; 
      font-weight: 700; 
      font-size: 1.15em;
      color: #333;
      border-top: 2px solid #4CAF50;
    }
    tfoot .total-label { text-align: left !important; }
    tfoot .total-value { text-align: right !important; }
    
    /* ĐỊNH DẠNG CÓ ĐIỀU KIỆN */
    .bg-green { background-color: #4CAF50 !important; color: white; }
    .bg-yellow { background-color: #FFEB3B !important; color: #424242; }
    .bg-lightred { background-color: #F44336 !important; color: white; }
    .bg-lightblue { background-color: #2196F3 !important; color: white; }
    
    /* --- STYLES TAB 1 --- */
    .report-container { display: flex; gap: 20px; }
    .sidebar { width: 260px; flex-shrink: 0; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .sidebar h3 { background: #2d7c2d; color: #fff; padding: 10px; margin-top: 10px; font-size: 18px; border-radius: 4px; font-weight: 700; }
    .sidebar label { display: block; margin: 8px 0; font-size: 15px; cursor: pointer; }
    .sidebar .indent { margin-left: 16px; }
    .sidebar input[type="date"] { width: 100%; box-sizing: border-box; padding: 8px; margin: 4px 0 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 15px; }
    .main-detailed { flex-grow: 1; }
    .header { display: flex; align-items: center; margin-bottom: 10px; }
    .header img { height: 60px; margin-right: 15px; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    .header h2 { margin: 0; color: #2d7c2d; font-weight: 700; font-size: 28px; }
    #kpi-summary-table { margin-top: 30px; }
    .daily-breakdown h3 { margin-top: 30px; background: #f0f0f0; padding: 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 18px; font-weight: 700;}

    /* --- STYLES TAB 2 --- */
    .daily-report-layout { display: flex; gap: 20px; }
    .daily-report-layout .sidebar { width: 260px; }
    .daily-report-layout .main-content { flex-grow: 1; }
    .main-daily h2 { color: #2d7c2d; text-align: center; margin-bottom: 20px; font-weight: 700; font-size: 28px; }
    .chart-toggle-controls { margin: 20px 0; padding: 10px; background: #eee; border-radius: 8px; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }
    .chart-toggle-controls label { font-size: 15px; cursor: pointer;}
    .chart-toggle-controls .toggle-all { font-weight: bold; }
    .charts-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .chart-wrapper {
        background: #fff; padding: 15px; border-radius: 12px;
        box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        transition: opacity 0.4s ease-in-out, display 0s 0.4s;
    }
    .chart-wrapper canvas { width: 100% !important; height: 400px !important; }

    /* --- CSS CHO TÍNH NĂNG SỔ CHI TIẾT --- */
    #date-summary-body tr.summary-row { cursor: pointer; }
    .daily-detail-row td {
        padding: 0 !important;
        background-color: #fafcff !important;
        border: none;
        border-left: 5px solid #2d7c2d !important;
    }
    .daily-detail-row:hover {
        background-color: #fafcff !important;
    }
    .detail-table-container {
      padding: 15px 20px;
    }
    .detail-table-container table {
        box-shadow: none;
        border-radius: 0;
        border: 1px solid #ddd;
    }
    .detail-table-container th {
        background-color: #f1f1f1 !important;
        color: #333 !important;
    }
    .detail-table-container .sub-row:hover {
        background-color: #e9f5ff !important;
    }

    /* --- CHỈ BÁO ĐANG TẢI --- */
    #loading-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255, 255, 255, 0.7);
      display: flex; justify-content: center; align-items: center;
      z-index: 9999;
      font-size: 1.5em; font-weight: bold; color: #2d7c2d;
      transition: opacity 0.3s, visibility 0.3s;
      visibility: hidden; opacity: 0;
    }
    #loading-overlay.visible { visibility: visible; opacity: 1; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
</head>
<body>
  
  <div id="loading-overlay">Đang tải dữ liệu...</div>

  <div class="tab-container">
    <button class="tablinks" onclick="openTab(event, 'DetailedReport')" id="defaultOpen">Báo cáo chi tiết</button>
    <button class="tablinks" onclick="openTab(event, 'DailyReport')">Báo cáo theo ngày</button>
  </div>

  <div id="DetailedReport" class="tab-content">
      <!-- Nội dung Tab 1 không thay đổi -->
      <div class="report-container">
        <div class="sidebar">
          <h3>Bộ lọc</h3>
          <label for="start-date-tab1">Từ ngày:</label><input type="date" id="start-date-tab1">
          <label for="end-date-tab1">Đến ngày:</label><input type="date" id="end-date-tab1">
          <h3>Sản phẩm</h3>
          <label><input type="checkbox" id="product-all-tab1" checked> Tất cả</label>
          <div id="product-options-tab1" class="indent"></div>
          <h3>Ca</h3>
          <label><input type="checkbox" id="ca-all-tab1" checked> Tất cả</label>
          <div id="ca-options-tab1" class="indent"></div>
          <h3>Team</h3>
          <label><input type="checkbox" id="team-all-tab1" checked> Tất cả</label>
          <div id="team-options-tab1" class="indent"></div>
          <h3>Thị trường</h3>
          <label><input type="checkbox" id="market-all-tab1" checked> Tất cả</label>
          <div id="market-options-tab1"></div>
        </div>
        <div class="main-detailed">
          <div class="header"> 
              <img src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Ff930e667.%E1%BA%A2nh.025539.jpg" alt="Logo"> 
              <h2 id="report-title-tab1">DỮ LIỆU CHI PHÍ ADS</h2> 
          </div>
          <div class="table-responsive-container">
            <table id="summary-table">
              <thead>
                <tr>
                  <th class="green-header">STT</th> <th class="green-header">Team</th> <th class="green-header">Marketing</th>
                  <th class="green-header">Số Mess</th> <th class="green-header">CPQC</th> <th class="green-header">Số Đơn</th> <th class="green-header">DS Chốt</th>
                  <th class="yellow-header">Tỉ lệ chốt</th> <th class="yellow-header">Giá Mess</th> <th class="yellow-header">CPS</th>
                  <th class="yellow-header">%CP/DS</th> <th class="yellow-header">Giá TB Đơn</th>
                </tr>
              </thead>
              <tbody id="summary-body"></tbody> <tfoot id="summary-foot"></tfoot>
            </table>
          </div>
          <div class="table-responsive-container">
            <table id="kpi-summary-table">
                <thead>
                  <tr>
                    <th class="green-header">STT</th> <th class="green-header">Team</th> <th class="green-header">Marketing</th>
                    <th class="green-header">CPQC</th> <th class="green-header">DS Chốt</th> <th class="green-header">DS Đi</th>
                    <th class="green-header">DS Sau Ship</th> <th class="green-header">DS Thành Công</th>
                    <th class="yellow-header">%CP/DS</th> <th class="yellow-header">% KPI</th>
                  </tr>
                </thead>
                <tbody id="kpi-summary-body"></tbody> <tfoot id="kpi-summary-foot"></tfoot>
            </table>
          </div>
          <div id="daily-breakdown"></div>
        </div>
    </div>
  </div>

  <div id="DailyReport" class="tab-content">
    <div class="main-daily">
      <h2>Báo cáo hiệu suất theo ngày</h2>
      <div class="daily-report-layout">
        <div class="sidebar">
          <h3>Bộ lọc</h3>
          <label for="start-date-tab2">Từ ngày:</label><input type="date" id="start-date-tab2">
          <label for="end-date-tab2">Đến ngày:</label><input type="date" id="end-date-tab2">
          <h3>Sản phẩm</h3>
          <label><input type="checkbox" id="product-all-tab2" checked> Tất cả</label>
          <div id="product-options-tab2" class="indent"></div>
          <h3>Thị trường</h3>
          <label><input type="checkbox" id="market-all-tab2" checked> Tất cả</label>
          <div id="market-options-tab2"></div>
        </div>
        <div class="main-content">
          <div class="table-responsive-container">
            <table id="date-summary-table">
              <thead> <tr> <th>Ngày</th><th>Tổng CPQC</th><th>DS Chốt</th><th>Tỉ lệ chốt TB</th> <th>Giá Mess</th><th>CPS</th><th>%CP/DS</th> </tr> </thead>
              <tbody id="date-summary-body"></tbody>
            </table>
          </div>
          <div class="chart-toggle-controls">
              <label class="toggle-all"><input type="checkbox" id="toggle-all-charts" checked> Chọn/Bỏ chọn tất cả</label>
              <label><input type="checkbox" class="chart-toggle" data-chart="cpqcChart" checked> CPQC</label>
              <label><input type="checkbox" class="chart-toggle" data-chart="dsChotChart" checked> DS Chốt</label>
              <label><input type="checkbox" class="chart-toggle" data-chart="rateChart" checked> Tỉ lệ chốt</label>
              <label><input type="checkbox" class="chart-toggle" data-chart="messChart" checked> Giá Mess</label>
              <label><input type="checkbox" class="chart-toggle" data-chart="cpsChart" checked> CPS</label>
              <label><input type="checkbox" class="chart-toggle" data-chart="cpDsRatioChart" checked> %CP/DS</label>
              <label><input type="checkbox" class="chart-toggle" data-chart="productSalesChart" checked> DS theo Sản phẩm</label>
              <label><input type="checkbox" class="chart-toggle" data-chart="marketSalesChart" checked> DS theo Thị trường</label>
          </div>
          <div class="charts-container">
            <div class="chart-wrapper" data-chart="cpqcChart"><canvas id="cpqcChart"></canvas></div>
            <div class="chart-wrapper" data-chart="dsChotChart"><canvas id="dsChotChart"></canvas></div>
            <div class="chart-wrapper" data-chart="rateChart"><canvas id="rateChart"></canvas></div>
            <div class="chart-wrapper" data-chart="messChart"><canvas id="messChart"></canvas></div>
            <div class="chart-wrapper" data-chart="cpsChart"><canvas id="cpsChart"></canvas></div>
            <div class="chart-wrapper" data-chart="cpDsRatioChart"><canvas id="cpDsRatioChart"></canvas></div>
            <div class="chart-wrapper" data-chart="productSalesChart"><canvas id="productSalesChart"></canvas></div>
            <div class="chart-wrapper" data-chart="marketSalesChart"><canvas id="marketSalesChart"></canvas></div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
    // --- KHAI BÁO BIẾN TOÀN CỤC ---
    let masterData = []; 
    let employeeData = [];
    let charts = {};
    const groupChildren = { 'Châu Á': ['Hàn Quốc','Nhật Bản','VN'], 'Ngoài Châu Á': ['Úc','US', 'Canada'] };

    const loader = document.getElementById('loading-overlay');
    const showLoader = () => loader.classList.add('visible');
    const hideLoader = () => loader.classList.remove('visible');
    
    // --- KHỞI TẠO & TẢI DỮ LIỆU ---
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById("defaultOpen").click();
      addEventListeners();
      setDefaultDates();
      fetchAndProcessData();
    });

    function setDefaultDates() {
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        const formatDateForInput = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        document.getElementById('start-date-tab1').value = formatDateForInput(firstDay);
        document.getElementById('end-date-tab1').value = formatDateForInput(lastDay);
        document.getElementById('start-date-tab2').value = formatDateForInput(firstDay);
        document.getElementById('end-date-tab2').value = formatDateForInput(lastDay);
    }
    
    function addEventListeners() {
      document.body.addEventListener('change', (e) => {
        if (e.target.closest('#DetailedReport')) { handleTab1Filters(e.target); }
        else if (e.target.closest('#DailyReport')) { handleTab2Filters(e.target); }
      });
    }

    function fetchAndProcessData() {
        showLoader();
        const salesDataUrl = 'https://script.google.com/macros/s/AKfycbwGwSBxeXplEzAM-jJDPaXPkiWjNyKmpR70o6nCY5_ynqoF-3WA1gvF91RIQQfDZ9fvAQ/exec';
        const employeeDataUrl = 'https://script.google.com/macros/s/AKfycbzwOv7UFwrqzf88QJL1QrxLKcnnnSIQ_PSmF0SO8LboqWI5li3vF3W8_-8s-A8lNGaR/exec';

        Promise.all([
            fetch(salesDataUrl).then(res => res.json()),
            fetch(employeeDataUrl).then(res => res.json())
        ])
        .then(([salesResult, employeeResult]) => {
            masterData = salesResult
                .filter(r => r.ten && String(r.ten).trim() !== '')
                .map(r => ({
                    ...r,
                    ngay: new Date(r.ngay), 
                    ten: (r.ten || 'N/A').trim(),
                    team: (r.team || 'Khác').trim(),
                    cpqc: +r.cpqc || 0,
                    soMessCmt: +r.soMessCmt || 0,
                    soDon: +r.soDon || 0,
                    dsChot: +r.dsChot || 0,
                    doanhSo: +r.doanhSoDi || 0,
                    doanhSoSauShip: +r.doanhSoSauShip || 0,
                    doanhsoTC: +r.doanhsoTC || 0,
                    kpis: +r.kpis || 0
                }));
            
            employeeData = employeeResult;
            
            let dataForFilters = masterData;
            const idFromUrl = new URLSearchParams(window.location.search).get('id');

            if (idFromUrl) {
                const currentUser = employeeData.find(emp => emp.idnv === idFromUrl); 
                if (currentUser) {
                    const memberName = (currentUser.ho_va_ten || '').trim();
                    const teamName = (currentUser.team || '').trim();
                    if ((currentUser.vi_tri || '').trim().toLowerCase() === 'leader') {
                        document.getElementById('report-title-tab1').textContent = `DỮ LIỆU TEAM ${teamName}`;
                        dataForFilters = masterData.filter(r => (r.team || '').trim() === teamName);
                    } else {
                        document.getElementById('report-title-tab1').textContent = `DỮ LIỆU CÁ NHÂN - ${memberName}`;
                        dataForFilters = masterData.filter(r => (r.ten || '').trim() === memberName);
                    }
                } else {
                    alert(`ID "${idFromUrl}" không hợp lệ hoặc không tồn tại trong danh sách nhân sự.`);
                    document.getElementById('report-title-tab1').textContent = `KHÔNG TÌM THẤY DỮ LIỆU`;
                    dataForFilters = [];
                }
            } else {
                document.getElementById('report-title-tab1').textContent = 'DỮ LIỆU CHI PHÍ ADS';
            }
            
            populateAllFilters(dataForFilters);
            applyTab1Filters(dataForFilters);
        }).catch(err => { 
            console.error("Lỗi khi tải dữ liệu:", err); 
            alert('Không thể tải dữ liệu. Vui lòng kiểm tra lại đường link hoặc kết nối mạng.'); 
        }).finally(() => {
            hideLoader();
        });
    }
    
    function getFilteredData(initialData) {
        //...
        return []; // Tạm thời để tránh lỗi, hàm thực sự không đổi
    }

    function populateAllFilters(data) {
        const prodSet=new Set(), caSet=new Set(), teamSet=new Set(), mktSet=new Set();
        (data || masterData).forEach(r=>{ if(r.sanPham) prodSet.add(r.sanPham); if(r.ca) caSet.add(r.ca); if(r.team) teamSet.add(r.team); if(r.thiTruong) mktSet.add(r.thiTruong); });
        
        const createSimpleCheckboxes = (set, className) => Array.from(set).sort().map(item => `<label class='indent'><input type='checkbox' class='${className}' value='${item}' checked> ${item}</label>`).join('');
        
        const createMarketCheckboxes = (className) => {
            const marketHtml = Object.keys(groupChildren).map(grp => `<label><input type='checkbox' class='${className}' value='${grp}' checked> <b>${grp}</b></label>` + groupChildren[grp].map(ch => `<label class='indent'><input type='checkbox' class='${className}' value='${ch}' checked> ${ch}</label>`).join('')).join('');
            const otherMarkets = Array.from(mktSet).filter(m => !Object.values(groupChildren).flat().map(c => normalize(c)).includes(normalize(m))).sort().map(m => `<label class='indent'><input type='checkbox' class='${className}' value='${m}' checked> ${m}</label>`).join('');
            return marketHtml + otherMarkets;
        };

        document.getElementById('product-options-tab1').innerHTML = createSimpleCheckboxes(prodSet, 'filter-product-tab1');
        document.getElementById('ca-options-tab1').innerHTML = createSimpleCheckboxes(caSet, 'filter-ca-tab1');
        document.getElementById('team-options-tab1').innerHTML = createSimpleCheckboxes(teamSet, 'filter-team-tab1');
        document.getElementById('market-options-tab1').innerHTML = createMarketCheckboxes('filter-market-tab1');
        
        document.getElementById('product-options-tab2').innerHTML = createSimpleCheckboxes(prodSet, 'filter-product-tab2');
        document.getElementById('market-options-tab2').innerHTML = createMarketCheckboxes('filter-market-tab2');
    }

    // Các hàm phụ trợ không đổi
    function normalize(s) { return (s||'').trim().toLowerCase(); }
    function capitalize(s) { return s.charAt(0).toUpperCase()+s.slice(1); }
    function getGroup(norm) { for (let g in groupChildren) { if (groupChildren[g].map(normalize).includes(norm)) return g; } return capitalize(norm); }
    function formatDate(v) { if (!(v instanceof Date) || isNaN(v)) return String(v); const day = String(v.getDate()).padStart(2,'0'); const month = String(v.getMonth() + 1).padStart(2,'0'); const year = v.getFullYear(); return `${day}/${month}/${year}`; }
    function formatCurrency(v) { return Number(v||0).toLocaleString('vi-VN',{style:'currency',currency:'VND'}); }
    function formatPriceShort(v) { const num = Number(v || 0); if (v === null || v === undefined) return ''; if (num >= 1000000) return (num / 1000000).toFixed(1) + 'tr'; if (num >= 1000) return (num / 1000).toFixed(0) + 'k'; return num.toLocaleString('vi-VN'); }
    function formatPercent(v) { if (v === null || v === undefined || !isFinite(v)) return '0.00%'; return `${(Number(v||0) * 100).toFixed(2)}%`; }
    function handleCheckbox(masterId, childClass, target) { const allCheckbox = document.getElementById(masterId); if (!allCheckbox) return; if (target.id === masterId) { document.querySelectorAll(`.${childClass}`).forEach(cb => cb.checked = target.checked); } else if (target.classList.contains(childClass)) { allCheckbox.checked = [...document.querySelectorAll(`.${childClass}`)].every(cb => cb.checked); } }
    function getCpsCellStyle(cps, selectedMarkets=[]) { const hasChauA = selectedMarkets.some(m => m === 'Châu Á' || groupChildren['Châu Á'].includes(m)); const hasNgoaiChauA = selectedMarkets.some(m => m === 'Ngoài Châu Á' || groupChildren['Ngoài Châu Á'].includes(m)); const isChauAOnly = hasChauA && !hasNgoaiChauA && selectedMarkets.length > 0; if (isChauAOnly) { if (cps > 1000000) return 'bg-lightred'; if (cps > 700000) return 'bg-yellow'; } else { if (cps > 1500000) return 'bg-lightred'; if (cps > 1000000) return 'bg-yellow'; } return ''; }
    
    // --- Các hàm xử lý TAB 1 ---
    function handleTab1Filters(target) { showLoader(); setTimeout(() => { handleCheckbox('product-all-tab1', 'filter-product-tab1', target); handleCheckbox('ca-all-tab1', 'filter-ca-tab1', target); handleCheckbox('team-all-tab1', 'filter-team-tab1', target); handleCheckbox('market-all-tab1', 'filter-market-tab1', target); applyTab1Filters(); hideLoader(); }, 10); }
    function applyTab1Filters(baseData = null) {
        if (baseData === null) {
            const idFromUrl = new URLSearchParams(window.location.search).get('id');
            if (idFromUrl) {
                const currentUser = employeeData.find(emp => emp.idnv === idFromUrl);
                if (currentUser) {
                    const memberName = (currentUser.ho_va_ten || '').trim();
                    const teamName = (currentUser.team || '').trim();
                    if ((currentUser.vi_tri || '').trim().toLowerCase() === 'leader') {
                        baseData = masterData.filter(r => (r.team || '').trim() === teamName);
                    } else {
                        baseData = masterData.filter(r => (r.ten || '').trim() === memberName);
                    }
                } else {
                    baseData = [];
                }
            } else {
                baseData = masterData;
            }
        }
        const filtered = getFilteredDataTab1(baseData);
        renderSummary(filtered); 
        renderKpiSummary(filtered); 
        renderDailyBreakdown(filtered);
    }
    function getFilteredDataTab1(initialData) {
        const filterIds = {
            startDateId: 'start-date-tab1', endDateId: 'end-date-tab1',
            productCbId: 'product-all-tab1', productOptionsClass: 'filter-product-tab1',
            marketCbId: 'market-all-tab1', marketOptionsClass: 'filter-market-tab1',
            caCbId: 'ca-all-tab1', caOptionsClass: 'filter-ca-tab1',
            teamCbId: 'team-all-tab1', teamOptionsClass: 'filter-team-tab1'
        };
        const sdVal = document.getElementById(filterIds.startDateId).value;
        const edVal = document.getElementById(filterIds.endDateId).value;
        const sd = sdVal ? new Date(sdVal + 'T00:00:00') : null;
        const ed = edVal ? new Date(edVal + 'T00:00:00') : null;
        if(ed) ed.setHours(23, 59, 59, 999);

        const getSelected = (allId, cbClass) => {
            if (document.getElementById(allId).checked) return null;
            return [...document.querySelectorAll(`.${cbClass}:checked`)].map(cb => cb.value);
        }
        const selP = getSelected(filterIds.productCbId, filterIds.productOptionsClass);
        const selM = getSelected(filterIds.marketCbId, filterIds.marketOptionsClass);
        const selCa = getSelected(filterIds.caCbId, filterIds.caOptionsClass);
        const selT = getSelected(filterIds.teamCbId, filterIds.teamOptionsClass);
        
        return initialData.filter(r => {
            const d = r.ngay;
            if (!(d instanceof Date) || isNaN(d)) return false; 
            const isDateOk = (!sd || d >= sd) && (!ed || d <= ed);
            const isProductOk = !selP || selP.includes(r.sanPham);
            const marketGroup = getGroup(normalize(r.thiTruong));
            const isMarketOk = !selM || selM.includes(marketGroup) || selM.includes(r.thiTruong);
            const isCaOk = !selCa || selCa.includes(r.ca);
            const isTeamOk = !selT || selT.includes(r.team);
            return isDateOk && isProductOk && isMarketOk && isCaOk && isTeamOk;
        });
    }
    function renderSummary(data) { /* ... Giữ nguyên như trước ... */ }
    function renderKpiSummary(data) { /* ... Giữ nguyên như trước ... */ }
    function renderDailyBreakdown(data) { /* ... Giữ nguyên như trước ... */ }

    // --- Các hàm xử lý TAB 2 ---
    function openTab(evt, tabName) {
      document.querySelectorAll(".tab-content").forEach(tc => tc.style.display = "none");
      document.querySelectorAll(".tablinks").forEach(tl => tl.classList.remove("active"));
      document.getElementById(tabName).style.display = "block";
      evt.currentTarget.classList.add("active");
      if (tabName === 'DailyReport' && Object.keys(charts).length === 0) { 
        initAllCharts(); 
        applyDailyFilters(); 
      }
    }
    
    function getFilteredDataTab2() {
        const filterIds = {
            startDateId: 'start-date-tab2', endDateId: 'end-date-tab2',
            productCbId: 'product-all-tab2', productOptionsClass: 'filter-product-tab2',
            marketCbId: 'market-all-tab2', marketOptionsClass: 'filter-market-tab2'
        };
        const sdVal = document.getElementById(filterIds.startDateId).value;
        const edVal = document.getElementById(filterIds.endDateId).value;
        const sd = sdVal ? new Date(sdVal + 'T00:00:00') : null;
        const ed = edVal ? new Date(edVal + 'T00:00:00') : null;
        if(ed) ed.setHours(23, 59, 59, 999);

        const getSelected = (allId, cbClass) => {
            if (document.getElementById(allId).checked) return null;
            return [...document.querySelectorAll(`.${cbClass}:checked`)].map(cb => cb.value);
        };
        const selP = getSelected(filterIds.productCbId, filterIds.productOptionsClass);
        const selM = getSelected(filterIds.marketCbId, filterIds.marketOptionsClass);

        return masterData.filter(r => {
            const d = r.ngay;
            if (!(d instanceof Date) || isNaN(d)) return false;
            const isDateOk = (!sd || d >= sd) && (!ed || d <= ed);
            const isProductOk = !selP || selP.includes(r.sanPham);
            const marketGroup = getGroup(normalize(r.thiTruong));
            const isMarketOk = !selM || selM.includes(marketGroup) || selM.includes(r.thiTruong);
            return isDateOk && isProductOk && isMarketOk;
        });
    }
    
    function handleTab2Filters(target) { 
        showLoader(); 
        setTimeout(() => { 
            if (target.id === 'toggle-all-charts' || target.classList.contains('chart-toggle')) {
                 if (target.id === 'toggle-all-charts') document.querySelectorAll('.chart-toggle').forEach(cb => cb.checked = target.checked);
                 else document.getElementById('toggle-all-charts').checked = [...document.querySelectorAll('.chart-toggle')].every(cb => cb.checked);
                 toggleChartVisibility(); hideLoader(); return;
            }
            handleCheckbox('product-all-tab2', 'filter-product-tab2', target);
            handleCheckbox('market-all-tab2', 'filter-market-tab2', target);
            applyDailyFilters();
            hideLoader();
        }, 10); 
    }

    function applyDailyFilters() { 
        if (!masterData.length) return; 
        const filtered = getFilteredDataTab2(); 
        renderDailyTable(filtered); 
        renderAllDailyCharts(filtered); 
    }

    function renderDailyTable(data) {
        const daily = {};
        data.forEach(r => {
            const dateKey = formatDate(r.ngay);
            if (!daily[dateKey]) daily[dateKey] = { cpqc: 0, don: 0, mess: 0, chot: 0 };
            daily[dateKey].cpqc += r.cpqc;
            daily[dateKey].don += r.soDon;
            daily[dateKey].mess += r.soMessCmt;
            daily[dateKey].chot += r.dsChot;
        });
        let tbodyHtml = Object.keys(daily)
            .sort((a,b) => new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-')))
            .map(d => {
                const day = daily[d];
                const avg = day.mess ? day.don / day.mess : 0;
                const giaMess = day.mess ? day.cpqc / day.mess : 0;
                const cps = day.don ? day.cpqc / day.don : 0;
                const cpqcRatio = day.chot ? day.cpqc / day.chot : 0;
                return `<tr class="summary-row" data-date="${d}" onclick="toggleDailyDetail(this)">
                            <td class="text-left"><b>${d}</b></td>
                            <td>${formatPriceShort(day.cpqc)}</td>
                            <td>${formatPriceShort(day.chot)}</td>
                            <td>${formatPercent(avg)}</td>
                            <td>${formatPriceShort(giaMess)}</td>
                            <td>${formatPriceShort(cps)}</td>
                            <td>${formatPercent(cpqcRatio)}</td>
                        </tr>`;
            }).join('');
        document.getElementById('date-summary-body').innerHTML = tbodyHtml;
    }

    // *** THAY ĐỔI: Sửa đổi hoàn toàn logic của hàm này ***
    function toggleDailyDetail(row) {
        const dateKey = row.dataset.date;
        const nextRow = row.nextElementSibling;

        if (nextRow && nextRow.classList.contains('daily-detail-row')) {
            nextRow.remove();
            return;
        }

        document.querySelectorAll('.daily-detail-row').forEach(detailRow => detailRow.remove());

        const currentFilteredData = getFilteredDataTab2();
        const dataForDay = currentFilteredData.filter(r => formatDate(r.ngay) === dateKey);

        if (dataForDay.length === 0) return;

        // Bắt đầu logic mới: nhóm theo nhân sự trong ngày
        const personSummary = {};
        dataForDay.forEach(r => {
            const personName = r.ten;
            if (!personSummary[personName]) {
                personSummary[personName] = { team: r.team, mess: 0, don: 0, chot: 0, cpqc: 0 };
            }
            personSummary[personName].mess += r.soMessCmt;
            personSummary[personName].don += r.soDon;
            personSummary[personName].chot += r.dsChot;
            personSummary[personName].cpqc += r.cpqc;
        });

        const sortedPersons = Object.keys(personSummary).sort((a, b) => (personSummary[a].team.localeCompare(personSummary[b].team)) || a.localeCompare(b));

        const rowsHtml = sortedPersons.map((personName, index) => {
            const s = personSummary[personName];
            const rate = s.mess ? s.don / s.mess : 0;
            const pm = s.mess ? s.cpqc / s.mess : 0;
            const pd = s.don ? s.cpqc / s.don : 0;
            const pc = s.chot ? s.cpqc / s.chot : 0;
            const pdt = s.don ? s.chot / s.don : 0;
            
            const rateClass = rate > 0.1 ? 'bg-green' : (rate > 0.05 ? 'bg-yellow' : '');
            const cpsClass = getCpsCellStyle(pd); // Không cần truyền market vì đang xem theo ngày
            const cpdsClass = pc > 0.33 ? 'bg-yellow' : '';

            return `<tr class="sub-row">
                <td class="text-center">${index + 1}</td>
                <td class="text-left">${s.team}</td>
                <td class="text-left">${personName}</td>
                <td>${s.mess.toLocaleString('vi-VN')}</td>
                <td>${formatCurrency(s.cpqc)}</td>
                <td>${s.don.toLocaleString('vi-VN')}</td>
                <td>${formatCurrency(s.chot)}</td>
                <td class="${rateClass}">${formatPercent(rate)}</td>
                <td>${formatCurrency(pm)}</td>
                <td class="${cpsClass}">${formatCurrency(pd)}</td>
                <td class="${cpdsClass}">${formatPercent(pc)}</td>
                <td>${formatCurrency(pdt)}</td>
            </tr>`;
        }).join('');

        const detailTableHtml = `
            <div class="detail-table-container">
                <table>
                    <thead>
                        <tr>
                            <th class="green-header">STT</th>
                            <th class="green-header">Team</th>
                            <th class="green-header">Marketing</th>
                            <th class="green-header">Số Mess</th>
                            <th class="green-header">CPQC</th>
                            <th class="green-header">Số Đơn</th>
                            <th class="green-header">DS Chốt</th>
                            <th class="yellow-header">Tỉ lệ chốt</th>
                            <th class="yellow-header">Giá Mess</th>
                            <th class="yellow-header">CPS</th>
                            <th class="yellow-header">%CP/DS</th>
                            <th class="yellow-header">Giá TB Đơn</th>
                        </tr>
                    </thead>
                    <tbody>${rowsHtml}</tbody>
                </table>
            </div>`;
        
        const detailRow = document.createElement('tr');
        detailRow.classList.add('daily-detail-row');
        const detailCell = document.createElement('td');
        detailCell.colSpan = row.cells.length;
        detailCell.innerHTML = detailTableHtml;
        
        detailRow.appendChild(detailCell);
        row.parentNode.insertBefore(detailRow, row.nextSibling);
    }

    // Các hàm vẽ biểu đồ không đổi
    function toggleChartVisibility() { /*...*/ }
    function initAllCharts() { /*...*/ }
    function renderAllDailyCharts(data) { /*...*/ }
    function getChartColors() { /*...*/ }
    function getLineChartConfig(yTitle, formatter) { /*...*/ }
    function getBarChartConfig(title) { /*...*/ }
    function updateChart(chart, label, labels, data, colors, type) { /*...*/ }
    function createDataset(label, data, colors, type) { /*...*/ }

</script>
</body>
</html>

<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Báo cáo chi phí tổng hợp</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
/* --- CÀI ĐẶT CHUNG & TABS --- */
body { font-family: 'Roboto', Arial, sans-serif; padding: 20px; background-color: #f4f4f4; color: #333; font-size: 16px; }
.tab-container { overflow: hidden; border-bottom: 2px solid #ccc; margin-bottom: 20px; }
.tab-container button {
background-color: #f1f1f1; float: left; border: none; outline: none; cursor: pointer;
padding: 14px 20px; transition: 0.3s; font-size: 17px; font-weight: 500;
border-radius: 8px 8px 0 0; margin-right: 5px;
}
.tab-container button:hover { background-color: #ddd; }
.tab-container button.active { background-color: #2d7c2d; color: white; }
.tab-content { display: none; padding: 6px 12px; border-top: none; animation: fadeIn 0.5s; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
code
Code
/* --- STYLES CHUNG CHO BẢNG & CĂN LỀ --- */
.table-responsive-container { overflow-x: auto; margin-bottom: 20px; }
table { width: 100%; border-collapse: collapse; table-layout: auto; background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
th, td { border: 1px solid #e0e0e0; padding: 12px 14px; white-space: nowrap; vertical-align: middle; transition: background-color 0.2s; font-size: 15px; }

th { text-align: center !important; font-size: 16px; }
td { text-align: right !important; }
.text-left { text-align: left !important; }
.text-center { text-align: center !important; }

/* CẢI THIỆN KHẢ NĂNG ĐỌC BẢNG */
tbody tr:nth-child(even) { background-color: #f9f9f9; }
tbody tr:not(.team-header-row):not(.total-row):hover { background-color: #eff5fb; }

th.green-header { background: #4CAF50; color: white; font-weight: 700; }
th.yellow-header { background: #FFC107; color: #424242; font-weight: 700; }

tr.total-row, tr.total-row:hover {
    background: #2d7c2d;
    color: white;
    font-weight: 700;
    font-size: 1.2em;
    border-bottom: 3px solid #FFC107;
}
.total-row .total-label {
    text-transform: uppercase;
    text-align: left !important;
}
.total-row .total-value {
    text-align: right !important;
}

.bg-green { background-color: #4CAF50 !important; color: white; }
.bg-yellow { background-color: #FFEB3B !important; color: #424242; }
.bg-lightred { background-color: #F44336 !important; color: white; }
.bg-lightblue { background-color: #2196F3 !important; color: white; }

/* --- STYLES CHO TABS & LAYOUT CHUNG --- */
.report-container { display: flex; gap: 20px; }
.sidebar { width: 260px; flex-shrink: 0; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
.sidebar h3 { background: #2d7c2d; color: #fff; padding: 10px; margin-top: 10px; font-size: 18px; border-radius: 4px; font-weight: 700; }
.sidebar label { display: block; margin: 8px 0; font-size: 15px; cursor: pointer; }
.sidebar .indent { margin-left: 16px; }
.sidebar input[type="date"] { width: 100%; box-sizing: border-box; padding: 8px; margin: 4px 0 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 15px; }
.main-content-area { flex-grow: 1; }
.header { display: flex; align-items: center; margin-bottom: 10px; }
.header img { height: 60px; margin-right: 15px; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
.header h2 { margin: 0; color: #2d7c2d; font-weight: 700; font-size: 28px; }

/* --- STYLES TAB 2 (BIỂU ĐỒ) --- */
.daily-report-layout { display: flex; gap: 20px; }
.main-daily h2 { color: #2d7c2d; text-align: center; margin-bottom: 20px; font-weight: 700; font-size: 28px; }
.chart-toggle-controls { margin: 20px 0; padding: 10px; background: #eee; border-radius: 8px; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }
.chart-toggle-controls label { font-size: 15px; cursor: pointer;}
.chart-toggle-controls .toggle-all { font-weight: bold; }
.charts-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
.chart-wrapper {
    background: #fff; padding: 15px; border-radius: 12px;
    box-shadow: 0 6px 12px rgba(0,0,0,0.1);
    transition: opacity 0.4s ease-in-out, display 0s 0.4s;
}
.chart-wrapper canvas { width: 100% !important; height: 400px !important; }
#date-summary-body tr { cursor: pointer; }

/* --- CHỈ BÁO ĐANG TẢI --- */
#loading-overlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(255, 255, 255, 0.7);
  display: flex; justify-content: center; align-items: center;
  z-index: 9999;
  font-size: 1.5em; font-weight: bold; color: #2d7c2d;
  transition: opacity 0.3s, visibility 0.3s;
  visibility: hidden; opacity: 0;
}
#loading-overlay.visible { visibility: visible; opacity: 1; }

/* --- CSS CHO MODAL & SẮP XẾP BẢNG --- */
.modal {
  display: none; position: fixed; z-index: 10000; left: 0; top: 0;
  width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6);
  justify-content: center; align-items: center;
}
.modal-content {
  background-color: #fefefe; margin: auto; padding: 25px; border-radius: 10px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 1200px;
  max-height: 90vh; display: flex; flex-direction: column;
}
.modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; padding-bottom: 15px; margin-bottom: 15px; }
.modal-header h2 { margin: 0; color: #2d7c2d; font-size: 24px; }
.close-button { color: #aaa; font-size: 30px; font-weight: bold; cursor: pointer; }
.close-button:hover, .close-button:focus { color: black; text-decoration: none; }
.modal-body { overflow-y: auto; }

.sortable-table th { cursor: pointer; position: relative; }
.sortable-table th .sort-icon {
  position: absolute; right: 8px; top: 50%;
  transform: translateY(-50%); font-size: 0.8em;
  opacity: 0.4; transition: opacity 0.2s;
}
.sortable-table th:hover .sort-icon { opacity: 0.8; }
.sortable-table th.sorted .sort-icon { opacity: 1; }
.sortable-table th .sort-icon.asc::after { content: " ▲"; }
.sortable-table th .sort-icon.desc::after { content: " ▼"; }
.daily-breakdown h3 { margin-top: 30px; background: #f0f0f0; padding: 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 18px; font-weight: 700;}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
</head>
<body>
<div id="loading-overlay">Đang tải dữ liệu...</div>
<div class="tab-container">
<button class="tablinks" onclick="openTab(event, 'DetailedReport')" id="defaultOpen">Báo cáo chi tiết</button>
<button class="tablinks" onclick="openTab(event, 'KpiReport')">Báo cáo KPI</button>
<button class="tablinks" onclick="openTab(event, 'DailyReport')">Báo cáo theo ngày</button>
</div>
<!-- TAB 1: BÁO CÁO CHI TIẾT -->
<div id="DetailedReport" class="tab-content">
<div class="report-container">
<div class="sidebar">
<h3>Bộ lọc</h3>
<label for="start-date-tab1">Từ ngày:</label><input type="date" id="start-date-tab1">
<label for="end-date-tab1">Đến ngày:</label><input type="date" id="end-date-tab1">
<h3>Sản phẩm</h3>
<label><input type="checkbox" id="product-all-tab1" checked> Tất cả</label>
<div id="product-options-tab1" class="indent"></div>
<h3>Ca</h3>
<label><input type="checkbox" id="ca-all-tab1" checked> Tất cả</label>
<div id="ca-options-tab1" class="indent"></div>
<h3>Team</h3>
<label><input type="checkbox" id="team-all-tab1" checked> Tất cả</label>
<div id="team-options-tab1" class="indent"></div>
<h3>Thị trường</h3>
<label><input type="checkbox" id="market-all-tab1" checked> Tất cả</label>
<div id="market-options-tab1"></div>
</div>
<div class="main-content-area">
<div class="header">
<img src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Ff930e667.%E1%BA%A2nh.025539.jpg" alt="Logo">
<h2 id="report-title-tab1">DỮ LIỆU CHI PHÍ ADS</h2>
</div>
<div class="table-responsive-container">
<table id="summary-table" class="sortable-table">
<thead>
<tr>
<th class="green-header">STT<span class="sort-icon"></span></th>
<th class="green-header">Team<span class="sort-icon"></span></th>
<th class="green-header">Marketing<span class="sort-icon"></span></th>
<th class="green-header">Số Mess<span class="sort-icon"></span></th>
<th class="green-header">CPQC<span class="sort-icon"></span></th>
<th class="green-header">Số Đơn<span class="sort-icon"></span></th>
<th class="green-header">DS Chốt<span class="sort-icon"></span></th>
<th class="yellow-header">Tỉ lệ chốt<span class="sort-icon"></span></th>
<th class="yellow-header">Giá Mess<span class="sort-icon"></span></th>
<th class="yellow-header">CPS<span class="sort-icon"></span></th>
<th class="yellow-header">%CP/DS<span class="sort-icon"></span></th>
<th class="yellow-header">Giá TB Đơn<span class="sort-icon"></span></th>
</tr>
</thead>
<tbody id="summary-body"></tbody>
<tfoot id="summary-foot"></tfoot>
</table>
</div>
<div id="daily-breakdown"></div>
</div>
</div>
</div>
<!-- TAB 2: BÁO CÁO KPI -->
<div id="KpiReport" class="tab-content">
<div class="report-container">
<div class="sidebar">
<h3>Bộ lọc</h3>
<label for="start-date-tab3">Từ ngày:</label><input type="date" id="start-date-tab3">
<label for="end-date-tab3">Đến ngày:</label><input type="date" id="end-date-tab3">
<h3>Sản phẩm</h3>
<label><input type="checkbox" id="product-all-tab3" checked> Tất cả</label>
<div id="product-options-tab3" class="indent"></div>
<h3>Ca</h3>
<label><input type="checkbox" id="ca-all-tab3" checked> Tất cả</label>
<div id="ca-options-tab3" class="indent"></div>
<h3>Team</h3>
<label><input type="checkbox" id="team-all-tab3" checked> Tất cả</label>
<div id="team-options-tab3" class="indent"></div>
<h3>Thị trường</h3>
<label><input type="checkbox" id="market-all-tab3" checked> Tất cả</label>
<div id="market-options-tab3"></div>
</div>
<div class="main-content-area">
<div class="header">
<img src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Ff930e667.%E1%BA%A2nh.025539.jpg" alt="Logo">
<h2>BÁO CÁO HIỆU SUẤT KPI</h2>
</div>
<div class="table-responsive-container">
<table id="kpi-summary-table" class="sortable-table">
<thead>
<tr>
<th class="green-header">STT<span class="sort-icon"></span></th>
<th class="green-header">Team<span class="sort-icon"></span></th>
<th class="green-header">Marketing<span class="sort-icon"></span></th>
<th class="green-header">CPQC<span class="sort-icon"></span></th>
<th class="green-header">DS Chốt<span class="sort-icon"></span></th>
<th class="green-header">DS Đi<span class="sort-icon"></span></th>
<th class="green-header">DS Sau Ship<span class="sort-icon"></span></th>
<th class="green-header">DS Thành Công<span class="sort-icon"></span></th>
<th class="yellow-header">%CP/DS<span class="sort-icon"></span></th>
<th class="yellow-header">% KPI<span class="sort-icon"></span></th>
</tr>
</thead>
<tbody id="kpi-summary-body"></tbody>
<tfoot id="kpi-summary-foot"></tfoot>
</table>
</div>
</div>
</div>
</div>
<!-- TAB 3: BÁO CÁO THEO NGÀY (BIỂU ĐỒ) -->
<div id="DailyReport" class="tab-content">
<div class="main-daily">
<h2>Báo cáo hiệu suất theo ngày</h2>
<div class="daily-report-layout">
<div class="sidebar">
<h3>Bộ lọc</h3>
<label for="start-date-tab2">Từ ngày:</label><input type="date" id="start-date-tab2">
<label for="end-date-tab2">Đến ngày:</label><input type="date" id="end-date-tab2">
<h3>Sản phẩm</h3>
<label><input type="checkbox" id="product-all-tab2" checked> Tất cả</label>
<div id="product-options-tab2" class="indent"></div>
<h3>Thị trường</h3>
<label><input type="checkbox" id="market-all-tab2" checked> Tất cả</label>
<div id="market-options-tab2"></div>
</div>
<div class="main-content-area">
<div class="table-responsive-container">
<table id="date-summary-table">
<thead> <tr> <th>Ngày</th><th>Tổng CPQC</th><th>DS Chốt</th><th>Tỉ lệ chốt TB</th> <th>Giá Mess</th><th>CPS</th><th>%CP/DS</th> </tr> </thead>
<tbody id="date-summary-body"></tbody>
</table>
</div>
<div class="chart-toggle-controls">
<label class="toggle-all"><input type="checkbox" id="toggle-all-charts" checked> Chọn/Bỏ chọn tất cả</label>
<label><input type="checkbox" class="chart-toggle" data-chart="cpqcChart" checked> CPQC</label>
<label><input type="checkbox" class="chart-toggle" data-chart="dsChotChart" checked> DS Chốt</label>
<label><input type="checkbox" class="chart-toggle" data-chart="rateChart" checked> Tỉ lệ chốt</label>
<label><input type="checkbox" class="chart-toggle" data-chart="messChart" checked> Giá Mess</label>
<label><input type="checkbox" class="chart-toggle" data-chart="cpsChart" checked> CPS</label>
<label><input type="checkbox" class="chart-toggle" data-chart="cpDsRatioChart" checked> %CP/DS</label>
<label><input type="checkbox" class="chart-toggle" data-chart="productSalesChart" checked> DS theo Sản phẩm</label>
<label><input type="checkbox" class="chart-toggle" data-chart="marketSalesChart" checked> DS theo Thị trường</label>
</div>
<div class="charts-container">
<div class="chart-wrapper" data-chart="cpqcChart"><canvas id="cpqcChart"></canvas></div>
<div class="chart-wrapper" data-chart="dsChotChart"><canvas id="dsChotChart"></canvas></div>
<div class="chart-wrapper" data-chart="rateChart"><canvas id="rateChart"></canvas></div>
<div class="chart-wrapper" data-chart="messChart"><canvas id="messChart"></canvas></div>
<div class="chart-wrapper" data-chart="cpsChart"><canvas id="cpsChart"></canvas></div>
<div class="chart-wrapper" data-chart="cpDsRatioChart"><canvas id="cpDsRatioChart"></canvas></div>
<div class="chart-wrapper" data-chart="productSalesChart"><canvas id="productSalesChart"></canvas></div>
<div class="chart-wrapper" data-chart="marketSalesChart"><canvas id="marketSalesChart"></canvas></div>
</div>
</div>
</div>
</div>
</div>
<!-- Cấu trúc HTML cho Modal -->
<div id="daily-detail-modal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h2 id="modal-title">Chi tiết ngày</h2>
<span class="close-button">&times;</span>
</div>
<div class="modal-body">
<div class="table-responsive-container">
<table id="modal-summary-table" class="sortable-table">
<thead>
<tr>
<th class="green-header">STT <span class="sort-icon"></span></th>
<th class="green-header">Team <span class="sort-icon"></span></th>
<th class="green-header">Marketing <span class="sort-icon"></span></th>
<th class="green-header">Số Mess <span class="sort-icon"></span></th>
<th class="green-header">CPQC <span class="sort-icon"></span></th>
<th class="green-header">Số Đơn <span class="sort-icon"></span></th>
<th class="green-header">DS Chốt <span class="sort-icon"></span></th>
<th class="yellow-header">Tỉ lệ chốt <span class="sort-icon"></span></th>
<th class="yellow-header">Giá Mess <span class="sort-icon"></span></th>
<th class="yellow-header">CPS <span class="sort-icon"></span></th>
<th class="yellow-header">%CP/DS <span class="sort-icon"></span></th>
<th class="yellow-header">Giá TB Đơn <span class="sort-icon"></span></th>
</tr>
</thead>
<tbody id="modal-summary-body"></tbody>
<tfoot id="modal-summary-foot"></tfoot>
</table>
</div>
</div>
</div>
</div>
<script>
// --- KHAI BÁO BIẾN TOÀN CỤC ---
let masterData = [];
let employeeData = [];
let baseDataForReport = [];
let charts = {};
const groupChildren = { 'Châu Á': ['Hàn Quốc','Nhật Bản','VN'], 'Ngoài Châu Á': ['Úc','US', 'Canada'] };

const loader = document.getElementById('loading-overlay');
const showLoader = () => loader.classList.add('visible');
const hideLoader = () => loader.classList.remove('visible');

// Biến cho bảng và sắp xếp
let currentSummaryList = [], currentKpiList = [], currentModalSummaryList = [];
let summarySortState = { column: null, direction: 'asc' };
let kpiSortState = { column: null, direction: 'asc' };
let modalSortState = { column: null, direction: 'asc' };
let dailySortStates = {}; // Object để lưu trạng thái sort của từng bảng ngày

// Định nghĩa key sắp xếp cho các bảng
const summaryColumnSortKeys = {
1: { prop: 'team', type: 'string' }, 2: { prop: 'name', type: 'string' },
3: { prop: 'mess', type: 'number' }, 4: { prop: 'cpqc', type: 'number' },
5: { prop: 'don', type: 'number' }, 6: { prop: 'chot', type: 'number' },
7: { prop: (s) => s.mess ? s.don / s.mess : 0, type: 'number' },
8: { prop: (s) => s.mess ? s.cpqc / s.mess : 0, type: 'number' },
9: { prop: (s) => s.don ? s.cpqc / s.don : 0, type: 'number' },
10: { prop: (s) => s.chot ? s.cpqc / s.chot : 0, type: 'number' },
11: { prop: (s) => s.don ? s.chot / s.don : 0, type: 'number' }
};
const kpiColumnSortKeys = {
1: { prop: 'team', type: 'string' }, 2: { prop: 'name', type: 'string' },
3: { prop: 'cpqc', type: 'number' }, 4: { prop: 'dsChot', type: 'number' },
5: { prop: 'dsDi', type: 'number' }, 6: { prop: 'dsSauShip', type: 'number' },
7: { prop: 'dsThanhCong', type: 'number' },
8: { prop: (s) => s.dsSauShip ? s.cpqc / s.dsSauShip : 0, type: 'number' },
9: { prop: (s) => s.kpiValue ? s.dsSauShip / s.kpiValue : 0, type: 'number' }
};

// --- KHỞI TẠO & TẢI DỮ LIỆU ---
document.addEventListener('DOMContentLoaded', () => {
document.getElementById("defaultOpen").click();
addEventListeners();
setDefaultDates();
fetchAndProcessData();
});

function setDefaultDates() {
const today = new Date();
const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
const formatDateForInput = (date) => date.toISOString().split('T');

['start-date-tab1', 'start-date-tab2', 'start-date-tab3'].forEach(id => document.getElementById(id).value = formatDateForInput(firstDay));
['end-date-tab1', 'end-date-tab2', 'end-date-tab3'].forEach(id => document.getElementById(id).value = formatDateForInput(lastDay));
}

function addEventListeners() {
document.body.addEventListener('change', (e) => {
if (e.target.closest('#DetailedReport')) { handleTab1Filters(e.target); }
else if (e.target.closest('#KpiReport')) { handleTab3Filters(e.target); }
else if (e.target.closest('#DailyReport')) { handleTab2Filters(e.target); }
});

document.getElementById('summary-table').querySelector('thead').addEventListener('click', (e) => sortTable(e, 'summary'));
document.getElementById('kpi-summary-table').querySelector('thead').addEventListener('click', (e) => sortTable(e, 'kpi'));
document.getElementById('daily-breakdown').addEventListener('click', (e) => sortTable(e, 'daily')); // Event delegation
addModalEventListeners();
}

function addModalEventListeners() {
const modal = document.getElementById('daily-detail-modal');
const closeBtn = modal.querySelector('.close-button');
closeBtn.onclick = () => { modal.style.display = "none"; };
window.onclick = (event) => { if (event.target == modal) { modal.style.display = "none"; } };
document.getElementById('date-summary-body').addEventListener('click', (e) => {
const row = e.target.closest('tr');
if (row) showDailyDetailModal(row.cells.textContent.trim());
});
document.getElementById('modal-summary-table').querySelector('thead').addEventListener('click', (e) => sortTable(e, 'modal'));
}

function fetchAndProcessData() {
showLoader();
const salesDataUrl = 'https://script.google.com/macros/s/AKfycbwGwSBxeXplEzAM-jJDPaXPkiWjNyKmpR70o6nCY5_ynqoF-3WA1gvF91RIQQfDZ9fvAQ/exec';
const employeeDataUrl = 'https://script.google.com/macros/s/AKfycbzwOv7UFwrqzf88QJL1QrxLKcnnnSIQ_PSmF0SO8LboqWI5li3vF3W8_-8s-A8lNGaR/exec';

Promise.all([fetch(salesDataUrl).then(res => res.json()), fetch(employeeDataUrl).then(res => res.json())])
.then(([salesResult, employeeResult]) => {
masterData = salesResult
.filter(r => r.ten && String(r.ten).trim() !== '')
.map(r => ({ ...r, ngay: new Date(r.ngay), ten: (r.ten||'N/A').trim(), team: (r.team||'Khác').trim(), cpqc: +r.cpqc||0, soMessCmt: +r.soMessCmt||0, soDon: +r.soDon||0, dsChot: +r.dsChot||0, doanhSo: +r.doanhSoDi||0, doanhSoSauShip: +r.doanhSoSauShip||0, doanhsoTC: +r.doanhsoTC||0, kpis: +r.kpis||0 }));
employeeData = employeeResult;

const idFromUrl = new URLSearchParams(window.location.search).get('id');
if (idFromUrl) {
const currentUser = employeeData.find(emp => emp.idnv === idFromUrl);
if (currentUser) {
const memberName = (currentUser.ho_va_ten||'').trim(), teamName = (currentUser.team||'').trim();
if ((currentUser.vi_tri||'').trim().toLowerCase() === 'leader') {
document.getElementById('report-title-tab1').textContent = `DỮ LIỆU TEAM ${teamName}`;
baseDataForReport = masterData.filter(r => (r.team||'').trim() === teamName);
} else {
document.getElementById('report-title-tab1').textContent = `DỮ LIỆU CÁ NHÂN - ${memberName}`;
baseDataForReport = masterData.filter(r => (r.ten||'').trim() === memberName);
}
} else {
alert(`ID "${idFromUrl}" không hợp lệ.`);
document.getElementById('report-title-tab1').textContent = `KHÔNG TÌM THẤY DỮ LIỆU`;
baseDataForReport = [];
}
} else {
document.getElementById('report-title-tab1').textContent = 'DỮ LIỆU CHI PHÍ ADS';
baseDataForReport = masterData;
}

populateAllFilters(baseDataForReport.length > 0 ? baseDataForReport : masterData);
applyTab1Filters();
}).catch(err => { console.error("Lỗi:", err); alert('Không thể tải dữ liệu.'); }).finally(hideLoader);
}

function getFilteredData(tabPrefix) {
const sdVal = document.getElementById(`start-date-${tabPrefix}`).value;
const edVal = document.getElementById(`end-date-${tabPrefix}`).value;
const sd = sdVal ? new Date(sdVal + 'T00:00:00') : null;
const ed = edVal ? new Date(edVal + 'T23:59:59') : null;
const getSelected = (allId, cbClass) => !document.getElementById(allId)?.checked ? [...document.querySelectorAll(`.${cbClass}:checked`)].map(cb => cb.value) : null;
const selP = getSelected(`product-all-${tabPrefix}`, `filter-product-${tabPrefix}`);
const selM = getSelected(`market-all-${tabPrefix}`, `filter-market-${tabPrefix}`);
const selCa = (tabPrefix!=='tab2') ? getSelected(`ca-all-${tabPrefix}`, `filter-ca-${tabPrefix}`) : null;
const selT = (tabPrefix!=='tab2') ? getSelected(`team-all-${tabPrefix}`, `filter-team-${tabPrefix}`) : null;
return baseDataForReport.filter(r => {
const d = r.ngay; if (!d) return false;
const isDateOk = (!sd || d >= sd) && (!ed || d <= ed);
const isProductOk = !selP || selP.includes(r.sanPham);
const marketGroup = getGroup(normalize(r.thiTruong));
const isMarketOk = !selM || selM.includes(marketGroup) || selM.includes(r.thiTruong);
const isCaOk = !selCa || selCa.includes(r.ca);
const isTeamOk = !selT || selT.includes(r.team);
return isDateOk && isProductOk && isMarketOk && isCaOk && isTeamOk;
});
}

function populateAllFilters(data) {
const pSet=new Set(), caSet=new Set(), tSet=new Set(), mktSet=new Set();
(data||masterData).forEach(r => { if(r.sanPham) pSet.add(r.sanPham); if(r.ca) caSet.add(r.ca); if(r.team) tSet.add(r.team); if(r.thiTruong) mktSet.add(r.thiTruong); });
const simpleBoxes = (set, cls) => Array.from(set).sort().map(i => `<label class='indent'><input type='checkbox' class='${cls}' value='${i}' checked> ${i}</label>`).join('');
const marketBoxes = (cls) => Object.keys(groupChildren).map(g => `<label><input type='checkbox' class='${cls}' value='${g}' checked> <b>${g}</b></label>` + groupChildren[g].map(c => `<label class='indent'><input type='checkbox' class='${cls}' value='${c}' checked> ${c}</label>`).join('')).join('') + Array.from(mktSet).filter(m => !Object.values(groupChildren).flat().map(normalize).includes(normalize(m))).sort().map(m => `<label class='indent'><input type='checkbox' class='${cls}' value='${m}' checked> ${m}</label>`).join('');
['tab1', 'tab3'].forEach(p => {
document.getElementById(`product-options-${p}`).innerHTML = simpleBoxes(pSet,`filter-product-${p}`);
document.getElementById(`ca-options-${p}`).innerHTML = simpleBoxes(caSet, `filter-ca-${p}`);
document.getElementById(`team-options-${p}`).innerHTML = simpleBoxes(tSet, `filter-team-${p}`);
document.getElementById(`market-options-${p}`).innerHTML = marketBoxes(`filter-market-${p}`);
});
document.getElementById('product-options-tab2').innerHTML = simpleBoxes(pSet, 'filter-product-tab2');
document.getElementById('market-options-tab2').innerHTML = marketBoxes('filter-market-tab2');
}

// --- CÁC HÀM XỬ LÝ SỰ KIỆN ---
function handleTab1Filters(target) { showLoader(); setTimeout(() => { handleCheckbox('product-all-tab1', 'filter-product-tab1', target); handleCheckbox('ca-all-tab1', 'filter-ca-tab1', target); handleCheckbox('team-all-tab1', 'filter-team-tab1', target); handleCheckbox('market-all-tab1', 'filter-market-tab1', target); applyTab1Filters(); hideLoader(); }, 10); }
function handleTab3Filters(target) { showLoader(); setTimeout(() => { handleCheckbox('product-all-tab3', 'filter-product-tab3', target); handleCheckbox('ca-all-tab3', 'filter-ca-tab3', target); handleCheckbox('team-all-tab3', 'filter-team-tab3', target); handleCheckbox('market-all-tab3', 'filter-market-tab3', target); applyTab3Filters(); hideLoader(); }, 10); }
function handleTab2Filters(target) { showLoader(); setTimeout(() => { if (target.id === 'toggle-all-charts' || target.classList.contains('chart-toggle')) { if (target.id === 'toggle-all-charts') document.querySelectorAll('.chart-toggle').forEach(cb => cb.checked = target.checked); else document.getElementById('toggle-all-charts').checked = [...document.querySelectorAll('.chart-toggle')].every(cb => cb.checked); toggleChartVisibility(); hideLoader(); return; } handleCheckbox('product-all-tab2', 'filter-product-tab2', target); handleCheckbox('market-all-tab2', 'filter-market-tab2', target); applyDailyFilters(); hideLoader(); }, 10); }

// --- CÁC HÀM ÁP DỤNG BỘ LỌC ---
function applyTab1Filters() {
const filtered = getFilteredData('tab1');
currentSummaryList = generateSummaryTableData(filtered);
summarySortState = { column: null, direction: 'asc' };
sortAndRenderSummary();
renderDailyBreakdown(filtered);
}
function applyTab3Filters() {
const filtered = getFilteredData('tab3');
currentKpiList = generateKpiTableData(filtered);
kpiSortState = { column: null, direction: 'asc' };
sortAndRenderKpi();
}
function applyDailyFilters() { if (!masterData.length) return; const filtered = getFilteredData('tab2'); renderDailyTable(filtered); renderAllDailyCharts(filtered); }

// --- CÁC HÀM TẠO DỮ LIỆU BẢNG ---
function generateSummaryTableData(data) {
const summary = {}; data.forEach(r => { const n = r.ten; if (!summary[n]) summary[n] = { team: r.team, name:n, mess:0, don:0, chot:0, cpqc:0 }; summary[n].mess += r.soMessCmt; summary[n].don += r.soDon; summary[n].chot += r.dsChot; summary[n].cpqc += r.cpqc; });
return Object.values(summary).map(s => ({ ...s, rate: s.mess?s.don/s.mess:0, pm: s.mess?s.cpqc/s.mess:0, pd: s.don?s.cpqc/s.don:0, pc: s.chot?s.cpqc/s.chot:0, pdt: s.don?s.chot/s.don:0 }));
}
function generateKpiTableData(data) {
const sum = {}; data.forEach(r => { const m = r.ten; if (!sum[m]) sum[m] = { name: m, team: r.team, cpqc: 0, dsChot: 0, dsDi: 0, dsSauShip: 0, dsThanhCong: 0, kpiValue: r.kpis }; sum[m].cpqc += r.cpqc; sum[m].dsChot += r.dsChot; sum[m].dsDi += r.doanhSo; sum[m].dsSauShip += r.doanhSoSauShip; sum[m].dsThanhCong += r.doanhsoTC; });
return Object.values(sum);
}

// --- CÁC HÀM RENDER VÀ SẮP XẾP ---
function sortAndRenderSummary() { sortList(currentSummaryList, summarySortState, summaryColumnSortKeys, {prop: 'team', type: 'string'}); renderSummary(currentSummaryList); updateSortIcons(document.getElementById('summary-table'), summarySortState); }
function sortAndRenderKpi() { sortList(currentKpiList, kpiSortState, kpiColumnSortKeys, {prop: 'team', type: 'string'}); renderKpiSummary(currentKpiList); updateSortIcons(document.getElementById('kpi-summary-table'), kpiSortState); }
function sortAndRenderModal() { sortList(currentModalSummaryList, modalSortState, summaryColumnSortKeys, {prop: 'team', type: 'string'}); renderModalSummaryTable(currentModalSummaryList); updateSortIcons(document.getElementById('modal-summary-table'), modalSortState); }

function renderSummary(dataList) { const selM = [...document.querySelectorAll('.filter-market-tab1:checked')].map(cb => cb.value); const {bodyHtml} = generateSummaryTableHTML(dataList, selM); document.getElementById('summary-body').innerHTML = bodyHtml; document.getElementById('summary-foot').innerHTML = ''; }
function renderKpiSummary(dataList) {
let total = { cpqc: 0, dsChot: 0, dsDi: 0, dsSauShip: 0, dsThanhCong: 0, kpis: 0 };
const bodyRowsHtml = dataList.map((s, i) => {
total.cpqc += s.cpqc; total.dsChot += s.dsChot; total.dsDi += s.dsDi;
total.dsSauShip += s.dsSauShip; total.dsThanhCong += s.dsThanhCong; total.kpis += s.kpiValue;
const cpds = s.dsSauShip ? s.cpqc / s.dsSauShip : 0;
const kpiP = s.kpiValue ? s.dsSauShip / s.kpiValue : 0;
const cpdsClass = cpds > 0.33 ? 'bg-yellow' : '';
return `<tr><td class="text-center">${i+1}</td><td class="text-left">${s.team}</td><td class="text-left">${s.name}</td><td>${formatCurrency(s.cpqc)}</td><td>${formatCurrency(s.dsChot)}</td><td>${formatCurrency(s.dsDi)}</td><td>${formatCurrency(s.dsSauShip)}</td><td>${formatCurrency(s.dsThanhCong)}</td><td class="${cpdsClass}">${formatPercent(cpds)}</td><td>${formatPercent(kpiP)}</td></tr>`;
}).join('');

const totalCpds = total.dsSauShip ? total.cpqc / total.dsSauShip : 0;
const totalKpiP = total.kpis ? total.dsSauShip / total.kpis : 0;
const totalRowHtml = `<tr class="total-row"><td class="total-label" colspan="3">TỔNG CỘNG</td><td class="total-value">${formatCurrency(total.cpqc)}</td><td class="total-value">${formatCurrency(total.dsChot)}</td><td class="total-value">${formatCurrency(total.dsDi)}</td><td class="total-value">${formatCurrency(total.dsSauShip)}</td><td class="total-value">${formatCurrency(total.dsThanhCong)}</td><td class="total-value">${formatPercent(totalCpds)}</td><td class="total-value">${formatPercent(totalKpiP)}</td></tr>`;

document.getElementById('kpi-summary-body').innerHTML = totalRowHtml + bodyRowsHtml;
document.getElementById('kpi-summary-foot').innerHTML = '';
}

function renderDailyBreakdown(data) {
const container = document.getElementById('daily-breakdown'); container.innerHTML = '';
if (data.length === 0) { container.innerHTML = '<p style="text-align:center; margin-top: 20px;">Không có dữ liệu chi tiết.</p>'; return; }
const groupedByDate = {}; data.forEach(r => { const d = formatDate(r.ngay); (groupedByDate[d]||(groupedByDate[d]=[])).push(r); });
const sortedDates = Object.keys(groupedByDate).sort((a,b) => new Date(b.split('/').reverse().join('-')) - new Date(a.split('/').reverse().join('-')));
const selectedMarkets = [...document.querySelectorAll('.filter-market-tab1:checked')].map(cb => cb.value);
let finalHtml = sortedDates.map(date => {
let dailyList = generateSummaryTableData(groupedByDate[date]);
sortList(dailyList, {column:null, direction:'asc'}, summaryColumnSortKeys, {prop: 'team', type: 'string'});
const { bodyHtml } = generateSummaryTableHTML(dailyList, selectedMarkets);
return `<h3>${date}</h3><div class="table-responsive-container">
<table class="sortable-table daily-summary-table" data-date="${date}">
<thead><tr>
<th class="green-header">STT<span class="sort-icon"></span></th><th class="green-header">Team<span class="sort-icon"></span></th><th class="green-header">Marketing<span class="sort-icon"></span></th><th class="green-header">Số Mess<span class="sort-icon"></span></th><th class="green-header">CPQC<span class="sort-icon"></span></th><th class="green-header">Số Đơn<span class="sort-icon"></span></th><th class="green-header">DS Chốt<span class="sort-icon"></span></th>
<th class="yellow-header">Tỉ lệ chốt<span class="sort-icon"></span></th><th class="yellow-header">Giá Mess<span class="sort-icon"></span></th><th class="yellow-header">CPS<span class="sort-icon"></span></th><th class="yellow-header">%CP/DS<span class="sort-icon"></span></th><th class="yellow-header">Giá TB Đơn<span class="sort-icon"></span></th>
</tr></thead>
<tbody>${bodyHtml}</tbody>
</table>
</div>`;
}).join('');
container.innerHTML = finalHtml;
dailySortStates = {}; // Reset state khi render lại toàn bộ
}

// --- CÁC HÀM TIỆN ÍCH KHÁC (TABS, MODAL, SẮP XẾP) ---
function openTab(evt, tabName) {
document.querySelectorAll(".tab-content").forEach(tc => tc.style.display = "none");
document.querySelectorAll(".tablinks").forEach(tl => tl.classList.remove("active"));
document.getElementById(tabName).style.display = "block";
evt.currentTarget.classList.add("active");
if (tabName === 'KpiReport' && !currentKpiList.length) { applyTab3Filters(); }
if (tabName === 'DailyReport' && !charts.cpqcChart) { initAllCharts(); applyDailyFilters(); }
}

function sortTable(event, tableType) {
const th = event.target.closest('th'); if (!th) return;
const columnIndex = th.cellIndex;
if (columnIndex === 0) return; // Không sort cột STT

const stateMap = { summary: summarySortState, kpi: kpiSortState, modal: modalSortState };
const renderMap = { summary: sortAndRenderSummary, kpi: sortAndRenderKpi, modal: sortAndRenderModal };

if (tableType === 'daily') {
const table = th.closest('table');
const date = table.dataset.date;
if (!dailySortStates[date]) dailySortStates[date] = { column: null, direction: 'asc' };
let sortState = dailySortStates[date];
if (sortState.column === columnIndex) sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
else { sortState.column = columnIndex; sortState.direction = 'asc'; }
sortAndRenderDailyTable(table, date, sortState);
} else {
let sortState = stateMap[tableType];
if (sortState.column === columnIndex) sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
else { sortState.column = columnIndex; sortState.direction = 'asc'; }
renderMap[tableType]();
}
}

function sortAndRenderDailyTable(table, date, sortState) {
const dataForDay = getFilteredData('tab1').filter(r => formatDate(r.ngay) === date);
let dailyList = generateSummaryTableData(dataForDay);
sortList(dailyList, sortState, summaryColumnSortKeys, {prop: 'team', type: 'string'});
const selectedMarkets = [...document.querySelectorAll('.filter-market-tab1:checked')].map(cb => cb.value);
const { bodyHtml } = generateSummaryTableHTML(dailyList, selectedMarkets);
table.querySelector('tbody').innerHTML = bodyHtml;
updateSortIcons(table, sortState);
}

function sortList(list, sortState, columnKeys, defaultSortKey) {
const { column, direction } = sortState; const sortInfo = columnKeys[column];
list.sort((a, b) => {
const key = sortInfo || defaultSortKey;
let valA = typeof key.prop === 'function' ? key.prop(a) : a[key.prop];
let valB = typeof key.prop === 'function' ? key.prop(b) : b[key.prop];
if (valA == null) valA = key.type === 'string' ? '' : -Infinity;
if (valB == null) valB = key.type === 'string' ? '' : -Infinity;
let comparison = key.type === 'string' ? String(valA).localeCompare(String(valB)) : valA - valB;
if (!sortInfo) return comparison;
return direction === 'asc' ? comparison : -comparison;
});
}

function updateSortIcons(tableElement, sortState) {
tableElement.querySelectorAll('thead th').forEach((th, index) => {
const icon = th.querySelector('.sort-icon'); if (!icon) return;
icon.className = 'sort-icon'; th.classList.remove('sorted');
if (index === sortState.column) { th.classList.add('sorted'); icon.classList.add(sortState.direction); }
});
}

function showDailyDetailModal(dateString) {
document.getElementById('modal-title').textContent = `Báo cáo chi tiết ngày ${dateString}`;
const dataForDay = getFilteredData('tab2').filter(r => formatDate(r.ngay) === dateString);
currentModalSummaryList = generateSummaryTableData(dataForDay);
modalSortState = { column: null, direction: 'asc' };
sortAndRenderModal();
document.getElementById('daily-detail-modal').style.display = 'flex';
}

function renderModalSummaryTable(dataList) {
const selM = [...document.querySelectorAll('.filter-market-tab2:checked')].map(cb => cb.value);
const {bodyHtml} = generateSummaryTableHTML(dataList, selM);
document.getElementById('modal-summary-body').innerHTML = bodyHtml;
document.getElementById('modal-summary-foot').innerHTML = '';
}

function generateSummaryTableHTML(dataList, selectedMarkets) {
let total = { mess: 0, don: 0, chot: 0, cpqc: 0 };
const bodyRowsHtml = dataList.map((s, index) => {
total.mess += s.mess; total.don += s.don; total.chot += s.chot; total.cpqc += s.cpqc;
const rateClass = s.rate > 0.1 ? 'bg-green' : (s.rate > 0.05 ? 'bg-yellow' : '');
const cpsClass = getCpsCellStyle(s.pd, selectedMarkets);
const cpdsClass = s.pc > 0.33 ? 'bg-yellow' : '';
return `<tr><td class="text-center">${index + 1}</td><td class="text-left">${s.team}</td>
<td class="text-left">${s.name}</td><td>${s.mess.toLocaleString('vi-VN')}</td>
<td>${formatCurrency(s.cpqc)}</td><td>${s.don.toLocaleString('vi-VN')}</td><td>${formatCurrency(s.chot)}</td>
<td class="${rateClass}">${formatPercent(s.rate)}</td><td>${formatCurrency(s.pm)}</td>
<td class="${cpsClass}">${formatCurrency(s.pd)}</td><td class="${cpdsClass}">${formatPercent(s.pc)}</td><td>${formatCurrency(s.pdt)}</td></tr>`;
}).join('');

const tRate=total.mess?total.don/total.mess:0, tPm=total.mess?total.cpqc/total.mess:0, tPd=total.don?total.cpqc/total.don:0, tPc=total.chot?total.cpqc/total.chot:0, tPdt=total.don?total.chot/total.don:0;
const totalRowHtml = `<tr class="total-row"><td class="total-label" colspan="3">TỔNG CỘNG</td>
<td class="total-value">${total.mess.toLocaleString('vi-VN')}</td><td class="total-value">${formatCurrency(total.cpqc)}</td><td class="total-value">${total.don.toLocaleString('vi-VN')}</td><td class="total-value">${formatCurrency(total.chot)}</td>
<td class="total-value">${formatPercent(tRate)}</td><td class="total-value">${formatCurrency(tPm)}</td><td class="total-value">${formatCurrency(tPd)}</td><td class="total-value">${formatPercent(tPc)}</td><td class="total-value">${formatCurrency(tPdt)}</td></tr>`;

return { bodyHtml: totalRowHtml + bodyRowsHtml };
}

// --- CÁC HÀM TIỆN ÍCH KHÁC (BIỂU ĐỒ, ĐỊNH DẠNG...) ---
function normalize(s) { return (s||'').trim().toLowerCase(); }
function getGroup(norm) { for (let g in groupChildren) { if (groupChildren[g].map(normalize).includes(norm)) return g; } return null; }
function formatDate(v) { if (!(v instanceof Date) || isNaN(v)) return String(v); return `${String(v.getDate()).padStart(2,'0')}/${String(v.getMonth() + 1).padStart(2,'0')}/${v.getFullYear()}`; }
function formatCurrency(v) { return Number(v||0).toLocaleString('vi-VN',{style:'currency',currency:'VND'}); }
function formatPriceShort(v) { const n = Number(v||0); if (n >= 1e6) return (n/1e6).toFixed(1)+'tr'; if (n >= 1e3) return (n/1e3).toFixed(0)+'k'; return n.toLocaleString('vi-VN'); }
function formatPercent(v) { if (!isFinite(v)) return '0.00%'; return `${(Number(v||0) * 100).toFixed(2)}%`; }
function handleCheckbox(m, c, t) { const a = document.getElementById(m); if (!a) return; if (t.id === m) document.querySelectorAll(`.${c}`).forEach(cb => cb.checked = t.checked); else if (t.classList.contains(c)) a.checked = [...document.querySelectorAll(`.${c}`)].every(cb => cb.checked); }
function getCpsCellStyle(cps, selM) { const hasA = selM.some(m=>m==='Châu Á'||groupChildren['Châu Á'].includes(m)); const hasOA = selM.some(m=>m==='Ngoài Châu Á'||groupChildren['Ngoài Châu Á'].includes(m)); if (hasA && !hasOA && selM.length > 0) { if (cps > 1e6) return 'bg-lightred'; if (cps > 7e5) return 'bg-yellow'; } else { if (cps > 1.5e6) return 'bg-lightred'; if (cps > 1e6) return 'bg-yellow'; } return ''; }
function renderDailyTable(data) { const daily = {}; data.forEach(r => { const d=formatDate(r.ngay); if (!daily[d]) daily[d] = {cpqc:0,don:0,mess:0,chot:0}; daily[d].cpqc+=r.cpqc; daily[d].don+=r.soDon; daily[d].mess+=r.soMessCmt; daily[d].chot+=r.dsChot; }); let html = Object.keys(daily).sort((a,b) => new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-'))).map(d => { const day=daily[d]; const avg=day.mess?day.don/day.mess:0, gM=day.mess?day.cpqc/day.mess:0, cps=day.don?day.cpqc/day.don:0, cR=day.chot?day.cpqc/day.chot:0; return `<tr><td class="text-left"><b>${d}</b></td><td>${formatPriceShort(day.cpqc)}</td><td>${formatPriceShort(day.chot)}</td><td>${formatPercent(avg)}</td><td>${formatPriceShort(gM)}</td><td>${formatPriceShort(cps)}</td><td>${formatPercent(cR)}</td></tr>`; }).join(''); document.getElementById('date-summary-body').innerHTML = html; }
function toggleChartVisibility() { document.querySelectorAll('.chart-toggle').forEach(c => { const w = document.querySelector(`.chart-wrapper[data-chart="${c.dataset.chart}"]`); if (w) w.style.display = c.checked ? 'block' : 'none'; }); }
function initAllCharts() { const c = (id, cfg) => new Chart(document.getElementById(id).getContext('2d'), cfg); charts.cpqcChart = c('cpqcChart', getLineChartConfig('CPQC (VND)')); charts.dsChotChart = c('dsChotChart', getLineChartConfig('DS Chốt (VND)')); charts.rateChart = c('rateChart', getLineChartConfig('Tỉ lệ chốt (%)', formatPercent)); charts.messChart = c('messChart', getLineChartConfig('Giá Mess (VND)')); charts.cpsChart = c('cpsChart', getLineChartConfig('CPS (VND)')); charts.cpDsRatioChart = c('cpDsRatioChart', getLineChartConfig('%CP/DS', formatPercent)); charts.productSalesChart = c('productSalesChart', getBarChartConfig('DS theo Sản phẩm')); charts.marketSalesChart = c('marketSalesChart', getBarChartConfig('DS theo Thị trường')); toggleChartVisibility(); }
function renderAllDailyCharts(data) { if (!Object.keys(charts).length) return; const daily = {}; data.forEach(r => { const d=formatDate(r.ngay); if (!daily[d]) daily[d] = {cpqc:0,don:0,mess:0,chot:0}; daily[d].cpqc+=r.cpqc; daily[d].don+=r.soDon; daily[d].mess+=r.soMessCmt; daily[d].chot+=r.dsChot; }); const labels = Object.keys(daily).sort((a,b)=>new Date(a.split('/').reverse().join('-'))-new Date(b.split('/').reverse().join('-'))); const clrs = getChartColors(); updateChart(charts.cpqcChart, 'CPQC', labels, labels.map(d => daily[d].cpqc), clrs.cpqc); updateChart(charts.dsChotChart, 'DS Chốt', labels, labels.map(d => daily[d].chot), clrs.dsChot); updateChart(charts.rateChart, 'Tỉ lệ chốt', labels, labels.map(d=>daily[d].mess?daily[d].don/daily[d].mess:0), clrs.rate); updateChart(charts.messChart, 'Giá Mess', labels, labels.map(d=>daily[d].mess?daily[d].cpqc/daily[d].mess:0), clrs.mess); updateChart(charts.cpsChart, 'CPS', labels, labels.map(d=>daily[d].don?daily[d].cpqc/daily[d].don:0), clrs.cps); updateChart(charts.cpDsRatioChart, '%CP/DS', labels, labels.map(d=>daily[d].chot?daily[d].cpqc/daily[d].chot:0), clrs.cpDsRatio); const pSales={}, mSales={}; data.forEach(r => { if (r.sanPham) pSales[r.sanPham] = (pSales[r.sanPham]||0)+r.dsChot; if (r.thiTruong) mSales[r.thiTruong] = (mSales[r.thiTruong]||0)+r.dsChot; }); const sP = Object.entries(pSales).sort((a,b)=>b-a), sM = Object.entries(mSales).sort((a,b)=>b-a); updateChart(charts.productSalesChart, 'DS theo SP', sP.map(p=>p), sP.map(p=>p), clrs.product, 'bar'); updateChart(charts.marketSalesChart, 'DS theo TT', sM.map(m=>m), sM.map(m=>m), clrs.market, 'bar'); }
function getChartColors() { return { cpqc:{b:'#3F51B5',f:'rgba(63,81,181,0.2)'}, dsChot:{b:'#4CAF50',f:'rgba(76,175,80,0.2)'}, rate:{b:'#F44336',f:'rgba(244,67,54,0.2)'}, mess:{b:'#FF9800',f:'rgba(255,152,0,0.2)'}, cps:{b:'#009688',f:'rgba(0,150,136,0.2)'}, cpDsRatio:{b:'#9C27B0',f:'rgba(156,39,176,0.2)'}, product:{b:'#607D8B'}, market:{b:'#795548'} }; }
function getLineChartConfig(yTitle, formatter=formatPriceShort) { Chart.register(ChartDataLabels); return {type:'line',options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top',labels:{font:{size:14,weight:'500'},padding:20,usePointStyle:true,pointStyle:'circle'}},tooltip:{backgroundColor:'rgba(0,0,0,0.9)',titleFont:{size:16,weight:'bold'},bodyFont:{size:14},padding:12,cornerRadius:8,displayColors:true,boxPadding:6,callbacks:{label:(ctx)=>`${ctx.dataset.label}: ${formatter(ctx.raw)}`}},datalabels:{display:true,align:'top',anchor:'end',backgroundColor:(ctx)=>ctx.dataset.borderColor,borderColor:'#fff',borderWidth:1,borderRadius:12,color:'#fff',font:{weight:'bold',size:10},formatter,padding:6,offset:4}},interaction:{intersect:false,mode:'index'},scales:{x:{grid:{display:false,drawBorder:false},ticks:{font:{size:12},maxRotation:45,minRotation:45}},y:{title:{display:true,text:yTitle,font:{size:14,weight:'500'},padding:{top:10,bottom:20}},ticks:{callback:formatter,font:{size:12}},grid:{color:'rgba(0,0,0,0.05)',drawBorder:false}}},elements:{line:{borderWidth:3,tension:0.3},point:{radius:5,hoverRadius:8,hitRadius:10,backgroundColor:'#fff'}},layout:{padding:20}}};}
function getBarChartConfig(title) { Chart.register(ChartDataLabels); return {type:'bar',options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',plugins:{title:{display:true,text:title,font:{size:16,weight:'bold'},padding:{bottom:15}},legend:{display:false},tooltip:{backgroundColor:'rgba(0,0,0,0.9)',titleFont:{size:16,weight:'bold'},bodyFont:{size:14},padding:12,cornerRadius:8,displayColors:false,callbacks:{label:(ctx)=>`${formatCurrency(ctx.parsed.x)}`}},datalabels:{display:true,anchor:'end',align:'right',offset:8,color:'#333',font:{weight:'600',size:12},formatter:formatPriceShort}},scales:{x:{display:false,grid:{display:false}},y:{grid:{display:false},ticks:{font:{size:13,weight:'500'}}}},layout:{padding:{left:120,right:50,top:20,bottom:20}},barPercentage:0.8,categoryPercentage:0.9}};}
function updateChart(chart,label,labels,data,colors,type='line') { chart.data.labels = labels; chart.data.datasets = [{label,data,backgroundColor:type==='line'?colors.f:colors.b,borderColor:colors.b,type,fill:type==='line',borderWidth:type==='line'?3:1,pointRadius:type==='line'?5:undefined,pointBackgroundColor:'#fff',pointBorderWidth:2,borderRadius:type==='line'?0:4}]; chart.update('none'); }
</script>
</body>
</html>

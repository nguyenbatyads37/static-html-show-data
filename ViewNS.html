<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <title>Báo cáo chi phí tổng hợp</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    /* --- CÀI ĐẶT CHUNG & TABS --- */
    body {
      font-family: 'Roboto', Arial, sans-serif;
      padding: 20px;
      background-color: #f4f4f4;
      color: #333;
      font-size: 16px;
    }

    .tab-container {
      overflow: hidden;
      border-bottom: 2px solid #ccc;
      margin-bottom: 20px;
    }

    .tab-container button {
      background-color: #f1f1f1;
      float: left;
      border: none;
      outline: none;
      cursor: pointer;
      padding: 14px 20px;
      transition: 0.3s;
      font-size: 17px;
      font-weight: 500;
      border-radius: 8px 8px 0 0;
      margin-right: 5px;
    }

    .tab-container button:hover {
      background-color: #ddd;
    }

    .tab-container button.active {
      background-color: #2d7c2d;
      color: white;
    }

    .tab-content {
      display: none;
      padding: 6px 12px;
      border-top: none;
      animation: fadeIn 0.5s;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    /* --- STYLES CHUNG CHO BẢNG & CĂN LỀ --- */
    .table-responsive-container {
      overflow-x: auto;
      margin-bottom: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: auto;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    th,
    td {
      border: 1px solid #e0e0e0;
      padding: 12px 14px;
      white-space: nowrap;
      vertical-align: middle;
      transition: background-color 0.2s;
      font-size: 15px;
    }

    th {
      text-align: center !important;
      font-size: 16px;
    }

    td {
      text-align: right !important;
    }

    .text-left {
      text-align: left !important;
    }

    .text-center {
      text-align: center !important;
    }

    /* CẢI THIỆN KHẢ NĂNG ĐỌC BẢNG */
    tbody tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    tbody tr:not(.team-header-row):not(.total-row):not(.highlight):hover {
      background-color: #eff5fb;
    }

    th.green-header {
      background: #4CAF50;
      color: white;
      font-weight: 700;
    }

    th.blue-header {
      background: #4CAF50;
      color: white;
      font-weight: 700;
    }

    th.yellow-header {
      background: #FFC107;
      color: #424242;
      font-weight: 700;
    }

    tr.total-row,
    tr.total-row:hover {
      background: #2d7c2d;
      color: white;
      font-weight: 700;
      font-size: 1.2em;
      border-bottom: 3px solid #FFC107;
    }

    .total-row .total-label {
      text-transform: uppercase;
      text-align: left !important;
    }

    .total-row .total-value {
      text-align: right !important;
    }

    .bg-green {
      background-color: #4CAF50 !important;
      color: white;
    }

    .bg-yellow {
      background-color: #FFEB3B !important;
      color: #424242;
    }

    .bg-lightred {
      background-color: #F44336 !important;
      color: white;
    }

    .bg-lightblue {
      background-color: #2196F3 !important;
      color: white;
    }

    /* --- STYLES CHO TABS & LAYOUT CHUNG --- */
    .report-container {
      display: flex;
      gap: 20px;
    }

    .sidebar {
      width: 260px;
      flex-shrink: 0;
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .sidebar h3 {
      background: #2d7c2d;
      color: #fff;
      padding: 10px;
      margin-top: 10px;
      font-size: 18px;
      border-radius: 4px;
      font-weight: 700;
    }

    .sidebar label {
      display: block;
      margin: 8px 0;
      font-size: 15px;
      cursor: pointer;
    }

    .sidebar .indent {
      margin-left: 16px;
    }

    .sidebar input[type="date"],
    .sidebar select {
      width: 100%;
      box-sizing: border-box;
      padding: 8px;
      margin: 4px 0 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 15px;
    }

    .main-content-area {
      flex-grow: 1;
    }

    .header {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .header img {
      height: 60px;
      margin-right: 15px;
      border-radius: 50%;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    .header h2 {
      margin: 0;
      color: #2d7c2d;
      font-weight: 700;
      font-size: 28px;
    }

    /* --- STYLES TAB 2 (BIỂU ĐỒ) --- */
    .daily-report-layout {
      display: flex;
      gap: 20px;
    }

    .main-daily h2 {
      color: #2d7c2d;
      text-align: center;
      margin-bottom: 20px;
      font-weight: 700;
      font-size: 28px;
    }

    .chart-toggle-controls {
      margin: 20px 0;
      padding: 10px;
      background: #eee;
      border-radius: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: center;
    }

    .chart-toggle-controls label {
      font-size: 15px;
      cursor: pointer;
    }

    .chart-toggle-controls .toggle-all {
      font-weight: bold;
    }

    .charts-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .chart-wrapper {
      background: #fff;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
      transition: opacity 0.4s ease-in-out, display 0s 0.4s;
    }

    .chart-wrapper canvas {
      width: 100% !important;
      height: 350px !important;
      /* CHIỀU CAO BIỂU ĐỒ ĐÃ ĐƯỢC GIẢM */
    }

    #date-summary-body tr {
      cursor: pointer;
    }

    /* --- CHỈ BÁO ĐANG TẢI --- */
    #loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      font-size: 1.5em;
      font-weight: bold;
      color: #2d7c2d;
      transition: opacity 0.3s, visibility 0.3s;
      visibility: hidden;
      opacity: 0;
    }

    #loading-overlay.visible {
      visibility: visible;
      opacity: 1;
    }

    /* --- CSS CHO MODAL & SẮP XẾP BẢNG --- */
    .modal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.6);
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background-color: #fefefe;
      margin: auto;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      width: 90%;
      max-width: 1400px;
      /* Increased width for new columns */
      max-height: 90vh;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #ddd;
      padding-bottom: 15px;
      margin-bottom: 15px;
    }

    .modal-header h2 {
      margin: 0;
      color: #2d7c2d;
      font-size: 24px;
    }

    .close-button {
      color: #aaa;
      font-size: 30px;
      font-weight: bold;
      cursor: pointer;
    }

    .close-button:hover,
    .close-button:focus {
      color: black;
      text-decoration: none;
    }

    .modal-body {
      overflow-y: auto;
    }

    .sortable-table th {
      cursor: pointer;
      position: relative;
    }

    .sortable-table th .sort-icon {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.8em;
      opacity: 0.4;
      transition: opacity 0.2s;
    }

    .sortable-table th:hover .sort-icon {
      opacity: 0.8;
    }

    .sortable-table th.sorted .sort-icon {
      opacity: 1;
    }

    .sortable-table th .sort-icon.asc::after {
      content: " ▲";
    }

    .sortable-table th .sort-icon.desc::after {
      content: " ▼";
    }

    .daily-breakdown h3 {
      margin-top: 30px;
      background: #f0f0f0;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 18px;
      font-weight: 700;
    }

    /* === STYLES MỚI CHO TAB HIỆU QUẢ MKT (TỪ testbaocaotongceo.html) === */
    #MarketReport .report-header {
      text-align: center;
      margin-bottom: 20px;
      padding: 20px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    #MarketReport .report-title {
      font-size: 22px;
      font-weight: 700;
      color: #333;
      margin-bottom: 5px;
    }

    #MarketReport .report-date {
      color: #555;
      font-size: 16px;
    }

    #MarketReport .filter-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 20px;
      padding: 15px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      align-items: center;
    }

    #MarketReport .filter-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #MarketReport label {
      font-weight: 500;
      color: #333;
    }

    #MarketReport input[type="date"],
    #MarketReport select {
      padding: 8px 12px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      font-family: inherit;
      background-color: #fff;
    }

    #MarketReport select[multiple] {
      height: 120px;
      padding: 5px;
    }

    #MarketReport button#apply-filter-mkt {
      background-color: #2d7c2d;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.2s;
      padding: 8px 15px;
      border-radius: 4px;
    }

    #MarketReport button#apply-filter-mkt:hover {
      background-color: #1b4b1b;
    }

    #MarketReport th {
      background-color: #4CAF50;
      color: white;
    }

    #MarketReport .highlight {
      background-color: #e8f5e9 !important;
      font-weight: 600;
    }

    #MarketReport .section-title {
      font-size: 20px;
      font-weight: 600;
      color: #1b4b1b;
      margin: 25px 0 15px 0;
      padding-bottom: 8px;
      border-bottom: 2px solid #2d7c2d;
    }

    #MarketReport .mkt-charts-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }

    #MarketReport .chart-wrapper {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
    }

    #MarketReport .chart-wrapper canvas {
      width: 100% !important;
      height: 350px !important;
    }

    @media (max-width: 768px) {
      #MarketReport .filter-container {
        flex-direction: column;
        align-items: flex-start;
      }

      #MarketReport .mkt-charts-container {
        grid-template-columns: 1fr;
      }

      .charts-container {
        grid-template-columns: 1fr;
      }

    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
</head>

<body>
  <div id="loading-overlay">Đang tải dữ liệu...</div>
  <div class="tab-container">
    <button class="tablinks" onclick="openTab(event, 'DetailedReport')" id="defaultOpen">Báo cáo chi tiết</button>
    <button class="tablinks" onclick="openTab(event, 'KpiReport')">Báo cáo KPI</button>
    <button class="tablinks" onclick="openTab(event, 'DailyReport')">Báo cáo theo ngày</button>
    <button class="tablinks" onclick="openTab(event, 'MarketReport')">Hiệu quả MKT</button>
  </div>
  <!-- TAB 1: BÁO CÁO CHI TIẾT -->
  <div id="DetailedReport" class="tab-content">
    <div class="report-container">
      <div class="sidebar">
        <h3>Bộ lọc</h3>
        <label for="quick-date-select-tab1">Chọn nhanh:</label>
        <select id="quick-date-select-tab1">
          <option value="">-- Chọn nhanh --</option>
          <optgroup label="Ngày">
            <option value="today">Hôm nay</option>
            <option value="yesterday">Hôm qua</option>
          </optgroup>
          <optgroup label="Tuần">
            <option value="lastWeek">Tuần trước</option>
            <option value="thisWeek">Tuần này</option>
            <option value="nextWeek">Tuần sau</option>
          </optgroup>
          <optgroup label="Tháng">
            <option value="thisMonth">Tháng này</option>
            <option value="month_1">Tháng 1</option>
            <option value="month_2">Tháng 2</option>
            <option value="month_3">Tháng 3</option>
            <option value="month_4">Tháng 4</option>
            <option value="month_5">Tháng 5</option>
            <option value="month_6">Tháng 6</option>
            <option value="month_7">Tháng 7</option>
            <option value="month_8">Tháng 8</option>
            <option value="month_9">Tháng 9</option>
            <option value="month_10">Tháng 10</option>
            <option value="month_11">Tháng 11</option>
            <option value="month_12">Tháng 12</option>
          </optgroup>
          <optgroup label="Quý">
            <option value="quarter_1">Quý 1</option>
            <option value="quarter_2">Quý 2</option>
            <option value="quarter_3">Quý 3</option>
            <option value="quarter_4">Quý 4</option>
          </optgroup>
        </select>
        <label for="start-date-tab1">Từ ngày:</label><input type="date" id="start-date-tab1">
        <label for="end-date-tab1">Đến ngày:</label><input type="date" id="end-date-tab1">
        <h3>Sản phẩm</h3>
        <label><input type="checkbox" id="product-all-tab1" checked> Tất cả</label>
        <div id="product-options-tab1" class="indent"></div>
        <h3>Ca</h3>
        <label><input type="checkbox" id="ca-all-tab1" checked> Tất cả</label>
        <div id="ca-options-tab1" class="indent"></div>
        <h3>Team</h3>
        <label><input type="checkbox" id="team-all-tab1" checked> Tất cả</label>
        <div id="team-options-tab1" class="indent"></div>
        <h3>Thị trường</h3>
        <label><input type="checkbox" id="market-all-tab1" checked> Tất cả</label>
        <div id="market-options-tab1"></div>
      </div>
      <div class="main-content-area">
        <div class="header">
          <img
            src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Ff930e667.%E1%BA%A2nh.025539.jpg"
            alt="Logo">
          <h2 id="report-title-tab1">DỮ LIỆU CHI PHÍ ADS</h2>
        </div>
        <div class="table-responsive-container">
          <table id="summary-table" class="sortable-table">
            <thead>
              <tr>
                <th class="green-header">STT<span class="sort-icon"></span></th>
                <th class="green-header">Team<span class="sort-icon"></span></th>
                <th class="green-header">Marketing<span class="sort-icon"></span></th>
                <th class="green-header">Số Mess<span class="sort-icon"></span></th>
                <th class="green-header">CPQC<span class="sort-icon"></span></th>
                <th class="green-header">Số Đơn<span class="sort-icon"></span></th>
                <th class="blue-header">Số Đơn (TT)<span class="sort-icon"></span></th>
                <th class="green-header">DS Chốt<span class="sort-icon"></span></th>
                <th class="blue-header">DS Chốt (TT)<span class="sort-icon"></span></th>
                <th class="green-header">DS Đi<span class="sort-icon"></span></th>
                <th class="blue-header">DS Đi (TT)<span class="sort-icon"></span></th>
                <th class="yellow-header">Tỉ lệ chốt<span class="sort-icon"></span></th>
                <th class="yellow-header">Tỉ lệ chốt (TT)<span class="sort-icon"></span></th>
                <th class="yellow-header">Giá Mess<span class="sort-icon"></span></th>
                <th class="yellow-header">CPS<span class="sort-icon"></span></th>
                <th class="yellow-header">%CP/DS<span class="sort-icon"></span></th>
                <th class="yellow-header">Giá TB Đơn<span class="sort-icon"></span></th>
              </tr>
            </thead>
            <tbody id="summary-body"></tbody>
            <tfoot id="summary-foot"></tfoot>
          </table>
        </div>
        <div id="daily-breakdown"></div>
      </div>
    </div>
  </div>
  <!-- TAB 2: BÁO CÁO KPI -->
  <div id="KpiReport" class="tab-content">
    <div class="report-container">
      <div class="sidebar">
        <h3>Bộ lọc</h3>
        <label for="quick-date-select-tab3">Chọn nhanh:</label>
        <select id="quick-date-select-tab3">
          <option value="">-- Chọn nhanh --</option>
          <optgroup label="Ngày">
            <option value="today">Hôm nay</option>
            <option value="yesterday">Hôm qua</option>
          </optgroup>
          <optgroup label="Tuần">
            <option value="lastWeek">Tuần trước</option>
            <option value="thisWeek">Tuần này</option>
            <option value="nextWeek">Tuần sau</option>
          </optgroup>
          <optgroup label="Tháng">
            <option value="thisMonth">Tháng này</option>
            <option value="month_1">Tháng 1</option>
            <option value="month_2">Tháng 2</option>
            <option value="month_3">Tháng 3</option>
            <option value="month_4">Tháng 4</option>
            <option value="month_5">Tháng 5</option>
            <option value="month_6">Tháng 6</option>
            <option value="month_7">Tháng 7</option>
            <option value="month_8">Tháng 8</option>
            <option value="month_9">Tháng 9</option>
            <option value="month_10">Tháng 10</option>
            <option value="month_11">Tháng 11</option>
            <option value="month_12">Tháng 12</option>
          </optgroup>
          <optgroup label="Quý">
            <option value="quarter_1">Quý 1</option>
            <option value="quarter_2">Quý 2</option>
            <option value="quarter_3">Quý 3</option>
            <option value="quarter_4">Quý 4</option>
          </optgroup>
        </select>
        <label for="start-date-tab3">Từ ngày:</label><input type="date" id="start-date-tab3">
        <label for="end-date-tab3">Đến ngày:</label><input type="date" id="end-date-tab3">
        <h3>Sản phẩm</h3>
        <label><input type="checkbox" id="product-all-tab3" checked> Tất cả</label>
        <div id="product-options-tab3" class="indent"></div>
        <h3>Ca</h3>
        <label><input type="checkbox" id="ca-all-tab3" checked> Tất cả</label>
        <div id="ca-options-tab3" class="indent"></div>
        <h3>Team</h3>
        <label><input type="checkbox" id="team-all-tab3" checked> Tất cả</label>
        <div id="team-options-tab3" class="indent"></div>
        <h3>Thị trường</h3>
        <label><input type="checkbox" id="market-all-tab3" checked> Tất cả</label>
        <div id="market-options-tab3"></div>
      </div>
      <div class="main-content-area">
        <div class="header">
          <img
            src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Ff930e667.%E1%BA%A2nh.025539.jpg"
            alt="Logo">
          <h2>BÁO CÁO HIỆU SUẤT KPI</h2>
        </div>
        <div class="table-responsive-container">
          <table id="kpi-summary-table" class="sortable-table">
            <thead>
              <tr>
                <th class="green-header">STT<span class="sort-icon"></span></th>
                <th class="green-header">Team<span class="sort-icon"></span></th>
                <th class="green-header">Marketing<span class="sort-icon"></span></th>
                <th class="green-header">CPQC<span class="sort-icon"></span></th>
                <th class="green-header">DS Chốt<span class="sort-icon"></span></th>
                <th class="blue-header">DS Chốt (TT)<span class="sort-icon"></span></th>
                <th class="green-header">DS Đi<span class="sort-icon"></span></th>
                <th class="blue-header">DS Đi (TT)<span class="sort-icon"></span></th>
                <th class="green-header">Số đơn hủy<span class="sort-icon"></span></th>
                <th class="blue-header">Số đơn hủy (TT)<span class="sort-icon"></span></th>
                <th class="green-header">Doanh số Hủy<span class="sort-icon"></span></th>
                <th class="blue-header">Doanh số Hủy (TT)<span class="sort-icon"></span></th>
                <th class="green-header">DS Sau Ship<span class="sort-icon"></span></th>
                <th class="blue-header">DS Thành Công (TT)<span class="sort-icon"></span></th>
                <th class="green-header">DS Thành Công<span class="sort-icon"></span></th>
                <th class="yellow-header">%CP/DS<span class="sort-icon"></span></th>
                <th class="yellow-header">% KPI<span class="sort-icon"></span></th>
              </tr>
            </thead>
            <tbody id="kpi-summary-body"></tbody>
            <tfoot id="kpi-summary-foot"></tfoot>
          </table>
        </div>
      </div>
    </div>
  </div>
  <!-- TAB 3: BÁO CÁO THEO NGÀY (BIỂU ĐỒ) -->
  <div id="DailyReport" class="tab-content">
    <div class="main-daily">
      <h2>Báo cáo hiệu suất theo ngày</h2>
      <div class="daily-report-layout">
        <div class="sidebar">
          <h3>Bộ lọc</h3>
          <label for="quick-date-select-tab2">Chọn nhanh:</label>
          <select id="quick-date-select-tab2">
            <option value="">-- Chọn nhanh --</option>
            <optgroup label="Ngày">
              <option value="today">Hôm nay</option>
              <option value="yesterday">Hôm qua</option>
            </optgroup>
            <optgroup label="Tuần">
              <option value="lastWeek">Tuần trước</option>
              <option value="thisWeek">Tuần này</option>
              <option value="nextWeek">Tuần sau</option>
            </optgroup>
            <optgroup label="Tháng">
              <option value="thisMonth">Tháng này</option>
              <option value="month_1">Tháng 1</option>
              <option value="month_2">Tháng 2</option>
              <option value="month_3">Tháng 3</option>
              <option value="month_4">Tháng 4</option>
              <option value="month_5">Tháng 5</option>
              <option value="month_6">Tháng 6</option>
              <option value="month_7">Tháng 7</option>
              <option value="month_8">Tháng 8</option>
              <option value="month_9">Tháng 9</option>
              <option value="month_10">Tháng 10</option>
              <option value="month_11">Tháng 11</option>
              <option value="month_12">Tháng 12</option>
            </optgroup>
            <optgroup label="Quý">
              <option value="quarter_1">Quý 1</option>
              <option value="quarter_2">Quý 2</option>
              <option value="quarter_3">Quý 3</option>
              <option value="quarter_4">Quý 4</option>
            </optgroup>
          </select>
          <label for="start-date-tab2">Từ ngày:</label><input type="date" id="start-date-tab2">
          <label for="end-date-tab2">Đến ngày:</label><input type="date" id="end-date-tab2">
          <h3>Sản phẩm</h3>
          <label><input type="checkbox" id="product-all-tab2" checked> Tất cả</label>
          <div id="product-options-tab2" class="indent"></div>
          <h3>Thị trường</h3>
          <label><input type="checkbox" id="market-all-tab2" checked> Tất cả</label>
          <div id="market-options-tab2"></div>
        </div>
        <div class="main-content-area">
          <div class="table-responsive-container">
            <table id="date-summary-table">
              <thead>
                <tr>
                  <th>Ngày</th>
                  <th>Tổng CPQC</th>
                  <th>DS Chốt</th>
                  <th>DS Chốt thực tế</th>
                  <th>Tỉ lệ chốt TB</th>
                  <th>Giá Mess</th>
                  <th>CPS</th>
                  <th>%CP/DS</th>
                </tr>
              </thead>
              <tbody id="date-summary-body"></tbody>
            </table>
          </div>
          <!-- START: KHU VỰC ĐIỀU KHIỂN BIỂU ĐỒ MỚI -->
          <div class="chart-toggle-controls">
            <label class="toggle-all"><input type="checkbox" id="toggle-all-charts" checked> Chọn/Bỏ chọn tất
              cả</label>
            <label><input type="checkbox" class="chart-toggle" data-chart="cpqcChart" checked> CPQC</label>
            <label><input type="checkbox" class="chart-toggle" data-chart="dsChotChart" checked> DS Chốt</label>
            <label><input type="checkbox" class="chart-toggle" data-chart="dsDiChart" checked> DS Đi</label>
            <label><input type="checkbox" class="chart-toggle" data-chart="rateChart" checked> Tỉ lệ chốt</label>
            <label><input type="checkbox" class="chart-toggle" data-chart="messChart" checked> Giá Mess</label>
            <label><input type="checkbox" class="chart-toggle" data-chart="cpsChart" checked> CPS</label>
            <label><input type="checkbox" class="chart-toggle" data-chart="cpDsRatioChart" checked> %CP/DS</label>
            <label><input type="checkbox" class="chart-toggle" data-chart="productSalesChart" checked> DS theo Sản
              phẩm</label>
            <label><input type="checkbox" class="chart-toggle" data-chart="marketSalesChart" checked> DS theo Thị
              trường</label>
          </div>
          <!-- END: KHU VỰC ĐIỀU KHIỂN BIỂU ĐỒ MỚI -->
          <div class="charts-container">
            <div class="chart-wrapper" data-chart="cpqcChart"><canvas id="cpqcChart"></canvas></div>
            <div class="chart-wrapper" data-chart="dsChotChart"><canvas id="dsChotChart"></canvas></div>
            <div class="chart-wrapper" data-chart="dsDiChart"><canvas id="dsDiChart"></canvas></div>
            <div class="chart-wrapper" data-chart="rateChart"><canvas id="rateChart"></canvas></div>
            <div class="chart-wrapper" data-chart="messChart"><canvas id="messChart"></canvas></div>
            <div class="chart-wrapper" data-chart="cpsChart"><canvas id="cpsChart"></canvas></div>
            <div class="chart-wrapper" data-chart="cpDsRatioChart"><canvas id="cpDsRatioChart"></canvas></div>
            <div class="chart-wrapper" data-chart="productSalesChart"><canvas id="productSalesChart"></canvas></div>
            <div class="chart-wrapper" data-chart="marketSalesChart"><canvas id="marketSalesChart"></canvas></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- TAB 4: HIỆU QUẢ MKT (GIAO DIỆN MỚI) -->
  <div id="MarketReport" class="tab-content">
    <div class="report-header">
      <div class="report-title">THỐNG KÊ HIỆU QUẢ MARKETING THEO SẢN PHẨM & THỊ TRƯỜNG</div>
      <div class="report-date" id="report-date-mkt"></div>
    </div>
    <div class="filter-container">
      <div class="filter-group">
        <label for="quick-date-mkt">Chọn nhanh:</label>
        <select id="quick-date-mkt">
          <option value="">-- Tùy chọn --</option>
          <optgroup label="Tuần">
            <option value="lastWeek">Tuần trước</option>
            <option value="thisWeek">Tuần này</option>
          </optgroup>
          <optgroup label="Tháng">
            <option value="thisMonth">Tháng này</option>
            <option value="month_1">Tháng 1</option>
            <option value="month_2">Tháng 2</option>
            <option value="month_3">Tháng 3</option>
            <option value="month_4">Tháng 4</option>
            <option value="month_5">Tháng 5</option>
            <option value="month_6">Tháng 6</option>
            <option value="month_7">Tháng 7</option>
            <option value="month_8">Tháng 8</option>
            <option value="month_9">Tháng 9</option>
            <option value="month_10">Tháng 10</option>
            <option value="month_11">Tháng 11</option>
            <option value="month_12">Tháng 12</option>
          </optgroup>
          <optgroup label="Quý">
            <option value="quarter_1">Quý 1</option>
            <option value="quarter_2">Quý 2</option>
            <option value="quarter_3">Quý 3</option>
            <option value="quarter_4">Quý 4</option>
          </optgroup>
        </select>
      </div>
      <div class="filter-group"> <label for="start-date-mkt">Từ ngày:</label> <input type="date" id="start-date-mkt">
      </div>
      <div class="filter-group"> <label for="end-date-mkt">Đến ngày:</label> <input type="date" id="end-date-mkt">
      </div>
      <div class="filter-group"> <label for="market-filter-mkt">Thị trường:</label> <select id="market-filter-mkt"
          multiple></select> </div>
      <div class="filter-group"> <label for="product-filter-mkt">Sản phẩm:</label> <select id="product-filter-mkt"
          multiple></select> </div>
      <button id="apply-filter-mkt">Áp dụng</button>
    </div>

    <div id="non-asia-market-mkt" style="display: none;">
      <div class="section-title">THỊ TRƯỜNG NGOÀI CHÂU Á</div>
      <div class="table-responsive-container">
        <table id="non-asia-table-mkt">
          <thead>
            <tr>
              <th>Sản phẩm</th>
              <th>Thị trường</th>
              <th class="text-right">CPQC</th>
              <th class="text-center">Số đơn</th>
              <th class="text-center">Số đơn (TT)</th>
              <th class="text-center">Số mess</th>
              <th class="text-right">DS Chốt</th>
              <th class="text-right">DS Chốt (TT)</th>
              <th class="text-right">DS Sau Hoàn Hủy</th>
              <th class="text-right">DS Sau HH (TT)</th>
              <th class="text-center">%CP/DS (Sau HH)</th>
              <th class="text-right">CPS</th>
              <th class="text-right">Giá đơn TB</th>
              <th class="text-center">Tỉ lệ chốt</th>
              <th class="text-center">Tỉ lệ chốt (TT)</th>
            </tr>
          </thead>
          <tbody id="non-asia-body-mkt"></tbody>
        </table>
      </div>
    </div>
    <div id="asia-market-mkt" style="display: none;">
      <div class="section-title">THỊ TRƯỜNG CHÂU Á</div>
      <div class="table-responsive-container">
        <table id="asia-table-mkt">
          <thead>
            <tr>
              <th>Sản phẩm</th>
              <th>Thị trường</th>
              <th class="text-right">CPQC</th>
              <th class="text-center">Số đơn</th>
              <th class="text-center">Số đơn (TT)</th>
              <th class="text-center">Số mess</th>
              <th class="text-right">DS Chốt</th>
              <th class="text-right">DS Chốt (TT)</th>
              <th class="text-right">DS Sau Hoàn Hủy</th>
              <th class="text-right">DS Sau HH (TT)</th>
              <th class="text-center">%CP/DS (Sau HH)</th>
              <th class="text-right">CPS</th>
              <th class="text-right">Giá đơn TB</th>
              <th class="text-center">Tỉ lệ chốt</th>
              <th class="text-center">Tỉ lệ chốt (TT)</th>
            </tr>
          </thead>
          <tbody id="asia-body-mkt"></tbody>
        </table>
      </div>
    </div>
    <div id="summary-mkt" style="display: none;">
      <div class="section-title">TỔNG HỢP TẤT CẢ THỊ TRƯỜNG</div>
      <div class="table-responsive-container">
        <table id="summary-table-mkt">
          <thead>
            <tr>
              <th>Sản phẩm</th>
              <th></th>
              <th class="text-right">CPQC</th>
              <th class="text-center">Số đơn</th>
              <th class="text-center">Số đơn (TT)</th>
              <th class="text-center">Số mess</th>
              <th class="text-right">DS Chốt</th>
              <th class="text-right">DS Chốt (TT)</th>
              <th class="text-right">DS Sau Hoàn Hủy</th>
              <th class="text-right">DS Sau HH (TT)</th>
              <th class="text-center">%CP/DS (Sau HH)</th>
              <th class="text-right">CPS</th>
              <th class="text-right">Giá đơn TB</th>
              <th class="text-center">Tỉ lệ chốt</th>
              <th class="text-center">Tỉ lệ chốt (TT)</th>
            </tr>
          </thead>
          <tbody id="summary-body-mkt"></tbody>
        </table>
      </div>
    </div>

    <div id="mkt-charts-section" style="display: none;">
      <div class="section-title">BIỂU ĐỒ TRỰC QUAN</div>
      <div class="mkt-charts-container">
        <div class="chart-wrapper"><canvas id="mktProductSalesChart"></canvas></div>
        <div class="chart-wrapper"><canvas id="mktProductDsChotChart"></canvas></div>
        <div class="chart-wrapper"><canvas id="mktProductCpqcChart"></canvas></div>
        <div class="chart-wrapper"><canvas id="mktProductCpsChart"></canvas></div>
        <div class="chart-wrapper"><canvas id="mktProductClosingRateChart"></canvas></div>
        <div class="chart-wrapper"><canvas id="mktProductCostRatioChart"></canvas></div>
      </div>
    </div>
  </div>
  <!-- Cấu trúc HTML cho Modal -->
  <div id="daily-detail-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-title">Chi tiết ngày</h2>
        <span class="close-button">&times;</span>
      </div>
      <div class="modal-body">
        <div class="table-responsive-container">
          <table id="modal-summary-table" class="sortable-table">
            <thead>
              <tr>
                <th class="green-header">STT <span class="sort-icon"></span></th>
                <th class="green-header">Team <span class="sort-icon"></span></th>
                <th class="green-header">Marketing <span class="sort-icon"></span></th>
                <th class="green-header">Số Mess <span class="sort-icon"></span></th>
                <th class="green-header">CPQC <span class="sort-icon"></span></th>
                <th class="green-header">Số Đơn <span class="sort-icon"></span></th>
                <th class="blue-header">Số Đơn (TT)<span class="sort-icon"></span></th>
                <th class="green-header">DS Chốt <span class="sort-icon"></span></th>
                <th class="blue-header">DS Chốt (TT)<span class="sort-icon"></span></th>
                <th class="green-header">DS Đi <span class="sort-icon"></span></th>
                <th class="blue-header">DS Đi (TT)<span class="sort-icon"></span></th>
                <th class="yellow-header">Tỉ lệ chốt <span class="sort-icon"></span></th>
                <th class="yellow-header">Tỉ lệ chốt (TT)<span class="sort-icon"></span></th>
                <th class="yellow-header">Giá Mess <span class="sort-icon"></span></th>
                <th class="yellow-header">CPS <span class="sort-icon"></span></th>
                <th class="yellow-header">%CP/DS <span class="sort-icon"></span></th>
                <th class="yellow-header">Giá TB Đơn <span class="sort-icon"></span></th>
              </tr>
            </thead>
            <tbody id="modal-summary-body"></tbody>
            <tfoot id="modal-summary-foot"></tfoot>
          </table>
        </div>
      </div>
    </div>
  </div>
  <script>
    // =================================================================================
    // --- I. KHAI BÁO BIẾN TOÀN CỤC & CẤU HÌNH ---
    // =================================================================================

    /**
    * @description URL của API để lấy dữ liệu báo cáo.
    */
    const API_URL = 'https://script.google.com/macros/s/AKfycbzzIdrTfo9mH5OmTBHfd4yUP5nn1zIoll8McvhWeihTdlVGcyTB46dQ_g1OWpkJJnSj/exec?tableName=Báo cáo MKT';

    /**
    * @description Mảng màu sắc để sử dụng cho các biểu đồ, giúp phân biệt các danh mục.
    */
    const CHART_COLORS = [
      '#4CAF50', '#2196F3', '#FFC107', '#F44336', '#9C27B0', '#009688',
      '#FF9800', '#795548', '#607D8B', '#E91E63', '#3F51B5', '#8BC34A'
    ];

    /**
    * @description Cấu trúc nhóm các thị trường để lọc và hiển thị.
    */
    const MARKET_GROUPS = {
      'Châu Á': ['Hàn Quốc', 'Nhật Bản', 'VN'],
      'Ngoài Châu Á': ['Úc', 'US', 'Canada']
    };

    // --- Biến lưu trữ trạng thái (State) của ứng dụng ---
    let masterData = [];
    let baseDataForReport = [];
    const charts = {};
    const sortStates = {
      summary: { column: null, direction: 'asc' },
      kpi: { column: null, direction: 'asc' },
      modal: { column: null, direction: 'asc' },
      daily: {}
    };

    /**
    * @description Cấu hình các key để sắp xếp cho từng cột trong bảng Báo cáo chi tiết.
    */
    const summaryColumnSortKeys = {
      1: { prop: 'team', type: 'string' },
      2: { prop: 'name', type: 'string' },
      3: { prop: 'mess', type: 'number' },
      4: { prop: 'cpqc', type: 'number' },
      5: { prop: 'don', type: 'number' },
      6: { prop: 'donThucTe', type: 'number' },
      7: { prop: 'chot', type: 'number' },
      8: { prop: 'chotThucTe', type: 'number' },
      9: { prop: 'dsDi', type: 'number' },
      10: { prop: 'dsDiThucTe', type: 'number' },
      11: { prop: (s) => s.mess ? s.don / s.mess : 0, type: 'number' }, // Tỉ lệ chốt
      12: { prop: (s) => s.mess ? s.donThucTe / s.mess : 0, type: 'number' }, // Tỉ lệ chốt (TT)
      13: { prop: (s) => s.mess ? s.cpqc / s.mess : 0, type: 'number' }, // Giá Mess
      14: { prop: (s) => s.don ? s.cpqc / s.don : 0, type: 'number' },   // CPS
      15: { prop: (s) => s.chot ? s.cpqc / s.chot : 0, type: 'number' }, // %CP/DS
      16: { prop: (s) => s.don ? s.chot / s.don : 0, type: 'number' }  // Giá TB Đơn
    };


    /**
    * @description Cấu hình các key để sắp xếp cho từng cột trong bảng Báo cáo KPI.
    */
    const kpiColumnSortKeys = {
      1: { prop: 'team', type: 'string' },
      2: { prop: 'name', type: 'string' },
      3: { prop: 'cpqc', type: 'number' },
      4: { prop: 'dsChot', type: 'number' },
      5: { prop: 'dsChotThucTe', type: 'number' },
      6: { prop: 'dsDi', type: 'number' },
      7: { prop: 'dsDiThucTe', type: 'number' },
      8: { prop: 'soDonHuy', type: 'number' },
      9: { prop: 'soDonHuyThucTe', type: 'number' },
      10: { prop: 'doanhSoHuy', type: 'number' },
      11: { prop: 'dsHoanHuyThucTe', type: 'number' },
      12: { prop: 'dsSauShip', type: 'number' },
      13: { prop: 'dsThanhCongThucTe', type: 'number' }, // Updated from dsSauHoanHuyThucTe
      14: { prop: 'dsThanhCong', type: 'number' },
      15: { prop: (s) => s.dsSauShip ? s.cpqc / s.dsSauShip : 0, type: 'number' }, // %CP/DS
      16: { prop: (s) => s.kpiValue ? s.dsSauShip / s.kpiValue : 0, type: 'number' } // % KPI
    };


    // =================================================================================
    // --- II. KHỞI TẠO ỨNG DỤNG ---
    // =================================================================================

    document.addEventListener('DOMContentLoaded', () => {
      // SỬA LỖI: Đăng ký plugin datalabels trên toàn cục
      Chart.register(ChartDataLabels);

      setupEventListeners();
      setDefaultDates();
      fetchAndProcessData();
      document.getElementById("defaultOpen").click();
    });

    function setDefaultDates() {
      const today = new Date();
      const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
      const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
      const formatDateForInput = (date) => date.toISOString().split('T')[0];

      const dateInputs = [
        'start-date-tab1', 'end-date-tab1',
        'start-date-tab2', 'end-date-tab2',
        'start-date-tab3', 'end-date-tab3',
        'start-date-mkt', 'end-date-mkt'
      ];

      dateInputs.forEach(id => {
        const el = document.getElementById(id);
        if (id.startsWith('start-')) {
          el.value = formatDateForInput(firstDay);
        } else {
          el.value = formatDateForInput(lastDay);
        }
      });
    }

    // UPDATED function
    function setupEventListeners() {
      document.querySelectorAll('.tablinks').forEach(tab => {
        tab.addEventListener('click', (e) => openTab(e, tab.getAttribute('onclick').match(/'([^']+)'/)[1]));
      });

      // The main listener for all filter changes (checkboxes, date inputs, selects)
      document.body.addEventListener('change', handleFilterChange);

      // The "Apply" button in Tab 4 is now redundant because filters apply immediately.
      // We remove its click listener and hide it.
      const applyMktButton = document.getElementById('apply-filter-mkt');
      if (applyMktButton) {
        // Cloning and replacing the node is a robust way to remove all listeners
        const newButton = applyMktButton.cloneNode(true);
        applyMktButton.parentNode.replaceChild(newButton, applyMktButton);
        newButton.style.display = 'none';
      }

      // Sorting table listeners
      document.getElementById('summary-table').querySelector('thead').addEventListener('click', (e) => sortTable(e, 'summary'));
      document.getElementById('kpi-summary-table').querySelector('thead').addEventListener('click', (e) => sortTable(e, 'kpi'));
      document.getElementById('modal-summary-table').querySelector('thead').addEventListener('click', (e) => sortTable(e, 'modal'));
      document.getElementById('daily-breakdown').addEventListener('click', (e) => {
        if (e.target.closest('th')) {
          sortTable(e, 'daily');
        }
      });

      setupModalEventListeners();
    }


    function setupModalEventListeners() {
      const modal = document.getElementById('daily-detail-modal');
      const closeBtn = modal.querySelector('.close-button');
      closeBtn.onclick = () => { modal.style.display = "none"; };
      window.onclick = (event) => { if (event.target == modal) { modal.style.display = "none"; } };
      document.getElementById('date-summary-body').addEventListener('click', (e) => {
        const row = e.target.closest('tr');
        const dateText = row?.cells[0]?.textContent.trim();
        if (dateText) {
          showDailyDetailModal(dateText);
        }
      });
    }


    // =================================================================================
    // --- III. TẢI VÀ XỬ LÝ DỮ LIỆU ---
    // =================================================================================

    async function fetchAndProcessData() {
      showLoader();
      try {
        const response = await fetch(API_URL);
        const result = await response.json();

        masterData = result.data
          .filter(r => r["Tên"] && String(r["Tên"]).trim() !== '')
          .map(r => {
            const dsChot = Number(r["DS chốt"]) || 0;
            const dsSauHoanHuy = Number(r["DS sau hoàn hủy"]) || 0;
            return {
              idnv: (r["id_NS"] || '').trim(),
              ten: (r["Tên"] || 'N/A').trim(),
              ngay: new Date(r["Ngày"]),
              ca: (r["ca"] || 'N/A').trim(),
              sanPham: (r["Sản_phẩm"] || 'N/A').trim(),
              thiTruong: (r["Thị_trường"] || 'N/A').trim(),
              team: (r["Team"] || 'Khác').trim(),
              chucVu: (r["Chức vụ"] || '').trim().toLowerCase(),
              cpqc: Number(r["CPQC"]) || 0,
              soMessCmt: Number(r["Số_Mess_Cmt"]) || 0,
              soDon: Number(r["Số đơn"]) || 0,
              dsChot: dsChot,
              dsDi: Number(r["Doanh số đi"]) || 0,
              soDonHuy: Number(r["Số đơn hoàn hủy"]) || 0,
              doanhSoHuy: dsChot - dsSauHoanHuy,
              dsSauHoanHuy: dsSauHoanHuy,
              dsSauShip: Number(r["Doanh số sau ship"]) || 0,
              dsThanhCong: Number(r["Doanh số TC"]) || 0,
              kpiValue: Number(r["KPIs"]) || 0,
              // Dữ liệu thực tế
              soDonThucTe: Number(r["Số đơn thực tế"]) || 0,
              dsChotThucTe: Number(r["Doanh thu chốt thực tế"]) || 0,
              dsDiThucTe: Number(r["Doanh số đi thực tế"]) || 0,
              dsHoanHuyThucTe: Number(r["Doanh số hoàn hủy thực tế"]) || 0,
              soDonHuyThucTe: Number(r["Số đơn hoàn hủy thực tế"]) || 0,
              dsSauHoanHuyThucTe: Number(r["Doanh số sau hoàn hủy thực tế"]) || 0,
              dsThanhCongThucTe: Number(r["Doanh số đi thực tế"]) || 0, // Added for KPI report
            };
          });

        setupInitialReportView();
        populateAllFilters();
        applyTab1Filters();
      } catch (err) {
        console.error("Lỗi tải dữ liệu:", err);
        alert('Không thể tải dữ liệu từ API. Vui lòng kiểm tra lại.');
        document.getElementById('report-title-tab1').textContent = `LỖI TẢI DỮ LIỆU`;
      } finally {
        hideLoader();
      }
    }

    function setupInitialReportView() {
      const idFromUrl = new URLSearchParams(window.location.search).get('id');
      if (!idFromUrl) {
        document.getElementById('report-title-tab1').textContent = 'DỮ LIỆU CHI PHÍ ADS';
        baseDataForReport = masterData;
        return;
      }
      const currentUser = masterData.find(emp => emp.idnv === idFromUrl);
      if (currentUser) {
        if (currentUser.chucVu === 'leader') {
          document.getElementById('report-title-tab1').textContent = `DỮ LIỆU TEAM ${currentUser.team}`;
          baseDataForReport = masterData.filter(r => (r.team || '').trim() === currentUser.team);
        } else {
          document.getElementById('report-title-tab1').textContent = `DỮ LIỆU CÁ NHÂN - ${currentUser.ten}`;
          baseDataForReport = masterData.filter(r => (r.ten || '').trim() === currentUser.ten);
        }
      } else {
        alert(`ID "${idFromUrl}" không hợp lệ.`);
        document.getElementById('report-title-tab1').textContent = `KHÔNG TÌM THẤY DỮ LIỆU`;
        baseDataForReport = [];
      }
    }


    // =================================================================================
    // --- IV. XỬ LÝ SỰ KIỆN VÀ BỘ LỌC (REVISED BASED ON mẫu.html) ---
    // =================================================================================

    /**
     * Utility function to manage the state of "select all" checkboxes and their children.
     * From mẫu.html.
     * @param {string} allId - The ID of the "select all" checkbox.
     * @param {string} childClass - The class name shared by all child checkboxes.
     * @param {HTMLElement} target - The element that triggered the event.
     */
    function handleCheckbox(allId, childClass, target) {
      const allCheckbox = document.getElementById(allId);
      if (!allCheckbox) return;

      if (target.id === allId) {
        // Case 1: The "select all" checkbox was clicked.
        // Update all child checkboxes to match its state.
        document.querySelectorAll(`.${childClass}`).forEach(cb => cb.checked = target.checked);
      } else if (target.classList.contains(childClass)) {
        // Case 2: A child checkbox was clicked.
        // Check if all children are now checked and update the "select all" checkbox accordingly.
        const allChildren = document.querySelectorAll(`.${childClass}`);
        allCheckbox.checked = [...allChildren].every(cb => cb.checked);
      }
    }

    // Specific handler for Tab 1 filters
    function handleTab1Filters(target) {
      handleCheckbox('product-all-tab1', 'filter-product-tab1', target);
      handleCheckbox('ca-all-tab1', 'filter-ca-tab1', target);
      handleCheckbox('team-all-tab1', 'filter-team-tab1', target);
      handleCheckbox('market-all-tab1', 'filter-market-tab1', target);
      applyTab1Filters();
    }

    // Specific handler for Tab 3 filters
    function handleTab3Filters(target) {
      handleCheckbox('product-all-tab3', 'filter-product-tab3', target);
      handleCheckbox('ca-all-tab3', 'filter-ca-tab3', target);
      handleCheckbox('team-all-tab3', 'filter-team-tab3', target);
      handleCheckbox('market-all-tab3', 'filter-market-tab3', target);
      applyTab3Filters();
    }

    // Specific handler for Tab 2 filters
    function handleTab2Filters(target) {
      handleCheckbox('product-all-tab2', 'filter-product-tab2', target);
      handleCheckbox('market-all-tab2', 'filter-market-tab2', target);
      applyDailyFilters();
    }

    // Main event handler that delegates to the correct function
    function handleFilterChange(e) {
      const target = e.target;
      const container = target.closest('.tab-content');
      if (!container) return;

      // Handle special cases first
      if (target.matches('select[id^="quick-date"]')) {
        handleQuickDateChange(e);
        return;
      }
      if (target.matches('#toggle-all-charts, .chart-toggle')) {
        handleChartToggle(target);
        return;
      }

      // Show loader and delegate to the appropriate handler with a small delay
      // to allow the UI to update (e.g., the checkbox to show its new state).
      showLoader();
      setTimeout(() => {
        switch (container.id) {
          case 'DetailedReport':
            handleTab1Filters(target);
            break;
          case 'KpiReport':
            handleTab3Filters(target);
            break;
          case 'DailyReport':
            handleTab2Filters(target);
            break;
          case 'MarketReport':
            // For Tab 4, which uses multi-selects, just apply the filters on any change.
            applyTab4Filters();
            break;
        }
        hideLoader();
      }, 50);
    }

    function handleQuickDateChange(event) {
      const selection = event.target.value;
      if (!selection) return;

      const { startDate, endDate } = getDateRange(selection);
      const formattedStart = startDate.toLocaleDateString('en-CA');
      const formattedEnd = endDate.toLocaleDateString('en-CA');

      const tabId = event.target.closest('.tab-content')?.id ||
        (event.target.id.includes('mkt') ? 'MarketReport' :
          event.target.id.includes('tab1') ? 'DetailedReport' :
            event.target.id.includes('tab2') ? 'DailyReport' : 'KpiReport');

      let startDateId, endDateId;
      if (tabId === 'MarketReport') {
        startDateId = 'start-date-mkt';
        endDateId = 'end-date-mkt';
      } else if (tabId === 'DailyReport') {
        startDateId = 'start-date-tab2';
        endDateId = 'end-date-tab2';
      } else if (tabId === 'KpiReport') {
        startDateId = 'start-date-tab3';
        endDateId = 'end-date-tab3';
      } else {
        startDateId = 'start-date-tab1';
        endDateId = 'end-date-tab1';
      }

      document.getElementById(startDateId).value = formattedStart;
      document.getElementById(endDateId).value = formattedEnd;

      // Manually trigger the change event to apply the filter
      document.getElementById(startDateId).dispatchEvent(new Event('change', { bubbles: true }));
    }


    function getFilteredData(tabPrefix) {
      const isMktTab = tabPrefix === 'mkt';
      const startDateVal = document.getElementById(`start-date-${tabPrefix}`).value;
      const endDateVal = document.getElementById(`end-date-${tabPrefix}`).value;
      const startDate = startDateVal ? new Date(startDateVal) : null;
      const endDate = endDateVal ? new Date(endDateVal) : null;

      if ((startDate && isNaN(startDate)) || (endDate && isNaN(endDate))) return [];

      let selectedProducts, selectedMarkets, selectedCas, selectedTeams;
      if (isMktTab) {
        selectedProducts = Array.from(document.getElementById('product-filter-mkt').selectedOptions).map(opt => opt.value);
        selectedMarkets = Array.from(document.getElementById('market-filter-mkt').selectedOptions).map(opt => opt.value);
      } else {
        const getSelected = (type) => {
          const allCheckbox = document.getElementById(`${type}-all-${tabPrefix}`);
          if (!allCheckbox || allCheckbox.checked) return [];
          return Array.from(document.querySelectorAll(`.filter-${type}-${tabPrefix}:checked`)).map(cb => cb.value);
        };
        selectedProducts = getSelected('product');
        selectedMarkets = getSelected('market');
        selectedCas = tabPrefix !== 'tab2' ? getSelected('ca') : [];
        selectedTeams = tabPrefix !== 'tab2' ? getSelected('team') : [];
      }

      // Áp dụng bộ lọc và lưu kết quả vào một biến
      const filteredDataResult = baseDataForReport.filter(r => {
        const date = new Date(r.ngay);                // Ép kiểu ngày
        if (!r.ngay || isNaN(date)) return false;     // Loại nếu không có hoặc sai định dạng
        const isDateOk =
          (!startDate || date >= startDate) &&
          (!endDate || date <= endDate);
        if (!isDateOk) return false;


        const isProductOk = selectedProducts.length === 0 || selectedProducts.includes(r.sanPham);
        if (!isProductOk) return false;

        const marketGroup = getMarketGroup(normalize(r.thiTruong));
        const isMarketOk = selectedMarkets.length === 0 || selectedMarkets.includes(r.thiTruong) || selectedMarkets.includes(marketGroup);
        if (!isMarketOk) return false;

        if (isMktTab) return true;

        if (tabPrefix === 'tab2' && r.ca !== 'Hết ca') return false;

        const isCaOk = (tabPrefix === 'tab2' || selectedCas.length === 0) || selectedCas.includes(r.ca);
        if (!isCaOk) return false;

        const isTeamOk = (tabPrefix === 'tab2' || selectedTeams.length === 0) || selectedTeams.includes(r.team);
        if (!isTeamOk) return false;

        return true;
      });

      // Trả về dữ liệu đã được lọc
      return filteredDataResult;
    }

    function populateAllFilters() {
      if (!masterData.length) return;

      const products = [...new Set(masterData.map(r => r.sanPham).filter(Boolean))].sort();
      const cas = [...new Set(masterData.map(r => r.ca).filter(Boolean))].sort();
      const teams = [...new Set(masterData.map(r => r.team).filter(Boolean))].sort();
      const markets = [...new Set(masterData.map(r => r.thiTruong).filter(Boolean))].sort();

      const createCheckboxes = (items, className) => items.map(item => `<label class='indent'><input type='checkbox' class='${className}' value='${item}' checked> ${item}</label>`).join('');
      const createMarketCheckboxes = (className) => {
        let html = '';
        Object.keys(MARKET_GROUPS).forEach(group => {
          html += `<label><input type='checkbox' class='${className} filter-market-group' value='${group}' checked> <b>${group}</b></label>`;
          html += MARKET_GROUPS[group].map(child => `<label class='indent'><input type='checkbox' class='${className}' value='${child}' checked> ${child}</label>`).join('');
        });
        const ungroupedMarkets = markets.filter(m => !Object.values(MARKET_GROUPS).flat().map(normalize).includes(normalize(m)));
        html += createCheckboxes(ungroupedMarkets, className);
        return html;
      };

      ['tab1', 'tab3'].forEach(prefix => {
        document.getElementById(`product-options-${prefix}`).innerHTML = createCheckboxes(products, `filter-product-${prefix}`);
        document.getElementById(`ca-options-${prefix}`).innerHTML = createCheckboxes(cas, `filter-ca-${prefix}`);
        document.getElementById(`team-options-${prefix}`).innerHTML = createCheckboxes(teams, `filter-team-${prefix}`);
        document.getElementById(`market-options-${prefix}`).innerHTML = createMarketCheckboxes(`filter-market-${prefix}`);
      });
      document.getElementById(`product-options-tab2`).innerHTML = createCheckboxes(products, `filter-product-tab2`);
      document.getElementById(`market-options-tab2`).innerHTML = createMarketCheckboxes(`filter-market-tab2`);

      const createOptions = (items) => items.map(item => `<option value="${item}">${item}</option>`).join('');
      document.getElementById('product-filter-mkt').innerHTML = createOptions(products);
      document.getElementById('market-filter-mkt').innerHTML = createOptions(markets);
    }

    // =================================================================================
    // --- V. CÁC HÀM ÁP DỤNG BỘ LỌC CHO TỪNG TAB ---
    // =================================================================================

    function applyTab1Filters() {
      const filteredData = getFilteredData('tab1');
      const summaryList = generateSummaryTableData(filteredData);
      sortList(summaryList, sortStates.summary, summaryColumnSortKeys, { prop: 'team', type: 'string' });
      renderSummary(summaryList);
      updateSortIcons(document.getElementById('summary-table'), sortStates.summary);
      renderDailyBreakdown(filteredData);
    }

    function applyTab3Filters() {
      const filteredData = getFilteredData('tab3');
      const kpiList = generateKpiTableData(filteredData);
      sortList(kpiList, sortStates.kpi, kpiColumnSortKeys, { prop: 'team', type: 'string' });
      renderKpiSummary(kpiList);
      updateSortIcons(document.getElementById('kpi-summary-table'), sortStates.kpi);
    }

    function applyDailyFilters() {
      if (!masterData.length) return;
      const filteredData = getFilteredData('tab2');
      renderDailyTable(filteredData);
      renderAllDailyCharts(filteredData);
    }

    function applyTab4Filters() {
      showLoader();
      try {
        setTimeout(() => {
          const startDateVal = document.getElementById('start-date-mkt').value;
          const endDateVal = document.getElementById('end-date-mkt').value;
          if (!startDateVal || !endDateVal) {
            hideLoader();
            return;
          }
          document.getElementById('report-date-mkt').textContent = `Từ ngày ${formatDate(new Date(startDateVal))} đến ngày ${formatDate(new Date(endDateVal))}`;
          const filteredData = getFilteredData('mkt');
          const asiaData = [], nonAsiaData = [];
          const nonAsiaMarketsLower = MARKET_GROUPS['Ngoài Châu Á'].map(m => m.toLowerCase());
          filteredData.forEach(record => {
            if (nonAsiaMarketsLower.includes((record.thiTruong || '').toLowerCase())) {
              nonAsiaData.push(record);
            } else {
              asiaData.push(record);
            }
          });
          renderMktTable(nonAsiaData, 'non-asia', true);
          renderMktTable(asiaData, 'asia', true);
          renderMktTable(filteredData, 'summary', false);
          const chartSection = document.getElementById('mkt-charts-section');
          if (filteredData.length > 0) {
            chartSection.style.display = 'block';
            renderMktCharts(filteredData);
          } else {
            chartSection.style.display = 'none';
          }
        }, 10);
      } catch (error) {
        console.error("Lỗi xảy ra khi áp dụng bộ lọc Tab 4:", error);
        alert("Đã có lỗi xảy ra. Vui lòng thử lại.");
      } finally {
        setTimeout(hideLoader, 50);
      }
    }


    // =================================================================================
    // --- VI. CÁC HÀM TÍNH TOÁN VÀ TỔNG HỢP DỮ LIỆU ---
    // =================================================================================

    function generateSummaryTableData(data) {
      const summary = {};
      data.forEach(r => {
        const key = r.ten || 'N/A';
        if (!summary[key]) {
          summary[key] = {
            team: r.team, name: r.ten, mess: 0, don: 0, chot: 0, cpqc: 0, dsDi: 0,
            donThucTe: 0, chotThucTe: 0, dsDiThucTe: 0
          };
        }
        const S = summary[key];
        S.mess += r.soMessCmt;
        S.don += r.soDon;
        S.chot += r.dsChot;
        S.cpqc += r.cpqc;
        S.dsDi += r.dsDi;
        S.donThucTe += r.soDonThucTe;
        S.chotThucTe += r.dsChotThucTe;
        S.dsDiThucTe += r.dsDiThucTe;
      });
      return Object.values(summary);
    }

    function generateKpiTableData(data) {
      const summary = {};
      data.forEach(r => {
        const key = r.ten || 'N/A';
        if (!summary[key]) {
          summary[key] = {
            name: r.ten, team: r.team, cpqc: 0, dsChot: 0, dsDi: 0,
            soDonHuy: 0, doanhSoHuy: 0, dsSauShip: 0, dsThanhCong: 0, kpiValue: 0,
            dsChotThucTe: 0, dsDiThucTe: 0, soDonHuyThucTe: 0, dsHoanHuyThucTe: 0, dsSauHoanHuyThucTe: 0,
            dsThanhCongThucTe: 0
          };
        }
        const S = summary[key];
        S.cpqc += r.cpqc; S.dsChot += r.dsChot; S.dsDi += r.dsDi;
        S.dsSauShip += r.dsSauShip; S.dsThanhCong += r.dsThanhCong;
        S.kpiValue += r.kpiValue; S.soDonHuy += r.soDonHuy; S.doanhSoHuy += r.doanhSoHuy;
        S.dsChotThucTe += r.dsChotThucTe; S.dsDiThucTe += r.dsDiThucTe;
        S.soDonHuyThucTe += r.soDonHuyThucTe; S.dsHoanHuyThucTe += r.dsHoanHuyThucTe;
        S.dsSauHoanHuyThucTe += r.dsSauHoanHuyThucTe;
        S.dsThanhCongThucTe += r.dsThanhCongThucTe;
      });
      return Object.values(summary);
    }

    // =================================================================================
    // --- VII. CÁC HÀM HIỂN THỊ DỮ LIỆU (RENDERING) ---
    // =================================================================================

    function renderSummary(dataList) {
      const selM = [...document.querySelectorAll('.filter-market-tab1:checked')].map(cb => cb.value);
      const { bodyHtml } = generateSummaryTableHTML(dataList, selM);
      document.getElementById('summary-body').innerHTML = bodyHtml;
      document.getElementById('summary-foot').innerHTML = '';
    }

    function renderKpiSummary(dataList) {
      let total = { cpqc: 0, dsChot: 0, dsDi: 0, soDonHuy: 0, doanhSoHuy: 0, dsSauShip: 0, dsThanhCong: 0, kpis: 0, dsChotThucTe: 0, dsDiThucTe: 0, soDonHuyThucTe: 0, dsHoanHuyThucTe: 0, dsSauHoanHuyThucTe: 0, dsThanhCongThucTe: 0 };
      const bodyRowsHtml = dataList.map((s, i) => {
        Object.keys(total).forEach(key => total[key] += s[key] || 0);
        const cpds = s.dsSauShip ? s.cpqc / s.dsSauShip : 0, kpiP = s.kpiValue ? s.dsSauShip / s.kpiValue : 0, cpdsClass = cpds > 0.33 ? 'bg-yellow' : '';
        return `<tr>
                <td class="text-center">${i + 1}</td>
                <td class="text-left">${s.team}</td>
                <td class="text-left">${s.name}</td>
                <td>${formatCurrency(s.cpqc)}</td>
                <td>${formatCurrency(s.dsChot)}</td>
                <td>${formatCurrency(s.dsChotThucTe)}</td>
                <td>${formatCurrency(s.dsDi)}</td>
                <td>${formatCurrency(s.dsDiThucTe)}</td>
                <td>${formatNumber(s.soDonHuy)}</td>
                <td>${formatNumber(s.soDonHuyThucTe)}</td>
                <td>${formatCurrency(s.doanhSoHuy)}</td>
                <td>${formatCurrency(s.dsHoanHuyThucTe)}</td>
                <td>${formatCurrency(s.dsSauShip)}</td>
                <td>${formatCurrency(s.dsThanhCongThucTe)}</td>
                <td>${formatCurrency(s.dsThanhCong)}</td>
                <td class="${cpdsClass}">${formatPercent(cpds)}</td>
                <td>${formatPercent(kpiP)}</td>
            </tr>`;
      }).join('');
      const totalCpds = total.dsSauShip ? total.cpqc / total.dsSauShip : 0, totalKpiP = total.kpis ? total.dsSauShip / total.kpis : 0;
      const totalRowHtml = `<tr class="total-row">
            <td class="total-label" colspan="3">TỔNG CỘNG</td>
            <td class="total-value">${formatCurrency(total.cpqc)}</td>
            <td class="total-value">${formatCurrency(total.dsChot)}</td>
            <td class="total-value">${formatCurrency(total.dsChotThucTe)}</td>
            <td class="total-value">${formatCurrency(total.dsDi)}</td>
            <td class="total-value">${formatCurrency(total.dsDiThucTe)}</td>
            <td class="total-value">${formatNumber(total.soDonHuy)}</td>
            <td class="total-value">${formatNumber(total.soDonHuyThucTe)}</td>
            <td class="total-value">${formatCurrency(total.doanhSoHuy)}</td>
            <td class="total-value">${formatCurrency(total.dsHoanHuyThucTe)}</td>
            <td class="total-value">${formatCurrency(total.dsSauShip)}</td>
            <td class="total-value">${formatCurrency(total.dsThanhCongThucTe)}</td>
            <td class="total-value">${formatCurrency(total.dsThanhCong)}</td>
            <td class="total-value">${formatPercent(totalCpds)}</td>
            <td class="total-value">${formatPercent(totalKpiP)}</td>
        </tr>`;
      document.getElementById('kpi-summary-body').innerHTML = totalRowHtml + bodyRowsHtml;
      document.getElementById('kpi-summary-foot').innerHTML = '';
    }

    function renderMktTable(data, prefix, showMarket) {
      const container = document.getElementById(`${prefix}-market-mkt`);
      const tableBody = document.getElementById(`${prefix}-body-mkt`);
      if (!container || !tableBody) return;
      container.style.display = data.length > 0 ? 'block' : 'none';
      if (data.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="15" class="text-center">Không có dữ liệu.</td></tr>`;
        if (prefix === 'summary') document.getElementById('summary-mkt').style.display = 'block';
        return;
      }

      const productGroups = {};
      data.forEach(r => {
        const productKey = r.sanPham || 'Chưa xác định';
        const marketKey = showMarket ? (r.thiTruong || 'Không xác định') : '_';
        if (!productGroups[productKey]) productGroups[productKey] = {};
        if (!productGroups[productKey][marketKey]) {
          productGroups[productKey][marketKey] = { cpqc: 0, soDon: 0, soDonThucTe: 0, soMessCmt: 0, dsChot: 0, dsChotThucTe: 0, dsSauHoanHuy: 0, dsSauHoanHuyThucTe: 0 };
        }
        const group = productGroups[productKey][marketKey];
        group.cpqc += r.cpqc;
        group.soDon += r.soDon;
        group.soDonThucTe += r.soDonThucTe;
        group.soMessCmt += r.soMessCmt;
        group.dsChot += r.dsChot;
        group.dsChotThucTe += r.dsChotThucTe;
        group.dsSauHoanHuy += r.dsSauHoanHuy;
        group.dsSauHoanHuyThucTe += r.dsSauHoanHuyThucTe;
      });

      const grandTotal = { cpqc: 0, soDon: 0, soDonThucTe: 0, soMessCmt: 0, dsChot: 0, dsChotThucTe: 0, dsSauHoanHuy: 0, dsSauHoanHuyThucTe: 0 };
      let tableHtml = '';
      Object.keys(productGroups).sort().forEach(product => {
        const markets = productGroups[product];
        const productTotal = { cpqc: 0, soDon: 0, soDonThucTe: 0, soMessCmt: 0, dsChot: 0, dsChotThucTe: 0, dsSauHoanHuy: 0, dsSauHoanHuyThucTe: 0 };
        Object.keys(markets).sort().forEach(market => {
          const marketData = markets[market];
          tableHtml += createMktRow(product, market, marketData, showMarket);
          Object.keys(productTotal).forEach(key => productTotal[key] += marketData[key]);
        });
        if (showMarket && Object.keys(markets).length > 1) {
          tableHtml += createMktRow(product, 'Tổng', productTotal, showMarket, 'highlight');
        }
        Object.keys(grandTotal).forEach(key => grandTotal[key] += productTotal[key]);
      });
      tableBody.innerHTML = createMktRow('TỔNG CỘNG', '', grandTotal, showMarket, 'total-row') + tableHtml;
    }

    function createMktRow(productName, marketName, data, showMarket, className = '') {
      const costPercent = data.dsSauHoanHuy ? data.cpqc / data.dsSauHoanHuy : 0;
      const cps = data.soDon ? data.cpqc / data.soDon : 0;
      const avgOrderValue = data.soDon ? data.dsSauHoanHuy / data.soDon : 0;
      const closingRate = data.soMessCmt ? data.soDon / data.soMessCmt : 0;
      const closingRateThucTe = data.soMessCmt ? data.soDonThucTe / data.soMessCmt : 0;
      const rateClass = closingRate > 0.1 ? 'bg-green' : (closingRate > 0.05 ? 'bg-yellow' : '');
      const rateThucTeClass = closingRateThucTe > 0.1 ? 'bg-green' : (closingRateThucTe > 0.05 ? 'bg-yellow' : '');
      const isTotalRow = className.includes('total-row');
      const productCell = isTotalRow ? `<td class="total-label" colspan="2">${productName}</td>` : `<td class="text-left">${productName}</td>`;
      const marketCell = showMarket && !isTotalRow ? `<td class="text-left">${marketName}</td>` : (isTotalRow ? '' : '<td></td>');
      return `<tr class="${className}">
            ${productCell} ${marketCell}
            <td>${formatCurrency(data.cpqc)}</td>
            <td class="text-center">${formatNumber(data.soDon)}</td>
            <td class="text-center">${formatNumber(data.soDonThucTe)}</td>
            <td class="text-center">${formatNumber(data.soMessCmt)}</td>
            <td>${formatCurrency(data.dsChot)}</td>
            <td>${formatCurrency(data.dsChotThucTe)}</td>
            <td>${formatCurrency(data.dsSauHoanHuy)}</td>
            <td>${formatCurrency(data.dsSauHoanHuyThucTe)}</td>
            <td class="text-center">${formatPercent(costPercent)}</td>
            <td>${formatCurrency(cps)}</td>
            <td>${formatCurrency(avgOrderValue)}</td>
            <td class="text-center ${rateClass}">${formatPercent(closingRate)}</td>
            <td class="text-center ${rateThucTeClass}">${formatPercent(closingRateThucTe)}</td>
        </tr>`;
    }

    function renderDailyBreakdown(filteredData) {
      const container = document.getElementById('daily-breakdown'); container.innerHTML = '';
      if (filteredData.length === 0) { container.innerHTML = '<p style="text-align:center; margin-top: 20px;">Không có dữ liệu chi tiết.</p>'; return; }
      const groupedByDate = {};
      filteredData.forEach(r => {
        const d = formatDate(r.ngay);
        if (!groupedByDate[d]) groupedByDate[d] = [];
        groupedByDate[d].push(r);
      });
      const sortedDates = Object.keys(groupedByDate).sort((a, b) => new Date(b.split('/').reverse().join('-')) - new Date(a.split('/').reverse().join('-')));
      const selectedMarkets = [...document.querySelectorAll('.filter-market-tab1:checked')].map(cb => cb.value);
      let finalHtml = sortedDates.map(date => {
        let dailyList = generateSummaryTableData(groupedByDate[date]);
        sortList(dailyList, { column: null, direction: 'asc' }, summaryColumnSortKeys, { prop: 'team', type: 'string' });
        const { bodyHtml } = generateSummaryTableHTML(dailyList, selectedMarkets);
        return `<h3>${date}</h3><div class="table-responsive-container"><table class="sortable-table daily-summary-table" data-date="${date}">
        <thead><tr>
        <th class="green-header">STT<span class="sort-icon"></span></th>
        <th class="green-header">Team<span class="sort-icon"></span></th>
        <th class="green-header">Marketing<span class="sort-icon"></span></th>
        <th class="green-header">Số Mess<span class="sort-icon"></span></th>
        <th class="green-header">CPQC<span class="sort-icon"></span></th>
        <th class="green-header">Số Đơn<span class="sort-icon"></span></th>
        <th class="blue-header">Số Đơn (TT)<span class="sort-icon"></span></th>
        <th class="green-header">DS Chốt<span class="sort-icon"></span></th>
        <th class="blue-header">DS Chốt (TT)<span class="sort-icon"></span></th>
        <th class="green-header">DS Đi<span class="sort-icon"></span></th>
        <th class="blue-header">DS Đi (TT)<span class="sort-icon"></span></th>
        <th class="yellow-header">Tỉ lệ chốt<span class="sort-icon"></span></th>
        <th class="yellow-header">Tỉ lệ chốt (TT)<span class="sort-icon"></span></th>
        <th class="yellow-header">Giá Mess<span class="sort-icon"></span></th>
        <th class="yellow-header">CPS<span class="sort-icon"></span></th>
        <th class="yellow-header">%CP/DS<span class="sort-icon"></span></th>
        <th class="yellow-header">Giá TB Đơn<span class="sort-icon"></span></th>
        </tr></thead><tbody>${bodyHtml}</tbody></table></div>`;
      }).join('');
      container.innerHTML = finalHtml;
      sortStates.daily = {};
    }

    function generateSummaryTableHTML(dataList, selectedMarkets) {
      let total = { mess: 0, don: 0, chot: 0, cpqc: 0, dsDi: 0, donThucTe: 0, chotThucTe: 0, dsDiThucTe: 0 };
      const bodyRowsHtml = dataList.map((s, index) => {
        Object.keys(total).forEach(key => total[key] += s[key] || 0);
        const rate = s.mess ? s.don / s.mess : 0;
        const rateThucTe = s.mess ? s.donThucTe / s.mess : 0;
        const pm = s.mess ? s.cpqc / s.mess : 0;
        const pd = s.don ? s.cpqc / s.don : 0;
        const pc = s.chot ? s.cpqc / s.chot : 0;
        const pdt = s.don ? s.chot / s.don : 0;
        const rateClass = rate > 0.1 ? 'bg-green' : (rate > 0.05 ? 'bg-yellow' : '');
        const rateThucTeClass = rateThucTe > 0.1 ? 'bg-green' : (rateThucTe > 0.05 ? 'bg-yellow' : '');
        const cpsClass = getCpsCellStyle(pd, selectedMarkets);
        const cpdsClass = pc > 0.33 ? 'bg-yellow' : '';
        return `<tr>
                <td class="text-center">${index + 1}</td>
                <td class="text-left">${s.team}</td>
                <td class="text-left">${s.name}</td>
                <td>${formatNumber(s.mess)}</td>
                <td>${formatCurrency(s.cpqc)}</td>
                <td>${formatNumber(s.don)}</td>
                <td>${formatNumber(s.donThucTe)}</td>
                <td>${formatCurrency(s.chot)}</td>
                <td>${formatCurrency(s.chotThucTe)}</td>
                <td>${formatCurrency(s.dsDi)}</td>
                <td>${formatCurrency(s.dsDiThucTe)}</td>
                <td class="${rateClass}">${formatPercent(rate)}</td>
                <td class="${rateThucTeClass}">${formatPercent(rateThucTe)}</td>
                <td>${formatCurrency(pm)}</td>
                <td class="${cpsClass}">${formatCurrency(pd)}</td>
                <td class="${cpdsClass}">${formatPercent(pc)}</td>
                <td>${formatCurrency(pdt)}</td>
            </tr>`;
      }).join('');
      const tRate = total.mess ? total.don / total.mess : 0;
      const tRateThucTe = total.mess ? total.donThucTe / total.mess : 0;
      const tPm = total.mess ? total.cpqc / total.mess : 0;
      const tPd = total.don ? total.cpqc / total.don : 0;
      const tPc = total.chot ? total.cpqc / total.chot : 0;
      const tPdt = total.don ? total.chot / total.don : 0;
      const totalRowHtml = `<tr class="total-row">
            <td class="total-label" colspan="3">TỔNG CỘNG</td>
            <td class="total-value">${formatNumber(total.mess)}</td>
            <td class="total-value">${formatCurrency(total.cpqc)}</td>
            <td class="total-value">${formatNumber(total.don)}</td>
            <td class="total-value">${formatNumber(total.donThucTe)}</td>
            <td class="total-value">${formatCurrency(total.chot)}</td>
            <td class="total-value">${formatCurrency(total.chotThucTe)}</td>
            <td class="total-value">${formatCurrency(total.dsDi)}</td>
            <td class="total-value">${formatCurrency(total.dsDiThucTe)}</td>
            <td class="total-value">${formatPercent(tRate)}</td>
            <td class="total-value">${formatPercent(tRateThucTe)}</td>
            <td class="total-value">${formatCurrency(tPm)}</td>
            <td class="total-value">${formatCurrency(tPd)}</td>
            <td class="total-value">${formatPercent(tPc)}</td>
            <td class="total-value">${formatCurrency(tPdt)}</td>
        </tr>`;
      return { bodyHtml: totalRowHtml + bodyRowsHtml };
    }


    // =================================================================================
    // --- VIII. LOGIC SẮP XẾP BẢNG ---
    // =================================================================================

    function sortTable(event, tableType) {
      const th = event.target.closest('th');
      if (!th) return;
      let columnIndex = th.cellIndex;
      if (columnIndex === 0) return; // Không sắp xếp cột STT

      let sortState;
      let tableElement = th.closest('table');

      if (tableType === 'daily') {
        const date = tableElement.dataset.date;
        if (!sortStates.daily[date]) sortStates.daily[date] = { column: null, direction: 'asc' };
        sortState = sortStates.daily[date];
      } else {
        sortState = sortStates[tableType];
      }

      if (sortState.column === columnIndex) {
        sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
      } else {
        sortState.column = columnIndex;
        sortState.direction = 'asc';
      }

      if (tableType === 'daily') {
        sortAndRenderDailyTable(tableElement, sortState);
      } else if (tableType === 'summary') {
        applyTab1Filters();
      } else if (tableType === 'kpi') {
        applyTab3Filters();
      } else if (tableType === 'modal') {
        const dateString = document.getElementById('modal-title').textContent.split(' ').pop();
        const filteredData = getFilteredData('tab2');
        const dailyData = filteredData.filter(r => formatDate(r.ngay) === dateString);
        const modalDataList = generateSummaryTableData(dailyData);
        sortList(modalDataList, sortStates.modal, summaryColumnSortKeys);
        renderModalSummaryTable(modalDataList);
        updateSortIcons(document.getElementById('modal-summary-table'), sortStates.modal);
      }
    }

    function sortAndRenderDailyTable(table, sortState) {
      const date = table.dataset.date;
      const filteredData = getFilteredData('tab1');
      const dailyData = filteredData.filter(r => formatDate(r.ngay) === date);
      let dailyList = generateSummaryTableData(dailyData);
      sortList(dailyList, sortState, summaryColumnSortKeys, { prop: 'team', type: 'string' });
      const selectedMarkets = [...document.querySelectorAll('.filter-market-tab1:checked')].map(cb => cb.value);
      const { bodyHtml } = generateSummaryTableHTML(dailyList, selectedMarkets);
      table.querySelector('tbody').innerHTML = bodyHtml;
      updateSortIcons(table, sortState);
    }

    function sortList(list, sortState, columnKeys, defaultSortKey) {
      const { column, direction } = sortState;
      const sortInfo = columnKeys[column];
      if (!sortInfo && !defaultSortKey) return;
      list.sort((a, b) => {
        const key = sortInfo || defaultSortKey;
        if (key.prop === 'chot' && !sortInfo) return b.chot - a.chot;
        let valA = typeof key.prop === 'function' ? key.prop(a) : a[key.prop];
        let valB = typeof key.prop === 'function' ? key.prop(b) : b[key.prop];
        if (valA == null) valA = key.type === 'string' ? '' : -Infinity;
        if (valB == null) valB = key.type === 'string' ? '' : -Infinity;
        let comparison = 0;
        if (key.type === 'string') {
          comparison = String(valA).localeCompare(String(valB));
        } else {
          comparison = valA - valB;
        }
        if (!sortInfo) return comparison;
        return direction === 'asc' ? comparison : -comparison;
      });
    }

    function updateSortIcons(tableElement, sortState) {
      if (!tableElement) return;
      tableElement.querySelectorAll('thead th').forEach((th, index) => {
        const icon = th.querySelector('.sort-icon');
        if (!icon) return;
        icon.className = 'sort-icon';
        th.classList.remove('sorted');
        if (index === sortState.column) {
          th.classList.add('sorted');
          icon.classList.add(sortState.direction);
        }
      });
    }

    // =================================================================================
    // --- IX. LOGIC TAB, MODAL VÀ BIỂU ĐỒ ---
    // =================================================================================

    function openTab(evt, tabName) {
      document.querySelectorAll(".tab-content").forEach(tc => tc.style.display = "none");
      document.querySelectorAll(".tablinks").forEach(tl => tl.classList.remove("active"));
      document.getElementById(tabName).style.display = "block";
      const currentTabButton = Array.from(document.querySelectorAll('.tablinks')).find(
        btn => btn.getAttribute('onclick').includes(`'${tabName}'`)
      );
      if (currentTabButton) currentTabButton.classList.add("active");
      switch (tabName) {
        case 'KpiReport':
          applyTab3Filters();
          break;
        case 'DailyReport':
          if (!charts.cpqcChart) initDailyReportCharts();
          applyDailyFilters();
          break;
        case 'MarketReport':
          if (!charts.mktProductSalesChart) initMarketReportCharts();
          applyTab4Filters();
          break;
        case 'DetailedReport':
          applyTab1Filters();
          break;
      }
    }

    function showDailyDetailModal(dateString) {
      document.getElementById('modal-title').textContent = `Báo cáo chi tiết ngày ${dateString}`;
      const filteredData = getFilteredData('tab2');
      const dailyData = filteredData.filter(r => formatDate(r.ngay) === dateString);
      const modalDataList = generateSummaryTableData(dailyData);
      sortStates.modal = { column: null, direction: 'asc' };
      sortList(modalDataList, sortStates.modal, summaryColumnSortKeys);
      renderModalSummaryTable(modalDataList);
      updateSortIcons(document.getElementById('modal-summary-table'), sortStates.modal);
      document.getElementById('daily-detail-modal').style.display = 'flex';
    }

    function renderModalSummaryTable(dataList) {
      const selM = [...document.querySelectorAll('.filter-market-tab2:checked')].map(cb => cb.value);
      const { bodyHtml } = generateSummaryTableHTML(dataList, selM);
      document.getElementById('modal-summary-body').innerHTML = bodyHtml;
      document.getElementById('modal-summary-foot').innerHTML = '';
    }

    function renderDailyTable(filteredData) {
      const daily = {};
      filteredData.forEach(r => {
        const d = formatDate(r.ngay);
        if (!daily[d]) daily[d] = { cpqc: 0, don: 0, mess: 0, chot: 0, chotThucTe: 0 };
        const D = daily[d];
        D.cpqc += r.cpqc; D.don += r.soDon; D.mess += r.soMessCmt; D.chot += r.dsChot; D.chotThucTe += r.dsChotThucTe;
      });
      const html = Object.keys(daily).sort((a, b) => new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-')))
        .map(d => {
          const day = daily[d];
          const avg = day.mess ? day.don / day.mess : 0;
          const gM = day.mess ? day.cpqc / day.mess : 0;
          const cps = day.don ? day.cpqc / day.don : 0;
          const cR = day.chot ? day.cpqc / day.chot : 0;
          return `<tr><td class="text-left"><b>${d}</b></td><td>${formatPriceShort(day.cpqc)}</td><td>${formatPriceShort(day.chot)}</td><td>${formatPriceShort(day.chotThucTe)}</td><td>${formatPercent(avg)}</td><td>${formatPriceShort(gM)}</td><td>${formatPriceShort(cps)}</td><td>${formatPercent(cR)}</td></tr>`;
        }).join('');
      document.getElementById('date-summary-body').innerHTML = html;
    }

    // START: HÀM MỚI ĐỂ XỬ LÝ VIỆC ẨN/HIỆN BIỂU ĐỒ
    function handleChartToggle(target) {
      if (target.id === 'toggle-all-charts') {
        document.querySelectorAll('.chart-toggle').forEach(cb => cb.checked = target.checked);
      } else {
        document.getElementById('toggle-all-charts').checked = [...document.querySelectorAll('.chart-toggle')].every(cb => cb.checked);
      }
      document.querySelectorAll('.chart-toggle').forEach(c => {
        const wrapper = document.querySelector(`.chart-wrapper[data-chart="${c.dataset.chart}"]`);
        if (wrapper) wrapper.style.display = c.checked ? 'block' : 'none';
      });
    }
    // END: HÀM MỚI

    function initDailyReportCharts() {
      const c = (id, cfg) => charts[id] = new Chart(document.getElementById(id), cfg);
      c('cpqcChart', getLineChartConfig('CPQC (VND)'));
      c('dsChotChart', getLineChartConfig('DS Chốt (VND)'));
      c('dsDiChart', getLineChartConfig('DS Đi (VND)'));
      c('rateChart', getLineChartConfig('Tỉ lệ chốt (%)', formatPercent));
      c('messChart', getLineChartConfig('Giá Mess (VND)'));
      c('cpsChart', getLineChartConfig('CPS (VND)'));
      c('cpDsRatioChart', getLineChartConfig('%CP/DS', formatPercent));
      c('productSalesChart', getBarChartConfig('DS theo Sản phẩm'));
      c('marketSalesChart', getBarChartConfig('DS theo Thị trường'));
      // CẬP NHẬT: Đặt trạng thái hiển thị ban đầu cho các biểu đồ
      handleChartToggle(document.getElementById('toggle-all-charts'));
    }

    function initMarketReportCharts() {
      charts.mktProductSalesChart = createBarChart('mktProductSalesChart', 'Doanh số sau Hoàn Hủy theo SP');
      charts.mktProductDsChotChart = createBarChart('mktProductDsChotChart', 'Doanh số Chốt theo SP');
      charts.mktProductCpqcChart = createBarChart('mktProductCpqcChart', 'Chi phí Quảng cáo theo SP');
      charts.mktProductCpsChart = createBarChart('mktProductCpsChart', 'Chi phí trên đơn (CPS) theo SP');
      charts.mktProductClosingRateChart = createPieChart('mktProductClosingRateChart', 'Tỉ lệ chốt (%) theo SP');
      charts.mktProductCostRatioChart = createPieChart('mktProductCostRatioChart', 'Tỉ lệ CP/DS (Sau HH) theo SP');
    }

    function renderAllDailyCharts(filteredData) {
      if (!charts.cpqcChart) return;
      const daily = {};
      filteredData.forEach(r => {
        const d = formatDate(r.ngay); if (!d) return;
        if (!daily[d]) daily[d] = { cpqc: 0, don: 0, mess: 0, chot: 0, dsDi: 0, products: {}, markets: {} };
        const D = daily[d];
        D.cpqc += r.cpqc; D.don += r.soDon; D.mess += r.soMessCmt; D.chot += r.dsChot; D.dsDi += r.dsDi;
        if (r.sanPham) D.products[r.sanPham] = (D.products[r.sanPham] || 0) + r.dsChot;
        if (r.thiTruong) D.markets[r.thiTruong] = (D.markets[r.thiTruong] || 0) + r.dsChot;
      });

      const labels = Object.keys(daily).sort((a, b) => new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-')));
      const clrs = {
        cpqc: { b: '#3F51B5', f: 'rgba(63,81,181,0.2)' },
        dsChot: { b: '#4CAF50', f: 'rgba(76,175,80,0.2)' },
        dsDi: { b: '#2196F3', f: 'rgba(33,150,243,0.2)' },
        rate: { b: '#F44336', f: 'rgba(244,67,54,0.2)' },
        mess: { b: '#FF9800', f: 'rgba(255,152,0,0.2)' },
        cps: { b: '#009688', f: 'rgba(0,150,136,0.2)' },
        cpDsRatio: { b: '#9C27B0', f: 'rgba(156,39,176,0.2)' }
      };

      updateChart(charts.cpqcChart, 'CPQC', labels, labels.map(d => daily[d].cpqc), clrs.cpqc);
      updateChart(charts.dsChotChart, 'DS Chốt', labels, labels.map(d => daily[d].chot), clrs.dsChot);
      updateChart(charts.dsDiChart, 'DS Đi', labels, labels.map(d => daily[d].dsDi), clrs.dsDi);
      updateChart(charts.rateChart, 'Tỉ lệ chốt', labels, labels.map(d => daily[d].mess ? daily[d].don / daily[d].mess : 0), clrs.rate);
      updateChart(charts.messChart, 'Giá Mess', labels, labels.map(d => daily[d].mess ? daily[d].cpqc / daily[d].mess : 0), clrs.mess);
      updateChart(charts.cpsChart, 'CPS', labels, labels.map(d => daily[d].don ? daily[d].cpqc / daily[d].don : 0), clrs.cps);
      updateChart(charts.cpDsRatioChart, '%CP/DS', labels, labels.map(d => daily[d].chot ? daily[d].cpqc / daily[d].chot : 0), clrs.cpDsRatio);

      const pSales = {}, mSales = {};
      Object.values(daily).forEach(d => {
        Object.entries(d.products).forEach(([p, val]) => pSales[p] = (pSales[p] || 0) + val);
        Object.entries(d.markets).forEach(([m, val]) => mSales[m] = (mSales[m] || 0) + val);
      });

      const sP = Object.entries(pSales).sort((a, b) => b[1] - a[1]), sM = Object.entries(mSales).sort((a, b) => b[1] - a[1]);
      updateChart(charts.productSalesChart, 'DS theo SP', sP.map(p => p[0]), sP.map(p => p[1]), { b: CHART_COLORS }, 'bar');
      updateChart(charts.marketSalesChart, 'DS theo TT', sM.map(m => m[0]), sM.map(m => m[1]), { b: CHART_COLORS }, 'bar');
    }

    function renderMktCharts(data) {
      if (!charts.mktProductSalesChart) return;
      const productMetrics = {};
      data.forEach(r => {
        const p = r.sanPham || 'Chưa xác định';
        if (!productMetrics[p]) productMetrics[p] = { cpqc: 0, dsSauHoanHuy: 0, soDon: 0, dsChot: 0, soMessCmt: 0 };
        productMetrics[p].cpqc += r.cpqc;
        productMetrics[p].dsSauHoanHuy += r.dsSauHoanHuy;
        productMetrics[p].soDon += r.soDon;
        productMetrics[p].dsChot += r.dsChot;
        productMetrics[p].soMessCmt += r.soMessCmt;
      });

      const sortedProducts = Object.entries(productMetrics).sort(([, a], [, b]) => b.dsSauHoanHuy - a.dsSauHoanHuy);
      const labels = sortedProducts.map(([name]) => name);

      const updateMktChartData = (chart, data) => {
        chart.data.labels = labels;
        chart.data.datasets[0].data = data;
        chart.update();
      };

      updateMktChartData(charts.mktProductSalesChart, sortedProducts.map(([, p]) => p.dsSauHoanHuy));
      updateMktChartData(charts.mktProductDsChotChart, sortedProducts.map(([, p]) => p.dsChot));
      updateMktChartData(charts.mktProductCpqcChart, sortedProducts.map(([, p]) => p.cpqc));
      updateMktChartData(charts.mktProductCpsChart, sortedProducts.map(([, p]) => (p.soDon > 0 ? p.cpqc / p.soDon : 0)));
      updateMktChartData(charts.mktProductClosingRateChart, sortedProducts.map(([, p]) => (p.soMessCmt > 0 ? p.soDon / p.soMessCmt : 0)));
      updateMktChartData(charts.mktProductCostRatioChart, sortedProducts.map(([, p]) => (p.dsSauHoanHuy > 0 ? p.cpqc / p.dsSauHoanHuy : 0)));
    }


    function getLineChartConfig(yTitle, formatter = formatPriceShort) { return { type: 'line', options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { display: true, align: 'top', formatter } }, scales: { y: { title: { display: true, text: yTitle }, ticks: { callback: formatter } } } } }; }
    function createBarChart(canvasId, chartTitle) {
      return new Chart(document.getElementById(canvasId), {
        type: 'bar',
        data: { labels: [], datasets: [{ backgroundColor: CHART_COLORS, data: [] }] },
        options: {
          responsive: true, maintainAspectRatio: false, indexAxis: 'y',
          plugins: {
            legend: { display: false },
            title: { display: true, text: chartTitle, font: { size: 16 } },
            datalabels: { anchor: 'end', align: 'right', offset: 4, color: '#333', font: { weight: '600' }, formatter: formatPriceShort }
          },
          scales: { x: { display: false }, y: { grid: { display: false } } }
        }
      });
    }
    function createPieChart(canvasId, chartTitle) {
      return new Chart(document.getElementById(canvasId), {
        type: 'doughnut',
        data: { labels: [], datasets: [{ backgroundColor: CHART_COLORS, data: [] }] },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' },
            title: { display: true, text: chartTitle, font: { size: 16 } },
            tooltip: { callbacks: { label: (ctx) => `${ctx.label}: ${formatPercent(ctx.raw)}` } },
            datalabels: {
              color: '#fff', font: { weight: 'bold' },
              formatter: (value, ctx) => {
                const total = ctx.chart.getDatasetMeta(0).total;
                if (total === 0) return '0%';
                const percentage = value / total;
                return formatPercent(percentage);
              }
            }
          }
        }
      });
    }
    function updateChart(chart, label, labels, data, colors, type = 'line') {
      if (!chart) return;
      const chartType = chart.config.type;
      if (chartType === 'bar' || chartType === 'doughnut') {
        chart.data.labels = labels;
        chart.data.datasets = [{ label, data, backgroundColor: CHART_COLORS }];
      } else { // line
        chart.data.labels = labels;
        chart.data.datasets = [{ label, data, backgroundColor: colors.f, borderColor: colors.b, fill: true, tension: 0.1 }];
      }
      chart.update('none');
    }

    // =================================================================================
    // --- X. CÁC HÀM TIỆN ÍCH (UTILITIES) ---
    // =================================================================================
    const loader = document.getElementById('loading-overlay');
    const showLoader = () => loader.classList.add('visible');
    const hideLoader = () => loader.classList.remove('visible');

    function normalize(s) { return (s || '').trim().toLowerCase(); }
    function getMarketGroup(normalizedMarket) {
      for (const group in MARKET_GROUPS) {
        if (MARKET_GROUPS[group].map(normalize).includes(normalizedMarket)) return group;
      }
      return null;
    }
    function formatDate(dateObj) {
      if (!(dateObj instanceof Date) || isNaN(dateObj)) return '';
      return `${String(dateObj.getDate()).padStart(2, '0')}/${String(dateObj.getMonth() + 1).padStart(2, '0')}/${dateObj.getFullYear()}`;
    }
    function formatCurrency(v) { return Number(v || 0).toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }); }
    function formatNumber(v) { return Number(v || 0).toLocaleString('vi-VN'); }
    function formatPriceShort(v) {
      const n = Number(v || 0);
      if (isNaN(n)) return '0';
      if (Math.abs(n) >= 1e9) return (n / 1e9).toFixed(1).replace(/\.0$/, '') + ' tỷ';
      if (Math.abs(n) >= 1e6) return (n / 1e6).toFixed(1).replace(/\.0$/, '') + ' tr';
      if (Math.abs(n) >= 1e3) return (n / 1e3).toFixed(0) + ' k';
      return n.toLocaleString('vi-VN');
    }
    function formatPercent(v) {
      if (!isFinite(v)) return '0.00%';
      return `${(Number(v || 0) * 100).toFixed(2)}%`;
    }
    function getCpsCellStyle(cps, selectedMarkets) {
      const hasAsia = selectedMarkets.some(m => m === 'Châu Á' || MARKET_GROUPS['Châu Á'].includes(m));
      const hasNonAsia = selectedMarkets.some(m => m === 'Ngoài Châu Á' || MARKET_GROUPS['Ngoài Châu Á'].includes(m));
      if (hasAsia && !hasNonAsia && selectedMarkets.length > 0) {
        if (cps > 1e6) return 'bg-lightred';
        if (cps > 7e5) return 'bg-yellow';
      } else {
        if (cps > 1.5e6) return 'bg-lightred';
        if (cps > 1e6) return 'bg-yellow';
      }
      return '';
    }
    function getDateRange(selection) {
      const now = new Date();
      let startDate, endDate = new Date(now);
      const currentYear = now.getFullYear(), currentMonth = now.getMonth(), currentDay = now.getDay();
      const dayOfWeek = currentDay === 0 ? 6 : currentDay - 1;
      switch (selection) {
        case 'today': startDate = new Date(now.setHours(0, 0, 0, 0)); endDate = new Date(now.setHours(23, 59, 59, 999)); break;
        case 'yesterday': startDate = new Date(new Date().setDate(new Date().getDate() - 1)); startDate.setHours(0, 0, 0, 0); endDate = new Date(startDate); endDate.setHours(23, 59, 59, 999); break;
        case 'thisWeek': startDate = new Date(now.setDate(now.getDate() - dayOfWeek)); startDate.setHours(0, 0, 0, 0); endDate = new Date(startDate); endDate.setDate(startDate.getDate() + 6); endDate.setHours(23, 59, 59, 999); break;
        case 'lastWeek': startDate = new Date(); startDate.setDate(new Date().getDate() - dayOfWeek - 7); startDate.setHours(0, 0, 0, 0); endDate = new Date(startDate); endDate.setDate(startDate.getDate() + 6); endDate.setHours(23, 59, 59, 999); break;
        case 'nextWeek': startDate = new Date(); startDate.setDate(new Date().getDate() - dayOfWeek + 7); startDate.setHours(0, 0, 0, 0); endDate = new Date(startDate); endDate.setDate(startDate.getDate() + 6); endDate.setHours(23, 59, 59, 999); break;
        case 'thisMonth': startDate = new Date(currentYear, currentMonth, 1); endDate = new Date(currentYear, currentMonth + 1, 0); break;
        default:
          if (selection.startsWith('month_')) {
            const month = parseInt(selection.split('_')[1], 10) - 1;
            startDate = new Date(currentYear, month, 1);
            endDate = new Date(currentYear, month + 1, 0);
          } else if (selection.startsWith('quarter_')) {
            const quarter = parseInt(selection.split('_')[1], 10);
            const startMonth = (quarter - 1) * 3;
            startDate = new Date(currentYear, startMonth, 1);
            endDate = new Date(currentYear, startMonth + 3, 0);
          }
          break;
      }
      return { startDate, endDate };
    }
  </script>
</body>

</html>

<script>
    // --- KHAI BÁO BIẾN TOÀN CỤC ---
    let masterData = []; 
    let employeeData = [];
    let charts = {};
    const groupChildren = { 'Châu Á': ['Hàn Quốc','Nhật Bản','VN'], 'Ngoài Châu Á': ['Úc','US', 'Canada'] };

    const loader = document.getElementById('loading-overlay');
    const showLoader = () => loader.classList.add('visible');
    const hideLoader = () => loader.classList.remove('visible');
    
    // --- KHỞI TẠO & TẢI DỮ LIỆU ---
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById("defaultOpen").click();
      addEventListeners();
      setDefaultDates();
      fetchAndProcessData();
    });

    function setDefaultDates() {
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        const formatDateForInput = (date) => date.toISOString().split('T')[0];
        document.getElementById('start-date-tab1').value = formatDateForInput(firstDay);
        document.getElementById('end-date-tab1').value = formatDateForInput(lastDay);
        document.getElementById('start-date-tab2').value = formatDateForInput(firstDay);
        document.getElementById('end-date-tab2').value = formatDateForInput(lastDay);
    }
    
    function addEventListeners() {
      document.body.addEventListener('change', (e) => {
        if (e.target.closest('#DetailedReport')) { handleTab1Filters(e.target); }
        else if (e.target.closest('#DailyReport')) { handleTab2Filters(e.target); }
      });
    }

    function fetchAndProcessData() {
        showLoader();
        // LINK DỮ LIỆU BÁN HÀNG MỚI NHẤT
        const salesDataUrl = 'https://script.google.com/macros/s/AKfycbwGwSBxeXplEzAM-jJDPaXPkiWjNyKmpR70o6nCY5_ynqoF-3WA1gvF91RIQQfDZ9fvAQ/exec';
        // LINK DỮ LIỆU NHÂN SỰ (GIỮ NGUYÊN)
        const employeeDataUrl = 'https://script.google.com/macros/s/AKfycbzwOv7UFwrqzf88QJL1QrxLKcnnnSIQ_PSmF0SO8LboqWI5li3vF3W8_-8s-A8lNGaR/exec';

        Promise.all([
            fetch(salesDataUrl).then(res => res.json()),
            fetch(employeeDataUrl).then(res => res.json())
        ])
        .then(([salesResult, employeeResult]) => {
            // == BƯỚC 1: Xử lý dữ liệu bán hàng (sử dụng key từ API mới) ==
            masterData = salesResult
                .filter(r => r.ten && String(r.ten).trim() !== '')
                .map(r => ({
                    ...r,
                    ten: (r.ten || 'N/A').trim(),
                    team: (r.team || 'Khác').trim(),
                    cpqc: +r.cpqc || 0,
                    soMessCmt: +r.soMessCmt || 0,
                    soDon: +r.soDon || 0,
                    dsChot: +r.dsChot || 0,
                    doanhSo: +r.doanhSoDi || 0, // <-- SỬA KEY Ở ĐÂY: từ r.doanhSo thành r.doanhSoDi
                    doanhSoSauShip: +r.doanhSoSauShip || 0,
                    doanhsoTC: +r.doanhsoTC || 0,
                    kpis: +r.kpis || 0
                }));
            
            // == BƯỚC 2: SỬA LỖI - Dữ liệu nhân sự đã có cấu trúc đúng, KHÔNG cần map lại. ==
            // Dùng trực tiếp kết quả từ API mà không cần xử lý `map(e => ({...}))` nữa.
            employeeData = employeeResult;
            
            // == BƯỚC 3: Lọc dữ liệu theo vai trò (giờ sẽ hoạt động đúng) ==
            let dataForFilters = masterData;
            const idFromUrl = new URLSearchParams(window.location.search).get('id');

            if (idFromUrl) {
                // `find` sẽ hoạt động vì employeeData giờ đã có cấu trúc đúng
                const currentUser = employeeData.find(emp => emp.idnv === idFromUrl); 
                
                if (currentUser) {
                    // Các thuộc tính `ho_va_ten`, `team`, `vi_tri` sẽ có giá trị đúng
                    const memberName = (currentUser.ho_va_ten || '').trim();
                    const teamName = (currentUser.team || '').trim();
                    
                    if ((currentUser.vi_tri || '').trim().toLowerCase() === 'leader') {
                        document.getElementById('report-title-tab1').textContent = `DỮ LIỆU TEAM ${teamName}`;
                        dataForFilters = masterData.filter(r => (r.team || '').trim() === teamName);
                    } else {
                        document.getElementById('report-title-tab1').textContent = `DỮ LIỆU CÁ NHÂN - ${memberName}`;
                        dataForFilters = masterData.filter(r => (r.ten || '').trim() === memberName);
                    }
                } else {
                    alert(`ID "${idFromUrl}" không hợp lệ hoặc không tồn tại trong danh sách nhân sự.`);
                    document.getElementById('report-title-tab1').textContent = `KHÔNG TÌM THẤY DỮ LIỆU`;
                    dataForFilters = [];
                }
            } else {
                document.getElementById('report-title-tab1').textContent = 'DỮ LIỆU CHI PHÍ ADS';
            }
            
            populateAllFilters(dataForFilters);
            applyTab1Filters(dataForFilters);
        }).catch(err => { 
            console.error("Lỗi khi tải dữ liệu:", err); 
            alert('Không thể tải dữ liệu. Vui lòng kiểm tra lại đường link hoặc kết nối mạng.'); 
        }).finally(() => {
            hideLoader();
        });
    }

    // --- CÁC HÀM CÒN LẠI GIỮ NGUYÊN ---
    
    function getFilteredData(initialData) {
        let dataToFilter = initialData;
        const filterIds = {
            startDateId: 'start-date-tab1', endDateId: 'end-date-tab1',
            productCbId: 'product-all-tab1', productOptionsClass: 'filter-product-tab1',
            marketCbId: 'market-all-tab1', marketOptionsClass: 'filter-market-tab1',
            caCbId: 'ca-all-tab1', caOptionsClass: 'filter-ca-tab1',
            teamCbId: 'team-all-tab1', teamOptionsClass: 'filter-team-tab1'
        };
        const sdVal = document.getElementById(filterIds.startDateId).value;
        const edVal = document.getElementById(filterIds.endDateId).value;
        const sd = sdVal ? new Date(sdVal + 'T00:00:00.000Z') : null;
        const ed = edVal ? new Date(edVal + 'T23:59:59.999Z') : null;
        const getSelected = (allId, cbClass) => {
            const allCheckbox = document.getElementById(allId);
            if (!allCheckbox || allCheckbox.checked) return null;
            return [...document.querySelectorAll(`.${cbClass}:checked`)].map(cb => cb.value);
        }
        const selP = getSelected(filterIds.productCbId, filterIds.productOptionsClass);
        const selM = filterIds.marketCbId ? getSelected(filterIds.marketCbId, filterIds.marketOptionsClass) : null;
        const selCa = filterIds.caCbId ? getSelected(filterIds.caCbId, filterIds.caOptionsClass) : null;
        const selT = filterIds.teamCbId ? getSelected(filterIds.teamCbId, filterIds.teamOptionsClass) : null;
        return dataToFilter.filter(r => {
            const d = new Date(r.ngay);
            const isDateOk = (!sd || d >= sd) && (!ed || d <= ed);
            const isProductOk = !selP || selP.includes(r.sanPham);
            const marketGroup = getGroup(normalize(r.thiTruong));
            const isMarketOk = !selM || selM.includes(marketGroup) || selM.includes(r.thiTruong);
            const isCaOk = !selCa || selCa.includes(r.ca);
            const isTeamOk = !selT || selT.includes(r.team);
            return isDateOk && isProductOk && isMarketOk && isCaOk && isTeamOk;
        });
    }

    function populateAllFilters(data) {
        const prodSet=new Set(), caSet=new Set(), teamSet=new Set(), mktSet=new Set();
        (data || masterData).forEach(r=>{ if(r.sanPham) prodSet.add(r.sanPham); if(r.ca) caSet.add(r.ca); if(r.team) teamSet.add(r.team); if(r.thiTruong) mktSet.add(r.thiTruong); });
        
        const createSimpleCheckboxes = (set, className) => Array.from(set).sort().map(item => `<label class='indent'><input type='checkbox' class='${className}' value='${item}' checked> ${item}</label>`).join('');
        
        const createMarketCheckboxes = (className) => {
            const marketHtml = Object.keys(groupChildren).map(grp => `<label><input type='checkbox' class='${className}' value='${grp}' checked> <b>${grp}</b></label>` + groupChildren[grp].map(ch => `<label class='indent'><input type='checkbox' class='${className}' value='${ch}' checked> ${ch}</label>`).join('')).join('');
            const otherMarkets = Array.from(mktSet).filter(m => !Object.values(groupChildren).flat().map(c => normalize(c)).includes(normalize(m))).sort().map(m => `<label class='indent'><input type='checkbox' class='${className}' value='${m}' checked> ${m}</label>`).join('');
            return marketHtml + otherMarkets;
        };

        document.getElementById('product-options-tab1').innerHTML = createSimpleCheckboxes(prodSet, 'filter-product-tab1');
        document.getElementById('ca-options-tab1').innerHTML = createSimpleCheckboxes(caSet, 'filter-ca-tab1');
        document.getElementById('team-options-tab1').innerHTML = createSimpleCheckboxes(teamSet, 'filter-team-tab1');
        document.getElementById('market-options-tab1').innerHTML = createMarketCheckboxes('filter-market-tab1');
        
        document.getElementById('product-options-tab2').innerHTML = createSimpleCheckboxes(prodSet, 'filter-product-tab2');
        document.getElementById('market-options-tab2').innerHTML = createMarketCheckboxes('filter-market-tab2');
    }

    function normalize(s) { return (s||'').trim().toLowerCase(); }
    function capitalize(s) { return s.charAt(0).toUpperCase()+s.slice(1); }
    function getGroup(norm) { for (let g in groupChildren) { if (groupChildren[g].map(normalize).includes(norm)) return g; } return capitalize(norm); }
    function formatDate(v) { const d = new Date(v); if (isNaN(d)) return v; return `${String(d.getUTCDate()).padStart(2,'0')}/${String(d.getUTCMonth()+1).padStart(2,'0')}/${d.getUTCFullYear()}`; }
    function formatCurrency(v) { return Number(v||0).toLocaleString('vi-VN',{style:'currency',currency:'VND'}); }
    function formatPriceShort(v) { const num = Number(v || 0); if (v === null || v === undefined) return ''; if (num >= 1000000) return (num / 1000000).toFixed(1) + 'tr'; if (num >= 1000) return (num / 1000).toFixed(0) + 'k'; return num.toLocaleString('vi-VN'); }
    function formatPercent(v) { if (v === null || v === undefined || !isFinite(v)) return '0.00%'; return `${(Number(v||0) * 100).toFixed(2)}%`; }
    function handleCheckbox(masterId, childClass, target) { const allCheckbox = document.getElementById(masterId); if (!allCheckbox) return; if (target.id === masterId) { document.querySelectorAll(`.${childClass}`).forEach(cb => cb.checked = target.checked); } else if (target.classList.contains(childClass)) { allCheckbox.checked = [...document.querySelectorAll(`.${childClass}`)].every(cb => cb.checked); } }
    function getCpsCellStyle(cps, selectedMarkets) { const hasChauA = selectedMarkets.some(m => m === 'Châu Á' || groupChildren['Châu Á'].includes(m)); const hasNgoaiChauA = selectedMarkets.some(m => m === 'Ngoài Châu Á' || groupChildren['Ngoài Châu Á'].includes(m)); const isChauAOnly = hasChauA && !hasNgoaiChauA && selectedMarkets.length > 0; if (isChauAOnly) { if (cps > 1000000) return 'bg-lightred'; if (cps > 700000) return 'bg-yellow'; } else { if (cps > 1500000) return 'bg-lightred'; if (cps > 1000000) return 'bg-yellow'; } return ''; }

    function handleTab1Filters(target) { showLoader(); setTimeout(() => { handleCheckbox('product-all-tab1', 'filter-product-tab1', target); handleCheckbox('ca-all-tab1', 'filter-ca-tab1', target); handleCheckbox('team-all-tab1', 'filter-team-tab1', target); handleCheckbox('market-all-tab1', 'filter-market-tab1', target); applyTab1Filters(); hideLoader(); }, 10); }
    
    function applyTab1Filters(baseData = null) {
        if (baseData === null) {
            const idFromUrl = new URLSearchParams(window.location.search).get('id');
            if (idFromUrl) {
                const currentUser = employeeData.find(emp => emp.idnv === idFromUrl);
                if (currentUser) {
                    const memberName = (currentUser.ho_va_ten || '').trim();
                    const teamName = (currentUser.team || '').trim();
                    if ((currentUser.vi_tri || '').trim().toLowerCase() === 'leader') {
                        baseData = masterData.filter(r => (r.team || '').trim() === teamName);
                    } else {
                        baseData = masterData.filter(r => (r.ten || '').trim() === memberName);
                    }
                } else {
                    baseData = [];
                }
            } else {
                baseData = masterData;
            }
        }
        const filtered = getFilteredData(baseData);
        renderSummary(filtered); 
        renderKpiSummary(filtered); 
        renderDailyBreakdown(filtered);
    }

    function renderSummary(data) {
        const summaryData = {};
        data.forEach(r => {
            const name = r.ten;
            if (!summaryData[name]) summaryData[name] = { team: r.team, mess: 0, don: 0, chot: 0, cpqc: 0 };
            summaryData[name].mess += r.soMessCmt; summaryData[name].don += r.soDon;
            summaryData[name].chot += r.dsChot; summaryData[name].cpqc += r.cpqc;
        });
        const flatList = Object.keys(summaryData).map(name => ({ name, team: summaryData[name].team, data: summaryData[name] }))
            .sort((a,b) => (a.team || 'zzz').localeCompare(b.team || 'zzz') || a.name.localeCompare(b.name));
        let total = { mess: 0, don: 0, chot: 0, cpqc: 0 };
        const selectedMarkets = [...document.querySelectorAll('.filter-market-tab1:checked')].map(cb => cb.value);
        let bodyHtml = flatList.map((item, index) => {
            const s = item.data;
            total.mess += s.mess; total.don += s.don; total.chot += s.chot; total.cpqc += s.cpqc;
            const rate = s.mess ? s.don / s.mess : 0; const pm = s.mess ? s.cpqc / s.mess : 0;
            const pd = s.don ? s.cpqc / s.don : 0; const pc = s.chot ? s.cpqc / s.chot : 0;
            const pdt = s.don ? s.chot / s.don : 0;
            const rateClass = rate > 0.1 ? 'bg-green' : (rate > 0.05 ? 'bg-yellow' : '');
            const cpsClass = getCpsCellStyle(pd, selectedMarkets);
            const cpdsClass = pc > 0.33 ? 'bg-yellow' : '';
            return `<tr><td class="text-center">${index + 1}</td><td class="text-left">${item.team}</td>
                <td class="text-left">${item.name}</td><td>${s.mess.toLocaleString('vi-VN')}</td>
                <td>${formatCurrency(s.cpqc)}</td><td>${s.don.toLocaleString('vi-VN')}</td><td>${formatCurrency(s.chot)}</td>
                <td class="${rateClass}">${formatPercent(rate)}</td><td>${formatCurrency(pm)}</td>
                <td class="${cpsClass}">${formatCurrency(pd)}</td><td class="${cpdsClass}">${formatPercent(pc)}</td><td>${formatCurrency(pdt)}</td></tr>`;
        }).join('');
        document.getElementById('summary-body').innerHTML = bodyHtml;
        const totalRate = total.mess ? total.don / total.mess : 0; const totalPm = total.mess ? total.cpqc / total.mess : 0;
        const totalPd = total.don ? total.cpqc / total.don : 0; const totalPc = total.chot ? total.cpqc / total.chot : 0;
        const totalPdt = total.don ? total.chot / total.don : 0;
        document.getElementById('summary-foot').innerHTML = `<tr class="total-row"><td class="total-label" colspan="3">TỔNG CỘNG</td>
                <td class="total-value">${total.mess.toLocaleString('vi-VN')}</td><td class="total-value">${formatCurrency(total.cpqc)}</td>
                <td class="total-value">${total.don.toLocaleString('vi-VN')}</td><td class="total-value">${formatCurrency(total.chot)}</td>
                <td class="total-value">${formatPercent(totalRate)}</td><td class="total-value">${formatCurrency(totalPm)}</td>
                <td class="total-value">${formatCurrency(totalPd)}</td><td class="total-value">${formatPercent(totalPc)}</td>
                <td class="total-value">${formatCurrency(totalPdt)}</td></tr>`;
    }

    function renderKpiSummary(data) { 
        const sum = {}; 
        data.forEach(r => { 
            const mkt = r.ten;
            if (!sum[mkt]) sum[mkt] = { cpqc: 0, dsChot: 0, dsDi: 0, dsSauShip: 0, dsThanhCong: 0, kpiValue: r.kpis, team: r.team }; 
            sum[mkt].cpqc += r.cpqc; sum[mkt].dsChot += r.dsChot; sum[mkt].dsDi += r.doanhSo;
            sum[mkt].dsSauShip += r.doanhSoSauShip; sum[mkt].dsThanhCong += r.doanhsoTC;
        });
        const sortedMktKeys = Object.keys(sum).sort((a, b) => (sum[a].team.localeCompare(sum[b].team)) || (a.localeCompare(b)));
        let total = { cpqc: 0, dsChot: 0, dsDi: 0, dsSauShip: 0, dsThanhCong: 0, kpis: 0 };
        let bodyHtml = sortedMktKeys.map((mkt, i) => { 
            const s = sum[mkt]; 
            total.cpqc += s.cpqc; total.dsChot += s.dsChot; total.dsDi += s.dsDi;
            total.dsSauShip += s.dsSauShip; total.dsThanhCong += s.dsThanhCong; total.kpis += s.kpiValue;
            const cp_ds = s.dsSauShip ? s.cpqc / s.dsSauShip : 0; const kpiPercentage = s.kpiValue ? s.dsSauShip / s.kpiValue : 0; 
            const cpdsClass = cp_ds > 0.33 ? 'bg-yellow' : ''; 
            return `<tr><td class="text-center">${i+1}</td><td class="text-left">${s.team}</td><td class="text-left">${mkt}</td>
                <td>${formatCurrency(s.cpqc)}</td><td>${formatCurrency(s.dsChot)}</td><td>${formatCurrency(s.dsDi)}</td>
                <td>${formatCurrency(s.dsSauShip)}</td><td>${formatCurrency(s.dsThanhCong)}</td>
                <td class="${cpdsClass}">${formatPercent(cp_ds)}</td><td>${formatPercent(kpiPercentage)}</td></tr>`;
        }).join(''); 
        document.getElementById('kpi-summary-body').innerHTML = bodyHtml;
        const totalCpds = total.dsSauShip ? total.cpqc / total.dsSauShip : 0;
        const totalKpiPercentage = total.kpis ? total.dsSauShip / total.kpis : 0;
        document.getElementById('kpi-summary-foot').innerHTML = `<tr class="total-row"><td class="total-label" colspan="3">TỔNG CỘNG</td>
                <td class="total-value">${formatCurrency(total.cpqc)}</td><td class="total-value">${formatCurrency(total.dsChot)}</td>
                <td class="total-value">${formatCurrency(total.dsDi)}</td><td class="total-value">${formatCurrency(total.dsSauShip)}</td>
                <td class="total-value">${formatCurrency(total.dsThanhCong)}</td><td class="total-value">${formatPercent(totalCpds)}</td>
                <td class="total-value">${formatPercent(totalKpiPercentage)}</td></tr>`;
    }
    
    function renderDailyBreakdown(data) { 
        const c=document.getElementById('daily-breakdown'); c.innerHTML='';
        if (data.length === 0) { c.innerHTML = '<p style="text-align:center; margin-top: 20px;">Không có dữ liệu chi tiết.</p>'; return; }
        const grpObj={};
        data.forEach(r=>{const d=formatDate(r.ngay);(grpObj[d]||(grpObj[d]=[])).push(r);});
        Object.keys(grpObj).sort((a,b)=>new Date(b.split('/').reverse().join('-'))-new Date(a.split('/').reverse().join('-'))).forEach(date=>{
            let m=0,d=0,ch=0,pc=0;
            const sortedDailyData = grpObj[date].sort((a, b) => (a.team || 'zzz').localeCompare(b.team || 'zzz'));
            const rowsHtml = sortedDailyData.map(r=>{
                m+=r.soMessCmt;d+=r.soDon;ch+=r.dsChot;pc+=r.cpqc;
                // SỬA KEY Ở ĐÂY: Dùng r.idNS thay vì r.id
                return`<tr><td class="text-center">${r.idNS}</td><td class="text-left">${r.ten}</td><td class="text-left">${r.ca}</td><td class="text-left">${r.page}</td><td class="text-left">${r.sanPham}</td><td class="text-left">${r.thiTruong}</td><td>${r.soMessCmt.toLocaleString('vi-VN')}</td><td>${r.soDon.toLocaleString('vi-VN')}</td><td>${formatCurrency(r.dsChot)}</td><td>${formatCurrency(r.cpqc)}</td><td class="text-left">${r.team}</td></tr>`
            }).join('');
            const footHtml=`<tr class='total-row'><td colspan='6' class='total-label'>Tổng</td><td class='total-value'>${m.toLocaleString('vi-VN')}</td><td class='total-value'>${d.toLocaleString('vi-VN')}</td><td class='total-value'>${formatCurrency(ch)}</td><td class='total-value'>${formatCurrency(pc)}</td><td class="text-left"></td></tr>`;
            c.innerHTML+=`<h3>${date}</h3><div class="table-responsive-container"><table><thead><tr><th>ID</th><th>Tên</th><th>Ca</th><th>Page</th><th>Sản phẩm</th><th>Thị trường</th><th>Mess</th><th>Đơn</th><th>DS Chốt</th><th>CPQC</th><th>Team</th></tr></thead><tbody>${rowsHtml}</tbody><tfoot>${footHtml}</tfoot></table></div>`;
        }); 
    }

    function openTab(evt, tabName) {
      document.querySelectorAll(".tab-content").forEach(tc => tc.style.display = "none");
      document.querySelectorAll(".tablinks").forEach(tl => tl.classList.remove("active"));
      document.getElementById(tabName).style.display = "block";
      evt.currentTarget.classList.add("active");
      if (tabName === 'DailyReport' && !charts.cpqcChart) { initAllCharts(); applyDailyFilters(); }
    }
    
    function getFilteredDataTab2() {
        let dataToFilter = masterData;
        const filterIds = {
            startDateId: 'start-date-tab2', endDateId: 'end-date-tab2',
            productCbId: 'product-all-tab2', productOptionsClass: 'filter-product-tab2',
            marketCbId: 'market-all-tab2', marketOptionsClass: 'filter-market-tab2'
        };
        const sdVal = document.getElementById(filterIds.startDateId).value;
        const edVal = document.getElementById(filterIds.endDateId).value;
        const sd = sdVal ? new Date(sdVal + 'T00:00:00.000Z') : null;
        const ed = edVal ? new Date(edVal + 'T23:59:59.999Z') : null;
        const getSelected = (allId, cbClass) => {
            const allCheckbox = document.getElementById(allId);
            if (!allCheckbox || allCheckbox.checked) return null;
            return [...document.querySelectorAll(`.${cbClass}:checked`)].map(cb => cb.value);
        };
        const selP = getSelected(filterIds.productCbId, filterIds.productOptionsClass);
        const selM = getSelected(filterIds.marketCbId, filterIds.marketOptionsClass);
        return dataToFilter.filter(r => {
            const d = new Date(r.ngay);
            const isDateOk = (!sd || d >= sd) && (!ed || d <= ed);
            const isProductOk = !selP || selP.includes(r.sanPham);
            const marketGroup = getGroup(normalize(r.thiTruong));
            const isMarketOk = !selM || selM.includes(marketGroup) || selM.includes(r.thiTruong);
            return isDateOk && isProductOk && isMarketOk;
        });
    }
    
    function handleTab2Filters(target) { showLoader(); setTimeout(() => { if (target.id === 'toggle-all-charts' || target.classList.contains('chart-toggle')) { if (target.id === 'toggle-all-charts') document.querySelectorAll('.chart-toggle').forEach(cb => cb.checked = target.checked); else document.getElementById('toggle-all-charts').checked = [...document.querySelectorAll('.chart-toggle')].every(cb => cb.checked); toggleChartVisibility(); hideLoader(); return; } handleCheckbox('product-all-tab2', 'filter-product-tab2', target); handleCheckbox('market-all-tab2', 'filter-market-tab2', target); applyDailyFilters(); hideLoader(); }, 10); }
    function applyDailyFilters() { if (!masterData.length) return; const filtered = getFilteredDataTab2(); renderDailyTable(filtered); renderAllDailyCharts(filtered); }
    function renderDailyTable(data) { const daily = {}; data.forEach(r => { const dateKey = formatDate(r.ngay); if (!daily[dateKey]) daily[dateKey] = { cpqc: 0, don: 0, mess: 0, chot: 0 }; daily[dateKey].cpqc += r.cpqc; daily[dateKey].don += r.soDon; daily[dateKey].mess += r.soMessCmt; daily[dateKey].chot += r.dsChot; }); let tbodyHtml = Object.keys(daily).sort((a,b) => new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-'))).map(d => { const day = daily[d]; const avg = day.mess ? day.don / day.mess : 0; const giaMess = day.mess ? day.cpqc / day.mess : 0; const cps = day.don ? day.cpqc / day.don : 0; const cpqcRatio = day.chot ? day.cpqc / day.chot : 0; return `<tr><td class="text-left"><b>${d}</b></td><td>${formatPriceShort(day.cpqc)}</td><td>${formatPriceShort(day.chot)}</td><td>${formatPercent(avg)}</td><td>${formatPriceShort(giaMess)}</td><td>${formatPriceShort(cps)}</td><td>${formatPercent(cpqcRatio)}</td></tr>`; }).join(''); document.getElementById('date-summary-body').innerHTML = tbodyHtml; }
    function toggleChartVisibility() { document.querySelectorAll('.chart-toggle').forEach(checkbox => { const chartName = checkbox.dataset.chart; const wrapper = document.querySelector(`.chart-wrapper[data-chart="${chartName}"]`); if (wrapper) { wrapper.style.display = checkbox.checked ? 'block' : 'none'; } }); }
    
    function initAllCharts() {
        const createChart = (ctxId, config) => new Chart(document.getElementById(ctxId).getContext('2d'), config);
        charts.cpqcChart = createChart('cpqcChart', getLineChartConfig('CPQC (VND)')); charts.dsChotChart = createChart('dsChotChart', getLineChartConfig('DS Chốt (VND)')); charts.rateChart = createChart('rateChart', getLineChartConfig('Tỉ lệ chốt (%)', v => formatPercent(v))); charts.messChart = createChart('messChart', getLineChartConfig('Giá Mess (VND)')); charts.cpsChart = createChart('cpsChart', getLineChartConfig('CPS (VND)')); charts.cpDsRatioChart = createChart('cpDsRatioChart', getLineChartConfig('%CP/DS', v => formatPercent(v))); charts.productSalesChart = createChart('productSalesChart', getBarChartConfig('DS theo Sản phẩm')); charts.marketSalesChart = createChart('marketSalesChart', getBarChartConfig('DS theo Thị trường'));
        toggleChartVisibility();
    }
    
    function renderAllDailyCharts(data) {
        if (!Object.keys(charts).length) return;
        const daily = {}; data.forEach(r => { const dateKey = formatDate(r.ngay); if (!daily[dateKey]) daily[dateKey] = { cpqc: 0, don: 0, mess: 0, chot: 0 }; daily[dateKey].cpqc += r.cpqc; daily[dateKey].don += r.soDon; daily[dateKey].mess += r.soMessCmt; daily[dateKey].chot += r.dsChot; });
        const labels = Object.keys(daily).sort((a,b) => new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-')));
        updateChart(charts.cpqcChart, 'CPQC', labels, labels.map(d => daily[d].cpqc), getChartColors().cpqc);
        updateChart(charts.dsChotChart, 'DS Chốt', labels, labels.map(d => daily[d].chot), getChartColors().dsChot);
        updateChart(charts.rateChart, 'Tỉ lệ chốt', labels, labels.map(d => daily[d].mess ? (daily[d].don / daily[d].mess) : 0), getChartColors().rate);
        updateChart(charts.messChart, 'Giá Mess', labels, labels.map(d => daily[d].mess ? (daily[d].cpqc / daily[d].mess) : 0), getChartColors().mess);
        updateChart(charts.cpsChart, 'CPS', labels, labels.map(d => daily[d].don ? (daily[d].cpqc / daily[d].don) : 0), getChartColors().cps);
        updateChart(charts.cpDsRatioChart, '%CP/DS', labels, labels.map(d => daily[d].chot ? (daily[d].cpqc / daily[d].chot) : 0), getChartColors().cpDsRatio);
        const productSales = {}, marketSales = {}; data.forEach(r => { if (r.sanPham) productSales[r.sanPham] = (productSales[r.sanPham] || 0) + r.dsChot; if (r.thiTruong) marketSales[r.thiTruong] = (marketSales[r.thiTruong] || 0) + r.dsChot; });
        const sortedProducts = Object.entries(productSales).sort((a,b) => b[1] - a[1]); const sortedMarkets = Object.entries(marketSales).sort((a,b) => b[1] - a[1]);
        updateChart(charts.productSalesChart, 'DS theo SP', sortedProducts.map(p=>p[0]), sortedProducts.map(p=>p[1]), getChartColors().product, 'bar');
        updateChart(charts.marketSalesChart, 'DS theo TT', sortedMarkets.map(m=>m[0]), sortedMarkets.map(m=>m[1]), getChartColors().market, 'bar');
    }

    function getChartColors() { return { cpqc: { border: '#3F51B5', fill: 'rgba(63, 81, 181, 0.2)' }, dsChot: { border: '#4CAF50', fill: 'rgba(76, 175, 80, 0.2)' }, rate: { border: '#F44336', fill: 'rgba(244, 67, 54, 0.2)' }, mess: { border: '#FF9800', fill: 'rgba(255, 152, 0, 0.2)' }, cps: { border: '#009688', fill: 'rgba(0, 150, 136, 0.2)' }, cpDsRatio: { border: '#9C27B0', fill: 'rgba(156, 39, 176, 0.2)' }, product: { border: '#607D8B', fill: '#607D8B' }, market: { border: '#795548', fill: '#795548' } }; }
    function getLineChartConfig(yTitle, formatter = v => formatPriceShort(v)) { Chart.register(ChartDataLabels); return { type: 'line', options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { font: { size: 14, weight: '500' }, padding: 20, usePointStyle: true, pointStyle: 'circle' } }, tooltip: { backgroundColor: 'rgba(0,0,0,0.9)', titleFont: { size: 16, weight: 'bold' }, bodyFont: { size: 14 }, padding: 12, cornerRadius: 8, displayColors: true, boxPadding: 6, callbacks: { label: (ctx) => `${ctx.dataset.label}: ${formatter(ctx.raw)}` } }, datalabels: { display: true, align: 'top', anchor: 'end', backgroundColor: (ctx) => ctx.dataset.borderColor, borderColor: '#fff', borderWidth: 1, borderRadius: 12, color: '#fff', font: { weight: 'bold', size: 10 }, formatter: formatter, padding: 6, offset: 4 } }, interaction: { intersect: false, mode: 'index' }, scales: { x: { grid: { display: false, drawBorder: false }, ticks: { font: { size: 12 }, maxRotation: 45, minRotation: 45 } }, y: { title: { display: true, text: yTitle, font: { size: 14, weight: '500' }, padding: {top: 10, bottom: 20} }, ticks: { callback: formatter, font: { size: 12 } }, grid: { color: 'rgba(0,0,0,0.05)', drawBorder: false } } }, elements: { line: { borderWidth: 3, tension: 0.3 }, point: { radius: 5, hoverRadius: 8, hitRadius: 10, backgroundColor: '#fff' } }, layout: { padding: 20 } } }; }
    function getBarChartConfig(title) { Chart.register(ChartDataLabels); return { type: 'bar', options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { title: { display: true, text: title, font: {size: 16, weight: 'bold'}, padding: {bottom: 15} }, legend: { display: false }, tooltip: { backgroundColor: 'rgba(0,0,0,0.9)', titleFont: { size: 16, weight: 'bold' }, bodyFont: { size: 14 }, padding: 12, cornerRadius: 8, displayColors: false, callbacks: { label: (ctx) => `${formatCurrency(ctx.parsed.x)}` } }, datalabels: { display: true, anchor: 'end', align: 'right', offset: 8, color: '#333', font: { weight: '600', size: 12 }, formatter: v => formatPriceShort(v) } }, scales: { x: { display: false, grid: { display: false } }, y: { grid: { display: false }, ticks: { font: { size: 13, weight: '500' } } } }, layout: { padding: { left: 120, right: 50, top: 20, bottom: 20 } }, barPercentage: 0.8, categoryPercentage: 0.9 } }; }
    function updateChart(chart, label, labels, data, colors, type = 'line') { chart.data.labels = labels; chart.data.datasets = [createDataset(label, data, colors, type)]; chart.update('none'); }
    function createDataset(label, data, colors, type = 'line') { const isLine = type === 'line'; return { label, data, backgroundColor: isLine ? colors.fill : colors.border, borderColor: colors.border, type, fill: isLine, tension: 0.4, borderWidth: isLine ? 3 : 1, pointRadius: isLine ? 5 : undefined, pointBackgroundColor: '#fff', pointBorderWidth: 2, borderRadius: isLine ? 0 : 4, }; }
</script>

<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Báo cáo học tập</title>
  <style>
    :root {
      --primary-color: #a71d2a;
      --secondary-color: #8c1a1a;
      --accent-color: #d62828;
      --light-color: #f8f1f1;
      --success-color: #2a9d8f;
      --warning-color: #e9c46a;
      --danger-color: #e63946;
      --text-color: #333333;
      --text-light: #6c757d;
      --border-radius: 8px;
      --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      margin: 0;
      padding: 40px 20px;
      background-color: var(--light-color);
      color: var(--text-color);
      line-height: 1.6;
    }

    .trf-container {
      width: 100%;
      max-width: 900px;
      margin: 0 auto;
      background-color: white;
      padding: 40px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(167, 29, 42, 0.2);
    }

    .trf-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 8px;
      background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(167, 29, 42, 0.1);
    }

    .header-left h1 {
      margin: 0;
      font-size: 28px;
      font-weight: 600;
      color: var(--primary-color);
      letter-spacing: -0.5px;
    }

    .header-left p {
      margin-top: 8px;
      color: var(--text-light);
      font-size: 15px;
    }

    .logo-group img {
      max-height: 80px;
      transition: var(--transition);
    }

    .logo-group:hover img {
      transform: scale(1.05);
    }

    .section-title {
      background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 12px 20px;
      font-weight: 500;
      margin: 30px 0 15px 0;
      font-size: 16px;
      border-radius: var(--border-radius);
      letter-spacing: 0.5px;
      box-shadow: 0 2px 8px rgba(167, 29, 42, 0.2);
    }

    .month-filter {
      margin: 20px 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .month-filter label {
      font-weight: 500;
      color: var(--primary-color);
    }

    .month-filter select {
      padding: 8px 12px;
      border: 1px solid var(--primary-color);
      border-radius: var(--border-radius);
      background-color: white;
      color: var(--text-color);
      font-size: 14px;
      cursor: pointer;
      transition: var(--transition);
    }

    .month-filter select:hover {
      background-color: #fdf3f4;
    }

    .candidate-details, .test-results {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 25px;
    }

    .candidate-details td,
    .candidate-details th,
    .test-results td,
    .test-results th {
      border: 1px solid #f0d6d9;
      padding: 12px;
    }

    .candidate-details th {
      background-color: #fdf3f4;
      text-align: left;
      width: 150px;
      font-weight: 500;
      color: var(--secondary-color);
    }

    .candidate-photo {
      width: 100px;
      height: 120px;
      background: linear-gradient(135deg, #f8f1f1 0%, #f0d6d9 100%);
      display: inline-block;
      margin-bottom: 10px;
      text-align: center;
      line-height: 120px;
      color: var(--text-light);
      font-size: 14px;
      border-radius: 4px;
      box-shadow: inset 0 0 10px rgba(167, 29, 42, 0.05);
      position: relative;
      overflow: hidden;
      border: 1px solid #f0d6d9;
    }

    .candidate-photo::after {
      content: "Ảnh học sinh";
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      background: rgba(167, 29, 42, 0.05);
      padding: 3px 0;
      font-size: 12px;
      color: var(--primary-color);
    }

    .score-table {
      border-collapse: collapse;
      width: 100%;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(167, 29, 42, 0.05);
    }

    .score-table th,
    .score-table td {
      border: 1px solid #f0d6d9;
      padding: 12px;
      text-align: center;
    }

    .score-table th {
      background-color: var(--primary-color);
      color: white;
      font-weight: 500;
      letter-spacing: 0.5px;
    }

    .score-table td {
      font-weight: 500;
      font-size: 16px;
    }

    .score-table tr:nth-child(even) {
      background-color: #fdf3f4;
    }

    .stamp-signature {
      display: flex;
      justify-content: space-between;
      margin-top: 50px;
      align-items: flex-end;
    }

    .stamp {
      width: 150px;
      height: 100px;
      border: 1px dashed var(--primary-color);
      text-align: center;
      line-height: 100px;
      color: var(--primary-color);
      border-radius: 4px;
      background-color: #fdf3f4;
      font-size: 13px;
      opacity: 0.8;
    }

    .signature {
      width: 200px;
      border-bottom: 1px solid var(--primary-color);
      text-align: center;
      color: var(--primary-color);
      padding-bottom: 5px;
      margin-bottom: 5px;
    }

    .signature::after {
      content: "Ký tên";
      display: block;
      font-size: 12px;
      color: var(--primary-color);
      margin-top: 5px;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 30px;
      box-shadow: 0 1px 3px rgba(167, 29, 42, 0.05);
    }

    .data-table th, .data-table td {
      border: 1px solid #f0d6d9;
      padding: 12px;
      text-align: left;
    }

    .data-table th {
      background-color: var(--primary-color);
      color: white;
      text-align: center;
      font-weight: 500;
      letter-spacing: 0.5px;
    }

    .data-table tr:nth-child(even) {
      background-color: #fdf3f4;
    }

    .center-text {
      text-align: center;
    }

    .no-data {
      text-align: center;
      color: var(--text-light);
      font-style: italic;
      padding: 20px;
    }

    #progressChart {
      margin: 20px 0 30px;
      background-color: white;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      border: 1px solid #f0d6d9;
      width: 100%;
      max-width: 800px;
      height: 400px;
    }

    .score-excellent { color: var(--success-color); font-weight: 600; }
    .score-good { color: #2a9d8f; }
    .score-average { color: var(--warning-color); }
    .score-poor { color: var(--danger-color); }

    @media (max-width: 768px) {
      .trf-container { padding: 25px; }
      .header { flex-direction: column; text-align: center; }
      .logo-group { margin-top: 20px; }
      .header-left h1 { font-size: 24px; }
      .stamp-signature { flex-direction: column; gap: 20px; }
      .candidate-details td:first-child { display: none; }
    }

    @media print {
      @page { size: A4; margin: 0; }
      body { 
        background-color: white !important;
        padding: 40px 20px !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      .trf-container { 
        box-shadow: none !important;
        border: 1px solid #ccc !important;
      }
      .no-print { display: none !important; }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="trf-container">
  <div class="header">
    <div class="header-left">
      <h1>BÁO CÁO KẾT QUẢ HỌC TẬP</h1>
      <p><strong>Trung tâm khoa bảng - Lớp thầy DR.Henry Đàm</strong></p>
    </div>
    <div class="logo-group">
      <img src="https://github.com/nguyenbatyads37/static-html-show-data/blob/main/KHOA%20B%E1%BA%A2NG%201-01.jpg?raw=true" alt="Logo">
    </div>
  </div>

  <div class="month-filter">
    <label>Chọn tháng:</label>
    <select id="monthSelect">
      <option value="all">Tất cả tháng</option>
    </select>
  </div>

  <div class="section-title">THÔNG TIN HỌC VIÊN</div>
  <table class="candidate-details">
    <tr>
      <td rowspan="4" style="width: 150px; text-align:center;">
        <div class="candidate-photo"></div>
      </td>
      <th>Họ và tên</th>
      <td id="student-name">...</td>
    </tr>
    <tr>
      <th>Lớp</th>
      <td id="student-class">...</td>
    </tr>
    <tr>
      <th>Xếp hạng</th>
      <td id="student-rank">...</td>
    </tr>
    <tr>
      <th>Ngày báo cáo</th>
      <td id="report-date">...</td>
    </tr>
  </table>

  <div class="section-title">KẾT QUẢ TỔNG HỢP</div>
  <table class="score-table">
    <tr>
      <th>Chuyên cần</th>
      <th>Điểm KT</th>
      <th>BTVN</th>
      <th>Tiến bộ</th>
    </tr>
    <tr>
      <td id="attendance">...</td>
      <td id="test-score">...</td>
      <td id="homework">...</td>
      <td id="progress">...</td>
    </tr>
  </table>

  <div class="section-title">CHI TIẾT HỌC TẬP</div>
  <table class="data-table">
    <thead>
      <tr>
        <th style="width:50px">STT</th>
        <th>Ngày</th>
        <th>Chuyên cần</th>
        <th>Hoàn thành BT</th>
        <th>Điểm KT</th>
        <th>Trạng thái</th>
      </tr>
    </thead>
    <tbody id="learningData"></tbody>
  </table>

  <div class="section-title">LỊCH SỬ KIỂM TRA</div>
  <table class="data-table">
    <thead>
      <tr>
        <th style="width:50px">STT</th>
        <th>Ngày</th>
        <th>Tên bài KT</th>
        <th>Điểm</th>
      </tr>
    </thead>
    <tbody id="testData"></tbody>
  </table>

  <div class="section-title">BIỂU ĐỒ TIẾN BỘ</div>
  <canvas id="progressChart"></canvas>

  <div class="stamp-signature">
    <div class="stamp">CON DẤU</div>
    <div class="signature">NGƯỜI LẬP BÁO CÁO</div>
  </div>
</div>

<script>
let allLearningData = [];
let allTestData = [];
let chartInstance = null;

// Hàm xử lý URL parameters
function getUrlParams(url) {
  try {
    const params = new URLSearchParams(new URL(url).search);
    const result = {};
    for (const [key, value] of params.entries()) {
      result[key] = decodeURIComponent(value.replace(/\+/g, ' '));
    }
    return result;
  } catch (error) {
    console.error('Lỗi xử lý URL:', error);
    return {};
  }
}

// Xử lý dữ liệu học tập
function processLearningData(dataStr) {
  if (!dataStr) return [];
  try {
    return dataStr.split('_b_').map(item => {
      const [date, attendance, homework, testScore, , , status] = item.split('_a_');
      return {
        date: date || 'N/A',
        attendance: attendance || 'N/A',
        homework: parseInt(homework) || 0,
        testScore: parseInt(testScore) || 0,
        status: status || 'N/A'
      };
    }).filter(item => item.date).sort((a, b) => new Date(a.date) - new Date(b.date));
  } catch (error) {
    console.error('Lỗi xử lý dữ liệu học tập:', error);
    return [];
  }
}

// Xử lý dữ liệu kiểm tra
function processTestData(testStr) {
  if (!testStr) return [];
  try {
    return testStr.split('_b_').map(item => {
      const [date, testName, score] = item.split('_a_');
      return {
        date: date || 'N/A',
        testName: testName || 'N/A',
        score: parseFloat(score) || 0
      };
    }).filter(item => item.date).sort((a, b) => new Date(a.date) - new Date(b.date));
  } catch (error) {
    console.error('Lỗi xử lý dữ liệu kiểm tra:', error);
    return [];
  }
}

// Cập nhật dropdown tháng
function updateMonthFilter() {
  const monthSet = new Set();
  
  const processDate = (dateString) => {
    try {
      const date = new Date(dateString);
      return `${date.getMonth() + 1}/${date.getFullYear()}`;
    } catch {
      return null;
    }
  };

  [...allLearningData, ...allTestData].forEach(item => {
    const monthYear = processDate(item.date);
    if (monthYear) monthSet.add(monthYear);
  });

  const months = Array.from(monthSet).sort((a, b) => {
    const [m1, y1] = a.split('/');
    const [m2, y2] = b.split('/');
    return new Date(y1, m1-1) - new Date(y2, m2-1);
  });

  const select = document.getElementById('monthSelect');
  select.innerHTML = '<option value="all">Tất cả tháng</option>';
  months.forEach(month => {
    const option = document.createElement('option');
    option.value = month;
    option.textContent = `Tháng ${month}`;
    select.appendChild(option);
  });
}

// Lọc dữ liệu theo tháng
function filterData(selectedMonth) {
  if (selectedMonth === 'all') return {
    learning: allLearningData,
    tests: allTestData
  };

  const [month, year] = selectedMonth.split('/');
  const filterFunc = item => {
    try {
      const date = new Date(item.date);
      return date.getMonth() + 1 === parseInt(month) && 
             date.getFullYear() === parseInt(year);
    } catch {
      return false;
    }
  };

  return {
    learning: allLearningData.filter(filterFunc),
    tests: allTestData.filter(filterFunc)
  };
}

// Cập nhật giao diện
function updateUI(selectedMonth = 'all') {
  const { learning, tests } = filterData(selectedMonth);
  
  // Cập nhật bảng học tập
  const learningBody = document.getElementById('learningData');
  learningBody.innerHTML = learning.map((item, index) => `
    <tr>
      <td class="center-text">${index + 1}</td>
      <td>${item.date}</td>
      <td>${item.attendance}</td>
      <td class="${getScoreClass(item.homework)}">${item.homework}%</td>
      <td class="${getScoreClass(item.testScore)}">${item.testScore}%</td>
      <td>${item.status}</td>
    </tr>
  `).join('') || '<tr><td colspan="6" class="no-data">Không có dữ liệu</td></tr>';

  // Cập nhật bảng kiểm tra
  const testBody = document.getElementById('testData');
  testBody.innerHTML = tests.map((item, index) => `
    <tr>
      <td class="center-text">${index + 1}</td>
      <td>${item.date}</td>
      <td>${item.testName}</td>
      <td class="${getScoreClass(item.score)}">${item.score}</td>
    </tr>
  `).join('') || '<tr><td colspan="4" class="no-data">Không có dữ liệu</td></tr>';

  // Cập nhật biểu đồ
  updateChart(tests);
}

// Vẽ biểu đồ
function updateChart(testData) {
  if (chartInstance) chartInstance.destroy();
  
  const ctx = document.getElementById('progressChart').getContext('2d');
  const validData = testData.filter(item => item.score > 0);
  
  if (validData.length === 0) {
    document.getElementById('progressChart').style.display = 'none';
    return;
  }

  chartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: validData.map(item => `${item.date}\n${item.testName}`),
      datasets: [{
        label: 'Điểm kiểm tra',
        data: validData.map(item => item.score),
        borderColor: '#d62828',
        backgroundColor: 'rgba(214, 40, 40, 0.1)',
        tension: 0.3,
        fill: true
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: { min: 0, max: 100, title: { text: 'Điểm số', display: true } },
        x: { title: { text: 'Ngày kiểm tra', display: true } }
      }
    }
  });
}

// Phân loại điểm
function getScoreClass(score) {
  if (score >= 90) return 'score-excellent';
  if (score >= 70) return 'score-good';
  if (score >= 50) return 'score-average';
  return 'score-poor';
}

// Khởi tạo
async function init() {
  try {
    const urlParams = new URLSearchParams(window.location.search);
    const studentId = urlParams.get('id');

    const response = await fetch('https://api.appsheet.com/api/v2/apps/8dd1c446-18a3-4704-bb84-9e3e1e33ca76/tables/Báo cáo/Action', {
      method: 'POST',
      headers: {
        'ApplicationAccessKey': 'V2-0VNG2-0pOdh-cAkPw-4UYbT-W2lqQ-thshv-WUqsM-GyzvT',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        Action: 'Edit',
        Properties: {},
        Rows: [{
          email: 'vhns@nashimart.io.vn',
          'Thời gian báo cáo': 'Theo tháng',
          'id học sinh': studentId || ''
        }]
      })
    });

    const result = await response.json();
    const webUrl = result.Rows[0].web;
    if (!webUrl) throw new Error('Không có dữ liệu');

    const params = getUrlParams(webUrl);
    
    // Cập nhật thông tin học sinh
    document.getElementById('student-name').textContent = params.ten || 'N/A';
    document.getElementById('student-class').textContent = params.lop || 'N/A';
    document.getElementById('student-rank').textContent = params.xephang || 'N/A';
    document.getElementById('report-date').textContent = params.ngay || new Date().toLocaleDateString('vi-VN');
    document.getElementById('attendance').textContent = params.chuyencan || 'N/A';
    document.getElementById('test-score').textContent = params.diemkt || 'N/A';
    document.getElementById('homework').textContent = params.btvn || 'N/A';
    document.getElementById('progress').textContent = params.tienbo || 'N/A';

    // Xử lý dữ liệu
    allLearningData = processLearningData(params.data);
    allTestData = processTestData(params.idktra);

    // Khởi tạo giao diện
    updateMonthFilter();
    updateUI('all');
    
    // Sự kiện lọc
    document.getElementById('monthSelect').addEventListener('change', (e) => {
      updateUI(e.target.value);
    });

  } catch (error) {
    console.error('Lỗi hệ thống:', error);
    alert('Có lỗi xảy ra khi tải dữ liệu. Vui lòng thử lại sau.');
  }
}

document.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>


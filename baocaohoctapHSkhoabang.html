<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Báo cáo học tập</title>
  <style>
    /* ... Giữ nguyên toàn bộ CSS gốc ... */
    
    /* Thêm CSS mới cho bộ lọc tháng */
    .month-filter {
      margin: 20px 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .month-filter label {
      font-weight: 500;
      color: var(--primary-color);
    }
    
    .month-filter select {
      padding: 8px 12px;
      border: 1px solid var(--primary-color);
      border-radius: var(--border-radius);
      background-color: white;
      color: var(--text-color);
      font-size: 14px;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .month-filter select:hover {
      background-color: #fdf3f4;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="trf-container">
  <div class="header">
    <div class="header-left">
      <h1>BÁO CÁO KẾT QUẢ HỌC TẬP</h1>
      <p><strong>Trung tâm khoa bảng - Lớp thầy DR.Henry Đàm trân trọng thông báo!</strong></p>
    </div>
    <div class="logo-group">
      <img src="https://github.com/nguyenbatyads37/static-html-show-data/blob/main/KHOA%20B%E1%BA%A2NG%201-01.jpg?raw=true" alt="Logo">
    </div>
  </div>

  <!-- Thêm bộ lọc tháng -->
  <div class="month-filter">
    <label>Chọn tháng:</label>
    <select id="monthSelect">
      <option value="all">Tất cả tháng</option>
    </select>
  </div>

  <!-- ... Giữ nguyên các phần HTML khác ... -->

<script>
// Biến toàn cục
let allLearningData = [];
let allTestData = [];
let chartInstance = null;

// Hàm decode URL an toàn
function safeDecode(encoded) {
  if (!encoded) return '';
  try {
    return decodeURIComponent(encoded.replace(/\+/g, ' '));
  } catch (e) {
    return encoded;
  }
}

// Hàm xử lý dữ liệu học tập
function processLearningData(dataStr) {
  if (!dataStr || dataStr.trim() === '') return [];
  
  try {
    return dataStr.split('_b_').map(item => {
      const parts = item.split('_a_');
      return {
        ngay: safeDecode(parts[0]) || '',
        chuyenCan: safeDecode(parts[1]) || '',
        status: safeDecode(parts[6]) || '',
        hoanThanhBT: parts[2] ? parseInt(parts[2]) : null,
        diemKiemTra: parts[3] ? parseInt(parts[3]) : null
      };
    }).filter(item => item.ngay.trim() !== '').sort((a, b) => new Date(a.ngay) - new Date(b.ngay));
  } catch (e) {
    console.error('Lỗi xử lý dữ liệu học tập:', e);
    return [];
  }
}

// Hàm xử lý dữ liệu điểm kiểm tra
function processTestData(testStr) {
  if (!testStr || testStr.trim() === '') return [];
  
  try {
    return testStr.split('_b_').map(item => {
      const parts = item.split('_a_');
      return {
        ngay: safeDecode(parts[0]) || '',
        tenBaiKiemTra: safeDecode(parts[1]) || '',
        diem: parts[2] ? parseFloat(parts[2]) : null
      };
    }).filter(item => item.ngay.trim() !== '').sort((a, b) => new Date(a.ngay) - new Date(b.ngay));
  } catch (e) {
    console.error('Lỗi xử lý dữ liệu điểm kiểm tra:', e);
    return [];
  }
}

// Hàm cập nhật dropdown tháng
function updateMonthFilter() {
  const monthSet = new Set();
  
  allLearningData.forEach(item => {
    if (item.ngay) {
      const date = new Date(item.ngay);
      const monthYear = `${date.getMonth() + 1}/${date.getFullYear()}`;
      monthSet.add(monthYear);
    }
  });

  allTestData.forEach(item => {
    if (item.ngay) {
      const date = new Date(item.ngay);
      const monthYear = `${date.getMonth() + 1}/${date.getFullYear()}`;
      monthSet.add(monthYear);
    }
  });

  const months = Array.from(monthSet).sort((a, b) => {
    const [m1, y1] = a.split('/');
    const [m2, y2] = b.split('/');
    return new Date(y1, m1-1) - new Date(y2, m2-1);
  });

  const select = document.getElementById('monthSelect');
  months.forEach(month => {
    const option = document.createElement('option');
    option.value = month;
    option.textContent = `Tháng ${month}`;
    select.appendChild(option);
  });
}

// Hàm lọc dữ liệu theo tháng
function filterDataByMonth(monthYear) {
  if (monthYear === 'all') {
    return {
      learningData: allLearningData,
      testData: allTestData
    };
  }

  const [month, year] = monthYear.split('/');
  
  const filteredLearning = allLearningData.filter(item => {
    if (!item.ngay) return false;
    const date = new Date(item.ngay);
    return date.getMonth() + 1 === parseInt(month) && 
           date.getFullYear() === parseInt(year);
  });

  const filteredTest = allTestData.filter(item => {
    if (!item.ngay) return false;
    const date = new Date(item.ngay);
    return date.getMonth() + 1 === parseInt(month) && 
           date.getFullYear() === parseInt(year);
  });

  return {
    learningData: filteredLearning,
    testData: filteredTest
  };
}

// Hàm cập nhật hiển thị
function updateDisplay(monthYear) {
  const { learningData, testData } = filterDataByMonth(monthYear);
  
  // Cập nhật bảng học tập
  displayLearningData(learningData);
  
  // Cập nhật bảng điểm kiểm tra
  displayTestData(testData);
  
  // Cập nhật biểu đồ
  if (chartInstance) {
    chartInstance.destroy();
  }
  chartInstance = drawChart(testData);
}

// Hàm hiển thị dữ liệu học tập
function displayLearningData(data) {
  const tableBody = document.getElementById('tableBody');
  const noDataRow = tableBody.querySelector('.no-data-row');
  
  tableBody.innerHTML = '';
  
  if (data.length > 0) {
    noDataRow.style.display = 'none';
    tableBody.innerHTML = data.map((item, index) => {
      const getScoreClass = (score) => {
        if (score === null) return '';
        if (score >= 90) return 'score-excellent';
        if (score >= 70) return 'score-good';
        if (score >= 50) return 'score-average';
        return 'score-poor';
      };
      
      return `
        <tr>
          <td class="center-text">${index + 1}</td>
          <td>${item.ngay || 'N/A'}</td>
          <td>${item.chuyenCan || 'Không có'}</td>
          <td class="center-text ${getScoreClass(item.hoanThanhBT)}">
            ${item.hoanThanhBT !== null ? item.hoanThanhBT + '%' : 'N/A'}
          </td>
          <td class="center-text ${getScoreClass(item.diemKiemTra)}">
            ${item.diemKiemTra !== null ? item.diemKiemTra + '%' : 'N/A'}
          </td>
          <td>${item.status || 'Không có'}</td>
        </tr>
      `;
    }).join('');
  } else {
    noDataRow.style.display = '';
  }
}

// Hàm hiển thị điểm kiểm tra
function displayTestData(data) {
  const testScoreBody = document.getElementById('testScoreBody');
  const noTestDataRow = testScoreBody.querySelector('.no-data-row');
  
  testScoreBody.innerHTML = '';
  
  if (data.length > 0) {
    noTestDataRow.style.display = 'none';
    testScoreBody.innerHTML = data.map((item, index) => {
      const getScoreClass = (score) => {
        if (score === null) return '';
        if (score >= 90) return 'score-excellent';
        if (score >= 70) return 'score-good';
        if (score >= 50) return 'score-average';
        return 'score-poor';
      };
      
      return `
        <tr>
          <td class="center-text">${index + 1}</td>
          <td>${item.ngay || 'N/A'}</td>
          <td>${item.tenBaiKiemTra || 'Không có tên'}</td>
          <td class="center-text ${getScoreClass(item.diem)}">
            ${item.diem !== null ? item.diem : 'N/A'}
          </td>
        </tr>
      `;
    }).join('');
  } else {
    noTestDataRow.style.display = '';
  }
}

// Hàm vẽ biểu đồ
function drawChart(data) {
  const canvas = document.getElementById('progressChart');
  if (data.length === 0) {
    canvas.style.display = 'none';
    return null;
  }
  
  canvas.style.display = 'block';
  const validData = data.filter(item => item.diem !== null);
  
  if (validData.length === 0) {
    canvas.style.display = 'none';
    return null;
  }
  
  try {
    const ctx = canvas.getContext('2d');
    return new Chart(ctx, {
      type: 'line',
      data: {
        labels: validData.map(item => [item.ngay, item.tenBaiKiemTra]),
        datasets: [{
          label: 'Điểm bài kiểm tra',
          data: validData.map(item => item.diem),
          backgroundColor: 'rgba(214, 40, 40, 0.1)',
          borderColor: 'rgba(214, 40, 40, 1)',
          borderWidth: 2,
          pointBackgroundColor: 'rgba(214, 40, 40, 1)',
          pointRadius: 5,
          pointHoverRadius: 7,
          tension: 0.3,
          fill: true
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'top',
            labels: {
              font: {
                size: 14
              }
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0,0,0,0.7)',
            titleFont: {
              size: 16
            },
            bodyFont: {
              size: 14
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            title: {
              display: true,
              text: 'Điểm số',
              font: {
                size: 14,
                weight: 'bold'
              }
            },
            grid: {
              color: 'rgba(0,0,0,0.05)'
            }
          },
          x: {
            title: {
              display: true,
              text: 'Ngày kiểm tra',
              font: {
                size: 14,
                weight: 'bold'
              }
            },
            grid: {
              display: false
            }
          }
        }
      }
    });
  } catch (e) {
    console.error('Lỗi khi vẽ biểu đồ:', e);
    canvas.style.display = 'none';
    return null;
  }
}

// Hàm chính khi trang được tải
function init() {
  const params = new URLSearchParams(window.location.search);
  const myHeaders = new Headers();
  myHeaders.append("ApplicationAccessKey", "V2-0VNG2-0pOdh-cAkPw-4UYbT-W2lqQ-thshv-WUqsM-GyzvT");
  myHeaders.append("Content-Type", "application/json");

  const raw = JSON.stringify({
    "Action": "Edit",
    "Properties": {},
    "Rows": [
      {
        "email": "vhns@nashimart.io.vn",
        "Thời gian báo cáo": "Theo tháng",
        "id học sinh": `${params.get('id') || ''}`,
      }
    ]
  });

  const requestOptions = {
    method: "POST",
    headers: myHeaders,
    body: raw,
    redirect: "follow"
  };

  fetch("https://api.appsheet.com/api/v2/apps/8dd1c446-18a3-4704-bb84-9e3e1e33ca76/tables/Báo cáo/Action", requestOptions)
    .then((response) => response.json())
    .then((result) => {
      const webUrl = result?.Rows?.[0]?.web;
      if (!webUrl) throw new Error("Không tìm thấy đường dẫn 'web' từ API");

      const params = new URLSearchParams(new URL(webUrl).search);

      // Hiển thị thông tin cơ bản
      document.getElementById('student-name').textContent = safeDecode(params.get('ten')) || '[Tên học sinh]';
      document.getElementById('student-class').textContent = safeDecode(params.get('lop')) || '[Tên lớp]';
      document.getElementById('student-id').textContent = params.get('id') || '[Mã học sinh]';
      document.getElementById('report-date').textContent = params.get('ngay') || new Date().toLocaleDateString('vi-VN');

      // Cập nhật các chỉ số
      document.getElementById('attendance').textContent = params.get('chuyencan') || '[Chuyên cần]';
      document.getElementById('test-score').textContent = params.get('diem') || '[Điểm kiểm tra]';
      document.getElementById('homework').textContent = params.get('btvn') || '[Điểm BTVN]';
      document.getElementById('stars').textContent = params.get('sao') ? params.get('sao') + ' %' : '[Số sao]';

      // Xử lý dữ liệu
      allLearningData = processLearningData(params.get('data'));
      allTestData = processTestData(params.get('idktra'));

      // Khởi tạo bộ lọc tháng
      updateMonthFilter();
      updateDisplay('all');

      // Thêm sự kiện thay đổi lọc
      document.getElementById('monthSelect').addEventListener('change', function() {
        updateDisplay(this.value);
      });
    })
    .catch((error) => console.error("❌ Lỗi API AppSheet hoặc xử lý dữ liệu:", error));
}

document.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>


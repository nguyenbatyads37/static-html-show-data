<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <title>Báo cáo học tập</title>
  <style>
    :root {
      --primary-color: #a71d2a;
      --secondary-color: #8c1a1a;
      --accent-color: #d62828;
      --light-color: #f8f1f1;
      --success-color: #2a9d8f;
      --warning-color: #e9c46a;
      --danger-color: #e63946;
      --text-color: #333333;
      --text-light: #6c757d;
      --border-radius: 8px;
      --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      margin: 0;
      padding: 40px 20px;
      background-color: #f8f1f1;
      color: var(--text-color);
      line-height: 1.6;
    }

    .trf-container {
      width: 100%;
      max-width: 900px;
      margin: 0 auto;
      background-color: white;
      padding: 40px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(167, 29, 42, 0.2);
    }

    .trf-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 8px;
      background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(167, 29, 42, 0.1);
    }

    .header-left h1 {
      margin: 0;
      font-size: 28px;
      font-weight: 600;
      color: var(--primary-color);
      letter-spacing: -0.5px;
    }

    .header-left p {
      margin-top: 8px;
      color: var(--text-light);
      font-size: 15px;
    }

    .logo-group img {
      max-height: 80px;
      transition: var(--transition);
    }

    .logo-group:hover img {
      transform: scale(1.05);
    }

    .section-title {
      background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 12px 20px;
      font-weight: 500;
      margin: 30px 0 15px 0;
      font-size: 16px;
      border-radius: var(--border-radius);
      letter-spacing: 0.5px;
      box-shadow: 0 2px 8px rgba(167, 29, 42, 0.2);
    }

    .candidate-details,
    .test-results {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 25px;
    }

    .candidate-details td,
    .candidate-details th,
    .test-results td,
    .test-results th {
      border: 1px solid #f0d6d9;
      padding: 12px;
    }

    .candidate-details th {
      background-color: #fdf3f4;
      text-align: left;
      width: 150px;
      font-weight: 500;
      color: var(--secondary-color);
    }

    .candidate-photo {
      width: 100px;
      height: 120px;
      background: linear-gradient(135deg, #f8f1f1 0%, #f0d6d9 100%);
      display: inline-block;
      margin-bottom: 10px;
      text-align: center;
      line-height: 120px;
      color: var(--text-light);
      font-size: 14px;
      border-radius: 4px;
      box-shadow: inset 0 0 10px rgba(167, 29, 42, 0.05);
      position: relative;
      overflow: hidden;
      border: 1px solid #f0d6d9;
    }

    .candidate-photo::after {
      content: var(--content, "Ảnh học sinh");
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      background: rgba(167, 29, 42, 0.05);
      padding: 3px 0;
      font-size: 12px;
      color: var(--primary-color);
    }

    .score-table {
      border-collapse: collapse;
      width: 100%;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(167, 29, 42, 0.05);
    }

    .score-table th,
    .score-table td {
      border: 1px solid #f0d6d9;
      padding: 12px;
      text-align: center;
    }

    .score-table th {
      background-color: var(--primary-color);
      color: white;
      font-weight: 500;
      letter-spacing: 0.5px;
    }

    .score-table td {
      font-weight: 500;
      font-size: 16px;
    }

    .score-table tr:nth-child(even) {
      background-color: #fdf3f4;
    }

    .stamp-signature {
      display: flex;
      justify-content: space-between;
      margin-top: 50px;
      align-items: flex-end;
    }

    .stamp {
      width: 150px;
      height: 100px;
      border: 1px dashed var(--primary-color);
      text-align: center;
      line-height: 100px;
      color: var(--primary-color);
      border-radius: 4px;
      background-color: #fdf3f4;
      font-size: 13px;
      opacity: 0.8;
    }

    .signature {
      width: 200px;
      border-bottom: 1px solid var(--primary-color);
      text-align: center;
      color: var(--primary-color);
      padding-bottom: 5px;
      margin-bottom: 5px;
    }

    .signature::after {
      content: "Ký tên";
      display: block;
      font-size: 12px;
      color: var(--primary-color);
      margin-top: 5px;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 30px;
      box-shadow: 0 1px 3px rgba(167, 29, 42, 0.05);
    }

    .data-table th,
    .data-table td {
      border: 1px solid #f0d6d9;
      padding: 12px;
      text-align: left;
    }

    .data-table th {
      background-color: var(--primary-color);
      color: white;
      text-align: center;
      font-weight: 500;
      letter-spacing: 0.5px;
    }

    .data-table tr:nth-child(even) {
      background-color: #fdf3f4;
    }

    .center-text {
      text-align: center;
    }

    .data-table td,
    .data-table th {
      white-space: normal;
      overflow-wrap: break-word;
      word-wrap: break-word;
      vertical-align: middle;
    }

    .empty-row {
      display: none;
    }

    .no-data {
      text-align: center;
      color: var(--text-light);
      font-style: italic;
      padding: 20px;
    }

    #progressChart {
      margin: 20px 0 30px;
      background-color: white;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      border: 1px solid #f0d6d9;
      width: 100%;
      max-width: 800px;
      height: 400px;
    }

    .report-section {
      border: 1px solid #f0d6d9;
      padding: 25px;
      margin-bottom: 30px;
      background-color: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      position: relative;
    }

    .report-section h2 {
      margin-top: 0;
      margin-bottom: 15px;
      color: var(--primary-color);
      font-weight: 600;
      font-size: 20px;
      border-bottom: 1px solid #f0d6d9;
      padding-bottom: 10px;
    }

    .report-section .item-title {
      color: var(--primary-color);
      font-weight: 600;
    }

    .comment-stamp {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-15deg);
      opacity: 0.4;
      /* Giảm độ mờ xuống 40% */
      z-index: 100;
      pointer-events: none;
    }

    .comment-stamp img {
      width: 390px;
      height: auto;
      filter: sepia(0.3) brightness(1.1);
    }

    .data-table tr:hover {
      background-color: #f9e3e5;
    }

    .score-excellent {
      color: var(--success-color);
      font-weight: 600;
    }

    .score-good {
      color: #2a9d8f;
    }

    .score-average {
      color: var(--warning-color);
    }

    .score-poor {
      color: var(--danger-color);
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .trf-container {
      animation: fadeIn 0.5s ease-out;
    }

    .section-title {
      animation: fadeIn 0.6s ease-out;
    }

    @media (max-width: 768px) {
      .trf-container {
        padding: 25px;
      }

      .header {
        flex-direction: column;
        text-align: center;
      }

      .logo-group {
        margin-top: 20px;
      }

      .header-left h1 {
        font-size: 24px;
      }

      .stamp-signature {
        flex-direction: column;
        align-items: center;
        gap: 20px;
      }

      .candidate-details td:first-child {
        display: none;
      }
    }

    @media print {
      @page {
        size: A4;
        margin: 0;
      }

      body {
        background-color: white !important;
        padding: 40px 20px !important;
        margin: 0 !important;
        color: var(--text-color) !important;
        line-height: 1.6 !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }

      .trf-container {
        width: 100% !important;
        max-width: 900px !important;
        margin: 0 auto !important;
        padding: 40px !important;
        border: 1px solid rgba(167, 29, 42, 0.2) !important;
        background-color: white !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1) !important;
        border-radius: 8px !important;
        position: relative !important;
        overflow: hidden !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }

      .trf-container::before {
        content: '' !important;
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 8px !important;
        background: linear-gradient(90deg, var(--primary-color), var(--accent-color)) !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }

      .header {
        display: flex !important;
        align-items: center !important;
        justify-content: space-between !important;
        margin-bottom: 30px !important;
        padding-bottom: 20px !important;
        border-bottom: 1px solid rgba(167, 29, 42, 0.1) !important;
      }

      .section-title {
        background: linear-gradient(to right, var(--primary-color), var(--secondary-color)) !important;
        color: white !important;
        padding: 12px 20px !important;
        margin: 30px 0 15px 0 !important;
        border-radius: 8px !important;
        box-shadow: 0 2px 8px rgba(167, 29, 42, 0.2) !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }

      .candidate-details th,
      .score-table th,
      .data-table th {
        background-color: var(--primary-color) !important;
        color: white !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }

      .candidate-details th {
        background-color: #fdf3f4 !important;
        color: var(--secondary-color) !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }

      .score-table tr:nth-child(even),
      .data-table tr:nth-child(even) {
        background-color: #fdf3f4 !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }

      .candidate-photo {
        background: linear-gradient(135deg, #f8f1f1 0%, #f0d6d9 100%) !important;
        border: 1px solid #f0d6d9 !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }

      .stamp {
        background-color: #fdf3f4 !important;
        border: 1px dashed var(--primary-color) !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }

      #progressChart {
        display: block !important;
        width: 800px !important;
        height: 400px !important;
        margin: 20px 0 30px !important;
        padding: 20px !important;
        border: 1px solid #f0d6d9 !important;
        border-radius: 8px !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1) !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }

      .comment-stamp {
        position: fixed !important;
        top: 50% !important;
        left: 50% !important;
        transform: translate(-50%, -50%) rotate(-15deg) !important;
        opacity: 0.4 !important;
        /* Giữ nguyên độ mờ 40% khi in */
        z-index: 100 !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }

      .comment-stamp img {
        width: 390px !important;
        height: auto !important;
        filter: sepia(0.3) brightness(1.1) !important;
      }

      .report-section {
        border: 1px solid #f0d6d9 !important;
        padding: 25px !important;
        margin-bottom: 30px !important;
        background-color: white !important;
        border-radius: 8px !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1) !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }

      .empty-row {
        display: none !important;
      }

      .no-print {
        display: none !important;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

  <div class="trf-container">
    <div class="header">
      <div class="header-left">
        <h1>BÁO CÁO KẾT QUẢ HỌC TẬP</h1>
        <p><strong>Trung tâm khoa bảng - Lớp thầy DR.Henry Đàm trân trọng thông báo!</strong></p>
      </div>
      <div class="logo-group">
        <img
          src="https://github.com/nguyenbatyads37/static-html-show-data/blob/main/KHOA%20B%E1%BA%A2NG%201-01.jpg?raw=true"
          alt="Logo">
      </div>
    </div>

    <div class="section-title">THÔNG TIN HỌC VIÊN</div>
    <table class="candidate-details">
      <tr>
        <td rowspan="4" style="width: 150px; text-align:center;">
          <div class="candidate-photo"></div>
        </td>
        <th>Họ và tên</th>
        <td id="student-name">[Tên học sinh]</td>
      </tr>
      <tr>
        <th>Lớp</th>
        <td id="student-class">[Tên lớp]</td>
      </tr>
      <tr>
        <th>Xếp hạng</th>
        <td id="student-id">[Mã học sinh]</td>
      </tr>
      <tr>
        <th>Ngày báo cáo</th>
        <td id="report-date">[Ngày báo cáo]</td>
      </tr>
    </table>

    <table class="score-table">
      <tr>
        <th>Chuyên cần</th>
        <th>Điểm kiểm tra</th>
        <th>Điểm BTVN</th>
        <th>% Tích lũy</th>
      </tr>
      <tr>
        <td id="attendance">[Chuyên cần]</td>
        <td id="test-score">[Điểm kiểm tra]</td>
        <td id="homework">[Điểm BTVN]</td>
        <td id="stars">[Số sao]</td>
      </tr>
    </table>

    <div class="section-title">CHI TIẾT HỌC TẬP</div>
    <table class="data-table">
      <thead>
        <tr>
          <th style="width: 50px;">STT</th>
          <th>Ngày</th>
          <th>Chuyên cần</th>
          <th>% Hoàn thành bài tập</th>
          <th>% Điểm kiểm tra</th>
          <th>Trạng thái</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        <tr class="no-data-row">
          <td colspan="6" class="no-data">Không có dữ liệu học tập</td>
        </tr>
      </tbody>
    </table>

    <div class="section-title">ĐIỂM KIỂM TRA CÁC NGÀY</div>
    <table class="data-table">
      <thead>
        <tr>
          <th style="width: 50px;">STT</th>
          <th>Ngày kiểm tra</th>
          <th>Tên Bài Kiểm Tra</th>
          <th>Điểm</th>
        </tr>
      </thead>
      <tbody id="testScoreBody">
        <tr class="no-data-row">
          <td colspan="4" class="no-data">Không có dữ liệu điểm kiểm tra</td>
        </tr>
      </tbody>
    </table>

    <div class="section-title">BIỂU ĐỒ TIẾN BỘ HỌC TẬP</div>
    <canvas id="progressChart" width="800" height="400"></canvas>

    <div class="report-section">
      <h2>BÁO CÁO TỔNG KẾT</h2>
      <div id="comment">
        <p><span class="item-title">1. Tiến bộ học tập</span>: Học sinh đã có sự cải thiện đáng kể trong các bài kiểm
          tra gần đây.</p>
        <p><span class="item-title">2. Tham gia lớp học</span>: Thường xuyên tham gia và tích cực trong các buổi học.
        </p>
        <p><span class="item-title">3. Đề xuất cải thiện</span>: Cần tập trung hơn vào việc hoàn thành bài tập về nhà
          đúng hạn.</p>
      </div>
    </div>

    <div class="comment-stamp" id="commentStamp">
      <img
        src="https://www.appsheet.com/template/gettablefileurl?appName=B%C3%A1ogi%C3%A1s%E1%BA%A3nph%E1%BA%9F-325045268&tableName=c%C3%A0i%20%C4%91%E1%BA%B7t%20APP&fileName=C%C3%A0i%20%C4%91%E1%BA%B7t%20APP_Images%2Fae184aa6.%E1%BA%A2nh.054008.png"
        alt="Con dấu">
    </div>

    <div class="stamp-signature">
      <div class="stamp">CON DẤU</div>
      <div class="signature">NGƯỜI LẬP BÁO CÁO</div>
    </div>
  </div>

  <script>
    // Hàm decode URL an toàn
    function safeDecode(encoded) {
      if (!encoded) return '';
      try {
        return decodeURIComponent(encoded.replace(/\+/g, ' '));
      } catch (e) {
        return encoded;
      }
    }

    function normalizeDate(str) {
      // Giả sử định dạng đầu vào là dd/mm/yyyy hoặc d/m/yyyy
      const parts = str.trim().split(/[\/\-]/); // Tách theo / hoặc -
      if (parts.length === 3) {
        const [d, m, y] = parts;
        return `${y.padStart(4, '20')}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
      }
      return str; // Trả nguyên nếu không đúng định dạng
    }


    // Hàm xử lý dữ liệu học tập và sắp xếp theo ngày tăng dần
    function processLearningData(dataStr) {
      if (!dataStr || dataStr.trim() === '') return [];

      try {
        return dataStr.split('_b_').map(item => {
          const parts = item.split('_a_');

          return {
            ngay: normalizeDate(safeDecode(parts[0])) || '',
            chuyenCan: safeDecode(parts[1]) || '',
            status: safeDecode(parts[6]) || '',
            hoanThanhBT: parts[2] ? parseInt(parts[2]) : null,
            diemKiemTra: parts[3] ? parseInt(parts[3]) : null
          };
        }).filter(item => item.ngay.trim() !== '').sort((a, b) => new Date(a.ngay) - new Date(b.ngay));  // Sắp xếp theo ngày
      } catch (e) {
        console.error('Lỗi xử lý dữ liệu học tập:', e);
        return [];
      }
    }

    // Hàm xử lý dữ liệu điểm kiểm tra và sắp xếp theo ngày tăng dần
    function processTestData(testStr) {
      if (!testStr || testStr.trim() === '') return [];

      try {
        return testStr.split('_b_').map(item => {
          const parts = item.split('_a_');
          return {
            ngay: normalizeDate(safeDecode(parts[0])) || '',
            tenBaiKiemTra: safeDecode(parts[1]) || '',
            diem: parts[2] ? parseFloat(parts[2]) : null
          };
        }).filter(item => item.ngay.trim() !== '').sort((a, b) => new Date(a.ngay) - new Date(b.ngay));  // Sắp xếp theo ngày
      } catch (e) {
        console.error('Lỗi xử lý dữ liệu điểm kiểm tra:', e);
        return [];
      }
    }

    // Hàm hiển thị dữ liệu học tập
    function displayLearningData(data) {
      const tableBody = document.getElementById('tableBody');
      const noDataRow = tableBody.querySelector('.no-data-row');

      if (data.length > 0) {
        noDataRow.style.display = 'none';

        tableBody.innerHTML = data.map((item, index) => {
          const getScoreClass = (score) => {
            if (score === null) return '';
            if (score >= 90) return 'score-excellent';
            if (score >= 70) return 'score-good';
            if (score >= 50) return 'score-average';
            return 'score-poor';
          };

          return `
        <tr>
          <td class="center-text">${index + 1}</td>
          <td>${item.ngay || 'N/A'}</td>
          <td>${item.chuyenCan || 'Không có'}</td>
          <td class="center-text ${getScoreClass(item.hoanThanhBT)}">
            ${item.hoanThanhBT !== null ? item.hoanThanhBT + '%' : 'N/A'}
          </td>
          <td class="center-text ${getScoreClass(item.diemKiemTra)}">
            ${item.diemKiemTra !== null ? item.diemKiemTra + '%' : 'N/A'}
          </td>
          <td>${item.status || 'Không có'}</td>
        </tr>
      `;
        }).join('');
      }
    }

    // Hàm hiển thị điểm kiểm tra
    function displayTestData(data) {
      const testScoreBody = document.getElementById('testScoreBody');
      const noTestDataRow = testScoreBody.querySelector('.no-data-row');

      if (data.length > 0) {
        noTestDataRow.style.display = 'none';

        testScoreBody.innerHTML = data.map((item, index) => {
          const getScoreClass = (score) => {
            if (score === null) return '';
            if (score >= 90) return 'score-excellent';
            if (score >= 70) return 'score-good';
            if (score >= 50) return 'score-average';
            return 'score-poor';
          };

          return `
        <tr>
          <td class="center-text">${index + 1}</td>
          <td>${item.ngay || 'N/A'}</td>
          <td>${item.tenBaiKiemTra || 'Không có tên'}</td>
          <td class="center-text ${getScoreClass(item.diem)}">
            ${item.diem !== null ? item.diem : 'N/A'}
          </td>
        </tr>
      `;
        }).join('');
      }
    }

    // Hàm vẽ biểu đồ
    function drawChart(data) {
      if (data.length === 0) {
        document.getElementById('progressChart').style.display = 'none';
        return;
      }

      const validData = data.filter(item => item.diem !== null);
      if (validData.length === 0) {
        document.getElementById('progressChart').style.display = 'none';
        return;
      }

      const labels = validData.map(item => [item.ngay, item.tenBaiKiemTra]);
      const scores = validData.map(item => item.diem);

      try {
        const ctx = document.getElementById('progressChart').getContext('2d');
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'Điểm bài kiểm tra',
              data: scores,
              backgroundColor: 'rgba(214, 40, 40, 0.1)',
              borderColor: 'rgba(214, 40, 40, 1)',
              borderWidth: 2,
              pointBackgroundColor: 'rgba(214, 40, 40, 1)',
              pointRadius: 5,
              pointHoverRadius: 7,
              tension: 0.3,
              fill: true
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: 'top',
                labels: {
                  font: {
                    size: 14
                  }
                }
              },
              tooltip: {
                backgroundColor: 'rgba(0,0,0,0.7)',
                titleFont: {
                  size: 16
                },
                bodyFont: {
                  size: 14
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
                title: {
                  display: true,
                  text: 'Điểm số',
                  font: {
                    size: 14,
                    weight: 'bold'
                  }
                },
                grid: {
                  color: 'rgba(0,0,0,0.05)'
                }
              },
              x: {
                title: {
                  display: true,
                  text: 'Ngày kiểm tra',
                  font: {
                    size: 14,
                    weight: 'bold'
                  }
                },
                grid: {
                  display: false
                }
              }
            }
          }
        });
      } catch (e) {
        console.error('Lỗi khi vẽ biểu đồ:', e);
        document.getElementById('progressChart').style.display = 'none';
      }
    }

    // Hàm chính khi trang được tải
    function init() {
      const params = new URLSearchParams(window.location.search);
      const myHeaders = new Headers();
      myHeaders.append("ApplicationAccessKey", "V2-0VNG2-0pOdh-cAkPw-4UYbT-W2lqQ-thshv-WUqsM-GyzvT");
      myHeaders.append("Content-Type", "application/json");

      const raw = JSON.stringify({
        "Action": "Edit",
        "Properties": {},
        "Rows": [
          {
            "email": "vhns@nashimart.io.vn",
            "Thời gian báo cáo": "Theo tháng",
            "id học sinh": `${params.get('id') || ''}`,
          }
        ]
      });

      const requestOptions = {
        method: "POST",
        headers: myHeaders,
        body: raw,
        redirect: "follow"
      };

      fetch("https://api.appsheet.com/api/v2/apps/8dd1c446-18a3-4704-bb84-9e3e1e33ca76/tables/Báo cáo/Action", requestOptions)
        .then((response) => response.json())
        .then((result) => {
          const webUrl = result?.Rows?.[0]?.web;
          if (!webUrl) throw new Error("Không tìm thấy đường dẫn 'web' từ API");

          const params = urlToJson(webUrl); // sử dụng hàm xử lý URL

          // Hiển thị thông tin cơ bản
          document.getElementById('student-name').textContent = safeDecode(params.ten) || '[Tên học sinh]';
          document.getElementById('student-class').textContent = safeDecode(params.lop) || '[Tên lớp]';
          document.getElementById('student-id').textContent = params.id || '[Mã học sinh]';

          // Xử lý ngày báo cáo
          const today = new Date();
          document.getElementById('report-date').textContent = params.ngay ||
            today.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });

          // Xử lý các điểm số
          document.getElementById('attendance').textContent = params.chuyencan || '[Chuyên cần]';
          document.getElementById('test-score').textContent = params.diem || '[Điểm kiểm tra]';
          document.getElementById('homework').textContent = params.btvn || '[Điểm BTVN]';
          document.getElementById('stars').textContent = params.sao ? params.sao + ' %' : '[Số sao]';

          // Xử lý nhận xét
          const nhanxet = params.nhanxet;
          if (nhanxet) {
            document.getElementById('comment').innerHTML = safeDecode(nhanxet)
              .replace(/###/g, '<h3>')
              .replace(/<\/br>/g, '<br>')
              .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
          }

          // Xử lý con dấu
          const condau = params.condau;
          const commentStamp = document.getElementById('commentStamp');
          if (condau && condau !== '0' && condau !== 'false') {
            commentStamp.querySelector('img').src = safeDecode(condau);
          } else {
            commentStamp.style.display = 'none';
          }

          // Lấy phần tử có class 'candidate-photo'
          const candidatePhotoDiv = document.querySelector('.candidate-photo');

          // Tạo một thẻ <img> mới
          const img = document.createElement('img');
          img.src = params.anhHocSinh || ''; // Kiểm tra nếu có URL ảnh
          img.alt = 'Ảnh học sinh';
          img.style.width = '100%'; // Thiết lập kích thước ảnh
          img.style.height = '100%';
          img.style.objectFit = 'cover'; // Đảm bảo ảnh không bị méo
          img.style.borderRadius = '4px'; // Thêm bo góc cho ảnh
          img.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.1)'; // Thêm bóng cho ảnh
          img.style.transition = 'transform 0.3s ease'; // Thêm hiệu ứng khi hover
          img.style.cursor = 'pointer'; // Thêm con trỏ tay khi hover

          // Thêm thẻ <img> vào phần tử .candidate-photo
          candidatePhotoDiv.appendChild(img);

          // Kiểm tra nếu có URL ảnh, để thay đổi nội dung của ::after
          if (img.src && img.src !== '') {
            // Nếu có URL ảnh, loại bỏ nội dung content của ::after
            candidatePhotoDiv.style.setProperty('--content', 'none');
          } else {
            // Nếu không có ảnh, giữ nguyên nội dung content của ::after
            candidatePhotoDiv.style.setProperty('--content', '"Ảnh học sinh"');
          }



          // Xử lý dữ liệu học tập
          const learningData = processLearningData(params.data);
          displayLearningData(learningData);
          // Xử lý điểm kiểm tra
          const testData = processTestData(params.idktra);
          displayTestData(testData);
          drawChart(testData);
        })
        .catch((error) => console.error("❌ Lỗi API AppSheet hoặc xử lý dữ liệu:", error));
    }


    function isEncoded(str) {
      try {
        return str !== decodeURIComponent(str);
      } catch (e) {
        return false;
      }
    }

    function urlToJson(url) {
      const queryString = url.split('?')[1]; // chỉ lấy phần sau '?'
      const params = new URLSearchParams(queryString);
      const json = {};

      for (const [key, value] of params.entries()) {
        if (isEncoded(value)) {
          try {
            json[key] = decodeURIComponent(value);
          } catch (e) {
            console.warn(`⚠️ Lỗi khi decode giá trị của '${key}':`, value);
            json[key] = value; // fallback
          }
        } else {
          json[key] = value;
        }
      }

      return json;
    }




    // Khởi chạy khi trang được tải
    document.addEventListener('DOMContentLoaded', init);
  </script>

</body>

</html>

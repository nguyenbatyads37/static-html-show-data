<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <title>Báo cáo chi phí tổng hợp</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    /* --- CÀI ĐẶT CHUNG & TABS --- */
    body {
      font-family: 'Roboto', Arial, sans-serif;
      padding: 20px;
      background-color: #f4f4f4;
      color: #333;
      font-size: 16px;
      overflow-x: hidden;
    }

    .tab-container {
      overflow: hidden;
      border-bottom: 2px solid #ccc;
      margin-bottom: 20px;
    }

    .tab-container button {
      background-color: #f1f1f1;
      float: left;
      border: none;
      outline: none;
      cursor: pointer;
      padding: 14px 20px;
      transition: 0.3s;
      font-size: 17px;
      font-weight: 500;
      border-radius: 8px 8px 0 0;
      margin-right: 5px;
    }

    .tab-container button:hover {
      background-color: #ddd;
    }

    .tab-container button.active {
      background-color: #2d7c2d;
      color: white;
    }

    .tab-content {
      display: none;
      padding: 6px 12px;
      border-top: none;
      animation: fadeIn 0.5s;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    /* --- STYLES CHUNG CHO BẢNG & CĂN LỀ --- */
    .table-responsive-container {
      /* bỏ scroll ngang, để bảng fit theo width */
      overflow-x: visible;
      margin-bottom: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed; /* quan trọng để ép bảng trong 1 width */
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    th,
    td {
      border: 1px solid #e0e0e0;
      padding: 6px 6px;
      white-space: normal;          /* cho phép xuống dòng */
      word-wrap: break-word;
      word-break: break-word;
      vertical-align: middle;
      transition: background-color 0.2s;
      font-size: 13px;
    }

    th {
      text-align: center !important;
      font-size: 13px;
      font-weight: 600;
    }

    td {
      text-align: right !important;
    }

    /* Điều chỉnh riêng cho bảng KPI: chữ nhỏ + padding nhỏ để fit */
    #kpi-summary-table th,
    #kpi-summary-table td {
      padding: 3px 4px;
      font-size: 11px;
    }

    #kpi-summary-table th {
      font-size: 11px;
    }

    .text-left {
      text-align: left !important;
    }

    .text-center {
      text-align: center !important;
    }

    /* CẢI THIỆN KHẢ NĂNG ĐỌC BẢNG */
    tbody tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    tbody tr:not(.team-header-row):not(.total-row):not(.highlight):hover {
      background-color: #eff5fb;
    }

    th.green-header {
      background: #4CAF50;
      color: white;
      font-weight: 700;
    }

    th.blue-header {
      background: #4CAF50;
      color: white;
      font-weight: 700;
    }

    th.yellow-header {
      background: #FFC107;
      color: #424242;
      font-weight: 700;
    }

    tr.total-row,
    tr.total-row:hover {
      background: #2d7c2d;
      color: white;
      font-weight: 700;
      font-size: 1.1em;
      border-bottom: 3px solid #FFC107;
    }

    .total-row .total-label {
      text-transform: uppercase;
      text-align: left !important;
    }

    .total-row .total-value {
      text-align: right !important;
    }

    .bg-green {
      background-color: #4CAF50 !important;
      color: white;
    }

    .bg-yellow {
      background-color: #FFEB3B !important;
      color: #424242;
    }

    .bg-lightred {
      background-color: #F44336 !important;
      color: white;
    }

    .bg-lightblue {
      background-color: #2196F3 !important;
      color: white;
    }

    /* --- STYLES CHO TABS & LAYOUT CHUNG --- */
    .report-container {
      display: flex;
      gap: 20px;
    }

    .sidebar {
      width: 260px;
      flex-shrink: 0;
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .sidebar h3 {
      background: #2d7c2d;
      color: #fff;
      padding: 10px;
      margin-top: 10px;
      font-size: 18px;
      border-radius: 4px;
      font-weight: 700;
    }

    .sidebar label {
      display: block;
      margin: 8px 0;
      font-size: 15px;
      cursor: pointer;
    }

    .sidebar .indent {
      margin-left: 16px;
    }

    .sidebar input[type="date"],
    .sidebar select {
      width: 100%;
      box-sizing: border-box;
      padding: 8px;
      margin: 4px 0 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 15px;
    }

    .main-content-area {
      flex-grow: 1;
    }

    .header {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .header img {
      height: 60px;
      margin-right: 15px;
      border-radius: 50%;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    .header h2 {
      margin: 0;
      color: #2d7c2d;
      font-weight: 700;
      font-size: 24px;
    }

    /* --- CHỈ BÁO ĐANG TẢI --- */
    #loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      font-size: 1.5em;
      font-weight: bold;
      color: #2d7c2d;
      transition: opacity 0.3s, visibility 0.3s;
      visibility: hidden;
      opacity: 0;
    }

    #loading-overlay.visible {
      visibility: visible;
      opacity: 1;
    }

    /* --- CSS CHO SẮP XẾP BẢNG --- */
    .sortable-table th {
      cursor: pointer;
      position: relative;
    }

    .sortable-table th .sort-icon {
      position: absolute;
      right: 4px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.7em;
      opacity: 0.4;
      transition: opacity 0.2s;
    }

    .sortable-table th:hover .sort-icon {
      opacity: 0.8;
    }

    .sortable-table th.sorted .sort-icon {
      opacity: 1;
    }

    .sortable-table th .sort-icon.asc::after {
      content: " ▲";
    }

    .sortable-table th .sort-icon.desc::after {
      content: " ▼";
    }

    /* --- CSS CHO KPI TABLE COLUMN CONTROLS --- */
    .column-controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      font-size: 12px;
    }

    .column-controls label {
      display: inline-flex;
      align-items: center;
      margin: 0;
      padding: 4px 8px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
      font-size: 11px;
    }

    .column-controls label:hover {
      background: #f0f0f0;
    }

    .column-controls input[type="checkbox"] {
      margin-right: 4px;
    }

    /* --- CSS CHO BẢNG KPI VỚI HEADER 2 DÒNG --- */
    #kpi-summary-table th[rowspan] {
      vertical-align: middle;
    }

    #kpi-summary-table th[colspan] {
      text-align: center;
    }

    #kpi-summary-table td[data-col-index],
    #kpi-summary-table th[data-col-index] {
      transition: all 0.3s ease;
    }

    /* Badges nguồn dữ liệu */
    .badge {
      display: inline-block;
      padding: 2px 5px;
      font-size: 10px;
      line-height: 1;
      border-radius: 3px;
      letter-spacing: .5px;
      font-weight: 600;
      cursor: help;
      background: #ccc;
      color: #222;
      margin-left: 3px;
    }

    .badge.tt {
      background: #2e7d32;
      color: #fff;
    }

    .badge.api {
      background: #1565c0;
      color: #fff;
    }

    .badge.mix {
      background: #ff9800;
      color: #fff;
    }

    .badge.der {
      background: #6d4c41;
      color: #fff;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
</head>

<body>
  <div id="loading-overlay">Đang tải dữ liệu...</div>
  <div class="tab-container">
    <button class="tablinks" onclick="openTab(event, 'KpiReport')" id="defaultOpen">Báo cáo KPI</button>
    <!-- TAB MỚI: Báo cáo thủ công, ẩn mặc định -->
    <button class="tablinks" onclick="openTab(event, 'ManualReport')" id="manual-report-tab-btn"
      style="display: none;">Báo cáo thủ công</button>
  </div>
  <!-- TAB 2: BÁO CÁO KPI -->
  <div id="KpiReport" class="tab-content">
    <div class="report-container">
      <div class="sidebar">
        <h3>Bộ lọc</h3>
        <label for="quick-date-select-tab3">Chọn nhanh:</label>
        <select id="quick-date-select-tab3">
          <option value="">-- Chọn nhanh --</option>
          <optgroup label="Ngày">
            <option value="today">Hôm nay</option>
            <option value="yesterday">Hôm qua</option>
          </optgroup>
          <optgroup label="Tuần">
            <option value="lastWeek">Tuần trước</option>
            <option value="thisWeek">Tuần này</option>
            <option value="nextWeek">Tuần sau</option>
          </optgroup>
          <optgroup label="Tháng">
            <option value="thisMonth">Tháng này</option>
            <option value="month_1">Tháng 1</option>
            <option value="month_2">Tháng 2</option>
            <option value="month_3">Tháng 3</option>
            <option value="month_4">Tháng 4</option>
            <option value="month_5">Tháng 5</option>
            <option value="month_6">Tháng 6</option>
            <option value="month_7">Tháng 7</option>
            <option value="month_8">Tháng 8</option>
            <option value="month_9">Tháng 9</option>
            <option value="month_10">Tháng 10</option>
            <option value="month_11">Tháng 11</option>
            <option value="month_12">Tháng 12</option>
          </optgroup>
          <optgroup label="Quý">
            <option value="quarter_1">Quý 1</option>
            <option value="quarter_2">Quý 2</option>
            <option value="quarter_3">Quý 3</option>
            <option value="quarter_4">Quý 4</option>
          </optgroup>
        </select>
        <label for="start-date-tab3">Từ ngày:</label><input type="date" id="start-date-tab3">
        <label for="end-date-tab3">Đến ngày:</label><input type="date" id="end-date-tab3">
        <h3>Sản phẩm</h3>
        <label><input type="checkbox" id="product-all-tab3" checked> Tất cả</label>
        <div id="product-options-tab3" class="indent"></div>
        <h3>Ca</h3>
        <label><input type="checkbox" id="ca-all-tab3" checked> Tất cả</label>
        <div id="ca-options-tab3" class="indent"></div>
        <h3>Team</h3>
        <label><input type="checkbox" id="team-all-tab3" checked> Tất cả</label>
        <div id="team-options-tab3" class="indent"></div>
        <h3>Thị trường</h3>
        <label><input type="checkbox" id="market-all-tab3" checked> Tất cả</label>
        <div id="market-options-tab3"></div>
      </div>
      <div class="main-content-area">
        <div class="header">
          <img
            src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Ff930e667.%E1%BA%A2nh.025539.jpg"
            alt="Logo">
          <h2>BÁO CÁO HIỆU SUẤT KPI</h2>
        </div>

        <!-- Column Visibility Controls -->
        <div class="column-controls" style="margin-bottom: 15px; padding: 10px; background: #f9f9f9; border-radius: 5px;">
          <strong style="font-size:12px;">Tùy chọn hiển thị cột:</strong>
          <label style="margin-left: 10px;"><input type="checkbox" class="toggle-column" data-col="3" checked> CPQC</label>
          <label><input type="checkbox" class="toggle-column" data-col="4" checked> Số đơn & DS chốt</label>
          <label><input type="checkbox" class="toggle-column" data-col="5" checked> Số đơn & DS hủy</label>
          <label><input type="checkbox" class="toggle-column" data-col="6" checked> Số đơn & DS sau hủy</label>
          <label><input type="checkbox" class="toggle-column" data-col="7" checked> Số đơn & DS đi</label>
          <label><input type="checkbox" class="toggle-column" data-col="12" checked> Số đơn & DThu thành công</label>
          <label><input type="checkbox" class="toggle-column" data-col="14" checked> Ship</label>
          <label><input type="checkbox" class="toggle-column" data-col="15" checked> DThu tính KPI</label>
          <label><input type="checkbox" class="toggle-column" data-col="16" checked> Tỷ lệ thu tiền</label>
          <label><input type="checkbox" class="toggle-column" data-col="17" checked> Tỷ lệ đạt KPI</label>
          <label><input type="checkbox" class="toggle-column" data-col="18" checked> %CP/DT</label>
        </div>

        <div class="table-responsive-container">
          <table id="kpi-summary-table" class="sortable-table">
            <thead>
              <tr>
                <th rowspan="2" class="green-header">STT<span class="sort-icon"></span></th>
                <th rowspan="2" class="green-header">Team<span class="sort-icon"></span></th>
                <th rowspan="2" class="green-header">Marketing<span class="sort-icon"></span></th>
                <th rowspan="2" class="green-header" data-col-index="3">CPQC<span class="sort-icon"></span></th>
                <th colspan="2" class="blue-header" data-col-index="4">Số đơn và DS chốt<span class="sort-icon"></span></th>
                <th colspan="2" class="blue-header" data-col-index="5">Số đơn và DS hủy<span class="sort-icon"></span></th>
                <th colspan="2" class="blue-header" data-col-index="6">Số đơn và DS sau hủy<span class="sort-icon"></span></th>
                <th colspan="2" class="blue-header" data-col-index="7">Số đơn và DS đi<span class="sort-icon"></span></th>
                <th colspan="2" class="yellow-header" data-col-index="12">Số đơn và DThu thành công<span class="sort-icon"></span></th>
                <th rowspan="2" class="blue-header" data-col-index="14">Ship<span class="sort-icon"></span></th>
                <th rowspan="2" class="yellow-header" data-col-index="15">DThu tính KPI<span class="sort-icon"></span></th>
                <th rowspan="2" class="yellow-header" data-col-index="16">Tỷ lệ thu tiền<span class="sort-icon"></span></th>
                <th rowspan="2" class="yellow-header" data-col-index="17">Tỷ lệ đạt KPI<span class="sort-icon"></span></th>
                <th rowspan="2" class="green-header" data-col-index="18">%CP/DT<span class="sort-icon"></span></th>
              </tr>
              <tr>
                <!-- Row 2 của header cho các cột 2 dòng -->
                <th class="blue-header" data-col-index="4">Số đơn</th>
                <th class="blue-header" data-col-index="4">DS chốt</th>
                <th class="blue-header" data-col-index="5">Số đơn</th>
                <th class="blue-header" data-col-index="5">DS hủy</th>
                <th class="blue-header" data-col-index="6">Số đơn</th>
                <th class="blue-header" data-col-index="6">DS sau hủy</th>
                <th class="blue-header" data-col-index="7">Số đơn</th>
                <th class="blue-header" data-col-index="7">DS đi</th>
                <th class="yellow-header" data-col-index="12">Số đơn</th>
                <th class="yellow-header" data-col-index="13">DThu TC</th>
              </tr>
            </thead>
            <tbody id="kpi-summary-body"></tbody>
            <tfoot id="kpi-summary-foot"></tfoot>
          </table>
        </div>
      </div>
    </div>
  </div>
  <!-- TAB MỚI: Nội dung báo cáo thủ công -->
  <div id="ManualReport" class="tab-content">
    <iframe id="manual-report-iframe" style="width: 100%; height: 85vh; border: none;" src=""></iframe>
  </div>

  <script>
    // =================================================================================
    // --- I. KHAI BÁO BIẾN TOÀN CỤC & CẤU HÌNH ---
    // =================================================================================

    const F3_URL = 'https://lumi-6dff7-default-rtdb.asia-southeast1.firebasedatabase.app/datasheet/F3.json';
    const API_URL = 'https://n-api-gamma.vercel.app/report/generate?tableName=Báo cáo MKT';

    const CHART_COLORS = [
      '#4CAF50', '#2196F3', '#FFC107', '#F44336', '#9C27B0', '#009688',
      '#FF9800', '#795548', '#607D8B', '#E91E63', '#3F51B5', '#8BC34A'
    ];

    const MARKET_GROUPS = {
      'Châu Á': ['Hàn Quốc', 'Nhật Bản', 'VN'],
      'Ngoài Châu Á': ['Úc', 'US', 'Canada']
    };

    let masterData = [];
    let employeeData = [];
    let baseDataForReport = [];
    const charts = {};
    const sortStates = {
      summary: { column: null, direction: 'asc' },
      kpi: { column: null, direction: 'asc' },
      daily: {}
    };

    const kpiColumnSortKeys = {
      0: { prop: (s, i) => i, type: 'number' }, // STT
      1: { prop: 'team', type: 'string' },
      2: { prop: 'name', type: 'string' },
      3: { prop: 'cpqc', type: 'number' },
      4: { prop: 'soDonChot', type: 'number' },
      5: { prop: 'dsChot', type: 'number' },
      6: { prop: 'soDonHuy', type: 'number' },
      7: { prop: 'dsHuy', type: 'number' },
      8: { prop: 'soDonSauHuy', type: 'number' },
      9: { prop: 'dsSauHuy', type: 'number' },
      10: { prop: 'soDonDi', type: 'number' },
      11: { prop: 'dsDi', type: 'number' },
      12: { prop: 'soDonThuTien', type: 'number' },
      13: { prop: 'dThuThanhCong', type: 'number' },
      14: { prop: 'ship', type: 'number' },
      15: { prop: 'dThuTinhKpi', type: 'number' },
      16: { prop: (s) => s.dsDi > 0 ? s.dThuThanhCong / s.dsDi : 0, type: 'number' },
      17: { prop: () => 0, type: 'number' },
      18: { prop: (s) => s.dThuTinhKpi > 0 ? s.cpqc / s.dThuTinhKpi : 0, type: 'number' } // %CP/DT
    };

    // Global holders
    window.dsSourceRows = [];
    window.dsFromVercelByMarketing = {};
    window.cpqcByMarketing = {};
    window.cpqcSourceRows = [];
    window.teamsFromVercel = [];
    window.teamByMarketingFromVercel = {};

    // --- Xác định VIEW MODE: mkt / sale / vandon (hoặc shipment) ---
    function getViewMode() {
      const params = new URLSearchParams(window.location.search);
      const raw = (params.get('view') || params.get('mode') || params.get('role') || '').toLowerCase();
      if (raw === 'sale' || raw === 'sales') return 'sale';
      if (raw === 'vd' || raw === 'vandon' || raw === 'van_don' || raw === 'shipment') return 'shipment';
      return 'mkt'; // mặc định
    }
    const VIEW_MODE = getViewMode();

    // =================================================================================
    // --- II. KHỞI TẠO ỨNG DỤNG ---
    // =================================================================================

    document.addEventListener('DOMContentLoaded', () => {
      Chart.register(ChartDataLabels);

      setupEventListeners();
      setDefaultDates();
      applyViewSpecificSettings();   // Ẩn/hiện CPQC, %CP/DT theo view
      fetchAndProcessData();
      document.getElementById("defaultOpen").click();
    });

    function applyViewSpecificSettings() {
      // Chỉ view MKT mới được thấy CPQC và %CP/DT
      if (VIEW_MODE === 'mkt') return;

      // 1. Ẩn label control của cột CPQC và %CP/DT
      const cpqcToggle = document.querySelector('.toggle-column[data-col="3"]');
      const cpdtToggle = document.querySelector('.toggle-column[data-col="18"]');

      if (cpqcToggle) {
        cpqcToggle.checked = false; // đảm bảo ẩn cột
        const lbl = cpqcToggle.closest('label');
        if (lbl) lbl.style.display = 'none';
      }

      if (cpdtToggle) {
        cpdtToggle.checked = false;
        const lbl = cpdtToggle.closest('label');
        if (lbl) lbl.style.display = 'none';
      }
      // Reapply sẽ được gọi sau khi render lần đầu, dựa vào trạng thái checkbox
    }

    function setDefaultDates() {
      const today = new Date();
      const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
      const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
      const formatDateForInput = (date) => date.toISOString().split('T')[0];

      const dateInputs = ['start-date-tab3', 'end-date-tab3'];

      dateInputs.forEach(id => {
        const el = document.getElementById(id);
        if (id.startsWith('start-')) {
          el.value = formatDateForInput(firstDay);
        } else {
          el.value = formatDateForInput(lastDay);
        }
      });
    }

    function setupEventListeners() {
      document.querySelectorAll('.tablinks').forEach(tab => {
        const onclickAttr = tab.getAttribute('onclick');
        if (onclickAttr) {
          const tabName = onclickAttr.match(/'([^']+)'/)?.[1];
          if (tabName) {
            tab.addEventListener('click', (e) => {
              e.preventDefault();
              e.stopPropagation();
              openTab(e, tabName);
            });
          }
        }
      });

      // Listener chính cho tất cả thay đổi bộ lọc
      document.body.addEventListener('change', handleFilterChange);

      // Listener sắp xếp bảng
      document.getElementById('kpi-summary-table').querySelector('thead')
        .addEventListener('click', (e) => sortTable(e, 'kpi'));

      // Listener cho toggle column visibility trong KPI table
      document.querySelectorAll('.toggle-column').forEach(checkbox => {
        checkbox.addEventListener('change', toggleKpiColumn);
      });
    }

    // =================================================================================
    // --- TOGGLE COLUMN VISIBILITY FOR KPI TABLE ---
    // =================================================================================
    function toggleKpiColumn(event) {
      const checkbox = event.target;
      const colIndex = checkbox.getAttribute('data-col');
      const table = document.getElementById('kpi-summary-table');

      const headerCells = table.querySelectorAll(`thead [data-col-index="${colIndex}"]`);
      const bodyCells = table.querySelectorAll(`tbody [data-col-index="${colIndex}"]`);
      const footCells = table.querySelectorAll(`tfoot [data-col-index="${colIndex}"]`);

      const displayValue = checkbox.checked ? '' : 'none';

      headerCells.forEach(cell => {
        cell.style.display = displayValue;
      });
      bodyCells.forEach(cell => {
        cell.style.display = displayValue;
      });
      footCells.forEach(cell => {
        cell.style.display = displayValue;
      });
    }

    // =================================================================================
    // --- III. TẢI VÀ XỬ LÝ DỮ LIỆU ---
    // =================================================================================

    async function fetchAndProcessData() {
      showLoader();
      try {
        const [apiResponse, f3Response] = await Promise.all([
          fetch(API_URL),
          fetch(F3_URL)
        ]);

        const apiData = await apiResponse.json();
        const f3Data = await f3Response.json();

        // Xử lý API data - có thể là object chứa array hoặc array trực tiếp
        let processedApiData = [];
        if (Array.isArray(apiData)) {
          processedApiData = apiData;
        } else if (apiData && typeof apiData === 'object') {
          const keys = Object.keys(apiData);
          if (apiData.employeeData && Array.isArray(apiData.employeeData)) {
            processedApiData = apiData.employeeData;
          } else {
            for (const key of keys) {
              if (Array.isArray(apiData[key])) {
                processedApiData = apiData[key];
                break;
              }
            }
          }
        }

        // Build CPQC & DS & Team map từ Vercel
        const cpqcByMarketing = {};
        const cpqcSourceRows = [];
        const dsSourceRows = [];
        const teamSetFromVercel = new Set();
        const teamByMarketing = {};

        if (apiData && typeof apiData === 'object') {
          const apiArrays = [];
          Object.keys(apiData).forEach(key => {
            if (Array.isArray(apiData[key])) apiArrays.push(apiData[key]);
          });

          apiArrays.forEach((arr) => {
            arr.forEach((row) => {
              if (!row || typeof row !== 'object') return;

              const nameRaw = row['Tên'] || row['ten'] || row['name'] || row['hoten'] || '';
              const marketingName = String(nameRaw).trim();

              const cpqcValue = Number(row['CPQC'] ?? row['cpqc'] ?? 0) || 0;
              const ngayStr = row['Ngày'] || row['ngay'] || row['date'] || row['Date'] || '';
              const ngay = ngayStr ? new Date(ngayStr) : null;

              const teamName = (row['Team'] || row['team'] || row['Nhóm'] || '').toString().trim();
              if (teamName) {
                teamSetFromVercel.add(teamName);
                if (marketingName) {
                  teamByMarketing[marketingName] = teamName;
                }
              }

              // CPQC
              if (marketingName && cpqcValue > 0) {
                cpqcByMarketing[marketingName] = (cpqcByMarketing[marketingName] || 0) + cpqcValue;
                if (ngay) cpqcSourceRows.push({ ten: marketingName, ngay, cpqc: cpqcValue });
              }

              // DS từ Vercel
              const dsChot = Number(row['DS chốt'] ?? row['DS chot'] ?? row['Doanh số chốt'] ?? row['Doanh số'] ?? 0) || 0;
              const dsHuy = Number(row['DS hủy'] ?? row['DS huy'] ?? row['Doanh số hủy'] ?? 0) || 0;
              const dsSauHuy = Number(row['DS sau hủy'] ?? row['DS sau huy'] ?? row['Doanh số sau hủy'] ?? 0) || 0;
              const dsDi = Number(row['DS đi'] ?? row['DS di'] ?? row['Doanh số đi'] ?? 0) || 0;

              if (marketingName && ngay && (dsChot || dsHuy || dsSauHuy || dsDi)) {
                dsSourceRows.push({
                  ten: marketingName,
                  ngay,
                  dsChot,
                  dsHuy,
                  dsSauHuy,
                  dsDi
                });
              }
            });
          });
        }

        window.cpqcByMarketing = cpqcByMarketing;
        window.cpqcSourceRows = cpqcSourceRows;
        window.dsSourceRows = dsSourceRows;
        window.dsFromVercelByMarketing = {};
        window.teamsFromVercel = Array.from(teamSetFromVercel);
        window.teamByMarketingFromVercel = teamByMarketing;

        // Tạo masterData từ từng đơn F3 (ưu tiên team & ds bên Vercel, ship + số đơn bên F3)
        const cpqcFirstRecordFlag = {};
        masterData = Array.isArray(f3Data)
          ? f3Data
            .filter(o => o && o['Nhân viên Marketing'])
            .map(order => {
              const marketing = String(order['Nhân viên Marketing']).trim();

              const teamFromVercel = teamByMarketing[marketing];
              const team = teamFromVercel || order['Team'] || 'Khác';

              const ngayLenDonRaw = order['Ngày lên đơn'];
              const ngay = ngayLenDonRaw ? new Date(ngayLenDonRaw) : new Date();
              const sanPham = order['Mặt hàng'] || 'N/A';
              const thiTruong = order['Khu vực'] || 'N/A';
              const ketQuaCheck = order['Kết quả Check'] || '';
              const maTracking = String(order['Mã Tracking'] || '').trim();
              const tongTien = Number(order['Tổng tiền VNĐ']) || 0;

              // Ship từ F3
              const phiShip = Number(order['Phí ship']) || 0;

              // DThu TC từ F3: Tiền Việt đã đối soát
              const doiSoatRaw = order['Tiền Việt đã đối soát'];
              const tienVietDoiSoat = typeof doiSoatRaw === 'number'
                ? doiSoatRaw
                : (Number(doiSoatRaw) || 0);

              const isHuy = ketQuaCheck === 'Huỷ';
              const isDi = maTracking !== '';
              const isThanhCong = ketQuaCheck === 'OK' && isDi;

              const soDonThucTe = 1;
              const dsChotThucTe = tongTien;
              const soDonHuyThucTe = isHuy ? 1 : 0;
              const dsHoanHuyThucTe = isHuy ? tongTien : 0;
              const dsSauHoanHuyThucTe = isHuy ? 0 : tongTien;
              const dsThanhCongThucTe = isThanhCong ? tongTien : 0;

              // Số đơn & DThu thành công dùng Tiền Việt đã đối soát
              const soDonThuTienThucTe = tienVietDoiSoat > 0 ? 1 : 0;
              const dThuThanhCongThucTe = tienVietDoiSoat;

              // CPQC: lấy từ map, gán 1 lần/marketing
              let cpqc = 0;
              if (!cpqcFirstRecordFlag[marketing]) {
                cpqc = cpqcByMarketing[marketing] || 0;
                cpqcFirstRecordFlag[marketing] = true;
              }

              return {
                ten: marketing,
                team,
                ngay,
                sanPham,
                thiTruong,
                dsChot: tongTien,
                ship: phiShip, // Ship từ F3
                cpqc,

                // Dữ liệu phụ
                idnv: '', email: '', ca: 'N/A', chucVu: '', soMessCmt: 0,

                // Thống kê F3
                soDon: 1,
                soDonHuy: soDonHuyThucTe,
                doanhSoHuy: dsHoanHuyThucTe,
                dsSauHoanHuy: dsSauHoanHuyThucTe,
                dsSauShip: dsSauHoanHuyThucTe,
                dsThanhCong: dsThanhCongThucTe,
                kpiValue: 0,

                // Thực tế
                soDonThucTe,
                dsChotThucTe,
                dsHoanHuyThucTe,
                soDonHuyThucTe,
                dsSauHoanHuyThucTe,
                dsThanhCongThucTe,

                // DThu thành công từ Tiền Việt đã đối soát
                soDonThuTienThucTe,
                dThuThanhCongThucTe
              };
            })
          : [];

        setupInitialReportView();
        populateAllFilters();
        applyTab3Filters();
      } catch (err) {
        console.error("Lỗi tải dữ liệu:", err);
        alert('Không thể tải dữ liệu từ Firebase/Vercel. Vui lòng kiểm tra lại.');
      } finally {
        hideLoader();
      }
    }

    function setupInitialReportView() {
      const idFromUrl = new URLSearchParams(window.location.search).get('id');
      const manualTabBtn = document.getElementById('manual-report-tab-btn');

      if (!idFromUrl) {
        baseDataForReport = masterData;
        manualTabBtn.style.display = 'none';
        return;
      }

      const currentUser = employeeData.find(emp => emp.idnv === idFromUrl && emp.email != '');
      if (currentUser) {
        if (currentUser.chucVu === 'leader') {
          const teamsString = new URLSearchParams(window.location.search).get('teams');
          const teams = teamsString ? teamsString.split(' , ') : [currentUser.team];

          baseDataForReport = masterData.filter(r => teams.includes((r.team || '').trim()));

        } else {
          baseDataForReport = masterData.filter(r => (r.ten || '').trim() === currentUser.ten);
        }

        manualTabBtn.style.display = 'block';
        const manualIframe = document.getElementById('manual-report-iframe');
        const hoten = encodeURIComponent(currentUser.ten);
        const email = `${currentUser.email}`;
        const tableName = encodeURIComponent('Báo cáo MKT');
        manualIframe.src = `https://nguyenbatyads37.github.io/static-html-show-data/baoCaoThuCong.html?hoten=${hoten}&email=${email}&tableName=${tableName}&hideColumns=Page`;

      } else {
        baseDataForReport = [];
        manualTabBtn.style.display = 'none';
      }

    }

    // =================================================================================
    // --- IV. XỬ LÝ SỰ KIỆN VÀ BỘ LỌC ---
    // =================================================================================

    function handleCheckbox(allId, childClass, target) {
      const allCheckbox = document.getElementById(allId);
      if (!allCheckbox) return;

      if (target.id === allId) {
        document.querySelectorAll(`.${childClass}`).forEach(cb => cb.checked = target.checked);
      } else if (target.classList.contains(childClass)) {
        const allChildren = document.querySelectorAll(`.${childClass}`);
        allCheckbox.checked = [...allChildren].every(cb => cb.checked);
      }
    }

    function handleTab3Filters(target) {
      handleCheckbox('product-all-tab3', 'filter-product-tab3', target);
      handleCheckbox('ca-all-tab3', 'filter-ca-tab3', target);
      handleCheckbox('team-all-tab3', 'filter-team-tab3', target);
      handleCheckbox('market-all-tab3', 'filter-market-tab3', target);
      applyTab3Filters();
    }

    function handleFilterChange(e) {
      const target = e.target;
      const container = target.closest('.tab-content');
      if (!container) return;

      if (target.matches('select[id^="quick-date"]')) {
        handleQuickDateChange(e);
        return;
      }

      showLoader();
      setTimeout(() => {
        switch (container.id) {
          case 'KpiReport':
            handleTab3Filters(target);
            break;
        }
        hideLoader();
      }, 50);
    }

    function handleQuickDateChange(event) {
      const selection = event.target.value;
      if (!selection) return;

      const { startDate, endDate } = getDateRange(selection);
      const formattedStart = startDate.toLocaleDateString('en-CA');
      const formattedEnd = endDate.toLocaleDateString('en-CA');

      const tabId = event.target.closest('.tab-content')?.id || 'KpiReport';

      let startDateId, endDateId;
      if (tabId === 'KpiReport') {
        startDateId = 'start-date-tab3';
        endDateId = 'end-date-tab3';
      } else {
        startDateId = 'start-date-tab3';
        endDateId = 'end-date-tab3';
      }

      document.getElementById(startDateId).value = formattedStart;
      document.getElementById(endDateId).value = formattedEnd;

      document.getElementById(startDateId).dispatchEvent(new Event('change', { bubbles: true }));
    }


    function getFilteredData(tabPrefix) {
      const startDateVal = document.getElementById(`start-date-${tabPrefix}`).value;
      const endDateVal = document.getElementById(`end-date-${tabPrefix}`).value;
      const startDate = startDateVal ? new Date(startDateVal) : null;
      if (startDate) startDate.setHours(0, 0, 0, 0);

      const endDate = endDateVal ? new Date(endDateVal) : null;
      if (endDate) endDate.setHours(23, 59, 59, 999);


      if ((startDate && isNaN(startDate)) || (endDate && isNaN(endDate))) return [];

      const getSelected = (type) => {
        const allCheckbox = document.getElementById(`${type}-all-${tabPrefix}`);
        if (!allCheckbox || allCheckbox.checked) return [];
        return Array.from(document.querySelectorAll(`.filter-${type}-${tabPrefix}:checked`)).map(cb => cb.value);
      };
      const selectedProducts = getSelected('product');
      const selectedMarkets = getSelected('market');
      const selectedCas = getSelected('ca');
      const selectedTeams = getSelected('team');

      const filteredDataResult = baseDataForReport.filter(r => {
        const date = new Date(r.ngay);
        date.setHours(0, 0, 0, 0);

        if (!r.ngay || isNaN(date)) return false;     // Loại nếu không có hoặc sai định dạng
        const isDateOk =
          (!startDate || date >= startDate) &&
          (!endDate || date <= endDate);
        if (!isDateOk) return false;


        const isProductOk = selectedProducts.length === 0 || selectedProducts.includes(r.sanPham);
        if (!isProductOk) return false;

        const marketGroup = getMarketGroup(normalize(r.thiTruong));
        const isMarketOk = selectedMarkets.length === 0 || selectedMarkets.includes(r.thiTruong) || selectedMarkets.includes(marketGroup);
        if (!isMarketOk) return false;

        const isCaOk = (selectedCas.length === 0) || selectedCas.includes(r.ca);
        if (!isCaOk) return false;

        // Lọc theo Team
        const isTeamOk = (selectedTeams.length === 0) || selectedTeams.includes(r.team);
        if (!isTeamOk) return false;

        return true;
      });

      return filteredDataResult;
    }

    function populateAllFilters() {
      if (!masterData.length) return;

      const products = [...new Set(masterData.map(r => r.sanPham).filter(Boolean))].sort();
      const cas = [...new Set(masterData.map(r => r.ca).filter(Boolean))].sort();

      // Team ưu tiên lấy từ Vercel
      const teamsFromVercel = window.teamsFromVercel || [];
      const teamsRaw = teamsFromVercel.length
        ? teamsFromVercel
        : [...new Set(masterData.map(r => r.team).filter(Boolean))];

      const teams = [...new Set(teamsRaw)].sort();

      const markets = [...new Set(masterData.map(r => r.thiTruong).filter(Boolean))].sort();

      const createCheckboxes = (items, className) =>
        items.map(item => `<label class='indent'><input type='checkbox' class='${className}' value='${item}' checked> ${item}</label>`).join('');

      const createMarketCheckboxes = (className) => {
        let html = '';
        Object.keys(MARKET_GROUPS).forEach(group => {
          html += `<label><input type='checkbox' class='${className} filter-market-group' value='${group}' checked> <b>${group}</b></label>`;
          html += MARKET_GROUPS[group].map(child => `<label class='indent'><input type='checkbox' class='${className}' value='${child}' checked> ${child}</label>`).join('');
        });
        const ungroupedMarkets = markets.filter(m => !Object.values(MARKET_GROUPS).flat().map(normalize).includes(normalize(m)));
        html += createCheckboxes(ungroupedMarkets, className);
        return html;
      };

      const prefix = 'tab3';
      const productEl = document.getElementById(`product-options-${prefix}`);
      const caEl = document.getElementById(`ca-options-${prefix}`);
      const teamEl = document.getElementById(`team-options-${prefix}`);
      const marketEl = document.getElementById(`market-options-${prefix}`);

      if (productEl) productEl.innerHTML = createCheckboxes(products, `filter-product-${prefix}`);
      if (caEl) caEl.innerHTML = createCheckboxes(cas, `filter-ca-${prefix}`);
      if (teamEl) teamEl.innerHTML = createCheckboxes(teams, `filter-team-${prefix}`);
      if (marketEl) marketEl.innerHTML = createCheckboxes([], `filter-market-${prefix}`) + createMarketCheckboxes(`filter-market-${prefix}`);
    }

    // =================================================================================
    // --- V. CÁC HÀM ÁP DỤNG BỘ LỌC CHO TAB KPI ---
    // =================================================================================

    function applyTab3Filters() {
      const filteredData = getFilteredData('tab3');

      // Tính CPQC + DS theo khoảng ngày đang lọc
      try {
        const startDateVal = document.getElementById('start-date-tab3').value;
        const endDateVal = document.getElementById('end-date-tab3').value;
        const cpRows = Array.isArray(window.cpqcSourceRows) ? window.cpqcSourceRows : [];
        const dsRows = Array.isArray(window.dsSourceRows) ? window.dsSourceRows : [];

        if (cpRows.length && startDateVal && endDateVal) {
          const s = new Date(startDateVal); s.setHours(0, 0, 0, 0);
          const e = new Date(endDateVal); e.setHours(23, 59, 59, 999);
          const map = {};
          cpRows.forEach(r => {
            if (!r || !r.ngay) return;
            const d = new Date(r.ngay);
            if (d >= s && d <= e) {
              map[r.ten] = (map[r.ten] || 0) + (Number(r.cpqc) || 0);
            }
          });
          window.cpqcByMarketing = map; // cập nhật map cho lần render này
        }

        if (dsRows.length && startDateVal && endDateVal) {
          const s = new Date(startDateVal); s.setHours(0, 0, 0, 0);
          const e = new Date(endDateVal); e.setHours(23, 59, 59, 999);
          const mapDs = {};
          dsRows.forEach(r => {
            if (!r || !r.ngay) return;
            const d = new Date(r.ngay);
            if (d >= s && d <= e) {
              const k = r.ten;
              if (!mapDs[k]) {
                mapDs[k] = {
                  dsChot: 0,
                  dsHuy: 0,
                  dsSauHuy: 0,
                  dsDi: 0
                };
              }
              mapDs[k].dsChot += Number(r.dsChot) || 0;
              mapDs[k].dsHuy += Number(r.dsHuy) || 0;
              mapDs[k].dsSauHuy += Number(r.dsSauHuy) || 0;
              mapDs[k].dsDi += Number(r.dsDi) || 0;
            }
          });
          window.dsFromVercelByMarketing = mapDs;
        }
      } catch (e) {
        console.warn('Không thể lọc CPQC/DS theo ngày:', e);
      }

      const kpiList = generateKpiTableData(filteredData);
      sortList(kpiList, sortStates.kpi, kpiColumnSortKeys, { prop: 'team', type: 'string' });
      renderKpiSummary(kpiList);
      updateSortIcons(document.getElementById('kpi-summary-table'), sortStates.kpi);
    }

    // =================================================================================
    // --- VI. CÁC HÀM TÍNH TOÁN VÀ TỔNG HỢP DỮ LIỆU ---
    // =================================================================================

    function generateKpiTableData(data) {
      const summary = {};
      const cpqcMap = window.cpqcByMarketing || {};
      const dsVercelMap = window.dsFromVercelByMarketing || {};

      data.forEach(r => {
        const key = r.ten || 'N/A';
        if (!summary[key]) {
          summary[key] = {
            name: r.ten, team: r.team, cpqc: cpqcMap[key] || 0,
            // Dữ liệu chốt
            soDonChot: 0, dsChot: 0,
            // Dữ liệu hủy
            soDonHuy: 0, dsHuy: 0,
            // Dữ liệu sau hủy
            soDonSauHuy: 0, dsSauHuy: 0,
            // Dữ liệu đi (có mã tracking)
            soDonDi: 0, dsDi: 0,
            // Dữ liệu thu tiền thành công
            soDonThuTien: 0, dThuThanhCong: 0,
            // Ship và KPI
            ship: 0, dThuTinhKpi: 0,
            kpiValue: 0,
            // Dữ liệu F3 để fallback khi không có vercel
            dsChotF3: 0, dsHuyF3: 0, dsSauHuyF3: 0, dsDiF3: 0,
            // Giữ lại dữ liệu cũ để tương thích
            soDonHuyOld: 0, doanhSoHuy: 0, dsSauShip: 0, dsThanhCong: 0,
            dsChotThucTe: 0, soDonHuyThucTe: 0, dsHoanHuyThucTe: 0, dsSauHoanHuyThucTe: 0,
            dsThanhCongThucTe: 0
          };
        }
        const S = summary[key];

        // Tổng hợp số đơn từ F3
        const soDonThucTe = Number(r.soDonThucTe) || 0;
        const soDonHuyThucTe = Number(r.soDonHuyThucTe) || 0;
        const soDonThuTienThucTe = Number(r.soDonThuTienThucTe) || 0;

        // DS từ F3
        const dsChotBaseF3 = (Number(r.dsChotThucTe) || Number(r.dsChot) || 0);
        const dsHuyF3Val = Number(r.dsHoanHuyThucTe) || 0;
        const dsDiF3 = Number(r.dsThanhCongThucTe) || Number(r.dsThanhCong) || 0;
        const dsSauHoanHuyF3 = Number(r.dsSauHoanHuyThucTe) || (dsChotBaseF3 - dsHuyF3Val);

        S.soDonChot += soDonThucTe;
        S.soDonHuy += soDonHuyThucTe;
        S.soDonSauHuy += Math.max(0, soDonThucTe - soDonHuyThucTe);
        S.soDonDi += soDonThucTe;              // số đơn đi: F3
        S.soDonThuTien += soDonThuTienThucTe;  // số đơn thu tiền: F3 (Tiền VN đã đối soát > 0)

        S.dsChotF3 += dsChotBaseF3;
        S.dsHuyF3 += dsHuyF3Val;
        S.dsSauHuyF3 += Math.max(0, dsSauHoanHuyF3);
        S.dsDiF3 += dsDiF3;

        // DThu TC: cộng từ F3 ("Tiền Việt đã đối soát")
        S.dThuThanhCong += r.dThuThanhCongThucTe || 0;
        // Ship: cộng từ F3
        S.ship += r.ship || 0;

        // Giữ lại dữ liệu cũ
        S.dsSauShip += r.dsSauShip || 0;
        S.dsThanhCong += r.dsThanhCong || 0;
        S.kpiValue += r.kpiValue || 0;
        S.soDonHuyOld += r.soDonHuy || 0;
        S.doanhSoHuy += r.doanhSoHuy || 0;
        S.dsChotThucTe += r.dsChotThucTe || 0;
        S.soDonHuyThucTe += r.soDonHuyThucTe || 0;
        S.dsHoanHuyThucTe += r.dsHoanHuyThucTe || 0;
        S.dsSauHoanHuyThucTe += r.dsSauHoanHuyThucTe || 0;
        S.dsThanhCongThucTe += r.dsThanhCongThucTe || 0;
      });

      // Sau khi gom xong từng người, áp logic DS ưu tiên Vercel
      return Object.values(summary).map(s => {
        const dsV = dsVercelMap[s.name] || {};
        const hasVercelData = dsV && (
          (dsV.dsChot || 0) !== 0 ||
          (dsV.dsHuy || 0) !== 0 ||
          (dsV.dsSauHuy || 0) !== 0 ||
          (dsV.dsDi || 0) !== 0
        );

        if (hasVercelData) {
          s.dsChot = dsV.dsChot || 0;
          s.dsHuy = dsV.dsHuy || 0;
          s.dsSauHuy = dsV.dsSauHuy || Math.max(0, s.dsChot - s.dsHuy);
          s.dsDi = dsV.dsDi || 0;
        } else {
          s.dsChot = s.dsChotF3;
          s.dsHuy = s.dsHuyF3;
          s.dsSauHuy = s.dsSauHuyF3 || Math.max(0, s.dsChotF3 - s.dsHuyF3);
          s.dsDi = s.dsDiF3;
        }

        // DThu tính KPI = DThu TC − Ship
        s.dThuTinhKpi = (s.dThuThanhCong || 0) - (s.ship || 0);

        return s;
      });
    }

    // =================================================================================
    // --- VII. CÁC HÀM HIỂN THỊ DỮ LIỆU (RENDERING) ---
    // =================================================================================

    function renderKpiSummary(dataList) {
      let total = {
        cpqc: 0,
        soDonChot: 0, dsChot: 0,
        soDonHuy: 0, dsHuy: 0,
        soDonSauHuy: 0, dsSauHuy: 0,
        soDonDi: 0, dsDi: 0,
        soDonThuTien: 0, dThuThanhCong: 0,
        ship: 0, dThuTinhKpi: 0,
        kpiValue: 0
      };

      const bodyRowsHtml = dataList.map((s, i) => {
        Object.keys(total).forEach(key => total[key] += s[key] || 0);

        // Tỷ lệ thu tiền = DThu TC / DS đi
        const tyLeThuTien = s.dsDi > 0 ? (s.dThuThanhCong / s.dsDi) : 0;
        // %CP/DT = CPQC / DThu tính KPI
        const cpdt = s.dThuTinhKpi > 0 ? (s.cpqc / s.dThuTinhKpi) : 0;
        const cpdtClass = cpdt > 0.33 ? 'bg-yellow' : '';

        return `<tr>
                <td class="text-center">${i + 1}</td>
                <td class="text-left">${s.team}</td>
                <td class="text-left">${s.name}</td>
                <td data-col-index="3">${formatCurrency(s.cpqc)}</td>
                <td data-col-index="4" class="text-center">${formatNumber(s.soDonChot)}</td>
                <td data-col-index="4">${formatCurrency(s.dsChot)}</td>
                <td data-col-index="5" class="text-center">${formatNumber(s.soDonHuy)}</td>
                <td data-col-index="5">${formatCurrency(s.dsHuy)}</td>
                <td data-col-index="6" class="text-center">${formatNumber(s.soDonSauHuy)}</td>
                <td data-col-index="6">${formatCurrency(s.dsSauHuy)}</td>
                <td data-col-index="7" class="text-center">${formatNumber(s.soDonDi)}</td>
                <td data-col-index="7">${formatCurrency(s.dsDi)}</td>
                <td data-col-index="12" class="text-center">${formatNumber(s.soDonThuTien)}</td>
                <td data-col-index="13">${formatCurrency(s.dThuThanhCong)}</td>
                <td data-col-index="14">${formatCurrency(s.ship)}</td>
                <td data-col-index="15">${formatCurrency(s.dThuTinhKpi)}</td>
                <td data-col-index="16">${formatPercent(tyLeThuTien)}</td>
                <td data-col-index="17">-</td>
                <td data-col-index="18" class="${cpdtClass}">${formatPercent(cpdt / 100)}</td>
            </tr>`;
      }).join('');

      // Tổng
      const totalTyLeThuTien = total.dsDi > 0 ? (total.dThuThanhCong / total.dsDi) : 0;
      const totalCpdt = total.dThuTinhKpi > 0 ? (total.cpqc / total.dThuTinhKpi) : 0;

      const totalRowHtml = `<tr class="total-row">
            <td class="total-label" colspan="3">TỔNG CỘNG</td>
            <td class="total-value" data-col-index="3">${formatCurrency(total.cpqc)}</td>
            <td class="total-value text-center" data-col-index="4">${formatNumber(total.soDonChot)}</td>
            <td class="total-value" data-col-index="4">${formatCurrency(total.dsChot)}</td>
            <td class="total-value text-center" data-col-index="5">${formatNumber(total.soDonHuy)}</td>
            <td class="total-value" data-col-index="5">${formatCurrency(total.dsHuy)}</td>
            <td class="total-value text-center" data-col-index="6">${formatNumber(total.soDonSauHuy)}</td>
            <td class="total-value" data-col-index="6">${formatCurrency(total.dsSauHuy)}</td>
            <td class="total-value text-center" data-col-index="7">${formatNumber(total.soDonDi)}</td>
            <td class="total-value" data-col-index="7">${formatCurrency(total.dsDi)}</td>
            <td class="total-value text-center" data-col-index="12">${formatNumber(total.soDonThuTien)}</td>
            <td class="total-value" data-col-index="13">${formatCurrency(total.dThuThanhCong)}</td>
            <td class="total-value" data-col-index="14">${formatCurrency(total.ship)}</td>
            <td class="total-value" data-col-index="15">${formatCurrency(total.dThuTinhKpi)}</td>
            <td class="total-value" data-col-index="16">${formatPercent(totalTyLeThuTien)}</td>
            <td class="total-value" data-col-index="17">-</td>
            <td class="total-value" data-col-index="18">${formatPercent(totalCpdt / 100)}</td>
        </tr>`;
      document.getElementById('kpi-summary-body').innerHTML = totalRowHtml + bodyRowsHtml;
      document.getElementById('kpi-summary-foot').innerHTML = '';

      // Reapply column visibility sau khi render
      reapplyKpiColumnVisibility();
    }

    // =================================================================================
    // --- REAPPLY COLUMN VISIBILITY STATE ---
    // =================================================================================
    function reapplyKpiColumnVisibility() {
      document.querySelectorAll('.toggle-column').forEach(checkbox => {
        if (!checkbox.checked) {
          const colIndex = checkbox.getAttribute('data-col');
          const table = document.getElementById('kpi-summary-table');
          const cells = table.querySelectorAll(`[data-col-index="${colIndex}"]`);
          cells.forEach(cell => {
            cell.style.display = 'none';
          });
        }
      });
    }


    // =================================================================================
    // --- VIII. LOGIC SẮP XẾP BẢNG ---
    // =================================================================================

    function sortTable(event, tableType) {
      const th = event.target.closest('th');
      if (!th) return;
      let columnIndex = th.cellIndex;
      if (columnIndex === 0) return;

      let sortState;
      let tableElement = th.closest('table');

      if (tableType === 'daily') {
        const date = tableElement.dataset.date;
        if (!sortStates.daily[date]) sortStates.daily[date] = { column: null, direction: 'asc' };
        sortState = sortStates.daily[date];
      } else {
        sortState = sortStates[tableType];
      }

      if (sortState.column === columnIndex) {
        sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
      } else {
        sortState.column = columnIndex;
        sortState.direction = 'asc';
      }

      if (tableType === 'kpi') {
        applyTab3Filters();
      }
    }

    function sortList(list, sortState, columnKeys, defaultSortKey) {
      const { column, direction } = sortState;
      const sortInfo = columnKeys[column];
      if (!sortInfo && !defaultSortKey) return;
      list.sort((a, b) => {
        const key = sortInfo || defaultSortKey;
        if (key.prop === 'chot' && !sortInfo) return b.chot - a.chot;
        let valA = typeof key.prop === 'function' ? key.prop(a) : a[key.prop];
        let valB = typeof key.prop === 'function' ? key.prop(b) : b[key.prop];
        if (valA == null) valA = key.type === 'string' ? '' : -Infinity;
        if (valB == null) valB = key.type === 'string' ? '' : -Infinity;
        let comparison = 0;
        if (key.type === 'string') {
          comparison = String(valA).localeCompare(String(valB));
        } else {
          comparison = valA - valB;
        }
        if (!sortInfo) return comparison;
        return direction === 'asc' ? comparison : -comparison;
      });
    }

    function updateSortIcons(tableElement, sortState) {
      if (!tableElement) return;
      tableElement.querySelectorAll('thead th').forEach((th, index) => {
        const icon = th.querySelector('.sort-icon');
        if (!icon) return;
        icon.className = 'sort-icon';
        th.classList.remove('sorted');
        if (index === sortState.column) {
          th.classList.add('sorted');
          icon.classList.add(sortState.direction);
        }
      });
    }

    // =================================================================================
    // --- IX. LOGIC TAB ---
    // =================================================================================

    function openTab(evt, tabName) {
      document.querySelectorAll(".tab-content").forEach(tc => tc.style.display = "none");
      document.querySelectorAll(".tablinks").forEach(tl => tl.classList.remove("active"));
      document.getElementById(tabName).display = "block";
      document.getElementById(tabName).style.display = "block";

      const currentTabButton = Array.from(document.querySelectorAll('.tablinks')).find(
        btn => btn.getAttribute('onclick') && btn.getAttribute('onclick').includes(`'${tabName}'`)
      );
      if (currentTabButton) currentTabButton.classList.add("active");

      showLoader();
      setTimeout(() => {
        try {
          if (tabName === 'KpiReport') applyTab3Filters();
        } catch (error) {
          console.error('Lỗi khi chuyển tab:', tabName, error);
        } finally {
          hideLoader();
        }
      }, 100);
    }

    // =================================================================================
    // --- X. CÁC HÀM TIỆN ÍCH (UTILITIES) ---
    // =================================================================================
    const loader = document.getElementById('loading-overlay');
    const showLoader = () => loader.classList.add('visible');
    const hideLoader = () => loader.classList.remove('visible');

    function normalize(s) { return (s || '').trim().toLowerCase(); }
    function getMarketGroup(normalizedMarket) {
      for (const group in MARKET_GROUPS) {
        if (MARKET_GROUPS[group].map(normalize).includes(normalizedMarket)) return group;
      }
      return null;
    }
    function formatCurrency(v) { return Number(v || 0).toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }); }
    function formatNumber(v) { return Number(v || 0).toLocaleString('vi-VN'); }
    function formatPercent(v) {
      if (!isFinite(v)) return '0.00%';
      return `${(Number(v || 0) * 100).toFixed(2)}%`;
    }
    function getDateRange(selection) {
      const now = new Date();
      let startDate, endDate = new Date(now);
      const currentYear = now.getFullYear(), currentMonth = now.getMonth(), currentDay = now.getDay();
      const dayOfWeek = currentDay === 0 ? 6 : currentDay - 1;
      switch (selection) {
        case 'today': startDate = new Date(now.setHours(0, 0, 0, 0)); endDate = new Date(now.setHours(23, 59, 59, 999)); break;
        case 'yesterday': startDate = new Date(new Date().setDate(new Date().getDate() - 1)); startDate.setHours(0, 0, 0, 0); endDate = new Date(startDate); endDate.setHours(23, 59, 59, 999); break;
        case 'thisWeek': startDate = new Date(now.setDate(now.getDate() - dayOfWeek)); startDate.setHours(0, 0, 0, 0); endDate = new Date(startDate); endDate.setDate(startDate.getDate() + 6); endDate.setHours(23, 59, 59, 999); break;
        case 'lastWeek': startDate = new Date(); startDate.setDate(new Date().getDate() - dayOfWeek - 7); startDate.setHours(0, 0, 0, 0); endDate = new Date(startDate); endDate.setDate(startDate.getDate() + 6); endDate.setHours(23, 59, 59, 999); break;
        case 'nextWeek': startDate = new Date(); startDate.setDate(new Date().getDate() - dayOfWeek + 7); startDate.setHours(0, 0, 0, 0); endDate = new Date(startDate); endDate.setDate(startDate.getDate() + 6); endDate.setHours(23, 59, 59, 999); break;
        case 'thisMonth': startDate = new Date(currentYear, currentMonth, 1); endDate = new Date(currentYear, currentMonth + 1, 0); break;
        default:
          if (selection.startsWith('month_')) {
            const month = parseInt(selection.split('_')[1], 10) - 1;
            startDate = new Date(currentYear, month, 1);
            endDate = new Date(currentYear, month + 1, 0);
          } else if (selection.startsWith('quarter_')) {
            const quarter = parseInt(selection.split('_')[1], 10);
            const startMonth = (quarter - 1) * 3;
            startDate = new Date(currentYear, startMonth, 1);
            endDate = new Date(currentYear, startMonth + 3, 0);
          }
          break;
      }
      return { startDate, endDate };
    }
  </script>
</body>

</html>

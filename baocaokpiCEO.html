<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ch·ªâ s·ªë v·∫≠n ƒë∆°n c·ªßa MKT</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #2d7c2d;
      --primary-light: #4CAF50;
      --primary-dark: #2d7c2d;
      --text-dark: #111;
      --text-medium: #333;
      --bg-light: #f4f4f4;
      --border-color: #e0e0e0;
      --font-main: 'Roboto', Arial, sans-serif;
      --header-gradient: #4CAF50;
      --hover-highlight: rgba(76, 175, 80, 0.12);
    }

    body { 
      font-family: var(--font-main); 
      padding: 10px; 
      background: var(--bg-light); 
      color: var(--text-dark);
      margin: 0;
      font-size: 11px;
      line-height: 1.45;
    }
    .container { max-width: 98%; margin: 0 auto; }
    .header { display: flex; align-items: center; gap: 12px; margin-bottom: 14px; }
    .header h1 { margin: 0; color: var(--primary-color); font-size: 26px; font-weight: 700; }

    .filters { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 10px; 
      align-items: flex-start; 
      justify-content: flex-start; 
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(2px);
      padding: 12px; 
      border-radius: 10px; 
      box-shadow: 0 6px 18px rgba(15, 85, 47, 0.12);
      margin-bottom: 12px;
      border: 1px solid rgba(31, 157, 85, 0.25);
      position: relative;
      z-index: 2000;
    }
    .filters label { font-weight: 500; margin-right: 6px; }
    .filters input[type="date"], .filters input[type="text"] { padding: 7px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
    .filters .spacer { flex: 1 1 auto; }
    .btn { padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
    .btn-primary { background: var(--primary-color); color: #fff; }
    .btn-secondary { background: #e0e0e0; color: var(--text-medium); }

    .table-wrap { overflow-x: auto; }
    table { 
      width: 100%; 
      border-collapse: collapse; 
      background: #fff; 
      border-radius: 10px; 
      overflow: hidden; 
      box-shadow: 0 8px 24px rgba(20, 107, 54, 0.12);
      margin-top: 10px;
      table-layout: fixed;
    }
    #kpi-summary-table th:first-child,
    #kpi-summary-table td:first-child {
      width: 40px;
      min-width: 40px;
      max-width: 40px;
    }
    /* C·ªôt "S·ªë ƒë∆°n" - h·∫πp l·∫°i, v·ª´a v·ªõi d·ªØ li·ªáu */
    #kpi-summary-table td[data-col-index="4"].text-center,
    #kpi-summary-table td[data-col-index="5"].text-center,
    #kpi-summary-table td[data-col-index="6"].text-center,
    #kpi-summary-table td[data-col-index="7"].text-center,
    #kpi-summary-table td[data-col-index="12"].text-center,
    #kpi-summary-table tfoot td[data-col-index="4"].text-center,
    #kpi-summary-table tfoot td[data-col-index="5"].text-center,
    #kpi-summary-table tfoot td[data-col-index="6"].text-center,
    #kpi-summary-table tfoot td[data-col-index="7"].text-center,
    #kpi-summary-table tfoot td[data-col-index="12"].text-center {
      width: 55px !important;
      min-width: 55px !important;
      max-width: 55px !important;
      padding: 4px 2px !important;
      white-space: nowrap !important;
      text-align: center !important;
    }
    /* C·ªôt "Doanh s·ªë" - to ra (c√°c √¥ kh√¥ng c√≥ class text-center) */
    #kpi-summary-table th[data-col-index="4"]:nth-of-type(2),
    #kpi-summary-table th[data-col-index="5"]:nth-of-type(2),
    #kpi-summary-table th[data-col-index="6"]:nth-of-type(2),
    #kpi-summary-table th[data-col-index="7"]:nth-of-type(2),
    #kpi-summary-table th[data-col-index="13"],
    #kpi-summary-table td[data-col-index="4"]:not(.text-center),
    #kpi-summary-table td[data-col-index="5"]:not(.text-center),
    #kpi-summary-table td[data-col-index="6"]:not(.text-center),
    #kpi-summary-table td[data-col-index="7"]:not(.text-center),
    #kpi-summary-table td[data-col-index="13"],
    #kpi-summary-table tfoot td[data-col-index="4"]:not(.text-center),
    #kpi-summary-table tfoot td[data-col-index="5"]:not(.text-center),
    #kpi-summary-table tfoot td[data-col-index="6"]:not(.text-center),
    #kpi-summary-table tfoot td[data-col-index="7"]:not(.text-center),
    #kpi-summary-table tfoot td[data-col-index="13"] {
      width: 170px !important;
      min-width: 170px !important;
    }
    th, td { 
      border: 1px solid var(--border-color); 
      padding: 4px 6px; 
      white-space: normal;
      word-break: break-word;
      font-size: 12px; 
      font-weight: 700; 
      color: #000;
      vertical-align: middle;
      transition: background-color 0.2s ease;
    }
    th { 
      text-align: center !important; 
      font-weight: 700; 
      background: var(--header-gradient); 
      color: #fff; 
      position: sticky;
      top: 0;
      z-index: 10;
      cursor: pointer;
      line-height: 1.2;
      font-size: 11px;
    }
    tbody tr:nth-child(even) { background: #f9f9f9; }
    tbody tr:hover { background: #eff5fb; }
    td { text-align: right; }
    td.text-left { text-align: left; }
    tfoot tr { background: var(--primary-dark); color: #fff; font-weight: 700; }

    .badge-range { display:inline-block; background:#ffecb3; color:#6d4c41; padding:3px 6px; border-radius:4px; font-size:12px; margin-left:8px; }
    .status { margin-left: 8px; color: #666; }
    #loading { display:none; color: #2d7c2d; font-weight: 600; }
    .sort-caret { position:absolute; right:8px; top:50%; transform:translateY(-50%); opacity:.9; }

    /* Tabs for switching views */
    .view-tabs { display:flex; gap:10px; margin-bottom:12px; }
    .tab-btn { padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; background:#e0e0e0; color:var(--text-medium); }
    .tab-btn.active { background: var(--primary-color); color:#fff; }
    .hidden { display:none; }
    /* Extra styles for KPI-like summary */
    .total-row { 
      background: #ffeb3b !important; 
      color: #000 !important; 
      font-weight: 700 !important;
      font-size: 1.12em !important;
      border-top: none;
      border-bottom: none;
    }
    .total-row .total-label { text-align: left !important; }
    .total-row .total-value { text-align: right !important; }

    /* Dropdown checkbox filters */
    .dd { position: relative; }
    .dd-btn { 
      display:inline-flex; 
      align-items:center; 
      gap:6px; 
      padding:6px 10px; 
      border:1px solid #ccc; 
      border-radius:6px; 
      background:#fff; 
      cursor:pointer; 
      font-size:12px; 
      color:var(--text-medium);
      transition: all 0.2s ease;
    }
    .dd-btn:hover {
      background: var(--hover-highlight);
      border-color: var(--primary-light);
    }
    .dd-btn:after { content:'‚ñæ'; font-size:10px; opacity:.7; }
    .dd-menu { 
      position:absolute; 
      top: 100%;
      left:0; 
      margin-top: 2px;
      z-index:9999; 
      min-width:200px; 
      max-height:260px; 
      overflow:auto; 
      background:#fff; 
      border:1px solid var(--border-color); 
      border-radius:6px; 
      box-shadow:0 6px 18px rgba(15, 85, 47, 0.12); 
      padding:6px; 
      display:none; 
    }
    .dd.open { z-index: 9999; }
    .dd.open .dd-menu { display:block; z-index: 9999; }
    .dd-menu .dd-item { 
      display:flex; 
      align-items:center; 
      gap:6px; 
      padding:4px 6px; 
      border-radius:4px; 
      font-size:12px;
      transition: background 0.2s ease;
    }
    .dd-menu .dd-item:hover { background: var(--hover-highlight); }
    .dd-menu .dd-item input { margin:0; }
    .dd-menu .dd-section { font-weight:700; color:#555; margin:4px 0 2px; padding:2px 6px; font-size:11px; }
    .dd-menu .dd-search { width:100%; padding:6px 8px; margin-bottom:6px; border:1px solid var(--border-color); border-radius:4px; font-size:12px; }
    /* ƒê·ªìng b·ªô format b·∫£ng F3 v·ªõi b·∫£ng v·∫≠n ƒë∆°n */
    #rawF3Table {
      border-collapse: collapse;
      width: 100%;
      min-width: 1400px;
      max-width: 100%;
      table-layout: auto;
      font-size: 12px;
      background: #fff;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 8px 24px rgba(20, 107, 54, 0.12);
    }
    #rawF3Table th {
      background: var(--header-gradient);
      color: #fff;
      font-weight: 700;
      font-size: 11px;
      vertical-align: middle;
      position: sticky;
      top: 0;
      z-index: 20;
      text-align: center !important;
      padding: 6px;
      border-bottom: 1px solid rgba(255,255,255,0.25);
      white-space: normal;
      line-height: 1.2;
    }
    #rawF3Table td {
      background-color: white;
      text-align: left;
      padding: 6px;
      font-size: 12px;
      border: 1px solid var(--border-color);
    }
    #rawF3Table tbody tr:nth-child(even) {
      background: #f9f9f9;
    }
    #rawF3Table tbody tr:hover {
      background-color: #eff5fb;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Ch·ªâ s·ªë v·∫≠n ƒë∆°n c·ªßa MKT</h1>
      <span id="loading">ƒêang t·∫£i d·ªØ li·ªáu...</span>
      <span id="roleInfo" class="status"></span>
    </div>
    <!-- KHU V·ª∞C KPI T·ªîNG H·ª¢P - hi·ªÉn th·ªã full -->
    <div id="agg-container">
      <div class="filters">
      <div class="dd" id="dd-quickDate">
        <button type="button" class="dd-btn" id="btn-quickDate">B·ªô l·ªçc nhanh</button>
        <div class="dd-menu" id="menu-quickDate">
          <div class="dd-section">Kho·∫£ng th·ªùi gian</div>
          <label class="dd-item"><input type="radio" name="quickDate" value="today"> <span>H√¥m nay</span></label>
          <label class="dd-item"><input type="radio" name="quickDate" value="yesterday"> <span>H√¥m qua</span></label>
          <label class="dd-item"><input type="radio" name="quickDate" value="thisWeek"> <span>Tu·∫ßn n√†y</span></label>
          <label class="dd-item"><input type="radio" name="quickDate" value="lastWeek"> <span>Tu·∫ßn tr∆∞·ªõc</span></label>
          <label class="dd-item"><input type="radio" name="quickDate" value="thisMonth"> <span>Th√°ng n√†y</span></label>
          <div class="dd-section">Theo th√°ng</div>
          <label class="dd-item"><input type="radio" name="quickDate" value="month1"> <span>Th√°ng 1</span></label>
          <label class="dd-item"><input type="radio" name="quickDate" value="month2"> <span>Th√°ng 2</span></label>
          <label class="dd-item"><input type="radio" name="quickDate" value="month3"> <span>Th√°ng 3</span></label>
          <label class="dd-item"><input type="radio" name="quickDate" value="month4"> <span>Th√°ng 4</span></label>
          <label class="dd-item"><input type="radio" name="quickDate" value="month5"> <span>Th√°ng 5</span></label>
          <label class="dd-item"><input type="radio" name="quickDate" value="month6"> <span>Th√°ng 6</span></label>
          <label class="dd-item"><input type="radio" name="quickDate" value="month7"> <span>Th√°ng 7</span></label>
          <label class="dd-item"><input type="radio" name="quickDate" value="month8"> <span>Th√°ng 8</span></label>
          <label class="dd-item"><input type="radio" name="quickDate" value="month9"> <span>Th√°ng 9</span></label>
          <label class="dd-item"><input type="radio" name="quickDate" value="month10"> <span>Th√°ng 10</span></label>
          <label class="dd-item"><input type="radio" name="quickDate" value="month11"> <span>Th√°ng 11</span></label>
          <label class="dd-item"><input type="radio" name="quickDate" value="month12"> <span>Th√°ng 12</span></label>
        </div>
      </div>
      <div>
        <label for="startDate">T·ª´ ng√†y</label>
        <input type="date" id="startDate" />
      </div>
      <div>
        <label for="endDate">ƒê·∫øn ng√†y</label>
        <input type="date" id="endDate" />
      </div>
      <div class="dd" id="dd-filterStaffType">
        <button type="button" class="dd-btn" id="btn-filterStaffType">Lo·∫°i NV (T·∫•t c·∫£)</button>
        <div class="dd-menu" id="menu-filterStaffType"></div>
      </div>
      <div class="dd" id="dd-filterTeam">
        <button type="button" class="dd-btn" id="btn-filterTeam">Team (T·∫•t c·∫£)</button>
        <div class="dd-menu" id="menu-filterTeam"></div>
      </div>
      <div>
        <div class="dd" id="dd-filterName">
          <button type="button" class="dd-btn" id="btn-filterName">T√¨m t√™n (T·∫•t c·∫£)</button>
          <div class="dd-menu" id="menu-filterName"></div>
        </div>
      </div>
      <div class="dd" id="dd-filterProduct">
        <button type="button" class="dd-btn" id="btn-filterProduct">S·∫£n ph·∫©m (T·∫•t c·∫£)</button>
        <div class="dd-menu" id="menu-filterProduct"></div>
      </div>
      <div class="dd" id="dd-filterMarket">
        <button type="button" class="dd-btn" id="btn-filterMarket">Th·ªã tr∆∞·ªùng (T·∫•t c·∫£)</button>
        <div class="dd-menu" id="menu-filterMarket"></div>
      </div>
      <div>
        <label><input type="checkbox" id="includeZeroShip" checked /> Bao g·ªìm ƒë∆°n ship = 0</label>
      </div>
      <div class="dd" id="dd-filterBranch">
        <button type="button" class="dd-btn" id="btn-filterBranch">Chi nh√°nh (T·∫•t c·∫£)</button>
        <div class="dd-menu" id="menu-filterBranch"></div>
      </div>
      <span id="rangeText" class="badge-range"></span>
      <span class="spacer"></span>
      <button id="showAllBtn" class="btn btn-secondary">Hi·ªán t·∫•t c·∫£</button>
      <button id="refreshBtn" class="btn btn-secondary">L√†m m·ªõi</button>
      <button id="exportExcelBtn" class="btn btn-primary">üì• T·∫£i Excel</button>
      </div>

      <div class="column-controls" style="margin-bottom: 15px; padding: 10px; background: #f9f9f9; border-radius: 5px;">
        <strong>T√πy ch·ªçn hi·ªÉn th·ªã c·ªôt:</strong>
        <label style="margin-left: 15px;"><input type="checkbox" class="toggle-column" data-col="3" checked> CPQC</label>
        <label><input type="checkbox" class="toggle-column" data-col="4" checked> S·ªë ƒë∆°n & DS ch·ªët</label>
        <label><input type="checkbox" class="toggle-column" data-col="5" checked> S·ªë ƒë∆°n & DS h·ªßy</label>
        <label><input type="checkbox" class="toggle-column" data-col="6" checked> S·ªë ƒë∆°n & DS sau h·ªßy</label>
        <label><input type="checkbox" class="toggle-column" data-col="7" checked> S·ªë ƒë∆°n & DS ƒëi</label>
        <label><input type="checkbox" class="toggle-column" data-col="12" checked> S·ªë ƒë∆°n & DThu th√†nh c√¥ng</label>
        <label><input type="checkbox" class="toggle-column" data-col="14" checked> Ship</label>
        <label><input type="checkbox" class="toggle-column" data-col="15" checked> DThu t√≠nh KPI</label>
        <label><input type="checkbox" class="toggle-column" data-col="16" checked> T·ª∑ l·ªá thu ti·ªÅn</label>
        <label><input type="checkbox" class="toggle-column" data-col="18" checked> %CP/DT</label>
      </div>
      <div class="table-wrap">
        <table id="kpi-summary-table" class="sortable-table">
          <thead>
            <tr>
              <th rowspan="2">STT</th>
              <th rowspan="2">Team</th>
              <th rowspan="2">Nh√¢n vi√™n</th>
              <th rowspan="2" data-col-index="3">CPQC</th>
              <th colspan="2" data-col-index="4">S·ªë ƒë∆°n v√† DS ch·ªët</th>
              <th colspan="2" data-col-index="5">S·ªë ƒë∆°n v√† DS h·ªßy</th>
              <th colspan="2" data-col-index="6">S·ªë ƒë∆°n v√† DS sau h·ªßy</th>
              <th colspan="2" data-col-index="7">S·ªë ƒë∆°n v√† DS ƒëi</th>
              <th colspan="2" data-col-index="12">S·ªë ƒë∆°n v√† DThu th√†nh c√¥ng</th>
              <th rowspan="2" data-col-index="14">Ship</th>
              <th rowspan="2" data-col-index="15">DThu t√≠nh KPI</th>
              <th rowspan="2" data-col-index="16">T·ª∑ l·ªá thu ti·ªÅn</th>
              <th rowspan="2" data-col-index="18">%CP/DT</th>
            </tr>
            <tr>
              <th data-col-index="4">S·ªë ƒë∆°n</th>
              <th data-col-index="4">DS ch·ªët</th>
              <th data-col-index="5">S·ªë ƒë∆°n</th>
              <th data-col-index="5">DS h·ªßy</th>
              <th data-col-index="6">S·ªë ƒë∆°n</th>
              <th data-col-index="6">DS sau h·ªßy</th>
              <th data-col-index="7">S·ªë ƒë∆°n</th>
              <th data-col-index="7">DS ƒëi</th>
              <th data-col-index="12">S·ªë ƒë∆°n</th>
              <th data-col-index="13">DThu TC</th>
            </tr>
          </thead>
          <tbody id="kpi-summary-body"></tbody>
          <tfoot id="kpi-summary-foot"></tfoot>
        </table>
      </div>
      <div class="status" id="statusText"></div>
    </div>

    <!-- RAW F3 VIEW (ƒë√£ t√°ch sang file ri√™ng, ·∫©n trong trang KPI) -->
    <div id="raw-container" class="hidden">
      <div class="filters">
        <div>
          <label for="rawSearch">T√¨m ki·∫øm</label>
          <input type="text" id="rawSearch" placeholder="T√¨m trong m·ªçi c·ªôt..." />
        </div>
        <div>
          <label for="rawPageSize">S·ªë d√≤ng/trang</label>
          <select id="rawPageSize">
            <option value="50">50</option>
            <option value="100" selected>100</option>
            <option value="200">200</option>
            <option value="500">500</option>
            <option value="all">T·∫•t c·∫£</option>
          </select>
        </div>
        <div>
          <label for="rawFilterCa">Ca</label>
          <select id="rawFilterCa">
            <option value="">T·∫•t c·∫£</option>
          </select>
        </div>
      <div>
          <label for="rawDept">Ph√≤ng ban</label>
          <select id="rawDept">
            <option value="">T·∫•t c·∫£</option>
            <option value="MKT">MKT</option>
            <option value="Sale">Sale</option>
            <option value="V·∫≠n ƒë∆°n">V·∫≠n ƒë∆°n</option>
          </select>
      </div>
      <div>
          <label for="rawName">T√™n</label>
          <select id="rawName">
            <option value="">T·∫•t c·∫£</option>
          </select>
      </div>
      <div>
          <label for="rawCheck">K·∫øt qu·∫£ Check</label>
          <select id="rawCheck">
            <option value="">T·∫•t c·∫£</option>
          </select>
      </div>
      <div>
          <label for="rawDelivery">Tr·∫°ng th√°i giao h√†ng NB</label>
          <select id="rawDelivery">
            <option value="">T·∫•t c·∫£</option>
          </select>
      </div>
        <span class="spacer"></span>
        <button id="rawExportBtn" class="btn btn-primary">Xu·∫•t CSV</button>
      </div>
      
      <!-- Column visibility controls for F3 table -->
      <div class="column-controls-f3" style="margin: 10px 0; padding: 10px; background: rgba(255, 255, 255, 0.95); border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
        <strong style="color: #2d7c2d;">Hi·ªÉn th·ªã c·ªôt:</strong>
        <label style="font-size: 11px; display: flex; align-items: center; gap: 4px;"><input type="checkbox" class="toggle-f3-column" data-col="0" checked> STT</label>
        <label style="font-size: 11px; display: flex; align-items: center; gap: 4px;"><input type="checkbox" class="toggle-f3-column" data-col="1" checked> M√£ ƒë∆°n</label>
        <label style="font-size: 11px; display: flex; align-items: center; gap: 4px;"><input type="checkbox" class="toggle-f3-column" data-col="2" checked> Ng√†y l√™n ƒë∆°n</label>
        <label style="font-size: 11px; display: flex; align-items: center; gap: 4px;"><input type="checkbox" class="toggle-f3-column" data-col="3" checked> Nh√¢n vi√™n MKT</label>
        <label style="font-size: 11px; display: flex; align-items: center; gap: 4px;"><input type="checkbox" class="toggle-f3-column" data-col="4" checked> Nh√¢n vi√™n Sale</label>
        <label style="font-size: 11px; display: flex; align-items: center; gap: 4px;"><input type="checkbox" class="toggle-f3-column" data-col="5" checked> NV V·∫≠n ƒë∆°n</label>
        <label style="font-size: 11px; display: flex; align-items: center; gap: 4px;"><input type="checkbox" class="toggle-f3-column" data-col="6" checked> Ca</label>
        <label style="font-size: 11px; display: flex; align-items: center; gap: 4px;"><input type="checkbox" class="toggle-f3-column" data-col="7" checked> S·∫£n ph·∫©m</label>
        <label style="font-size: 11px; display: flex; align-items: center; gap: 4px;"><input type="checkbox" class="toggle-f3-column" data-col="8" checked> Khu v·ª±c</label>
        <label style="font-size: 11px; display: flex; align-items: center; gap: 4px;"><input type="checkbox" class="toggle-f3-column" data-col="9" checked> Chi nh√°nh</label>
        <label style="font-size: 11px; display: flex; align-items: center; gap: 4px;"><input type="checkbox" class="toggle-f3-column" data-col="10" checked> T·ªïng ti·ªÅn VNƒê</label>
        <label style="font-size: 11px; display: flex; align-items: center; gap: 4px;"><input type="checkbox" class="toggle-f3-column" data-col="11" checked> S·ªë ti·ªÅn ƒë·ªëi so√°t</label>
        <label style="font-size: 11px; display: flex; align-items: center; gap: 4px;"><input type="checkbox" class="toggle-f3-column" data-col="12" checked> K·∫øt qu·∫£ Check</label>
        <label style="font-size: 11px; display: flex; align-items: center; gap: 4px;"><input type="checkbox" class="toggle-f3-column" data-col="13" checked> Tr·∫°ng th√°i giao h√†ng NB</label>
        <label style="font-size: 11px; display: flex; align-items: center; gap: 4px;"><input type="checkbox" class="toggle-f3-column" data-col="14" checked> M√£ tracking</label>
      </div>
      
      <div id="rawSummaryTop" class="status" style="margin-top:6px;"></div>
      <div class="table-wrap">
        <table id="rawF3Table">
          <thead id="rawHead"></thead>
          <tbody id="rawBody"></tbody>
        </table>
      </div>
      <div class="status" id="rawStatus"></div>
      <div style="margin-top:8px; display:flex; align-items:center; gap:10px;">
        <button id="rawPrev" class="btn btn-secondary">Trang tr∆∞·ªõc</button>
        <span id="rawPageInfo"></span>
        <button id="rawNext" class="btn btn-secondary">Trang sau</button>
      </div>
    </div>

    <!-- KPI VIEW (embedded from viewNsMoiNhanh.html) -->
    <div id="kpi-container" class="hidden">
      <iframe src="viewNsMoiNhanh.html" style="width:100%; height:85vh; border:none;" title="B√°o c√°o KPI"></iframe>
    </div>
  </div>

  <script>
    const F3_URL = 'https://lumi-6dff7-default-rtdb.asia-southeast1.firebasedatabase.app/datasheet/F3.json';
    const BAO_CAO_MKT_URL = 'https://n-api-gamma.vercel.app/report/generate?tableName=' + encodeURIComponent('B√°o c√°o MKT');
    const HR_URL = 'https://lumi-6dff7-default-rtdb.asia-southeast1.firebasedatabase.app/datasheet/Nh%C3%A2n_s%E1%BB%B1.json';
    // Fallback sample (user-provided) to display when network fails
    const F3_SAMPLE = {
      "0": {
        "Add": "3 Seneca Court",
        "Ca": "Gi·ªØa ca",
        "City": "Streamwood",
        "Gi√° b√°n": 179,
        "Gi√° g·ªëc": 179,
        "H√¨nh th·ª©c thanh to√°n": "Zelle",
        "Khu v·ª±c": "US",
        "K·∫øt qu·∫£ Check": "V·∫≠n ƒë∆°n XL",
        "Lo·∫°i ti·ªÅn thanh to√°n": "USD",
        "M√†u backlist": "Kh√°ch m·ªõi",
        "M√£ ƒë∆°n h√†ng": "Keme1f8aba6",
        "M·∫∑t h√†ng": "Kem Body",
        "NV V·∫≠n ƒë∆°n": "test",
        "Name*": "Luz Adaya",
        "Ng√†y l√™n ƒë∆°n": "2025-07-25T17:00:00.000Z",
        "Nh√¢n vi√™n Marketing": "Nguy·ªÖn Quang Tr∆∞·ªùng",
        "Nh√¢n vi√™n Sale": "Ho√†ng Th·ªã Uy√™n",
        "Phone*": 6302443988,
        "Ph√≠ ship": 0,
        "State": "Illinois",
        "S·ªë l∆∞·ª£ng m·∫∑t h√†ng 1": 5,
        "S·ªë ti·ªÅn th·ª±c thu": 0,
        "Team": "H√† N·ªôi",
        "Th·ªùi gian l√™n ƒë∆°n": "2025-07-25T23:01:51.000Z",
        "Ti·ªÅn Vi·ªát ƒë√£ ƒë·ªëi so√°t": 0,
        "Ti·ªÅn chi·∫øt kh·∫•u": 0,
        "Tr·∫°ng th√°i ƒë∆°n": "ƒê∆°n h·ª£p l·ªá",
        "T√™n l√™n ƒë∆°n": "Luz Adaya",
        "T√™n m·∫∑t h√†ng 1": "Kem Body",
        "T√™n m·∫∑t h√†ng 2": "Kem Body",
        "T√™n page": "Venature Glutathione Body Lotion 50x Tone Up US - Beauty & Health",
        "T·ªïng s·ªë ti·ªÅn t·ª´ FFM": 0,
        "T·ªïng ti·ªÅn VNƒê": 4296000,
        "X√°c nh·∫≠n ƒë∆°n": "ƒê√£ x√°c nh·∫≠n TT kh√°ch , ƒê√£ X√°c nh·∫≠n TT ƒë∆°n , ƒê√£ x√°c nh·∫≠n TT giao h√†ng , ƒê√£ x√°c nh·∫≠n TT thanh to√°n",
        "Zipcode": 60107,
        "in": 7
      }
    };

    let rawOrders = [];
    let currentData = [];
    let sortState = { column: null, direction: 'asc' };
    
    // Debounce function ƒë·ªÉ gi·∫£m lag khi l·ªçc
    let filterTimeout = null;
    function debounceFilter(callback, delay = 300) {
      if (filterTimeout) clearTimeout(filterTimeout);
      filterTimeout = setTimeout(callback, delay);
    }
    
    // Wrapper function cho applyFiltersAndRender v·ªõi debounce
    function debouncedApplyFilters() {
      debounceFilter(() => {
        requestAnimationFrame(() => {
          applyFiltersAndRender();
        });
      }, 200);
    }
    // RAW view state
    let rawColumns = [];
    let rawFiltered = [];
      // MKT report data
      let mktRows = [];
    // HR data and access scope
    let hrRows = [];
    let userPosition = '';
    let userTeam = '';
    let userName = '';
    let allowedNames = null; // Set of allowed marketer names; null means unrestricted
    let rawPage = 1;
    let rawPageSize = 100;
    let rawSort = { key: null, dir: 'asc' };
    let rawSearchText = '';

    document.addEventListener('DOMContentLoaded', async () => {
      setDefaultDates();
      await loadData();
      bindEvents();

      // Ch·ªçn ch·∫ø ƒë·ªô hi·ªÉn th·ªã theo tham s·ªë view tr√™n URL:
      // - view=f3  -> ch·ªâ hi·ªÉn th·ªã RAW F3
      // - m·∫∑c ƒë·ªãnh -> ch·ªâ hi·ªÉn th·ªã KPI
      const viewMode = getQueryParam('view');
      const aggContainer = document.getElementById('agg-container');
      const rawContainer = document.getElementById('raw-container');
      if (viewMode === 'f3') {
        if (aggContainer) aggContainer.classList.add('hidden');
        if (rawContainer) rawContainer.classList.remove('hidden');
      } else {
        if (aggContainer) aggContainer.classList.remove('hidden');
        if (rawContainer) rawContainer.classList.add('hidden');
      }
    });

    function setDefaultDates() {
      document.getElementById('startDate').value = '';
      document.getElementById('endDate').value = '';
      updateRangeBadge();
    }

    function updateRangeBadge() {
      const s = document.getElementById('startDate').value;
      const e = document.getElementById('endDate').value;
      const el = document.getElementById('rangeText');
      el.textContent = (s && e) ? `Kho·∫£ng: ${s} ‚Üí ${e}` : '';
    }

    async function loadData() {
      toggleLoading(true);
      try {
        const [dataF3, dataMkt, dataHr] = await Promise.all([
          fetchWithRetry(F3_URL, { retries: 3, delayMs: 800 }),
          fetchWithRetry(BAO_CAO_MKT_URL, { retries: 3, delayMs: 800 }).catch(() => null),
          fetchWithRetry(HR_URL, { retries: 3, delayMs: 800 }).catch(() => null)
        ]);
        rawOrders = normalizeF3(dataF3);
        // X·ª≠ l√Ω d·ªØ li·ªáu t·ª´ API m·ªõi: c√≥ th·ªÉ l√† {data: [...]} ho·∫∑c {rows: [...]} ho·∫∑c array tr·ª±c ti·∫øp
        if (dataMkt) {
          if (Array.isArray(dataMkt)) {
            mktRows = normalizeF3(dataMkt);
          } else if (dataMkt.data && Array.isArray(dataMkt.data)) {
            mktRows = normalizeF3(dataMkt.data);
          } else if (dataMkt.rows && Array.isArray(dataMkt.rows)) {
            mktRows = normalizeF3(dataMkt.rows);
          } else {
            mktRows = normalizeF3(dataMkt);
          }
        } else {
          mktRows = [];
          console.warn('‚ö†Ô∏è No MKT report data loaded - CPQC will be 0 for all staff');
        }
        // Load HR data gi·ªëng nh∆∞ vandonCEO.html: ch·ªâ l·∫•y record c√≥ Team
        if (dataHr) {
          const normalized = normalizeF3(dataHr);
          // L·ªçc ch·ªâ l·∫•y nh·ªØng record c√≥ Team (gi·ªëng vandonCEO.html)
          hrRows = normalized.filter(item => item && item["Team"]);
          console.log('‚úÖ HR data loaded:', hrRows.length, 'records with Team');
          if (hrRows.length > 0) {
            console.log('üìå Sample HR record:', hrRows[0]);
          }
        } else {
          hrRows = [];
          console.warn('‚ö†Ô∏è No HR data loaded from Firebase');
        }
        computeAccessScope();
        populateAllFilters();
        applyFiltersAndRender(); // Ch·ªâ d√πng cho KPI, kh√¥ng kh·ªüi t·∫°o RAW F3 view n·ªØa
      } catch (e) {
        console.error('L·ªói t·∫£i d·ªØ li·ªáu F3:', e);
        document.getElementById('statusText').textContent = 'Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu t·ª´ F3. ƒêang hi·ªÉn th·ªã d·ªØ li·ªáu m·∫´u.';
        const rawStatus = document.getElementById('rawStatus');
        if (rawStatus) rawStatus.textContent = 'Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu t·ª´ F3. ƒêang hi·ªÉn th·ªã d·ªØ li·ªáu m·∫´u.';
        // Use fallback sample so UI still works
        rawOrders = normalizeF3(F3_SAMPLE);
        mktRows = [];
        hrRows = [];
        computeAccessScope();
        populateAllFilters();
        applyFiltersAndRender(); // Ch·ªâ d√πng cho KPI
      } finally {
        toggleLoading(false);
      }
    }

    function getQueryParam(key) {
      try {
        const params = new URLSearchParams(window.location.search);
        let val = params.get(key);
        if (!val) {
          const hash = window.location.hash || '';
          // support both #id=XXX or #...&id=XXX
          const match = hash.match(new RegExp(`[?#&]?(?:${key})=([^&]+)`));
          if (match && match[1]) val = decodeURIComponent(match[1]);
        }
        return val ? String(val).trim() : '';
      } catch (_) { return ''; }
    }

    function computeAccessScope() {
      allowedNames = null;
      userPosition = '';
      userTeam = '';
      userName = '';

      // N·∫øu c√≥ scope=allF3 tr√™n URL ‚Üí kh√¥ng gi·ªõi h·∫°n theo nh√¢n s·ª±, lu√¥n xem full data
      const scope = getQueryParam('scope');
      if (scope === 'allF3') {
        updateRoleInfo(); // X√≥a/clear roleInfo n·∫øu c√≥
        return;
      }

      if (!Array.isArray(hrRows) || !hrRows.length) { 
        updateRoleInfo(); 
        allowedNames = null; // Kh√¥ng c√≥ HR data ‚Üí xem t·∫•t c·∫£
        return; 
      }
      const idParam = getQueryParam('id');
      if (!idParam) {
        // Kh√¥ng c√≥ id ‚Üí admin mode, xem t·∫•t c·∫£
        allowedNames = null;
        updateRoleInfo();
        return;
      }
      const matchId = (row) => {
        const candidates = ['id','ID','Id','uid','UID','Uid','M√£ nh√¢n s·ª±','M√£_Nh√¢n_s·ª±','Ma_Nhan_su'];
        for (const k of candidates) {
          if (row[k] !== undefined && String(row[k]).trim() === idParam) return true;
        }
        for (const k in row) {
          if (k && k.toLowerCase() === 'id' && String(row[k]).trim() === idParam) return true;
        }
        return false;
      };
      const me = hrRows.find(matchId);
      if (!me) {
        const el = document.getElementById('roleInfo');
        if (el) el.textContent = `Kh√¥ng t√¨m th·∫•y id: ${idParam} trong Nh√¢n s·ª±`;
        return;
      }
      userName = (me['T√™n'] ?? me['Name'] ?? me['H·ªç v√† t√™n'] ?? me['H·ªç_v√†_t√™n'] ?? me['H·ªç V√† T√™n'] ?? '').toString().trim();
      userPosition = (me['V·ªã tr√≠'] ?? me['Vi_tri'] ?? me['Vi tr√≠'] ?? me['Position'] ?? '').toString().trim();
      userTeam = (me['Team'] ?? '').toString().trim();
      
      const isLeader = /leader/i.test(userPosition);
      const isNV = /^nv$/i.test(userPosition) || userPosition.toLowerCase() === 'nh√¢n vi√™n';
      
      console.log('üë§ User info:', { id: idParam, userName, userPosition, userTeam, isLeader, isNV });
      
      const set = new Set();
      if (isLeader) {
        // Leader: xem full Team c·ªßa m√¨nh
        hrRows.forEach(r => {
          const t = (r['Team'] ?? '').toString().trim();
          if (t === userTeam && t) { // Ch·ªâ l·∫•y nh√¢n vi√™n c√πng Team v√† Team kh√¥ng r·ªóng
            const n = (r['T√™n'] ?? r['Name'] ?? r['H·ªç v√† t√™n'] ?? r['H·ªç_v√†_t√™n'] ?? r['H·ªç V√† T√™n'] ?? '').toString().trim();
            if (n) set.add(n);
          }
        });
        console.log('üëî Leader - allowed names from team:', Array.from(set));
      } else {
        // NV ho·∫∑c kh√¥ng ph·∫£i Leader: ch·ªâ xem c·ªßa ch√≠nh m√¨nh
        if (userName) {
          set.add(userName);
          console.log('üë∑ NV/Staff - allowed name (self only):', userName);
        }
      }
      allowedNames = set.size ? set : null;
      updateRoleInfo();
    }

    function updateRoleInfo() {
      const el = document.getElementById('roleInfo');
      if (!el) return;
      if (!userPosition) { el.textContent = ''; return; }
      if (/leader/i.test(userPosition)) {
        el.textContent = `V·ªã tr√≠: ${userPosition} | Team: ${userTeam}`;
      } else {
        el.textContent = `V·ªã tr√≠: ${userPosition}`;
      }
    }

    async function fetchWithRetry(url, opts = {}) {
      const { retries = 2, delayMs = 500 } = opts;
      let lastErr;
      for (let i = 0; i <= retries; i++) {
        try {
          const res = await fetch(url, { cache: 'no-store' });
          if (!res.ok) {
            const errorMsg = `HTTP ${res.status} - ${res.statusText}`;
            console.warn(`‚ö†Ô∏è Fetch failed for ${url}: ${errorMsg}`);
            throw new Error(errorMsg);
          }
          return await res.json();
        } catch (err) {
          lastErr = err;
          if (i < retries) {
            console.log(`üîÑ Retrying fetch (${i + 1}/${retries}) for ${url}...`);
            await new Promise(r => setTimeout(r, delayMs * Math.pow(2, i)));
          }
        }
      }
      console.error(`‚ùå Failed to fetch ${url} after ${retries + 1} attempts:`, lastErr);
      throw lastErr;
    }

    function normalizeF3(data) {
      if (Array.isArray(data)) return data;
      if (data && typeof data === 'object') {
        try {
          return Object.values(data).filter(r => r && typeof r === 'object');
        } catch (_) { return []; }
      }
      return [];
    }

    function getUniqueValues(field) {
      const s = new Set();
      const restrict = allowedNames && allowedNames.size > 0;
      rawOrders.forEach(r => {
        if (restrict) {
          const nm = (r && r['Nh√¢n vi√™n Marketing'] ? String(r['Nh√¢n vi√™n Marketing']).trim() : '');
          if (!allowedNames.has(nm)) return;
        }
        const v = r && r[field];
        if (v === undefined || v === null) return;
        if (field === 'Ca') {
          String(v).split(',').map(x => x.trim()).filter(Boolean).forEach(tok => s.add(tok));
        } else {
          s.add(String(v).trim());
        }
      });
      return Array.from(s).filter(x => x !== '').sort((a,b)=>a.localeCompare(b));
    }

    function populateSelectOptions(selectId, values) {
      const el = document.getElementById(selectId);
      if (!el) return;
      const prev = el.value;
      el.innerHTML = '<option value="">T·∫•t c·∫£</option>' + values.map(v => `<option value="${v}">${v}</option>`).join('');
      if (values.includes(prev)) el.value = prev; else el.value = '';
    }

    function populateAllFilters() {
      const caValues = getUniqueValues('Ca');
      const productValues = getUniqueValues('M·∫∑t h√†ng');
      const branchValues = getUniqueValues('Team'); // Team in F3 = Chi nh√°nh
      const marketValues = getUniqueValues('Khu v·ª±c');

      // 1. Populate Staff Type
      const staffTypes = ['Marketing', 'Sale', 'V·∫≠n ƒë∆°n'];
      populateDropdown('filterStaffType', staffTypes);
      // M·∫∑c ƒë·ªãnh ch·ªçn Marketing ƒë·ªÉ gi·ªëng behavior c≈© (tr·ª´ khi user ch·ªçn kh√°c)
      // Tuy nhi√™n ƒë·ªÉ ti·ªán cho ng∆∞·ªùi d√πng m·ªõi, ta set Marketing l√†m m·∫∑c ƒë·ªãnh
      // setDropdownValues('filterStaffType', ['Marketing']); 
      // NH∆ØNG: User y√™u c·∫ßu "nh∆∞ vandonCEO", vandonCEO m·∫∑c ƒë·ªãnh all n·∫øu ko c√≥ user role.
      // File n√†y l√† B√°o c√°o MKT, n√™n m·∫∑c ƒë·ªãnh MKT l√† h·ª£p l√Ω.
      const currentType = getSelectedDropdown('filterStaffType');
      if (currentType.all && currentType.values.length === 0) {
         setDropdownValues('filterStaffType', ['Marketing']);
      }

      // 2. Update Team dropdown based on Staff Type
      updateTeamDropdown();

      populateDropdown('filterProduct', productValues);
      populateDropdown('filterBranch', branchValues);
      populateDropdown('filterMarket', marketValues);
      
      // 3. Populate Name dropdown based on current Team & Staff Type selection
      populateNameDropdownBasedOnTeam();
      
      // Auto-select allowed names if defined
      if (allowedNames && allowedNames.size > 0) {
        setDropdownValues('filterName', allowedNames);
      }
      // Auto-select user's team if defined
      if (userTeam) {
        setDropdownValues('filterTeam', [userTeam]);
        // Re-populate names restricted by userTeam
        populateNameDropdownBasedOnTeam();
      }
      // RAW tab filters
      populateSelectOptions('rawFilterCa', caValues);
      populateRawNameOptions();
      populateRawSelectFromField('rawCheck', 'K·∫øt qu·∫£ Check');
      populateRawSelectFromField('rawDelivery', 'Tr·∫°ng th√°i giao h√†ng NB');
    }

    function updateTeamDropdown() {
      const selectedTypes = getSelectedDropdown('filterStaffType');
      console.log('üîÑ Updating Team dropdown for staff types:', selectedTypes.values);
      // Map Lo·∫°i NV -> B·ªô ph·∫≠n (HR data)
      const boPhanMap = { 'Marketing': 'MKT', 'Sale': 'Sale', 'V·∫≠n ƒë∆°n': 'V·∫≠n ƒë∆°n' };
      const boPhanFilters = new Set();
      if (!selectedTypes.all && selectedTypes.values.length > 0) {
         selectedTypes.values.forEach(t => { if (boPhanMap[t]) boPhanFilters.add(boPhanMap[t]); });
      }
      console.log('üìã Filtering by departments:', Array.from(boPhanFilters));

      const teamValues = new Set();
      // ∆Øu ti√™n l·∫•y t·ª´ HR Data
      if (Array.isArray(hrRows) && hrRows.length > 0) {
         hrRows.forEach(r => {
             const bp = (r['B·ªô ph·∫≠n'] || r['Bo_phan'] || '').toString().trim();
             const bpUpper = bp.toUpperCase();
             const tm = (r['Team'] || '').toString().trim();
             if (!tm) return;
             
             // N·∫øu kh√¥ng ch·ªçn lo·∫°i NV n√†o (ho·∫∑c ch·ªçn T·∫•t c·∫£), l·∫•y h·∫øt Team c√≥ trong HR
             if (boPhanFilters.size === 0) {
                 teamValues.add(tm);
                 return;
             }
             
             // N·∫øu c√≥ ch·ªçn, ch·ªâ l·∫•y Team c·ªßa b·ªô ph·∫≠n ƒë√≥ (th·ª≠ nhi·ªÅu bi·∫øn th·ªÉ)
             let match = false;
             
             // Check exact match tr∆∞·ªõc
             if (boPhanFilters.has(bp)) {
                match = true;
             }
             // Check c√°c bi·∫øn th·ªÉ
             else if (boPhanFilters.has('MKT') && (bp === 'MKT' || bpUpper === 'MKT' || bp === 'Marketing' || bpUpper === 'MARKETING')) {
                match = true;
             }
             else if (boPhanFilters.has('Sale') && (bp === 'Sale' || bpUpper === 'SALE')) {
                match = true;
             }
             else if (boPhanFilters.has('V·∫≠n ƒë∆°n')) {
                // Th·ª≠ nhi·ªÅu bi·∫øn th·ªÉ c·ªßa V·∫≠n ƒë∆°n
                if (bp === 'V·∫≠n ƒë∆°n' || bp === 'V·∫≠n_ƒë∆°n' || bp === 'Van don' || 
                    bpUpper === 'V·∫¨N ƒê∆†N' || bpUpper === 'V·∫¨N_ƒê∆†N' || 
                    bp.includes('V·∫≠n') || bp.includes('v·∫≠n')) {
                   match = true;
                }
             }
             
             if (match) {
                 teamValues.add(tm);
             }
         });
         console.log('üìä Teams found for selected staff types:', Array.from(teamValues).sort());
      } else {
         // Fallback: l·∫•y t·ª´ B√°o c√°o MKT (ch·ªâ c√≥ MKT) ho·∫∑c F3
         if (mktRows) mktRows.forEach(r => { const t = (r['Team']||'').trim(); if(t) teamValues.add(t); });
         // N·∫øu ch·ªçn Sale/V·∫≠n ƒë∆°n m√† kh√¥ng c√≥ HR data, c√≥ th·ªÉ s·∫Ω thi·∫øu team.
      }
      
      const teamArrayAll = Array.from(teamValues).sort((a,b)=>a.localeCompare(b));
      const teamArray = userTeam ? [userTeam] : teamArrayAll;
      
      // L∆∞u selection hi·ªán t·∫°i ƒë·ªÉ ki·ªÉm tra
      const currentTeamSelection = getSelectedDropdown('filterTeam');
      const hasCurrentSelection = !currentTeamSelection.all && currentTeamSelection.values.length > 0;
      
      // Populate dropdown (s·∫Ω t·ª± ƒë·ªông preserve selection n·∫øu gi√° tr·ªã v·∫´n c√≤n)
      populateDropdown('filterTeam', teamArray);
      
      // N·∫øu c√≥ selection nh∆∞ng kh√¥ng c√≤n trong danh s√°ch m·ªõi, reset v·ªÅ "T·∫•t c·∫£"
      if (hasCurrentSelection) {
         const newTeamSelection = getSelectedDropdown('filterTeam');
         const stillHasSelection = !newTeamSelection.all && newTeamSelection.values.length > 0;
         if (!stillHasSelection) {
            // Selection ƒë√£ b·ªã m·∫•t -> reset v·ªÅ "T·∫•t c·∫£"
            setDropdownAll('filterTeam');
            console.log('üîÑ Team selection reset to "T·∫•t c·∫£" because selected teams are no longer available');
         }
      }
      
      console.log('‚úÖ Team dropdown updated with', teamArray.length, 'teams');
    }

    function getDeptField(dept) {
      if (dept === 'MKT') return 'Nh√¢n vi√™n Marketing';
      if (dept === 'Sale') return 'Nh√¢n vi√™n Sale';
      if (dept === 'V·∫≠n ƒë∆°n') return 'NV V·∫≠n ƒë∆°n';
      return null;
    }

    function populateRawNameOptions() {
      const deptEl = document.getElementById('rawDept');
      const select = document.getElementById('rawName');
      if (!deptEl || !select) return;
      const dept = deptEl.value || '';
      const field = getDeptField(dept);
      const nameSet = new Set();

      rawOrders.forEach(r => {
        const fieldsToCheck = field ? [field] : ['Nh√¢n vi√™n Marketing','Nh√¢n vi√™n Sale','NV V·∫≠n ƒë∆°n'];
        fieldsToCheck.forEach(f => {
          const v = r && r[f];
          if (v === undefined || v === null) return;
          const name = String(v).trim();
          if (!name) return;
          // Gi·ªõi h·∫°n theo allowedNames n·∫øu ƒëang l·ªçc theo MKT
          if (dept === 'MKT' && f === 'Nh√¢n vi√™n Marketing' && allowedNames && allowedNames.size > 0) {
            if (!allowedNames.has(name)) return;
          }
          nameSet.add(name);
        });
      });

      const names = Array.from(nameSet).sort((a,b)=>a.localeCompare(b));
      const prev = select.value;
      select.innerHTML = '<option value="">T·∫•t c·∫£</option>' + names.map(n => `<option value="${n}">${n}</option>`).join('');
      if (names.includes(prev)) select.value = prev; else select.value = '';
    }

    function populateRawSelectFromField(selectId, field) {
      const select = document.getElementById(selectId);
      if (!select) return;
      const values = new Set();
      rawOrders.forEach(r => {
        const v = r && r[field];
        if (v === undefined || v === null) return;
        const s = String(v).trim();
        if (!s) return;
        
        // N·∫øu l√† field "Ca", t√°ch c√°c ca n·∫øu c√≥ d·∫•u ph·∫©y (VD: "Gi·ªØa ca,H·∫øt ca" -> ["Gi·ªØa ca", "H·∫øt ca"])
        if (field === 'Ca' && s.includes(',')) {
          s.split(',').forEach(ca => {
            const trimmedCa = ca.trim();
            if (trimmedCa) values.add(trimmedCa);
          });
        } else {
          values.add(s);
        }
      });
      const arr = Array.from(values).sort((a,b)=>a.localeCompare(b));
      const prev = select.value;
      select.innerHTML = '<option value="">T·∫•t c·∫£</option>' + arr.map(v => `<option value="${v}">${v}</option>`).join('');
      if (arr.includes(prev)) select.value = prev; else select.value = '';
    }
    function populateNameDropdownBasedOnTeam() {
      const selectedTeam = getSelectedDropdown('filterTeam');
      const selectedTypes = getSelectedDropdown('filterStaffType');
      
      const boPhanMap = { 'Marketing': 'MKT', 'Sale': 'Sale', 'V·∫≠n ƒë∆°n': 'V·∫≠n ƒë∆°n' };
      const targetDepts = new Set();
      if (!selectedTypes.all && selectedTypes.values.length > 0) {
          selectedTypes.values.forEach(t => { if (boPhanMap[t]) targetDepts.add(boPhanMap[t]); });
      }
      
      const names = new Set();
      
      // ∆Øu ti√™n l·∫•y t·ª´ HR data
      if (Array.isArray(hrRows) && hrRows.length > 0) {
          hrRows.forEach(r => {
              const n = (r['T√™n'] ?? r['Name'] ?? r['H·ªç v√† t√™n'] ?? '').toString().trim();
              if (!n) return;
              const tm = (r['Team'] || '').toString().trim();
              const bp = (r['B·ªô ph·∫≠n'] || '').toString().trim();
              
              // Filter by Team
              if (!selectedTeam.all) {
                  const isEmpty = (tm === '');
                  if (selectedTeam.empty && isEmpty) {} 
                  else if (selectedTeam.values.includes(tm)) {} 
                  else return;
              }
              
              // Filter by Staff Type (Dept)
              if (targetDepts.size > 0) {
                  if (!targetDepts.has(bp)) return;
              }
              
              names.add(n);
          });
      } else {
          // Fallback logic c≈© n·∫øu kh√¥ng c√≥ HR data (ch·ªß y·∫øu cho MKT)
          // Ch·ªâ ch·∫°y n·∫øu targetDepts bao g·ªìm MKT ho·∫∑c r·ªóng
          if (targetDepts.size === 0 || targetDepts.has('MKT')) {
              if (Array.isArray(mktRows)) {
                mktRows.forEach(row => {
                  const name = (row['T√™n'] ?? row['Ten'] ?? row['Name'] ?? row['H·ªç_v√†_t√™n'] ?? row['Email'] ?? '').toString().trim();
                  const tm = (row['Team'] ?? row['team'] ?? '').toString().trim();
                  if (!name) return;
                  
                  if (!selectedTeam.all) {
                     const isEmpty = (tm === '');
                     if (selectedTeam.empty && isEmpty) {} 
                     else if (selectedTeam.values.includes(tm)) {} 
                     else return;
                  }
                  names.add(name);
                });
              }
              // F3 fallback
              rawOrders.forEach(r => {
                const n = (r['Nh√¢n vi√™n Marketing'] || '').toString().trim();
                if (!n) return;
                // F3 ko c√≥ team info tr·ª±c ti·∫øp cho NV, gi·∫£ s·ª≠ empty team ho·∫∑c check logic kh√°c
                // ·ªû ƒë√¢y t·∫°m b·ªè qua check team ch·∫∑t ch·∫Ω cho fallback F3
                names.add(n);
              });
          }
      }

      // Apply user access restrictions
      let nameList = Array.from(names);
      if (allowedNames && allowedNames.size > 0) {
        nameList = nameList.filter(n => allowedNames.has(n));
      }
      nameList.sort((a,b)=>a.localeCompare(b));
      
      populateDropdown('filterName', nameList);
    }
    function populateDropdown(filterId, values) {
      const menu = document.getElementById(`menu-${filterId}`);
      const btn = document.getElementById(`btn-${filterId}`);
      if (!menu || !btn) return;
      // Preserve previous selection
      const prev = new Set(Array.from(menu.querySelectorAll('input[type="checkbox"]:checked')).map(i=>i.value));
      const makeItem = (value, label) => `<label class="dd-item"><input type="checkbox" value="${value}"> <span>${label}</span></label>`;
      const specialsHtml = [
        makeItem('__ALL__', '‚úì T·∫•t c·∫£'),
        makeItem('__EMPTY__', '[ Tr·ªëng ]')
      ].join('');
      const regularHtml = values.map(v => makeItem(v, v)).join('');
      menu.innerHTML = `
        <input type="text" class="dd-search" placeholder="T√¨m..." aria-label="T√¨m nhanh">
        ${specialsHtml}
        <div class="dd-items">${regularHtml}</div>
      `;
      // restore previous
      menu.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        if (prev.size) cb.checked = prev.has(cb.value);
      });
      updateDropdownButtonLabel(filterId);
      attachDropdownSearch(filterId);
    }

    function setDropdownValues(filterId, values) {
      const menu = document.getElementById(`menu-${filterId}`);
      if (!menu) return;
      const set = new Set(Array.isArray(values) ? values : values ? Array.from(values) : []);
      // Uncheck all first
      menu.querySelectorAll('input[type="checkbox"]').forEach(cb => { cb.checked = false; });
      // Check desired values
      menu.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        if (set.has(cb.value)) cb.checked = true;
      });
      // Ensure __ALL__ and __EMPTY__ are not selected
      const all = menu.querySelector('input[value="__ALL__"]');
      const empty = menu.querySelector('input[value="__EMPTY__"]');
      if (all) all.checked = false;
      if (empty) empty.checked = false;
      updateDropdownButtonLabel(filterId);
    }

    function attachDropdownSearch(filterId) {
      const menu = document.getElementById(`menu-${filterId}`);
      if (!menu) return;
      const search = menu.querySelector('.dd-search');
      const itemsWrap = menu.querySelector('.dd-items');
      if (!search || !itemsWrap) return;
      search.addEventListener('input', () => {
        const q = search.value.trim().toLowerCase();
        itemsWrap.querySelectorAll('.dd-item').forEach(item => {
          const label = (item.querySelector('span')?.textContent || '').toLowerCase();
          item.style.display = q === '' || label.includes(q) ? '' : 'none';
        });
      });
    }

    function updateDropdownButtonLabel(filterId) {
      const menu = document.getElementById(`menu-${filterId}`);
      const btn = document.getElementById(`btn-${filterId}`);
      if (!menu || !btn) return;
      const checked = Array.from(menu.querySelectorAll('input[type="checkbox"]:checked')).map(i=>i.value);
      let text = btn.textContent.split(' (')[0];
      if (checked.includes('__ALL__') || checked.length === 0) {
        btn.textContent = `${text} (T·∫•t c·∫£)`;
        return;
      }
      const selectedLabels = checked.filter(v=>v!=='__ALL__' && v!=='__EMPTY__');
      if (checked.includes('__EMPTY__')) selectedLabels.unshift('Tr·ªëng');
      btn.textContent = `${text} (${selectedLabels.length || 'T·∫•t c·∫£'})`;
    }

    function getSelectedDropdown(filterId) {
      const menu = document.getElementById(`menu-${filterId}`);
      if (!menu) return { all:false, empty:false, values:[] };
      const sel = Array.from(menu.querySelectorAll('input[type="checkbox"]:checked')).map(i=>i.value);
      const hasAll = sel.includes('__ALL__');
      const hasEmpty = sel.includes('__EMPTY__');
      const values = sel.filter(v => v !== '__ALL__' && v !== '__EMPTY__');
      return { all: hasAll || sel.length===0, empty: hasEmpty, values };
    }

    function setDropdownAll(filterId) {
      const menu = document.getElementById(`menu-${filterId}`);
      if (!menu) return;
      menu.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
      const all = menu.querySelector('input[value="__ALL__"]');
      if (all) all.checked = true;
      updateDropdownButtonLabel(filterId);
    }

    function bindEvents() {
      document.getElementById('startDate').addEventListener('change', () => { 
        // Clear quick date selection when manually changing dates
        const quickDateRadios = document.querySelectorAll('input[name="quickDate"]');
        quickDateRadios.forEach(radio => radio.checked = false);
        updateRangeBadge(); 
        debouncedApplyFilters(); 
      });
      document.getElementById('endDate').addEventListener('change', () => { 
        // Clear quick date selection when manually changing dates
        const quickDateRadios = document.querySelectorAll('input[name="quickDate"]');
        quickDateRadios.forEach(radio => radio.checked = false);
        updateRangeBadge(); 
        debouncedApplyFilters(); 
      });
      // Name dropdown uses checkbox menu; removed text search
      document.getElementById('refreshBtn').addEventListener('click', () => loadData());
      const showAllBtn = document.getElementById('showAllBtn');
      if (showAllBtn) showAllBtn.addEventListener('click', () => clearFiltersToShowAll());
      const exportExcelBtn = document.getElementById('exportExcelBtn');
      if (exportExcelBtn) exportExcelBtn.addEventListener('click', () => exportKpiToExcel());
      // Dropdown open/close for checkbox dropdowns
      ['filterProduct','filterBranch','filterTeam','filterMarket','filterName','filterStaffType'].forEach(fid => {
        const wrap = document.getElementById(`dd-${fid}`);
        const btn = document.getElementById(`btn-${fid}`);
        const menu = document.getElementById(`menu-${fid}`);
        if (btn && wrap) btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const wasOpen = wrap.classList.contains('open');
          closeAllDropdowns();
          wrap.classList.toggle('open', !wasOpen);
          if (!wasOpen && menu) {
            const search = menu.querySelector('.dd-search');
            if (search) setTimeout(() => { try { search.focus(); search.select?.(); } catch(_){} }, 0);
          }
        });
        // Keep menu open when interacting inside
        if (menu) {
          menu.addEventListener('click', (e) => { e.stopPropagation(); });
          menu.addEventListener('input', (e) => { e.stopPropagation(); });
          menu.addEventListener('keydown', (e) => { e.stopPropagation(); });
        }
        if (menu) menu.addEventListener('change', (e) => {
          // Handle ALL toggle logic: if ALL checked, uncheck others; if any other checked, uncheck ALL
          const tgt = e.target;
          if (tgt && tgt.type === 'checkbox') {
            if (tgt.value === '__ALL__') {
              if (tgt.checked) {
                menu.querySelectorAll('input[type="checkbox"]').forEach(cb => { if (cb !== tgt) cb.checked = false; });
              }
            } else {
              const allCb = menu.querySelector('input[value="__ALL__"]');
              if (allCb) allCb.checked = false;
            }
            updateDropdownButtonLabel(fid);
            
            if (fid === 'filterStaffType') {
              updateTeamDropdown();
              populateNameDropdownBasedOnTeam();
            }
            if (fid === 'filterTeam') {
              // Rebuild Name options when Team changes
              populateNameDropdownBasedOnTeam();
              // √Åp d·ª•ng ·∫©n/hi·ªán c√°c d√≤ng theo team (sau khi render)
              setTimeout(() => applyTeamFilterVisibility(), 0);
            }
            debouncedApplyFilters();
          }
        });
      });
      
      // Quick date dropdown (radio buttons)
      const quickDateWrap = document.getElementById('dd-quickDate');
      const quickDateBtn = document.getElementById('btn-quickDate');
      const quickDateMenu = document.getElementById('menu-quickDate');
      if (quickDateBtn && quickDateWrap) {
        quickDateBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          const wasOpen = quickDateWrap.classList.contains('open');
          closeAllDropdowns();
          quickDateWrap.classList.toggle('open', !wasOpen);
        });
        if (quickDateMenu) {
          quickDateMenu.addEventListener('click', (e) => { e.stopPropagation(); });
          
          // Quick date filter dropdown change handler
          quickDateMenu.addEventListener('change', (e) => {
          if (e.target.type === 'radio' && e.target.checked) {
            const value = e.target.value;
            const today = new Date();
            const startDate = document.getElementById('startDate');
            const endDate = document.getElementById('endDate');
            
            let start = new Date();
            let end = new Date();
            
            if (value === 'today') {
              start = new Date(today);
              end = new Date(today);
            } else if (value === 'yesterday') {
              start = new Date(today);
              start.setDate(start.getDate() - 1);
              end = new Date(start);
            } else if (value === 'thisWeek') {
              const dayOfWeek = today.getDay();
              const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); // Monday
              start = new Date(today.getFullYear(), today.getMonth(), diff);
              end = new Date(today);
            } else if (value === 'lastWeek') {
              const lastWeekStart = new Date(today);
              const lastWeekDay = today.getDay();
              const lastWeekDiff = today.getDate() - lastWeekDay - 6; // Previous Monday
              lastWeekStart.setDate(lastWeekDiff);
              const lastWeekEnd = new Date(lastWeekStart);
              lastWeekEnd.setDate(lastWeekStart.getDate() + 6);
              start = lastWeekStart;
              end = lastWeekEnd;
            } else if (value === 'thisMonth') {
              // Ng√†y 1 c·ªßa th√°ng hi·ªán t·∫°i (b·∫Øt bu·ªôc)
              const year = today.getFullYear();
              const month = today.getMonth();
              start = new Date(year, month, 1);
              // Ng√†y cu·ªëi c·ªßa th√°ng hi·ªán t·∫°i
              end = new Date(year, month + 1, 0);
            } else if (value.startsWith('month')) {
              const month = parseInt(value.replace('month', ''));
              const year = today.getFullYear();
              // Ng√†y 1 c·ªßa th√°ng (b·∫Øt bu·ªôc) - lu√¥n l√† ng√†y 1
              start = new Date(year, month - 1, 1);
              // Ng√†y cu·ªëi c·ªßa th√°ng
              end = new Date(year, month, 0);
            }
            
            if (start && end) {
              // Format date ƒë·ªÉ ƒë·∫£m b·∫£o lu√¥n l√† ng√†y 1 cho start
              const startYear = start.getFullYear();
              const startMonth = String(start.getMonth() + 1).padStart(2, '0');
              const startDay = '01'; // Lu√¥n l√† ng√†y 1
              startDate.value = `${startYear}-${startMonth}-${startDay}`;
              
              // Format date cho end
              const endYear = end.getFullYear();
              const endMonth = String(end.getMonth() + 1).padStart(2, '0');
              const endDay = String(end.getDate()).padStart(2, '0');
              endDate.value = `${endYear}-${endMonth}-${endDay}`;
              updateRangeBadge();
              debouncedApplyFilters();
            }
          }
        });
        }
      }
      document.addEventListener('click', () => closeAllDropdowns());
      const includeZeroEl = document.getElementById('includeZeroShip');
      if (includeZeroEl) includeZeroEl.addEventListener('change', () => debouncedApplyFilters());

      const kpiHead = document.getElementById('kpi-summary-table')?.querySelector('thead');
      if (kpiHead) kpiHead.addEventListener('click', (e) => sortKpiTable(e));

      document.querySelectorAll('.toggle-column').forEach(cb => cb.addEventListener('change', toggleKpiColumn));

      // RAW view listeners
      const rawSearch = document.getElementById('rawSearch');
      if (rawSearch) rawSearch.addEventListener('input', () => { rawSearchText = rawSearch.value.trim().toLowerCase(); applyRawFiltersAndRender(); });
      const rawSz = document.getElementById('rawPageSize');
      if (rawSz) rawSz.addEventListener('change', () => { 
        const val = rawSz.value;
        rawPageSize = (val === 'all') ? Number.MAX_SAFE_INTEGER : Number(val || 100);
        rawPage = 1; 
        applyRawFiltersAndRender(); 
      });
      const rawPrev = document.getElementById('rawPrev');
      if (rawPrev) rawPrev.addEventListener('click', () => { rawPage = Math.max(1, rawPage - 1); renderRawBody(); });
      const rawNext = document.getElementById('rawNext');
      if (rawNext) rawNext.addEventListener('click', () => { const totalPages = Math.max(1, Math.ceil((rawFiltered.length||0) / rawPageSize)); rawPage = Math.min(totalPages, rawPage + 1); renderRawBody(); });
      const rawExportBtn = document.getElementById('rawExportBtn');
      if (rawExportBtn) rawExportBtn.addEventListener('click', () => exportRawCSV());
      const rawFilterCaEl = document.getElementById('rawFilterCa');
      if (rawFilterCaEl) rawFilterCaEl.addEventListener('change', () => applyRawFiltersAndRender());
      const rawDeptEl = document.getElementById('rawDept');
      if (rawDeptEl) rawDeptEl.addEventListener('change', () => { populateRawNameOptions(); applyRawFiltersAndRender(); });
      const rawNameEl = document.getElementById('rawName');
      if (rawNameEl) rawNameEl.addEventListener('change', () => applyRawFiltersAndRender());
      const rawCheckEl = document.getElementById('rawCheck');
      if (rawCheckEl) rawCheckEl.addEventListener('change', () => applyRawFiltersAndRender());
      const rawDeliveryEl = document.getElementById('rawDelivery');
      if (rawDeliveryEl) rawDeliveryEl.addEventListener('change', () => applyRawFiltersAndRender());
      const rawHead = document.getElementById('rawHead');
      if (rawHead) rawHead.addEventListener('click', (e) => {
        const th = e.target.closest('th[data-key]');
        if (!th) return;
        const key = th.getAttribute('data-key');
        if (rawSort.key === key) rawSort.dir = rawSort.dir === 'asc' ? 'desc' : 'asc'; else { rawSort.key = key; rawSort.dir = 'asc'; }
        applyRawSortingAndRender();
      });
      
      // F3 Column visibility toggles
      document.querySelectorAll('.toggle-f3-column').forEach(cb => {
        cb.addEventListener('change', (e) => {
          const colIndex = parseInt(e.target.dataset.col);
          const isVisible = e.target.checked;
          toggleF3Column(colIndex, isVisible);
        });
      });
    }
    
    function toggleF3Column(colIndex, isVisible) {
      const table = document.getElementById('rawF3Table');
      if (!table) return;
      
      // Toggle header cells
      const headerCells = table.querySelectorAll('thead th');
      if (headerCells[colIndex]) {
        headerCells[colIndex].style.display = isVisible ? '' : 'none';
      }
      
      // Toggle body cells
      table.querySelectorAll('tbody tr').forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells[colIndex]) {
          cells[colIndex].style.display = isVisible ? '' : 'none';
        }
      });
    }

    // setActiveTab kh√¥ng c√≤n d√πng v√¨ ch·ªâ gi·ªØ l·∫°i F3

    function closeAllDropdowns() {
      document.querySelectorAll('.dd.open').forEach(el => el.classList.remove('open'));
    }

    function parseNumber(val) {
      if (val === null || val === undefined || val === '') return 0;
      if (typeof val === 'number') return val;
      let s = String(val).trim();
      // X·ª≠ l√Ω ƒë·ªãnh d·∫°ng s·ªë: c√≥ th·ªÉ l√† "1.234.567" (VN) ho·∫∑c "1,234.56" (US) ho·∫∑c "1234567"
      // Ki·ªÉm tra n·∫øu c√≥ d·∫•u ch·∫•m ·ªü 3 v·ªã tr√≠ cu·ªëi (ƒë·ªãnh d·∫°ng US v·ªõi ph·∫ßn th·∫≠p ph√¢n)
      const lastDotIndex = s.lastIndexOf('.');
      const lastCommaIndex = s.lastIndexOf(',');
      if (lastDotIndex > -1 && lastDotIndex === s.length - 3) {
        // C√≥ d·∫•u ch·∫•m ·ªü v·ªã tr√≠ th·ª© 3 t·ª´ cu·ªëi -> c√≥ th·ªÉ l√† ph·∫ßn th·∫≠p ph√¢n (US format)
        // Ki·ªÉm tra xem c√≥ d·∫•u ph·∫©y tr∆∞·ªõc ƒë√≥ kh√¥ng (nh∆∞ "1,234.56")
        if (lastCommaIndex > -1 && lastCommaIndex < lastDotIndex) {
          // ƒê·ªãnh d·∫°ng US: "1,234.56" -> gi·ªØ d·∫•u ch·∫•m, x√≥a d·∫•u ph·∫©y
          s = s.replace(/,/g, '');
        } else {
          // C√≥ th·ªÉ l√† ƒë·ªãnh d·∫°ng VN v·ªõi d·∫•u ch·∫•m l√†m ph√¢n c√°ch h√†ng ngh√¨n
          // X√≥a t·∫•t c·∫£ d·∫•u ch·∫•m v√† ph·∫©y
          s = s.replace(/\./g, '').replace(/,/g, '');
        }
      } else if (lastCommaIndex > -1 && lastCommaIndex === s.length - 3) {
        // C√≥ d·∫•u ph·∫©y ·ªü v·ªã tr√≠ th·ª© 3 t·ª´ cu·ªëi -> c√≥ th·ªÉ l√† ph·∫ßn th·∫≠p ph√¢n (VN format)
        // Thay d·∫•u ph·∫©y b·∫±ng d·∫•u ch·∫•m cho parseFloat, x√≥a c√°c d·∫•u ch·∫•m kh√°c
        s = s.replace(/\./g, '').replace(',', '.');
      } else {
        // Kh√¥ng c√≥ ph·∫ßn th·∫≠p ph√¢n -> x√≥a t·∫•t c·∫£ d·∫•u ch·∫•m v√† ph·∫©y (ƒë·ªãnh d·∫°ng VN)
        s = s.replace(/\./g, '').replace(/,/g, '');
      }
      const n = Number(s);
      return isNaN(n) ? 0 : n;
    }

    function toDate(val) {
      if (!val) return null;
      const d = new Date(val);
      return isNaN(d.getTime()) ? null : d;
    }

    function inRange(d, start, end) {
      if (!start && !end) return true;
      if (!d) return false;
      if (start && d < start) return false;
      if (end && d > end) return false;
      return true;
    }

    function applyFiltersAndRender() {
      const s = document.getElementById('startDate').value ? new Date(document.getElementById('startDate').value + 'T00:00:00') : null;
      const e = document.getElementById('endDate').value ? new Date(document.getElementById('endDate').value + 'T23:59:59') : null;
      const selectedName = getSelectedDropdown('filterName');
      const includeZero = document.getElementById('includeZeroShip') ? document.getElementById('includeZeroShip').checked : true;
      
      // Get selected values from dropdown checkbox filters
      const selectedProduct = getSelectedDropdown('filterProduct');
      const selectedBranch = getSelectedDropdown('filterBranch'); // Chi nh√°nh from F3 Team
      const selectedTeam = getSelectedDropdown('filterTeam'); // Team from BAO_CAO_MKT/HR
      const selectedMarket = getSelectedDropdown('filterMarket');
      const selectedStaffType = getSelectedDropdown('filterStaffType');

      // Determine target roles/columns based on Staff Type
      const roleColumns = [];
      if (selectedStaffType.all || selectedStaffType.values.length === 0) {
          roleColumns.push({ col: 'Nh√¢n vi√™n Marketing', type: 'Marketing' });
          roleColumns.push({ col: 'Nh√¢n vi√™n Sale', type: 'Sale' });
          roleColumns.push({ col: 'NV V·∫≠n ƒë∆°n', type: 'V·∫≠n ƒë∆°n' });
      } else {
          if (selectedStaffType.values.includes('Marketing')) roleColumns.push({ col: 'Nh√¢n vi√™n Marketing', type: 'Marketing' });
          if (selectedStaffType.values.includes('Sale')) roleColumns.push({ col: 'Nh√¢n vi√™n Sale', type: 'Sale' });
          if (selectedStaffType.values.includes('V·∫≠n ƒë∆°n')) roleColumns.push({ col: 'NV V·∫≠n ƒë∆°n', type: 'V·∫≠n ƒë∆°n' });
      }

      const filtered = rawOrders.filter(r => {
        const d = toDate(r['Ng√†y l√™n ƒë∆°n']);
        if (!inRange(d, s, e)) return false;
        
        const ship = parseNumber(r['Ph√≠ ship']);
        if (!includeZero && ship === 0) return false;
        
        // Filter by CA - B·ªè filter "H·∫øt ca" ƒë·ªÉ kh√¥ng lo·∫°i b·ªè ƒë∆°n h√†ng
        // (C√≥ th·ªÉ th√™m l·∫°i filter n√†y n·∫øu c·∫ßn)
        // const caFields = ['Ca', 'ca', 'CA'];
        // let hasCaField = false;
        // let hasHetCa = false;
        // for (const field of caFields) {
        //   if (r[field] !== undefined && r[field] !== null && r[field] !== '') {
        //     hasCaField = true;
        //     const cas = String(r[field] || '').split(',').map(x => x.trim()).filter(Boolean);
        //     if (cas.length > 0 && cas.includes('H·∫øt ca')) {
        //       hasHetCa = true;
        //       break;
        //     }
        //   }
        // }
        // if (hasCaField && !hasHetCa) return false;
        
        // Filter by Product
        if (!selectedProduct.all && (selectedProduct.values.length > 0 || selectedProduct.empty)) {
          const prod = (r['M·∫∑t h√†ng'] || '').toString().trim();
          const isEmpty = prod === '';
          if (selectedProduct.empty && isEmpty) {}
          else if (selectedProduct.values.length > 0 && selectedProduct.values.includes(prod)) {}
          else return false;
        }
        
        // Filter by Branch (Chi nh√°nh from F3 Team field)
        if (!selectedBranch.all && (selectedBranch.values.length > 0 || selectedBranch.empty)) {
          const branch = (r['Team'] || '').toString().trim();
          const isEmpty = branch === '';
          if (selectedBranch.empty && isEmpty) {}
          else if (selectedBranch.values.length > 0 && selectedBranch.values.includes(branch)) {}
          else return false;
        }
        
        // Filter by Market
        if (!selectedMarket.all && (selectedMarket.values.length > 0 || selectedMarket.empty)) {
          const market = (r['Khu v·ª±c'] || '').toString().trim();
          const isEmpty = market === '';
          if (selectedMarket.empty && isEmpty) {}
          else if (selectedMarket.values.length > 0 && selectedMarket.values.includes(market)) {}
          else return false;
        }
        
        return true;
      });

      // Build index for CPQC: name -> date -> {team, cpqc}
      // CPQC l√† c·ªôt ƒë·ªôc l·∫≠p, l·∫•y t·ª´ BAO_CAO_MKT_URL v√† filter theo b·ªô l·ªçc (date, team, name)
      const mktIndex = new Map();
      if (Array.isArray(mktRows) && mktRows.length) {
        // Pre-compute filter conditions
        const hasDateFilter = s !== null || e !== null;
        const hasTeamFilter = !selectedTeam.all && (selectedTeam.values.length > 0 || selectedTeam.empty);
        const hasNameFilter = !selectedName.all && (selectedName.values.length > 0 || selectedName.empty);
        const teamSet = hasTeamFilter && selectedTeam.values.length > 0 ? new Set(selectedTeam.values) : null;
        const nameSet = hasNameFilter && selectedName.values.length > 0 ? new Set(selectedName.values) : null;
        
        mktRows.forEach(row => {
          // Filter by CA - Ch·ªâ l·∫•y "H·∫øt ca" t·ª´ B√°o c√°o MKT (gi·ªëng baocaomkt)
          const caFields = ['Ca', 'ca', 'CA', 'ca TL'];
          let hasHetCa = false;
          for (const field of caFields) {
            if (row[field]) {
              const cas = String(row[field] || '').split(',').map(x => x.trim()).filter(Boolean);
              if (cas.length === 0 || !cas.includes('H·∫øt ca')) {
                // Kh√¥ng c√≥ ca ho·∫∑c kh√¥ng c√≥ "H·∫øt ca"
              } else {
                hasHetCa = true;
                break;
              }
            }
          }
          if (!hasHetCa) return; // Ch·ªâ l·∫•y ƒë∆°n c√≥ "H·∫øt ca"
          
          // Filter by date range
          if (hasDateFilter) {
            const ngay = toDate(row['Ng√†y'] ?? row['Ngay'] ?? row['Ng√†y l√™n ƒë∆°n'] ?? row['Date'] ?? row['Ng√†y_l√™n_ƒë∆°n']);
            if (!ngay || !inRange(ngay, s, e)) return;
          }
          
          const ten = (row['T√™n'] ?? row['Ten'] ?? row['Name'] ?? row['H·ªç_v√†_t√™n'] ?? row['Email'] ?? '').toString().trim();
          if (!ten) return;
          
          // Filter by name
          if (hasNameFilter) {
            const isEmpty = ten === '';
            if (selectedName.empty && isEmpty) {}
            else if (nameSet && nameSet.has(ten)) {}
            else if (!selectedName.empty || !nameSet) return;
          }
          
          const ngay = toDate(row['Ng√†y'] ?? row['Ngay'] ?? row['Ng√†y l√™n ƒë∆°n'] ?? row['Date'] ?? row['Ng√†y_l√™n_ƒë∆°n']);
          if (!ngay) return;
          const dateKey = ngay.toISOString().split('T')[0]; // YYYY-MM-DD
          
          // Filter by team
          if (hasTeamFilter) {
            const tm = (row['Team'] ?? row['team'] ?? '').toString().trim();
            const isEmpty = tm === '';
            if (selectedTeam.empty && isEmpty) {}
            else if (teamSet && teamSet.has(tm)) {}
            else if (!selectedTeam.empty || !teamSet) return;
          }
          
          // ƒê·ªçc CPQC/CPOC - ∆∞u ti√™n CPOC v√¨ ƒë√≥ l√† t√™n c·ªôt trong baocaomkt
          const cp = Number(row['CPOC'] ?? row['CPQC'] ?? row['cpqc'] ?? 0) || 0;
          const tm = (row['Team'] ?? row['team'] ?? '').toString().trim();
          
          if (!mktIndex.has(ten)) mktIndex.set(ten, new Map());
          const dateMap = mktIndex.get(ten);
          if (!dateMap.has(dateKey)) dateMap.set(dateKey, { team: tm, cpqc: 0 });
          const entry = dateMap.get(dateKey);
          if (tm && !entry.team) entry.team = tm;
          entry.cpqc += cp;
        });
      }

      // B∆Ø·ªöC 1: L·∫•y danh s√°ch nh√¢n vi√™n t·ª´ HR data (gi·ªëng vandonCEO.html)
      const boPhanMap = { 'Marketing': 'MKT', 'Sale': 'Sale', 'V·∫≠n ƒë∆°n': 'V·∫≠n ƒë∆°n' };
      const boPhanFilters = new Set();
      if (!selectedStaffType.all && selectedStaffType.values.length > 0) {
         selectedStaffType.values.forEach(t => { if (boPhanMap[t]) boPhanFilters.add(boPhanMap[t]); });
      }

      // L·∫•y nh√¢n s·ª± t·ª´ HR data theo Team ƒë√£ ch·ªçn
      let staffFromHR = [];
      let useHRData = Array.isArray(hrRows) && hrRows.length > 0;
      
      if (useHRData) {
         // L·∫•y t·∫•t c·∫£ nh√¢n s·ª± t·ª´ HR data (kh√¥ng filter theo Team ·ªü ƒë√¢y, s·∫Ω filter sau)
         staffFromHR = hrRows;
         
         // L·ªçc theo B·ªô ph·∫≠n (Lo·∫°i NV) tr∆∞·ªõc
         if (boPhanFilters.size > 0) {
            staffFromHR = staffFromHR.filter(r => {
               const bp = (r['B·ªô ph·∫≠n'] || r['Bo_phan'] || '').toString().trim();
               const bpUpper = bp.toUpperCase();
               
               // Check exact match tr∆∞·ªõc
               if (boPhanFilters.has(bp)) return true;
               
               // Check c√°c bi·∫øn th·ªÉ c·ªßa t√™n B·ªô ph·∫≠n
               // MKT
               if (boPhanFilters.has('MKT') && (bp === 'MKT' || bpUpper === 'MKT' || bp === 'Marketing' || bpUpper === 'MARKETING')) {
                  return true;
               }
               // Sale
               if (boPhanFilters.has('Sale') && (bp === 'Sale' || bpUpper === 'SALE')) {
                  return true;
               }
               // V·∫≠n ƒë∆°n - th·ª≠ nhi·ªÅu bi·∫øn th·ªÉ
               if (boPhanFilters.has('V·∫≠n ƒë∆°n')) {
                  if (bp === 'V·∫≠n ƒë∆°n' || bp === 'V·∫≠n_ƒë∆°n' || bp === 'Van don' || 
                      bpUpper === 'V·∫¨N ƒê∆†N' || bpUpper === 'V·∫¨N_ƒê∆†N' || 
                      bp.includes('V·∫≠n') || bp.includes('v·∫≠n')) {
                     return true;
                  }
               }
               
               return false;
            });
            console.log('üìä After filtering by department:', staffFromHR.length, 'staff members');
         }
         
         // B·ªè filter Team ·ªü c·∫•p d·ªØ li·ªáu - s·∫Ω ·∫©n/hi·ªán trong UI thay v√¨ lo·∫°i b·ªè kh·ªèi danh s√°ch
         // if (!selectedTeam.all && (selectedTeam.values.length > 0 || selectedTeam.empty)) {
         //    staffFromHR = staffFromHR.filter(r => {
         //       const team = (r['Team'] || '').toString().trim();
         //       const isEmpty = team === '';
         //       if (selectedTeam.empty && isEmpty) return true;
         //       if (selectedTeam.values.length > 0 && selectedTeam.values.includes(team)) return true;
         //       return false;
         //    });
         // }
      }

      // Chuy·ªÉn ƒë·ªïi sang format {name, type, team} d·ª±a tr√™n B·ªô ph·∫≠n
      const staffWithTypes = [];
      if (useHRData) {
         console.log('üìä Processing HR staff:', staffFromHR.length, 'records');
         staffFromHR.forEach(r => {
            // Th·ª≠ nhi·ªÅu t√™n c·ªôt kh√°c nhau (gi·ªëng vandonCEO.html)
            const ten = (r['H·ªç V√† T√™n'] ?? r['T√™n'] ?? r['Name'] ?? r['H·ªç v√† t√™n'] ?? r['H·ªç_v√†_t√™n'] ?? '').toString().trim();
            const team = (r['Team'] || '').toString().trim();
            const boPhan = (r['B·ªô ph·∫≠n'] ?? r['Bo_phan'] ?? '').toString().trim();
            
            if (!ten || ten === '') {
               // Log ƒë·ªÉ debug n·∫øu kh√¥ng c√≥ t√™n
               if (staffFromHR.indexOf(r) < 3) {
                  console.log('‚ö†Ô∏è HR record without name:', Object.keys(r));
               }
               return;
            }
            
            // Map B·ªô ph·∫≠n sang lo·∫°i NV (th·ª≠ nhi·ªÅu t√™n kh√°c nhau)
            let type = '';
            const boPhanUpper = boPhan.toUpperCase();
            if (boPhan === 'MKT' || boPhanUpper === 'MKT' || boPhan === 'Marketing' || boPhanUpper === 'MARKETING') {
               type = 'Marketing';
            } else if (boPhan === 'Sale' || boPhanUpper === 'SALE') {
               type = 'Sale';
            } else if (boPhan === 'V·∫≠n ƒë∆°n' || boPhan === 'V·∫≠n_ƒë∆°n' || boPhan === 'Van don' || boPhanUpper === 'V·∫¨N ƒê∆†N' || boPhanUpper === 'V·∫¨N_ƒê∆†N' || boPhan === 'V·∫≠n ƒë∆°n' || boPhan.includes('V·∫≠n') || boPhan.includes('v·∫≠n')) {
               type = 'V·∫≠n ƒë∆°n';
            }
            
            if (type) {
               staffWithTypes.push({ name: ten, type: type, team: team });
            } else {
               // Log ƒë·ªÉ debug n·∫øu kh√¥ng c√≥ B·ªô ph·∫≠n ph√π h·ª£p (ch·ªâ log 5 record ƒë·∫ßu)
               if (staffFromHR.indexOf(r) < 5) {
                  console.log('‚ö†Ô∏è HR record without matching department:', { ten, boPhan, team, allKeys: Object.keys(r) });
               }
            }
         });
         console.log('‚úÖ Staff with types:', staffWithTypes.length, 'staff members');
         // Log s·ªë l∆∞·ª£ng theo t·ª´ng lo·∫°i
         const countByType = { Marketing: 0, Sale: 0, 'V·∫≠n ƒë∆°n': 0 };
         staffWithTypes.forEach(s => {
            if (countByType.hasOwnProperty(s.type)) countByType[s.type]++;
         });
         console.log('üìä Staff count by type:', countByType);
         
         // B·ªï sung: L·∫•y th√™m nh√¢n vi√™n t·ª´ F3 data n·∫øu h·ªç kh√¥ng c√≥ trong HR
         // ƒêi·ªÅu n√†y ƒë·∫£m b·∫£o kh√¥ng b·ªè s√≥t ƒë∆°n h√†ng
         const existingNames = new Set(staffWithTypes.map(s => `${s.name.toLowerCase()}|||${s.type}`));
         const nameTeamMap = new Map();
         roleColumns.forEach(rc => {
            const nameSet = new Set();
            filtered.forEach(r => {
               const name = (r[rc.col] || '').toString().trim();
               if (name) {
                  const key = `${name.toLowerCase()}|||${rc.type}`;
                  // Ch·ªâ th√™m n·∫øu ch∆∞a c√≥ trong HR data
                  if (!existingNames.has(key)) {
                     nameSet.add(name);
                     // Th·ª≠ l·∫•y Team t·ª´ MKT index n·∫øu l√† Marketing
                     if (rc.type === 'Marketing' && mktIndex.has(name)) {
                        const map = mktIndex.get(name);
                        if (map.size > 0) {
                           const team = map.values().next().value.team;
                           if (team && !nameTeamMap.has(name)) nameTeamMap.set(name, team);
                        }
                     }
                  }
               }
            });
            nameSet.forEach(name => {
               const team = nameTeamMap.get(name) || '';
               staffWithTypes.push({ name: name, type: rc.type, team: team });
            });
         });
         if (nameTeamMap.size > 0) {
            console.log('‚úÖ B·ªï sung th√™m', nameTeamMap.size, 'nh√¢n vi√™n t·ª´ F3 data');
         }
      } else {
         // Fallback: N·∫øu kh√¥ng c√≥ HR data, l·∫•y t·ª´ F3 data (logic c≈©)
         const nameTeamMap = new Map();
         roleColumns.forEach(rc => {
            const nameSet = new Set();
            filtered.forEach(r => {
               const name = (r[rc.col] || '').toString().trim();
               if (name) {
                  nameSet.add(name);
                  // Th·ª≠ l·∫•y Team t·ª´ MKT index n·∫øu l√† Marketing
                  if (rc.type === 'Marketing' && mktIndex.has(name)) {
                     const map = mktIndex.get(name);
                     if (map.size > 0) {
                        const team = map.values().next().value.team;
                        if (team && !nameTeamMap.has(name)) nameTeamMap.set(name, team);
                     }
                  }
               }
            });
            nameSet.forEach(name => {
               const team = nameTeamMap.get(name) || '';
               staffWithTypes.push({ name: name, type: rc.type, team: team });
            });
         });
      }

      // L·ªçc theo Name filter n·∫øu c√≥
      let finalStaffList = staffWithTypes;
      if (!selectedName.all && (selectedName.values.length > 0 || selectedName.empty)) {
         finalStaffList = staffWithTypes.filter(s => {
            const isEmptyName = s.name === '';
            if (selectedName.empty && isEmptyName) return true;
            if (selectedName.values.includes(s.name)) return true;
            return false;
         });
      }

      // L·ªçc theo allowedNames n·∫øu c√≥
      if (allowedNames && allowedNames.size > 0) {
         finalStaffList = finalStaffList.filter(s => allowedNames.has(s.name));
      }

      console.log('üìã Final staff list for table:', finalStaffList.length, 'staff members');
      if (finalStaffList.length > 0) {
         console.log('üìå Sample staff:', finalStaffList[0]);
      }

      // B∆Ø·ªöC 2: T√≠nh to√°n s·ªë li·ªáu cho t·ª´ng nh√¢n vi√™n t·ª´ HR data
      const byName = new Map();
      const cpqcByName = new Map();
      const cpqcProcessed = new Set(); // Track ƒë√£ c·ªông CPQC cho (name, date) n√†o
      
      // T·ªêI ∆ØU: T·∫°o Map index t·ª´ t√™n nh√¢n vi√™n (lowercase) ƒë·ªÉ lookup nhanh O(1) thay v√¨ O(n)
      // Map: t√™n (lowercase) -> { name, type, key, f3Column }
      const staffByNameLower = new Map(); // name lowercase -> staff info
      const staffByF3Column = {
        'Nh√¢n vi√™n Marketing': new Map(),
        'Nh√¢n vi√™n Sale': new Map(),
        'NV V·∫≠n ƒë∆°n': new Map()
      };
      
      // Kh·ªüi t·∫°o stats cho t·∫•t c·∫£ nh√¢n vi√™n t·ª´ HR v√† x√¢y d·ª±ng index
      finalStaffList.forEach(s => {
         const key = `${s.name}|||${s.type}`;
         if (!s.name || s.name.trim() === '') return;
         
         const nameTrimmed = s.name.trim();
         const nameLower = nameTrimmed.toLowerCase().replace(/\s+/g, ' ');
         
         // X√°c ƒë·ªãnh c·ªôt F3 t∆∞∆°ng ·ª©ng
         let f3Column = null;
         if (s.type === 'Marketing') f3Column = 'Nh√¢n vi√™n Marketing';
         else if (s.type === 'Sale') f3Column = 'Nh√¢n vi√™n Sale';
         else if (s.type === 'V·∫≠n ƒë∆°n') f3Column = 'NV V·∫≠n ƒë∆°n';
         
         if (f3Column && staffByF3Column[f3Column]) {
           staffByF3Column[f3Column].set(nameLower, { name: nameTrimmed, type: s.type, key, team: s.team || '' });
         }
         
         // Kh·ªüi t·∫°o stats
         byName.set(key, {
            name: nameTrimmed,
            team: s.team || '',
            type: s.type,
            soDonChot: 0, dsChot: 0,
            soDonHuy: 0, dsHuy: 0,
            soDonSauHuy: 0, dsSauHuy: 0,
            soDonDi: 0, dsDi: 0,
            soDonThuTien: 0, dThuThanhCong: 0,
            ship: 0, cpqc: 0
         });
      });
      
      // T·ªêI ∆ØU: T√≠nh to√°n s·ªë li·ªáu - O(n) thay v√¨ O(n*m)
      // V·ªõi m·ªói ƒë∆°n h√†ng, ch·ªâ lookup t√™n t·ª´ c√°c c·ªôt F3 trong Map (O(1))
      const f3Columns = ['Nh√¢n vi√™n Marketing', 'Nh√¢n vi√™n Sale', 'NV V·∫≠n ƒë∆°n'];
      
      filtered.forEach(r => {
        const ship = parseNumber(r['Ph√≠ ship']);
        const tongTien = parseNumber(r['T·ªïng ti·ªÅn VNƒê']);
        const ketQuaCheck = (r['K·∫øt qu·∫£ Check'] || '').toString().trim();
        const maTracking = (r['M√£ Tracking'] || '').toString().trim();
        const tienVietDoiSoat = parseNumber(r['Ti·ªÅn Vi·ªát ƒë√£ ƒë·ªëi so√°t']);
        const keToanXacNhan = (r['K·∫ø to√°n x√°c nh·∫≠n thu ti·ªÅn v·ªÅ'] ?? r['Ke toan xac nhan thu tien ve'] ?? '').toString().trim();
        const isHuy = ketQuaCheck === 'Hu·ª∑';
        const isDi = maTracking !== '';
        const isThanhCong = ketQuaCheck === 'OK' && isDi;
        const isDaThuTien = keToanXacNhan === 'ƒê√£ thu ti·ªÅn' || keToanXacNhan === 'Da thu tien';

        // Tr√°nh t√≠nh tr√πng cho c√πng m·ªôt nh√¢n vi√™n trong c√πng m·ªôt ƒë∆°n h√†ng
        const processedStaffForOrder = new Set();
        
        // Ch·ªâ lookup trong c√°c c·ªôt F3 c√≥ trong ƒë∆°n h√†ng (O(3) constant)
        for (const f3Column of f3Columns) {
          const nameInF3Raw = r[f3Column];
          if (!nameInF3Raw) continue;
          
          const nameInF3 = nameInF3Raw.toString().trim().toLowerCase().replace(/\s+/g, ' ');
          if (!nameInF3) continue;
          
          // Tr√°nh t√≠nh tr√πng
          if (processedStaffForOrder.has(nameInF3)) continue;
          
          // Lookup nhanh O(1) trong Map
          const staffInfo = staffByF3Column[f3Column]?.get(nameInF3);
          if (!staffInfo) continue;
          
          processedStaffForOrder.add(nameInF3);
          
          const agg = byName.get(staffInfo.key);
          if (!agg) continue;

          // T√≠nh to√°n s·ªë li·ªáu
          agg.soDonChot += 1;
          agg.dsChot += tongTien;
          if (isHuy) {
            agg.soDonHuy += 1;
            agg.dsHuy += tongTien;
          }
          if (isThanhCong) {
            agg.soDonDi += 1;
            agg.dsDi += tongTien;
          }
          if (isDaThuTien && tienVietDoiSoat > 0) {
            agg.soDonThuTien += 1;
            agg.dThuThanhCong += tienVietDoiSoat;
          }
          if (isDi) {
            agg.ship += ship;
          }
        }
      });
      
      // T√≠nh CPQC tr·ª±c ti·∫øp t·ª´ mktIndex cho T·∫§T C·∫¢ nh√¢n vi√™n trong finalStaffList
      // CPQC l√† c·ªôt ƒë·ªôc l·∫≠p, l·∫•y t·ª´ BAO_CAO_MKT_URL (ƒë√£ filter theo date, team, name)
      
      finalStaffList.forEach(staff => {
        if (staff.name) {
          const name = staff.name.trim();
          // Th·ª≠ match v·ªõi nhi·ªÅu c√°ch: exact, case-insensitive
          let matchedName = null;
          let matchedDateMap = null;
          
          // T√¨m exact match tr∆∞·ªõc
          if (mktIndex.has(name)) {
            matchedName = name;
            matchedDateMap = mktIndex.get(name);
          } else {
            // T√¨m case-insensitive match
            for (const [mktName, dateMap] of mktIndex.entries()) {
              if (mktName.toLowerCase() === name.toLowerCase()) {
                matchedName = mktName;
                matchedDateMap = dateMap;
                break;
              }
            }
          }
          
          if (matchedName && matchedDateMap) {
            let totalCpqc = 0;
            matchedDateMap.forEach((entry, dateKey) => {
              totalCpqc += entry.cpqc || 0;
            });
            if (totalCpqc > 0) {
              cpqcByName.set(name, totalCpqc);
            }
          }
        }
      });

      let rows = [...byName.values()]
        .map((it, idx) => {
          if (!it.name || it.name.trim() === '') {
          }
          const cpqc = cpqcByName.get(it.name) || 0;
          const dsSauHuy = Math.max(0, (it.dsChot || 0) - (it.dsHuy || 0));
          const dThuTinhKpi = (it.dThuThanhCong || 0) - (it.ship || 0);
          return {
            stt: idx + 1,
            name: (it.name || '').trim(),  // T√™n t·ª´ HR data - ƒë·∫£m b·∫£o trim
            type: (it.type || '').trim(),  // Lo·∫°i NV t·ª´ HR data
            team: (it.team || '').trim(),  // Team t·ª´ HR data - ƒë·∫£m b·∫£o trim
            cpqc,
            soDonChot: it.soDonChot, dsChot: it.dsChot,
            soDonHuy: it.soDonHuy, dsHuy: it.dsHuy,
            soDonSauHuy: Math.max(0, it.soDonChot - it.soDonHuy), dsSauHuy,
            soDonDi: it.soDonDi, dsDi: it.dsDi,
            soDonThuTien: it.soDonThuTien, dThuThanhCong: it.dThuThanhCong,
            ship: it.ship,
            dThuTinhKpi
          };
        });
      
      // S·∫Øp x·∫øp: Lu√¥n theo Team tr∆∞·ªõc, sau ƒë√≥ m·ªõi ƒë·∫øn t√™n
      rows.sort((a, b) => {
         const teamA = (a.team || '').trim();
         const teamB = (b.team || '').trim();
         if (teamA !== teamB) {
            // S·∫Øp x·∫øp theo Team (team r·ªóng s·∫Ω xu·ªëng cu·ªëi)
            if (teamA === '') return 1;
            if (teamB === '') return -1;
            return teamA.localeCompare(teamB, 'vi');
         }
         // C√πng Team -> s·∫Øp x·∫øp theo t√™n
         return (a.name || '').localeCompare(b.name || '', 'vi');
      });
      
      // C·∫≠p nh·∫≠t l·∫°i STT sau khi s·∫Øp x·∫øp
      rows = rows.map((row, idx) => ({ ...row, stt: idx + 1 }));
      
      console.log('‚úÖ Prepared', rows.length, 'rows for display (sorted by Team, then Name)');
      if (rows.length > 0) {
         console.log('üìå Sample row:', rows[0]);
      }

      currentData = rows;
      renderKpiSummary(rows, null);
      document.getElementById('statusText').textContent = `Hi·ªÉn th·ªã ${rows.length} nh√¢n vi√™n | ${filtered.length} ƒë∆°n h·ª£p l·ªá`;
    }

    function renderKpiSummary(dataList, allF3Total = null) {
      let total = { 
        cpqc: 0, 
        soDonChot: 0, dsChot: 0,
        soDonHuy: 0, dsHuy: 0,
        soDonSauHuy: 0, dsSauHuy: 0,
        soDonDi: 0, dsDi: 0,
        soDonThuTien: 0, dThuThanhCong: 0,
        ship: 0, dThuTinhKpi: 0
      };

      const bodyRowsHtml = dataList.map((s, i) => {
        Object.keys(total).forEach(key => total[key] += s[key] || 0);
        const tyLeThuTien = s.dsDi > 0 ? (s.dThuThanhCong / s.dsDi) : 0;
        const cpdt = s.dThuTinhKpi > 0 ? (s.cpqc / s.dThuTinhKpi) : 0;
        const staffName = (s.name || '').toString().trim() || 'N/A';
        const staffTeam = (s.team || '').toString().trim() || '';
        return `<tr data-team="${staffTeam}">
                <td class="text-center">${i + 1}</td>
                <td class="text-left">${staffTeam}</td>
                <td class="text-left">${staffName}</td>
                <td data-col-index="3">${formatCurrency(s.cpqc)}</td>
                <td data-col-index="4" class="text-center">${formatNumber(s.soDonChot)}</td>
                <td data-col-index="4">${formatCurrency(s.dsChot)}</td>
                <td data-col-index="5" class="text-center">${formatNumber(s.soDonHuy)}</td>
                <td data-col-index="5">${formatCurrency(s.dsHuy)}</td>
                <td data-col-index="6" class="text-center">${formatNumber(s.soDonSauHuy)}</td>
                <td data-col-index="6">${formatCurrency(s.dsSauHuy)}</td>
                <td data-col-index="7" class="text-center">${formatNumber(s.soDonDi)}</td>
                <td data-col-index="7">${formatCurrency(s.dsDi)}</td>
                <td data-col-index="12" class="text-center">${formatNumber(s.soDonThuTien)}</td>
                <td data-col-index="13">${formatCurrency(s.dThuThanhCong)}</td>
                <td data-col-index="14">${formatCurrency(s.ship)}</td>
                <td data-col-index="15">${formatCurrency(s.dThuTinhKpi)}</td>
                <td data-col-index="16">${formatPercent(tyLeThuTien)}</td>
                <td data-col-index="18">${formatPercent(cpdt)}</td>
            </tr>`;
      }).join('');

      // S·ª≠ d·ª•ng allF3Total n·∫øu c√≥ (t·ªïng T·∫§T C·∫¢ F3 records) thay v√¨ t·ªïng t·ª´ rows
      if (allF3Total) {
        total.soDonChot = allF3Total.soDonChot;
        total.dsChot = allF3Total.dsChot;
        total.soDonHuy = allF3Total.soDonHuy;
        total.dsHuy = allF3Total.dsHuy;
        total.soDonSauHuy = allF3Total.soDonSauHuy;
        total.dsSauHuy = allF3Total.dsSauHuy;
      }

      const totalTyLeThuTien = total.dsDi > 0 ? (total.dThuThanhCong / total.dsDi) : 0;
      const totalCpdt = total.dThuTinhKpi > 0 ? (total.cpqc / total.dThuTinhKpi) : 0;

      const totalRowHtml = `<tr class="total-row">
            <td class="total-label" colspan="3">T·ªîNG C·ªòNG</td>
            <td class="total-value" data-col-index="3">${formatCurrency(total.cpqc)}</td>
            <td class="total-value text-center" data-col-index="4">${formatNumber(total.soDonChot)}</td>
            <td class="total-value" data-col-index="4">${formatCurrency(total.dsChot)}</td>
            <td class="total-value text-center" data-col-index="5">${formatNumber(total.soDonHuy)}</td>
            <td class="total-value" data-col-index="5">${formatCurrency(total.dsHuy)}</td>
            <td class="total-value text-center" data-col-index="6">${formatNumber(total.soDonSauHuy)}</td>
            <td class="total-value" data-col-index="6">${formatCurrency(total.dsSauHuy)}</td>
            <td class="total-value text-center" data-col-index="7">${formatNumber(total.soDonDi)}</td>
            <td class="total-value" data-col-index="7">${formatCurrency(total.dsDi)}</td>
            <td class="total-value text-center" data-col-index="12">${formatNumber(total.soDonThuTien)}</td>
            <td class="total-value" data-col-index="13">${formatCurrency(total.dThuThanhCong)}</td>
            <td class="total-value" data-col-index="14">${formatCurrency(total.ship)}</td>
            <td class="total-value" data-col-index="15">${formatCurrency(total.dThuTinhKpi)}</td>
            <td class="total-value" data-col-index="16">${formatPercent(totalTyLeThuTien)}</td>
            <td class="total-value" data-col-index="18">${formatPercent(totalCpdt)}</td>
        </tr>`;

      document.getElementById('kpi-summary-body').innerHTML = totalRowHtml + bodyRowsHtml;
      document.getElementById('kpi-summary-foot').innerHTML = '';
      reapplyKpiColumnVisibility();
      applyTeamFilterVisibility();
    }
    
    function applyTeamFilterVisibility() {
      const selectedTeam = getSelectedDropdown('filterTeam');
      const table = document.getElementById('kpi-summary-table');
      if (!table) return;
      
      const rows = table.querySelectorAll('tbody tr[data-team]');
      const isAllSelected = selectedTeam.all || (selectedTeam.values.length === 0 && !selectedTeam.empty);
      
      rows.forEach(row => {
        const rowTeam = row.getAttribute('data-team') || '';
        if (isAllSelected) {
          // Hi·ªÉn th·ªã t·∫•t c·∫£ n·∫øu ch·ªçn "T·∫•t c·∫£"
          row.style.display = '';
        } else {
          // ·∫®n/hi·ªán d·ª±a tr√™n team ƒë∆∞·ª£c ch·ªçn
          const isEmpty = rowTeam === '';
          let shouldShow = false;
          
          if (selectedTeam.empty && isEmpty) {
            shouldShow = true;
          } else if (selectedTeam.values.length > 0 && selectedTeam.values.includes(rowTeam)) {
            shouldShow = true;
          }
          
          row.style.display = shouldShow ? '' : 'none';
        }
      });
    }

    function sortKpiTable(event) {
      const th = event.target.closest('th');
      if (!th) return;
      // determine a simple column mapping for sort
      const idx = th.cellIndex;
      const map = {
        0: r => r.stt,
        1: r => (r.team || ''),
        2: r => (r.name || ''),
        3: r => Number(r.cpqc)||0,
        4: r => Number(r.soDonChot)||0,
        5: r => Number(r.dsChot)||0,
        6: r => Number(r.soDonHuy)||0,
        7: r => Number(r.dsHuy)||0,
        8: r => Number(r.soDonSauHuy)||0,
        9: r => Number(r.dsSauHuy)||0,
        10: r => Number(r.soDonDi)||0,
        11: r => Number(r.dsDi)||0,
        12: r => Number(r.soDonThuTien)||0,
        13: r => Number(r.dThuThanhCong)||0,
        14: r => Number(r.ship)||0,
        15: r => Number(r.dThuTinhKpi)||0,
      };
      if (!map[idx]) return;
      if (sortState.column === idx) sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
      else { sortState.column = idx; sortState.direction = 'asc'; }
      const dir = sortState.direction === 'asc' ? 1 : -1;
      const getter = map[idx];
      const arr = [...currentData].sort((a,b)=>{
        const av = getter(a), bv = getter(b);
        if (typeof av === 'string' || typeof bv === 'string') return String(av).localeCompare(String(bv)) * dir;
        return (Number(av)-Number(bv)) * dir;
      }).map((r,i)=>({ ...r, stt: i+1 }));
      currentData = arr;
      renderKpiSummary(arr);
    }

    function toggleKpiColumn(event) {
      const checkbox = event.target;
      const colIndex = checkbox.getAttribute('data-col');
      const table = document.getElementById('kpi-summary-table');
      const headerCells = table.querySelectorAll(`thead [data-col-index="${colIndex}"]`);
      const bodyCells = table.querySelectorAll(`tbody [data-col-index="${colIndex}"]`);
      const footCells = table.querySelectorAll(`tfoot [data-col-index="${colIndex}"]`);
      const displayValue = checkbox.checked ? '' : 'none';
      headerCells.forEach(cell => cell.style.display = displayValue);
      bodyCells.forEach(cell => cell.style.display = displayValue);
      footCells.forEach(cell => cell.style.display = displayValue);
    }
    function reapplyKpiColumnVisibility() {
      document.querySelectorAll('.toggle-column').forEach(checkbox => {
        if (!checkbox.checked) {
          const colIndex = checkbox.getAttribute('data-col');
          const table = document.getElementById('kpi-summary-table');
          const cells = table.querySelectorAll(`[data-col-index="${colIndex}"]`);
          cells.forEach(cell => { cell.style.display = 'none'; });
        }
      });
    }

    function exportCSV() {
      if (!currentData.length) return;
      const header = ['STT','T√™n NV Marketing','S·ªë ƒë∆°n','T·ªïng ti·ªÅn ship (VNƒê)','Trung b√¨nh/ƒë∆°n (VNƒê)','Min ship','Max ship'];
      const lines = [header.join(',')];
      currentData.forEach((r, i) => {
        lines.push([
          i+1,
          '"' + r.name.replaceAll('"','""') + '"',
          r.orders,
          Math.round(r.totalShip),
          Math.round(r.avgShip),
          Math.round(r.minShip),
          Math.round(r.maxShip)
        ].join(','));
      });
      const csv = lines.join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'thongke_tienship_marketing.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function toggleLoading(on) {
      document.getElementById('loading').style.display = on ? 'inline' : 'none';
    }
    
    function clearFiltersToShowAll() {
      const s = document.getElementById('startDate');
      const e = document.getElementById('endDate');
      if (s) s.value = '';
      if (e) e.value = '';
      const includeZeroEl2 = document.getElementById('includeZeroShip');
      if (includeZeroEl2) includeZeroEl2.checked = true;
      // Reset dropdown filters to 'T·∫•t c·∫£'
      ['filterProduct', 'filterBranch', 'filterTeam', 'filterMarket', 'filterName', 'filterStaffType'].forEach(id => setDropdownAll(id));
      updateRangeBadge();
      applyFiltersAndRender();
    }

    // ================= RAW F3 VIEW =================
    function detectRawColumns(rows) {
      const preferred = ['Ng√†y l√™n ƒë∆°n','Nh√¢n vi√™n Marketing','Team','Khu v·ª±c','M·∫∑t h√†ng','T·ªïng ti·ªÅn VNƒê','Ph√≠ ship','K·∫øt qu·∫£ Check','M√£ Tracking','Ti·ªÅn Vi·ªát ƒë√£ ƒë·ªëi so√°t'];
      const set = new Set();
      rows.forEach(r => { if (r && typeof r === 'object') Object.keys(r).forEach(k => set.add(k)); });
      const all = Array.from(set);
      const ordered = preferred.filter(k => set.has(k));
      const rest = all.filter(k => !ordered.includes(k)).sort((a,b)=>a.localeCompare(b));
      return [...ordered, ...rest];
    }

    function initRawView() {
      rawColumns = detectRawColumns(rawOrders);
      renderRawHead();
      applyRawFiltersAndRender();
    }

    function renderRawHead() {
      const head = document.getElementById('rawHead');
      if (!head) return;
      const tr = document.createElement('tr');
      tr.innerHTML = rawColumns.map(c => `<th data-key="${c}">${c} <span class="sort-caret">‚áÖ</span></th>`).join('');
      head.innerHTML = '';
      head.appendChild(tr);
    }

    function applyRawFiltersAndRender() {
      const caRaw = (document.getElementById('rawFilterCa') && document.getElementById('rawFilterCa').value) ? document.getElementById('rawFilterCa').value.trim() : '';
      const dept = (document.getElementById('rawDept') && document.getElementById('rawDept').value) ? document.getElementById('rawDept').value.trim() : '';
      const rawName = (document.getElementById('rawName') && document.getElementById('rawName').value) ? document.getElementById('rawName').value.trim() : '';
      const rawCheck = (document.getElementById('rawCheck') && document.getElementById('rawCheck').value) ? document.getElementById('rawCheck').value.trim() : '';
      const rawDelivery = (document.getElementById('rawDelivery') && document.getElementById('rawDelivery').value) ? document.getElementById('rawDelivery').value.trim() : '';
      rawFiltered = rawOrders.filter(r => {
        if (allowedNames && allowedNames.size > 0) {
          const nm = (r && r['Nh√¢n vi√™n Marketing'] ? String(r['Nh√¢n vi√™n Marketing']).trim() : '');
          if (!allowedNames.has(nm)) return false;
        }
        if (caRaw) {
          const cas = String(r['Ca'] || '').split(',').map(x => x.trim()).filter(Boolean);
          if (!cas.includes(caRaw)) return false;
        }
        // Filter by department & name
        if (dept) {
          const field = getDeptField(dept);
          const deptName = field ? String(r[field] || '').trim() : '';
          if (!deptName) return false;
          if (rawName && deptName !== rawName) return false;
        } else if (rawName) {
          const names = [
            String(r['Nh√¢n vi√™n Marketing'] || '').trim(),
            String(r['Nh√¢n vi√™n Sale'] || '').trim(),
            String(r['NV V·∫≠n ƒë∆°n'] || '').trim()
          ];
          if (!names.includes(rawName)) return false;
        }
        // Filter by K·∫øt qu·∫£ Check
        if (rawCheck) {
          const kc = String(r['K·∫øt qu·∫£ Check'] || '').trim();
          if (kc !== rawCheck) return false;
        }
        // Filter by Tr·∫°ng th√°i giao h√†ng NB
        if (rawDelivery) {
          const st = String(r['Tr·∫°ng th√°i giao h√†ng NB'] || '').trim();
          if (st !== rawDelivery) return false;
        }
        if (!rawSearchText) return true;
        for (const k of rawColumns) {
          const v = r[k];
          if (v !== undefined && v !== null && String(v).toLowerCase().includes(rawSearchText)) return true;
        }
        return false;
      });
      rawPage = 1;
      applyRawSortingAndRender();
    }

    function applyRawSortingAndRender() {
      if (rawSort.key) {
        const key = rawSort.key;
        const dir = rawSort.dir === 'asc' ? 1 : -1;
        rawFiltered.sort((a,b) => {
          const av = a[key];
          const bv = b[key];
          const na = (av === '' || av === null || av === undefined) ? NaN : Number(String(av).replace(/\./g,'').replace(/,/g,''));
          const nb = (bv === '' || bv === null || bv === undefined) ? NaN : Number(String(bv).replace(/\./g,'').replace(/,/g,''));
          const bothNum = !isNaN(na) && !isNaN(nb);
          if (bothNum) return (na - nb) * dir;
          const sa = (av === undefined || av === null) ? '' : String(av);
          const sb = (bv === undefined || bv === null) ? '' : String(bv);
          return sa.localeCompare(sb) * dir;
        });
      }
      renderRawBody();
    }

    function renderRawBody() {
      const body = document.getElementById('rawBody');
      const info = document.getElementById('rawPageInfo');
      const status = document.getElementById('rawStatus');
      const summaryTop = document.getElementById('rawSummaryTop');
      if (!body) return;
      const total = rawFiltered.length;
      const pages = Math.max(1, Math.ceil(total / rawPageSize));
      if (rawPage > pages) rawPage = pages;
      const start = (rawPage - 1) * rawPageSize;
      const end = Math.min(total, start + rawPageSize);
      const rows = rawFiltered.slice(start, end);

      const frag = document.createDocumentFragment();
      rows.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = rawColumns.map(c => {
          let value = r[c];
          // Format "Ng√†y l√™n ƒë∆°n" column as date
          if (c === 'Ng√†y l√™n ƒë∆°n' && value !== undefined && value !== null) {
            value = formatDate(value);
          } else if (value === undefined || value === null) {
            value = '';
          }
          return `<td class="${typeof r[c] === 'number' ? '' : 'text-left'}">${value}</td>`;
        }).join('');
        frag.appendChild(tr);
      });
      body.innerHTML = '';
      body.appendChild(frag);
      if (info) info.textContent = `Trang ${rawPage}/${pages}`;
      let totalTongTien = 0;
      let totalDoiSoat = 0;
      rawFiltered.forEach(r => {
        totalTongTien += parseNumber(r['T·ªïng ti·ªÅn VNƒê']);
        totalDoiSoat += parseNumber(r['Ti·ªÅn Vi·ªát ƒë√£ ƒë·ªëi so√°t']);
      });
      const summaryText = `S·ªë ƒë∆°n: ${total.toLocaleString('vi-VN')} | T·ªïng ti·ªÅn VNƒê: ${formatCurrency(totalTongTien)} | T·ªïng ti·ªÅn ƒë√£ ƒë·ªëi so√°t: ${formatCurrency(totalDoiSoat)}`;
      if (summaryTop) summaryTop.textContent = summaryText;
      if (status) status.textContent = `Hi·ªÉn th·ªã ${rows.length} / ${total} d√≤ng`;
    }

    function exportRawCSV() {
      if (!rawFiltered.length) return;
      const header = rawColumns.map(h => '"' + String(h).replaceAll('"','""') + '"').join(',');
      const lines = [header];
      rawFiltered.forEach(r => {
        const row = rawColumns.map(k => {
          const v = r[k];
          if (v === null || v === undefined) return '';
          const s = String(v).replaceAll('"','""');
          return '"' + s + '"';
        }).join(',');
        lines.push(row);
      });
      const csv = lines.join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'F3.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function exportKpiToExcel() {
      if (!currentData || currentData.length === 0) {
        alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t Excel!');
        return;
      }

      // L·∫•y th√¥ng tin b·ªô l·ªçc hi·ªán t·∫°i
      const startDate = document.getElementById('startDate')?.value || '';
      const endDate = document.getElementById('endDate')?.value || '';
      const selectedName = getSelectedDropdown('filterName');
      const selectedTeam = getSelectedDropdown('filterTeam');
      const selectedStaffType = getSelectedDropdown('filterStaffType');
      
      // T·∫°o th√¥ng tin b·ªô l·ªçc ƒë·ªÉ hi·ªÉn th·ªã
      let filterInfo = [];
      if (startDate && endDate) {
        const start = new Date(startDate);
        const end = new Date(endDate);
        const startStr = `${String(start.getDate()).padStart(2, '0')}/${String(start.getMonth() + 1).padStart(2, '0')}/${start.getFullYear()}`;
        const endStr = `${String(end.getDate()).padStart(2, '0')}/${String(end.getMonth() + 1).padStart(2, '0')}/${end.getFullYear()}`;
        filterInfo.push(`Kho·∫£ng th·ªùi gian: ${startStr} - ${endStr}`);
      }
      if (!selectedName.all && selectedName.values.length > 0) {
        const nameList = selectedName.values.length <= 3 
          ? selectedName.values.join(', ') 
          : `${selectedName.values.slice(0, 3).join(', ')}... (+${selectedName.values.length - 3} nh√¢n vi√™n)`;
        filterInfo.push(`Nh√¢n vi√™n: ${nameList}`);
      }
      if (!selectedTeam.all && selectedTeam.values.length > 0) {
        filterInfo.push(`Team: ${selectedTeam.values.join(', ')}`);
      }
      if (!selectedStaffType.all && selectedStaffType.values.length > 0) {
        filterInfo.push(`Lo·∫°i NV: ${selectedStaffType.values.join(', ')}`);
      }

      // T√≠nh t·ªïng c√°c gi√° tr·ªã
      let total = { 
        cpqc: 0, 
        soDonChot: 0, dsChot: 0,
        soDonHuy: 0, dsHuy: 0,
        soDonSauHuy: 0, dsSauHuy: 0,
        soDonDi: 0, dsDi: 0,
        soDonThuTien: 0, dThuThanhCong: 0,
        ship: 0, dThuTinhKpi: 0
      };

      currentData.forEach(s => {
        Object.keys(total).forEach(key => total[key] += s[key] || 0);
      });

      const totalTyLeThuTien = total.dsDi > 0 ? (total.dThuThanhCong / total.dsDi) : 0;
      const totalCpdt = total.dThuTinhKpi > 0 ? (total.cpqc / total.dThuTinhKpi) : 0;

      // Chu·∫©n b·ªã d·ªØ li·ªáu Excel
      const excelData = [];
      
      // Th√™m th√¥ng tin b·ªô l·ªçc v√†o ƒë·∫ßu file
      if (filterInfo.length > 0) {
        excelData.push(['B·ªò L·ªåC √ÅP D·ª§NG:']);
        filterInfo.forEach(info => {
          excelData.push([info]);
        });
        excelData.push([]); // D√≤ng tr·ªëng
      }

      // Header row 1
      excelData.push([
        'STT',
        'Team',
        'Nh√¢n vi√™n',
        'CPQC',
        'S·ªë ƒë∆°n v√† DS ch·ªët',
        '',
        'S·ªë ƒë∆°n v√† DS h·ªßy',
        '',
        'S·ªë ƒë∆°n v√† DS sau h·ªßy',
        '',
        'S·ªë ƒë∆°n v√† DS ƒëi',
        '',
        'S·ªë ƒë∆°n v√† DThu th√†nh c√¥ng',
        '',
        'Ship',
        'DThu t√≠nh KPI',
        'T·ª∑ l·ªá thu ti·ªÅn',
        '%CP/DT'
      ]);

      // Header row 2
      excelData.push([
        '',
        '',
        '',
        '',
        'S·ªë ƒë∆°n',
        'DS ch·ªët',
        'S·ªë ƒë∆°n',
        'DS h·ªßy',
        'S·ªë ƒë∆°n',
        'DS sau h·ªßy',
        'S·ªë ƒë∆°n',
        'DS ƒëi',
        'S·ªë ƒë∆°n',
        'DThu TC',
        '',
        '',
        '',
        ''
      ]);

      // Data rows
      currentData.forEach((s, i) => {
        const tyLeThuTien = s.dsDi > 0 ? (s.dThuThanhCong / s.dsDi) : 0;
        const cpdt = s.dThuTinhKpi > 0 ? (s.cpqc / s.dThuTinhKpi) : 0;
        const staffName = (s.name || '').toString().trim() || 'N/A';
        const staffTeam = (s.team || '').toString().trim() || '';

        excelData.push([
          i + 1,
          staffTeam,
          staffName,
          s.cpqc || 0,
          s.soDonChot || 0,
          s.dsChot || 0,
          s.soDonHuy || 0,
          s.dsHuy || 0,
          s.soDonSauHuy || 0,
          s.dsSauHuy || 0,
          s.soDonDi || 0,
          s.dsDi || 0,
          s.soDonThuTien || 0,
          s.dThuThanhCong || 0,
          s.ship || 0,
          s.dThuTinhKpi || 0,
          tyLeThuTien,
          cpdt
        ]);
      });

      // Total row
      excelData.push([
        '',
        '',
        'T·ªîNG C·ªòNG',
        total.cpqc || 0,
        total.soDonChot || 0,
        total.dsChot || 0,
        total.soDonHuy || 0,
        total.dsHuy || 0,
        total.soDonSauHuy || 0,
        total.dsSauHuy || 0,
        total.soDonDi || 0,
        total.dsDi || 0,
        total.soDonThuTien || 0,
        total.dThuThanhCong || 0,
        total.ship || 0,
        total.dThuTinhKpi || 0,
        totalTyLeThuTien,
        totalCpdt
      ]);

      // T·∫°o workbook v√† worksheet
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(excelData);

      // Set ƒë·ªô r·ªông c·ªôt
      ws['!cols'] = [
        { wch: 6 },   // STT
        { wch: 15 },  // Team
        { wch: 25 },  // Nh√¢n vi√™n
        { wch: 12 },  // CPQC
        { wch: 10 },  // S·ªë ƒë∆°n ch·ªët
        { wch: 15 },  // DS ch·ªët
        { wch: 10 },  // S·ªë ƒë∆°n h·ªßy
        { wch: 15 },  // DS h·ªßy
        { wch: 10 },  // S·ªë ƒë∆°n sau h·ªßy
        { wch: 15 },  // DS sau h·ªßy
        { wch: 10 },  // S·ªë ƒë∆°n ƒëi
        { wch: 15 },  // DS ƒëi
        { wch: 10 },  // S·ªë ƒë∆°n thu ti·ªÅn
        { wch: 15 },  // DThu TC
        { wch: 12 },  // Ship
        { wch: 15 },  // DThu t√≠nh KPI
        { wch: 12 },  // T·ª∑ l·ªá thu ti·ªÅn
        { wch: 10 }   // %CP/DT
      ];

      // Merge header cells for row 1 (t√≠nh offset d·ª±a tr√™n s·ªë d√≤ng th√¥ng tin b·ªô l·ªçc)
      const filterRows = filterInfo.length > 0 ? filterInfo.length + 2 : 0; // +2 cho d√≤ng ti√™u ƒë·ªÅ v√† d√≤ng tr·ªëng
      const headerRow1 = filterRows; // D√≤ng header ƒë·∫ßu ti√™n
      const headerRow2 = filterRows + 1; // D√≤ng header th·ª© hai
      
      if (!ws['!merges']) ws['!merges'] = [];
      ws['!merges'].push(
        { s: { r: headerRow1, c: 4 }, e: { r: headerRow1, c: 5 } }, // S·ªë ƒë∆°n v√† DS ch·ªët
        { s: { r: headerRow1, c: 6 }, e: { r: headerRow1, c: 7 } }, // S·ªë ƒë∆°n v√† DS h·ªßy
        { s: { r: headerRow1, c: 8 }, e: { r: headerRow1, c: 9 } }, // S·ªë ƒë∆°n v√† DS sau h·ªßy
        { s: { r: headerRow1, c: 10 }, e: { r: headerRow1, c: 11 } }, // S·ªë ƒë∆°n v√† DS ƒëi
        { s: { r: headerRow1, c: 12 }, e: { r: headerRow1, c: 13 } }  // S·ªë ƒë∆°n v√† DThu th√†nh c√¥ng
      );

      XLSX.utils.book_append_sheet(wb, ws, 'Bao_cao_KPI');

      // T·∫°o t√™n file v·ªõi th√¥ng tin b·ªô l·ªçc
      const now = new Date();
      const dateStr = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}`;
      
      let fileName = 'Bao_cao_KPI_CEO';
      
      // Th√™m th√¥ng tin th√°ng v√†o t√™n file n·∫øu c√≥
      if (startDate && endDate) {
        const start = new Date(startDate);
        const end = new Date(endDate);
        // N·∫øu c√πng th√°ng, th√™m th√°ng v√†o t√™n file
        if (start.getMonth() === end.getMonth() && start.getFullYear() === end.getFullYear()) {
          const month = String(start.getMonth() + 1).padStart(2, '0');
          const year = start.getFullYear();
          fileName += `_Thang${month}_${year}`;
        } else {
          // N·∫øu kh√°c th√°ng, th√™m kho·∫£ng th·ªùi gian
          const startStr = `${String(start.getMonth() + 1).padStart(2, '0')}${String(start.getDate()).padStart(2, '0')}`;
          const endStr = `${String(end.getMonth() + 1).padStart(2, '0')}${String(end.getDate()).padStart(2, '0')}`;
          fileName += `_${startStr}_${endStr}`;
        }
      }
      
      // Th√™m t√™n nh√¢n vi√™n n·∫øu ch·ªâ ch·ªçn 1 nh√¢n vi√™n
      if (!selectedName.all && selectedName.values.length === 1) {
        const name = selectedName.values[0].replace(/[^a-zA-Z0-9]/g, '_').substring(0, 20);
        fileName += `_${name}`;
      }
      
      fileName += `_${dateStr}.xlsx`;

      // Xu·∫•t file
      XLSX.writeFile(wb, fileName);
      
      alert(`ƒê√£ t·∫£i xu·ªëng ${currentData.length} nh√¢n vi√™n th√†nh c√¥ng!\nFile: ${fileName}`);
    }

    // ===== Helpers used by KPI-like table =====
    function formatCurrency(v) { return Number(v || 0).toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }); }
    function formatNumber(v) { return Number(v || 0).toLocaleString('vi-VN'); }
    function formatPercent(v) {
      if (!isFinite(v)) return '0.00%';
      return `${(Number(v || 0) * 100).toFixed(2)}%`;
    }
    function formatDate(v) {
      if (!v) return '';
      const d = toDate(v);
      if (!d || isNaN(d)) return String(v);
      const day = String(d.getDate()).padStart(2, '0');
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const year = d.getFullYear();
      return `${day}/${month}/${year}`;
    }
  </script>
</body>
</html>



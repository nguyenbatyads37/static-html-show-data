<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phiếu Nghiệm Thu Vật Tư</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-size: 70%;
        }
        .a4-container {
            width: 210mm;
            height: 297mm;
            margin: 20px auto;
            padding: 20px;
            background-color: white;
        }
        .bold-text {
            font-weight: bold;
        }
        .signs {
            font-weight: bold;
            text-align: center;
        }
        .min-height-48 {
            min-height: 48px;
        }
        .my-img {
            width: 100%;
            max-width: 145px;
            height: 150px;
        }
        @media print {
            body {
                margin: 0;
                padding: 0;
                background-color: white;
            }
            .a4-container {
                margin: 0 auto;
                width: 210mm;
                height: 297mm;
            }
        }
        .all-center {
            text-align: center;
            vertical-align: middle;
        }
        .table-border {
            border: 2px solid black;
            border-collapse: collapse;
        }
        .table-border th, .table-border td {
            border: 2px solid black;
            padding: 8px;
            text-align: center;
        }
        .table {
            width: 100%;
            max-width: 100%;
        }

        .table td {
            overflow-wrap: break-word;
            word-wrap: break-word;
            word-break: break-word;
        }
        .header-padding-top {
            padding-top: 10px;
        }
        .btn-print {
            margin-bottom: 20px;
        }
        .table-border th {
            background-color: #f2f2f2;
        }

        .table-border tr:nth-child(even) {
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
    <div class="a4-container">
        <button onclick="window.print()" class="btn btn-primary btn-print">In Phiếu</button>
        <div class="text-center mb-2">
            <div class="row">
                <div class="col-6">
                    <h6 class="bold-text">TẬP ĐOÀN ĐIỆN LỰC VIỆT NAM</h6>
                    <h6 class="bold-text">CÔNG TY TNHH MTV NHIỆT ĐIỆN THỦ ĐỨC</h6>
                </div>
                <div class="col-2"></div>
                <div class="col-4">
                    <p>HD-NĐTĐ-04-09/BM-05 <br>Lần ban hành : 02</p>
                </div>
            </div>
            <div class="row">
                <h6 class="fw-bold header-padding-top">PHIẾU NGHIỆM THU VẬT TƯ VÀ ĐỀ NGHỊ NHẬP KHO</h6>
            </div>
        </div>
        
        <table class="table table-border">
            <tbody>
                <tr>
                    <td class="bold-text" style="width: 20%;">Ngày xuất hóa đơn</td>
                    <td id="nxhd" style="width: 30%;">26/12/2024</td>
                    <td class="bold-text" style="width: 20%;">Ngày Nghiệm thu</td>
                    <td id="nnt" style="width: 30%;">26/12/2024</td>
                </tr>
                <tr>
                    <td class="bold-text">Hóa đơn số</td>
                    <td id="hds">31</td>
                    <td class="bold-text">Số phiếu nhập kho</td>
                    <td id="spnk">393-NK-12/2024</td>
                </tr>
                <tr>
                    <td class="bold-text">Đơn vị cung cấp</td>
                    <td id="dvcc">Hải Dương</td>
                    <td class="bold-text">Số phiếu trình giá</td>
                    <td id="sptg">443-MH-12/2024</td>
                </tr>
                <tr>
                    <td class="bold-text">Hình thức thanh toán</td>
                    <td>Tiền mặt/chuyển khoản</td>
                    <td class="bold-text">Nhập kho (theo ERP)</td>
                    <td id="nk"></td>
                </tr>
            </tbody>
        </table>

        <h6 class="fw-bold">Danh mục hàng hóa:</h6>
        <table class="table table-border">
            <thead class="text-center">
                <tr>
                    <th scope="col" class="all-center" style="width: 5%;">STT</th>
                    <th scope="col" class="all-center" style="width: 30%;">TÊN VẬT TƯ</th>
                    <th scope="col" class="all-center" style="width: 20%;">MÃ SỐ VẬT TƯ</th>
                    <th scope="col" class="all-center" style="width: 10%;">ĐVT</th>
                    <th scope="col" class="all-center" style="width: 12%;">SỐ LƯỢNG</th>
                    <th scope="col" class="all-center" style="width: 10%;">VAT</th>
                    <th scope="col" class="all-center" style="width: 13%;">THÀNH TIỀN</th>
                </tr>
            </thead>
            <tbody id="dmhh">
                <!-- Các hàng sản phẩm sẽ được thêm vào đây thông qua JavaScript -->
            </tbody>
            <tfoot>
                <tr class="total-row">
                    <td colspan="6" class="text-end">Tổng cộng:</td>
                    <td class="text-end" id="totalAmount"></td>
                </tr>
            </tfoot>
        </table>

        <div class="row mt-22">
            <div class="col">
                <h6 class="bold-text">Chất lượng:</h6>
                <table class="table table-border">
                    <tbody>
                        <tr>
                            <th style="width: 30%;">Tổng mục vật tư</th>
                            <th style="width: 35%;">Số lượng vật tư</th>
                            <th style="width: 35%;">Chất lượng vật tư</th>
                        </tr>
                        <tr>
                            <td id="tmvt"></td>
                            <td>Đầy đủ theo hóa đơn</td>
                            <td>Đạt yêu cầu</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="mt-2">
            <p><strong>Lý do nghiệm thu:</strong> Nhập phục vụ SXKD</p>
        </div>

        <div class="row text-center mt-1">
            <div class="col-4">
                <div class="row">
                    <div class="col-12 bold-text min-height-48">Thủ kho</div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <img src="" class="my-img img-fluid" id="chuky1" alt="Chữ ký Thủ kho"/>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 bold-text" id="tenchuky1">Ngô Văn Ngọc Đức</div>
                </div>
            </div>
            <div class="col-4">
                <div class="row">
                    <div class="col-12 bold-text min-height-48">Kế toán vật tư</div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <img src="" class="my-img img-fluid" id="chuky2" alt="Chữ ký Kế toán vật tư"/>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 bold-text" id="tenchuky2">Huỳnh Nguyễn Trúc Vy</div>
                </div>
            </div>
            <div class="col-4">
                <div class="row">
                    <div class="col-12 bold-text min-height-48">Trưởng ban kiểm nghiệm <br>Chủ tịch Hội đồng</div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <img src="" class="my-img img-fluid" id="chuky3" alt="Chữ ký Trưởng ban kiểm nghiệm"/>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 bold-text" id="tenchuky3">Toi la ai3</div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Hàm để lấy giá trị tham số từ URL
        function getParam(param) {
            return urlParams.get(param) || 'N/A';
        }

        // Hàm để làm sạch dữ liệu đầu vào và ngăn ngừa XSS
        function sanitizeHTML(str) {
            var temp = document.createElement('div');
            temp.textContent = str;
            return temp.innerHTML;
        }

        const urlParams = new URLSearchParams(window.location.search);

        // Populate các trường thông tin cơ bản
        const fields = ['nxhd', 'hds', 'dvcc', 'nnt', 'spnk', 'sptg', 'nk'];
        fields.forEach(field => {
            const element = document.getElementById(field);
            if (element) {
                element.innerHTML = sanitizeHTML(getParam(field));
            }
        });

        // Populate Danh mục hàng hóa và tính tổng thành tiền
        const dmhh = urlParams.get('dmhh');
        let totalAmount = 0; // Khởi tạo biến tổng

        if (dmhh) {
            const splitedDmhh = dmhh.split('_b_');
            if (splitedDmhh && splitedDmhh.length > 0) {
                let theContent = "";
                let index = 1;
                for(let hh of splitedDmhh) {
                    const splitedHh = hh.split('_a_');
                    if(splitedHh.length === 6) { // Đảm bảo có đủ 6 trường
                        const name = sanitizeHTML(splitedHh[0]);
                        const code = sanitizeHTML(splitedHh[1]);
                        const unit = sanitizeHTML(splitedHh[2]);
                        const quantity = sanitizeHTML(splitedHh[3]);
                        const vat = sanitizeHTML(splitedHh[4]);
                        const amountStr = sanitizeHTML(splitedHh[5]);

                        // Chuyển đổi chuỗi thành tiền thành số, loại bỏ dấu phẩy
                        const amount = parseFloat(amountStr.replace(/,/g, '')) || 0;
                        totalAmount += amount; // Cộng vào tổng

                        theContent += '<tr>' +
                            '<td>' + index + '</td>' +
                            '<td>' + name + '</td>' +
                            '<td>' + code + '</td>' +
                            '<td>' + unit + '</td>' +
                            '<td>' + quantity + '</td>' +
                            '<td>' + vat + '</td>' +
                            '<td>' + amountStr + '</td>' +
                        '</tr>';
                        index++;
                    } else {
                        console.warn('Dữ liệu hàng hóa không hợp lệ:', hh);
                    }
                }

                document.getElementById('dmhh').insertAdjacentHTML("beforeend", theContent);
                document.getElementById('tmvt').innerHTML = index - 1;
                document.getElementById('totalAmount').innerHTML = totalAmount.toLocaleString('en-US');
            }
        }

        // Populate chữ ký
        ['chuky1', 'chuky2', 'chuky3'].forEach((chuky, index) => {
            const img = document.getElementById(chuky);
            cons

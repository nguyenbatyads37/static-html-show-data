<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIẤY ĐỀ NGHỊ XUẤT KHO VẬT TƯ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-size: 12.5px;
            line-height: 1.1;
            font-weight: 500;
            position: relative;
        }

        .a4-container {
            /* border: 1px solid black; */
            width: 210mm;
            height: 297mm;
            margin: 20px auto;
            padding: 56.7px;
            background-color: white;
        }

        .bold-text {
            font-weight: bold;
        }

        .signs {
            font-weight: bold;
            text-align: center;
        }

        .min-height-48 {
            min-height: 29px;
        }

        .my-img {
            width: auto;
            max-width: 145px;
            height: auto;
            max-height: 150px;
        }

        .img-wrapper {
            height: 150px;
            display: flex;
            /* Enables Flexbox */
            justify-content: center;
            /* Centers content horizontally */
            align-items: center;
            /* Centers content vertically */
        }

        .saveButtonWraper {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #saveAsPdfButton, #printButton {
            padding: 12px 24px;
            /* Add spacing inside the button */
            font-size: 18px;
            /* Slightly larger font for better readability */
            font-weight: bold;
            /* Make the text bold */
            color: #fff;
            /* White text */
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            /* Gradient background */
            border: none;
            /* Remove default border */
            border-radius: 8px;
            /* Rounded corners */
            cursor: pointer;
            /* Pointer cursor on hover */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            /* Subtle shadow for a 3D effect */
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            /* Smooth hover effect */
            margin-top: 20px;
        }

        /* Hover effect */
        #saveAsPdfButton:hover, #printButton:hover {
            transform: translateY(-2px);
            /* Slight lift on hover */
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
            /* Deeper shadow on hover */
        }

        /* Active state */
        #saveAsPdfButton:active, #printButton:active {
            transform: translateY(0);
            /* Reset lift on click */
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            /* Lighter shadow on click */
        }

        #printButton {
            margin-left: 50px;
            background: linear-gradient(135deg, #ff09de, #3a0315);
        }
        .saveAsPdfButtonWrapper {
            display: none;
        }

        @media print {
            body {
                margin: 0;
                padding: 0;
                background-color: white;
            }

            .a4-container {
                margin: 0 auto;
                width: 210mm;
                height: 297mm;
                padding: 56.7px;
            }
        }

        .all-center {
            text-align: center;
            vertical-align: middle;
        }

        .table-border {
            border-collapse: collapse;
        }

        .saveAsPdfButtonWrapper {
            width: 100% !important;
            max-width: 100% !important;
        }

        .padding-10 {
            padding: 10px;
        }

        .text-right {
            text-align: right;
        }

        .table {
            width: 100%;
            /* Table fits within the wrapper */
            max-width: 100%;
        }

        .table td {
            overflow-wrap: break-word;
            /* Handle long words gracefully */
            word-wrap: break-word;
            /* Legacy support for word wrapping */
            word-break: break-word;
            /* Force breaking long words */
        }
    </style>
    <style>
        /* Centered loading spinner styles */
        #loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        #loading span {
            font-size: 18px;
            font-weight: bold;
            margin-left: 10px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #ccc;
            border-top: 5px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .font-size-13 {
            font-size: 13px !important;
        }

        .font-size-14 {
            font-size: 14px !important;
        }

        .font-size-14-smaller {
            font-size: calc(14px * 0.9) !important;
            font-weight: 400;
        }

        .font-size-15 {
            font-size: 15px !important;
        }

        .font-size-16 {
            font-size: 16px !important;
        }

        .font-size-17 {
            font-size: 17px !important;
        }

        .font-size-18 {
            font-size: 18px !important;
        }

        .font-size-12 {
            font-size: 12px !important;
        }

        .padding-top-12 {
            padding-top: 12px;
        }
        table td, table th {
            border-right: 1px solid black;
            border-bottom: 1px solid black;
        }

        .bordered-top {
            border-top: 1px solid black;
        }

        .bordered-left {
            border-left: 1px solid black;
        }
    </style>
</head>

<body>
    <div class="a4-container">
        <div class="text-center mb-2">
            <div class="row">
                <div class="col-6">
                    <h6 class="bold-text font-size-14">CÔNG TY TNHH MTV NHIỆT ĐIỆN THỦ ĐỨC </br><span id="bophan">Phân
                            xưởng vận hành</span></h6>

                </div>
                <div class="col-2"></div>
                <div class="col-4" style="padding-top: 30px;">
                    <p class="bold-text font-size-14">Số: <span id="so">456-ĐSDĐSD</span></p>
                </div>
            </div>
            <div class="row">
                <div class="bold-text font-size-17">GIẤY ĐỀ NGHỊ XUẤT KHO VẬT TƯ</div>
                <div class="col-12 text-center" style="padding-top: 5px;"><i>Tại kho: Công ty TNHH MTV Nhiệt điện Thủ
                        Đức</i></div>
                <div class="col-12 text-center" style="padding-top: 5px;">Kính gửi: <span class="bold-text">Ông GIÁM ĐỐC
                        CÔNG TY NHIỆT ĐIỆN THỦ
                        ĐỨC</span></div>
            </div>
        </div>
        <div class="row">
            <div class="col-12 mb-2">
                <div class="row">
                    <div class="col-12">Họ và tên người lãnh vật tư:
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span
                            id="nlvt" class="bold-text"></span></div>
                </div>
                <!-- Họ và tên người lãnh vật tư: <span class="bold-text" id="nlvt">Trương Minh Triết</span> -->
            </div>
            <div class="col-12 mb-2">
                <div class="row">
                    <div class="col-12">Lý do sử dụng:
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span
                            id="ldsd" class="bold-text"></span></div>
                </div>
                <!-- Lý do sử dụng: <span id="">Logsheet dùng cho các vị trí vận hành năm 2025</span> -->
            </div>
            <div class="col-12 mb-2">
                Đề nghị cho lãnh số vật tư dưới đây:
            </div>
        </div>

        <table class="table table-border">
            <thead class="text-center">
                <tr>
                    <th class="all-center bordered-top bordered-left" style="width: 5%">STT</th>
                    <th class="all-center bordered-top" style="width: 25%">Tên vật tư</th>
                    <th class="all-center bordered-top" style="width: 15%">Mã số vật tư</th>
                    <th class="all-center bordered-top" style="width: 7%">ĐVT</th>
                    <th class="all-center bordered-top" style="width: 10%">Số lượng</th>
                    <th class="all-center bordered-top" style="width: 16%">Ghi chú</th>
                    <th class="all-center bordered-top" style="width: 27%">Quy cách vật tư</th>
                </tr>
            </thead>
            <tbody id="vattu">
                <!-- <tr>
                    <td>1</td>
                    <td>Vật tư phụ (Ty, cùm) đỡ ống thoát nước</td>
                    <td>5.65.90.222.VIE.00.000</td>
                    <td>Gói</td>
                    <td>1</td>
                    <td>10%</td>
                    <td>605,000</td>
                </tr>
                <tr>
                    <td>2</td>
                    <td>Thay bảo ôn cách nhiệt và quấn simili ống nước 021</td>
                    <td>4.88.36.201.VIE.00.000</td>
                    <td>Mét</td>
                    <td>50</td>
                    <td>10%</td>
                    <td>2,475,000</td>
                </tr>
                <tr>
                    <td>3</td>
                    <td>Thay bảo ôn cách nhiệt và quấn simili ống nước 034</td>
                    <td>4.88.36.200.VIE.00.000</td>
                    <td>Mét</td>
                    <td>42</td>
                    <td>10%</td>
                    <td>4,158,000</td>
                </tr> -->
            </tbody>
        </table>

        <div class="text-right">
            <p class="text-right">TP. HCM Ngày <span id="ngayhomnay">32</span> tháng <span id="thanghomnay">12</span>
                năm <span id="namhomnay">2024</span></p>
        </div>

        <div class="row text-center mt-4 font-size-14">
            <div class="col-4">
                <div class="row">
                    <div class="col-12 bold-text min-height-48">PHỤ TRÁCH BỘ PHẬN SỬ DỤNG</div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <div class="img-wrapper">
                            <img src="" class="my-img" id="chuky1" />
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 bold-text" id="tenchuky1">Đỗ Thanh Tuyền</div>
                </div>
            </div>
            <div class="col-4">
            </div>
            <div class="col-4">
                <div class="row">
                    <div class="col-12 bold-text min-height-48">P. THỦ TRƯỞNG ĐƠN VỊ DUYỆT</div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <div class="img-wrapper">
                            <img src="" class="my-img" id="chuky3" />
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 bold-text" id="tenchuky3">Đỗ Thanh Tuyền</div>
                </div>
            </div>
        </div>

        <div class="row text-center mt-4 font-size-14">
            <div class="col-4">
            </div>
            <div class="col-4">
                <div class="row">
                    <div class="col-12 bold-text min-height-48">NGƯỜI ĐỀ NGHỊ</div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <div class="img-wrapper">
                            <img src="" class="my-img" id="chuky2" />
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 bold-text" id="tenchuky2">Đỗ Thanh Tuyền</div>
                </div>
            </div>
            <div class="col-4">
            </div>
        </div>
    </div>
    <div class="container saveAsPdfButtonWrapper" id="saveAsPdfButtonWrapper">
        <div class="row">
            <div class="col-12 saveButtonWraper">
                <button id="saveAsPdfButton">Lưu PDF</button>
                <button id="printButton" onclick="window.print();">In phiếu</button>
            </div>
        </div>
    </div>
    <div id="loading">
        <div class="spinner"></div>
        <span id="loading-msg">Đang tạo PDF, vui lòng chờ...</span>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);

        document.getElementById('bophan').innerHTML = urlParams.get('bophan');
        document.getElementById('so').innerHTML = urlParams.get('so');
        document.getElementById('nlvt').innerHTML = urlParams.get('nlvt');
        document.getElementById('ldsd').innerHTML = urlParams.get('ldsd');
        document.getElementById('ngayhomnay').innerHTML = urlParams.get('ngayhomnay');
        document.getElementById('thanghomnay').innerHTML = urlParams.get('thanghomnay');
        document.getElementById('namhomnay').innerHTML = urlParams.get('namhomnay');

        const vattu = urlParams.get('vattu');

        let index = 0;
        let theContent = "";
        if (vattu) {
            const vattuSplited = vattu.split('_b_');
            if (vattuSplited && vattuSplited.length > 0) {
                index = 1;
                for (let vt of vattuSplited) {
                    const splitedVt = vt.split('_a_');
                    theContent += '<tr>' +
                        '<td class="text-center bordered-left">' + index + '</td>' +
                        '<td>' + splitedVt[0] + '</td>' +
                        '<td class="text-center">' + splitedVt[1] + '</td>' +
                        '<td class="text-center">' + splitedVt[2] + '</td>' +
                        '<td class="text-center">' + splitedVt[3] + '</td>' +
                        '<td>' + splitedVt[4] + '</td>' +
                        '<td>' + splitedVt[5] + '</td>'
                    '</tr>';
                    index++;
                }
            }
        }

        document.getElementById('vattu').insertAdjacentHTML("beforeend", theContent);

        document.getElementById('chuky1').src = urlParams.get('chuky1');
        document.getElementById('chuky2').src = urlParams.get('chuky2');
        document.getElementById('chuky3').src = urlParams.get('chuky3');

        document.getElementById('tenchuky1').innerHTML = urlParams.get('tenchuky1');
        document.getElementById('tenchuky2').innerHTML = urlParams.get('tenchuky2');
        document.getElementById('tenchuky3').innerHTML = urlParams.get('tenchuky3');

        //file:///Users/BenNguyen/Documents/static-html-show-data/bill-1-3.html?bophan=Phân Xưởng Vận Hành&so=21-2323&nlvt=Dương Minh Triết&ldsd=Logsheet dùng cho dăm ba cái&ngayhomnay=31&thanghomnay=12&namhomnay=2024&vattu=Bảng ghi thông số băng giá(1/2)~22-DSV~tờ~600~Theo mẫu~Kèm theo mẫu:Bảng ghi thông số băng giá(1/2)~22-DSV~tờ~600~Theo mẫu~Kèm theo mẫu
    </script>
    <script src="./html2canvas.min.js"></script>
    <script src="./jspdf.umd.min.js"></script>

    <script>
        async function convertImageToBase64AndSetToImg(img, imgUrl) {
            const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(imgUrl)}`;
            await fetch(proxyUrl)
                .then(response => response.json())
                .then(data => {
                    img.src = data.contents;
                })
                .catch(error => console.error('Error fetching image:', error));
        };

        // const fetchImgs = async (callBack) => {
        //     document.getElementById("loading").style.display = "flex";
        //     const imgs = document.getElementsByTagName('img');
        //     for (let i = 0; i < imgs.length; i++) {
        //         const theImg = imgs[i];
        //         if (theImg.src && theImg.src != "")
        //             await convertImageToBase64AndSetToImg(theImg, theImg.src);
        //     }
        //     callBack();
        //     document.getElementById("loading").style.display = "none";
        // }


        // const downloadPdfAndClosePage = (name) => {
        //     const { jsPDF } = window.jspdf;

        //     const element = document.querySelector('.a4-container');
        //     // Capture the current page
        //     html2canvas(element, { scale: 4 }).then((canvas) => {
        //         const imgData = canvas.toDataURL('image/png');
        //         const pdf = new jsPDF('p', 'mm', 'a4');
        //         const scale = 0;
        //         let pageWidth = pdf.internal.pageSize.getWidth();
        //         pageWidth = pageWidth + pageWidth * scale;
        //         let pageHeight = pdf.internal.pageSize.getHeight();
        //         pageHeight = pageHeight + pageHeight * scale;

        //         // Ensure content fits within the PDF page dimensions
        //         const imgWidth = canvas.width;
        //         const imgHeight = canvas.height;
        //         const ratio = imgWidth / imgHeight;

        //         const pdfWidth = pageWidth; // Fit to PDF page width
        //         const pdfHeight = pageWidth / ratio; // Adjust height proportionally

        //         pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        //         pdf.save(name);
        //     });
        // };

        // const checkAndDownloadPDF = () => {
        //     downloadPdfAndClosePage(exportPdfFileName);
        // }
        // const exportPdfFileName = urlParams.get('tenPdf');
        // if (exportPdfFileName) {
        //     fetchImgs(checkAndDownloadPDF);
        // }
        const loading = document.getElementById("loading");
        const loadingMsg = document.getElementById("loading-msg");
        const showLoading = (msg) => {
            loading.style.display = "flex";
            loadingMsg.innerHTML = msg;
        }
        const closeLoading = () => {
            loading.style.display = "none";
        }
    </script>
    <script>
        const exportPdfWrapper = document.getElementById('saveAsPdfButtonWrapper');
        const exportPdfFileName = urlParams.get('tenPdf');
        if (exportPdfFileName) {
            exportPdfWrapper.style.display = "block";
            exportPdfWrapper.style.position = "absolute";
            // Select the container div
            const container = document.querySelector('.a4-container');

            // Calculate the total height of child content
            let totalContentHeight = 133;
            Array.from(container.children).forEach(child => {
                totalContentHeight += child.offsetHeight;
            });
            exportPdfWrapper.style.top = totalContentHeight + "px";
        } else {
            exportPdfWrapper.style.display = "none";
        }

        window.addEventListener('beforeprint', () => {
            exportPdfWrapper.style.display = "none";
        });

        window.addEventListener('afterprint', () => {
            exportPdfWrapper.style.display = "block";
        });

        async function loadImage(url) {
            const response = await fetch(url);
            const blob = await response.blob();
            const image = new Image();
            image.src = URL.createObjectURL(blob);
            return new Promise((resolve) => {
                image.onload = () => resolve(image);
            });
        }

        document.getElementById('saveAsPdfButton').addEventListener('click', async () => {
            showLoading("Đang tạo PDF, vui lòng chờ...");
            try {

                // Use File System Access API to show "Save As" dialog
                const handle = await window.showSaveFilePicker({
                    suggestedName: 'page.pdf',
                    types: [
                        {
                            description: 'PDF file',
                            accept: { 'application/pdf': ['.pdf'] },
                        },
                    ],
                });

                const { jsPDF } = window.jspdf;

                const element = document.querySelector('.a4-container');
                // Capture the current page
                html2canvas(element, {
                    scale: 4
                }).then(async (canvas) => {
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const scale = 0;
                    let pageWidth = pdf.internal.pageSize.getWidth();
                    pageWidth = pageWidth + pageWidth * scale;
                    let pageHeight = pdf.internal.pageSize.getHeight();
                    pageHeight = pageHeight + pageHeight * scale;

                    // Ensure content fits within the PDF page dimensions
                    const imgWidth = canvas.width;
                    const imgHeight = canvas.height;
                    const ratio = imgWidth / imgHeight;

                    const pdfWidth = pageWidth; // Fit to PDF page width
                    const pdfHeight = pageWidth / ratio; // Adjust height proportionally

                    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                    const pdfBlob = pdf.output('blob');
                    // Write the PDF Blob to the selected file
                    const writableStream = await handle.createWritable();
                    await writableStream.write(pdfBlob);
                    await writableStream.close();

                    console.log('PDF saved successfully');
                    closeLoading();
                    alert("Tải file thành công.");
                });
            } catch (error) {
                console.error('Error saving PDF:', error);
                closeLoading();
                alert("Tải file thất bại!");
            }
        });
    </script>
</body>

</html>
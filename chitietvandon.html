<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>Chi tiết Vận đơn</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- CÀI ĐẶT CHUNG --- */
        :root {
            --primary-color: #2d7c2d;
            --primary-light: #4CAF50;
            --primary-dark: #1b4b1b;
            --text-dark: #333;
            --text-medium: #555;
            --bg-light: #f4f4f4;
            --border-color: #e0e0e0;
            --font-main: 'Roboto', Arial, sans-serif;
        }

        body {
            font-family: var(--font-main);
            padding: 20px;
            background-color: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
        }

        /* --- TABS --- */

        .tab-btn {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 18px;
            font-weight: 500;
            color: var(--text-medium);
            position: relative;
        }
        
        .tab-btn.active {
            color: var(--primary-dark);
            position: relative;
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -3px; /* Đặt dưới border của container */
            left: 0;
            width: 100%;
            height: 3px;
            background-color: var(--primary-dark);
        }

        .tab-content {
            display: none;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-top: none;
            animation: fadeIn 0.5s;
            background-color: #fff;
            border-radius: 0 0 8px 8px;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- STYLES CHO BỘ LỌC VÀ ĐIỀU KHIỂN --- */
        .controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            align-items: center;
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            flex-wrap: wrap;
            gap: 15px;
        }

        .controls .left-controls,
        .controls .right-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .controls .date-filter {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .controls button:not(.tab-btn) {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            color: white;
            background-color: #27ae60;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            cursor: pointer;
        }

        .controls button:not(.tab-btn):hover {
            background-color: #229954;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .clear-filter-btn {
            background-color: #f39c12 !important;
        }

        .clear-filter-btn:hover {
            background-color: #e67e22 !important;
        }

        .controls input[type="date"],
        .controls input[type="text"],
        .controls select {
            padding: 10px 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
            background-color: white;
        }

        .multi-select-container {
            position: relative;
            display: inline-block;
        }

        .multi-select-container button {
            background-color: white;
            color: #333;
            border: 1px solid #ccc;
            font-size: 16px;
            padding: 10px 15px;
            text-align: left;
            width: 250px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .checkbox-dropdown {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 250px;
            box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
            z-index: 101;
            border: 1px solid #ddd;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
        }

        .checkbox-dropdown.show {
            display: block;
        }

        .checkbox-dropdown label {
            display: flex;       
            align-items: center; 
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.2s;
            white-space: nowrap;
            color: var(--text-dark);
        }

        .checkbox-dropdown label:hover {
            background-color: #f1f1f1;
        }
        
        .checkbox-dropdown label input {
            margin-right: 10px;
        }

        /* --- STYLES CỤ THỂ CHO TAB CHI TIẾT --- */
        #DonChiTiet h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .table-wrapper {
            position: relative;
            overflow: auto;
            max-height: 75vh;
            background: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }

        #DonChiTiet table {
            border-collapse: collapse;
            width: 100%;
            min-width: 1800px;
            font-size: 11px;
            font-weight: bold;
        }

        #DonChiTiet th,
        #DonChiTiet td {
            border: 1px solid #e0e0e0;
            padding: 6px 10px;
            white-space: nowrap;
            background-color: white;
            text-align: left !important;
        }

        #DonChiTiet th {
            background-color: #2c3e50;
            color: white;
            font-weight: 500;
            vertical-align: middle;
            position: sticky;
            z-index: 20;
            text-align: center !important;
        }
        
        #DonChiTiet th.header-title {
            top: 0; /* Tiêu đề dính ở trên cùng */
        }
        
        #DonChiTiet tr.filter-row {
            position: sticky;
            top: 30px; /* Dính ngay dưới hàng tiêu đề */
            z-index: 21; /* Phải cao hơn z-index của tiêu đề */
        }
        
        #DonChiTiet thead .filter-row th {
            padding: 5px;
            background-color: #e8f5e9; /* Màu nền nhạt cho hàng lọc */
            vertical-align: top;
        }

        #DonChiTiet thead .filter-row input,
        #DonChiTiet thead .filter-row .multi-select-container button {
            width: 100%;
            padding: 6px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 11px; /* Cỡ chữ nhỏ hơn cho ô lọc */
        }

        /* CSS cho dropdown bộ lọc trong cột gọn gàng hơn */
        #DonChiTiet .filter-row .checkbox-dropdown {
            min-width: max-content;
            width: auto;
            padding: 5px;
        }

        #DonChiTiet .filter-row .checkbox-dropdown label {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 2px 6px;
            font-size: 11px;
            line-height: 1.4;
            white-space: nowrap;
        }

        #DonChiTiet .filter-row .checkbox-dropdown input[type="checkbox"] {
            margin: 0;
            width: 14px;
            height: 14px;
        }

        .no-data {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            font-style: italic;
            font-size: 16px;
        }

        /* --- Thanh tóm tắt --- */
        #DonChiTiet .summary-bar {
            background-color: #e8f5e9;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-top: 20px;
            border-left: 5px solid var(--primary-color);
        }

        #DonChiTiet .summary-item {
            text-align: center;
        }

        #DonChiTiet .summary-item .label {
            font-size: 16px;
            color: var(--text-medium);
        }
        #DonChiTiet .summary-item .value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-dark);
        }

        #DonChiTiet .region-container {
            margin-top: 25px;
        }

        #DonChiTiet .region-header {
            font-size: 22px;
            color: var(--primary-dark);
            margin-bottom: 10px;
            border-bottom: 2px solid var(--primary-light);
            padding-bottom: 5px;
        }

        /* --- SCROLLBAR & LOADING --- */
        ::-webkit-scrollbar {
            height: 12px;
            width: 12px;
        }
        ::-webkit-scrollbar-thumb {
            border-radius: 5px;
            background-color: #27ae60;
            border: 2px solid #f5f5f5;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.6; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }

        #loading-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: all 0.3s ease;
            visibility: hidden;
            opacity: 0;
            backdrop-filter: blur(4px);
        }

        #loading-overlay.visible {
            visibility: visible;
            opacity: 1;
        }

        .loading-content {
            text-align: center;
        }

        .loading-logo {
            max-width: 200px;
            width: 40vw;
            height: auto;
            animation: pulse 2s infinite ease-in-out;
        }

        .loading-text {
            margin-top: 20px;
            font-size: 1.3em;
            font-weight: 500;
            color: var(--primary-color);
        }
    </style>
</head>

<body>

    <!-- Chỉ báo đang tải -->
    <div id="loading-overlay">
        <div class="loading-content">
            <div class="loading-text">Đang tải dữ liệu...</div>
        </div>
    </div>

    <!-- Nội dung của Tab 2 -->
    <div id="DonChiTiet" class="tab-content active">
        <div class="controls">
            <div class="left-controls">
                 <div class="multi-select-container">
                    <button id="detailTeamFilterBtn">Tất cả Team</button>
                    <div id="detailTeamDropdown" class="checkbox-dropdown"></div>
                </div>
                 <div class="multi-select-container">
                    <button id="detailStaffFilterBtn">Tất cả NV</button>
                    <div id="detailStaffDropdown" class="checkbox-dropdown"></div>
                </div>
                <div class="multi-select-container">
                    <button id="detailProductFilterBtn">Tất cả Sản phẩm</button>
                    <div id="detailProductDropdown" class="checkbox-dropdown"></div>
                </div>
                <div class="multi-select-container">
                    <button id="detailMarketFilterBtn">Tất cả Khu vực</button>
                    <div id="detailMarketDropdown" class="checkbox-dropdown"></div>
                </div>
                <div class="multi-select-container">
                    <button id="detailCheckResultFilterBtn">Tất cả Kết quả check</button>
                    <div id="detailCheckResultDropdown" class="checkbox-dropdown"></div>
                </div>
                <div class="multi-select-container">
                    <button id="detailDeliveryStatusFilterBtn">Tất cả Trạng thái giao hàng</button>
                    <div id="detailDeliveryStatusDropdown" class="checkbox-dropdown"></div>
                </div>
                <div class="multi-select-container">
                    <button id="detailPaymentStatusFilterBtn">Tất cả Trạng thái thu tiền</button>
                    <div id="detailPaymentStatusDropdown" class="checkbox-dropdown"></div>
                </div>
            </div>
            <div class="right-controls">
                <div class="date-filter">
                    <span>Từ:</span><input type="date" id="detailStartDateFilter" />
                    <span>Đến:</span><input type="date" id="detailEndDateFilter" />
                </div>
                <input type="text" id="detailNameFilter" placeholder="Tìm theo Tên, SĐT, Mã đơn..." />
                <button id="detailClearFilters" class="clear-filter-btn">Xóa lọc</button>
            </div>
        </div>

        <div class="summary-bar">
            <div class="summary-item">
                <div class="label">Tổng số đơn</div>
                <div class="value" id="totalOrdersCount">0</div>
            </div>
            <div class="summary-item">
                <div class="label">Tổng thành tiền</div>
                <div class="value" id="totalOrdersAmount">0 ₫</div>
            </div>
        </div>

        <!-- Các bảng chi tiết sẽ được render động vào đây -->
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CÁC HÀM TIỆN ÍCH ---
            const loader = document.getElementById('loading-overlay');
            const showLoader = () => loader.classList.add('visible');
            const hideLoader = () => loader.classList.remove('visible');
            let globalData = []; // Lưu trữ toàn bộ dữ liệu

            function parseDateString(dateString) {
                if (!dateString) return null;
                const str = String(dateString).trim();
                if (str.includes('-') || str.includes('T')) {
                    const d = new Date(str);
                    if (!isNaN(d.getTime())) return d;
                }
                const parts = str.match(/^(\d{1,2})[/\-](\d{1,2})[/\-](\d{4})/);
                if (parts) {
                    const d = new Date(Date.UTC(parseInt(parts[3], 10), parseInt(parts[2], 10) - 1, parseInt(parts[1], 10)));
                    if (!isNaN(d.getTime())) return d;
                }
                if (/^\d+(\.\d+)?$/.test(str)) {
                    const d = new Date(Date.UTC(0, 0, parseFloat(str) - 1));
                    if (!isNaN(d.getTime())) return d;
                }
                return null;
            }

            function formatDateDisplay(dateObj) {
                if (!dateObj || isNaN(dateObj.getTime())) return '';
                const day = String(dateObj.getUTCDate()).padStart(2, '0');
                const month = String(dateObj.getUTCMonth() + 1).padStart(2, '0');
                const year = dateObj.getUTCFullYear();
                return `${day}/${month}/${year}`;
            }

            function formatDateForInputLocal(date) {
                if (!date) return '';
                return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            }
            
            // --- XỬ LÝ DỮ LIỆU CHÍNH ---
            function handleData(response) {
                hideLoader();
                if (response.error || !Array.isArray(response.rows)) {
                    detailApp.showError('DonChiTiet', 'Lỗi hoặc không có dữ liệu: ' + (response.error || 'Định dạng dữ liệu không đúng'));
                    return;
                }
                globalData = response.rows;
                detailApp.populateFilters();
                detailApp.applyFilters();
            }

            function loadData() {
                showLoader();
                detailApp.showError('DonChiTiet', 'Đang tải dữ liệu...');

                const apiUrl = 'https://n-api-rouge.vercel.app/sheet/getAll';

                fetch(apiUrl)
                    .then(response => response.json())
                    .then(data => {
                        // console.log("Dữ liệu tải về:", data);
                        handleData(data);
                    })
                    .catch(error => {
                        console.error('Lỗi khi tải dữ liệu:', error);
                        const errorMsg = 'Tải dữ liệu thất bại. Vui lòng kiểm tra kết nối mạng và thử lại.';
                        detailApp.showError('DonChiTiet', errorMsg);
                        hideLoader();
                    });
            }

            // ===================================================================
            // =========== MODULE CHO CHI TIẾT VẬN ĐƠN (TAB 2) ================
            // ===================================================================
            const detailApp = {
                init: function () {
                    this.setupControls();
                },
                showError: function (tableId, message) {
                    const container = document.getElementById(tableId);
                    if (!container) return;
                    const summaryBar = container.querySelector('.summary-bar');
                    if (!summaryBar) return;
                    
                    // Xóa các bảng cũ
                    container.querySelectorAll('.region-container').forEach(c => c.remove());

                    // Hiển thị thông báo
                    const errorContainer = document.createElement('div');
                    errorContainer.className = 'region-container';
                    errorContainer.innerHTML = `<div class="no-data" style="margin-top:20px;">${message}</div>`;
                    summaryBar.parentNode.insertBefore(errorContainer, summaryBar.nextSibling);
                },
                populateFilters: function () {
                    const changeCallback = () => this.applyFilters();
                    const checkResults = [...new Set(globalData.map(r => r["Kết quả Check"]).filter(Boolean))].sort();
                    const deliveryStatuses = [...new Set(globalData.map(r => r["Trạng thái giao hàng NB"]).filter(Boolean))].sort();
                    const paymentStatuses = [...new Set(globalData.map(r => r["Trạng thái thu tiền"]).filter(Boolean))].sort();
                    const allStaff = [...new Set(globalData.map(r => r["NV Vận đơn"] || r["NV_Vận_đơn"]).filter(Boolean))].sort();
                    const allProducts = [...new Set(globalData.map(r => r["Mặt hàng"]).filter(Boolean))].sort();
                    const allMarkets = [...new Set(globalData.map(r => r["Khu vực"] || r["khu vực"]).filter(Boolean))].sort();
                    const allTeams = [...new Set(globalData.map(r => r["Team"]).filter(Boolean))].sort();

                    this.populateMultiSelect('detailCheckResultDropdown', 'detailCheckResultSelectAll', checkResults, () => { this.updateFilterButtonText('detailCheckResultFilterBtn', 'detailCheckResultDropdown', 'detailCheckResultSelectAll', 'Kết quả check'); changeCallback(); });
                    this.populateMultiSelect('detailDeliveryStatusDropdown', 'detailDeliveryStatusSelectAll', deliveryStatuses, () => { this.updateFilterButtonText('detailDeliveryStatusFilterBtn', 'detailDeliveryStatusDropdown', 'detailDeliveryStatusSelectAll', 'Trạng thái GH'); changeCallback(); });
                    this.populateMultiSelect('detailPaymentStatusDropdown', 'detailPaymentStatusSelectAll', paymentStatuses, () => { this.updateFilterButtonText('detailPaymentStatusFilterBtn', 'detailPaymentStatusDropdown', 'detailPaymentStatusSelectAll', 'Trạng thái TT'); changeCallback(); });
                    this.populateMultiSelect('detailStaffDropdown', 'detailStaffSelectAll', allStaff, () => { this.updateFilterButtonText('detailStaffFilterBtn', 'detailStaffDropdown', 'detailStaffSelectAll', 'NV'); changeCallback(); });
                    this.populateMultiSelect('detailProductDropdown', 'detailProductSelectAll', allProducts, () => { this.updateFilterButtonText('detailProductFilterBtn', 'detailProductDropdown', 'detailProductSelectAll', 'Sản phẩm'); changeCallback(); });
                    this.populateMultiSelect('detailMarketDropdown', 'detailMarketSelectAll', allMarkets, () => { this.updateFilterButtonText('detailMarketFilterBtn', 'detailMarketDropdown', 'detailMarketSelectAll', 'Khu vực'); changeCallback(); });
                    this.populateMultiSelect('detailTeamDropdown', 'detailTeamSelectAll', allTeams, () => { this.updateFilterButtonText('detailTeamFilterBtn', 'detailTeamDropdown', 'detailTeamSelectAll', 'Team'); changeCallback(); });
                },
                populateMultiSelect: function(dropdownId, selectAllId, items, changeCallback) {
                    const dropdown = document.getElementById(dropdownId);
                    if (!dropdown) return;

                    dropdown.innerHTML = '';
                    const allLabel = document.createElement('label');
                    allLabel.innerHTML = `<input type="checkbox" id="${selectAllId}"> <b>Chọn tất cả</b>`;
                    dropdown.appendChild(allLabel);

                    items.forEach(item => {
                        const label = document.createElement('label');
                        const encodedItem = item.replace(/"/g, '&quot;');
                        label.innerHTML = `<input type="checkbox" value="${encodedItem}"> ${item}`;
                        label.querySelector('input').addEventListener('change', changeCallback);
                        dropdown.appendChild(label);
                    });

                    document.getElementById(selectAllId)?.addEventListener('change', (e) => {
                        dropdown.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = e.target.checked);
                        changeCallback();
                    });
                },
                updateFilterButtonText: function (btnId, dropdownId, selectAllId, defaultTextPrefix) {
                    const btn = document.getElementById(btnId);
                    const dropdown = document.getElementById(dropdownId);
                    if (!btn || !dropdown) return;
                    const selectedCount = dropdown.querySelectorAll(`input:checked:not(#${selectAllId})`).length;
                    const totalCount = dropdown.querySelectorAll(`input[type="checkbox"]:not(#${selectAllId})`).length;

                    if (selectedCount === 0 || selectedCount === totalCount) btn.textContent = `Tất cả ${defaultTextPrefix}`;
                    else if (selectedCount === 1) btn.textContent = dropdown.querySelector(`input:checked:not(#${selectAllId})`).value;
                    else btn.textContent = `${selectedCount} ${defaultTextPrefix} đã chọn`;
                },
                setupControls: function () {
                    const apply = this.applyFilters.bind(this);
                    
                    document.getElementById('detailStartDateFilter')?.addEventListener('change', apply);
                    document.getElementById('detailEndDateFilter')?.addEventListener('change', apply);
                    document.getElementById('detailNameFilter')?.addEventListener('input', apply);

                    this.setupMultiSelectDropdown('detailStaffFilterBtn', 'detailStaffDropdown');
                    this.setupMultiSelectDropdown('detailProductFilterBtn', 'detailProductDropdown');
                    this.setupMultiSelectDropdown('detailMarketFilterBtn', 'detailMarketDropdown');
                    this.setupMultiSelectDropdown('detailTeamFilterBtn', 'detailTeamDropdown');
                    this.setupMultiSelectDropdown('detailCheckResultFilterBtn', 'detailCheckResultDropdown');
                    this.setupMultiSelectDropdown('detailDeliveryStatusFilterBtn', 'detailDeliveryStatusDropdown');
                    this.setupMultiSelectDropdown('detailPaymentStatusFilterBtn', 'detailPaymentStatusDropdown');

                    document.getElementById('detailClearFilters')?.addEventListener('click', () => {
                        document.getElementById('detailStartDateFilter').value = '';
                        document.getElementById('detailEndDateFilter').value = '';
                        document.getElementById('detailNameFilter').value = '';
                        
                        document.querySelectorAll('#DonChiTiet .filter-row .column-filter').forEach(element => {
                            if (element.tagName === 'INPUT') element.value = '';
                            else if (element.classList.contains('multi-select-container')) {
                                const dropdown = element.querySelector('.checkbox-dropdown');
                                const button = element.querySelector('button');
                                if (dropdown && button) {
                                    dropdown.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                                    this.updateColumnMultiSelectButtonText(button, dropdown);
                                }
                            }
                        });
                        
                        const filterConfigs = [
                           { type: 'Team', prefix: 'Team' }, { type: 'Staff', prefix: 'NV' },
                           { type: 'Product', prefix: 'Sản phẩm' }, { type: 'Market', prefix: 'Khu vực' },
                           { type: 'CheckResult', prefix: 'Kết quả check' }, { type: 'DeliveryStatus', prefix: 'Trạng thái GH' },
                           { type: 'PaymentStatus', prefix: 'Trạng thái TT' }
                        ];

                        filterConfigs.forEach(config => {
                            const dropdown = document.getElementById(`detail${config.type}Dropdown`);
                            if (dropdown) {
                                dropdown.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                                this.updateFilterButtonText(`detail${config.type}FilterBtn`, `detail${config.type}Dropdown`, `detail${config.type}SelectAll`, config.prefix);
                            }
                        });
                        this.applyFilters();
                    });

                    window.addEventListener('click', () => {
                        document.querySelectorAll('#DonChiTiet .checkbox-dropdown.show').forEach(d => d.classList.remove('show'));
                    });
                },
                setupMultiSelectDropdown: function (btnId, dropdownId) {
                    const btn = document.getElementById(btnId);
                    const dropdown = document.getElementById(dropdownId);
                    if (btn && dropdown) {
                        btn.addEventListener('click', (e) => { e.stopPropagation(); dropdown.classList.toggle('show'); });
                        dropdown.addEventListener('click', e => e.stopPropagation());
                        window.addEventListener('click', (e) => {
                            if (!btn.contains(e.target) && !dropdown.contains(e.target)) {
                                dropdown.classList.remove('show');
                            }
                        });
                    }
                },
                applyFilters: function () {
                    let filteredData = [...globalData];
                    
                    const getSelected = (id, allId) => Array.from(document.querySelectorAll(`#${id} input:checked:not(#${allId})`)).map(cb => cb.value);

                    const selectedCheckResults = getSelected('detailCheckResultDropdown', 'detailCheckResultSelectAll');
                    const selectedDeliveryStatuses = getSelected('detailDeliveryStatusDropdown', 'detailDeliveryStatusSelectAll');
                    const selectedPaymentStatuses = getSelected('detailPaymentStatusDropdown', 'detailPaymentStatusSelectAll');
                    const startDate = document.getElementById('detailStartDateFilter').value;
                    const endDate = document.getElementById('detailEndDateFilter').value;
                    const nameQuery = document.getElementById('detailNameFilter').value.toLowerCase().trim();
                    const selectedStaff = getSelected('detailStaffDropdown', 'detailStaffSelectAll');
                    const selectedProducts = getSelected('detailProductDropdown', 'detailProductSelectAll');
                    const selectedMarkets = getSelected('detailMarketDropdown', 'detailMarketSelectAll');
                    const selectedTeams = getSelected('detailTeamDropdown', 'detailTeamSelectAll');

                    if (selectedStaff.length > 0) filteredData = filteredData.filter(row => selectedStaff.includes(row["NV Vận đơn"] || row["NV_Vận_đơn"] || ''));
                    if (selectedProducts.length > 0) filteredData = filteredData.filter(row => selectedProducts.includes(row["Mặt hàng"] || ''));
                    if (selectedMarkets.length > 0) filteredData = filteredData.filter(row => selectedMarkets.includes(row["Khu vực"] || row["khu vực"] || ''));
                    if (selectedTeams.length > 0) filteredData = filteredData.filter(row => selectedTeams.includes(row["Team"] || ''));
                    if (selectedCheckResults.length > 0) filteredData = filteredData.filter(r => selectedCheckResults.includes(r["Kết quả Check"] || ''));
                    if (selectedDeliveryStatuses.length > 0) filteredData = filteredData.filter(r => selectedDeliveryStatuses.includes(r["Trạng thái giao hàng NB"] || ''));
                    if (selectedPaymentStatuses.length > 0) filteredData = filteredData.filter(r => selectedPaymentStatuses.includes(r["Trạng thái thu tiền"] || ''));

                    if (startDate || endDate) {
                        const start = startDate ? new Date(startDate) : null;
                        const end = endDate ? new Date(endDate) : null;
                        if (start) start.setHours(0, 0, 0, 0);
                        if (end) end.setHours(23, 59, 59, 999);
                        filteredData = filteredData.filter(row => {
                            const orderDate = parseDateString(row["Ngày lên đơn"]);
                            return orderDate && (!start || orderDate >= start) && (!end || orderDate <= end);
                        });
                    }
                    if (nameQuery) {
                        filteredData = filteredData.filter(r =>
                            (r["Thông tin khách hàng"] || '').toLowerCase().includes(nameQuery) ||
                            (r["Phone*"] || '').toString().toLowerCase().includes(nameQuery) ||
                            (r["Mã đơn hàng"] || '').toLowerCase().includes(nameQuery) ||
                            (r["Mã Tracking"] || '').toLowerCase().includes(nameQuery)
                        );
                    }
                    
                    const columnFilters = {};
                    document.querySelectorAll('#DonChiTiet .filter-row .column-filter').forEach(element => {
                        const column = element.dataset.column;
                        if (element.tagName === 'INPUT') {
                            const value = element.value.trim();
                            if (value) columnFilters[column] = { type: element.type === 'date' ? 'date' : 'text', value: value.toLowerCase() };
                        } else if (element.classList.contains('multi-select-container')) {
                            const selected = Array.from(element.querySelectorAll('input[type="checkbox"]:checked:not(.select-all)')).map(cb => cb.value);
                            if (selected.length > 0) columnFilters[column] = { type: 'multiselect', value: new Set(selected) };
                        }
                    });

                    if (Object.keys(columnFilters).length > 0) {
                        filteredData = filteredData.filter(row => {
                            return Object.entries(columnFilters).every(([column, filter]) => {
                                const colMap = { "Nhân sự Marketing": "Nhân viên Marketing", "Nhân sự Sale": "Nhân viên Sale" };
                                let cellValue = row[colMap[column] || column] || '';
                                if (filter.type === 'multiselect') return filter.value.has(String(cellValue));
                                if (filter.type === 'date') {
                                    const dateObject = parseDateString(cellValue);
                                    return dateObject ? formatDateForInputLocal(dateObject) === filter.value : false;
                                }
                                return String(cellValue).toLowerCase().includes(filter.value);
                            });
                        });
                    }

                    this.updateSummaryBar(filteredData);
                    this.renderTables(filteredData);
                },
                updateSummaryBar(data) {
                    const totalCount = data.length;
                    const totalAmount = data.reduce((sum, row) => sum + (parseFloat(String(row["Tổng tiền VNĐ"] || 0).replace(/[^\d.-]/g, '')) || 0), 0);
                    document.getElementById('totalOrdersCount').textContent = totalCount.toLocaleString('vi-VN');
                    document.getElementById('totalOrdersAmount').textContent = new Intl.NumberFormat('vi-VN').format(totalAmount) + ' ₫';
                },
                renderTables: function (data) {
                    const container = document.getElementById('DonChiTiet');
                    container.querySelectorAll('.region-container').forEach(c => c.remove()); // Luôn xóa bảng cũ
                    
                    if (data.length === 0) {
                        this.showError('DonChiTiet', 'Không có dữ liệu khớp với bộ lọc.');
                        return;
                    }

                    const teams = [...new Set(data.map(r => r["Team"]).filter(Boolean))].sort();
                    if (data.some(r => !r["Team"])) teams.push("Chưa phân Team"); // Thêm nhóm mặc định nếu có dữ liệu không team

                    const headers = ["Mã đơn hàng", "Mã Tracking", "Ngày lên đơn", "Thông tin khách hàng", "Phone*", "Mặt hàng", "Số lượng mặt hàng 1", "Tổng tiền VNĐ", "Nhân sự Marketing", "Nhân sự Sale", "NV Vận đơn", "Đơn vị vận chuyển", "Trạng thái giao hàng NB", "Kết quả Check", "Trạng thái thu tiền"];
                    
                    teams.forEach(teamName => {
                        const teamData = data.filter(r => (teamName === "Chưa phân Team") ? !r["Team"] : r["Team"] === teamName);
                        if (teamData.length === 0) return;

                        const teamContainer = document.createElement('div');
                        teamContainer.className = 'region-container';
                        const tableId = `table-team-${teamName.replace(/\s+/g, '-').toLowerCase()}`;
                        teamContainer.innerHTML = `
                            <h3 class="region-header">Team: ${teamName} (${teamData.length} đơn)</h3>
                            <div class="table-wrapper">
                                <table id="${tableId}">
                                    <thead></thead>
                                    <tbody></tbody>
                                </table>
                            </div>`;
                        
                        const summaryBar = container.querySelector('.summary-bar');
                        summaryBar.parentNode.insertBefore(teamContainer, summaryBar.nextSibling);

                        this.renderTableHeader(tableId, headers);
                        this.renderTableRows(tableId, headers, teamData);
                    });
                },
                renderTableHeader: function(tableId, headers) {
                    const table = document.getElementById(tableId);
                    if (!table || table.querySelector('thead').innerHTML !== '') return; // Chỉ render 1 lần

                    const thead = table.querySelector('thead');
                    const titleRow = thead.insertRow();
                    titleRow.className = 'header-row';
                    headers.forEach(h => {
                        const th = document.createElement('th');
                        th.className = 'header-title';
                        th.textContent = h;
                        titleRow.appendChild(th);
                    });

                    const filterRow = thead.insertRow();
                    filterRow.className = 'filter-row';
                    headers.forEach(header => {
                        const th = document.createElement('th');
                        const filterOptions = {
                            "Ngày lên đơn": { type: 'date' },
                            "Mặt hàng": { type: 'multiselect', items: [...new Set(globalData.map(r => r["Mặt hàng"]).filter(Boolean))].sort() },
                            "NV Vận đơn": { type: 'multiselect', items: [...new Set(globalData.map(r => r["NV Vận đơn"] || r["NV_Vận_đơn"]).filter(Boolean))].sort() },
                            "Nhân sự Marketing": { type: 'multiselect', items: [...new Set(globalData.map(r => r["Nhân viên Marketing"]).filter(Boolean))].sort() },
                            "Nhân sự Sale": { type: 'multiselect', items: [...new Set(globalData.map(r => r["Nhân viên Sale"]).filter(Boolean))].sort() }
                        };

                        const config = filterOptions[header];
                        if (config) {
                            if (config.type === 'date') {
                                const input = document.createElement('input');
                                input.type = 'date';
                                input.className = 'column-filter';
                                input.dataset.column = header;
                                input.addEventListener('input', () => this.applyFilters());
                                th.appendChild(input);
                            } else if (config.type === 'multiselect') {
                                th.appendChild(this.createColumnMultiSelect(header, config.items));
                            }
                        } else {
                            const input = document.createElement('input');
                            input.type = 'text';
                            input.placeholder = `Lọc theo ${header}`;
                            input.className = 'column-filter';
                            input.dataset.column = header;
                            input.addEventListener('input', () => this.applyFilters());
                            th.appendChild(input);
                        }
                        filterRow.appendChild(th);
                    });
                },
                createColumnMultiSelect: function(header, items) {
                    const container = document.createElement('div');
                    container.className = 'multi-select-container column-filter';
                    container.dataset.column = header;

                    const uniqueId = `col-filter-${header.replace(/\W/g, '')}`;
                    const button = document.createElement('button');
                    button.textContent = `Tất cả (${items.length})`;
                    const dropdown = document.createElement('div');
                    dropdown.className = 'checkbox-dropdown';
                    
                    dropdown.innerHTML = `<label><input type="checkbox" class="select-all"> <b>Chọn tất cả</b></label>`;
                    items.forEach(item => {
                        const encodedItem = item.replace(/"/g, '&quot;');
                        dropdown.innerHTML += `<label><input type="checkbox" value="${encodedItem}"> ${item}</label>`;
                    });
                    
                    container.append(button, dropdown);
                    
                    button.addEventListener('click', (e) => {
                        e.stopPropagation();
                        document.querySelectorAll('#DonChiTiet .filter-row .checkbox-dropdown.show').forEach(d => {
                            if (d !== dropdown) d.classList.remove('show');
                        });
                        dropdown.classList.toggle('show');
                    });

                    dropdown.addEventListener('change', (e) => {
                        if (e.target.classList.contains('select-all')) {
                            dropdown.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = e.target.checked);
                        }
                        this.updateColumnMultiSelectButtonText(button, dropdown);
                        this.applyFilters();
                    });
                    dropdown.addEventListener('click', e => e.stopPropagation());
                    return container;
                },
                updateColumnMultiSelectButtonText: function(button, dropdown) {
                    const selectedCount = dropdown.querySelectorAll('input[type="checkbox"]:checked:not(.select-all)').length;
                    const totalCount = dropdown.querySelectorAll('input[type="checkbox"]:not(.select-all)').length;
                    button.textContent = (selectedCount === 0 || selectedCount === totalCount) ? `Tất cả (${totalCount})` : `${selectedCount} đã chọn`;
                },
                renderTableRows: function (tableId, headers, data) {
                    const tbody = document.getElementById(tableId)?.querySelector('tbody');
                    if (!tbody) return;
                    tbody.innerHTML = '';

                    const colMap = { "Nhân sự Marketing": "Nhân viên Marketing", "Nhân sự Sale": "Nhân viên Sale" };
                    const fragment = document.createDocumentFragment();
                    data.forEach(row => {
                        const tr = document.createElement('tr');
                        headers.forEach(header => {
                            const cell = tr.insertCell();
                            let value = row[colMap[header] || header] || '';
                            if (header === "Ngày lên đơn") cell.textContent = formatDateDisplay(parseDateString(value));
                            else if (header === "Tổng tiền VNĐ") cell.textContent = new Intl.NumberFormat('vi-VN').format(parseFloat(String(value).replace(/[^\d.-]/g, '')) || 0) + ' ₫';
                            else cell.textContent = value;
                        });
                        fragment.appendChild(tr);
                    });
                    tbody.appendChild(fragment);
                }
            };

            // --- KHỞI TẠO ỨNG DỤNG ---
            detailApp.init();
            loadData();
        });
    </script>
</body>
</html>

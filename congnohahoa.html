<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Báo Cáo Công Nợ | Tổng kho Hà Hòa</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4CAF50; --hover-color: #45a049; --text-color: #333;
            --border-color: #e0e0e0; --error-color: #d32f2f; --success-color: #388e3c;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; }
        body { background-color: #f4f7f6; line-height: 1.6; }
        .container { max-width: 1400px; margin: 20px auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .app-header { display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 15px; text-align: left; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid var(--primary-color); }
        .app-header .logo-section { display: flex; align-items: center; gap: 15px; }
        .app-header img { height: 70px; border-radius: 8px; }
        .app-header h1 { color: var(--primary-color); font-size: 26px; margin: 0; }
        .user-info { font-size: 14px; text-align: right; }
        .user-info p { margin-bottom: 5px; }
        #logout-btn { background: none; border: none; color: var(--primary-color); cursor: pointer; font-weight: bold; margin-left: 10px; font-size: 14px; padding: 0; }
        .tabs { display: flex; flex-wrap: wrap; border-bottom: 1px solid var(--border-color); margin-bottom: 25px; }
        .tab { padding: 12px 25px; cursor: pointer; background-color: #f5f5f5; border: 1px solid var(--border-color); border-bottom: none; margin-right: 5px; border-radius: 5px 5px 0 0; font-weight: 500; transition: background-color 0.3s, color 0.3s; }
        .tab.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { padding: 12px 15px; text-align: left; border: 1px solid var(--border-color); white-space: nowrap; }
        th { background-color: var(--primary-color); color: white; position: sticky; top: 0; z-index: 10; }
        tbody tr:nth-child(even) { background-color: #f9f9f9; }
        tbody tr:hover { background-color: #e8f5e9; }
        .status-indicator { text-align: center; padding: 20px; font-size: 16px; color: #777; font-style: italic; }
        .status-indicator.error { color: var(--error-color); font-weight: 500; }
        .table-title { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .table-title h2 { color: #333; }
        .table-title .record-count { font-size: 14px; color: #555; background-color: #e0e0e0; padding: 4px 10px; border-radius: 12px; font-weight: 500; }
        footer { text-align: center; margin-top: 30px; color: #888; font-size: 13px; }
    </style>
</head>
<body>
    <div class="container">
        <header class="app-header">
            <div class="logo-section">
                <img alt="Logo" src="data:image/jpeg;base64,...(base64_string_logo)..." />
                <div>
                    <h1>Hệ thống Báo cáo Công nợ</h1>
                    <p>CÔNG TY TNHH TỔNG KHO HÀ HÒA</p>
                </div>
            </div>
            <div class="user-info">
                <p>Chào, <strong id="user-name-display"></strong> <i class="fas fa-circle" style="color:var(--success-color);font-size:10px"></i><button id="logout-btn">[Đăng xuất]</button></p>
                <p>Quyền: <strong id="user-position-display"></strong></p>
            </div>
        </header>

        <div class="tabs">
            <div id="tab-btn-khn" class="tab active">Khách Hàng Nợ</div>
            <div id="tab-btn-khtn" class="tab">Khách hàng trả nợ</div>
            <div id="tab-btn-hth" class="tab">Hàng thu hồi</div>
        </div>

        <!-- Các tab content giống như file bạn đã cung cấp -->
        <div id="tab-content-khn" class="tab-content active">
            <div class="table-title">
                <h2>Bảng Khách Hàng Nợ</h2>
                <span id="count-khn" class="record-count">...</span>
            </div>
            <div class="table-container" id="container-khn"><p class="status-indicator">Đang tải dữ liệu...</p></div>
        </div>
        <div id="tab-content-khtn" class="tab-content">
            <div class="table-title">
                <h2>Bảng Khách hàng trả nợ</h2>
                <span id="count-khtn" class="record-count">...</span>
            </div>
            <div class="table-container" id="container-khtn"><p class="status-indicator">Vui lòng chọn tab để xem</p></div>
        </div>
        <div id="tab-content-hth" class="tab-content">
            <div class="table-title">
                <h2>Bảng Hàng thu hồi</h2>
                <span id="count-hth" class="record-count">...</span>
            </div>
            <div class="table-container" id="container-hth"><p class="status-indicator">Vui lòng chọn tab để xem</p></div>
        </div>
        
        <footer><p>&copy; 2023 - Hệ thống quản lý Tổng kho Hà Hòa</p></footer>
    </div>
    
    <script>
        // ========== CẤU HÌNH ==========
        const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbzJTJ9uaaGXhSpzRwCER5bqJVBHseSQpw9DQNaYahV5N0Z-9Xz-ctvvaOJgtap9c78A/exec'; 
        
        const TABLE_CONFIG = {
            'khn': { name: 'Khách Hàng Nợ', containerId: 'container-khn', countId: 'count-khn', loaded: false },
            'khtn': { name: 'Khách hàng trả nợ', containerId: 'container-khtn', countId: 'count-khtn', loaded: false },
            'hth': { name: 'Hàng thu hồi', containerId: 'container-hth', countId: 'count-hth', loaded: false }
        };
        
        // ========== QUẢN LÝ XÁC THỰC ==========
        function checkAuth() {
            const userName = sessionStorage.getItem('userName');
            const userPosition = sessionStorage.getItem('userPosition');

            if (!userName || !userPosition) {
                // Nếu chưa đăng nhập, chuyển về trang login
                window.location.href = 'login.html';
                return false;
            }

            // Nếu đã đăng nhập, hiển thị thông tin
            document.getElementById('user-name-display').textContent = userName;
            document.getElementById('user-position-display').textContent = userPosition;
            return true;
        }

        function logout() {
            sessionStorage.clear();
            window.location.href = 'login.html';
        }

        // ========== HÀM RENDER VÀ TẢI DỮ LIỆU (Giữ nguyên) ==========
        function renderTable(tableKey, data) {
            const config = TABLE_CONFIG[tableKey];
            if (!config) return;

            const container = document.getElementById(config.containerId);
            document.getElementById(config.countId).textContent = `${data.total || 0} bản ghi`;

            if (data.error) {
                container.innerHTML = `<p class="status-indicator error">Lỗi: ${data.error}</p>`;
                return;
            }
            if (!data.rows || data.rows.length === 0) {
                container.innerHTML = '<p class="status-indicator">Không có dữ liệu.</p>';
                return;
            }

            const headers = Object.keys(data.rows[0]);
            const headerHtml = `<thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>`;
            const bodyHtml = `<tbody>${data.rows.map(row => 
                `<tr>${headers.map(h => `<td>${row[h] ?? ''}</td>`).join('')}</tr>`
            ).join('')}</tbody>`;
            container.innerHTML = `<table>${headerHtml}${bodyHtml}</table>`;
        }

        async function loadData(tableKey) {
            const config = TABLE_CONFIG[tableKey];
            if (!config || config.loaded) return;

            try {
                const url = `${API_BASE_URL}?table=${encodeURIComponent(config.name)}&date_fmt=dd/MM/yyyy`;
                const response = await fetch(url);
                if (!response.ok) throw new Error("Lỗi mạng khi tải dữ liệu.");
                const data = await response.json();
                renderTable(tableKey, data);
                config.loaded = true;
            } catch (error) {
                renderTable(tableKey, { error: error.message });
            }
        }

        // ========== GÁN SỰ KIỆN VÀ KHỞI CHẠY ==========
        document.addEventListener('DOMContentLoaded', () => {
            if (checkAuth()) {
                // Chỉ chạy tiếp nếu đã xác thực thành công
                document.getElementById('logout-btn').addEventListener('click', logout);
                
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        const targetKey = e.currentTarget.id.replace('tab-btn-', '');
                        
                        document.querySelectorAll('.tab, .tab-content').forEach(el => el.classList.remove('active'));
                        e.currentTarget.classList.add('active');
                        document.getElementById(`tab-content-${targetKey}`).classList.add('active');
                        
                        loadData(targetKey);
                    });
                });

                // Tải dữ liệu cho tab mặc định
                loadData('khn');
            }
        });

    </script>
</body>
</html>

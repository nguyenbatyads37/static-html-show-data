<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <title>QUẢN LÝ VẬN ĐƠN</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    :root {
      --font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      --primary-color: #007bff;
      --primary-color-dark: #0056b3;
      --primary-color-light: #cce5ff;
      --secondary-color: #6c757d;
      --success-color: #28a745;
      --warning-color: #ffc107;
      --danger-color: #dc3545;
      --text-color: #212529;
      --text-color-muted: #6c757d;
      --bg-body: #f8f9fa;
      --bg-card: #ffffff;
      --border-color: #dee2e6;
      --border-radius: 6px;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --transition-speed: 0.2s;
    }

    html {
      font-size: 16px;
    }

    body {
      font-family: var(--font-family);
      padding: 20px;
      background-color: var(--bg-body);
      color: var(--text-color);
      margin: 0;
      line-height: 1.5;
    }

    h2 {
      text-align: center;
      margin-bottom: 2rem;
      color: var(--text-color);
      font-weight: 700;
    }

    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--bg-card);
      padding: 1rem 1.5rem;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-md);
      position: sticky;
      top: 0;
      z-index: 100;
      flex-wrap: wrap;
      gap: 1rem;
      border: 1px solid var(--border-color);
      margin-bottom: 1.5rem;
    }

    .controls .left-controls,
    .controls .right-controls {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    button,
    .btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: var(--border-radius);
      font-size: 0.9rem;
      font-weight: 500;
      color: white;
      transition: all var(--transition-speed) ease-in-out;
      cursor: pointer;
      box-shadow: var(--shadow-sm);
    }
    
    button:hover, .btn:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
    }

    button:focus-visible, .btn:focus-visible {
      outline: 2px solid var(--primary-color);
      outline-offset: 2px;
    }

    .refresh-btn { background-color: var(--success-color); }
    .update-btn { background-color: var(--primary-color); }
    .clear-filter-btn { background-color: var(--warning-color); color: var(--text-color); }

    .refresh-btn:hover { background-color: #218838; }
    .update-btn:hover { background-color: var(--primary-color-dark); }
    .clear-filter-btn:hover { background-color: #e0a800; }

    input[type="text"], input[type="date"], input[type="number"], select, .filter-select {
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        font-size: 0.9rem;
        background-color: var(--bg-card);
        transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
    }

    input:focus, select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
    }
    
    .tab-controls {
      display: flex;
      border-bottom: 2px solid var(--border-color);
      margin-bottom: 1.5rem;
      margin-left: 0;
      padding: 0;
      border-radius: 0;
      overflow: visible;
    }

    .tab-btn {
      background-color: transparent;
      border: none;
      border-bottom: 3px solid transparent;
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-color-muted);
      border-radius: 0;
      margin-bottom: -2px;
      box-shadow: none;
    }
    .tab-btn:hover {
      color: var(--primary-color);
      background-color: #e9ecef;
      transform: none;
      box-shadow: none;
    }
    .tab-btn.active {
      color: var(--primary-color);
      background-color: transparent;
      border-color: var(--primary-color);
      box-shadow: none;
    }
    
    .content-tab { display: none; }
    .content-tab.active { display: block; }
    
    .main-table-wrapper {
      overflow: auto;
      max-height: calc(100vh - 220px);
      background: var(--bg-card);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border-color);
    }

    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 2200px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    th, td {
      border: none;
      border-bottom: 1px solid var(--border-color);
      padding: 0.75rem 1rem;
      white-space: nowrap;
      background-color: var(--bg-card);
      text-align: left;
    }

    th {
      background-color: #f8f9fa;
      color: var(--text-color);
      font-weight: 600;
      vertical-align: top;
      position: sticky;
      top: 0;
      z-index: 20;
      border-bottom-width: 2px;
    }

    #tableBody tr:hover td, #japanTableBody tr:hover td, #allRegionsTableBody tr:hover td {
        background-color: var(--primary-color-light) !important;
        cursor: pointer;
    }

    th .filter-input, th .filter-select {
      width: 100%;
      box-sizing: border-box;
      margin-top: 0.5rem;
      padding: 0.3rem 0.5rem;
      font-size: 0.75rem;
    }

    th .tracking-filter-container {
        display: flex;
        flex-direction: column;
        gap: 4px;
        margin-top: 0.5rem;
    }
    th .tracking-filter-container input {
        width: 100%;
        box-sizing: border-box;
    }

    .multi-select-container {
        position: relative;
        display: inline-block;
        width: 100%;
        margin-top: 0.5rem;
    }

    .multi-select-container .multi-select-button {
      background-color: var(--bg-card);
      color: var(--text-color);
      border: 1px solid var(--border-color);
      font-size: 0.75rem;
      padding: 0.3rem 0.5rem;
      text-align: left;
      width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      border-radius: var(--border-radius);
      cursor: pointer;
    }
     .multi-select-container .multi-select-button:hover {
        border-color: var(--secondary-color);
     }

    .checkbox-dropdown {
      display: none;
      position: absolute;
      background-color: var(--bg-card);
      min-width: 220px;
      box-shadow: var(--shadow-lg);
      z-index: 101;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      max-height: 250px;
      overflow-y: auto;
      padding: 0.5rem;
      margin-top: 4px;
    }
    .checkbox-dropdown.show { display: block; }
    .checkbox-dropdown label {
      display: flex;
      align-items: center;
      padding: 0.4rem 0.6rem;
      cursor: pointer;
      border-radius: 4px;
      transition: background-color var(--transition-speed);
      white-space: nowrap;
      font-size: 0.8rem;
      color: var(--text-color);
      font-weight: 400;
    }
    .checkbox-dropdown label:hover { background-color: #e9ecef; }
    .checkbox-dropdown label input { margin-right: 0.5rem; }
    
    .controls .checkbox-dropdown { font-size: 1rem; }
    .controls .checkbox-dropdown label { font-size: 0.9rem; }

    .fixed-column { position: sticky; z-index: 5; }
    th.fixed-column { z-index: 30; background-color: #f1f3f5; }
    td.fixed-column { background-color: #f8f9fa; border-right: 1px solid var(--border-color); }
    
    /* [CẢI TIẾN] Ô có thể sửa màu xanh lá */
    td.editable {
      background-color: #e8f5e9; /* Nền xanh lá rất nhạt */
      border-left: 3px solid #66bb6a; /* Viền trái xanh lá để nhấn mạnh */
    }
    
    .summary-info {
      background: var(--primary-color-light);
      padding: 0.5rem 1rem;
      border-radius: var(--border-radius);
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--primary-color-dark);
      border: 1px solid #b8daff;
    }
    
    .cell-selected {
      background-color: #a7ffeb !important;
      outline: 2px solid #00bfa5;
      outline-offset: -2px;
    }

    .cell-ok { background-color: #d4edda !important; }
    .cell-cancel { background-color: #f8d7da !important; }
    .cell-xl { background-color: #fff3cd !important; }
    
    .charts-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 1.5rem;
      margin-top: 2rem;
    }

    .chart-wrapper {
      position: relative;
      background: var(--bg-card);
      padding: 1.5rem;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border-color);
      height: 400px;
    }

    ::-webkit-scrollbar { width: 12px; height: 12px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb {
      background-color: #aab5c0;
      border-radius: 10px;
      border: 3px solid #f1f1f1;
    }
    ::-webkit-scrollbar-thumb:hover { background-color: var(--secondary-color); }

    .controls .multi-select-container button {
        background-color: white; color: #333; border: 1px solid #ccc;
        font-size: 0.9rem; padding: 0.5rem 0.75rem; text-align: left;
        width: 250px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .controls .checkbox-dropdown { min-width: 250px; max-height: 300px; padding: 10px; }
    .controls .checkbox-dropdown label { padding: 8px 12px; font-size: 16px; font-weight: normal; color: #333; }
    .controls .checkbox-dropdown label input { margin-right: 10px; }
    
    .status { font-size: 0.85em; margin-left: 8px; color: var(--success-color); }
    .error-status { color: var(--danger-color); }
  </style>
</head>

<body>
  <h2>QUẢN LÝ VẬN ĐƠN</h2>

  <div class="tab-controls">
    <button id="tabData" class="tab-btn active">Dữ liệu đơn hàng</button>
    <button id="tabAllRegions" class="tab-btn" style="display: none;">Tổng đơn 2 miền</button>
    <button id="tabJapan" class="tab-btn">Đơn Nhật</button>
    <button id="tabReport" class="tab-btn">Báo cáo tổng kết</button>
  </div>

  <!-- Tab 1: Dữ liệu đơn hàng của nhân viên -->
  <div id="contentData" class="content-tab active">
    <div class="controls">
      <div class="left-controls">
        <span id="userInfo"></span>
        <button id="refreshData" class="refresh-btn"><span class="refresh-icon">↻</span> Load</button>
        <button id="updateAll" class="update-btn">Cập nhật</button>
        <div class="fixed-col-control">
          <span>Cột cố định:</span>
          <input type="number" id="fixedColumnCountInput" value="1" min="0" style="width: 70px;">
        </div>
        <div id="summaryInfo" class="summary-info"></div>
        <div id="selectionSummary" class="summary-info" style="background-color: #e8f5e9; border: 1px solid #a5d6a7;">
        </div>
      </div>
      <div class="right-controls">
        <div class="date-filter">
          <span>Từ:</span><input type="date" id="startDateFilter" />
          <span>Đến:</span><input type="date" id="endDateFilter" />
        </div>
        <select id="productFilter" class="filter-select">
          <option value="">Tất cả sản phẩm</option>
        </select>
        <select id="marketFilter" class="filter-select">
          <option value="">Tất cả khu vực</option>
        </select>
        <button id="clearFilters" class="clear-filter-btn">Xóa lọc</button>
      </div>
    </div>
    <div class="main-table-wrapper" id="tableContainer">
      <table>
        <thead id="tableHead"></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Tab 2: Tổng đơn 2 miền (Dành cho Leader) -->
  <div id="contentAllRegions" class="content-tab">
    <div class="controls">
      <div class="left-controls">
        <span class="tab-info-text">Toàn bộ đơn hàng</span>
        <button id="allRegionsRefreshData" class="refresh-btn"><span class="refresh-icon">↻</span> Load</button>
        <button id="allRegionsUpdateAll" class="update-btn">Cập nhật</button>
        <div id="allRegionsSummaryInfo" class="summary-info"></div>
      </div>
      <div class="right-controls">
        <div class="date-filter">
          <span>Từ:</span><input type="date" id="allRegionsStartDateFilter" />
          <span>Đến:</span><input type="date" id="allRegionsEndDateFilter" />
        </div>
        <select id="allRegionsProductFilter" class="filter-select">
          <option value="">Sản phẩm</option>
        </select>
        <select id="allRegionsMarketFilter" class="filter-select">
          <option value="">Khu vực</option>
        </select>
        <select id="allRegionsStaffFilter" class="filter-select">
          <option value="">NV Vận đơn</option>
        </select>
        <button id="allRegionsClearFilters" class="clear-filter-btn">Xóa lọc</button>
      </div>
    </div>
    <div class="main-table-wrapper" id="allRegionsTableContainer">
      <table>
        <thead id="allRegionsTableHead"></thead>
        <tbody id="allRegionsTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Tab 3: Đơn Nhật -->
  <div id="contentJapan" class="content-tab">
    <div class="controls">
      <div class="left-controls">
        <span class="tab-info-text">Đơn hàng khu vực: Nhật Bản</span>
        <button id="japanRefreshData" class="refresh-btn"><span class="refresh-icon">↻</span> Load</button>
        <button id="japanUpdateAll" class="update-btn">Cập nhật</button>
        <div id="japanSummaryInfo" class="summary-info"></div>
      </div>
      <div class="right-controls">
        <div class="date-filter">
          <span>Từ:</span><input type="date" id="japanStartDateFilter" />
          <span>Đến:</span><input type="date" id="japanEndDateFilter" />
        </div>
        <select id="japanProductFilter" class="filter-select">
          <option value="">Sản phẩm</option>
        </select>
        <select id="japanStaffFilter" class="filter-select">
          <option value="">NV Vận đơn</option>
        </select>
        <button id="japanClearFilters" class="clear-filter-btn">Xóa lọc</button>
      </div>
    </div>
    <div class="main-table-wrapper" id="japanTableContainer">
      <table>
        <thead id="japanTableHead"></thead>
        <tbody id="japanTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Tab 4: Báo cáo tổng kết -->
  <div id="contentReport" class="content-tab">
    <div class="controls">
      <div class="left-controls">
        <span style="font-weight: bold; font-size: 18px;">Tùy chọn Báo cáo</span>
      </div>
      <div class="right-controls">
        <div class="date-filter">
          <span>Từ:</span><input type="date" id="reportStartDateFilter" />
          <span>Đến:</span><input type="date" id="reportEndDateFilter" />
        </div>
        <div class="multi-select-container">
          <button id="reportStaffFilterBtn">Tất cả NV Vận đơn</button>
          <div id="reportStaffDropdown" class="checkbox-dropdown">
          </div>
        </div>
        <select id="reportProductFilter" class="filter-select">
          <option value="">Tất cả sản phẩm</option>
        </select>
        <select id="reportMarketFilter" class="filter-select">
          <option value="">Tất cả khu vực</option>
        </select>
        <button id="reportClearFilters" class="clear-filter-btn">Xóa lọc</button>
      </div>
    </div>
    <div class="table-wrapper">
      <table class="summary-table">
        <thead>
          <tr>
            <th rowspan="2">NV Vận đơn</th>
            <th rowspan="2">Đơn vị vận chuyển</th>
            <th colspan="2">Đã Thanh Toán (có bill)</th>
            <th rowspan="2">Bill 1 phần</th>
            <th rowspan="2">Tổng đơn lên nội bộ</th>
            <th rowspan="2">Tổng đơn đủ đkien đẩy vh</th>
            <th rowspan="2">Tổng đơn lên vận hành</th>
            <th rowspan="2">Tỷ lệ đơn lên vận hành</th>
            <th rowspan="2">Giao Thành Công</th>
            <th rowspan="2">Đang Giao</th>
            <th rowspan="2">Chưa Giao</th>
            <th rowspan="2">Hoàn</th>
            <th rowspan="2">chờ check</th>
            <th rowspan="2">Trống trạng thái</th>
            <th rowspan="2">Tỷ lệ thu tiền/giao thành công</th>
            <th rowspan="2">Tỷ lệ đơn tính phí vc</th>
          </tr>
          <tr>
            <th>Số đơn</th>
            <th>Thành Tiền</th>
          </tr>
        </thead>
        <tbody id="summaryTableBody"></tbody>
      </table>
    </div>

    <!-- KHU VỰC CHỨA BIỂU ĐỒ -->
    <div class="charts-container">
      <div class="chart-wrapper">
        <canvas id="staffOrderChart"></canvas>
      </div>
      <div class="chart-wrapper">
        <canvas id="deliveryStatusChart"></canvas>
      </div>
    </div>

  </div>

  <script>
    const POST_URL = 'https://script.google.com/macros/s/AKfycbx_rU4gsMXugPUK9ZoTczyWpKdsPVO3QcXzdpswFKVQmnsMU6B6J9lirCO_7NvET78/exec';
    const IMMEDIATE_UPDATE_URL = 'https://script.google.com/macros/s/AKfycbwtoLqG0p-HBsjpyMqqER4YRQ-B7x_qEGlL5_ZjNaIAaxKUXmHO5Weam3_E9ZUMPawy/exec';

    // === CẤU HÌNH CỘT ===
    const columnDisplayMapping = {};
    const editableCols = ["Kết quả Check", "Trạng thái giao hàng NB", "Lý do", "Trạng thái thu tiền", "Ghi chú của VĐ"];
    const dropdownCols = {
      "Kết quả Check": ["", "OK", "Huỷ", "Treo", "Vận đơn XL", "Đợi hàng", "Khách hẹn"],
      "Trạng thái giao hàng NB": ["", "Giao Thành Công", "Đang Giao", "Chưa Giao", "Hủy", "Hoàn", "chờ check", "Giao không thành công", "Bom_Thất Lạc"],
      "Trạng thái thu tiền": ["", "Có bill", "Có bill 1 phần", "Bom_bùng_chặn", "Hẹn Thanh Toán", "Hoàn Hàng", "Khó Đòi", "Không nhận được hàng", "Không PH dưới 3N", "Thanh toán phí hoàn", "KPH nhiều ngày"]
    };
    const displayColumns = ["Mã đơn hàng", "Kết quả Check", "Trạng thái giao hàng NB", "Mã Tracking", "Lý do", "Trạng thái thu tiền", "Ghi chú của VĐ", "Ngày lên đơn", "Name*", "Phone*", "Add", "City", "State", "khu vực", "Zipcode", "Mặt hàng", "Tên mặt hàng 1", "Số lượng mặt hàng 1", "Tên mặt hàng 2", "Số lượng mặt hàng 2", "Quà tặng", "Số lượng quà kèm", "Giá bán", "Loại tiền thanh toán", "Tổng tiền VNĐ", "Hình thức thanh toán", "Ghi chú", "Ngày đóng hàng", "Trạng thái giao hàng", "Thời gian giao dự kiến", "Phí ship nội địa Mỹ (usd)", "Phí xử lý đơn đóng hàng-Lưu kho(usd)", "GHI CHÚ", "Nhân viên Sale", "NV Vận đơn", "Đơn vị vận chuyển", "Số tiền của đơn hàng đã về TK Cty", "Kế toán xác nhận thu tiền về", "Ngày Kế toán đối soát với FFM lần 2"];
    const allDateColumns = ["Ngày lên đơn", "Ngày đóng hàng"];
    const columnsToMakeDynamic = ["Kết quả Check", "Trạng thái giao hàng NB", "Trạng thái thu tiền", "khu vực", "Mặt hàng", "Nhân viên Sale", "NV Vận đơn", "Đơn vị vận chuyển"];
    // === KẾT THÚC CẤU HÌNH ===

    let allData = [],
      staffFilteredData = [],
      japanData = [],
      changedRows = new Map(),
      japanChangedRows = new Map(),
      allRegionsChangedRows = new Map(),
      currentStaff = null,
      teamMembers = [],
      selectedCells = new Set(),
      isMouseDown = false,
      startCell = null,
      dynamicFilterOptions = {},
      japanDynamicFilterOptions = {},
      allRegionsDynamicFilterOptions = {},
      filterDebounceTimer; // [CẢI TIẾN] Biến cho debounce

    let staffChartInstance = null;
    let deliveryStatusChartInstance = null;

    const mainTabConfig = {
      data: () => staffFilteredData,
      changedRows: changedRows,
      controls: {
        refreshBtn: 'refreshData',
        updateBtn: 'updateAll',
        clearBtn: 'clearFilters',
        startDate: 'startDateFilter',
        endDate: 'endDateFilter',
        product: 'productFilter',
        market: 'marketFilter',
        summary: 'summaryInfo'
      },
      table: { head: 'tableHead', body: 'tableBody' },
      dynamicOptions: () => dynamicFilterOptions
    };
    const allRegionsTabConfig = {
      data: () => allData,
      changedRows: allRegionsChangedRows,
      controls: {
        refreshBtn: 'allRegionsRefreshData', updateBtn: 'allRegionsUpdateAll', clearBtn: 'allRegionsClearFilters',
        startDate: 'allRegionsStartDateFilter', endDate: 'allRegionsEndDateFilter',
        product: 'allRegionsProductFilter', market: 'allRegionsMarketFilter', staff: 'allRegionsStaffFilter',
        summary: 'allRegionsSummaryInfo'
      },
      table: { head: 'allRegionsTableHead', body: 'allRegionsTableBody' },
      dynamicOptions: () => allRegionsDynamicFilterOptions
    };
    const japanTabConfig = {
      data: () => japanData,
      changedRows: japanChangedRows,
      controls: {
        refreshBtn: 'japanRefreshData', updateBtn: 'japanUpdateAll', clearBtn: 'japanClearFilters',
        startDate: 'japanStartDateFilter', endDate: 'japanEndDateFilter',
        product: 'japanProductFilter', staff: 'japanStaffFilter',
        summary: 'japanSummaryInfo'
      },
      table: { head: 'japanTableHead', body: 'japanTableBody' },
      dynamicOptions: () => japanDynamicFilterOptions
    };
    const reportTabConfig = {
      controls: {
        clearBtn: 'reportClearFilters', startDate: 'reportStartDateFilter', endDate: 'reportEndDateFilter',
        product: 'reportProductFilter', market: 'reportMarketFilter',
        staffBtn: 'reportStaffFilterBtn', staffDropdown: 'reportStaffDropdown'
      }
    };
    const allTabConfigs = [mainTabConfig, allRegionsTabConfig, japanTabConfig];

    // ... (Các hàm tiện ích như getDateTimeVN, getFixedColumnCount, ... không đổi) ...
    function getDateTimeVN(dateInput) {
      const date = new Date(dateInput) || new Date();
      const options = { timeZone: 'Asia/Ho_Chi_Minh', hour12: false };
      const vnDate = new Date(date.toLocaleString('en-US', options));
      const dd = String(vnDate.getDate()).padStart(2, '0');
      const mm = String(vnDate.getMonth() + 1).padStart(2, '0');
      const yyyy = vnDate.getFullYear();
      const HH = String(vnDate.getHours()).padStart(2, '0');
      const MM = String(vnDate.getMinutes()).padStart(2, '0');
      const SS = String(vnDate.getSeconds()).padStart(2, '0');
      return `${dd}/${mm}/${yyyy} ${HH}:${MM}:${SS}`;
    }
    function getFixedColumnCount() {
      const input = document.getElementById('fixedColumnCountInput');
      const count = parseInt(input.value, 10);
      return isNaN(count) || count < 0 ? 0 : count;
    }
    function handleFixedColumnCountChange() {
      const newCount = getFixedColumnCount();
      const activeTab = document.querySelector('.content-tab.active');
      if (!activeTab) return;
      const activeConfig = allTabConfigs.find(c => c.table.body === activeTab.querySelector('tbody')?.id);
      if (!activeConfig) return;
      const tableHead = document.getElementById(activeConfig.table.head);
      const tableBody = document.getElementById(activeConfig.table.body);
      if (!tableHead || !tableBody) return;
      const allRows = [...tableHead.querySelectorAll('tr'), ...tableBody.querySelectorAll('tr')];
      allRows.forEach(row => {
        for (let i = 0; i < row.cells.length; i++) {
          const cell = row.cells[i];
          if (i < newCount) {
            cell.classList.add('fixed-column');
          } else {
            cell.classList.remove('fixed-column');
            cell.style.left = '';
          }
        }
      });
      updateStickyColumns(activeConfig);
    }
    function updateStickyColumns(config) {
      const fixedCount = getFixedColumnCount();
      const tableHead = document.getElementById(config.table.head);
      const tableBody = document.getElementById(config.table.body);
      [...tableHead.querySelectorAll('.fixed-column'), ...tableBody.querySelectorAll('.fixed-column')].forEach(c => c.style.left = '');
      if (fixedCount <= 0) return;
      const headerRow = tableHead.querySelector('tr');
      if (!headerRow) return;
      let leftOffset = 0;
      for (let i = 0; i < fixedCount; i++) {
        const th = headerRow.cells[i];
        if (!th) continue;
        th.style.left = leftOffset + 'px';
        const rows = tableBody.querySelectorAll('tr');
        rows.forEach(row => {
          if (row.cells[i]) {
            row.cells[i].style.left = leftOffset + 'px';
          }
        });
        leftOffset += th.offsetWidth;
      }
    }
    function getUrlParameter(name) {
      name = name.replace(/[\[\]]/g, '\\$&');
      const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
      const results = regex.exec(window.location.href);
      if (!results) return null;
      if (!results[2]) return '';
      return decodeURIComponent(results[2].replace(/\+/g, ' '));
    }
    function parseDateString(dateString) {
      if (!dateString || typeof dateString !== 'string') return null;
      const cleanedDateString = dateString.trim().replace(/[^\d\/\-\s]/g, '');
      if (/^\d{4}-\d{2}-\d{2}/.test(cleanedDateString)) {
        const d = new Date(cleanedDateString);
        if (!isNaN(d.getTime())) return d;
      }
      const parts = cleanedDateString.match(/^(\d{1,2})[/\-](\d{1,2})[/\-](\d{4})/);
      if (parts) {
        const month = parseInt(parts[1], 10);
        const day = parseInt(parts[2], 10);
        const year = parseInt(parts[3], 10);
        if (year > 1000 && month > 0 && month <= 12 && day > 0 && day <= 31) {
          const d = new Date(Date.UTC(year, month - 1, day));
          if (d.getUTCFullYear() === year && d.getUTCMonth() === month - 1) return d;
        }
      }
      return null;
    }
    function formatDate(dateString) {
      const originalValue = (typeof dateString === 'string') ? dateString.trim() : '';
      if (!originalValue) return { display: '', original: '' };
      const dateObj = parseDateString(originalValue);
      if (dateObj) {
        const day = String(dateObj.getUTCDate()).padStart(2, '0');
        const month = String(dateObj.getUTCMonth() + 1).padStart(2, '0');
        const year = dateObj.getUTCFullYear();
        return { display: `${day}/${month}/${year}`, original: originalValue };
      }
      return { display: originalValue, original: originalValue };
    }
    async function fetchStaffInfo(idns, id1 = null) {
      try {
        const staffApiUrl = 'https://script.google.com/macros/s/AKfycbzwOv7UFwrqzf88QJL1QrxLKcnnnSIQ_PSmF0SO8LboqWI5li3vF3W8_-8s-A8lNGaR/exec';
        const response = await fetch(staffApiUrl, { cache: "no-store" });
        if (!response.ok) throw new Error('Lỗi mạng khi tải data nhân viên');
        const data = await response.json();
        let staffMember = data.find(staff => String(staff.idnv) === idns);
        let staffMember1 = id1 ? data.find(staff => String(staff.idnv) === id1) : null;
        if (!staffMember && !staffMember1) {
          let errorMsg = `Không tìm thấy nhân viên với ID: ${idns}`;
          if (id1) errorMsg += ` hoặc ID1: ${id1}`;
          throw new Error(errorMsg);
        }
        const memberNames = new Set();
        if (staffMember) {
          if (staffMember.ho_va_ten) memberNames.add(staffMember.ho_va_ten);
          if (staffMember.vi_tri === "Leader" && staffMember.team) {
            const teamName = staffMember.team;
            data.forEach(member => {
              if (member.team === teamName && member.ho_va_ten) memberNames.add(member.ho_va_ten);
            });
          }
        }
        if (staffMember1 && staffMember1.ho_va_ten) memberNames.add(staffMember1.ho_va_ten);
        teamMembers = Array.from(memberNames);
        return staffMember || staffMember1;
      } catch (error) {
        showError(error.message);
        throw error;
      }
    }
    function showError(message, containerId = 'tableBody') {
      const container = document.getElementById(containerId);
      const colCount = displayColumns.length;
      container.innerHTML = `<tr><td colspan="${colCount}" class="no-data">${message}</td></tr>`;
    }
    function createEmptyStats() {
      return {
        "Đã Thanh Toán (có bill)": { count: 0, amount: 0 }, "Bill 1 phần": { count: 0, amount: 0 }, "Tổng đơn lên nội bộ": { count: 0, amount: 0 }, "Tổng đơn đủ đkien đẩy vh": { count: 0, amount: 0 }, "Tổng đơn lên vận hành": { count: 0, amount: 0 }, "Giao Thành Công": { count: 0, amount: 0 }, "Đang Giao": { count: 0, amount: 0 }, "Chưa Giao": { count: 0, amount: 0 }, "Hoàn": { count: 0, amount: 0 }, "chờ check": { count: 0, amount: 0 }, "Trống trạng thái": { count: 0, amount: 0 }
      };
    }
    function updateSummaryInfo(filteredData, summaryElementId) {
      const totalOrders = filteredData.length;
      const totalAmount = filteredData.reduce((sum, row) => {
        let amountValue = row["Tổng tiền VNĐ"] || row["Tổng_tiền_VNĐ"] || 0;
        const numericValue = parseFloat(String(amountValue).replace(/[^\d.-]/g, '')) || 0;
        return sum + numericValue;
      }, 0);
      const formattedAmount = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(totalAmount);
      document.getElementById(summaryElementId).innerHTML = `Tổng đơn: <b>${totalOrders}</b> | Tổng tiền: <b style="color:var(--success-color)">${formattedAmount}</b>`;
    }
    function updateDetailedSummaryTable(filteredData) {
      const summaryTableBody = document.getElementById('summaryTableBody');
      summaryTableBody.innerHTML = '';
      if (filteredData.length === 0) {
        showError('Không có dữ liệu báo cáo khớp với bộ lọc.', 'summaryTableBody');
        renderReportCharts({}, {}); return;
      }
      const staffStats = {};
      const grandTotal = createEmptyStats();
      filteredData.forEach(row => {
        const staffName = row["NV Vận đơn"] || row["NV_Vận_đơn"] || "Chưa có NV";
        const shippingCompany = row["Đơn vị vận chuyển"] || row["Đơn_vị_vận_chuyển"] || "Không xác định";
        if (!staffStats[staffName]) staffStats[staffName] = { _total: createEmptyStats() };
        if (!staffStats[staffName][shippingCompany]) staffStats[staffName][shippingCompany] = createEmptyStats();
        const statsToUpdate = [staffStats[staffName][shippingCompany], staffStats[staffName]._total, grandTotal];
        const numericAmount = parseFloat(String(row["Tổng tiền VNĐ"] || row["Tổng_tiền_VNĐ"] || 0).replace(/[^\d.-]/g, '')) || 0;
        const paymentStatus = row["Trạng thái thu tiền"] || "";
        const deliveryStatus = row["Trạng thái giao hàng NB"] || "";
        const checkResult = row["Kết quả Check"] || "";
        const trackingCode = row["Mã Tracking"] || "";
        statsToUpdate.forEach(stats => {
          stats["Tổng đơn lên nội bộ"].count++;
          if (paymentStatus === "Có bill") { stats["Đã Thanh Toán (có bill)"].count++; stats["Đã Thanh Toán (có bill)"].amount += numericAmount; }
          if (paymentStatus === "Có bill 1 phần") stats["Bill 1 phần"].count++;
          if (checkResult === "OK") stats["Tổng đơn đủ đkien đẩy vh"].count++;
          if (shippingCompany && shippingCompany !== "Không xác định") stats["Tổng đơn lên vận hành"].count++;
          if (deliveryStatus === "Giao Thành Công") stats["Giao Thành Công"].count++;
          else if (deliveryStatus === "Hoàn") stats["Hoàn"].count++;
          else if (trackingCode) stats["Đang Giao"].count++;
          else if (deliveryStatus === "Chưa Giao") stats["Chưa Giao"].count++;
          else if (deliveryStatus === "chờ check") stats["chờ check"].count++;
          else if (!deliveryStatus) stats["Trống trạng thái"].count++;
        });
      });
      const grandTotalRow = renderSummaryRow("TỔNG TOÀN BỘ", "Tất cả NV & DVVC", grandTotal);
      grandTotalRow.className = 'summary-grand-total';
      summaryTableBody.appendChild(grandTotalRow);
      Object.keys(staffStats).sort().forEach(staffName => {
        const staffData = staffStats[staffName];
        const totalRow = renderSummaryRow(staffName, "Tất cả DVVC", staffData._total);
        totalRow.className = 'summary-staff-total';
        summaryTableBody.appendChild(totalRow);
      });
      renderReportCharts(staffStats, grandTotal);
    }
    function renderReportCharts(staffStats, grandTotal) {
      if (staffChartInstance) staffChartInstance.destroy();
      if (deliveryStatusChartInstance) deliveryStatusChartInstance.destroy();
      const staffCtx = document.getElementById('staffOrderChart').getContext('2d');
      const sortedStaffNames = Object.keys(staffStats).sort((a, b) => staffStats[b]._total["Tổng đơn lên vận hành"].count - staffStats[a]._total["Tổng đơn lên vận hành"].count);
      staffChartInstance = new Chart(staffCtx, { type: 'bar', data: { labels: sortedStaffNames, datasets: [{ label: 'Tổng đơn lên vận hành', data: sortedStaffNames.map(name => staffStats[name]._total["Tổng đơn lên vận hành"].count), backgroundColor: 'rgba(39, 174, 96, 0.7)', borderColor: 'rgba(39, 174, 96, 1)', borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'Số Lượng Đơn Lên Vận Hành Theo Nhân Viên', font: { size: 16 } }, legend: { display: false } }, scales: { y: { beginAtZero: true, title: { display: true, text: 'Số lượng đơn' } } } } });
      const statusCtx = document.getElementById('deliveryStatusChart').getContext('2d');
      const statusData = grandTotal["Tổng đơn lên nội bộ"] ? [grandTotal["Giao Thành Công"].count, grandTotal["Hoàn"].count, grandTotal["Đang Giao"].count, grandTotal["Chưa Giao"].count, grandTotal["chờ check"].count, grandTotal["Trống trạng thái"].count] : [];
      deliveryStatusChartInstance = new Chart(statusCtx, { type: 'doughnut', data: { labels: ['Giao Thành Công', 'Hoàn', 'Đang Giao', 'Chưa Giao', 'Chờ Check', 'Trống'], datasets: [{ label: 'Trạng thái đơn hàng', data: statusData, backgroundColor: ['#2ecc71', '#e74c3c', '#3498db', '#f1c40f', '#9b59b6', '#95a5a6'], hoverOffset: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'Tổng Quan Trạng Thái Giao Hàng', font: { size: 16 } }, legend: { position: 'top' } } } });
    }
    function renderSummaryRow(staffName, companyName, data) {
      const tr = document.createElement('tr');
      tr.insertCell().textContent = staffName;
      tr.insertCell().textContent = companyName;
      tr.insertCell().textContent = data["Đã Thanh Toán (có bill)"].count;
      tr.insertCell().textContent = new Intl.NumberFormat('vi-VN').format(data["Đã Thanh Toán (có bill)"].amount) + ' ₫';
      tr.insertCell().textContent = data["Bill 1 phần"].count;
      tr.insertCell().textContent = data["Tổng đơn lên nội bộ"].count;
      tr.insertCell().textContent = data["Tổng đơn đủ đkien đẩy vh"].count;
      tr.insertCell().textContent = data["Tổng đơn lên vận hành"].count;
      tr.insertCell().textContent = (data["Tổng đơn lên nội bộ"].count > 0 ? (data["Tổng đơn lên vận hành"].count / data["Tổng đơn lên nội bộ"].count * 100) : 0).toFixed(2) + '%';
      tr.insertCell().textContent = data["Giao Thành Công"].count;
      tr.insertCell().textContent = data["Đang Giao"].count;
      tr.insertCell().textContent = data["Chưa Giao"].count;
      tr.insertCell().textContent = data["Hoàn"].count;
      tr.insertCell().textContent = data["chờ check"].count;
      tr.insertCell().textContent = data["Trống trạng thái"].count;
      tr.insertCell().textContent = (data["Giao Thành Công"].count > 0 ? (data["Đã Thanh Toán (có bill)"].count / data["Giao Thành Công"].count * 100) : 0).toFixed(2) + '%';
      tr.insertCell().textContent = (data["Tổng đơn lên vận hành"].count > 0 ? (data["Giao Thành Công"].count / data["Tổng đơn lên vận hành"].count * 100) : 0).toFixed(2) + '%';
      return tr;
    }
    function getDOMCellValue(cell) {
      if (!cell) return '';
      const select = cell.querySelector('select');
      if (select) return select.value;
      const input = cell.querySelector('input');
      if (input) return input.value;
      return cell.textContent.trim();
    }
    function updateSelectionSummary() {
      const summaryEl = document.getElementById('selectionSummary');
      if (!summaryEl || !document.getElementById('contentData').classList.contains('active')) { if (summaryEl) summaryEl.innerHTML = ''; return; }
      if (selectedCells.size <= 1) { summaryEl.innerHTML = ''; return; }
      let totalSum = 0, numericCount = 0, nonBlankCount = 0;
      selectedCells.forEach(cell => {
        const value = getDOMCellValue(cell);
        if (value !== '') nonBlankCount++;
        const numericValue = parseFloat(String(value).replace(/[^0-9.-]/g, ''));
        if (!isNaN(numericValue)) { totalSum += numericValue; numericCount++; }
      });
      let summaryParts = [`Count: <b>${nonBlankCount}</b>`];
      if (numericCount > 0) summaryParts.push(`Sum: <b>${totalSum.toLocaleString('vi-VN')}</b>`);
      summaryEl.innerHTML = summaryParts.join(' | ');
    }
    function setupCellSelection(tableBodyId) {
      const tableBody = document.getElementById(tableBodyId);
      if (!tableBody) return;
      let lastClickTime = 0, lastClickCell = null;
      tableBody.addEventListener('mousedown', (e) => {
        const td = e.target.closest('td');
        if (!td || e.target.tagName === 'SELECT' || e.target.tagName === 'INPUT') return;
        if (!e.ctrlKey && !e.metaKey && !e.shiftKey) {
          isMouseDown = true; startCell = td;
          selectedCells.forEach(cell => cell.classList.remove('cell-selected'));
          selectedCells.clear();
          td.classList.add('cell-selected');
          selectedCells.add(td);
          e.preventDefault();
        }
      });
      tableBody.addEventListener('click', (e) => {
        const td = e.target.closest('td');
        if (!td || e.target.tagName === 'SELECT' || e.target.tagName === 'INPUT') return;
        const currentTime = new Date().getTime();
        if ((currentTime - lastClickTime < 300) && (lastClickCell === td)) {
          handleEditCell(td, tableBodyId);
        } else {
          if (e.shiftKey && startCell) selectCellsBetween(startCell, td);
          else if (!e.ctrlKey && !e.metaKey) {
            selectedCells.forEach(cell => cell.classList.remove('cell-selected'));
            selectedCells.clear();
            td.classList.add('cell-selected');
            selectedCells.add(td);
          } else {
            td.classList.toggle('cell-selected');
            if (td.classList.contains('cell-selected')) selectedCells.add(td); else selectedCells.delete(td);
          }
          startCell = td;
        }
        lastClickTime = currentTime; lastClickCell = td;
        updateSelectionSummary();
      });
      tableBody.addEventListener('mouseover', (e) => { if (isMouseDown) { const td = e.target.closest('td'); if (td) selectCellsBetween(startCell, td); } });
      document.addEventListener('mouseup', () => { if (isMouseDown) { isMouseDown = false; updateSelectionSummary(); } });
    }
    function selectCellsBetween(start, end) {
      if (!start || !end || start.closest('tbody') !== end.closest('tbody')) return;
      const tableBody = start.closest('tbody');
      const rows = Array.from(tableBody.rows);
      const startRowIndex = rows.findIndex(row => row.contains(start)), endRowIndex = rows.findIndex(row => row.contains(end));
      const startColIndex = start.cellIndex, endColIndex = end.cellIndex;
      const minRow = Math.min(startRowIndex, endRowIndex), maxRow = Math.max(startRowIndex, endRowIndex);
      const minCol = Math.min(startColIndex, endColIndex), maxCol = Math.max(startColIndex, endColIndex);
      const newSelection = new Set();
      for (let i = minRow; i <= maxRow; i++) for (let j = minCol; j <= maxCol; j++) { const cell = rows[i]?.cells[j]; if (cell) newSelection.add(cell); }
      selectedCells.forEach(cell => { if (!newSelection.has(cell)) cell.classList.remove('cell-selected'); });
      newSelection.forEach(cell => { if (!selectedCells.has(cell)) cell.classList.add('cell-selected'); });
      selectedCells = newSelection;
    }
    function handleEditCell(td, tableBodyId) {
      if (!td.classList.contains('editable') || td.classList.contains('editing') || td.querySelector('select')) return;
      if (td.querySelector('input.date-input')) { td.querySelector('input.date-input').focus(); return; }
      const originalValue = td.textContent;
      const input = document.createElement('input');
      input.type = 'text'; input.value = originalValue;
      td.textContent = ''; td.appendChild(input);
      td.classList.add('editing'); input.focus();
      const finishEdit = (save) => {
        const newValue = save ? input.value.trim() : originalValue;
        td.textContent = newValue; td.classList.remove('editing');
        if (save && newValue !== originalValue) {
          td.classList.add('highlight');
          const rowIndex = parseInt(td.closest('tr').dataset.rowIndex);
          const colName = displayColumns[td.cellIndex];
          const config = allTabConfigs.find(c => c.table.body === tableBodyId);
          if (!isNaN(rowIndex) && config) {
            const currentChanges = config.changedRows.get(rowIndex) || {};
            currentChanges[colName] = newValue;
            config.changedRows.set(rowIndex, currentChanges);
          }
        }
        input.removeEventListener('blur', onBlur);
        input.removeEventListener('keydown', onKeyDown);
      };
      const onBlur = () => finishEdit(true);
      const onKeyDown = (e) => { if (e.key === 'Enter') { e.preventDefault(); finishEdit(true); } else if (e.key === 'Escape') { e.preventDefault(); finishEdit(false); } };
      input.addEventListener('blur', onBlur);
      input.addEventListener('keydown', onKeyDown);
    }
    function copySelectedCells() {
      if (selectedCells.size === 0) return;
      const sortedCells = Array.from(selectedCells).sort((a, b) => a.parentNode.rowIndex - b.parentNode.rowIndex || a.cellIndex - b.cellIndex);
      const firstCell = sortedCells[0];
      const minRow = firstCell.parentNode.rowIndex;
      const minCol = sortedCells.reduce((min, cell) => Math.min(min, cell.cellIndex), Infinity);
      const grid = new Map();
      sortedCells.forEach(cell => { const r = cell.parentNode.rowIndex - minRow; const c = cell.cellIndex - minCol; if (!grid.has(r)) grid.set(r, new Map()); grid.get(r).set(c, getDOMCellValue(cell)); });
      let tsv = '';
      const maxR = Math.max(...Array.from(grid.keys()));
      const maxC = Math.max(...Array.from(grid.values()).flatMap(row => Array.from(row.keys())));
      for (let r = 0; r <= maxR; r++) { for (let c = 0; c <= maxC; c++) { tsv += grid.get(r)?.get(c) || ''; if (c < maxC) tsv += '\t'; } if (r < maxR) tsv += '\n'; }
      navigator.clipboard.writeText(tsv).then(() => showTempMessage(`Đã sao chép ${selectedCells.size} ô`)).catch(err => console.error('Lỗi sao chép:', err));
    }
    function pasteToSelectedCells(text) {
      if (selectedCells.size === 0) return;
      const dataGrid = text.split('\n').map(row => row.split('\t'));
      const sortedCells = Array.from(selectedCells).sort((a, b) => a.parentNode.rowIndex - b.parentNode.rowIndex || a.cellIndex - b.cellIndex);
      const firstCell = sortedCells[0];
      const table = firstCell.closest('table');
      if (!table) return;
      const startRowIndex = Array.from(table.rows).indexOf(firstCell.closest('tr'));
      const startColIndex = firstCell.cellIndex;
      let pasteCount = 0;
      if (dataGrid.length === 1 && dataGrid[0].length === 1) { sortedCells.forEach(cell => { if (updateCellValue(cell, dataGrid[0][0])) pasteCount++; }); } else {
        dataGrid.forEach((row, r) => row.forEach((value, c) => { const targetRow = table.rows[startRowIndex + r]; if (targetRow) { const targetCell = targetRow.cells[startColIndex + c]; if (targetCell && updateCellValue(targetCell, value)) pasteCount++; } }));
      }
      showTempMessage(`Đã dán ${pasteCount} giá trị`);
      updateSelectionSummary();
    }
    function clearSelectedCells() {
      if (selectedCells.size === 0) return;
      let clearCount = 0;
      selectedCells.forEach(cell => { if (updateCellValue(cell, '')) clearCount++; });
      if (clearCount > 0) showTempMessage(`Đã xóa nội dung ${clearCount} ô`);
    }
    function updateCellValue(cell, value) {
      if (!cell || !cell.classList.contains('editable')) return false;
      const select = cell.querySelector('select'), dateInput = cell.querySelector('input.date-input');
      const rowIndex = cell.closest('tr').dataset.rowIndex;
      const config = allTabConfigs.find(c => c.table.body === cell.closest('tbody').id);
      let changed = false;
      if (select) { if ([...select.options].some(opt => opt.value === value) && select.value !== value) { select.value = value; select.dispatchEvent(new Event('change', { bubbles: true })); changed = true; } }
      else if (dateInput) { if (dateInput.value !== value) { dateInput.value = value; dateInput.dispatchEvent(new Event('input', { bubbles: true })); changed = true; } }
      else { if (cell.textContent !== value) { cell.textContent = value; cell.classList.add('highlight'); changed = true; } }
      if (changed && rowIndex && config) {
        const colName = displayColumns[cell.cellIndex];
        const currentChanges = config.changedRows.get(parseInt(rowIndex)) || {};
        currentChanges[colName] = value;
        config.changedRows.set(parseInt(rowIndex), currentChanges);
      }
      return changed;
    }
    function showTempMessage(message, isError = false) {
      document.querySelector('.temp-message')?.remove();
      const tempMsg = document.createElement('div');
      tempMsg.textContent = message;
      Object.assign(tempMsg.style, { position: 'fixed', bottom: '20px', right: '20px', backgroundColor: isError ? 'rgba(220, 53, 69, 0.9)' : 'rgba(40, 167, 69, 0.9)', color: 'white', padding: '12px 20px', borderRadius: '5px', zIndex: '2000', transition: 'opacity 0.5s', opacity: '1', boxShadow: '0 4px 10px rgba(0,0,0,0.2)' });
      document.body.appendChild(tempMsg);
      setTimeout(() => { tempMsg.style.opacity = '0'; setTimeout(() => tempMsg.remove(), 500); }, 3000);
    }
    async function sendImmediateUpdate(rowData) {
      try {
        fetch(IMMEDIATE_UPDATE_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: new URLSearchParams({ rows: JSON.stringify([rowData]) }) });
        setTimeout(() => showTempMessage(`Đã cập nhật trạng thái cho đơn: ${rowData["Mã đơn hàng"]}`), 3000);
      } catch (error) { console.error('Lỗi khi cập nhật tức thì:', error); showTempMessage(`Lỗi cập nhật: ${error.message}`, true); }
    }
    async function handleData(response) {
      allTabConfigs.forEach(config => { document.getElementById(config.controls.refreshBtn).innerHTML = '<span class="refresh-icon">↻</span> Load'; });
      allData = [], staffFilteredData = [], japanData = [];
      changedRows.clear(), japanChangedRows.clear(), allRegionsChangedRows.clear();
      if (response.error || !Array.isArray(response.rows)) {
        const errorMsg = 'Lỗi hoặc không có dữ liệu: ' + (response.error || 'Định dạng dữ liệu không đúng');
        allTabConfigs.forEach(config => showError(errorMsg, config.table.body));
        return;
      }
      allData = response.rows.sort((a, b) => (parseDateString(b["Ngày lên đơn"] || b["Thời gian lên đơn"]) || 0) - (parseDateString(a["Ngày lên đơn"] || a["Thời gian lên đơn"]) || 0));
      const staffId = getUrlParameter('id'), staffId1 = getUrlParameter('id1');
      if (!staffId && !staffId1) { showError('Thiếu tham số ID nhân viên trong URL', mainTabConfig.table.body); }
      else {
        try {
          currentStaff = await fetchStaffInfo(staffId, staffId1);
          let staffInfo = `Nhân viên: ${currentStaff.ho_va_ten}`;
          if (staffId1 && staffId1 !== staffId) staffInfo += ` và ${teamMembers.find(name => name !== currentStaff.ho_va_ten) || ''}`;
          if (currentStaff.vi_tri === "Leader") staffInfo += ` (Leader - Team ${currentStaff.team})`;
          document.getElementById('userInfo').textContent = staffInfo;
          if (currentStaff.vi_tri_van_don === "Lên đơn FFM" && !editableCols.includes("Đơn vị vận chuyển")) editableCols.push("Đơn vị vận chuyển");
          document.getElementById('tabAllRegions').style.display = (currentStaff?.vi_tri === "Leader") ? '' : 'none';
          staffFilteredData = allData.filter(row => {
            const isTeamMemberOrder = teamMembers.includes(row["NV Vận đơn"] || row["NV_Vận_đơn"] || '');
            return (currentStaff.vi_tri_van_don === "Lên đơn FFM") ? (isTeamMemberOrder || (row["Kết quả Check"] || "") === "OK") : isTeamMemberOrder;
          });
          initializeTab(mainTabConfig, staffFilteredData);
        } catch (error) { showError(error.message, mainTabConfig.table.body); }
      }
      japanData = allData.filter(row => (row['khu vực'] || row['Khu vực']) === 'Nhật Bản');
      initializeTab(allRegionsTabConfig, allData);
      initializeTab(japanTabConfig, japanData);
      populateReportFilters();
      applyReportFilters();
    }
    function initializeTab(config, data) {
      generateDynamicOptions(config, data);
      populateExternalFilters(config);
      renderHeader(config);
      applyAllFilters(config);
      setupCellSelection(config.table.body);
    }
    function generateDynamicOptions(config, data) {
      const options = {};
      columnsToMakeDynamic.forEach(colName => {
        const dataKey = columnDisplayMapping[colName] || colName;
        const uniqueValues = new Set(data.map(row => row[dataKey] || row[dataKey.replace(/ /g, '_')] || (dataKey === 'khu vực' ? (row['Khu vực'] || '') : '')).filter(Boolean));
        options[colName] = Array.from(uniqueValues).sort((a, b) => String(a).localeCompare(String(b), 'vi'));
      });
      if (config === mainTabConfig) dynamicFilterOptions = options;
      else if (config === japanTabConfig) japanDynamicFilterOptions = options;
      else if (config === allRegionsTabConfig) allRegionsDynamicFilterOptions = options;
    }
    function populateExternalFilters(config) {
      const options = config.dynamicOptions();
      const productFilter = document.getElementById(config.controls.product);
      productFilter.innerHTML = '<option value="">Tất cả sản phẩm</option>';
      (options['Mặt hàng'] || []).forEach(opt => productFilter.add(new Option(opt, opt)));
      if (config.controls.market) {
        const marketFilter = document.getElementById(config.controls.market);
        marketFilter.innerHTML = '<option value="">Tất cả khu vực</option>';
        (options['khu vực'] || []).forEach(opt => marketFilter.add(new Option(opt, opt)));
      }
      if (config.controls.staff) {
        const staffFilter = document.getElementById(config.controls.staff);
        staffFilter.innerHTML = '<option value="">Tất cả NV Vận đơn</option>';
        (options['NV Vận đơn'] || []).forEach(opt => staffFilter.add(new Option(opt, opt)));
      }
    }
    
    // [SỬA LỖI & CẢI TIẾN] Logic lọc được làm lại hoàn toàn
    function applyAllFilters(config) {
        let dataToFilter = [...config.data()];
        const tableHead = document.getElementById(config.table.head);
        if (!tableHead.querySelector('tr')) {
            renderTableBody(config, dataToFilter);
            updateSummaryInfo(dataToFilter, config.controls.summary);
            return;
        }

        // 1. Lọc bên ngoài
        const startDate = document.getElementById(config.controls.startDate).value;
        const endDate = document.getElementById(config.controls.endDate).value;
        if (startDate || endDate) {
            const start = startDate ? new Date(startDate) : null;
            const end = endDate ? new Date(endDate) : null;
            if (start) start.setHours(0, 0, 0, 0);
            if (end) end.setHours(23, 59, 59, 999);
            dataToFilter = dataToFilter.filter(row => {
                const orderDate = parseDateString(row["Ngày lên đơn"] || row["Thời gian lên đơn"]);
                return orderDate && (!start || orderDate >= start) && (!end || orderDate <= end);
            });
        }
        const productValue = document.getElementById(config.controls.product).value;
        if (productValue) dataToFilter = dataToFilter.filter(row => (row["Mặt hàng"] || '') === productValue);
        if (config.controls.market) {
            const marketValue = document.getElementById(config.controls.market).value;
            if(marketValue) dataToFilter = dataToFilter.filter(row => (row["Khu vực"] || row["khu vực"] || '') === marketValue);
        }
        if (config.controls.staff) {
            const staffValue = document.getElementById(config.controls.staff).value;
            if(staffValue) dataToFilter = dataToFilter.filter(row => (row["NV Vận đơn"] || row["NV_Vận_đơn"] || '') === staffValue);
        }

        // 2. Thu thập tất cả điều kiện lọc trong header
        const filterValues = {};
        tableHead.querySelectorAll('[data-column]').forEach(filter => {
            const colName = filter.dataset.column;
            if (!filterValues[colName]) filterValues[colName] = {};

            if (filter.dataset.filterType) { // Ưu tiên loại filter đặc biệt (Mã Tracking)
                filterValues[colName][filter.dataset.filterType] = filter.value.toLowerCase();
            } else if (filter.classList.contains('multi-select-container')) {
                const selected = Array.from(filter.querySelectorAll('input:checked')).map(cb => cb.value);
                if (selected.length > 0) filterValues[colName].multi = new Set(selected);
            } else if (filter.classList.contains('filter-input')) {
                filterValues[colName].text = filter.value.toLowerCase();
            }
        });
        
        // 3. Lọc dữ liệu với các điều kiện đã thu thập
        if (Object.keys(filterValues).length > 0) {
            dataToFilter = dataToFilter.filter(row => {
                for (const colName in filterValues) {
                    const dataKey = columnDisplayMapping[colName] || colName;
                    let cellValue = row[dataKey] ?? (row[dataKey.replace(/ /g, '_')] || (dataKey === 'khu vực' ? (row['Khu vực'] || '') : ''));
                    const cellValueLower = String(cellValue).toLowerCase();
                    const colFilters = filterValues[colName];

                    if (colFilters.text && !cellValueLower.includes(colFilters.text)) return false;
                    if (colFilters.multi && !colFilters.multi.has(String(cellValue))) return false;
                    if (colFilters.contains && !cellValueLower.includes(colFilters.contains)) return false;
                    if (colFilters.notcontains && colFilters.notcontains !== '' && cellValueLower.includes(colFilters.notcontains)) return false;
                }
                return true;
            });
        }
        
        updateSummaryInfo(dataToFilter, config.controls.summary);
        renderTableBody(config, dataToFilter);
    }
    
    // [CẢI TIẾN] Hàm renderHeader sử dụng Debounce
    function renderHeader(config) {
        const header = document.getElementById(config.table.head);
        const options = config.dynamicOptions();
        header.innerHTML = '';
        const tr = document.createElement('tr');
        const fixedCount = getFixedColumnCount();

        // Hàm debounce cho bộ lọc input
        const debouncedFilter = () => {
            clearTimeout(filterDebounceTimer);
            filterDebounceTimer = setTimeout(() => applyAllFilters(config), 300);
        };
        // Hàm lọc ngay lập tức cho select/checkbox
        const immediateFilter = () => applyAllFilters(config);

        displayColumns.forEach((colName, index) => {
            const th = document.createElement('th');
            th.textContent = colName;
            if (index < fixedCount) th.classList.add('fixed-column');
            th.appendChild(document.createElement('br'));

            if (colName === "Mã Tracking") {
                const container = document.createElement('div');
                container.className = 'tracking-filter-container';
                const inputContains = document.createElement('input');
                inputContains.type = 'text'; inputContains.placeholder = 'Chứa ký tự...'; inputContains.className = 'filter-input'; inputContains.dataset.column = colName; inputContains.dataset.filterType = 'contains';
                inputContains.addEventListener('input', debouncedFilter);
                const inputNotContains = document.createElement('input');
                inputNotContains.type = 'text'; inputNotContains.placeholder = 'Không chứa...'; inputNotContains.className = 'filter-input'; inputNotContains.dataset.column = colName; inputNotContains.dataset.filterType = 'notcontains';
                inputNotContains.addEventListener('input', debouncedFilter);
                container.append(inputContains, inputNotContains);
                th.appendChild(container);
            }
            else if (options[colName]) {
                const container = document.createElement('div');
                container.className = 'multi-select-container'; container.dataset.column = colName;
                const button = document.createElement('button');
                button.className = 'multi-select-button'; button.textContent = `Tất cả ${colName}`;
                const dropdown = document.createElement('div');
                dropdown.className = 'checkbox-dropdown';
                options[colName].forEach(opt => {
                    const label = document.createElement('label');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox'; checkbox.value = opt;
                    checkbox.addEventListener('change', () => {
                        const selectedCount = dropdown.querySelectorAll('input:checked').length;
                        button.textContent = (selectedCount === 0) ? `Tất cả ${colName}` : `${selectedCount} lựa chọn`;
                        immediateFilter();
                    });
                    label.append(checkbox, ` ${opt}`);
                    dropdown.appendChild(label);
                });
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    document.querySelectorAll('.checkbox-dropdown.show').forEach(d => { if (d !== dropdown) d.classList.remove('show'); });
                    dropdown.classList.toggle('show');
                });
                container.append(button, dropdown);
                th.appendChild(container);
            } else {
                const filterElement = document.createElement('input');
                filterElement.type = 'text'; filterElement.className = 'filter-input'; filterElement.placeholder = `Lọc ${colName}...`; filterElement.dataset.column = colName;
                filterElement.addEventListener('input', debouncedFilter);
                th.appendChild(filterElement);
            }
            tr.appendChild(th);
        });
        header.appendChild(tr);
        window.addEventListener('click', (e) => {
             if (!e.target.closest('.multi-select-container')) {
                 document.querySelectorAll('.checkbox-dropdown.show').forEach(d => d.classList.remove('show'));
             }
        });
    }

    // ... (Các hàm còn lại như renderTableBody, setupControls, ... không đổi) ...
    function renderTableBody(config, data) {
      const container = document.getElementById(config.table.body);
      container.innerHTML = '';
      if (data.length === 0) { showError(`Không có đơn hàng nào khớp với bộ lọc.`, config.table.body); return; }
      const originalDataSet = config.data();
      const fixedCount = getFixedColumnCount();
      data.forEach((row) => {
        const originalRowIndex = originalDataSet.indexOf(row);
        const tr = document.createElement('tr');
        tr.dataset.rowIndex = originalRowIndex;
        displayColumns.forEach((col, index) => {
          const td = document.createElement('td');
          if (index < fixedCount) td.classList.add('fixed-column');
          const dataKey = columnDisplayMapping[col] || col;
          let value;
          if (allDateColumns.includes(dataKey)) {
            let dateSource = row[dataKey] || '';
            if (dataKey === "Ngày lên đơn") dateSource = row["Ngày lên đơn"] || row["Thời gian lên đơn"];
            const formattedDate = formatDate(dateSource);
            value = formattedDate.display;
            td.dataset.originalValue = formattedDate.original;
          } else if (dataKey === "Ngày Kế toán đối soát với FFM lần 2") {
            value = getDateTimeVN(row[dataKey]);
          } else {
            value = row[dataKey] ?? (row[dataKey.replace(/ /g, '_')] || (dataKey === 'khu vực' ? (row['Khu vực'] || '') : ''));
          }
          if (editableCols.includes(col)) {
            td.classList.add('editable');
            if (dropdownCols[col]) {
              td.classList.add('has-dropdown');
              const select = document.createElement('select');
              dropdownCols[col].forEach(opt => select.add(new Option(opt, opt)));
              select.value = value;
              select.addEventListener('change', (e) => {
                td.classList.add('highlight');
                const newValue = select.value;
                const currentChanges = config.changedRows.get(originalRowIndex) || {};
                currentChanges[col] = newValue;
                config.changedRows.set(originalRowIndex, currentChanges);
                if (col === "Trạng thái giao hàng NB" || col === "Trạng thái thu tiền") {
                  const currentRow = e.target.closest('tr');
                  if (!currentRow) return;
                  const deliveryStatusCell = currentRow.cells[displayColumns.indexOf("Trạng thái giao hàng NB")];
                  const paymentStatusCell = currentRow.cells[displayColumns.indexOf("Trạng thái thu tiền")];
                  sendImmediateUpdate({ "Mã đơn hàng": row["Mã đơn hàng"] || row["Mã_đơn_hàng"], "Trạng thái giao hàng NB": deliveryStatusCell ? getDOMCellValue(deliveryStatusCell) : '', "Trạng thái thu tiền": paymentStatusCell ? getDOMCellValue(paymentStatusCell) : '' });
                }
              });
              td.appendChild(select);
            } else {
              td.textContent = value;
            }
          } else {
            td.textContent = value;
          }
          if (col === "Kết quả Check") {
            if (value === 'OK') td.classList.add('cell-ok');
            else if (value === 'Vận đơn XL') td.classList.add('cell-xl');
            else if (value === 'Huỷ') td.classList.add('cell-cancel');
          }
          tr.appendChild(td);
        })
        container.appendChild(tr);
      });
      updateStickyColumns(config);
    }
    function setupControls() {
      setupTabs();
      allTabConfigs.forEach(setupTabControls);
      setupReportControls();
      document.getElementById('fixedColumnCountInput').addEventListener('input', handleFixedColumnCountChange);
      document.addEventListener('keydown', (e) => {
        const activeEl = document.activeElement;
        if (activeEl && ['INPUT', 'SELECT', 'TEXTAREA'].includes(activeEl.tagName) && !activeEl.closest('td')) return;
        if (document.querySelector('td.editing')) return;
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'c' && selectedCells.size > 0) { e.preventDefault(); copySelectedCells(); }
        else if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'v' && selectedCells.size > 0) { e.preventDefault(); navigator.clipboard.readText().then(text => pasteToSelectedCells(text)).catch(err => console.error('Lỗi đọc clipboard:', err)); }
        else if ((e.key === 'Delete' || e.key === 'Backspace') && selectedCells.size > 0) { e.preventDefault(); clearSelectedCells(); }
      });
      window.addEventListener('resize', () => {
        const activeTab = document.querySelector('.content-tab.active');
        if (!activeTab) return;
        const activeConfig = allTabConfigs.find(c => c.table.body === activeTab.querySelector('tbody')?.id);
        if (activeConfig) updateStickyColumns(activeConfig);
      });
    }
    function setupTabControls(config) {
      document.getElementById(config.controls.refreshBtn).addEventListener('click', refreshData);
      document.getElementById(config.controls.updateBtn).addEventListener('click', () => updateAllChangedRows(config));
      const filterFunction = () => applyAllFilters(config);
      document.getElementById(config.controls.startDate).addEventListener('change', filterFunction);
      document.getElementById(config.controls.endDate).addEventListener('change', filterFunction);
      document.getElementById(config.controls.product).addEventListener('change', filterFunction);
      if (config.controls.market) document.getElementById(config.controls.market).addEventListener('change', filterFunction);
      if (config.controls.staff) document.getElementById(config.controls.staff).addEventListener('change', filterFunction);
      document.getElementById(config.controls.clearBtn).addEventListener('click', () => {
        document.getElementById(config.controls.startDate).value = '';
        document.getElementById(config.controls.endDate).value = '';
        document.getElementById(config.controls.product).selectedIndex = 0;
        if (config.controls.market) document.getElementById(config.controls.market).selectedIndex = 0;
        if (config.controls.staff) document.getElementById(config.controls.staff).selectedIndex = 0;
        const header = document.getElementById(config.table.head);
        header.querySelectorAll('.filter-input').forEach(f => f.value = '');
        header.querySelectorAll('.multi-select-container').forEach(container => {
          container.querySelectorAll('input:checked').forEach(cb => cb.checked = false);
          container.querySelector('.multi-select-button').textContent = `Tất cả ${container.dataset.column}`;
        });
        applyAllFilters(config);
      });
    }
    function setupReportControls() {
      const { controls } = reportTabConfig;
      const staffBtn = document.getElementById(controls.staffBtn), staffDropdown = document.getElementById(controls.staffDropdown);
      document.getElementById(controls.startDate).addEventListener('change', applyReportFilters);
      document.getElementById(controls.endDate).addEventListener('change', applyReportFilters);
      document.getElementById(controls.product).addEventListener('change', applyReportFilters);
      document.getElementById(controls.market).addEventListener('change', applyReportFilters);
      document.getElementById(controls.clearBtn).addEventListener('click', () => {
        document.getElementById(controls.startDate).value = ''; document.getElementById(controls.endDate).value = '';
        document.getElementById(controls.product).selectedIndex = 0; document.getElementById(controls.market).selectedIndex = 0;
        staffDropdown.querySelectorAll('input:checked').forEach(cb => cb.checked = false);
        updateStaffFilterButtonText(); applyReportFilters();
      });
      staffBtn.addEventListener('click', (e) => { e.stopPropagation(); staffDropdown.classList.toggle('show'); });
      staffDropdown.addEventListener('click', (e) => { if (e.target.tagName !== 'LABEL' && e.target.tagName !== 'INPUT') e.stopPropagation(); });
      window.addEventListener('click', (e) => { if (!e.target.closest('.controls .multi-select-container') && staffDropdown.classList.contains('show')) staffDropdown.classList.remove('show'); });
    }
    function setupTabs() {
      const tabs = document.querySelectorAll('.tab-btn'), contents = document.querySelectorAll('.content-tab');
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          selectedCells.forEach(cell => cell.classList.remove('cell-selected'));
          selectedCells.clear(); isMouseDown = false; startCell = null;
          tabs.forEach(item => item.classList.remove('active'));
          contents.forEach(content => content.classList.remove('active'));
          tab.classList.add('active');
          const contentId = 'content' + tab.id.substring(3);
          document.getElementById(contentId).classList.add('active');
          setTimeout(() => {
            handleFixedColumnCountChange();
            const summaryEl = document.getElementById('selectionSummary');
            if (summaryEl) summaryEl.innerHTML = (contentId === 'contentData') ? summaryEl.innerHTML : '';
          }, 10);
        });
      });
    }
    function refreshData() {
      allTabConfigs.forEach(config => { document.getElementById(config.controls.refreshBtn).innerHTML = '<span class="loading"></span> Đang tải...'; document.getElementById(config.controls.updateBtn).disabled = true; });
      loadData();
      setTimeout(() => { allTabConfigs.forEach(config => { document.getElementById(config.controls.refreshBtn).innerHTML = '<span class="refresh-icon">↻</span> Load'; document.getElementById(config.controls.updateBtn).disabled = false; }); }, 5000);
    }
    function updateAllChangedRows(config) {
      if (config.changedRows.size === 0) { alert('Không có thay đổi nào để cập nhật'); return; }
      const updateBtn = document.getElementById(config.controls.updateBtn);
      const statusEl = document.createElement('span'); statusEl.className = 'status'; statusEl.textContent = 'Đang xử lý...';
      updateBtn.appendChild(statusEl); updateBtn.disabled = true;
      const rowsToSend = [];
      config.changedRows.forEach((changes, rowIndex) => {
        const originalData = config.data()[rowIndex];
        if (!originalData) return;
        const updatedRowData = { ...originalData };
        for (const displayName in changes) { updatedRowData[columnDisplayMapping[displayName] || displayName] = changes[displayName]; }
        delete updatedRowData["Thời gian lên đơn"]; rowsToSend.push(updatedRowData);
      });
      if (rowsToSend.length === 0) {
        statusEl.textContent = 'Không có dòng nào hợp lệ.';
        setTimeout(() => { if (statusEl.parentElement) updateBtn.removeChild(statusEl); updateBtn.disabled = false; }, 3000);
        return;
      }
      fetch(POST_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: new URLSearchParams({ rows: JSON.stringify(rowsToSend) }) })
        .then(() => {
          statusEl.textContent = `Đã gửi ${rowsToSend.length} thay đổi.`;
          setTimeout(() => {
            alert(`Yêu cầu cập nhật ${rowsToSend.length} dòng đã được gửi. Vui lòng nhấn "Load" để xem kết quả.`);
            config.changedRows.clear(); document.querySelectorAll(`#${config.table.body} .highlight`).forEach(cell => cell.classList.remove('highlight'));
            if (statusEl.parentElement) updateBtn.removeChild(statusEl); updateBtn.disabled = false;
          }, 1500);
        })
        .catch(e => { statusEl.textContent = 'Lỗi mạng: ' + e.message; statusEl.classList.add('error-status'); setTimeout(() => { if (statusEl.parentElement) updateBtn.removeChild(statusEl); updateBtn.disabled = false; }, 4000); });
    }
    function populateReportFilters() {
      const { controls } = reportTabConfig;
      const productFilter = document.getElementById(controls.product), marketFilter = document.getElementById(controls.market), staffDropdown = document.getElementById(controls.staffDropdown);
      const allProducts = [...new Set(allData.map(r => r["Mặt hàng"]).filter(Boolean))].sort(), allMarkets = [...new Set(allData.map(r => r["khu vực"] || r["Khu vực"]).filter(Boolean))].sort(), allStaff = [...new Set(allData.map(r => r["NV Vận đơn"] || r["NV_Vận_đơn"]).filter(Boolean))].sort();
      productFilter.innerHTML = '<option value="">Tất cả sản phẩm</option>'; allProducts.forEach(opt => productFilter.add(new Option(opt, opt)));
      marketFilter.innerHTML = '<option value="">Tất cả khu vực</option>'; allMarkets.forEach(opt => marketFilter.add(new Option(opt, opt)));
      staffDropdown.innerHTML = '';
      const allLabel = document.createElement('label'); allLabel.innerHTML = `<input type="checkbox" id="reportStaffSelectAll"> <b>Chọn tất cả</b>`; staffDropdown.appendChild(allLabel);
      allStaff.forEach(staffName => {
        const label = document.createElement('label'), checkbox = document.createElement('input');
        checkbox.type = 'checkbox'; checkbox.value = staffName;
        checkbox.addEventListener('change', () => { updateStaffFilterButtonText(); applyReportFilters(); });
        label.append(checkbox, ` ${staffName}`); staffDropdown.appendChild(label);
      });
      document.getElementById('reportStaffSelectAll').addEventListener('change', (e) => { staffDropdown.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = e.target.checked); updateStaffFilterButtonText(); applyReportFilters(); });
    }
    function updateStaffFilterButtonText() {
      const { controls } = reportTabConfig;
      const staffBtn = document.getElementById(controls.staffBtn);
      const allStaffCheckboxes = document.querySelectorAll(`#${controls.staffDropdown} input:not(#reportStaffSelectAll)`);
      const selectedCount = Array.from(allStaffCheckboxes).filter(cb => cb.checked).length;
      if (selectedCount === 0) staffBtn.textContent = 'Tất cả NV Vận đơn';
      else if (selectedCount === allStaffCheckboxes.length) { staffBtn.textContent = 'Tất cả NV đã chọn'; document.getElementById('reportStaffSelectAll').checked = true; }
      else { staffBtn.textContent = `${selectedCount} NV đã chọn`; document.getElementById('reportStaffSelectAll').checked = false; }
    }
    function applyReportFilters() {
      let filteredReportData = [...allData];
      const { controls } = reportTabConfig;
      const startDate = document.getElementById(controls.startDate).value, endDate = document.getElementById(controls.endDate).value;
      const product = document.getElementById(controls.product).value, market = document.getElementById(controls.market).value;
      const selectedStaff = Array.from(document.querySelectorAll(`#${controls.staffDropdown} input:checked:not(#reportStaffSelectAll)`)).map(cb => cb.value);
      if (startDate || endDate) {
        const start = startDate ? new Date(startDate) : null, end = endDate ? new Date(endDate) : null;
        if (start) start.setHours(0, 0, 0, 0); if (end) end.setHours(23, 59, 59, 999);
        filteredReportData = filteredReportData.filter(row => { const orderDate = parseDateString(row["Ngày lên đơn"] || row["Thời gian lên đơn"]); return orderDate && (!start || orderDate >= start) && (!end || orderDate <= end); });
      }
      if (product) filteredReportData = filteredReportData.filter(row => row["Mặt hàng"] === product);
      if (market) filteredReportData = filteredReportData.filter(row => (row["khu vực"] || row["Khu vực"]) === market);
      if (selectedStaff.length > 0) { const staffSet = new Set(selectedStaff); filteredReportData = filteredReportData.filter(row => staffSet.has(row["NV Vận đơn"] || row["NV_Vận_đơn"])); }
      updateDetailedSummaryTable(filteredReportData);
    }
    function loadData() {
      allTabConfigs.forEach(config => showError('Đang tải dữ liệu...', config.table.body));
      const script = document.createElement('script');
      script.src = `${POST_URL}?callback=handleData&rand=${Math.random()}`;
      document.querySelector('script[src^="https://script.google.com"]')?.remove();
      document.body.appendChild(script);
    }

    document.addEventListener('DOMContentLoaded', () => {
      setupControls();
      loadData();
    });
  </script>
</body>

</html>

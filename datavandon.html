<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>DANH SÁCH ĐƠN HÀNG</title>
  <style>
    /* ... Toàn bộ CSS từ trước giữ nguyên ... */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      background-color: #f5f5f5;
      color: #333;
      margin: 0;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    h2 { text-align: center; margin-bottom: 20px; color: #2c3e50; }
    .controls {
      display: flex; justify-content: space-between; margin-bottom: 15px; align-items: center;
      background: #fff; padding: 10px 15px; border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; flex-wrap: wrap;
    }
    .controls .left-controls, .controls .right-controls { display: flex; align-items: center; gap: 10px; }
    .date-filter { display: flex; align-items: center; gap: 8px; }

    .date-filter span {
      font-size: 16px;
    }
    .date-filter input[type="date"] {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 15px;
    }

    .table-wrapper {
      position: relative; overflow: auto; max-height: 70vh;
      background: white; border-radius: 0 0 5px 5px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 2400px;
      font-size: 16px;
    }
    thead { position: sticky; top: 0; z-index: 10; }
    th, td {
      border: 1px solid #e0e0e0;
      padding: 10px 15px;
      text-align: left;
      white-space: nowrap;
      background-color: white;
    }
    th {
      background-color: #3498db;
      color: white;
      font-weight: 700;
      vertical-align: top;
      position: sticky;
      top: 0;
      z-index: 20;
    }
    th .filter-input, th .filter-select {
      width: 100%; margin-top: 5px; padding: 4px;
      font-size: 12px; border: 1px solid #ccc; border-radius: 3px;
      box-sizing: border-box;
    }
    td.editable { background-color: #fffbe8; }
    td select, td input.date-input {
      width: 100%; padding: 6px; border: none;
      background: transparent; font-family: inherit; font-size: inherit;
      /* Thêm con trỏ để người dùng biết là có thể click */
      cursor: pointer;
    }
    button {
      padding: 6px 12px; cursor: pointer; background-color: #3498db; color: white;
      border: none; border-radius: 4px; font-size: 13px;
      transition: background-color 0.3s;
    }
    button:hover { background-color: #2980b9; }
    .status { font-size: 0.85em; margin-left: 8px; color: #27ae60; }
    .error-status { color: #e74c3c; }
    .highlight { background-color: #ffeb3b !important; }
    .no-data {
      text-align: center; padding: 20px;
      color: #7f8c8d; font-style: italic;
    }
    .refresh-btn { background-color: #2ecc71; }
    .refresh-btn:hover { background-color: #27ae60; }
    .clear-filter-btn { background-color: #f39c12; }
    .clear-filter-btn:hover { background-color: #e67e22; }
    .refresh-icon { margin-right: 5px; }
    .fixed-column { position: sticky; left: 0; z-index: 5; }
    th.fixed-column { z-index: 30; background-color: #3498db; }
    td.fixed-column { background-color: #f9f9f9; }
    #userInfo { font-weight: bold; margin-right: 15px; }
    
    td {
      font-weight: 500;
      transition: background-color 0.2s ease-in-out;
    }
    tbody tr:hover td {
      background-color: #fdf5d4;
    }
    tbody tr:hover td.highlight {
      background-color: #ffeb3b !important;
    }
    tbody tr:hover td.fixed-column {
        background-color: #f0f0f0;
    }

    .summary-dashboard {
      display: flex; gap: 20px; margin-bottom: 15px; background-color: #ffffff;
      padding: 15px 20px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .summary-item { display: flex; flex-direction: column; align-items: center; }
    .summary-label { font-size: 14px; color: #7f8c8d; margin-bottom: 5px; }
    .summary-value { font-size: 24px; font-weight: bold; color: #2c3e50; transition: color 0.3s ease; }

    #tableBody {
      user-select: none; -webkit-user-select: none; -moz-user-select: none;
    }
    td.cell-selected {
      background-color: rgba(52, 152, 219, 0.4) !important;
      outline: 1px solid #3498db;
    }
    .copy-flash { animation: flash-success 0.5s ease; }
    @keyframes flash-success {
        from { background-color: #2ecc71; }
        to { background-color: initial; }
    }
  </style>
</head>
<body>
  <h2>QUẢN LÝ VẬN ĐƠN</h2>
  <div class="controls"><!--...--></div>
  <div class="summary-dashboard"><!--...--></div>
  <div class="table-wrapper" id="tableContainer">
    <table>
      <thead id="tableHead"></thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <script>
    const POST_URL = 'https://script.google.com/macros/s/AKfycbywmvvC_1x5rIS6keNkADH2yPbxNLCqshCwyx_-gP2yFYpyygfS1l-Z5i1EAlXrIfzL/exec';

    // ✅ KIỂM TRA LẠI MẢNG NÀY! Đảm bảo tên cột bạn muốn sửa nằm trong đây và gõ chính xác.
    const editableCols = [
        "Kết quả Check", "Trạng thái giao hàng NB", "Lý do", "Trạng thái thu tiền",
        "Ngày hẹn đẩy đơn", "Loại thanh toán", "Tên người chuyển khoản"
    ];

    const dropdownCols = {
        "Kết quả Check": ["", "OK", "Huỷ", "Treo", "Vận đơn XL", "Đợi hàng", "Khách hẹn"],
        "Trạng thái giao hàng NB": ["", "Giao Thành Công", "Đang Giao", "Chưa Giao", "Hủy", "Hoàn", "chờ check", "Giao không thành công", "Bom_Thất Lạc"],
        "Trạng thái thu tiền": ["", "Có bill", "Có bill 1 phần", "Bom_bùng_chặn", "Hẹn Thanh Toán", "Hoàn Hàng", "Khó Đòi", "Không nhận được hàng", "Không PH dưới 3N", "Thanh toán phí hoàn", "KPH nhiều ngày"]
    };

    const displayColumns = [
      "Mã đơn hàng", ...editableCols, "Ngày lên đơn", "Name*", "Phone*", "Add", "City",
      "State", "Zipcode", "Mặt hàng", "Tên mặt hàng 1", "Số lượng mặt hàng 1", "Tên mặt hàng 2",
      "Số lượng mặt hàng 2", "Quà tặng", "Số lượng quà kèm", "Giá bán", "Loại tiền thanh toán",
      "Tổng tiền VNĐ", "Hình thức thanh toán", "Ghi chú", "Mã Tracking", "Ngày đóng hàng",
      "Trạng thái giao hàng", "Thời gian giao dự kiến", "Phí ship nội địa Mỹ (usd)",
      "Phí xử lý đơn đóng hàng-Lưu kho(usd)", "GHI CHÚ", "Nhân viên Sale", "NV Vận đơn", "Đơn vị vận chuyển"
    ];
    
    // ✅ ĐỊNH NGHĨA MÀU SẮC VÀ KIỂU CHỮ CHO CÁC TRẠNG THÁI
    const statusStyles = {
      // Kết quả Check
      'OK': { color: '#27ae60', fontWeight: 'bold' },
      'Huỷ': { color: '#e74c3c', fontWeight: 'bold' },
      'Treo': { color: '#f39c12', fontWeight: 'bold' },
      // Trạng thái giao hàng NB
      'Giao Thành Công': { color: '#2ecc71', fontWeight: 'bold' },
      'Hủy': { color: '#e74c3c', fontWeight: 'bold' },
      'Hoàn': { color: '#e67e22', fontWeight: 'bold' },
      'Bom_Thất Lạc': { color: '#c0392b', fontWeight: 'bold' },
      // Trạng thái thu tiền
      'Có bill': { color: '#2980b9', fontWeight: 'bold' },
      'Bom_bùng_chặn': { color: '#c0392b', fontWeight: 'bold' },
      'Khó Đòi': { color: '#e74c3c', fontWeight: 'bold' },
    };

    // ✅ HÀM TRỢ GIÚP ĐỂ ÁP DỤNG STYLE
    function applySelectStyles(selectElement) {
        const selectedValue = selectElement.value;
        // Lấy style từ đối tượng statusStyles, nếu không có thì dùng style mặc định
        const style = statusStyles[selectedValue] || { color: 'inherit', fontWeight: 'inherit' };
        selectElement.style.color = style.color;
        selectElement.style.fontWeight = style.fontWeight;
    }

    let allData = [];
    let staffFilteredData = [];
    let changedRows = new Set();
    let currentStaff = null;
    let teamMembers = [];

    // ... (Các hàm getUrlParameter, fetchStaffInfo, showError, formatDate không đổi)
    
    async function handleData(response) { /* ... */ }
    function filterDataByStaff() { /* ... */ }
    function applyAllFilters() { /* ... */ }

    // ✅ HÀM RENDER HEADER ĐÃ KHÔI PHỤC LẠI BỘ LỌC TEXT CHO NGÀY LÊN ĐƠN
    function renderHeader() {
        const header = document.getElementById('tableHead');
        header.innerHTML = '';
        const tr = document.createElement('tr');
        displayColumns.forEach(colName => {
            const th = document.createElement('th');
            th.textContent = colName;
            if (colName === "Mã đơn hàng") th.classList.add('fixed-column');

            th.appendChild(document.createElement('br'));
            
            let filterElement;
            if (dropdownCols[colName]) {
                filterElement = document.createElement('select');
                filterElement.className = 'filter-select';
                filterElement.add(new Option('(Tất cả)', ''));
                dropdownCols[colName].forEach(opt => {
                    if(opt) filterElement.add(new Option(opt, opt));
                });
                filterElement.addEventListener('change', applyAllFilters);
            } else {
                // Tất cả các cột khác, bao gồm "Ngày lên đơn", sẽ có bộ lọc text
                filterElement = document.createElement('input');
                filterElement.type = 'text';
                filterElement.className = 'filter-input';
                filterElement.placeholder = `Lọc ${colName}...`;
                filterElement.addEventListener('input', applyAllFilters);
            }
            filterElement.dataset.column = colName;
            th.appendChild(filterElement);
            tr.appendChild(th);
        });
        header.appendChild(tr);
    }

    // ✅ HÀM RENDER BODY ĐÃ ĐƯỢC CẬP NHẬT HOÀN TOÀN
    function renderTableBody(data) {
      const container = document.getElementById('tableBody');
      container.innerHTML = '';
      if (data.length === 0) {
        showError(`Không có đơn hàng nào khớp với bộ lọc.`);
        updateSummary([]); 
        return;
      }
      data.forEach((row) => {
        const originalRowIndex = staffFilteredData.indexOf(row);
        const tr = document.createElement('tr');
        tr.dataset.rowIndex = originalRowIndex;
        displayColumns.forEach(col => {
          const td = document.createElement('td');
          let value = row[col] !== undefined ? row[col] : row[col.replace(/ /g, '_')] || '';
          
          if (["Ngày lên đơn", "Ngày đóng hàng", "Ngày hẹn đẩy đơn"].includes(col)) {
              const dateSource = col === "Ngày lên đơn" ? (row["Ngày lên đơn"] || row["Thời gian lên đơn"]) : value;
              value = formatDate(dateSource);
          }

          if (col === "Mã đơn hàng") td.classList.add('fixed-column');

          // Logic render ô có thể chỉnh sửa
          if (editableCols.includes(col)) {
            td.classList.add('editable');

            if (dropdownCols[col]) { // Nếu là menu thả xuống
              const select = document.createElement('select');
              
              dropdownCols[col].forEach(optText => {
                const option = document.createElement('option');
                option.value = optText;
                option.textContent = optText || '(Trống)';
                
                // Áp dụng style cho từng option trong danh sách
                const style = statusStyles[optText];
                if (style) {
                    option.style.color = style.color;
                    option.style.fontWeight = style.fontWeight;
                }
                select.appendChild(option);
              });

              select.value = value;
              
              // Áp dụng style cho thẻ select lúc ban đầu
              applySelectStyles(select);

              select.addEventListener('change', function() {
                td.classList.add('highlight');
                changedRows.add(originalRowIndex);
                // Áp dụng style cho thẻ select mỗi khi thay đổi
                applySelectStyles(this);
              });
              td.appendChild(select);
            } else if (col === "Ngày hẹn đẩy đơn") { // Nếu là ô nhập ngày
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'date-input';
                input.placeholder = 'dd/mm/yyyy';
                input.value = value;
                input.addEventListener('input', () => {
                    td.classList.add('highlight');
                    changedRows.add(originalRowIndex);
                });
                td.appendChild(input);
            } else { // Các ô chỉnh sửa văn bản thông thường
              td.contentEditable = 'true';
              td.textContent = value;
              td.addEventListener('input', () => {
                td.classList.add('highlight');
                changedRows.add(originalRowIndex);
              });
            }
          } else { // Các ô không thể chỉnh sửa
            td.textContent = value;
          }
          tr.appendChild(td);
        });
        container.appendChild(tr);
      });
    }

    // ... (Tất cả các hàm còn lại giữ nguyên như phiên bản trước)
    function updateSummary(data) { /* ... */ }
    function setupControls() { /* ... */ }
    function refreshData() { /* ... */ }
    function reformatDateForSheet(dateString) { /* ... */ }
    function updateAllChangedRows() { /* ... */ }
    function loadData() { /* ... */ }
    let isMouseDown = false; /* ... */
    function getCellValue(cell) { /* ... */ }
    function updateSelection(start, end) { /* ... */ }
    function handleCopy(e) { /* ... */ }
    function setupSelectionEvents() { /* ... */ }
    
    // Gọi các hàm khởi tạo
    setupControls();
    setupSelectionEvents();
    loadData();

    // Dán lại các hàm đã ẩn ở trên vào đây
    function getUrlParameter(name) { name = name.replace(/[\[\]]/g, '\\$&'); const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'); const results = regex.exec(window.location.href); if (!results) return null; if (!results[2]) return ''; return decodeURIComponent(results[2].replace(/\+/g, ' ')); }
    async function fetchStaffInfo(idns) { try { const staffApiUrl = 'https://script.google.com/macros/s/AKfycbzwOv7UFwrqzf88QJL1QrxLKcnnnSIQ_PSmF0SO8LboqWI5li3vF3W8_-8s-A8lNGaR/exec'; const response = await fetch(staffApiUrl, { cache: "no-store" }); if (!response.ok) throw new Error('Lỗi mạng khi tải data nhân viên'); const data = await response.json(); const staffMember = data.find(staff => String(staff.idnv) === idns); if (!staffMember) throw new Error(`Không tìm thấy nhân viên với ID: ${idns}`); if (staffMember.vi_tri === "Leader") { const teamName = staffMember.team; teamMembers = data.filter(member => member.team === teamName).map(member => member.ho_va_ten); } return staffMember; } catch (error) { showError(error.message); throw error; } }
    function showError(message) { const container = document.getElementById('tableBody'); const colCount = displayColumns.length > 0 ? displayColumns.length : 10; container.innerHTML = `<tr><td colspan="${colCount}" class="no-data">${message}</td></tr>`; }
    function formatDate(dateString) { if (!dateString || typeof dateString !== 'string') return ''; const match = dateString.match(/^(\d{4})-(\d{2})-(\d{2})/); if (match) { const year = match[1]; const month = match[2]; const day = match[3]; return `${day}/${month}/${year}`; } return dateString; }
    async function handleData(response) { document.getElementById('refreshData').innerHTML = '<span class="refresh-icon">↻</span> Load dữ liệu'; allData = []; staffFilteredData = []; changedRows = new Set(); if (response.error || !Array.isArray(response.rows)) { showError('Lỗi hoặc không có dữ liệu: ' + (response.error || 'Định dạng dữ liệu không đúng')); return; } allData = response.rows; const staffId = getUrlParameter('id'); if (!staffId) { showError('Thiếu tham số ID nhân viên trong URL'); return; } try { currentStaff = await fetchStaffInfo(staffId); let staffInfo = `Nhân viên: ${currentStaff.ho_va_ten}`; staffInfo += (currentStaff.vi_tri === "Leader") ? ` (Leader - Team ${currentStaff.team})` : ` (Nhân viên)`; document.getElementById('userInfo').textContent = staffInfo; filterDataByStaff(); renderHeader(); applyAllFilters(); } catch (error) { showError(error.message); } }
    function filterDataByStaff() { if (!currentStaff) return; staffFilteredData = allData.filter(row => { const deliveryStaff = row["NV Vận đơn"] || row["NV_Vận_đơn"] || ''; if (currentStaff.vi_tri === "Leader") { return teamMembers.includes(deliveryStaff); } else { return deliveryStaff === currentStaff.ho_va_ten; } }); }
    function applyAllFilters() { let dataToFilter = [...staffFilteredData]; const startNum = document.getElementById('startDateFilter').value ? parseInt(document.getElementById('startDateFilter').value.replace(/-/g, ''), 10) : null; const endNum = document.getElementById('endDateFilter').value ? parseInt(document.getElementById('endDateFilter').value.replace(/-/g, ''), 10) : null; if (startNum || endNum) { dataToFilter = dataToFilter.filter(row => { const orderDateStr = row["Ngày lên đơn"] || row["Thời gian lên đơn"]; if (!orderDateStr) return false; const orderDateNum = parseInt(orderDateStr.substring(0, 10).replace(/-/g, ''), 10); if (isNaN(orderDateNum)) return false; if (startNum && orderDateNum < startNum) return false; if (endNum && orderDateNum > endNum) return false; return true; }); } const tableHead = document.getElementById('tableHead'); if (tableHead.querySelector('tr')) { const filters = tableHead.querySelectorAll('.filter-input, .filter-select'); filters.forEach(filter => { const value = filter.value.toLowerCase().trim(); if (value === '') return; const colName = filter.dataset.column; dataToFilter = dataToFilter.filter(row => { let cellValue = row[colName] !== undefined ? row[colName] : row[colName.replace(/ /g, '_')] || ''; return cellValue.toString().toLowerCase().includes(value); }); }); } updateSummary(dataToFilter); renderTableBody(dataToFilter); }
    function updateSummary(data) { const totalOrdersEl = document.getElementById('totalOrders'); const totalRevenueEl = document.getElementById('totalRevenue'); if (!data || data.length === 0) { totalOrdersEl.textContent = '0'; totalRevenueEl.textContent = '0'; return; } const totalOrders = data.length; const totalRevenue = data.reduce((sum, row) => { const revenueString = row["Tổng tiền VNĐ"] || '0'; const revenueNumber = parseFloat(String(revenueString).replace(/[^0-9.-]+/g,"")); return sum + (isNaN(revenueNumber) ? 0 : revenueNumber); }, 0); totalOrdersEl.textContent = totalOrders.toLocaleString('vi-VN'); totalRevenueEl.textContent = totalRevenue.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' }); }
    function setupControls() { document.getElementById('refreshData').addEventListener('click', refreshData); document.getElementById('updateAll').addEventListener('click', updateAllChangedRows); document.getElementById('startDateFilter').addEventListener('change', applyAllFilters); document.getElementById('endDateFilter').addEventListener('change', applyAllFilters); document.getElementById('clearFilters').addEventListener('click', () => { document.getElementById('startDateFilter').value = ''; document.getElementById('endDateFilter').value = ''; document.querySelectorAll('#tableHead .filter-input, #tableHead .filter-select').forEach(f => { f.value = ''; }); applyAllFilters(); }); }
    function refreshData() { document.getElementById('refreshData').innerHTML = '<span class="loading"></span> Đang tải...'; document.getElementById('updateAll').disabled = true; loadData(); setTimeout(() => { document.getElementById('refreshData').innerHTML = '<span class="refresh-icon">↻</span> Load dữ liệu'; document.getElementById('updateAll').disabled = false; }, 5000); }
    function reformatDateForSheet(dateString) { if (typeof dateString !== 'string' || dateString.trim() === '') return dateString; if (/^\d{2}\/\d{2}\/\d{4}$/.test(dateString)) { const parts = dateString.split('/'); return `${parts[2]}-${parts[1]}-${parts[0]}`; } if (/^\d{4}-\d{2}-\d{2}/.test(dateString)) { return dateString.substring(0, 10); } return dateString; }
    function updateAllChangedRows() { if (changedRows.size === 0) { alert('Không có thay đổi nào để cập nhật'); return; } const updateBtn = document.getElementById('updateAll'); const statusEl = document.createElement('span'); statusEl.className = 'status'; statusEl.textContent = 'Đang xử lý...'; updateBtn.appendChild(statusEl); updateBtn.disabled = true; const rowsToSend = []; const tableBody = document.getElementById('tableBody'); changedRows.forEach(rowIndex => { const originalData = staffFilteredData[rowIndex]; if (!originalData) return; const tr = tableBody.querySelector(`tr[data-row-index="${rowIndex}"]`); if(!tr) return; const updatedRow = { ...originalData }; editableCols.forEach(colName => { const colIndex = displayColumns.indexOf(colName); const cell = tr.cells[colIndex]; let value = cell.querySelector('select, input')?.value ?? cell.textContent.trim(); updatedRow[colName] = value; }); updatedRow["Ngày hẹn đẩy đơn"] = reformatDateForSheet(updatedRow["Ngày hẹn đẩy đơn"]); const orderDateSource = updatedRow["Thời gian lên đơn"] || updatedRow["Ngày lên đơn"]; if (orderDateSource) { const formattedDate = reformatDateForSheet(orderDateSource); updatedRow["Ngày lên đơn"] = formattedDate; updatedRow["Thời gian lên đơn"] = formattedDate; } rowsToSend.push(updatedRow); }); if (rowsToSend.length === 0) { statusEl.textContent = 'Không có dòng nào để gửi.'; setTimeout(() => { updateBtn.removeChild(statusEl); updateBtn.disabled = false; }, 3000); return; } fetch(POST_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: new URLSearchParams({ rows: JSON.stringify(rowsToSend) }) }).then(() => { statusEl.textContent = `Đã gửi ${rowsToSend.length} thay đổi. Đang chờ xác nhận...`; setTimeout(() => { alert(`Cập nhật thành công ${rowsToSend.length} dòng. Vui lòng nhấn "Load dữ liệu" để xem thay đổi.`); changedRows.clear(); document.querySelectorAll('.highlight').forEach(cell => cell.classList.remove('highlight')); updateBtn.removeChild(statusEl); updateBtn.disabled = false; }, 2000); }).catch(e => { statusEl.textContent = 'Lỗi mạng: ' + e.message; statusEl.classList.add('error-status'); setTimeout(() => { updateBtn.removeChild(statusEl); updateBtn.disabled = false; }, 4000); }); }
    function loadData() { const container = document.getElementById('tableBody'); const colCount = displayColumns.length > 0 ? displayColumns.length : 10; container.innerHTML = `<tr><td colspan="${colCount}" style="text-align: center; padding: 20px;">Đang tải dữ liệu...</td></tr>`; const script = document.createElement('script'); script.src = `${POST_URL}?callback=handleData&rand=${Math.random()}`; const oldScript = document.querySelector('script[src^="https://script.google.com"]'); if (oldScript) oldScript.remove(); document.body.appendChild(script); }
    let isMouseDown = false; let startCell = null; let endCell = null; function getCellValue(cell) { if (!cell) return ''; const input = cell.querySelector('input, select'); if (input) { return input.value; } return cell.textContent.trim(); } function updateSelection(start, end) { document.querySelectorAll('td.cell-selected').forEach(c => c.classList.remove('cell-selected')); if (!start || !end) return; const table = document.querySelector('#tableBody'); const startRowIndex = start.parentElement.rowIndex; const startColIndex = start.cellIndex; const endRowIndex = end.parentElement.rowIndex; const endColIndex = end.cellIndex; const minRow = Math.min(startRowIndex, endRowIndex); const maxRow = Math.max(startRowIndex, endRowIndex); const minCol = Math.min(startColIndex, endColIndex); const maxCol = Math.max(startColIndex, endColIndex); const firstRowAbsIndex = table.rows[0].rowIndex; for (let i = minRow; i <= maxRow; i++) { const row = table.rows[i - firstRowAbsIndex]; if (!row) continue; for (let j = minCol; j <= maxCol; j++) { const cell = row.cells[j]; if (cell) cell.classList.add('cell-selected'); } } }
    function handleCopy(e) { const selectedCells = document.querySelectorAll('td.cell-selected'); if (selectedCells.length === 0) return; e.preventDefault(); const dataGrid = {}; selectedCells.forEach(cell => { const rowIndex = cell.parentElement.rowIndex; const colIndex = cell.cellIndex; if (!dataGrid[rowIndex]) dataGrid[rowIndex] = {}; dataGrid[rowIndex][colIndex] = getCellValue(cell); }); let clipboardData = ''; const sortedRows = Object.keys(dataGrid).sort((a, b) => a - b); sortedRows.forEach(rowIndex => { const rowData = dataGrid[rowIndex]; const sortedCols = Object.keys(rowData).sort((a, b) => a - b); clipboardData += sortedCols.map(colIndex => rowData[colIndex]).join('\t') + '\n'; }); navigator.clipboard.writeText(clipboardData).then(() => { const tableBody = document.getElementById('tableBody'); tableBody.classList.add('copy-flash'); setTimeout(() => tableBody.classList.remove('copy-flash'), 500); }); }
    function setupSelectionEvents() { const tableBody = document.getElementById('tableBody'); tableBody.addEventListener('mousedown', e => { if (e.target.tagName === 'TD') { isMouseDown = true; startCell = e.target; endCell = e.target; updateSelection(startCell, endCell); e.preventDefault(); } }); tableBody.addEventListener('mouseover', e => { if (isMouseDown && e.target.tagName === 'TD') { endCell = e.target; updateSelection(startCell, endCell); } }); document.addEventListener('mouseup', () => { isMouseDown = false; }); document.addEventListener('copy', handleCopy); }
  </script>
</body>
</html>

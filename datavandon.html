<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>DANH SÁCH ĐƠN HÀNG</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      background-color: #f5f5f5;
      color: #333;
      margin: 0;
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #2c3e50;
    }
    .controls {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      align-items: center;
      background: #fff;
      padding: 10px 15px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
      flex-wrap: wrap; /* Cho phép wrap trên màn hình nhỏ */
    }
    .controls .left-controls, .controls .right-controls {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .date-filter {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    .date-filter input[type="date"] {
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 13px;
    }
    .table-wrapper {
      position: relative;
      overflow: auto;
      max-height: 75vh;
      background: white;
      border-radius: 0 0 5px 5px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 2000px;
      font-size: 14px;
    }
    thead {
      position: sticky;
      top: 0;
      z-index: 10;
    }
    th, td {
      border: 1px solid #e0e0e0;
      padding: 8px 12px;
      text-align: left;
      white-space: nowrap;
      background-color: white;
    }
    th {
      background-color: #3498db;
      color: white;
      position: sticky;
      top: 0;
      z-index: 20;
      font-weight: 500;
      vertical-align: top;
    }
    th .filter-input, th .filter-select {
        width: 100%;
        margin-top: 5px;
        padding: 4px;
        font-size: 12px;
        border: 1px solid #ccc;
        border-radius: 3px;
    }
    td.editable {
      background-color: #fffbe8;
    }
    td select, td input.date-input {
        width: 100%;
        padding: 6px;
        border: none;
        background: transparent;
        font-family: inherit;
        font-size: inherit;
    }
    button {
      padding: 6px 12px;
      cursor: pointer;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 13px;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #2980b9;
    }
    .status {
      font-size: 0.85em;
      margin-left: 8px;
      color: #27ae60;
    }
    .error-status {
      color: #e74c3c;
    }
    .highlight {
      background-color: #ffeb3b !important;
    }
    .no-data {
      text-align: center;
      padding: 20px;
      color: #7f8c8d;
      font-style: italic;
    }
    .refresh-btn {
      background-color: #2ecc71;
    }
    .refresh-btn:hover {
      background-color: #27ae60;
    }
    .clear-filter-btn {
      background-color: #f39c12;
    }
    .clear-filter-btn:hover {
      background-color: #e67e22;
    }
    .refresh-icon {
      margin-right: 5px;
    }
    .fixed-column {
      position: sticky;
      left: 0;
      z-index: 5;
    }
    th.fixed-column {
      z-index: 30;
      background-color: #3498db;
    }
    td.fixed-column {
      background-color: #f9f9f9;
    }
    #userInfo {
      font-weight: bold;
      margin-right: 15px;
    }
  </style>
</head>
<body>
  <h2>QUẢN LÝ VẬN ĐƠN</h2>
  
  <div class="controls">
    <div class="left-controls">
      <span id="userInfo"></span>
      <button id="refreshData" class="refresh-btn">
        <span class="refresh-icon">↻</span> Load dữ liệu
      </button>
      <button id="updateAll">Cập nhật tất cả</button>
    </div>
    <div class="right-controls">
      <div class="date-filter">
          <span>Lọc từ ngày:</span>
          <input type="date" id="startDateFilter">
          <span>Đến ngày:</span>
          <input type="date" id="endDateFilter">
      </div>
      <button id="clearFilters" class="clear-filter-btn">Xóa bộ lọc</button>
    </div>
  </div>
  
  <div class="table-wrapper" id="tableContainer">
    <table>
      <thead id="tableHead">
        <!-- Header sẽ được tạo bằng JS -->
      </thead>
      <tbody id="tableBody">
        <!-- Dữ liệu sẽ được thêm vào đây -->
      </tbody>
    </table>
  </div>

  <script>
    const POST_URL = 'https://script.google.com/macros/s/AKfycbx2sX3QXh2ltziVv2jXwjN4VnQxBGhLNALK2QjT6PSuq7RSuwzWa2MuHsbOe6dd9DnW/exec';
    
    const editableCols = [
        "Kết quả Check", "Trạng thái giao hàng NB", "Lý do", "Trạng thái thu tiền",
        "Ngày hẹn đẩy đơn", "Loại thanh toán", "Tên người chuyển khoản"
    ];

    const dropdownCols = {
        "Kết quả Check": ["", "OK", "Huỷ", "Treo", "Vận đơn XL", "Đợi hàng", "Khách hẹn"],
        "Trạng thái giao hàng NB": ["", "Giao Thành Công", "Đang Giao", "Chưa Giao", "Hủy", "Hoàn", "chờ check", "Giao không thành công", "Bom_Thất Lạc"],
        "Trạng thái thu tiền": ["", "Có bill", "Có bill 1 phần", "Bom_bùng_chặn", "Hẹn Thanh Toán", "Hoàn Hàng", "Khó Đòi", "Không nhận được hàng", "Không PH dưới 3N", "Thanh toán phí hoàn", "KPH nhiều ngày"]
    };

    const displayColumns = [
      "Mã đơn hàng", ...editableCols, "Ngày lên đơn", "Name*", "Phone*", "Add", "City", 
      "State", "Zipcode", "Mặt hàng", "Tên mặt hàng 1", "Số lượng mặt hàng 1", "Tên mặt hàng 2", 
      "Số lượng mặt hàng 2", "Quà tặng", "Số lượng quà kèm", "Giá bán", "Loại tiền thanh toán", 
      "Tổng tiền VNĐ", "Hình thức thanh toán", "Ghi chú", "Mã Tracking", "Ngày đóng hàng", 
      "Trạng thái giao hàng", "Thời gian giao dự kiến", "Phí ship nội địa Mỹ (usd)", 
      "Phí xử lý đơn đóng hàng-Lưu kho(usd)", "GHI CHÚ", "Nhân viên Sale", "NV Vận đơn", "Đơn vị vận chuyển"
    ];
    
    let allData = [];
    let staffFilteredData = [];
    let changedRows = new Set();
    let currentStaff = null;
    let teamMembers = [];

    function getUrlParameter(name) {
      name = name.replace(/[\[\]]/g, '\\$&');
      const regex = new RegExp('[?&]'_name _ '(=([^&#]*)|&|#|$)');
      const results = regex.exec(window.location.href);
      if (!results) return null;
      if (!results[2]) return '';
      return decodeURIComponent(results[2].replace(/\+/g, ' '));
    }

    async function fetchStaffInfo(idns) {
      try {
        const staffApiUrl = 'https://script.google.com/macros/s/AKfycbzwOv7UFwrqzf88QJL1QrxLKcnnnSIQ_PSmF0SO8LboqWI5li3vF3W8_-8s-A8lNGaR/exec';
        const response = await fetch(staffApiUrl, { cache: "no-store" });
        if (!response.ok) throw new Error('Lỗi mạng khi tải data nhân viên');
        const data = await response.json();
        const staffMember = data.find(staff => String(staff.idnv) === idns);
        if (!staffMember) throw new Error(`Không tìm thấy nhân viên với ID: ${idns}`);
        if (staffMember.vi_tri === "Leader") {
          const teamName = staffMember.team;
          teamMembers = data.filter(member => member.team === teamName).map(member => member.ho_va_ten);
        }
        return staffMember;
      } catch (error) { 
        showError(error.message); 
        throw error; 
      }
    }

    function showError(message) {
      const container = document.getElementById('tableBody');
      container.innerHTML = `<tr><td colspan="${displayColumns.length}" class="no-data">${message}</td></tr>`;
    }

    function formatDate(dateString) {
        if (!dateString) return '';
        const str = String(dateString);
        if (/^\d{4}-\d{2}-\d{2}/.test(str)) {
            const datePart = str.substring(0, 10);
            const [year, month, day] = datePart.split('-');
            if (day && month && year) return `${day}/${month}/${year}`;
        }
        try {
            const date = new Date(str);
            if (isNaN(date.getTime())) return str;
            const day = String(date.getUTCDate()).padStart(2, '0');
            const month = String(date.getUTCMonth() + 1).padStart(2, '0');
            const year = date.getUTCFullYear();
            return `${day}/${month}/${year}`;
        } catch (e) {
            return str;
        }
    }

    async function handleData(response) {
      document.getElementById('refreshData').innerHTML = '<span class="refresh-icon">↻</span> Load dữ liệu';
      allData = []; staffFilteredData = []; changedRows = new Set();
      
      if (response.error || !Array.isArray(response.rows)) {
        showError('Lỗi hoặc không có dữ liệu: ' _ (response.error || 'Định dạng dữ liệu không đúng'));
        return;
      }
      allData = response.rows;
      
      const staffId = getUrlParameter('id');
      if (!staffId) {
        showError('Thiếu tham số ID nhân viên trong URL');
        return;
      }
      
      try {
        currentStaff = await fetchStaffInfo(staffId);
        let staffInfo = `Nhân viên: ${currentStaff.ho_va_ten}`;
        staffInfo += (currentStaff.vi_tri === "Leader") ? ` (Leader - Team ${currentStaff.team})` : ` (Nhân viên)`;
        document.getElementById('userInfo').textContent = staffInfo;
        
        filterDataByStaff();
        renderHeader();
        applyAllFilters();
      } catch (error) {
        showError(error.message);
      }
    }

    function filterDataByStaff() {
      if (!currentStaff) return;
      staffFilteredData = allData.filter(row => {
        const deliveryStaff = row["NV Vận đơn"] || row["NV_Vận_đơn"] || '';
        if (currentStaff.vi_tri === "Leader") {
          return teamMembers.includes(deliveryStaff);
        } else {
          return deliveryStaff === currentStaff.ho_va_ten;
        }
      });
    }

    function applyAllFilters() {
        let dataToFilter = [...staffFilteredData];
        const tableHead = document.getElementById('tableHead');
        if (!tableHead.querySelector('tr')) return;

        const startDate = document.getElementById('startDateFilter').value;
        const endDate = document.getElementById('endDateFilter').value;
        if (startDate || endDate) {
            const start = startDate ? new Date(startDate) : null;
            const end = endDate ? new Date(endDate) : null;
            if(start) start.setHours(0,0,0,0);
            if(end) end.setHours(23,59,59,999);

            dataToFilter = dataToFilter.filter(row => {
                const orderDateStr = row["Ngày lên đơn"] || row["Thời gian lên đơn"];
                if (!orderDateStr) return false;
                const orderDate = new Date(orderDateStr);
                 if (isNaN(orderDate.getTime())) return false;
                if (start && orderDate < start) return false;
                if (end && orderDate > end) return false;
                return true;
            });
        }

        const filters = tableHead.querySelectorAll('.filter-input, .filter-select');
        filters.forEach(filter => {
            const value = filter.value.toLowerCase().trim();
            if (value === '') return;
            const colName = filter.dataset.column;
            dataToFilter = dataToFilter.filter(row => {
                 let cellValue = row[colName] !== undefined ? row[colName] : row[colName.replace(/ /g, '_')] || '';
                 return cellValue.toString().toLowerCase().includes(value);
            });
        });

        renderTableBody(dataToFilter);
    }
    
    function renderHeader() {
        const header = document.getElementById('tableHead');
        header.innerHTML = '';
        const tr = document.createElement('tr');
        displayColumns.forEach(colName => {
            const th = document.createElement('th');
            th.textContent = colName;
            if (colName === "Mã đơn hàng") th.classList.add('fixed-column');
            let filterElement;
            if (dropdownCols[colName]) {
                filterElement = document.createElement('select');
                filterElement.className = 'filter-select';
                dropdownCols[colName].forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt;
                    option.textContent = opt || '(Tất cả)';
                    filterElement.appendChild(option);
                });
                filterElement.addEventListener('change', applyAllFilters);
            } else {
                filterElement = document.createElement('input');
                filterElement.type = 'text';
                filterElement.className = 'filter-input';
                filterElement.placeholder = `Lọc ${colName}...`;
                filterElement.addEventListener('input', applyAllFilters);
            }
            filterElement.dataset.column = colName;
            th.appendChild(document.createElement('br'));
            th.appendChild(filterElement);
            tr.appendChild(th);
        });
        header.appendChild(tr);
    }

    function renderTableBody(data) {
      const container = document.getElementById('tableBody');
      container.innerHTML = '';
      if (data.length === 0) {
        showError(`Không có đơn hàng nào khớp với bộ lọc.`);
        return;
      }
      data.forEach((row) => {
        const originalRowIndex = staffFilteredData.indexOf(row);
        const tr = document.createElement('tr');
        tr.dataset.rowIndex = originalRowIndex;
        
        displayColumns.forEach(col => {
          const td = document.createElement('td');
          let value = row[col] !== undefined ? row[col] : row[col.replace(/ /g, '_')] || '';
          
          if (col === "Ngày lên đơn") {
              const dateSource = row["Ngày lên đơn"] || row["Thời gian lên đơn"];
              value = formatDate(dateSource);
          } else if (["Ngày đóng hàng", "Ngày hẹn đẩy đơn"].includes(col)) {
              value = formatDate(value);
          }
          
          if (col === "Mã đơn hàng") td.classList.add('fixed-column');
          
          if (editableCols.includes(col)) {
            td.classList.add('editable');
            if (dropdownCols[col]) {
              const select = document.createElement('select');
              dropdownCols[col].forEach(opt => select.add(new Option(opt, opt)));
              select.value = value;
              select.addEventListener('change', () => {
                td.classList.add('highlight');
                changedRows.add(originalRowIndex);
              });
              td.appendChild(select);
            } else if (col === "Ngày hẹn đẩy đơn") {
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'date-input';
                input.placeholder = 'dd/mm/yyyy';
                input.value = value;
                input.addEventListener('input', () => {
                    td.classList.add('highlight');
                    changedRows.add(originalRowIndex);
                });
                td.appendChild(input);
            } else {
              td.contentEditable = 'true';
              td.textContent = value;
              td.addEventListener('input', () => {
                td.classList.add('highlight');
                changedRows.add(originalRowIndex);
              });
            }
          } else {
            td.textContent = value;
          }
          tr.appendChild(td);
        });
        container.appendChild(tr);
      });
    }

    function setupControls() {
      document.getElementById('refreshData').addEventListener('click', refreshData);
      document.getElementById('updateAll').addEventListener('click', updateAllChangedRows);
      document.getElementById('startDateFilter').addEventListener('change', applyAllFilters);
      document.getElementById('endDateFilter').addEventListener('change', applyAllFilters);
      document.getElementById('clearFilters').addEventListener('click', () => {
          document.getElementById('startDateFilter').value = '';
          document.getElementById('endDateFilter').value = '';
          document.querySelectorAll('#tableHead .filter-input, #tableHead .filter-select').forEach(f => f.value = '');
          applyAllFilters();
      });
    }

    function refreshData() {
      document.getElementById('refreshData').innerHTML = '<span class="loading"></span> Đang tải...';
      loadData();
    }

    function loadData() {
      const container = document.getElementById('tableBody');
      container.innerHTML = `<tr><td colspan="${displayColumns.length}" style="text-align: center; padding: 20px;">Đang tải dữ liệu...</td></tr>`;
      const script = document.createElement('script');
      script.src = `https://script.google.com/macros/s/AKfycbx2sX3QXh2ltziVv2jXwjN4VnQxBGhLNALK2QjT6PSuq7RSuwzWa2MuHsbOe6dd9DnW/exec?callback=handleData&rand=${Math.random()}`;
      const oldScript = document.querySelector('script[src^="https://script.google.com"]');
      if (oldScript) oldScript.remove();
      document.body.appendChild(script);
    }
    
    function reformatDateForSheet(dateString) {
      if (typeof dateString !== 'string' || dateString.trim() === '') return dateString;
      if (/^\d{2}\/\d{2}\/\d{4}$/.test(dateString)) {
        const parts = dateString.split('/');
        return `${parts[2]}-${parts[1]}-${parts[0]}`;
      }
      if (/^\d{4}-\d{2}-\d{2}/.test(dateString)) {
        return dateString.substring(0, 10);
      }
      const formatted = formatDate(dateString);
      if (/^\d{2}\/\d{2}\/\d{4}$/.test(formatted)) {
        const parts = formatted.split('/');
        return `${parts[2]}-${parts[1]}-${parts[0]}`;
      }
      return dateString;
    }

    function updateAllChangedRows() {
      if (changedRows.size === 0) {
        alert('Không có thay đổi nào để cập nhật');
        return;
      }
      const updateBtn = document.getElementById('updateAll');
      const statusEl = document.createElement('span');
      statusEl.className = 'status';
      statusEl.textContent = 'Đang xử lý...';
      updateBtn.appendChild(statusEl);
      
      const rowsToSend = [];
      const tableBody = document.getElementById('tableBody');
      changedRows.forEach(rowIndex => {
        const originalData = staffFilteredData[rowIndex];
        if (!originalData) return;
        
        const tr = tableBody.querySelector(`tr[data-row-index="${rowIndex}"]`);
        if(!tr) return;

        const updatedRow = { ...originalData }; 
        
        editableCols.forEach(colName => {
            const colIndex = displayColumns.indexOf(colName);
            const cell = tr.cells[colIndex];
            let value = cell.querySelector('select, input')?.value ?? cell.textContent.trim();
            updatedRow[colName] = value;
        });

        const dateColumnsToNormalize = ["Ngày lên đơn", "Ngày đóng hàng", "Ngày hẹn đẩy đơn", "Thời gian lên đơn"];
        dateColumnsToNormalize.forEach(col => {
            // Lấy nguồn ngày đúng để chuẩn hóa
            let sourceDate = updatedRow[col];
            if(col === "Ngày lên đơn" || col === "Thời gian lên đơn"){
                sourceDate = updatedRow["Thời gian lên đơn"] || updatedRow["Ngày lên đơn"];
            }

            if (sourceDate) {
                updatedRow[col] = reformatDateForSheet(sourceDate);
            }
        });

        rowsToSend.push(updatedRow);
      });

      if (rowsToSend.length === 0) {
        statusEl.textContent = 'Không có dòng nào để gửi.';
        setTimeout(() => updateBtn.removeChild(statusEl), 3000);
        return;
      }

      fetch(POST_URL, {
        method: 'POST', 
        mode: 'cors', 
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ rows: JSON.stringify(rowsToSend) })
      })
      .then(r => r.json())
      .then(json => {
        if (json.message) {
          statusEl.textContent = `Thành công: ${json.message}`;
          changedRows.clear();
          rowsToSend.forEach(sentRow => {
              const trToClear = Array.from(tableBody.rows).find(r => r.cells[0].textContent === sentRow["Mã đơn hàng"]);
              if(trToClear) {
                  trToClear.querySelectorAll('.highlight').forEach(cell => cell.classList.remove('highlight'));
              }
          });
        } else {
          statusEl.textContent = json.error || 'Cập nhật lỗi';
          statusEl.classList.add('error-status');
        }
        setTimeout(() => updateBtn.removeChild(statusEl), 4000);
      })
      .catch(e => {
        statusEl.textContent = 'Lỗi: ' _ e.message;
        statusEl.classList.add('error-status');
        setTimeout(() => updateBtn.removeChild(statusEl), 4000);
      });
    }

    setupControls();
    loadData();
  </script>
</body>
</html>

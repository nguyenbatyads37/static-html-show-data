<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <title>QUẢN LÝ VẬN ĐƠN</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      background-color: #f5f5f5;
      color: #333;
      margin: 0;
    }

    h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #2c3e50;
    }

    .controls {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      align-items: center;
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 100;
      flex-wrap: wrap;
      gap: 15px;
      transition: box-shadow 0.3s ease;
    }

    .controls .left-controls,
    .controls .right-controls {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }

    .controls .date-filter,
    .controls .fixed-col-control {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .controls button:not(.tab-btn) {
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      font-size: 18px;
      color: white;
      background-color: #27ae60;
      /* THEME COLOR */
      transition: all 0.2s ease-in-out;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .controls button:not(.tab-btn):hover {
      background-color: #229954;
      /* THEME COLOR HOVER */
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .controls .filter-input,
    .controls .filter-select,
    .controls input[type="date"],
    .controls input[type="number"] {
      padding: 10px 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 18px;
      background-color: white;
    }

    .controls .date-filter span,
    .controls .fixed-col-control span {
      font-size: 18px;
    }

    #userInfo,
    .japan-tab-info {
      font-size: 18px;
      font-weight: bold;
    }

    .tab-controls {
      display: flex;
      border: 1px solid #ccc;
      border-radius: 5px;
      overflow: hidden;
      margin-left: 20px;
      margin-bottom: 15px;
    }

    .tab-btn {
      background-color: #f1f1f1;
      border: none;
      padding: 12px 22px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: all 0.2s ease-in-out;
    }

    .tab-btn:hover {
      background-color: #e0e0e0;
    }

    .tab-btn.active {
      background-color: #27ae60;
      /* THEME COLOR */
      color: white;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .content-tab {
      display: none;
    }

    .content-tab.active {
      display: block;
    }

    .table-wrapper {
      position: relative;
      overflow: auto;
      max-height: 75vh;
      background: white;
      border-radius: 5px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      margin-top: 20px;
    }

    .main-table-wrapper {
      overflow-x: scroll;
      overflow-y: auto;
      max-height: calc(100vh - 200px);
    }

    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 2200px;
      font-size: 11px;
      font-weight: bold;
    }

    thead {
      position: sticky;
      top: 0;
      z-index: 10;
    }

    th,
    td {
      border: 1px solid #e0e0e0;
      padding: 6px 10px;
      white-space: nowrap;
      background-color: white;
      text-align: left;
    }

    th {
      background-color: #27ae60;
      /* THEME COLOR */
      color: white;
      font-weight: 500;
      vertical-align: top;
      position: sticky;
      top: 0;
      z-index: 20;
    }

    th .filter-input,
    th .filter-select {
      width: 100%;
      margin-top: 5px;
      padding: 6px 4px;
      font-size: 12px;
      border: 1px solid #ccc;
      border-radius: 3px;
    }

    td.editable {
      background-color: #fffbe8;
    }

    td.editable.has-dropdown {
      cursor: pointer;
    }

    td select,
    td input.date-input {
      width: 100%;
      height: 100%;
      padding: 4px;
      border: none;
      background: transparent;
      font-family: inherit;
      font-size: inherit;
      font-weight: inherit;
      cursor: pointer;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      text-indent: 1px;
      text-overflow: '';
    }

    button {
      cursor: pointer;
      border: none;
      transition: background-color 0.3s;
    }

    .update-btn {
      background-color: #3498db;
    }

    .update-btn:hover {
      background-color: #2980b9;
    }

    .refresh-btn {
      background-color: #2ecc71;
    }

    .refresh-btn:hover {
      background-color: #27ae60;
    }

    .clear-filter-btn {
      background-color: #f39c12;
    }

    .clear-filter-btn:hover {
      background-color: #e67e22;
    }

    .status {
      font-size: 0.85em;
      margin-left: 8px;
      color: #27ae60;
    }

    .error-status {
      color: #e74c3c;
    }

    .highlight {
      background-color: #ffeb3b !important;
    }

    .no-data {
      text-align: center;
      padding: 20px;
      color: #7f8c8d;
      font-style: italic;
      font-size: 16px;
    }

    .refresh-icon {
      margin-right: 5px;
    }

    .fixed-column {
      position: sticky;
      z-index: 5;
    }

    th.fixed-column {
      z-index: 30;
      background-color: #27ae60;
    }

    td.fixed-column {
      background-color: #f9f9f9;
    }

    .summary-info {
      background: #e3f2fd;
      padding: 8px 15px;
      border-radius: 4px;
      margin-left: 10px;
      font-weight: bold;
      font-size: 18px;
    }

    .cell-selected {
      background-color: #a7ffeb !important;
      outline: 2px solid #00bfa5;
      outline-offset: -2px;
    }

    #tableBody tr:hover td,
    #japanTableBody tr:hover td {
      background-color: #f1f1f1 !important;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .cell-ok {
      background-color: #e8f5e9 !important;
    }

    .cell-cancel {
      background-color: #ffebee !important;
    }

    .cell-xl {
      background-color: #fffde7 !important;
    }

    .summary-table {
      width: 100%;
      margin-bottom: 20px;
      background: white;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      font-size: 13px;
    }

    .summary-table th {
      background-color: #2c3e50;
      position: sticky;
      top: 0;
    }

    .summary-table td {
      text-align: center;
    }

    .positive {
      color: #27ae60;
      font-weight: bold;
    }

    .negative {
      color: #e74c3c;
      font-weight: bold;
    }

    .summary-staff-header td {
      background-color: #ecf0f1 !important;
      font-weight: bold;
      text-align: left !important;
      color: #2c3e50;
    }

    .summary-staff-total td {
      background-color: #fff9c4 !important;
      font-weight: bold;
      color: #5d4037;
    }

    .summary-grand-total td {
      background-color: #ffeb3b !important;
      font-weight: bold;
      color: #3e2723;
    }

    ::-webkit-scrollbar {
      -webkit-appearance: none;
      height: 15px;
      width: 15px;
    }

    ::-webkit-scrollbar-thumb {
      border-radius: 5px;
      background-color: #27ae60;
      border: 2px solid #f5f5f5;
    }

    ::-webkit-scrollbar-thumb:hover {
      background-color: #229954;
    }

    td select,
    .controls .filter-select,
    th .filter-select {
      background-color: #e0f2f1;
      border: 1px solid #b2dfdb;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s, box-shadow 0.2s;
    }

    td select:hover,
    .controls .filter-select:hover,
    th .filter-select:hover {
      background-color: #b2dfdb;
    }

    td select:focus,
    .controls .filter-select:focus,
    th .filter-select:focus {
      outline: none;
      border-color: #27ae60;
      box-shadow: 0 0 0 2px rgba(39, 174, 96, 0.4);
    }

    td.editing {
      padding: 0;
    }

    td.editing input {
      width: 100%;
      height: 100%;
      border: 2px solid #27ae60;
      padding: 4px;
      box-sizing: border-box;
      font-family: inherit;
      font-size: inherit;
      font-weight: inherit;
    }

    .multi-select-container {
      position: relative;
      display: inline-block;
    }

    .multi-select-container button {
      background-color: white;
      color: #333;
      border: 1px solid #ccc;
      font-size: 18px;
      padding: 10px 15px;
      text-align: left;
      width: 250px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .checkbox-dropdown {
      display: none;
      position: absolute;
      background-color: #f9f9f9;
      min-width: 250px;
      box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
      z-index: 101;
      border: 1px solid #ddd;
      border-radius: 5px;
      max-height: 300px;
      overflow-y: auto;
      padding: 10px;
    }

    .checkbox-dropdown.show {
      display: block;
    }

    .checkbox-dropdown label {
      display: block;
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 4px;
      transition: background-color 0.2s;
    }

    .checkbox-dropdown label:hover {
      background-color: #f1f1f1;
    }

    .checkbox-dropdown label input {
      margin-right: 10px;
    }
  </style>
</head>

<body>
  <h2>QUẢN LÝ VẬN ĐƠN</h2>

  <div class="tab-controls">
    <button id="tabData" class="tab-btn active">Dữ liệu đơn hàng</button>
    <button id="tabJapan" class="tab-btn">Đơn Nhật</button>
    <button id="tabReport" class="tab-btn">Báo cáo tổng kết</button>
  </div>

  <div id="contentData" class="content-tab active">
    <div class="controls">
      <div class="left-controls">
        <span id="userInfo"></span>
        <button id="refreshData" class="refresh-btn"><span class="refresh-icon">↻</span> Load</button>
        <button id="updateAll" class="update-btn">Cập nhật</button>
        <div class="fixed-col-control">
          <span>Cột cố định:</span>
          <input type="number" id="fixedColumnCountInput" value="1" min="0" style="width: 70px;">
        </div>
        <div id="summaryInfo" class="summary-info"></div>
        <div id="selectionSummary" class="summary-info" style="background-color: #e8f5e9; border: 1px solid #a5d6a7;">
        </div>
      </div>
      <div class="right-controls">
        <div class="date-filter">
          <span>Từ:</span><input type="date" id="startDateFilter" />
          <span>Đến:</span><input type="date" id="endDateFilter" />
        </div>
        <select id="productFilter" class="filter-select">
          <option value="">Tất cả sản phẩm</option>
        </select>
        <select id="marketFilter" class="filter-select">
          <option value="">Tất cả khu vực</option>
        </select>
        <button id="clearFilters" class="clear-filter-btn">Xóa lọc</button>
      </div>
    </div>
    <div class="main-table-wrapper" id="tableContainer">
      <table>
        <thead id="tableHead"></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>

  <div id="contentJapan" class="content-tab">
    <div class="controls">
      <div class="left-controls">
        <span class="japan-tab-info">Đơn hàng khu vực: Nhật Bản</span>
        <button id="japanRefreshData" class="refresh-btn"><span class="refresh-icon">↻</span> Load</button>
        <button id="japanUpdateAll" class="update-btn">Cập nhật</button>
        <div id="japanSummaryInfo" class="summary-info"></div>
      </div>
      <div class="right-controls">
        <div class="date-filter">
          <span>Từ:</span><input type="date" id="japanStartDateFilter" />
          <span>Đến:</span><input type="date" id="japanEndDateFilter" />
        </div>
        <select id="japanProductFilter" class="filter-select">
          <option value="">Sản phẩm</option>
        </select>
        <select id="japanStaffFilter" class="filter-select">
          <option value="">NV Vận đơn</option>
        </select>
        <button id="japanClearFilters" class="clear-filter-btn">Xóa lọc</button>
      </div>
    </div>
    <div class="main-table-wrapper" id="japanTableContainer">
      <table>
        <thead id="japanTableHead"></thead>
        <tbody id="japanTableBody"></tbody>
      </table>
    </div>
  </div>

  <div id="contentReport" class="content-tab">
    <div class="controls">
      <div class="left-controls">
        <span style="font-weight: bold; font-size: 18px;">Tùy chọn Báo cáo</span>
      </div>
      <div class="right-controls">
        <div class="date-filter">
          <span>Từ:</span><input type="date" id="reportStartDateFilter" />
          <span>Đến:</span><input type="date" id="reportEndDateFilter" />
        </div>
        <div class="multi-select-container">
          <button id="reportStaffFilterBtn">Tất cả NV Vận đơn</button>
          <div id="reportStaffDropdown" class="checkbox-dropdown">
          </div>
        </div>
        <select id="reportProductFilter" class="filter-select">
          <option value="">Tất cả sản phẩm</option>
        </select>
        <select id="reportMarketFilter" class="filter-select">
          <option value="">Tất cả khu vực</option>
        </select>
        <button id="reportClearFilters" class="clear-filter-btn">Xóa lọc</button>
      </div>
    </div>
    <div class="table-wrapper">
      <table class="summary-table">
        <thead>
          <tr>
            <th rowspan="2">NV Vận đơn</th>
            <th rowspan="2">Đơn vị vận chuyển</th>
            <th colspan="2">Đã Thanh Toán (có bill)</th>
            <th rowspan="2">Bill 1 phần</th>
            <th rowspan="2">Tổng đơn lên nội bộ</th>
            <th rowspan="2">Tổng đơn đủ đkien đẩy vh</th>
            <th rowspan="2">Tổng đơn lên vận hành</th>
            <th rowspan="2">Tỷ lệ đơn lên vận hành</th>
            <th rowspan="2">Giao Thành Công</th>
            <th rowspan="2">Đang Giao</th>
            <th rowspan="2">Chưa Giao</th>
            <th rowspan="2">Hoàn</th>
            <th rowspan="2">chờ check</th>
            <th rowspan="2">Trống trạng thái</th>
            <th rowspan="2">Tỷ lệ thu tiền/giao thành công</th>
            <th rowspan="2">Tỷ lệ đơn tính phí vc</th>
          </tr>
          <tr>
            <th>Số đơn</th>
            <th>Thành Tiền</th>
          </tr>
        </thead>
        <tbody id="summaryTableBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    const POST_URL = 'https://script.google.com/macros/s/AKfycbwngDNc5r-P5mkm0v55M2I1Dq68__mv0SeJGkbbqz733WIiFRO9kGinWbbO-30DwtPd/exec';

    // === CẤU HÌNH CỘT ===
    const columnDisplayMapping = {};
    const editableCols = ["Kết quả Check", "Trạng thái giao hàng NB", "Lý do", "Trạng thái thu tiền", "Ghi chú của VĐ"];
    const dropdownCols = {
      "Kết quả Check": ["", "OK", "Huỷ", "Treo", "Vận đơn XL", "Đợi hàng", "Khách hẹn"],
      "Trạng thái giao hàng NB": ["", "Giao Thành Công", "Đang Giao", "Chưa Giao", "Hủy", "Hoàn", "chờ check", "Giao không thành công", "Bom_Thất Lạc"],
      "Trạng thái thu tiền": ["", "Có bill", "Có bill 1 phần", "Bom_bùng_chặn", "Hẹn Thanh Toán", "Hoàn Hàng", "Khó Đòi", "Không nhận được hàng", "Không PH dưới 3N", "Thanh toán phí hoàn", "KPH nhiều ngày"]
    };
    const displayColumns = ["Mã đơn hàng", "Kết quả Check", "Trạng thái giao hàng NB", "Mã Tracking", "Lý do", "Trạng thái thu tiền", "Ghi chú của VĐ", "Ngày lên đơn", "Name*", "Phone*", "Add", "City", "State", "khu vực", "Zipcode", "Mặt hàng", "Tên mặt hàng 1", "Số lượng mặt hàng 1", "Tên mặt hàng 2", "Số lượng mặt hàng 2", "Quà tặng", "Số lượng quà kèm", "Giá bán", "Loại tiền thanh toán", "Tổng tiền VNĐ", "Hình thức thanh toán", "Ghi chú", "Ngày đóng hàng", "Trạng thái giao hàng", "Thời gian giao dự kiến", "Phí ship nội địa Mỹ (usd)", "Phí xử lý đơn đóng hàng-Lưu kho(usd)", "GHI CHÚ", "Nhân viên Sale", "NV Vận đơn", "Đơn vị vận chuyển", "Số tiền của đơn hàng đã về TK Cty", "Kế toán xác nhận thu tiền về"];
    const allDateColumns = ["Ngày lên đơn", "Ngày đóng hàng"];
    // === KẾT THÚC CẤU HÌNH ===

    const columnsToMakeDynamic = ["Kết quả Check", "Trạng thái giao hàng NB", "Trạng thái thu tiền", "khu vực", "Mặt hàng", "Nhân viên Sale", "NV Vận đơn", "Đơn vị vận chuyển"];
    let allData = [], staffFilteredData = [], japanData = [], changedRows = new Set(), japanChangedRows = new Set(), currentStaff = null, teamMembers = [], selectedCells = new Set(), isMouseDown = false, startCell = null, dynamicFilterOptions = {}, japanDynamicFilterOptions = {};
    const mainTabConfig = { data: () => staffFilteredData, changedRows: changedRows, controls: { refreshBtn: 'refreshData', updateBtn: 'updateAll', clearBtn: 'clearFilters', startDate: 'startDateFilter', endDate: 'endDateFilter', product: 'productFilter', market: 'marketFilter', summary: 'summaryInfo' }, table: { head: 'tableHead', body: 'tableBody' }, dynamicOptions: () => dynamicFilterOptions };
    const japanTabConfig = { data: () => japanData, changedRows: japanChangedRows, controls: { refreshBtn: 'japanRefreshData', updateBtn: 'japanUpdateAll', clearBtn: 'japanClearFilters', startDate: 'japanStartDateFilter', endDate: 'japanEndDateFilter', product: 'japanProductFilter', staff: 'japanStaffFilter', summary: 'japanSummaryInfo' }, table: { head: 'japanTableHead', body: 'japanTableBody' }, dynamicOptions: () => japanDynamicFilterOptions };
    const reportTabConfig = { controls: { clearBtn: 'reportClearFilters', startDate: 'reportStartDateFilter', endDate: 'reportEndDateFilter', product: 'reportProductFilter', market: 'reportMarketFilter', staffBtn: 'reportStaffFilterBtn', staffDropdown: 'reportStaffDropdown' } };
    function getFixedColumnCount() { const input = document.getElementById('fixedColumnCountInput'); const count = parseInt(input.value, 10); return isNaN(count) || count < 0 ? 0 : count; }
    function handleFixedColumnCountChange() { const newCount = getFixedColumnCount(); const isActiveDataTab = document.getElementById('contentData').classList.contains('active'); const config = isActiveDataTab ? mainTabConfig : japanTabConfig; const tableHead = document.getElementById(config.table.head); const tableBody = document.getElementById(config.table.body); if (!tableHead || !tableBody) return; const allRows = [...tableHead.querySelectorAll('tr'), ...tableBody.querySelectorAll('tr')]; allRows.forEach(row => { for (let i = 0; i < row.cells.length; i++) { const cell = row.cells[i]; if (i < newCount) { cell.classList.add('fixed-column'); } else { cell.classList.remove('fixed-column'); cell.style.left = ''; } } }); updateStickyColumns(config); }
    function updateStickyColumns(config) { const fixedCount = getFixedColumnCount(); if (fixedCount <= 0) return; const tableHead = document.getElementById(config.table.head); const tableBody = document.getElementById(config.table.body); const headerRow = tableHead.querySelector('tr'); if (!headerRow) return; let leftOffset = 0; for (let i = 0; i < fixedCount; i++) { const th = headerRow.cells[i]; if (!th) continue; th.style.left = leftOffset + 'px'; const rows = tableBody.querySelectorAll('tr'); rows.forEach(row => { if (row.cells[i]) { row.cells[i].style.left = leftOffset + 'px'; } }); leftOffset += th.offsetWidth; } }
    function getUrlParameter(name) { name = name.replace(/[\[\]]/g, '\\$&'); const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'); const results = regex.exec(window.location.href); if (!results) return null; if (!results[2]) return ''; return decodeURIComponent(results[2].replace(/\+/g, ' ')); }
    function parseDateString(dateString) { if (!dateString || typeof dateString !== 'string') return null; const cleanedDateString = dateString.trim().replace(/[^\d\/\-\s]/g, ''); if (/^\d{4}-\d{2}-\d{2}/.test(cleanedDateString)) { const d = new Date(cleanedDateString); if (!isNaN(d.getTime())) return d; } const parts = cleanedDateString.match(/^(\d{1,2})[/\-](\d{1,2})[/\-](\d{4})/); if (parts) { const month = parseInt(parts[1], 10); const day = parseInt(parts[2], 10); const year = parseInt(parts[3], 10); if (year > 1000 && month > 0 && month <= 12 && day > 0 && day <= 31) { const d = new Date(Date.UTC(year, month - 1, day)); if (d.getUTCFullYear() === year && d.getUTCMonth() === month - 1) return d; } } return null; }
    function formatDate(dateString) { const originalValue = (typeof dateString === 'string') ? dateString.trim() : ''; if (!originalValue) return { display: '', original: '' }; const dateObj = parseDateString(originalValue); if (dateObj) { const day = String(dateObj.getUTCDate()).padStart(2, '0'); const month = String(dateObj.getUTCMonth() + 1).padStart(2, '0'); const year = dateObj.getUTCFullYear(); return { display: `${day}/${month}/${year}`, original: originalValue }; } return { display: originalValue, original: originalValue }; }
    async function fetchStaffInfo(idns, id1 = null) { try { const staffApiUrl = 'https://script.google.com/macros/s/AKfycbzwOv7UFwrqzf88QJL1QrxLKcnnnSIQ_PSmF0SO8LboqWI5li3vF3W8_-8s-A8lNGaR/exec'; const response = await fetch(staffApiUrl, { cache: "no-store" }); if (!response.ok) throw new Error('Lỗi mạng khi tải data nhân viên'); const data = await response.json(); let staffMember = data.find(staff => String(staff.idnv) === idns); let staffMember1 = id1 ? data.find(staff => String(staff.idnv) === id1) : null; if (!staffMember && !staffMember1) { let errorMsg = `Không tìm thấy nhân viên với ID: ${idns}`; if (id1) errorMsg += ` hoặc ID1: ${id1}`; throw new Error(errorMsg); } const memberNames = new Set(); if (staffMember) { if (staffMember.ho_va_ten) memberNames.add(staffMember.ho_va_ten); if (staffMember.vi_tri === "Leader" && staffMember.team) { const teamName = staffMember.team; data.forEach(member => { if (member.team === teamName && member.ho_va_ten) memberNames.add(member.ho_va_ten); }); } } if (staffMember1 && staffMember1.ho_va_ten) memberNames.add(staffMember1.ho_va_ten); teamMembers = Array.from(memberNames); return staffMember || staffMember1; } catch (error) { showError(error.message); throw error; } }
    function showError(message, containerId = 'tableBody') { const container = document.getElementById(containerId); const colCount = displayColumns.length; container.innerHTML = `<tr><td colspan="${colCount}" class="no-data">${message}</td></tr>`; }
    function createEmptyStats() { return { "Đã Thanh Toán (có bill)": { count: 0, amount: 0 }, "Bill 1 phần": { count: 0, amount: 0 }, "Tổng đơn lên nội bộ": { count: 0, amount: 0 }, "Tổng đơn đủ đkien đẩy vh": { count: 0, amount: 0 }, "Tổng đơn lên vận hành": { count: 0, amount: 0 }, "Giao Thành Công": { count: 0, amount: 0 }, "Đang Giao": { count: 0, amount: 0 }, "Chưa Giao": { count: 0, amount: 0 }, "Hoàn": { count: 0, amount: 0 }, "chờ check": { count: 0, amount: 0 }, "Trống trạng thái": { count: 0, amount: 0 } }; }
    function updateSummaryInfo(filteredData, summaryElementId) { const totalOrders = filteredData.length; const totalAmount = filteredData.reduce((sum, row) => { let amountValue = row["Tổng tiền VNĐ"] || row["Tổng_tiền_VNĐ"] || 0; const numericValue = parseFloat(String(amountValue).replace(/[^\d.-]/g, '')) || 0; return sum + numericValue; }, 0); const formattedAmount = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(totalAmount); document.getElementById(summaryElementId).innerHTML = `Tổng đơn: <span style="color: #e74c3c;">${totalOrders}</span> | Tổng tiền: <span style="color: #27ae60;">${formattedAmount}</span>`; }
    function updateDetailedSummaryTable(filteredData) {
      const summaryTableBody = document.getElementById('summaryTableBody');
      summaryTableBody.innerHTML = '';
      if (filteredData.length === 0) {
        showError('Không có dữ liệu báo cáo khớp với bộ lọc.', 'summaryTableBody');
        return;
      }
      const staffStats = {};
      const grandTotal = createEmptyStats();
      filteredData.forEach(row => {
        const staffName = row["NV Vận đơn"] || row["NV_Vận_đơn"] || "Chưa có NV";
        const shippingCompany = row["Đơn vị vận chuyển"] || row["Đơn_vị_vận_chuyển"] || "Không xác định";
        if (!staffStats[staffName]) {
          staffStats[staffName] = {
            _total: createEmptyStats()
          };
        }
        if (!staffStats[staffName][shippingCompany]) {
          staffStats[staffName][shippingCompany] = createEmptyStats();
        }
        const statsToUpdate = [staffStats[staffName][shippingCompany], staffStats[staffName]._total, grandTotal];
        const numericAmount = parseFloat(String(row["Tổng tiền VNĐ"] || row["Tổng_tiền_VNĐ"] || 0).replace(/[^\d.-]/g, '')) || 0;
        const paymentStatus = row["Trạng thái thu tiền"] || "";
        const deliveryStatus = row["Trạng thái giao hàng NB"] || "";
        const checkResult = row["Kết quả Check"] || "";
        const trackingCode = row["Mã Tracking"] || "";
        statsToUpdate.forEach(stats => {
          stats["Tổng đơn lên nội bộ"].count++;
          if (paymentStatus === "Có bill") {
            stats["Đã Thanh Toán (có bill)"].count++;
            stats["Đã Thanh Toán (có bill)"].amount += numericAmount;
          }
          if (paymentStatus === "Có bill 1 phần") {
            stats["Bill 1 phần"].count++;
          }
          if (checkResult === "OK") {
            stats["Tổng đơn đủ đkien đẩy vh"].count++;
          }
          if (trackingCode) {
            stats["Tổng đơn lên vận hành"].count++;
          }
          switch (deliveryStatus) {
            case "Giao Thành Công":
              stats["Giao Thành Công"].count++;
              break;
            case "Đang Giao":
              stats["Đang Giao"].count++;
              break;
            case "Chưa Giao":
              stats["Chưa Giao"].count++;
              break;
            case "Hoàn":
              stats["Hoàn"].count++;
              break;
            case "chờ check":
              stats["chờ check"].count++;
              break;
            case "":
              stats["Trống trạng thái"].count++;
              break;
          }
        });
      });
      const grandTotalRow = renderSummaryRow("TỔNG TOÀN BỘ", "Tất cả NV & DVVC", grandTotal);
      grandTotalRow.className = 'summary-grand-total';
      summaryTableBody.appendChild(grandTotalRow);
      Object.keys(staffStats).sort().forEach(staffName => {
        const staffData = staffStats[staffName];
        const headerRow = summaryTableBody.insertRow();
        headerRow.className = 'summary-staff-header';
        const headerCell = headerRow.insertCell();
        headerCell.colSpan = 17;
        const totalRow = renderSummaryRow(staffName, "Tất cả DVVC", staffData._total);
        totalRow.className = 'summary-staff-total';
        summaryTableBody.appendChild(totalRow);
      });
    }
    function renderSummaryRow(staffName, companyName, data) { const tr = document.createElement('tr'); tr.insertCell().textContent = staffName; tr.insertCell().textContent = companyName; tr.insertCell().textContent = data["Đã Thanh Toán (có bill)"].count; const paidAmountCell = tr.insertCell(); paidAmountCell.textContent = new Intl.NumberFormat('vi-VN').format(data["Đã Thanh Toán (có bill)"].amount) + ' ₫'; tr.insertCell().textContent = data["Bill 1 phần"].count; tr.insertCell().textContent = data["Tổng đơn lên nội bộ"].count; tr.insertCell().textContent = data["Tổng đơn đủ đkien đẩy vh"].count; tr.insertCell().textContent = data["Tổng đơn lên vận hành"].count; const shippingRate = data["Tổng đơn lên nội bộ"].count > 0 ? (data["Tổng đơn lên vận hành"].count / data["Tổng đơn lên nội bộ"].count * 100) : 0; const shippingRateCell = tr.insertCell(); shippingRateCell.textContent = shippingRate.toFixed(2) + '%'; shippingRateCell.className = shippingRate > 70 ? 'positive' : 'negative'; tr.insertCell().textContent = data["Giao Thành Công"].count; tr.insertCell().textContent = data["Đang Giao"].count; tr.insertCell().textContent = data["Chưa Giao"].count; tr.insertCell().textContent = data["Hoàn"].count; tr.insertCell().textContent = data["chờ check"].count; tr.insertCell().textContent = data["Trống trạng thái"].count; const paymentSuccessRate = data["Giao Thành Công"].count > 0 ? (data["Đã Thanh Toán (có bill)"].count / data["Giao Thành Công"].count * 100) : 0; const paymentRateCell = tr.insertCell(); paymentRateCell.textContent = paymentSuccessRate.toFixed(2) + '%'; paymentRateCell.className = paymentSuccessRate > 80 ? 'positive' : 'negative'; const feeRate = data["Tổng đơn lên vận hành"].count > 0 ? (data["Giao Thành Công"].count / data["Tổng đơn lên vận hành"].count * 100) : 0; const feeRateCell = tr.insertCell(); feeRateCell.textContent = feeRate.toFixed(2) + '%'; feeRateCell.className = feeRate > 80 ? 'positive' : 'negative'; return tr; }
    function getDOMCellValue(cell) { if (!cell) return ''; const select = cell.querySelector('select'); if (select) return select.value; const input = cell.querySelector('input'); if (input) return input.value; return cell.textContent.trim(); }
    function updateSelectionSummary() { const summaryEl = document.getElementById('selectionSummary'); if (!summaryEl || !document.getElementById('contentData').classList.contains('active')) { if (summaryEl) summaryEl.innerHTML = ''; return; } if (selectedCells.size <= 1) { summaryEl.innerHTML = ''; return; } let totalSum = 0; let numericCount = 0; let nonBlankCount = 0; selectedCells.forEach(cell => { const value = getDOMCellValue(cell); if (value !== '') { nonBlankCount++; } const numericValue = parseFloat(String(value).replace(/[^0-9.-]/g, '')); if (!isNaN(numericValue)) { totalSum += numericValue; numericCount++; } }); let summaryParts = []; summaryParts.push(`Count: <b>${nonBlankCount}</b>`); if (numericCount > 0) { summaryParts.push(`Sum: <b>${totalSum.toLocaleString('vi-VN')}</b>`); } summaryEl.innerHTML = summaryParts.join(' | '); }
    function setupCellSelection(tableBodyId) { const tableBody = document.getElementById(tableBodyId); if (!tableBody) return; let lastClickTime = 0; let lastClickCell = null; tableBody.addEventListener('mousedown', (e) => { const td = e.target.closest('td'); if (!td) return; if (e.target.tagName === 'SELECT' || e.target.tagName === 'INPUT') { return; } if (!e.ctrlKey && !e.metaKey && !e.shiftKey) { isMouseDown = true; startCell = td; selectedCells.forEach(cell => cell.classList.remove('cell-selected')); selectedCells.clear(); td.classList.add('cell-selected'); selectedCells.add(td); e.preventDefault(); } }); tableBody.addEventListener('click', (e) => { const td = e.target.closest('td'); if (!td) return; if (e.target.tagName === 'SELECT' || e.target.tagName === 'INPUT') { return; } const currentTime = new Date().getTime(); const isDoubleClick = (currentTime - lastClickTime < 300) && (lastClickCell === td); if (isDoubleClick) { handleEditCell(td, tableBodyId); } else { if (e.shiftKey && startCell) { selectCellsBetween(startCell, td); } else if (!e.ctrlKey && !e.metaKey) { selectedCells.forEach(cell => cell.classList.remove('cell-selected')); selectedCells.clear(); td.classList.add('cell-selected'); selectedCells.add(td); } else { td.classList.toggle('cell-selected'); if (td.classList.contains('cell-selected')) { selectedCells.add(td); } else { selectedCells.delete(td); } } startCell = td; } lastClickTime = currentTime; lastClickCell = td; updateSelectionSummary(); }); tableBody.addEventListener('mouseover', (e) => { if (isMouseDown) { const td = e.target.closest('td'); if (td) { selectCellsBetween(startCell, td); } } }); document.addEventListener('mouseup', () => { if (isMouseDown) { isMouseDown = false; updateSelectionSummary(); } }); }
    function selectCellsBetween(start, end) { if (!start || !end || start.closest('tbody') !== end.closest('tbody')) return; const tableBody = start.closest('tbody'); const rows = Array.from(tableBody.rows); const startRowIndex = rows.findIndex(row => row.contains(start)); const endRowIndex = rows.findIndex(row => row.contains(end)); const startColIndex = start.cellIndex; const endColIndex = end.cellIndex; const minRow = Math.min(startRowIndex, endRowIndex); const maxRow = Math.max(startRowIndex, endRowIndex); const minCol = Math.min(startColIndex, endColIndex); const maxCol = Math.max(startColIndex, endColIndex); const newSelection = new Set(); for (let i = minRow; i <= maxRow; i++) { for (let j = minCol; j <= maxCol; j++) { const cell = rows[i]?.cells[j]; if (cell) { newSelection.add(cell); } } } selectedCells.forEach(cell => { if (!newSelection.has(cell)) { cell.classList.remove('cell-selected'); } }); newSelection.forEach(cell => { if (!selectedCells.has(cell)) { cell.classList.add('cell-selected'); } }); selectedCells = newSelection; }
    function handleEditCell(td, tableBodyId) { if (!td.classList.contains('editable') || td.classList.contains('editing') || td.querySelector('select')) return; const dateInput = td.querySelector('input.date-input'); if (dateInput) { dateInput.focus(); return; } const originalValue = td.textContent; const input = document.createElement('input'); input.type = 'text'; input.value = originalValue; td.textContent = ''; td.appendChild(input); td.classList.add('editing'); input.focus(); const finishEdit = (save) => { const newValue = save ? input.value.trim() : originalValue; td.textContent = newValue; td.classList.remove('editing'); if (save && newValue !== originalValue) { td.classList.add('highlight'); const rowIndex = td.closest('tr').dataset.rowIndex; if (rowIndex) { const config = tableBodyId === 'tableBody' ? mainTabConfig : japanTabConfig; config.changedRows.add(parseInt(rowIndex)); } } input.removeEventListener('blur', onBlur); input.removeEventListener('keydown', onKeyDown); }; const onBlur = () => finishEdit(true); const onKeyDown = (e) => { if (e.key === 'Enter') { e.preventDefault(); finishEdit(true); } else if (e.key === 'Escape') { e.preventDefault(); finishEdit(false); } }; input.addEventListener('blur', onBlur); input.addEventListener('keydown', onKeyDown); }
    function copySelectedCells() { if (selectedCells.size === 0) return; const sortedCells = Array.from(selectedCells).sort((a, b) => a.parentNode.rowIndex - b.parentNode.rowIndex || a.cellIndex - b.cellIndex); const firstCell = sortedCells[0]; const minRow = firstCell.parentNode.rowIndex; const minCol = sortedCells.reduce((min, cell) => Math.min(min, cell.cellIndex), Infinity); const grid = new Map(); sortedCells.forEach(cell => { const r = cell.parentNode.rowIndex - minRow; const c = cell.cellIndex - minCol; if (!grid.has(r)) grid.set(r, new Map()); grid.get(r).set(c, getDOMCellValue(cell)); }); let tsv = ''; const maxR = Math.max(...Array.from(grid.keys())); const maxC = Math.max(...Array.from(grid.values()).flatMap(row => Array.from(row.keys()))); for (let r = 0; r <= maxR; r++) { for (let c = 0; c <= maxC; c++) { tsv += grid.get(r)?.get(c) || ''; if (c < maxC) tsv += '\t'; } if (r < maxR) tsv += '\n'; } navigator.clipboard.writeText(tsv).then(() => showTempMessage(`Đã sao chép ${selectedCells.size} ô`)).catch(err => console.error('Lỗi sao chép:', err)); }
    function pasteToSelectedCells(text) { if (selectedCells.size === 0) return; const dataGrid = text.split('\n').map(row => row.split('\t')); const sortedCells = Array.from(selectedCells).sort((a, b) => a.parentNode.rowIndex - b.parentNode.rowIndex || a.cellIndex - b.cellIndex); const firstCell = sortedCells[0]; const table = firstCell.closest('table'); if (!table) return; const startRowIndex = Array.from(table.rows).indexOf(firstCell.closest('tr')); const startColIndex = firstCell.cellIndex; let pasteCount = 0; if (dataGrid.length === 1 && dataGrid[0].length === 1) { const value = dataGrid[0][0]; sortedCells.forEach(cell => { if (updateCellValue(cell, value)) { pasteCount++; } }); } else { dataGrid.forEach((row, r) => { row.forEach((value, c) => { const targetRow = table.rows[startRowIndex + r]; if (targetRow) { const targetCell = targetRow.cells[startColIndex + c]; if (targetCell) { if (updateCellValue(targetCell, value)) { pasteCount++; } } } }); }); } showTempMessage(`Đã dán ${pasteCount} giá trị`); updateSelectionSummary(); }
    function clearSelectedCells() { if (selectedCells.size === 0) return; let clearCount = 0; selectedCells.forEach(cell => { if (updateCellValue(cell, '')) { clearCount++; } }); if (clearCount > 0) { showTempMessage(`Đã xóa nội dung ${clearCount} ô`); } }
    function updateCellValue(cell, value) { if (!cell || !cell.classList.contains('editable')) return false; const select = cell.querySelector('select'); const dateInput = cell.querySelector('input.date-input'); const rowIndex = cell.closest('tr').dataset.rowIndex; const config = cell.closest('tbody').id === 'tableBody' ? mainTabConfig : japanTabConfig; let changed = false; if (select) { const optionExists = [...select.options].some(opt => opt.value === value); if (optionExists && select.value !== value) { select.value = value; select.dispatchEvent(new Event('change', { bubbles: true })); changed = true; } } else if (dateInput) { if (dateInput.value !== value) { dateInput.value = value; dateInput.dispatchEvent(new Event('input', { bubbles: true })); changed = true; } } else { if (cell.textContent !== value) { cell.textContent = value; cell.classList.add('highlight'); if (rowIndex) { config.changedRows.add(parseInt(rowIndex)); } changed = true; } } return changed; }
    function showTempMessage(message) { const existingMsg = document.querySelector('.temp-message'); if (existingMsg) existingMsg.remove(); const tempMsg = document.createElement('div'); tempMsg.className = 'temp-message'; tempMsg.textContent = message; Object.assign(tempMsg.style, { position: 'fixed', bottom: '20px', right: '20px', backgroundColor: 'rgba(39, 174, 96, 0.9)', color: 'white', padding: '12px 20px', borderRadius: '5px', zIndex: '2000', transition: 'opacity 0.5s', opacity: '1', boxShadow: '0 4px 10px rgba(0,0,0,0.2)' }); document.body.appendChild(tempMsg); setTimeout(() => { tempMsg.style.opacity = '0'; setTimeout(() => tempMsg.remove(), 500); }, 2000); }
    async function handleData(response) { document.getElementById(mainTabConfig.controls.refreshBtn).innerHTML = '<span class="refresh-icon">↻</span> Load'; document.getElementById(japanTabConfig.controls.refreshBtn).innerHTML = '<span class="refresh-icon">↻</span> Load'; allData = []; staffFilteredData = []; japanData = []; changedRows.clear(); japanChangedRows.clear(); if (response.error || !Array.isArray(response.rows)) { showError('Lỗi hoặc không có dữ liệu: ' + (response.error || 'Định dạng dữ liệu không đúng'), mainTabConfig.table.body); showError('Lỗi hoặc không có dữ liệu: ' + (response.error || 'Định dạng dữ liệu không đúng'), japanTabConfig.table.body); return; } allData = response.rows; allData.sort((a, b) => { const dateA = parseDateString(a["Ngày lên đơn"] || a["Thời gian lên đơn"]); const dateB = parseDateString(b["Ngày lên đơn"] || b["Thời gian lên đơn"]); if (!dateB && !dateA) return 0; if (!dateB) return -1; if (!dateA) return 1; return dateB - dateA; }); const staffId = getUrlParameter('id'); const staffId1 = getUrlParameter('id1'); if (!staffId && !staffId1) { showError('Thiếu tham số ID nhân viên trong URL', mainTabConfig.table.body); } else { try { currentStaff = await fetchStaffInfo(staffId, staffId1); let staffInfo = `Nhân viên: ${currentStaff.ho_va_ten}`; if (staffId1 && staffId1 !== staffId) { staffInfo += ` và ${teamMembers.find(name => name !== currentStaff.ho_va_ten) || ''}`; } if (currentStaff.vi_tri === "Leader") staffInfo += ` (Leader - Team ${currentStaff.team})`; document.getElementById('userInfo').textContent = staffInfo; staffFilteredData = allData.filter(row => { const deliveryStaff = row["NV Vận đơn"] || row["NV_Vận_đơn"] || ''; return teamMembers.includes(deliveryStaff); }); initializeTab(mainTabConfig, staffFilteredData); } catch (error) { showError(error.message, mainTabConfig.table.body); } } japanData = allData.filter(row => (row['khu vực'] || row['Khu vực']) === 'Nhật Bản'); initializeTab(japanTabConfig, japanData); populateReportFilters(); applyReportFilters(); }
    function initializeTab(config, data) { generateDynamicOptions(config, data); populateExternalFilters(config); renderHeader(config); applyAllFilters(config); setupCellSelection(config.table.body); }
    function generateDynamicOptions(config, data) { const options = {}; columnsToMakeDynamic.forEach(colName => { const dataKey = columnDisplayMapping[colName] || colName; const uniqueValues = new Set(data.map(row => row[dataKey] || row[dataKey.replace(/ /g, '_')] || (dataKey === 'khu vực' ? (row['Khu vực'] || '') : '')).filter(Boolean)); options[colName] = Array.from(uniqueValues).sort((a, b) => String(a).localeCompare(String(b))); }); if (config === japanTabConfig) { japanDynamicFilterOptions = options; } else { dynamicFilterOptions = options; } }
    function populateExternalFilters(config) { const options = config.dynamicOptions(); const productFilter = document.getElementById(config.controls.product); productFilter.innerHTML = '<option value="">Tất cả sản phẩm</option>'; (options['Mặt hàng'] || []).forEach(opt => productFilter.add(new Option(opt, opt))); if (config.controls.market) { const marketFilter = document.getElementById(config.controls.market); marketFilter.innerHTML = '<option value="">Tất cả khu vực</option>'; (options['khu vực'] || []).forEach(opt => marketFilter.add(new Option(opt, opt))); } if (config.controls.staff) { const staffFilter = document.getElementById(config.controls.staff); staffFilter.innerHTML = '<option value="">Tất cả NV Vận đơn</option>'; (options['NV Vận đơn'] || []).forEach(opt => staffFilter.add(new Option(opt, opt))); } }

    // === CẬP NHẬT LOGIC LỌC ===
    function applyAllFilters(config) {
      let dataToFilter = [...config.data()];
      const tableHead = document.getElementById(config.table.head);
      if (!tableHead.querySelector('tr')) {
        renderTableBody(config, dataToFilter);
        updateSummaryInfo(dataToFilter, config.controls.summary);
        return;
      }

      // External filters
      const startDate = document.getElementById(config.controls.startDate).value;
      const endDate = document.getElementById(config.controls.endDate).value;
      if (startDate || endDate) { const start = startDate ? new Date(startDate) : null; const end = endDate ? new Date(endDate) : null; if (start) start.setHours(0, 0, 0, 0); if (end) end.setHours(23, 59, 59, 999); dataToFilter = dataToFilter.filter(row => { const orderDateStr = row["Ngày lên đơn"] || row["Thời gian lên đơn"]; const orderDate = parseDateString(orderDateStr); if (!orderDate) return false; return (!start || orderDate >= start) && (!end || orderDate <= end); }); }
      const productFilterValue = document.getElementById(config.controls.product).value;
      if (productFilterValue) dataToFilter = dataToFilter.filter(row => (row["Mặt hàng"] || '') === productFilterValue);
      if (config.controls.market && document.getElementById(config.controls.market).value) { const marketFilterValue = document.getElementById(config.controls.market).value; dataToFilter = dataToFilter.filter(row => (row["Khu vực"] || row["khu vực"] || '') === marketFilterValue); }
      if (config.controls.staff && document.getElementById(config.controls.staff).value) { const staffFilterValue = document.getElementById(config.controls.staff).value; dataToFilter = dataToFilter.filter(row => (row["NV Vận đơn"] || row["NV_Vận_đơn"] || '') === staffFilterValue); }

      // Header filters
      const filters = tableHead.querySelectorAll('.filter-input, .filter-select');
      filters.forEach(filter => {
        const value = filter.value;
        if (value === '') return;

        const colName = filter.dataset.column;
        const dataKey = columnDisplayMapping[colName] || colName;

        // Logic đặc biệt cho bộ lọc Mã Tracking
        if (colName === "Mã Tracking") {
          if (value === "has_code") {
            dataToFilter = dataToFilter.filter(row => (row[dataKey] || row[dataKey.replace(/ /g, '_')]));
          } else if (value === "is_blank") {
            dataToFilter = dataToFilter.filter(row => !(row[dataKey] || row[dataKey.replace(/ /g, '_')]));
          }
        } else {
          // Logic lọc thông thường cho các cột khác
          const lowerCaseValue = value.toLowerCase();
          dataToFilter = dataToFilter.filter(row => {
            let cellValue = row[dataKey] !== undefined ? row[dataKey] : row[dataKey.replace(/ /g, '_')] || '';
            if (dataKey === 'khu vực') cellValue = row['Khu vực'] || row['khu vực'] || '';
            return String(cellValue).toLowerCase().includes(lowerCaseValue);
          });
        }
      });

      updateSummaryInfo(dataToFilter, config.controls.summary);
      renderTableBody(config, dataToFilter);
    }

    // === CẬP NHẬT LOGIC TẠO HEADER ===
    function renderHeader(config) {
      const header = document.getElementById(config.table.head);
      const options = config.dynamicOptions();
      header.innerHTML = '';
      const tr = document.createElement('tr');
      const filterFunction = () => applyAllFilters(config);
      const fixedCount = getFixedColumnCount();

      displayColumns.forEach((colName, index) => {
        const th = document.createElement('th');
        th.textContent = colName;
        if (index < fixedCount) {
          th.classList.add('fixed-column');
        }

        let filterElement;

        // Tạo bộ lọc đặc biệt cho cột "Mã Tracking"
        if (colName === "Mã Tracking") {
          filterElement = document.createElement('select');
          filterElement.className = 'filter-select';
          filterElement.add(new Option('Tất cả', ''));
          filterElement.add(new Option('Có mã', 'has_code'));
          filterElement.add(new Option('Không có mã', 'is_blank'));
          filterElement.addEventListener('change', filterFunction);
        }
        // Tạo bộ lọc dropdown cho các cột được định nghĩa
        else if (options[colName]) {
          filterElement = document.createElement('select');
          filterElement.className = 'filter-select';
          filterElement.add(new Option(`Tất cả ${colName}`, ''));
          options[colName].forEach(opt => filterElement.add(new Option(opt, opt)));
          filterElement.addEventListener('change', filterFunction);
        }
        // Tạo bộ lọc input text cho các cột còn lại
        else {
          filterElement = document.createElement('input');
          filterElement.type = 'text';
          filterElement.className = 'filter-input';
          filterElement.placeholder = `Lọc ${colName}...`;
          filterElement.addEventListener('input', filterFunction);
        }

        filterElement.dataset.column = colName;
        th.appendChild(document.createElement('br'));
        th.appendChild(filterElement);
        tr.appendChild(th);
      });
      header.appendChild(tr);
    }

    function renderTableBody(config, data) { const container = document.getElementById(config.table.body); container.innerHTML = ''; if (data.length === 0) { showError(`Không có đơn hàng nào khớp với bộ lọc.`, config.table.body); return; } const originalDataSet = config.data(); const fixedCount = getFixedColumnCount(); data.forEach((row) => { const originalRowIndex = originalDataSet.indexOf(row); const tr = document.createElement('tr'); tr.dataset.rowIndex = originalRowIndex; displayColumns.forEach((col, index) => { const td = document.createElement('td'); if (index < fixedCount) { td.classList.add('fixed-column'); } const dataKey = columnDisplayMapping[col] || col; let value; if (allDateColumns.includes(dataKey)) { let dateSource = row[dataKey] || ''; if (dataKey === "Ngày lên đơn") dateSource = row["Ngày lên đơn"] || row["Thời gian lên đơn"]; const formattedDate = formatDate(dateSource); value = formattedDate.display; td.dataset.originalValue = formattedDate.original; } else { value = row[dataKey] || row[dataKey.replace(/ /g, '_')] || (dataKey === 'khu vực' ? (row['Khu vực'] || '') : ''); } if (editableCols.includes(col)) { td.classList.add('editable'); if (dropdownCols[col]) { td.classList.add('has-dropdown'); const select = document.createElement('select'); dropdownCols[col].forEach(opt => select.add(new Option(opt, opt))); select.value = value; select.addEventListener('change', () => { td.classList.add('highlight'); config.changedRows.add(originalRowIndex); }); td.appendChild(select); } else { td.textContent = value; } } else { td.textContent = value; } if (col === "Kết quả Check") { if (value === 'OK') td.classList.add('cell-ok'); else if (value === 'Vận đơn XL') td.classList.add('cell-xl'); else if (value === 'Huỷ') td.classList.add('cell-cancel'); } tr.appendChild(td); }); container.appendChild(tr); }); updateStickyColumns(config); }
    function setupControls() { setupTabs(); setupTabControls(mainTabConfig); setupTabControls(japanTabConfig); setupReportControls(); document.getElementById('fixedColumnCountInput').addEventListener('input', handleFixedColumnCountChange); document.addEventListener('keydown', (e) => { const activeEl = document.activeElement; if (activeEl && ['INPUT', 'SELECT', 'TEXTAREA'].includes(activeEl.tagName) && !activeEl.closest('td')) { return; } if (document.querySelector('td.editing')) { return; } if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'c' && selectedCells.size > 0) { e.preventDefault(); copySelectedCells(); } else if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'v' && selectedCells.size > 0) { e.preventDefault(); navigator.clipboard.readText().then(text => { pasteToSelectedCells(text); }).catch(err => console.error('Lỗi đọc clipboard:', err)); } else if ((e.key === 'Delete' || e.key === 'Backspace') && selectedCells.size > 0) { e.preventDefault(); clearSelectedCells(); } }); window.addEventListener('resize', () => { if (document.getElementById('contentData').classList.contains('active')) { updateStickyColumns(mainTabConfig); } if (document.getElementById('contentJapan').classList.contains('active')) { updateStickyColumns(japanTabConfig); } }); }
    function setupTabControls(config) { document.getElementById(config.controls.refreshBtn).addEventListener('click', refreshData); document.getElementById(config.controls.updateBtn).addEventListener('click', () => updateAllChangedRows(config)); document.getElementById(config.controls.startDate).addEventListener('change', () => applyAllFilters(config)); document.getElementById(config.controls.endDate).addEventListener('change', () => applyAllFilters(config)); document.getElementById(config.controls.product).addEventListener('change', () => applyAllFilters(config)); if (config.controls.market) document.getElementById(config.controls.market).addEventListener('change', () => applyAllFilters(config)); if (config.controls.staff) document.getElementById(config.controls.staff).addEventListener('change', () => applyAllFilters(config)); document.getElementById(config.controls.clearBtn).addEventListener('click', () => { document.getElementById(config.controls.startDate).value = ''; document.getElementById(config.controls.endDate).value = ''; document.getElementById(config.controls.product).selectedIndex = 0; if (config.controls.market) document.getElementById(config.controls.market).selectedIndex = 0; if (config.controls.staff) document.getElementById(config.controls.staff).selectedIndex = 0; document.querySelectorAll(`#${config.table.head} .filter-input, #${config.table.head} .filter-select`).forEach(f => { if (f.tagName === 'SELECT') f.selectedIndex = 0; else f.value = ''; }); applyAllFilters(config); }); }
    function setupReportControls() { const { controls } = reportTabConfig; const staffBtn = document.getElementById(controls.staffBtn); const staffDropdown = document.getElementById(controls.staffDropdown); document.getElementById(controls.startDate).addEventListener('change', applyReportFilters); document.getElementById(controls.endDate).addEventListener('change', applyReportFilters); document.getElementById(controls.product).addEventListener('change', applyReportFilters); document.getElementById(controls.market).addEventListener('change', applyReportFilters); document.getElementById(controls.clearBtn).addEventListener('click', () => { document.getElementById(controls.startDate).value = ''; document.getElementById(controls.endDate).value = ''; document.getElementById(controls.product).selectedIndex = 0; document.getElementById(controls.market).selectedIndex = 0; staffDropdown.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false); updateStaffFilterButtonText(); applyReportFilters(); }); staffBtn.addEventListener('click', (e) => { e.stopPropagation(); staffDropdown.classList.toggle('show'); }); staffDropdown.addEventListener('click', (e) => { if (e.target.tagName !== 'LABEL' && e.target.tagName !== 'INPUT') { e.stopPropagation(); } }); window.addEventListener('click', (e) => { if (!staffBtn.contains(e.target) && staffDropdown.classList.contains('show')) { staffDropdown.classList.remove('show'); } }); }
    function setupTabs() { const tabs = document.querySelectorAll('.tab-btn'); const contents = document.querySelectorAll('.content-tab'); tabs.forEach(tab => { tab.addEventListener('click', () => { selectedCells.forEach(cell => cell.classList.remove('cell-selected')); selectedCells.clear(); isMouseDown = false; startCell = null; tabs.forEach(item => item.classList.remove('active')); contents.forEach(content => content.classList.remove('active')); tab.classList.add('active'); const contentId = 'content' + tab.id.substring(3); document.getElementById(contentId).classList.add('active'); setTimeout(() => { handleFixedColumnCountChange(); if (contentId === 'contentData') { updateSelectionSummary(); } else { const summaryEl = document.getElementById('selectionSummary'); if (summaryEl) summaryEl.innerHTML = ''; } }, 10); }); }); }
    function refreshData() { document.getElementById(mainTabConfig.controls.refreshBtn).innerHTML = '<span class="loading"></span> Đang tải...'; document.getElementById(japanTabConfig.controls.refreshBtn).innerHTML = '<span class="loading"></span> Đang tải...'; document.getElementById(mainTabConfig.controls.updateBtn).disabled = true; document.getElementById(japanTabConfig.controls.updateBtn).disabled = true; loadData(); setTimeout(() => { document.getElementById(mainTabConfig.controls.refreshBtn).innerHTML = '<span class="refresh-icon">↻</span> Load'; document.getElementById(japanTabConfig.controls.refreshBtn).innerHTML = '<span class="refresh-icon">↻</span> Load'; document.getElementById(mainTabConfig.controls.updateBtn).disabled = false; document.getElementById(mainTabConfig.controls.updateBtn).disabled = false; }, 5000); }
    function updateAllChangedRows(config) { if (config.changedRows.size === 0) { alert('Không có thay đổi nào để cập nhật'); return; } const updateBtn = document.getElementById(config.controls.updateBtn); const statusEl = document.createElement('span'); statusEl.className = 'status'; statusEl.textContent = 'Đang xử lý...'; updateBtn.appendChild(statusEl); updateBtn.disabled = true; const rowsToSend = []; const tableBody = document.getElementById(config.table.body); config.changedRows.forEach(rowIndex => { const originalData = config.data()[rowIndex]; if (!originalData) return; const tr = tableBody.querySelector(`tr[data-row-index="${rowIndex}"]`); if (!tr) return; const updatedRowData = { ...originalData }; editableCols.forEach(dataKey => { const displayKey = Object.keys(columnDisplayMapping).find(k => columnDisplayMapping[k] === dataKey) || dataKey; const colIndex = displayColumns.indexOf(displayKey); if (colIndex === -1) return; const cell = tr.cells[colIndex]; let valueFromDOM = getDOMCellValue(cell); updatedRowData[dataKey] = valueFromDOM; }); allDateColumns.forEach(dataKey => { if (editableCols.indexOf(dataKey) === -1) { const displayKey = Object.keys(columnDisplayMapping).find(k => columnDisplayMapping[k] === dataKey) || dataKey; const colIndex = displayColumns.indexOf(displayKey); if (colIndex === -1) return; const cell = tr.cells[colIndex]; updatedRowData[dataKey] = cell.dataset.originalValue || cell.textContent.trim(); } }); delete updatedRowData["Thời gian lên đơn"]; rowsToSend.push(updatedRowData); }); if (rowsToSend.length === 0) { statusEl.textContent = 'Không có dòng nào hợp lệ để gửi.'; setTimeout(() => { if (statusEl.parentElement) updateBtn.removeChild(statusEl); updateBtn.disabled = false; }, 3000); return; } fetch(POST_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: new URLSearchParams({ rows: JSON.stringify(rowsToSend) }) }).then(() => { statusEl.textContent = `Đã gửi ${rowsToSend.length} thay đổi.`; setTimeout(() => { alert(`Yêu cầu cập nhật ${rowsToSend.length} dòng đã được gửi đi. \n\nVui lòng nhấn "Load" để kiểm tra và xem kết quả mới nhất.`); config.changedRows.clear(); document.querySelectorAll(`#${config.table.body} .highlight`).forEach(cell => cell.classList.remove('highlight')); if (statusEl.parentElement) updateBtn.removeChild(statusEl); updateBtn.disabled = false; }, 1500); }).catch(e => { statusEl.textContent = 'Lỗi mạng: ' + e.message; statusEl.classList.add('error-status'); setTimeout(() => { if (statusEl.parentElement) updateBtn.removeChild(statusEl); updateBtn.disabled = false; }, 4000); }); }
    function populateReportFilters() { const { controls } = reportTabConfig; const productFilter = document.getElementById(controls.product); const marketFilter = document.getElementById(controls.market); const staffDropdown = document.getElementById(controls.staffDropdown); const allProducts = [...new Set(allData.map(r => r["Mặt hàng"]).filter(Boolean))].sort(); const allMarkets = [...new Set(allData.map(r => r["khu vực"] || r["Khu vực"]).filter(Boolean))].sort(); const allStaff = [...new Set(allData.map(r => r["NV Vận đơn"] || r["NV_Vận_đơn"]).filter(Boolean))].sort(); productFilter.innerHTML = '<option value="">Tất cả sản phẩm</option>'; allProducts.forEach(opt => productFilter.add(new Option(opt, opt))); marketFilter.innerHTML = '<option value="">Tất cả khu vực</option>'; allMarkets.forEach(opt => marketFilter.add(new Option(opt, opt))); staffDropdown.innerHTML = ''; const allLabel = document.createElement('label'); allLabel.innerHTML = `<input type="checkbox" id="reportStaffSelectAll"> <b>Chọn tất cả</b>`; staffDropdown.appendChild(allLabel); allStaff.forEach(staffName => { const label = document.createElement('label'); const checkbox = document.createElement('input'); checkbox.type = 'checkbox'; checkbox.value = staffName; checkbox.addEventListener('change', () => { updateStaffFilterButtonText(); applyReportFilters(); }); label.appendChild(checkbox); label.appendChild(document.createTextNode(` ${staffName}`)); staffDropdown.appendChild(label); }); document.getElementById('reportStaffSelectAll').addEventListener('change', (e) => { const isChecked = e.target.checked; staffDropdown.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = isChecked); updateStaffFilterButtonText(); applyReportFilters(); }); }
    function updateStaffFilterButtonText() { const { controls } = reportTabConfig; const staffBtn = document.getElementById(controls.staffBtn); const staffDropdown = document.getElementById(controls.staffDropdown); const allStaffCheckboxes = staffDropdown.querySelectorAll('input[type="checkbox"]:not(#reportStaffSelectAll)'); const selectedCount = Array.from(allStaffCheckboxes).filter(cb => cb.checked).length; if (selectedCount === 0) { staffBtn.textContent = 'Tất cả NV Vận đơn'; } else if (selectedCount === allStaffCheckboxes.length) { staffBtn.textContent = 'Tất cả NV đã chọn'; document.getElementById('reportStaffSelectAll').checked = true; } else { staffBtn.textContent = `${selectedCount} NV đã chọn`; document.getElementById('reportStaffSelectAll').checked = false; } }
    function applyReportFilters() { let filteredReportData = [...allData]; const { controls } = reportTabConfig; const startDate = document.getElementById(controls.startDate).value; const endDate = document.getElementById(controls.endDate).value; const product = document.getElementById(controls.product).value; const market = document.getElementById(controls.market).value; const selectedStaff = Array.from(document.querySelectorAll(`#${controls.staffDropdown} input:checked:not(#reportStaffSelectAll)`)).map(cb => cb.value); if (startDate || endDate) { const start = startDate ? new Date(startDate) : null; const end = endDate ? new Date(endDate) : null; if (start) start.setHours(0, 0, 0, 0); if (end) end.setHours(23, 59, 59, 999); filteredReportData = filteredReportData.filter(row => { const orderDate = parseDateString(row["Ngày lên đơn"] || row["Thời gian lên đơn"]); return orderDate && (!start || orderDate >= start) && (!end || orderDate <= end); }); } if (product) { filteredReportData = filteredReportData.filter(row => row["Mặt hàng"] === product); } if (market) { filteredReportData = filteredReportData.filter(row => (row["khu vực"] || row["Khu vực"]) === market); } if (selectedStaff.length > 0) { const staffSet = new Set(selectedStaff); filteredReportData = filteredReportData.filter(row => staffSet.has(row["NV Vận đơn"] || row["NV_Vận_đơn"])); } updateDetailedSummaryTable(filteredReportData); }
    function loadData() { showError('Đang tải dữ liệu...', mainTabConfig.table.body); showError('Đang tải dữ liệu...', japanTabConfig.table.body); const script = document.createElement('script'); script.src = `${POST_URL}?callback=handleData&rand=${Math.random()}`; const oldScript = document.querySelector('script[src^="https://script.google.com"]'); if (oldScript) oldScript.remove(); document.body.appendChild(script); }

    setupControls();
    loadData();
  </script>
</body>

</html>

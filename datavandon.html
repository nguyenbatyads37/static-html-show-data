<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>DANH SÁCH ĐƠN HÀNG</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      background-color: #f5f5f5;
      color: #333;
      margin: 0;
    }
    h2 { text-align: center; margin-bottom: 20px; color: #2c3e50; }
    .controls {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      align-items: center;
      background: #fff;
      padding: 10px 15px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 1000; /* Đảm bảo thanh control luôn ở trên cùng */
      flex-wrap: wrap;
    }
    .controls .left-controls, .controls .right-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap; /* Cho phép các nút xuống dòng trên màn hình nhỏ */
    }
    .date-filter { display: flex; align-items: center; gap: 5px; }
    .date-filter input[type="date"] {
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 13px;
    }
    .table-wrapper {
      position: relative;
      overflow: auto;
      max-height: 60vh; /* Giảm chiều cao để có không gian cho bảng tóm tắt */
      background: white;
      border-radius: 5px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-top: 20px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 14px;
    }
    #tableContainer table {
      min-width: 2500px; /* Đảm bảo bảng chi tiết đủ rộng */
    }
    thead {
      position: sticky;
      top: 0;
      z-index: 900;
    }
    th, td {
      border: 1px solid #e0e0e0;
      padding: 8px 12px;
      text-align: left;
      white-space: nowrap;
      background-color: white;
    }
    th {
      background-color: #3498db;
      color: white;
      font-weight: 500;
      vertical-align: top;
    }
    #tableContainer thead th {
        position: sticky;
        top: 0;
        z-index: 950;
    }

    th .filter-input, th .filter-select {
      width: 100%;
      box-sizing: border-box;
      margin-top: 5px;
      padding: 4px;
      font-size: 12px;
      border: 1px solid #ccc;
      border-radius: 3px;
    }
    td.editable { background-color: #fffbe8; }
    td select, td input.date-input {
      width: 100%;
      padding: 6px;
      border: none;
      background: transparent;
      font-family: inherit;
      font-size: inherit;
      box-sizing: border-box;
    }
    button {
      padding: 6px 12px;
      cursor: pointer;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 13px;
      transition: background-color 0.3s;
    }
    button:hover { background-color: #2980b9; }
    .status { font-size: 0.85em; margin-left: 8px; color: #27ae60; }
    .error-status { color: #e74c3c; }
    .highlight { background-color: #ffeb3b !important; }
    .no-data {
      text-align: center;
      padding: 20px;
      color: #7f8c8d;
      font-style: italic;
    }
    .refresh-btn { background-color: #2ecc71; }
    .refresh-btn:hover { background-color: #27ae60; }
    .clear-filter-btn { background-color: #f39c12; }
    .clear-filter-btn:hover { background-color: #e67e22; }
    .refresh-icon { margin-right: 5px; }
    .fixed-column {
      position: sticky;
      left: 0;
      z-index: 10;
    }
    th.fixed-column {
      z-index: 960 !important; /* Phải cao hơn z-index của thead th */
      background-color: #3498db;
    }
    td.fixed-column {
      background-color: #f2f2f2;
      font-weight: bold;
    }
    #userInfo { font-weight: bold; margin-right: 15px; }
    .summary-info {
      background: #e3f2fd;
      padding: 8px 15px;
      border-radius: 4px;
      margin-left: 10px;
      font-weight: bold;
    }
    tr.selected, tr.selected td {
      background-color: #aed6f1 !important;
    }
    
    /* CSS cho bảng tổng hợp */
    #summaryContainer {
      margin-top: 15px;
      overflow-x: auto;
      border-radius: 5px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    #summaryTable {
      width: 100%;
      min-width: 1800px; /* Đảm bảo bảng tổng hợp đủ rộng */
      font-size: 13px;
    }
    #summaryTable th, #summaryTable td {
      border: 1px solid #ccc;
      padding: 9px;
      text-align: center;
    }
    #summaryTable th {
      background-color: #2c3e50;
      color: white;
      position: sticky;
      top: 0;
      z-index: 800; /* Thấp hơn z-index của thanh control */
    }
    #summaryTable td {
      font-weight: bold;
      background-color: #fdfefe;
    }
    #summaryTable .rate-col {
        background-color: #e3f2fd;
        color: #1a5276;
    }
  </style>
</head>
<body>
  <h2>QUẢN LÝ VẬN ĐƠN</h2>
  
  <div class="controls">
    <div class="left-controls">
      <span id="userInfo"></span>
      <button id="refreshData" class="refresh-btn">
        <span class="refresh-icon">↻</span> Load dữ liệu
      </button>
      <button id="updateAll">Cập nhật tất cả</button>
      <div id="summaryInfo" class="summary-info"></div>
    </div>
    <div class="right-controls">
      <div class="date-filter">
        <span>Lọc từ ngày:</span>
        <input type="date" id="startDateFilter" />
        <span>Đến ngày:</span>
        <input type="date" id="endDateFilter" />
      </div>
      <button id="clearFilters" class="clear-filter-btn">Xóa bộ lọc</button>
    </div>
  </div>

  <!-- BẢNG TỔNG HỢP -->
  <div id="summaryContainer">
    <h3 style="text-align: center; color: #2c3e50; margin: 10px 0;">BẢNG TỔNG HỢP THEO BỘ LỌC</h3>
    <table id="summaryTable">
      <thead>
        <tr>
          <th>Tên vận đơn</th>
          <th>Đã Thanh Toán (có bill)</th>
          <th>Bill 1 phần</th>
          <th>Tổng đơn lên nội bộ</th>
          <th>Tổng đơn đủ đkien đẩy vh</th>
          <th>Tổng đơn lên vận hành</th>
          <th class="rate-col">Tỷ lệ đơn lên vận hành</th>
          <th>Giao Thành Công</th>
          <th>Đang Giao</th>
          <th>Chưa Giao</th>
          <th>Hoàn</th>
          <th>chờ check</th>
          <th>Trống trạng thái</th>
          <th class="rate-col">Tỷ lệ thu tiền/giao thành công</th>
          <th class="rate-col">Tỷ lệ đơn tính phí vc</th>
        </tr>
      </thead>
      <tbody id="summaryTableBody">
        <!-- Dữ liệu sẽ được chèn vào đây bằng JavaScript -->
      </tbody>
    </table>
  </div>

  <!-- BẢNG CHI TIẾT -->
  <div class="table-wrapper" id="tableContainer">
    <table>
      <thead id="tableHead"></thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <script>
    const POST_URL = 'https://script.google.com/macros/s/AKfycbzNeQSd_fUNicLT8VyVg90Di9NpAZxCagmBLFboJZ5I64qjqHBHM7uOZalO11mJdAxN/exec';

    const editableCols = [
        "Kết quả Check", "Trạng thái giao hàng NB", "Lý do", "Trạng thái thu tiền", "Ngày hẹn đẩy đơn"
    ];
    const dropdownCols = {
        "Kết quả Check": ["", "OK", "Huỷ", "Treo", "Vận đơn XL", "Đợi hàng", "Khách hẹn"],
        "Trạng thái giao hàng NB": ["", "Giao Thành Công", "Đang Giao", "Chưa Giao", "Hủy", "Hoàn", "chờ check", "Giao không thành công", "Bom_Thất Lạc"],
        "Trạng thái thu tiền": ["", "Có bill", "Có bill 1 phần", "Bom_bùng_chặn", "Hẹn Thanh Toán", "Hoàn Hàng", "Khó Đòi", "Không nhận được hàng", "Không PH dưới 3N", "Thanh toán phí hoàn", "KPH nhiều ngày"]
    };
    const displayColumns = [
      "Mã đơn hàng", ...editableCols, "Ngày lên đơn", "Name*", "Phone*", "Add", "City", "State", "Zipcode", 
      "Mặt hàng", "Tên mặt hàng 1", "Số lượng mặt hàng 1", "Tên mặt hàng 2", "Số lượng mặt hàng 2", "Quà tặng", "Số lượng quà kèm", 
      "Giá bán", "Loại tiền thanh toán", "Tổng tiền VNĐ", "Hình thức thanh toán", "Ghi chú", "Mã Tracking", "Ngày đóng hàng", 
      "Trạng thái giao hàng", "Thời gian giao dự kiến", "Phí ship nội địa Mỹ (usd)", "Phí xử lý đơn đóng hàng-Lưu kho(usd)", 
      "GHI CHÚ", "Nhân viên Sale", "NV Vận đơn", "Đơn vị vận chuyển"
    ];
    const allDateColumns = ["Ngày lên đơn", "Ngày đóng hàng", "Ngày hẹn đẩy đơn"];

    let allData = [];
    let staffFilteredData = [];
    let changedRows = new Set();
    let currentStaff = null;
    let teamMembers = [];
    let selectedRows = new Set();
    
    function getUrlParameter(name) {
      name = name.replace(/[\[\]]/g, '\\$&');
      const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
      const results = regex.exec(window.location.href);
      if (!results) return null;
      if (!results) return '';
      return decodeURIComponent(results.replace(/\+/g, ' '));
    }

    async function fetchStaffInfo(idns) {
      try {
        const staffApiUrl = 'https://script.google.com/macros/s/AKfycbzwOv7UFwrqzf88QJL1QrxLKcnnnSIQ_PSmF0SO8LboqWI5li3vF3W8_-8s-A8lNGaR/exec';
        const response = await fetch(staffApiUrl, { cache: "no-store" });
        if (!response.ok) throw new Error('Lỗi mạng khi tải data nhân viên');
        const data = await response.json();
        const staffMember = data.find(staff => String(staff.idnv) === idns);
        if (!staffMember) throw new Error(`Không tìm thấy nhân viên với ID: ${idns}`);
        if (staffMember.vi_tri === "Leader") {
          const teamName = staffMember.team;
          teamMembers = data.filter(member => member.team === teamName).map(member => member.ho_va_ten);
        }
        return staffMember;
      } catch (error) {
        showError(error.message);
        throw error;
      }
    }
    
    function showError(message) {
      const container = document.getElementById('tableBody');
      const colCount = displayColumns.length > 0 ? displayColumns.length : 10;
      container.innerHTML = `<tr><td colspan="${colCount}" class="no-data">${message}</td></tr>`;
      document.getElementById('summaryTableBody').innerHTML = `<tr><td colspan="15" class="no-data">${message}</td></tr>`;
    }

    function formatDate(dateString) {
      if (!dateString || typeof dateString !== 'string') return { display: '', original: '' };
      
      const originalValue = dateString;
      let displayValue = dateString;
      
      try {
        if (dateString.endsWith('Z') || /^\d{4}-\d{2}-\d{2}/.test(dateString)) {
          const dateObj = new Date(dateString);
          if (!isNaN(dateObj.getTime())) {
            const day = String(dateObj.getDate()).padStart(2, '0');
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const year = dateObj.getFullYear();
            displayValue = `${day}/${month}/${year}`;
          }
        }
      } catch (e) {
        // Giữ giá trị gốc nếu có lỗi
      }
      return { display: displayValue, original: originalValue };
    }

    function updateSummaryInfo(filteredData) {
      const totalOrders = filteredData.length;
      const totalAmount = filteredData.reduce((sum, row) => {
        let amountValue = String(row["Tổng tiền VNĐ"] || row["Tổng_tiền_VNĐ"] || 0);
        const numericValue = amountValue.replace(/[^\d.-]/g, '');
        return sum + (parseFloat(numericValue) || 0);
      }, 0);
      
      const formattedAmount = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(totalAmount);
      
      document.getElementById('summaryInfo').innerHTML = `
        Tổng đơn: <span style="color: #e74c3c;">${totalOrders}</span> | 
        Tổng tiền: <span style="color: #27ae60;">${formattedAmount}</span>`;
    }

    function renderSummaryTable(filteredData) {
        const summaryBody = document.getElementById('summaryTableBody');
        summaryBody.innerHTML = '';
        const dataByStaff = {};

        filteredData.forEach(row => {
            const staffName = row["NV Vận đơn"] || row["NV_Vận_đơn"] || 'Chưa phân công';
            if (!dataByStaff[staffName]) {
                dataByStaff[staffName] = {
                    total: 0, paid: 0, paid_partial: 0, qualified: 0, pushed: 0,
                    success: 0, shipping: 0, not_shipped: 0, returned: 0,
                    waiting_check: 0, no_status: 0,
                };
            }
            const summary = dataByStaff[staffName];
            summary.total++;
            if ((row["Trạng thái thu tiền"] || "").toLowerCase() === 'có bill') summary.paid++;
            if ((row["Trạng thái thu tiền"] || "").toLowerCase() === 'có bill 1 phần') summary.paid_partial++;
            if ((row["Kết quả Check"] || "").toLowerCase() === 'ok') summary.qualified++;
            if (row["Mã Tracking"]) summary.pushed++;
            
            const deliveryStatus = (row["Trạng thái giao hàng NB"] || "").toLowerCase();
            switch(deliveryStatus) {
                case "giao thành công": summary.success++; break;
                case "đang giao": summary.shipping++; break;
                case "chưa giao": summary.not_shipped++; break;
                case "hoàn": summary.returned++; break;
                case "chờ check": summary.waiting_check++; break;
                case "": summary.no_status++; break;
            }
        });

        Object.keys(dataByStaff).sort().forEach(staff => {
            const data = dataByStaff[staff];
            const tr = document.createElement('tr');
            const pushRate = data.total > 0 ? (data.pushed / data.total * 100).toFixed(2) + '%' : '0.00%';
            const paymentRate = data.success > 0 ? ((data.paid + data.paid_partial) / data.success * 100).toFixed(2) + '%' : '0.00%';
            const feeRate = data.total > 0 ? ((data.success + data.returned) / data.total * 100).toFixed(2) + '%' : '0.00%';

            tr.innerHTML = `
                <td>${staff}</td><td>${data.paid}</td><td>${data.paid_partial}</td>
                <td>${data.total}</td><td>${data.qualified}</td><td>${data.pushed}</td>
                <td class="rate-col">${pushRate}</td><td>${data.success}</td><td>${data.shipping}</td>
                <td>${data.not_shipped}</td><td>${data.returned}</td><td>${data.waiting_check}</td>
                <td>${data.no_status}</td><td class="rate-col">${paymentRate}</td><td class="rate-col">${feeRate}</td>
            `;
            summaryBody.appendChild(tr);
        });

        if (Object.keys(dataByStaff).length === 0) {
            summaryBody.innerHTML = `<tr><td colspan="15" class="no-data">Không có dữ liệu tổng hợp cho bộ lọc hiện tại.</td></tr>`;
        }
    }

    async function handleData(response) {
      document.getElementById('refreshData').innerHTML = '<span class="refresh-icon">↻</span> Load dữ liệu';
      allData = []; staffFilteredData = []; changedRows = new Set();

      if (response.error || !Array.isArray(response.rows)) {
        showError('Lỗi hoặc không có dữ liệu: ' + (response.error || 'Định dạng dữ liệu không đúng'));
        return;
      }
      allData = response.rows;

      const staffId = getUrlParameter('id');
      if (!staffId) {
        showError('Thiếu tham số ID nhân viên trong URL');
        return;
      }
      try {
        currentStaff = await fetchStaffInfo(staffId);
        let staffInfo = `Nhân viên: ${currentStaff.ho_va_ten}`;
        staffInfo += (currentStaff.vi_tri === "Leader") ? ` (Leader - Team ${currentStaff.team})` : ` (Nhân viên)`;
        document.getElementById('userInfo').textContent = staffInfo;
        filterDataByStaff();
        renderHeader();
        applyAllFilters();
      } catch (error) {
        showError(error.message);
      }
    }

    function filterDataByStaff() {
      if (!currentStaff) return;
      staffFilteredData = allData.filter(row => {
        const deliveryStaff = row["NV Vận đơn"] || row["NV_Vận_đơn"] || '';
        if (currentStaff.vi_tri === "Leader") {
          return teamMembers.includes(deliveryStaff);
        } else {
          return deliveryStaff === currentStaff.ho_va_ten;
        }
      });
    }

    function applyAllFilters() {
        let dataToFilter = [...staffFilteredData];
        const tableHead = document.getElementById('tableHead');
        if (!tableHead.querySelector('tr')) return;

        const startDate = document.getElementById('startDateFilter').value;
        const endDate = document.getElementById('endDateFilter').value;
        if (startDate || endDate) {
            const start = startDate ? new Date(startDate) : null;
            const end = endDate ? new Date(endDate) : null;
            if(start) start.setHours(0,0,0,0);
            if(end) end.setHours(23,59,59,999);
            dataToFilter = dataToFilter.filter(row => {
                const orderDateStr = row["Ngày lên đơn"] || row["Thời gian lên đơn"];
                if (!orderDateStr) return false;
                try {
                    const orderDate = new Date(orderDateStr);
                    if (isNaN(orderDate.getTime())) return false;
                    if (start && orderDate < start) return false;
                    if (end && orderDate > end) return false;
                    return true;
                } catch { return false; }
            });
        }
        tableHead.querySelectorAll('.filter-input, .filter-select').forEach(filter => {
            const value = filter.value.toLowerCase().trim();
            if (value === '') return;
            const colName = filter.dataset.column;
            dataToFilter = dataToFilter.filter(row => {
                 let cellValue = row[colName] ?? row[colName.replace(/ /g, '_')] ?? '';
                 return String(cellValue).toLowerCase().includes(value);
            });
        });
        
        updateSummaryInfo(dataToFilter);
        renderSummaryTable(dataToFilter);
        renderTableBody(dataToFilter);
    }

    function renderHeader() {
        const header = document.getElementById('tableHead');
        header.innerHTML = '';
        const tr = document.createElement('tr');
        displayColumns.forEach(colName => {
            const th = document.createElement('th');
            th.textContent = colName;
            if (colName === "Mã đơn hàng") th.classList.add('fixed-column');
            let filterElement;
            if (dropdownCols[colName]) {
                filterElement = document.createElement('select');
                filterElement.className = 'filter-select';
                dropdownCols[colName].forEach(opt => {
                    const option = new Option(opt || '(Tất cả)', opt);
                    filterElement.add(option);
                });
                filterElement.addEventListener('change', applyAllFilters);
            } else {
                filterElement = document.createElement('input');
                filterElement.type = 'text';
                filterElement.className = 'filter-input';
                filterElement.placeholder = `Lọc theo ${colName}...`;
                filterElement.addEventListener('input', applyAllFilters);
            }
            filterElement.dataset.column = colName;
            th.appendChild(document.createElement('br'));
            th.appendChild(filterElement);
            tr.appendChild(th);
        });
        header.appendChild(tr);
    }

    function renderTableBody(data) {
      const container = document.getElementById('tableBody');
      container.innerHTML = '';
      if (data.length === 0) {
        showError(`Không có đơn hàng nào khớp với bộ lọc.`);
        return;
      }
      data.forEach((row) => {
        const originalRowIndex = staffFilteredData.indexOf(row);
        const tr = document.createElement('tr');
        tr.dataset.rowIndex = originalRowIndex;
        tr.addEventListener('click', (e) => {
          if (e.ctrlKey || e.metaKey) {
            tr.classList.toggle('selected');
            if (tr.classList.contains('selected')) selectedRows.add(originalRowIndex);
            else selectedRows.delete(originalRowIndex);
          } else {
            document.querySelectorAll('#tableBody tr.selected').forEach(r => r.classList.remove('selected'));
            selectedRows.clear();
            tr.classList.add('selected');
            selectedRows.add(originalRowIndex);
          }
        });

        displayColumns.forEach(col => {
          const td = document.createElement('td');
          let value = row[col] ?? row[col.replace(/ /g, '_')] ?? '';
          if (allDateColumns.includes(col)) {
              const dateSource = col === "Ngày lên đơn" ? (row["Ngày lên đơn"] || row["Thời gian lên đơn"]) : value;
              const formattedDate = formatDate(dateSource);
              value = formattedDate.display;
              td.dataset.originalValue = formattedDate.original;
          }
          if (col === "Mã đơn hàng") td.classList.add('fixed-column');
          if (editableCols.includes(col)) {
            td.classList.add('editable');
            if (dropdownCols[col]) {
              const select = document.createElement('select');
              dropdownCols[col].forEach(opt => select.add(new Option(opt, opt)));
              select.value = value;
              select.addEventListener('change', () => {
                td.classList.add('highlight'); changedRows.add(originalRowIndex);
              });
              td.appendChild(select);
            } else if (col === "Ngày hẹn đẩy đơn") {
                const input = document.createElement('input');
                input.type = 'text'; input.className = 'date-input';
                input.placeholder = 'dd/mm/yyyy'; input.value = value;
                input.addEventListener('input', () => {
                  td.classList.add('highlight'); changedRows.add(originalRowIndex);
                });
                td.appendChild(input);
            } else {
              td.contentEditable = 'true'; td.textContent = value;
              td.addEventListener('input', () => {
                td.classList.add('highlight'); changedRows.add(originalRowIndex);
              });
            }
          } else {
            td.textContent = value;
          }
          tr.appendChild(td);
        });
        container.appendChild(tr);
      });
    }

    function copySelectedRows() {
      const rows = [displayColumns.join('\t')];
      selectedRows.forEach(rowIndex => {
        const rowData = staffFilteredData[rowIndex];
        const rowValues = displayColumns.map(header => 
            String(rowData[header] ?? rowData[header.replace(/ /g, '_')] ?? '').replace(/\t|\n/g, ' ')
        );
        rows.push(rowValues.join('\t'));
      });
      navigator.clipboard.writeText(rows.join('\n')).then(() => {
        const msg = document.createElement('div');
        msg.textContent = `Đã sao chép ${selectedRows.size} dòng`;
        Object.assign(msg.style, {
            position:'fixed', bottom:'20px', right:'20px', backgroundColor:'#2ecc71',
            color:'white', padding:'10px 15px', borderRadius:'5px', zIndex:'2000'
        });
        document.body.appendChild(msg);
        setTimeout(() => msg.remove(), 2000);
      }).catch(err => console.error('Không thể sao chép:', err));
    }

    function setupControls() {
      document.getElementById('refreshData').addEventListener('click', refreshData);
      document.getElementById('updateAll').addEventListener('click', updateAllChangedRows);
      document.getElementById('startDateFilter').addEventListener('change', applyAllFilters);
      document.getElementById('endDateFilter').addEventListener('change', applyAllFilters);
      document.getElementById('clearFilters').addEventListener('click', () => {
          document.getElementById('startDateFilter').value = '';
          document.getElementById('endDateFilter').value = '';
          document.querySelectorAll('#tableHead .filter-input, #tableHead .filter-select').forEach(f => f.value = '');
          applyAllFilters();
      });
      document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'c' && selectedRows.size > 0) {
          e.preventDefault(); copySelectedRows();
        }
      });
    }

    function refreshData() {
      document.getElementById('refreshData').innerHTML = '<span class="loading"></span> Đang tải...';
      document.getElementById('updateAll').disabled = true;
      loadData();
    }

    function updateAllChangedRows() {
      if (changedRows.size === 0) { alert('Không có thay đổi nào để cập nhật.'); return; }
      
      const updateBtn = document.getElementById('updateAll');
      const statusEl = document.createElement('span');
      statusEl.className = 'status'; statusEl.textContent = 'Đang xử lý...';
      updateBtn.appendChild(statusEl); updateBtn.disabled = true;

      const rowsToSend = [];
      const tableBody = document.getElementById('tableBody');
      changedRows.forEach(rowIndex => {
        const tr = tableBody.querySelector(`tr[data-row-index="${rowIndex}"]`);
        if(!tr || !staffFilteredData[rowIndex]) return;
        const updatedRowData = { ...staffFilteredData[rowIndex] };
        editableCols.forEach(colName => {
          const cell = tr.cells[displayColumns.indexOf(colName)];
          updatedRowData[colName] = cell.querySelector('select, input')?.value ?? cell.textContent.trim();
        });
        allDateColumns.forEach(colName => {
          if (!editableCols.includes(colName)) {
              const cell = tr.cells[displayColumns.indexOf(colName)];
              updatedRowData[colName] = cell.dataset.originalValue || '';
          }
        });
        delete updatedRowData["Thời gian lên đơn"]; // Xóa trường cũ nếu có
        rowsToSend.push(updatedRowData);
      });

      if (rowsToSend.length === 0) {
        statusEl.textContent = 'Lỗi! Không tìm thấy dòng để gửi.';
        setTimeout(() => { statusEl.remove(); updateBtn.disabled = false; }, 3000);
        return;
      }
      fetch(POST_URL, {
        method: 'POST', mode: 'no-cors',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ rows: JSON.stringify(rowsToSend) })
      }).then(() => {
        statusEl.textContent = `Đã gửi ${rowsToSend.length} thay đổi.`;
        setTimeout(() => {
          alert(`Cập nhật thành công ${rowsToSend.length} dòng. Vui lòng nhấn "Load dữ liệu" để làm mới.`);
          changedRows.clear();
          document.querySelectorAll('.highlight').forEach(cell => cell.classList.remove('highlight'));
          statusEl.remove(); updateBtn.disabled = false;
        }, 2000);
      }).catch(e => {
        statusEl.textContent = 'Lỗi mạng: ' + e.message;
        statusEl.classList.add('error-status');
        setTimeout(() => { statusEl.remove(); updateBtn.disabled = false; }, 4000);
      });
    }

    function loadData() {
      const loadingMessage = `<tr><td colspan="100%" style="text-align: center; padding: 20px;">Đang tải dữ liệu...</td></tr>`;
      document.getElementById('tableBody').innerHTML = loadingMessage;
      document.getElementById('summaryTableBody').innerHTML = loadingMessage;

      const script = document.createElement('script');
      const callbackUrl = `${POST_URL}?callback=handleData&rand=${Math.random()}`;
      script.src = callbackUrl;
      script.onerror = () => {
          showError("Không thể tải dữ liệu từ Google Script. Vui lòng kiểm tra lại URL hoặc kết nối mạng.");
          document.getElementById('refreshData').innerHTML = '<span class="refresh-icon">↻</span> Load dữ liệu';
          document.getElementById('updateAll').disabled = false;
      }
      const oldScript = document.querySelector(`script[src^="${POST_URL}"]`);
      if (oldScript) oldScript.remove();
      document.body.appendChild(script);

      // Timeout để tránh bị kẹt trạng thái loading
      setTimeout(() => {
          if (document.getElementById('updateAll').disabled) {
              document.getElementById('refreshData').innerHTML = '<span class="refresh-icon">↻</span> Load dữ liệu';
              document.getElementById('updateAll').disabled = false;
          }
      }, 15000); // 15 giây
    }

    setupControls();
    loadData();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>QUẢN LÝ VẬN ĐƠN</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      background-color: #f5f5f5;
      color: #333;
      margin: 0;
    }
    h2 { text-align: center; margin-bottom: 20px; color: #2c3e50; }
    .controls {
      display: flex; justify-content: space-between; margin-bottom: 15px; align-items: center;
      background: #fff; padding: 15px; border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; flex-wrap: wrap;
      gap: 15px;
    }
    .controls .left-controls, .controls .right-controls { display: flex; align-items: center; gap: 15px; flex-wrap: wrap;}
    .controls .date-filter { display: flex; align-items: center; gap: 8px; }
    .controls button:not(.tab-btn) {
      padding: 10px 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 18px;
      color: white;
      background-color: #3498db;
    }

    .controls .filter-input,
    .controls .filter-select,
    .controls input[type="date"] {
      padding: 10px 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 18px;
      background-color: white;
    }

    .controls .date-filter span {
        font-size: 18px;
    }
    #userInfo, .japan-tab-info {
        font-size: 18px;
        font-weight: bold;
    }

    .tab-controls {
      display: flex;
      border: 1px solid #ccc;
      border-radius: 5px;
      overflow: hidden;
      margin-right: 20px;
    }
    .tab-btn {
      background-color: #f1f1f1;
      border: none;
      padding: 12px 22px;
      cursor: pointer;
      transition: background-color 0.3s;
      font-size: 16px;
      font-weight: bold;
    }
    .tab-btn:hover {
      background-color: #ddd;
    }
    .tab-btn.active {
      background-color: #3498db;
      color: white;
    }
    .content-tab {
        display: none;
    }
    .content-tab.active {
        display: block;
    }


    .table-wrapper {
      position: relative; overflow: auto; max-height: 75vh;
      background: white; border-radius: 5px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-top: 20px;
    }
    .main-table-wrapper {
      overflow-x: scroll;
      overflow-y: auto;
      max-height: calc(100vh - 200px);
    }
    table {
      border-collapse: collapse; width: 100%; min-width: 2200px;
      font-size: 11px;
      font-weight: bold;
    }
    thead { position: sticky; top: 0; z-index: 10; }
    th, td {
      border: 1px solid #e0e0e0; padding: 6px 10px;
      white-space: nowrap; background-color: white; text-align: left;
      /* position: relative; ĐÃ BỊ XÓA ĐỂ SỬA LỖI KHÔNG EDIT ĐƯỢC */
    }
    th {
      background-color: #3498db; color: white; font-weight: 500;
      vertical-align: top; position: sticky; top: 0; z-index: 20;
    }
    th .filter-input, th .filter-select {
      width: 100%; margin-top: 5px;
      padding: 6px 4px;
      font-size: 12px;
      border: 1px solid #ccc; border-radius: 3px;
    }
    td.editable { background-color: #fffbe8; }
    td select, td input.date-input {
      width: 100%; padding: 4px; border: none;
      background: transparent; font-family: inherit; font-size: inherit;
      font-weight: inherit;
    }
    button {
      cursor: pointer;
      border: none;
      transition: background-color 0.3s;
    }

    .update-btn { background-color: #3498db; }
    .update-btn:hover { background-color: #2980b9; }
    .refresh-btn { background-color: #2ecc71; }
    .refresh-btn:hover { background-color: #27ae60; }
    .clear-filter-btn { background-color: #f39c12; }
    .clear-filter-btn:hover { background-color: #e67e22; }

    .status { font-size: 0.85em; margin-left: 8px; color: #27ae60; }
    .error-status { color: #e74c3c; }
    .highlight { background-color: #ffeb3b !important; }
    .no-data {
      text-align: center; padding: 20px;
      color: #7f8c8d; font-style: italic; font-size: 16px;
    }
    .refresh-icon { margin-right: 5px; }

    /* --- CSS CHO CỘT CỐ ĐỊNH --- */
    .sticky-col {
      position: sticky;
    }
    thead th.sticky-col {
      z-index: 25 !important;
      background-color: #3498db;
    }
    tbody td.sticky-col {
      z-index: 5 !important;
      background-color: #fdfdfd;
    }
    tbody td.sticky-col.cell-ok { background-color: #e8f5e9 !important; }
    tbody td.sticky-col.cell-cancel { background-color: #ffebee !important; }
    tbody td.sticky-col.cell-xl { background-color: #fffde7 !important; }
    tbody td.sticky-col.editable { background-color: #fffbe8; }

    .summary-info {
      background: #e3f2fd; padding: 8px 15px; border-radius: 4px;
      margin-left: 10px; font-weight: bold; font-size: 18px;
    }

    .cell-selected {
      background-color: #b3e5fc !important;
    }
    .cell-focused {
      outline: 2px solid #0288d1 !important;
      outline-offset: -2px;
    }
    #tableBody tr:hover td, #japanTableBody tr:hover td {
        background-color: #f1f1f1 !important;
        cursor: pointer;
    }
    #tableBody tr:hover td.sticky-col,
    #japanTableBody tr:hover td.sticky-col {
        background-color: #e9e9e9 !important;
    }

    .cell-ok { background-color: #e8f5e9 !important; }
    .cell-cancel { background-color: #ffebee !important; }
    .cell-xl { background-color: #fffde7 !important; }

    .drag-handle {
        position: absolute;
        right: 0;
        bottom: 0;
        width: 8px;
        height: 8px;
        background-color: #0288d1;
        border: 1px solid white;
        cursor: crosshair;
        z-index: 40;
    }

    .summary-table {
      width: 100%; margin-bottom: 20px; background: white;
      border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      overflow: hidden; font-size: 13px;
    }
    .summary-table th { background-color: #2c3e50; position: sticky; top: 0; }
    .summary-table td { text-align: center; }
    .positive { color: #27ae60; font-weight: bold; }
    .negative { color: #e74c3c; font-weight: bold; }
    .summary-staff-header td { background-color: #ecf0f1 !important; font-weight: bold; text-align: left !important; color: #2c3e50; }
    .summary-staff-total td { background-color: #bdc3c7 !important; font-weight: bold; }
    .summary-grand-total td { background-color: #34495e !important; font-weight: bold; color: white; }

    ::-webkit-scrollbar { -webkit-appearance: none; height: 15px; width: 15px; }
    ::-webkit-scrollbar-thumb { border-radius: 5px; background-color: #e74c3c; border: 2px solid #f5f5f5; }
    ::-webkit-scrollbar-thumb:hover { background-color: #c0392b; }

    td select, .controls .filter-select, th .filter-select {
      background-color: #e3f2fd; border: 1px solid #b0bec5; border-radius: 4px;
      cursor: pointer; transition: background-color 0.2s, box-shadow 0.2s;
    }
    td select:hover, .controls .filter-select:hover, th .filter-select:hover { background-color: #d1eaff; }
    td select:focus, .controls .filter-select:focus, th .filter-select:focus {
      outline: none; border-color: #3498db; box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.4);
    }
  </style>
</head>
<body>
  <h2>QUẢN LÝ VẬN ĐƠN</h2>
  <div class="tab-controls" style="margin-left: 20px; margin-bottom: 15px;">
      <button id="tabData" class="tab-btn active">Dữ liệu đơn hàng</button>
      <button id="tabJapan" class="tab-btn">Đơn Nhật</button>
      <button id="tabReport" class="tab-btn">Báo cáo tổng kết</button>
  </div>
  <div id="contentData" class="content-tab active">
    <div class="controls">
      <div class="left-controls">
        <span id="userInfo"></span>
        <button id="refreshData" class="refresh-btn"><span class="refresh-icon">↻</span> Load dữ liệu</button>
        <button id="updateAll" class="update-btn">Cập nhật tất cả</button>
        <div id="summaryInfo" class="summary-info"></div>
      </div>
      <div class="right-controls">
        <div class="date-filter">
          <span>Lọc từ ngày:</span><input type="date" id="startDateFilter" />
          <span>Đến ngày:</span><input type="date" id="endDateFilter" />
        </div>
         <select id="productFilter" class="filter-select"><option value="">Tất cả sản phẩm</option></select>
         <select id="marketFilter" class="filter-select"><option value="">Tất cả khu vực</option></select>
        <button id="clearFilters" class="clear-filter-btn">Xóa bộ lọc</button>
      </div>
    </div>
    <div class="main-table-wrapper" id="tableContainer">
      <table>
        <thead id="tableHead"></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>
  <div id="contentJapan" class="content-tab">
      <div class="controls">
          <div class="left-controls">
              <span class="japan-tab-info">Đơn hàng khu vực: Nhật Bản</span>
              <button id="japanRefreshData" class="refresh-btn"><span class="refresh-icon">↻</span> Load dữ liệu</button>
              <button id="japanUpdateAll" class="update-btn">Cập nhật tất cả</button>
              <div id="japanSummaryInfo" class="summary-info"></div>
          </div>
          <div class="right-controls">
              <div class="date-filter">
                  <span>Lọc từ ngày:</span><input type="date" id="japanStartDateFilter" />
                  <span>Đến ngày:</span><input type="date" id="japanEndDateFilter" />
              </div>
              <select id="japanProductFilter" class="filter-select"><option value="">Tất cả sản phẩm</option></select>
              <select id="japanStaffFilter" class="filter-select"><option value="">Tất cả NV Vận đơn</option></select>
              <button id="japanClearFilters" class="clear-filter-btn">Xóa bộ lọc</button>
          </div>
      </div>
      <div class="main-table-wrapper" id="japanTableContainer">
          <table>
              <thead id="japanTableHead"></thead>
              <tbody id="japanTableBody"></tbody>
          </table>
      </div>
  </div>
  <div id="contentReport" class="content-tab">
    <div class="table-wrapper">
      <table class="summary-table">
        <thead>
          <tr>
            <th rowspan="2">NV Vận đơn</th><th rowspan="2">Đơn vị vận chuyển</th><th colspan="2">Đã Thanh Toán (có bill)</th><th rowspan="2">Bill 1 phần</th><th rowspan="2">Tổng đơn lên nội bộ</th><th rowspan="2">Tổng đơn đủ đkien đẩy vh</th><th rowspan="2">Tổng đơn lên vận hành</th><th rowspan="2">Tỷ lệ đơn lên vận hành</th><th rowspan="2">Giao Thành Công</th><th rowspan="2">Đang Giao</th><th rowspan="2">Chưa Giao</th><th rowspan="2">Hoàn</th><th rowspan="2">chờ check</th><th rowspan="2">Trống trạng thái</th><th rowspan="2">Tỷ lệ thu tiền/giao thành công</th><th rowspan="2">Tỷ lệ đơn tính phí vc</th>
          </tr>
          <tr>
            <th>Số đơn</th><th>Thành Tiền</th>
          </tr>
        </thead>
        <tbody id="summaryTableBody"></tbody>
      </table>
    </div>
  </div>
  <script>
    const POST_URL = 'https://script.google.com/macros/s/AKfycbyGW5O47Y0TwPEqRzta72wwNSUN3jA1IPzSr1N72eOxVcqH4G8sgyelQROtDk9aVq75/exec';
    const FIXED_COLUMN_COUNT = 7; // Số lượng cột muốn cố định
    const columnDisplayMapping = { "Ghi chú vận đơn": "Ngày hẹn đẩy đơn" };
    const editableCols = ["Kết quả Check", "Trạng thái giao hàng NB", "Lý do", "Trạng thái thu tiền", "Ngày hẹn đẩy đơn"];
    const dropdownCols = {
        "Kết quả Check": ["", "OK", "Huỷ", "Treo", "Vận đơn XL", "Đợi hàng", "Khách hẹn"],
        "Trạng thái giao hàng NB": ["", "Giao Thành Công", "Đang Giao", "Chưa Giao", "Hủy", "Hoàn", "chờ check", "Giao không thành công", "Bom_Thất Lạc"],
        "Trạng thái thu tiền": ["", "Có bill", "Có bill 1 phần", "Bom_bùng_chặn", "Hẹn Thanh Toán", "Hoàn Hàng", "Khó Đòi", "Không nhận được hàng", "Không PH dưới 3N", "Thanh toán phí hoàn", "KPH nhiều ngày"]
    };
    const displayColumns = ["Mã đơn hàng", "Kết quả Check", "Trạng thái giao hàng NB", "Mã Tracking", "Lý do", "Trạng thái thu tiền", "Ghi chú vận đơn", "Ngày lên đơn", "Name*", "Phone*", "Add", "City", "State", "khu vực", "Zipcode", "Mặt hàng", "Tên mặt hàng 1", "Số lượng mặt hàng 1", "Tên mặt hàng 2", "Số lượng mặt hàng 2", "Quà tặng", "Số lượng quà kèm", "Giá bán", "Loại tiền thanh toán", "Tổng tiền VNĐ", "Hình thức thanh toán", "Ghi chú", "Ngày đóng hàng", "Trạng thái giao hàng", "Thời gian giao dự kiến", "Phí ship nội địa Mỹ (usd)", "Phí xử lý đơn đóng hàng-Lưu kho(usd)", "GHI CHÚ", "Nhân viên Sale", "NV Vận đơn", "Đơn vị vận chuyển", "Số tiền của đơn hàng đã về TK Cty", "Kế toán xác nhận thu tiền về"];
    const allDateColumns = ["Ngày lên đơn", "Ngày đóng hàng", "Ngày hẹn đẩy đơn"];
    const columnsToMakeDynamic = ["Kết quả Check", "Trạng thái giao hàng NB", "Trạng thái thu tiền", "khu vực", "Mặt hàng", "Nhân viên Sale", "NV Vận đơn", "Đơn vị vận chuyển"];

    let allData = [], staffFilteredData = [], japanData = [], changedRows = new Set(), japanChangedRows = new Set(), currentStaff = null, teamMembers = [], dynamicFilterOptions = {}, japanDynamicFilterOptions = {};

    let selectedCells = new Set();
    let isMouseDown = false;
    let isFilling = false;
    let startCell = null;
    let focusedCell = null;

    const mainTabConfig = {
        data: () => staffFilteredData, changedRows: changedRows,
        controls: { refreshBtn: 'refreshData', updateBtn: 'updateAll', clearBtn: 'clearFilters', startDate: 'startDateFilter', endDate: 'endDateFilter', product: 'productFilter', market: 'marketFilter', summary: 'summaryInfo' },
        table: { head: 'tableHead', body: 'tableBody' },
        dynamicOptions: () => dynamicFilterOptions
    };
    const japanTabConfig = {
        data: () => japanData, changedRows: japanChangedRows,
        controls: { refreshBtn: 'japanRefreshData', updateBtn: 'japanUpdateAll', clearBtn: 'japanClearFilters', startDate: 'japanStartDateFilter', endDate: 'japanEndDateFilter', product: 'japanProductFilter', staff: 'japanStaffFilter', summary: 'japanSummaryInfo' },
        table: { head: 'japanTableHead', body: 'japanTableBody' },
        dynamicOptions: () => japanDynamicFilterOptions
    };

    function getCurrentConfig() {
        const activeTabId = document.querySelector('.tab-btn.active').id;
        return activeTabId === 'tabJapan' ? japanTabConfig : mainTabConfig;
    }

    function getCellValue(cell) {
        if (!cell) return '';
        const input = cell.querySelector('input, select');
        if (input) return input.value;
        return cell.textContent;
    }

    function setCellValue(cell, value) {
        if (!cell) return;
        const input = cell.querySelector('input, select');
        if (input) {
            if(input.tagName === 'SELECT'){
                const optionExists = [...input.options].some(opt => opt.value === value);
                if(optionExists) input.value = value;
            } else {
                 input.value = value;
            }
        } else if (cell.isContentEditable) {
            cell.textContent = value;
        }
    }

    function clearSelection() {
        selectedCells.forEach(cell => cell.classList.remove('cell-selected'));
        selectedCells.clear();
        if (focusedCell) {
            focusedCell.classList.remove('cell-focused');
            const handle = focusedCell.querySelector('.drag-handle');
            if (handle) handle.remove();
            focusedCell = null;
        }
    }

    function setFocus(cell) {
        clearSelection();
        cell.classList.add('cell-selected', 'cell-focused');
        selectedCells.add(cell);
        focusedCell = cell;
        if (cell.classList.contains('editable')) {
            const handle = document.createElement('div');
            handle.className = 'drag-handle';
            cell.appendChild(handle);
        }
    }

    function getUrlParameter(name) { name = name.replace(/[\[\]]/g, '\\$&'); const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'); const results = regex.exec(window.location.href); if (!results) return null; if (!results[2]) return ''; return decodeURIComponent(results[2].replace(/\+/g, ' '));}
    function parseDateString(dateString) { if (!dateString || typeof dateString !== 'string') return null; const cleanedDateString = dateString.trim().replace(/[^\d\/\-\s]/g, ''); if (/^\d{4}-\d{2}-\d{2}/.test(cleanedDateString)) { const d = new Date(cleanedDateString); if (!isNaN(d.getTime())) return d; } const parts = cleanedDateString.match(/^(\d{1,2})[/\-](\d{1,2})[/\-](\d{4})/); if (parts) { const month = parseInt(parts[1], 10); const day = parseInt(parts[2], 10); const year = parseInt(parts[3], 10); if (year > 1000 && month > 0 && month <= 12 && day > 0 && day <= 31) { const d = new Date(Date.UTC(year, month - 1, day)); if (d.getUTCFullYear() === year && d.getUTCMonth() === month - 1) return d; } } return null; }
    function formatDate(dateString) { const originalValue = (typeof dateString === 'string') ? dateString.trim() : ''; if (!originalValue) return { display: '', original: '' }; const dateObj = parseDateString(originalValue); if (dateObj) { const day = String(dateObj.getUTCDate()).padStart(2, '0'); const month = String(dateObj.getUTCMonth() + 1).padStart(2, '0'); const year = dateObj.getUTCFullYear(); return { display: `${day}/${month}/${year}`, original: originalValue }; } return { display: originalValue, original: originalValue }; }
    async function fetchStaffInfo(idns, id1 = null) { try { const staffApiUrl = 'https://script.google.com/macros/s/AKfycbzwOv7UFwrqzf88QJL1QrxLKcnnnSIQ_PSmF0SO8LboqWI5li3vF3W8_-8s-A8lNGaR/exec'; const response = await fetch(staffApiUrl, { cache: "no-store" }); if (!response.ok) throw new Error('Lỗi mạng khi tải data nhân viên'); const data = await response.json(); let staffMember = data.find(staff => String(staff.idnv) === idns); let staffMember1 = id1 ? data.find(staff => String(staff.idnv) === id1) : null; if (!staffMember && !staffMember1) { let errorMsg = `Không tìm thấy nhân viên với ID: ${idns}`; if (id1) errorMsg += ` hoặc ID1: ${id1}`; throw new Error(errorMsg); } const memberNames = new Set(); if (staffMember) { if (staffMember.ho_va_ten) memberNames.add(staffMember.ho_va_ten); if (staffMember.vi_tri === "Leader" && staffMember.team) { const teamName = staffMember.team; data.forEach(member => { if (member.team === teamName && member.ho_va_ten) memberNames.add(member.ho_va_ten); }); } } if (staffMember1 && staffMember1.ho_va_ten) memberNames.add(staffMember1.ho_va_ten); teamMembers = Array.from(memberNames); return staffMember || staffMember1; } catch (error) { showError(error.message); throw error; } }
    function showError(message, containerId = 'tableBody') { const container = document.getElementById(containerId); const colCount = displayColumns.length; container.innerHTML = `<tr><td colspan="${colCount}" class="no-data">${message}</td></tr>`; }
    function createEmptyStats() { return { "Đã Thanh Toán (có bill)": { count: 0, amount: 0 }, "Bill 1 phần": { count: 0, amount: 0 }, "Tổng đơn lên nội bộ": { count: 0, amount: 0 }, "Tổng đơn đủ đkien đẩy vh": { count: 0, amount: 0 }, "Tổng đơn lên vận hành": { count: 0, amount: 0 }, "Giao Thành Công": { count: 0, amount: 0 }, "Đang Giao": { count: 0, amount: 0 }, "Chưa Giao": { count: 0, amount: 0 }, "Hoàn": { count: 0, amount: 0 }, "chờ check": { count: 0, amount: 0 }, "Trống trạng thái": { count: 0, amount: 0 } }; }
    function updateSummaryInfo(filteredData, summaryElementId, isMainTabReport = false) { const totalOrders = filteredData.length; const totalAmount = filteredData.reduce((sum, row) => { let amountValue = row["Tổng tiền VNĐ"] || row["Tổng_tiền_VNĐ"] || 0; const numericValue = parseFloat(String(amountValue).replace(/[^\d.-]/g, '')) || 0; return sum + numericValue; }, 0); const formattedAmount = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(totalAmount); document.getElementById(summaryElementId).innerHTML = `Tổng đơn: <span style="color: #e74c3c;">${totalOrders}</span> | Tổng tiền: <span style="color: #27ae60;">${formattedAmount}</span>`; if (isMainTabReport) { updateDetailedSummaryTable(filteredData); } }
    function updateDetailedSummaryTable(filteredData) { const summaryTableBody = document.getElementById('summaryTableBody'); summaryTableBody.innerHTML = ''; if (filteredData.length === 0) { showError('Không có dữ liệu thống kê.', 'summaryTableBody'); return; } const staffStats = {}; const grandTotal = createEmptyStats(); filteredData.forEach(row => { const staffName = row["NV Vận đơn"] || row["NV_Vận_đơn"] || "Chưa có NV"; const shippingCompany = row["Đơn vị vận chuyển"] || row["Đơn_vị_vận_chuyển"] || "Không xác định"; if (!staffStats[staffName]) { staffStats[staffName] = { _total: createEmptyStats() }; } if (!staffStats[staffName][shippingCompany]) { staffStats[staffName][shippingCompany] = createEmptyStats(); } const statsToUpdate = [ staffStats[staffName][shippingCompany], staffStats[staffName]._total, grandTotal ]; const amountValue = row["Tổng tiền VNĐ"] || row["Tổng_tiền_VNĐ"] || 0; const numericAmount = parseFloat(String(amountValue).replace(/[^\d.-]/g, '')) || 0; const paymentStatus = row["Trạng thái thu tiền"] || ""; const deliveryStatus = row["Trạng thái giao hàng NB"] || ""; statsToUpdate.forEach(stats => { if (paymentStatus.includes("Có bill")) { stats["Đã Thanh Toán (có bill)"].count++; stats["Đã Thanh Toán (có bill)"].amount += numericAmount; } else if (paymentStatus.includes("Có bill 1 phần")) { stats["Bill 1 phần"].count++; } if (deliveryStatus.includes("Giao Thành Công")) stats["Giao Thành Công"].count++; else if (deliveryStatus.includes("Đang Giao")) stats["Đang Giao"].count++; else if (deliveryStatus.includes("Chưa Giao")) stats["Chưa Giao"].count++; else if (deliveryStatus.includes("Hoàn")) stats["Hoàn"].count++; else if (deliveryStatus.includes("chờ check")) stats["chờ check"].count++; else if (deliveryStatus === "") stats["Trống trạng thái"].count++; stats["Tổng đơn lên nội bộ"].count++; if (paymentStatus.includes("Có bill") || paymentStatus.includes("Có bill 1 phần")) { stats["Tổng đơn đủ đkien đẩy vh"].count++; } if (deliveryStatus && !deliveryStatus.includes("Chưa Giao") && !deliveryStatus.includes("chờ check")) { stats["Tổng đơn lên vận hành"].count++; } }); }); Object.keys(staffStats).sort().forEach(staffName => { const staffData = staffStats[staffName]; const headerRow = summaryTableBody.insertRow(); headerRow.className = 'summary-staff-header'; const headerCell = headerRow.insertCell(); headerCell.colSpan = 17; headerCell.textContent = `Nhân viên: ${staffName}`; Object.keys(staffData).filter(key => key !== '_total').sort().forEach(companyName => { const companyData = staffData[companyName]; const tr = renderSummaryRow(staffName, companyName, companyData); summaryTableBody.appendChild(tr); }); const totalRow = renderSummaryRow("Tổng cộng", "Tất cả DVVC", staffData._total); totalRow.className = 'summary-staff-total'; summaryTableBody.appendChild(totalRow); }); const grandTotalRow = renderSummaryRow("TỔNG TOÀN BỘ", "Tất cả NV & DVVC", grandTotal); grandTotalRow.className = 'summary-grand-total'; summaryTableBody.appendChild(grandTotalRow); }
    function renderSummaryRow(staffName, companyName, data) { const tr = document.createElement('tr'); tr.insertCell().textContent = staffName; tr.insertCell().textContent = companyName; tr.insertCell().textContent = data["Đã Thanh Toán (có bill)"].count; const paidAmountCell = tr.insertCell(); paidAmountCell.textContent = new Intl.NumberFormat('vi-VN').format(data["Đã Thanh Toán (có bill)"].amount) + ' ₫'; tr.insertCell().textContent = data["Bill 1 phần"].count; tr.insertCell().textContent = data["Tổng đơn lên nội bộ"].count; tr.insertCell().textContent = data["Tổng đơn đủ đkien đẩy vh"].count; tr.insertCell().textContent = data["Tổng đơn lên vận hành"].count; const shippingRate = data["Tổng đơn lên nội bộ"].count > 0 ? (data["Tổng đơn lên vận hành"].count / data["Tổng đơn lên nội bộ"].count * 100) : 0; const shippingRateCell = tr.insertCell(); shippingRateCell.textContent = shippingRate.toFixed(2) + '%'; shippingRateCell.className = shippingRate > 70 ? 'positive' : 'negative'; tr.insertCell().textContent = data["Giao Thành Công"].count; tr.insertCell().textContent = data["Đang Giao"].count; tr.insertCell().textContent = data["Chưa Giao"].count; tr.insertCell().textContent = data["Hoàn"].count; tr.insertCell().textContent = data["chờ check"].count; tr.insertCell().textContent = data["Trống trạng thái"].count; const paymentSuccessRate = data["Giao Thành Công"].count > 0 ? (data["Đã Thanh Toán (có bill)"].count / data["Giao Thành Công"].count * 100) : 0; const paymentRateCell = tr.insertCell(); paymentRateCell.textContent = paymentSuccessRate.toFixed(2) + '%'; paymentRateCell.className = paymentSuccessRate > 80 ? 'positive' : 'negative'; const feeRate = data["Tổng đơn lên vận hành"].count > 0 ? (data["Giao Thành Công"].count / data["Tổng đơn lên vận hành"].count * 100) : 0; const feeRateCell = tr.insertCell(); feeRateCell.textContent = feeRate.toFixed(2) + '%'; feeRateCell.className = feeRate > 80 ? 'positive' : 'negative'; return tr; }

    function setupCellSelection(tableBodyId) {
        const tableBody = document.getElementById(tableBodyId);
        if(!tableBody) return;

        tableBody.addEventListener('mousedown', (e) => {
            e.preventDefault();
            const target = e.target;
            const clickedCell = target.closest('td');
            if (!clickedCell) return;
            if (target.classList.contains('drag-handle')) {
                isFilling = true;
                startCell = focusedCell;
                return;
            }
            isMouseDown = true;
            startCell = clickedCell;
            if (e.ctrlKey) {
                if (selectedCells.has(clickedCell)) {
                    clickedCell.classList.remove('cell-selected');
                    selectedCells.delete(clickedCell);
                } else {
                    clickedCell.classList.add('cell-selected');
                    selectedCells.add(clickedCell);
                }
            } else {
                setFocus(clickedCell);
            }
        });

        tableBody.addEventListener('mouseover', (e) => {
            const currentCell = e.target.closest('td');
            if (!currentCell) return;
            if (isFilling) {
                const config = getCurrentConfig();
                if (currentCell.cellIndex === startCell.cellIndex && currentCell.classList.contains('editable')) {
                    const sourceValue = getCellValue(startCell);
                    setCellValue(currentCell, sourceValue);
                    currentCell.classList.add('highlight');
                    const rowIndex = parseInt(currentCell.parentElement.dataset.rowIndex, 10);
                    config.changedRows.add(rowIndex);
                }
            }
            else if (isMouseDown) {
                clearSelection();
                const rows = tableBody.rows;
                const minRow = Math.min(startCell.parentNode.rowIndex, currentCell.parentNode.rowIndex);
                const maxRow = Math.max(startCell.parentNode.rowIndex, currentCell.parentNode.rowIndex);
                const minCol = Math.min(startCell.cellIndex, currentCell.cellIndex);
                const maxCol = Math.max(startCell.cellIndex, currentCell.cellIndex);

                for (let i = minRow; i <= maxRow; i++) {
                    for (let j = minCol; j <= maxCol; j++) {
                        const cell = rows[i].cells[j];
                        if (cell) {
                            cell.classList.add('cell-selected');
                            selectedCells.add(cell);
                        }
                    }
                }
                startCell.classList.add('cell-focused');
                focusedCell = startCell;
            }
        });

        document.addEventListener('mouseup', () => {
            isMouseDown = false;
            isFilling = false;
        });

        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'c' && selectedCells.size > 0) {
                e.preventDefault();
                copySelectedCells();
            }
        });
    }

    function copySelectedCells() { if (selectedCells.size === 0) return; let minRow = Infinity, maxRow = -Infinity, minCol = Infinity, maxCol = -Infinity; const tableBody = focusedCell.closest('tbody'); selectedCells.forEach(cell => { const row = cell.parentNode.rowIndex; const col = cell.cellIndex; minRow = Math.min(minRow, row); maxRow = Math.max(maxRow, row); minCol = Math.min(minCol, col); maxCol = Math.max(maxCol, col); }); const grid = Array(maxRow - minRow + 1).fill().map(() => Array(maxCol - minCol + 1).fill('')); selectedCells.forEach(cell => { const row = cell.parentNode.rowIndex - minRow; const col = cell.cellIndex - minCol; grid[row][col] = getCellValue(cell).trim(); }); const tsv = grid.map(row => row.join('\t')).join('\n'); navigator.clipboard.writeText(tsv).then(() => { const tempMsg = document.createElement('div'); tempMsg.textContent = `Đã sao chép ${selectedCells.size} ô`; Object.assign(tempMsg.style, { position: 'fixed', bottom: '20px', right: '20px', backgroundColor: '#2ecc71', color: 'white', padding: '10px', borderRadius: '4px', zIndex: '1000' }); document.body.appendChild(tempMsg); setTimeout(() => tempMsg.remove(), 2000); }).catch(err => console.error('Lỗi sao chép:', err)); }
    async function handleData(response) { document.getElementById(mainTabConfig.controls.refreshBtn).innerHTML = '<span class="refresh-icon">↻</span> Load dữ liệu'; document.getElementById(japanTabConfig.controls.refreshBtn).innerHTML = '<span class="refresh-icon">↻</span> Load dữ liệu'; allData = []; staffFilteredData = []; japanData = []; changedRows.clear(); japanChangedRows.clear(); if (response.error || !Array.isArray(response.rows)) { showError('Lỗi hoặc không có dữ liệu: ' + (response.error || 'Định dạng dữ liệu không đúng'), mainTabConfig.table.body); showError('Lỗi hoặc không có dữ liệu: ' + (response.error || 'Định dạng dữ liệu không đúng'), japanTabConfig.table.body); return; } allData = response.rows; const staffId = getUrlParameter('id'); const staffId1 = getUrlParameter('id1'); if (!staffId && !staffId1) { showError('Thiếu tham số ID nhân viên trong URL', mainTabConfig.table.body); } else { try { currentStaff = await fetchStaffInfo(staffId, staffId1); let staffInfo = `Nhân viên: ${currentStaff.ho_va_ten}`; if (staffId1 && staffId1 !== staffId) { staffInfo += ` và ${teamMembers.find(name => name !== currentStaff.ho_va_ten) || ''}`; } if (currentStaff.vi_tri === "Leader") staffInfo += ` (Leader - Team ${currentStaff.team})`; document.getElementById('userInfo').textContent = staffInfo; staffFilteredData = allData.filter(row => { const deliveryStaff = row["NV Vận đơn"] || row["NV_Vận_đơn"] || ''; return teamMembers.includes(deliveryStaff); }); initializeTab(mainTabConfig, staffFilteredData); } catch (error) { showError(error.message, mainTabConfig.table.body); } } japanData = allData.filter(row => (row['khu vực'] || row['Khu vực']) === 'Nhật Bản'); initializeTab(japanTabConfig, japanData); }
    function initializeTab(config, data) { generateDynamicOptions(config, data); populateExternalFilters(config); renderHeader(config); applyAllFilters(config); setupCellSelection(config.table.body); }
    function generateDynamicOptions(config, data) { const options = {}; columnsToMakeDynamic.forEach(colName => { const dataKey = columnDisplayMapping[colName] || colName; const uniqueValues = new Set(data.map(row => row[dataKey] || row[dataKey.replace(/ /g, '_')] || (dataKey === 'khu vực' ? (row['Khu vực'] || '') : '')).filter(Boolean)); options[colName] = Array.from(uniqueValues).sort((a, b) => String(a).localeCompare(String(b))); }); if (config === japanTabConfig) { japanDynamicFilterOptions = options; } else { dynamicFilterOptions = options; } }
    function populateExternalFilters(config) { const options = config.dynamicOptions(); const productFilter = document.getElementById(config.controls.product); productFilter.innerHTML = '<option value="">Tất cả sản phẩm</option>'; (options['Mặt hàng'] || []).forEach(opt => productFilter.add(new Option(opt, opt))); if (config.controls.market) { const marketFilter = document.getElementById(config.controls.market); marketFilter.innerHTML = '<option value="">Tất cả khu vực</option>'; (options['khu vực'] || []).forEach(opt => marketFilter.add(new Option(opt, opt))); } if (config.controls.staff) { const staffFilter = document.getElementById(config.controls.staff); staffFilter.innerHTML = '<option value="">Tất cả NV Vận đơn</option>'; (options['NV Vận đơn'] || []).forEach(opt => staffFilter.add(new Option(opt, opt))); } }
    function applyAllFilters(config) { clearSelection(); let dataToFilter = [...config.data()]; const tableHead = document.getElementById(config.table.head); if (!tableHead.querySelector('tr')) { renderTableBody(config, dataToFilter); updateSummaryInfo(dataToFilter, config.controls.summary, config === mainTabConfig); return; } const startDate = document.getElementById(config.controls.startDate).value; const endDate = document.getElementById(config.controls.endDate).value; if (startDate || endDate) { const start = startDate ? new Date(startDate) : null; const end = endDate ? new Date(endDate) : null; if(start) start.setHours(0,0,0,0); if(end) end.setHours(23,59,59,999); dataToFilter = dataToFilter.filter(row => { const orderDateStr = row["Ngày lên đơn"] || row["Thời gian lên đơn"]; const orderDate = parseDateString(orderDateStr); if (!orderDate) return false; return (!start || orderDate >= start) && (!end || orderDate <= end); }); } const productFilterValue = document.getElementById(config.controls.product).value; if (productFilterValue) dataToFilter = dataToFilter.filter(row => (row["Mặt hàng"] || '') === productFilterValue); if (config.controls.market && document.getElementById(config.controls.market).value) { const marketFilterValue = document.getElementById(config.controls.market).value; dataToFilter = dataToFilter.filter(row => (row["Khu vực"] || row["khu vực"] || '') === marketFilterValue); } if (config.controls.staff && document.getElementById(config.controls.staff).value) { const staffFilterValue = document.getElementById(config.controls.staff).value; dataToFilter = dataToFilter.filter(row => (row["NV Vận đơn"] || row["NV_Vận_đơn"] || '') === staffFilterValue); } const filters = tableHead.querySelectorAll('.filter-input, .filter-select'); filters.forEach(filter => { const value = filter.value.toLowerCase(); if (value === '') return; const colName = filter.dataset.column; const dataKey = columnDisplayMapping[colName] || colName; dataToFilter = dataToFilter.filter(row => { let cellValue = row[dataKey] !== undefined ? row[dataKey] : row[dataKey.replace(/ /g, '_')] || ''; if (dataKey === 'khu vực') cellValue = row['Khu vực'] || row['khu vực'] || ''; return String(cellValue).toLowerCase().includes(value); }); }); updateSummaryInfo(dataToFilter, config.controls.summary, config === mainTabConfig); renderTableBody(config, dataToFilter); }

    function applyStickyColumns(config) {
        const headRow = document.querySelector(`#${config.table.head} tr`);
        const bodyRows = document.querySelectorAll(`#${config.table.body} tr`);

        if (!headRow || headRow.cells.length === 0) return;

        const leftOffsets = [];
        let currentOffset = 0;

        for (let i = 0; i < FIXED_COLUMN_COUNT && i < headRow.cells.length; i++) {
            leftOffsets.push(currentOffset);
            currentOffset += headRow.cells[i].offsetWidth;
        }

        for (let i = 0; i < FIXED_COLUMN_COUNT && i < headRow.cells.length; i++) {
            const th = headRow.cells[i];
            th.classList.add('sticky-col');
            th.style.left = `${leftOffsets[i]}px`;
        }

        bodyRows.forEach(row => {
            for (let i = 0; i < FIXED_COLUMN_COUNT && i < row.cells.length; i++) {
                const td = row.cells[i];
                td.classList.add('sticky-col');
                td.style.left = `${leftOffsets[i]}px`;
            }
        });
    }

    function renderHeader(config) { const header = document.getElementById(config.table.head); const options = config.dynamicOptions(); header.innerHTML = ''; const tr = document.createElement('tr'); const filterFunction = () => applyAllFilters(config); displayColumns.forEach(colName => { const th = document.createElement('th'); th.textContent = colName; let filterElement; if (options[colName]) { filterElement = document.createElement('select'); filterElement.className = 'filter-select'; filterElement.add(new Option(`Tất cả ${colName}`, '')); options[colName].forEach(opt => filterElement.add(new Option(opt, opt))); filterElement.addEventListener('change', filterFunction); } else { filterElement = document.createElement('input'); filterElement.type = 'text'; filterElement.className = 'filter-input'; filterElement.placeholder = `Lọc ${colName}...`; filterElement.addEventListener('input', filterFunction); } filterElement.dataset.column = colName; th.appendChild(document.createElement('br')); th.appendChild(filterElement); tr.appendChild(th); }); header.appendChild(tr); }
    function renderTableBody(config, data) { const container = document.getElementById(config.table.body); container.innerHTML = ''; if (data.length === 0) { showError(`Không có đơn hàng nào khớp với bộ lọc.`, config.table.body); return; } const originalDataSet = config.data(); data.forEach((row) => { const originalRowIndex = originalDataSet.indexOf(row); const tr = document.createElement('tr'); tr.dataset.rowIndex = originalRowIndex; displayColumns.forEach((col, colIndex) => { const td = document.createElement('td'); if (colIndex >= FIXED_COLUMN_COUNT) { td.style.position = 'relative'; } const dataKey = columnDisplayMapping[col] || col; let value; if (allDateColumns.includes(dataKey)) { const dateSource = dataKey === "Ngày lên đơn" ? (row["Ngày lên đơn"] || row["Thời gian lên đơn"]) : (row[dataKey] || ''); const formattedDate = formatDate(dateSource); value = (dataKey === "Ngày hẹn đẩy đơn") ? (row[dataKey] || '') : formattedDate.display; td.dataset.originalValue = formattedDate.original; } else { value = row[dataKey] || row[dataKey.replace(/ /g, '_')] || (dataKey === 'khu vực' ? (row['Khu vực'] || '') : ''); } if (editableCols.includes(dataKey)) { td.classList.add('editable'); if (dropdownCols[dataKey]) { const select = document.createElement('select'); dropdownCols[dataKey].forEach(opt => select.add(new Option(opt, opt))); select.value = value; select.addEventListener('change', () => { td.classList.add('highlight'); config.changedRows.add(originalRowIndex); }); td.appendChild(select); } else if (dataKey === "Ngày hẹn đẩy đơn") { const input = document.createElement('input'); input.type = 'text'; input.className = 'date-input'; input.value = value; input.addEventListener('input', () => { td.classList.add('highlight'); config.changedRows.add(originalRowIndex); }); td.appendChild(input); } else { td.contentEditable = 'true'; td.textContent = value; td.addEventListener('input', () => { td.classList.add('highlight'); config.changedRows.add(originalRowIndex); }); } } else { td.textContent = value; } if (col === "Kết quả Check") { if (value === 'OK') td.classList.add('cell-ok'); else if (value === 'Vận đơn XL') td.classList.add('cell-xl'); else if (value === 'Huỷ') td.classList.add('cell-cancel'); } tr.appendChild(td); }); container.appendChild(tr); }); applyStickyColumns(config); }
    function setupControls() { setupTabs(); setupTabControls(mainTabConfig); setupTabControls(japanTabConfig); }
    function setupTabControls(config) { document.getElementById(config.controls.refreshBtn).addEventListener('click', refreshData); document.getElementById(config.controls.updateBtn).addEventListener('click', () => updateAllChangedRows(config)); document.getElementById(config.controls.startDate).addEventListener('change', () => applyAllFilters(config)); document.getElementById(config.controls.endDate).addEventListener('change', () => applyAllFilters(config)); document.getElementById(config.controls.product).addEventListener('change', () => applyAllFilters(config)); if(config.controls.market) document.getElementById(config.controls.market).addEventListener('change', () => applyAllFilters(config)); if(config.controls.staff) document.getElementById(config.controls.staff).addEventListener('change', () => applyAllFilters(config)); document.getElementById(config.controls.clearBtn).addEventListener('click', () => { document.getElementById(config.controls.startDate).value = ''; document.getElementById(config.controls.endDate).value = ''; document.getElementById(config.controls.product).selectedIndex = 0; if(config.controls.market) document.getElementById(config.controls.market).selectedIndex = 0; if(config.controls.staff) document.getElementById(config.controls.staff).selectedIndex = 0; document.querySelectorAll(`#${config.table.head} .filter-input, #${config.table.head} .filter-select`).forEach(f => { if (f.tagName === 'SELECT') f.selectedIndex = 0; else f.value = ''; }); applyAllFilters(config); }); }
    function setupTabs() { const tabs = document.querySelectorAll('.tab-btn'); const contents = document.querySelectorAll('.content-tab'); tabs.forEach(tab => { tab.addEventListener('click', () => { clearSelection(); tabs.forEach(item => item.classList.remove('active')); contents.forEach(content => content.classList.remove('active')); tab.classList.add('active'); const contentId = 'content' + tab.id.substring(3); document.getElementById(contentId).classList.add('active'); }); }); }
    function refreshData() { document.getElementById(mainTabConfig.controls.refreshBtn).innerHTML = '<span class="loading"></span> Đang tải...'; document.getElementById(japanTabConfig.controls.refreshBtn).innerHTML = '<span class="loading"></span> Đang tải...'; document.getElementById(mainTabConfig.controls.updateBtn).disabled = true; document.getElementById(japanTabConfig.controls.updateBtn).disabled = true; loadData(); setTimeout(() => { document.getElementById(mainTabConfig.controls.refreshBtn).innerHTML = '<span class="refresh-icon">↻</span> Load dữ liệu'; document.getElementById(japanTabConfig.controls.refreshBtn).innerHTML = '<span class="refresh-icon">↻</span> Load dữ liệu'; document.getElementById(mainTabConfig.controls.updateBtn).disabled = false; document.getElementById(japanTabConfig.controls.updateBtn).disabled = false; }, 5000); }
    function updateAllChangedRows(config) { if (config.changedRows.size === 0) { alert('Không có thay đổi nào để cập nhật'); return; } const updateBtn = document.getElementById(config.controls.updateBtn); const statusEl = document.createElement('span'); statusEl.className = 'status'; statusEl.textContent = 'Đang xử lý...'; updateBtn.appendChild(statusEl); updateBtn.disabled = true; const rowsToSend = []; const tableBody = document.getElementById(config.table.body); config.changedRows.forEach(rowIndex => { const originalData = config.data()[rowIndex]; if (!originalData) return; const tr = tableBody.querySelector(`tr[data-row-index="${rowIndex}"]`); if(!tr) return; const updatedRowData = { ...originalData }; editableCols.forEach(dataKey => { const displayKey = Object.keys(columnDisplayMapping).find(k => columnDisplayMapping[k] === dataKey) || dataKey; const colIndex = displayColumns.indexOf(displayKey); if (colIndex === -1) return; const cell = tr.cells[colIndex]; let valueFromDOM = getCellValue(cell).trim(); updatedRowData[dataKey] = valueFromDOM; }); allDateColumns.forEach(dataKey => { if (editableCols.indexOf(dataKey) === -1) { const displayKey = Object.keys(columnDisplayMapping).find(k => columnDisplayMapping[k] === dataKey) || dataKey; const colIndex = displayColumns.indexOf(displayKey); if (colIndex === -1) return; const cell = tr.cells[colIndex]; updatedRowData[dataKey] = cell.dataset.originalValue || cell.textContent.trim(); } }); delete updatedRowData["Thời gian lên đơn"]; rowsToSend.push(updatedRowData); }); if (rowsToSend.length === 0) { statusEl.textContent = 'Không có dòng nào hợp lệ để gửi.'; setTimeout(() => { if(statusEl.parentElement) updateBtn.removeChild(statusEl); updateBtn.disabled = false; }, 3000); return; } fetch(POST_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: new URLSearchParams({ rows: JSON.stringify(rowsToSend) }) }) .then(() => { statusEl.textContent = `Đã gửi ${rowsToSend.length} thay đổi.`; setTimeout(() => { alert(`Cập nhật thành công ${rowsToSend.length} dòng. Vui lòng nhấn "Load dữ liệu" để xem thay đổi.`); config.changedRows.clear(); document.querySelectorAll(`#${config.table.body} .highlight`).forEach(cell => cell.classList.remove('highlight')); if(statusEl.parentElement) updateBtn.removeChild(statusEl); updateBtn.disabled = false; }, 2000); }) .catch(e => { statusEl.textContent = 'Lỗi mạng: ' + e.message; statusEl.classList.add('error-status'); setTimeout(() => { if(statusEl.parentElement) updateBtn.removeChild(statusEl); updateBtn.disabled = false; }, 4000); }); }
    function loadData() { showError('Đang tải dữ liệu...', mainTabConfig.table.body); showError('Đang tải dữ liệu...', japanTabConfig.table.body); const script = document.createElement('script'); script.src = `${POST_URL}?callback=handleData&rand=${Math.random()}`; const oldScript = document.querySelector('script[src^="https://script.google.com"]'); if (oldScript) oldScript.remove(); document.body.appendChild(script); }

    setupControls();
    loadData();
  </script>
</body>
</html>


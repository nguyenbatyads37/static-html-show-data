<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý đơn hàng - Nhân viên</title>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #34495e;
            --text-color: #333;
            --border-color: #ddd;
            --selection-color: #aed6f1; /* Màu nền cho ô được chọn */
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* Làm cho việc bôi đen bằng chuột dễ nhìn hơn */
        ::selection {
            background-color: var(--primary-color);
            color: white;
        }
        
        body {
            background-color: #f5f7fa;
            color: var(--text-color);
            line-height: 1.6;
        }
        
        .container {
            max-width: 100%;
            margin: 20px auto;
            padding: 0 15px;
        }
        
        .header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 20px;
            border-radius: 5px 5px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .header h1 { font-size: 1.5rem; font-weight: 600; }
        
        .user-info {
            background-color: var(--light-color);
            padding: 10px;
            border-radius: 4px;
            font-weight: 500;
            color: var(--dark-color);
        }
        
        .controls-container {
            background-color: #fff;
            padding: 10px 15px;
            margin-top: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        .controls-container button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
            color: white;
        }

        #copySelectedBtn { background-color: var(--secondary-color); }
        #copySelectedBtn:hover { background-color: #2471a3; }
        #copyAllBtn { background-color: var(--success-color); }
        #copyAllBtn:hover { background-color: #27ae60; }
        #resetBtn { background-color: var(--warning-color); }
        #resetBtn:hover { background-color: #e67e22; }
        
        .table-container {
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-x: auto;
            margin-top: 1px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1700px;
        }
        
        thead {
            background-color: var(--primary-color);
            color: white;
            position: sticky;
            top: 0;
            z-index: 2;
        }
        
        th {
            padding: 12px 15px;
            text-align: left;
            font-weight: 500;
        }

        /* Cho phép click vào header cột/hàng */
        th.column-selector, td.row-selector {
            cursor: pointer;
        }
        
        .filter-row th { padding: 5px 10px; }
        .filter-input {
            width: 100%;
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        tbody tr {
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
        }
        
        tbody tr:nth-child(even) { background-color: #f8f9fa; }
        tbody tr:hover { background-color: #e9f7fe; }
        
        td {
            padding: 12px 15px;
            vertical-align: top;
            max-width: 250px;
            word-wrap: break-word;
            /* Cho phép chọn văn bản trong ô */
            user-select: text; 
        }

        /* Style cho các ô được chọn */
        td.cell-selected {
            background-color: var(--selection-color) !important;
            outline: 1px solid var(--primary-color);
        }
        
        .status {
            display: inline-block; padding: 4px 8px; border-radius: 4px;
            font-size: 0.8rem; font-weight: 500; white-space: nowrap;
        }
        .status-pending { background-color: #fff3cd; color: #856404; }
        .status-completed { background-color: #d4edda; color: #155724; }
        .status-cancelled { background-color: #f8d7da; color: #721c24; }
        .status-shipping { background-color: #cce5ff; color: #004085; }
        
        .loading, .error, .no-results {
            text-align: center; padding: 20px; font-size: 1.2rem;
            color: var(--dark-color); font-weight: 500;
        }
        .error { color: var(--danger-color); }
        
        .badge {
            display: inline-block; padding: 3px 7px; font-size: 0.75rem; font-weight: 600;
            line-height: 1; text-align: center; white-space: nowrap;
            vertical-align: baseline; border-radius: 10px; color: white;
        }
        .badge-success { background-color: var(--success-color); }
        .badge-warning { background-color: var(--warning-color); }
        .badge-danger { background-color: var(--danger-color); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Quản lý đơn hàng - Nhân viên</h1>
            <div class="user-info" id="userInfo">Đang tải thông tin...</div>
        </div>

        <div class="controls-container">
            <button id="copySelectedBtn">Sao chép vùng chọn</button>
            <button id="copyAllBtn">Sao chép toàn bộ (CSV)</button>
            <button id="resetBtn">Xóa bộ lọc</button>
            <span id="rowCount"></span>
        </div>
        
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th class="column-selector" title="Chọn/Bỏ chọn tất cả">#</th>
                        <th class="column-selector" data-col-index="1">Mã đơn hàng</th>
                        <th class="column-selector" data-col-index="2">Ngày lên đơn</th>
                        <th class="column-selector" data-col-index="3">Tên KH</th>
                        <th class="column-selector" data-col-index="4">SĐT</th>
                        <th class="column-selector" data-col-index="5">Địa chỉ</th>
                        <th class="column-selector" data-col-index="6">Thành phố</th>
                        <th class="column-selector" data-col-index="7">Tỉnh</th>
                        <th class="column-selector" data-col-index="8">Mặt hàng</th>
                        <th class="column-selector" data-col-index="9">Tổng tiền</th>
                        <th class="column-selector" data-col-index="10">Hình thức TT</th>
                        <th class="column-selector" data-col-index="11">Ghi chú</th>
                        <th class="column-selector" data-col-index="12">Trạng thái giao</th>
                        <th class="column-selector" data-col-index="13">Đơn vị VC</th>
                        <th class="column-selector" data-col-index="14">Trạng thái thu tiền</th>
                    </tr>
                    <tr class="filter-row">
                        <th></th>
                        <th><input type="text" class="filter-input" data-column="maDonHang"></th>
                        <th><input type="text" class="filter-input" data-column="ngayLenDon"></th>
                        <th><input type="text" class="filter-input" data-column="name"></th>
                        <th><input type="text" class="filter-input" data-column="phone"></th>
                        <th><input type="text" class="filter-input" data-column="address"></th>
                        <th><input type="text" class="filter-input" data-column="city"></th>
                        <th><input type="text" class="filter-input" data-column="state"></th>
                        <th><input type="text" class="filter-input" data-column="matHang"></th>
                        <th><input type="text" class="filter-input" data-column="tongTienVND"></th>
                        <th><input type="text" class="filter-input" data-column="hinhThucThanhToan"></th>
                        <th><input type="text" class="filter-input" data-column="ghiChu"></th>
                        <th><input type="text" class="filter-input" data-column="trangThaiGiaoHangNB"></th>
                        <th><input type="text" class="filter-input" data-column="donViVanChuyen"></th>
                        <th><input type="text" class="filter-input" data-column="trangThaiThuTien"></th>
                    </tr>
                </thead>
                <tbody id="orderTableBody">
                    <tr><td colspan="15" class="loading">Đang tải dữ liệu...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let allOrders = [];
        let currentDisplayedOrders = [];
        let selectedCells = new Set();

        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const idns = urlParams.get('idns');
            
            if (!idns) {
                showError('Không tìm thấy ID nhân viên trong URL (tham số idns).');
                return;
            }
            
            setupEventListeners();
            fetchStaffData(idns);
        });

        function setupEventListeners() {
            document.querySelectorAll('.filter-input').forEach(input => {
                input.addEventListener('input', applyFilters);
            });
            document.getElementById('resetBtn').addEventListener('click', resetFilters);
            document.getElementById('copyAllBtn').addEventListener('click', downloadCSV);
            document.getElementById('copySelectedBtn').addEventListener('click', copySelectedToClipboard);
            
            // Event delegation for cell selection
            const tableBody = document.getElementById('orderTableBody');
            tableBody.addEventListener('click', handleCellClick);

            const tableHead = document.querySelector('thead');
            tableHead.addEventListener('click', handleHeaderClick);
        }
        
        function handleCellClick(event) {
            const cell = event.target.closest('td');
            if (!cell) return;

            if (event.ctrlKey) { // Ctrl+Click to toggle selection
                if (selectedCells.has(cell)) {
                    selectedCells.delete(cell);
                    cell.classList.remove('cell-selected');
                } else {
                    selectedCells.add(cell);
                    cell.classList.add('cell-selected');
                }
            } else { // Simple click to select one cell
                clearSelection();
                selectedCells.add(cell);
                cell.classList.add('cell-selected');
            }

            // If it's a row selector cell, select the whole row
            if (cell.classList.contains('row-selector')) {
                const row = cell.parentElement;
                row.querySelectorAll('td').forEach(td => {
                    selectedCells.add(td);
                    td.classList.add('cell-selected');
                });
            }
        }
        
        function handleHeaderClick(event) {
            const header = event.target.closest('th.column-selector');
            if (!header) return;

            clearSelection();
            const colIndex = header.dataset.colIndex;
            if (colIndex) { // Select a specific column
                document.querySelectorAll(`#orderTableBody tr td:nth-child(${parseInt(colIndex) + 1})`).forEach(cell => {
                    selectedCells.add(cell);
                    cell.classList.add('cell-selected');
                });
            } else { // Select All (# header)
                 document.querySelectorAll(`#orderTableBody td`).forEach(cell => {
                    selectedCells.add(cell);
                    cell.classList.add('cell-selected');
                });
            }
        }

        function clearSelection() {
            selectedCells.forEach(cell => cell.classList.remove('cell-selected'));
            selectedCells.clear();
        }

        function fetchStaffData(idns) { /* ... Giữ nguyên hàm này ... */
            const staffApiUrl = 'https://script.google.com/macros/s/AKfycbzwOv7UFwrqzf88QJL1QrxLKcnnnSIQ_PSmF0SO8LboqWI5li3vF3W8_-8s-A8lNGaR/exec';
            fetch(staffApiUrl)
                .then(response => response.ok ? response.json() : Promise.reject(`Lỗi mạng: ${response.statusText}`))
                .then(data => {
                    const staffMember = data.find(staff => String(staff.idnv) === idns);
                    if (!staffMember) return showError('Không tìm thấy nhân viên với ID: ' + idns);
                    document.getElementById('userInfo').textContent = `Nhân viên: ${staffMember.ho_va_ten} - Bộ phận: ${staffMember.bo_phan}`;
                    fetchOrderData(staffMember.ho_va_ten);
                })
                .catch(error => showError('Lỗi khi tải dữ liệu nhân viên.'));
        }
        
        function fetchOrderData(staffName) { /* ... Giữ nguyên hàm này ... */
             const orderApiUrl = 'https://script.google.com/macros/s/AKfycbx8f3epIsFEhxwB-IbyXA36JIkE55Bj181y4vam-D93I0MLZL-iMxwFJNDT9TNU4vBV/exec';
            fetch(orderApiUrl)
                .then(response => response.ok ? response.json() : Promise.reject(`Lỗi mạng: ${response.statusText}`))
                .then(data => {
                    const staffNameTrimmed = staffName.trim();
                    allOrders = data.filter(order => order.nvVanDon && order.nvVanDon.trim() === staffNameTrimmed);
                    if (allOrders.length === 0) return showNoOrders();
                    displayOrders(allOrders);
                })
                .catch(error => showError('Lỗi khi tải dữ liệu đơn hàng.'));
        }

        function applyFilters() { /* ... Giữ nguyên hàm này ... */
            clearSelection();
            const filters = {};
            document.querySelectorAll('.filter-input').forEach(input => {
                if (input.value) filters[input.dataset.column] = input.value.toLowerCase().trim();
            });
            const filteredData = allOrders.filter(order => {
                return Object.keys(filters).every(key => {
                    if (!order[key]) return false;
                    let value = String(order[key]).toLowerCase();
                    if (key === 'ngayLenDon') value = new Date(order[key]).toLocaleDateString('vi-VN');
                    return value.includes(filters[key]);
                });
            });
            displayOrders(filteredData);
        }

        function resetFilters() {
            clearSelection();
            document.querySelectorAll('.filter-input').forEach(input => input.value = '');
            displayOrders(allOrders);
        }
        
        function displayOrders(orders) {
            currentDisplayedOrders = orders;
            clearSelection();
            const tableBody = document.getElementById('orderTableBody');
            tableBody.innerHTML = '';
            document.getElementById('rowCount').textContent = `Hiển thị ${orders.length} / ${allOrders.length} đơn hàng`;

            if (orders.length === 0) {
                 tableBody.innerHTML = `<tr><td colspan="15" class="no-results">Không tìm thấy đơn hàng nào.</td></tr>`;
                 return;
            }
            
            orders.forEach(order => {
                const row = document.createElement('tr');
                const totalAmount = order.tongTienVND ? parseInt(order.tongTienVND).toLocaleString('vi-VN') : '0';
                const formattedDate = order.ngayLenDon ? new Date(order.ngayLenDon).toLocaleDateString('vi-VN') : 'N/A';
                
                let statusBadge = '';
                const deliveryStatus = order.trangThaiGiaoHangNB;
                if (deliveryStatus === 'Đã giao') statusBadge = `<span class="status status-completed">${deliveryStatus}</span>`;
                else if (deliveryStatus === 'Đang giao') statusBadge = `<span class="status status-shipping">${deliveryStatus}</span>`;
                else if (deliveryStatus === 'Chờ xử lý') statusBadge = `<span class="status status-pending">${deliveryStatus}</span>`;
                else statusBadge = deliveryStatus || 'N/A';
                
                let paymentBadge = '';
                const paymentStatus = order.trangThaiThuTien; 
                if (paymentStatus === 'Đã thu') paymentBadge = `<span class="badge badge-success">${paymentStatus}</span>`;
                else if (paymentStatus === 'Chờ thu') paymentBadge = `<span class="badge badge-warning">${paymentStatus}</span>`;
                else if (paymentStatus === 'Không thu') paymentBadge = `<span class="badge badge-danger">${paymentStatus}</span>`;
                else paymentBadge = paymentStatus || 'N/A';

                row.innerHTML = `
                    <td class="row-selector" title="Chọn hàng này">📋</td>
                    <td>${order.maDonHang || 'N/A'}</td> <td>${formattedDate}</td>
                    <td>${order.name || 'N/A'}</td> <td>${order.phone || 'N/A'}</td>
                    <td>${order.address || 'N/A'}</td> <td>${order.city || 'N/A'}</td>
                    <td>${order.state || 'N/A'}</td> <td>${order.matHang || 'N/A'}</td>
                    <td>${totalAmount} VNĐ</td> <td>${order.hinhThucThanhToan || 'N/A'}</td>
                    <td>${order.ghiChu || ''}</td> <td>${statusBadge}</td>
                    <td>${order.donViVanChuyen || 'N/A'}</td> <td>${paymentBadge}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function copySelectedToClipboard() {
            if (selectedCells.size === 0) {
                alert("Chưa có ô nào được chọn. Hãy click vào ô, hàng, hoặc cột để chọn.");
                return;
            }

            // Sắp xếp các ô đã chọn theo thứ tự xuất hiện trên màn hình
            const sortedCells = Array.from(selectedCells).sort((a, b) => {
                const posA = a.getBoundingClientRect();
                const posB = b.getBoundingClientRect();
                if (posA.top !== posB.top) {
                    return posA.top - posB.top;
                }
                return posA.left - posB.left;
            });

            // Xây dựng chuỗi văn bản dạng bảng
            let clipboardText = '';
            let lastRowIndex = -1;

            sortedCells.forEach(cell => {
                const rowIndex = cell.parentElement.rowIndex;
                if (lastRowIndex !== -1 && rowIndex !== lastRowIndex) {
                    clipboardText += '\n'; // Xuống hàng mới
                } else if (lastRowIndex !== -1) {
                    clipboardText += '\t'; // Thêm tab giữa các ô trên cùng hàng
                }
                clipboardText += cell.innerText;
                lastRowIndex = rowIndex;
            });
            
            navigator.clipboard.writeText(clipboardText).then(() => {
                alert(`Đã sao chép ${selectedCells.size} ô vào clipboard.`);
            }, (err) => {
                alert('Lỗi khi sao chép. Vui lòng thử lại.');
                console.error('Lỗi clipboard: ', err);
            });
        }
        
        function downloadCSV() { /* ... Giữ nguyên hàm này, đổi tên copyBtn thành copyAllBtn ... */
            if (currentDisplayedOrders.length === 0) return alert("Không có dữ liệu để sao chép.");
            const headers = ["Mã đơn hàng", "Ngày lên đơn", "Tên KH", "SĐT", "Địa chỉ", "Thành phố", "Tỉnh", "Mặt hàng", "Tổng tiền", "Hình thức TT", "Ghi chú", "Trạng thái giao", "Đơn vị VC", "Trạng thái thu tiền"];
            let csvContent = headers.join(',') + '\n';
            currentDisplayedOrders.forEach(order => {
                const rowData = [order.maDonHang, order.ngayLenDon ? new Date(order.ngayLenDon).toLocaleDateString('vi-VN') : '', order.name, order.phone, order.address, order.city, order.state, order.matHang, order.tongTienVND, order.hinhThucThanhToan, order.ghiChu, order.trangThaiGiaoHangNB, order.donViVanChuyen, order.trangThaiThuTien];
                const sanitizedRow = rowData.map(field => `"${String(field || '').replace(/"/g, '""')}"`).join(',');
                csvContent += sanitizedRow + '\n';
            });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "don_hang_da_loc.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function showError(message) { /* ... Giữ nguyên ... */
            document.getElementById('userInfo').textContent = 'Lỗi';
            document.getElementById('orderTableBody').innerHTML = `<tr><td colspan="15" class="error">${message}</td></tr>`;
        }
        
        function showNoOrders() { /* ... Giữ nguyên ... */
            document.getElementById('rowCount').textContent = "Không có đơn hàng nào.";
            document.getElementById('orderTableBody').innerHTML = `<tr><td colspan="15" class="no-results">Không có đơn hàng nào được gán cho nhân viên này.</td></tr>`;
        }
    </script>
</body>
</html>

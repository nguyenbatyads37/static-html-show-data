<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω ƒë∆°n h√†ng - Nh√¢n vi√™n</title>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #34495e;
            --text-color: #333;
            --border-color: #ddd;
            --selection-color: #aed6f1; /* M√†u n·ªÅn cho √¥ ƒë∆∞·ª£c ch·ªçn */
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* L√†m cho vi·ªác b√¥i ƒëen b·∫±ng chu·ªôt d·ªÖ nh√¨n h∆°n */
        ::selection {
            background-color: var(--primary-color);
            color: white;
        }
        
        body {
            background-color: #f5f7fa;
            color: var(--text-color);
            line-height: 1.6;
        }
        
        .container {
            max-width: 100%;
            margin: 20px auto;
            padding: 0 15px;
        }
        
        .header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 20px;
            border-radius: 5px 5px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .header h1 { font-size: 1.5rem; font-weight: 600; }
        
        .user-info {
            background-color: var(--light-color);
            padding: 10px;
            border-radius: 4px;
            font-weight: 500;
            color: var(--dark-color);
        }
        
        .controls-container {
            background-color: #fff;
            padding: 10px 15px;
            margin-top: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        .controls-container button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
            color: white;
        }

        #copySelectedBtn { background-color: var(--secondary-color); }
        #copySelectedBtn:hover { background-color: #2471a3; }
        #copyAllBtn { background-color: var(--success-color); }
        #copyAllBtn:hover { background-color: #27ae60; }
        #resetBtn { background-color: var(--warning-color); }
        #resetBtn:hover { background-color: #e67e22; }
        
        .table-container {
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-x: auto;
            margin-top: 1px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1700px;
        }
        
        thead {
            background-color: var(--primary-color);
            color: white;
            position: sticky;
            top: 0;
            z-index: 2;
        }
        
        th {
            padding: 12px 15px;
            text-align: left;
            font-weight: 500;
        }

        /* Cho ph√©p click v√†o header c·ªôt/h√†ng */
        th.column-selector, td.row-selector {
            cursor: pointer;
        }
        
        .filter-row th { padding: 5px 10px; }
        .filter-input {
            width: 100%;
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        tbody tr {
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
        }
        
        tbody tr:nth-child(even) { background-color: #f8f9fa; }
        tbody tr:hover { background-color: #e9f7fe; }
        
        td {
            padding: 12px 15px;
            vertical-align: top;
            max-width: 250px;
            word-wrap: break-word;
            /* Cho ph√©p ch·ªçn vƒÉn b·∫£n trong √¥ */
            user-select: text; 
        }

        /* Style cho c√°c √¥ ƒë∆∞·ª£c ch·ªçn */
        td.cell-selected {
            background-color: var(--selection-color) !important;
            outline: 1px solid var(--primary-color);
        }
        
        .status {
            display: inline-block; padding: 4px 8px; border-radius: 4px;
            font-size: 0.8rem; font-weight: 500; white-space: nowrap;
        }
        .status-pending { background-color: #fff3cd; color: #856404; }
        .status-completed { background-color: #d4edda; color: #155724; }
        .status-cancelled { background-color: #f8d7da; color: #721c24; }
        .status-shipping { background-color: #cce5ff; color: #004085; }
        
        .loading, .error, .no-results {
            text-align: center; padding: 20px; font-size: 1.2rem;
            color: var(--dark-color); font-weight: 500;
        }
        .error { color: var(--danger-color); }
        
        .badge {
            display: inline-block; padding: 3px 7px; font-size: 0.75rem; font-weight: 600;
            line-height: 1; text-align: center; white-space: nowrap;
            vertical-align: baseline; border-radius: 10px; color: white;
        }
        .badge-success { background-color: var(--success-color); }
        .badge-warning { background-color: var(--warning-color); }
        .badge-danger { background-color: var(--danger-color); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Qu·∫£n l√Ω ƒë∆°n h√†ng - Nh√¢n vi√™n</h1>
            <div class="user-info" id="userInfo">ƒêang t·∫£i th√¥ng tin...</div>
        </div>

        <div class="controls-container">
            <button id="copySelectedBtn">Sao ch√©p v√πng ch·ªçn</button>
            <button id="copyAllBtn">Sao ch√©p to√†n b·ªô (CSV)</button>
            <button id="resetBtn">X√≥a b·ªô l·ªçc</button>
            <span id="rowCount"></span>
        </div>
        
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th class="column-selector" title="Ch·ªçn/B·ªè ch·ªçn t·∫•t c·∫£">#</th>
                        <th class="column-selector" data-col-index="1">M√£ ƒë∆°n h√†ng</th>
                        <th class="column-selector" data-col-index="2">Ng√†y l√™n ƒë∆°n</th>
                        <th class="column-selector" data-col-index="3">T√™n KH</th>
                        <th class="column-selector" data-col-index="4">SƒêT</th>
                        <th class="column-selector" data-col-index="5">ƒê·ªãa ch·ªâ</th>
                        <th class="column-selector" data-col-index="6">Th√†nh ph·ªë</th>
                        <th class="column-selector" data-col-index="7">T·ªânh</th>
                        <th class="column-selector" data-col-index="8">M·∫∑t h√†ng</th>
                        <th class="column-selector" data-col-index="9">T·ªïng ti·ªÅn</th>
                        <th class="column-selector" data-col-index="10">H√¨nh th·ª©c TT</th>
                        <th class="column-selector" data-col-index="11">Ghi ch√∫</th>
                        <th class="column-selector" data-col-index="12">Tr·∫°ng th√°i giao</th>
                        <th class="column-selector" data-col-index="13">ƒê∆°n v·ªã VC</th>
                        <th class="column-selector" data-col-index="14">Tr·∫°ng th√°i thu ti·ªÅn</th>
                    </tr>
                    <tr class="filter-row">
                        <th></th>
                        <th><input type="text" class="filter-input" data-column="maDonHang"></th>
                        <th><input type="text" class="filter-input" data-column="ngayLenDon"></th>
                        <th><input type="text" class="filter-input" data-column="name"></th>
                        <th><input type="text" class="filter-input" data-column="phone"></th>
                        <th><input type="text" class="filter-input" data-column="address"></th>
                        <th><input type="text" class="filter-input" data-column="city"></th>
                        <th><input type="text" class="filter-input" data-column="state"></th>
                        <th><input type="text" class="filter-input" data-column="matHang"></th>
                        <th><input type="text" class="filter-input" data-column="tongTienVND"></th>
                        <th><input type="text" class="filter-input" data-column="hinhThucThanhToan"></th>
                        <th><input type="text" class="filter-input" data-column="ghiChu"></th>
                        <th><input type="text" class="filter-input" data-column="trangThaiGiaoHangNB"></th>
                        <th><input type="text" class="filter-input" data-column="donViVanChuyen"></th>
                        <th><input type="text" class="filter-input" data-column="trangThaiThuTien"></th>
                    </tr>
                </thead>
                <tbody id="orderTableBody">
                    <tr><td colspan="15" class="loading">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let allOrders = [];
        let currentDisplayedOrders = [];
        let selectedCells = new Set();

        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const idns = urlParams.get('idns');
            
            if (!idns) {
                showError('Kh√¥ng t√¨m th·∫•y ID nh√¢n vi√™n trong URL (tham s·ªë idns).');
                return;
            }
            
            setupEventListeners();
            fetchStaffData(idns);
        });

        function setupEventListeners() {
            document.querySelectorAll('.filter-input').forEach(input => {
                input.addEventListener('input', applyFilters);
            });
            document.getElementById('resetBtn').addEventListener('click', resetFilters);
            document.getElementById('copyAllBtn').addEventListener('click', downloadCSV);
            document.getElementById('copySelectedBtn').addEventListener('click', copySelectedToClipboard);
            
            // Event delegation for cell selection
            const tableBody = document.getElementById('orderTableBody');
            tableBody.addEventListener('click', handleCellClick);

            const tableHead = document.querySelector('thead');
            tableHead.addEventListener('click', handleHeaderClick);
        }
        
        function handleCellClick(event) {
            const cell = event.target.closest('td');
            if (!cell) return;

            if (event.ctrlKey) { // Ctrl+Click to toggle selection
                if (selectedCells.has(cell)) {
                    selectedCells.delete(cell);
                    cell.classList.remove('cell-selected');
                } else {
                    selectedCells.add(cell);
                    cell.classList.add('cell-selected');
                }
            } else { // Simple click to select one cell
                clearSelection();
                selectedCells.add(cell);
                cell.classList.add('cell-selected');
            }

            // If it's a row selector cell, select the whole row
            if (cell.classList.contains('row-selector')) {
                const row = cell.parentElement;
                row.querySelectorAll('td').forEach(td => {
                    selectedCells.add(td);
                    td.classList.add('cell-selected');
                });
            }
        }
        
        function handleHeaderClick(event) {
            const header = event.target.closest('th.column-selector');
            if (!header) return;

            clearSelection();
            const colIndex = header.dataset.colIndex;
            if (colIndex) { // Select a specific column
                document.querySelectorAll(`#orderTableBody tr td:nth-child(${parseInt(colIndex) + 1})`).forEach(cell => {
                    selectedCells.add(cell);
                    cell.classList.add('cell-selected');
                });
            } else { // Select All (# header)
                 document.querySelectorAll(`#orderTableBody td`).forEach(cell => {
                    selectedCells.add(cell);
                    cell.classList.add('cell-selected');
                });
            }
        }

        function clearSelection() {
            selectedCells.forEach(cell => cell.classList.remove('cell-selected'));
            selectedCells.clear();
        }

        function fetchStaffData(idns) { /* ... Gi·ªØ nguy√™n h√†m n√†y ... */
            const staffApiUrl = 'https://script.google.com/macros/s/AKfycbzwOv7UFwrqzf88QJL1QrxLKcnnnSIQ_PSmF0SO8LboqWI5li3vF3W8_-8s-A8lNGaR/exec';
            fetch(staffApiUrl)
                .then(response => response.ok ? response.json() : Promise.reject(`L·ªói m·∫°ng: ${response.statusText}`))
                .then(data => {
                    const staffMember = data.find(staff => String(staff.idnv) === idns);
                    if (!staffMember) return showError('Kh√¥ng t√¨m th·∫•y nh√¢n vi√™n v·ªõi ID: ' + idns);
                    document.getElementById('userInfo').textContent = `Nh√¢n vi√™n: ${staffMember.ho_va_ten} - B·ªô ph·∫≠n: ${staffMember.bo_phan}`;
                    fetchOrderData(staffMember.ho_va_ten);
                })
                .catch(error => showError('L·ªói khi t·∫£i d·ªØ li·ªáu nh√¢n vi√™n.'));
        }
        
        function fetchOrderData(staffName) { /* ... Gi·ªØ nguy√™n h√†m n√†y ... */
             const orderApiUrl = 'https://script.google.com/macros/s/AKfycbx8f3epIsFEhxwB-IbyXA36JIkE55Bj181y4vam-D93I0MLZL-iMxwFJNDT9TNU4vBV/exec';
            fetch(orderApiUrl)
                .then(response => response.ok ? response.json() : Promise.reject(`L·ªói m·∫°ng: ${response.statusText}`))
                .then(data => {
                    const staffNameTrimmed = staffName.trim();
                    allOrders = data.filter(order => order.nvVanDon && order.nvVanDon.trim() === staffNameTrimmed);
                    if (allOrders.length === 0) return showNoOrders();
                    displayOrders(allOrders);
                })
                .catch(error => showError('L·ªói khi t·∫£i d·ªØ li·ªáu ƒë∆°n h√†ng.'));
        }

        function applyFilters() { /* ... Gi·ªØ nguy√™n h√†m n√†y ... */
            clearSelection();
            const filters = {};
            document.querySelectorAll('.filter-input').forEach(input => {
                if (input.value) filters[input.dataset.column] = input.value.toLowerCase().trim();
            });
            const filteredData = allOrders.filter(order => {
                return Object.keys(filters).every(key => {
                    if (!order[key]) return false;
                    let value = String(order[key]).toLowerCase();
                    if (key === 'ngayLenDon') value = new Date(order[key]).toLocaleDateString('vi-VN');
                    return value.includes(filters[key]);
                });
            });
            displayOrders(filteredData);
        }

        function resetFilters() {
            clearSelection();
            document.querySelectorAll('.filter-input').forEach(input => input.value = '');
            displayOrders(allOrders);
        }
        
        function displayOrders(orders) {
            currentDisplayedOrders = orders;
            clearSelection();
            const tableBody = document.getElementById('orderTableBody');
            tableBody.innerHTML = '';
            document.getElementById('rowCount').textContent = `Hi·ªÉn th·ªã ${orders.length} / ${allOrders.length} ƒë∆°n h√†ng`;

            if (orders.length === 0) {
                 tableBody.innerHTML = `<tr><td colspan="15" class="no-results">Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng n√†o.</td></tr>`;
                 return;
            }
            
            orders.forEach(order => {
                const row = document.createElement('tr');
                const totalAmount = order.tongTienVND ? parseInt(order.tongTienVND).toLocaleString('vi-VN') : '0';
                const formattedDate = order.ngayLenDon ? new Date(order.ngayLenDon).toLocaleDateString('vi-VN') : 'N/A';
                
                let statusBadge = '';
                const deliveryStatus = order.trangThaiGiaoHangNB;
                if (deliveryStatus === 'ƒê√£ giao') statusBadge = `<span class="status status-completed">${deliveryStatus}</span>`;
                else if (deliveryStatus === 'ƒêang giao') statusBadge = `<span class="status status-shipping">${deliveryStatus}</span>`;
                else if (deliveryStatus === 'Ch·ªù x·ª≠ l√Ω') statusBadge = `<span class="status status-pending">${deliveryStatus}</span>`;
                else statusBadge = deliveryStatus || 'N/A';
                
                let paymentBadge = '';
                const paymentStatus = order.trangThaiThuTien; 
                if (paymentStatus === 'ƒê√£ thu') paymentBadge = `<span class="badge badge-success">${paymentStatus}</span>`;
                else if (paymentStatus === 'Ch·ªù thu') paymentBadge = `<span class="badge badge-warning">${paymentStatus}</span>`;
                else if (paymentStatus === 'Kh√¥ng thu') paymentBadge = `<span class="badge badge-danger">${paymentStatus}</span>`;
                else paymentBadge = paymentStatus || 'N/A';

                row.innerHTML = `
                    <td class="row-selector" title="Ch·ªçn h√†ng n√†y">üìã</td>
                    <td>${order.maDonHang || 'N/A'}</td> <td>${formattedDate}</td>
                    <td>${order.name || 'N/A'}</td> <td>${order.phone || 'N/A'}</td>
                    <td>${order.address || 'N/A'}</td> <td>${order.city || 'N/A'}</td>
                    <td>${order.state || 'N/A'}</td> <td>${order.matHang || 'N/A'}</td>
                    <td>${totalAmount} VNƒê</td> <td>${order.hinhThucThanhToan || 'N/A'}</td>
                    <td>${order.ghiChu || ''}</td> <td>${statusBadge}</td>
                    <td>${order.donViVanChuyen || 'N/A'}</td> <td>${paymentBadge}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function copySelectedToClipboard() {
            if (selectedCells.size === 0) {
                alert("Ch∆∞a c√≥ √¥ n√†o ƒë∆∞·ª£c ch·ªçn. H√£y click v√†o √¥, h√†ng, ho·∫∑c c·ªôt ƒë·ªÉ ch·ªçn.");
                return;
            }

            // S·∫Øp x·∫øp c√°c √¥ ƒë√£ ch·ªçn theo th·ª© t·ª± xu·∫•t hi·ªán tr√™n m√†n h√¨nh
            const sortedCells = Array.from(selectedCells).sort((a, b) => {
                const posA = a.getBoundingClientRect();
                const posB = b.getBoundingClientRect();
                if (posA.top !== posB.top) {
                    return posA.top - posB.top;
                }
                return posA.left - posB.left;
            });

            // X√¢y d·ª±ng chu·ªói vƒÉn b·∫£n d·∫°ng b·∫£ng
            let clipboardText = '';
            let lastRowIndex = -1;

            sortedCells.forEach(cell => {
                const rowIndex = cell.parentElement.rowIndex;
                if (lastRowIndex !== -1 && rowIndex !== lastRowIndex) {
                    clipboardText += '\n'; // Xu·ªëng h√†ng m·ªõi
                } else if (lastRowIndex !== -1) {
                    clipboardText += '\t'; // Th√™m tab gi·ªØa c√°c √¥ tr√™n c√πng h√†ng
                }
                clipboardText += cell.innerText;
                lastRowIndex = rowIndex;
            });
            
            navigator.clipboard.writeText(clipboardText).then(() => {
                alert(`ƒê√£ sao ch√©p ${selectedCells.size} √¥ v√†o clipboard.`);
            }, (err) => {
                alert('L·ªói khi sao ch√©p. Vui l√≤ng th·ª≠ l·∫°i.');
                console.error('L·ªói clipboard: ', err);
            });
        }
        
        function downloadCSV() { /* ... Gi·ªØ nguy√™n h√†m n√†y, ƒë·ªïi t√™n copyBtn th√†nh copyAllBtn ... */
            if (currentDisplayedOrders.length === 0) return alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ sao ch√©p.");
            const headers = ["M√£ ƒë∆°n h√†ng", "Ng√†y l√™n ƒë∆°n", "T√™n KH", "SƒêT", "ƒê·ªãa ch·ªâ", "Th√†nh ph·ªë", "T·ªânh", "M·∫∑t h√†ng", "T·ªïng ti·ªÅn", "H√¨nh th·ª©c TT", "Ghi ch√∫", "Tr·∫°ng th√°i giao", "ƒê∆°n v·ªã VC", "Tr·∫°ng th√°i thu ti·ªÅn"];
            let csvContent = headers.join(',') + '\n';
            currentDisplayedOrders.forEach(order => {
                const rowData = [order.maDonHang, order.ngayLenDon ? new Date(order.ngayLenDon).toLocaleDateString('vi-VN') : '', order.name, order.phone, order.address, order.city, order.state, order.matHang, order.tongTienVND, order.hinhThucThanhToan, order.ghiChu, order.trangThaiGiaoHangNB, order.donViVanChuyen, order.trangThaiThuTien];
                const sanitizedRow = rowData.map(field => `"${String(field || '').replace(/"/g, '""')}"`).join(',');
                csvContent += sanitizedRow + '\n';
            });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "don_hang_da_loc.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function showError(message) { /* ... Gi·ªØ nguy√™n ... */
            document.getElementById('userInfo').textContent = 'L·ªói';
            document.getElementById('orderTableBody').innerHTML = `<tr><td colspan="15" class="error">${message}</td></tr>`;
        }
        
        function showNoOrders() { /* ... Gi·ªØ nguy√™n ... */
            document.getElementById('rowCount').textContent = "Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o.";
            document.getElementById('orderTableBody').innerHTML = `<tr><td colspan="15" class="no-results">Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o ƒë∆∞·ª£c g√°n cho nh√¢n vi√™n n√†y.</td></tr>`;
        }
    </script>
</body>
</html>

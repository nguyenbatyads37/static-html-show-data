<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω ƒë∆°n h√†ng - Nh√¢n vi√™n</title>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-color: #f8f9fa; 
            --selection-color: #aed6f1;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa; color: #333; line-height: 1.6; font-size: 14px;
        }
        
        .container { max-width: 100%; margin: 20px auto; padding: 0 15px; }
        
        .header {
            background-color: var(--primary-color); color: white; padding: 15px 20px;
            border-radius: 5px 5px 0 0; display: flex; justify-content: space-between;
            align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .header h1 { font-size: 1.6rem; font-weight: 600; }
        .user-info { background-color: #ecf0f1; padding: 10px; border-radius: 4px; font-weight: 500; color: #34495e; }
        
        .controls-container {
            background-color: #fff; padding: 10px 15px; margin-top: 20px;
            border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex; flex-wrap: wrap; gap: 10px; align-items: center;
        }
        .controls-container button {
            padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer;
            font-weight: 600; font-size: 14px; transition: background-color 0.2s; color: white;
        }
        #copySelectedBtn { background-color: var(--secondary-color); }
        #copyAllBtn { background-color: var(--success-color); }
        #resetBtn { background-color: var(--warning-color); }

        .table-container {
            background-color: white; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-x: auto; margin-top: 1px;
        }
        
        table { width: 100%; border-collapse: collapse; min-width: 2000px; }
        
        thead { background-color: var(--primary-color); color: white; position: sticky; top: 0; z-index: 10; }
        
        th, td {
            padding: 12px 15px; text-align: left; vertical-align: top;
            border-bottom: 1px solid #ddd; border-right: 1px solid #ddd;
            font-size: 15px;
        }
        th { font-weight: 600; }
        
        .frozen {
            position: sticky; background-color: var(--light-color); z-index: 5;
        }
        thead .frozen { z-index: 15; background-color: var(--primary-color); }
        .col-1 { left: 0; min-width: 50px; }
        .col-2 { left: 50px; min-width: 150px; }
        .col-3 { left: 200px; min-width: 130px; }
        
        td:nth-child(4), th:nth-child(4) { min-width: 200px; }
        td:nth-child(5), th:nth-child(5) { min-width: 130px; }
        td:nth-child(6), th:nth-child(6) { min-width: 300px; } 
        td:nth-child(9), th:nth-child(9) { min-width: 180px; }
        td:nth-child(12), th:nth-child(12) { min-width: 200px; } 

        .filter-row th { padding: 5px 10px; }
        .filter-control {
            width: 100%; padding: 8px; border: 1px solid #ccc;
            border-radius: 4px; font-size: 14px; background-color: #fff;
        }
        
        tbody tr:hover td, tbody tr:hover .frozen { background-color: #e9f7fe; }
        
        td.cell-selected {
            background-color: var(--selection-color) !important;
            outline: 2px solid var(--primary-color); outline-offset: -1px;
        }

        .loading, .error, .no-results { text-align: center; padding: 20px; font-size: 1.2rem; font-weight: 500; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header and Controls -->
        <div class="header"><h1>Qu·∫£n l√Ω ƒë∆°n h√†ng - Nh√¢n vi√™n</h1><div class="user-info" id="userInfo">ƒêang t·∫£i...</div></div>
        <div class="controls-container">
            <button id="copySelectedBtn">Sao ch√©p v√πng ch·ªçn</button>
            <button id="copyAllBtn">T·∫£i v·ªÅ CSV</button>
            <button id="resetBtn">X√≥a b·ªô l·ªçc</button>
            <span id="rowCount"></span>
        </div>
        
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th class="frozen col-1">#</th>
                        <th class="frozen col-2">M√£ ƒë∆°n h√†ng</th>
                        <th class="frozen col-3">Ng√†y l√™n ƒë∆°n</th>
                        <th>T√™n KH</th> <th>SƒêT</th> <th>ƒê·ªãa ch·ªâ</th>
                        <th>Th√†nh ph·ªë</th> <th>T·ªânh</th> <th>M·∫∑t h√†ng</th>
                        <th>T·ªïng ti·ªÅn</th> <th>H√¨nh th·ª©c TT</th> <th>Ghi ch√∫</th>
                        <th>Tr·∫°ng th√°i giao</th> <th>ƒê∆°n v·ªã VC</th> <th>Tr·∫°ng th√°i thu ti·ªÅn</th>
                    </tr>
                    <tr class="filter-row">
                        <th class="frozen col-1"></th>
                        <th class="frozen col-2"><input type="text" class="filter-control" data-column="maDonHang"></th>
                        <th class="frozen col-3"><input type="text" class="filter-control" data-column="ngayLenDon"></th>
                        <th><input type="text" class="filter-control" data-column="name"></th>
                        <th><input type="text" class="filter-control" data-column="phone"></th>
                        <th><input type="text" class="filter-control" data-column="address"></th>
                        <th><select class="filter-control" data-column="city"></select></th>
                        <th><select class="filter-control" data-column="state"></select></th>
                        <th><input type="text" class="filter-control" data-column="matHang"></th>
                        <th><input type="text" class="filter-control" data-column="tongTienVND"></th>
                        <th><select class="filter-control" data-column="hinhThucThanhToan"></select></th>
                        <th><input type="text" class="filter-control" data-column="ghiChu"></th>
                        <th><select class="filter-control" data-column="trangThaiGiaoHangNB"></select></th>
                        <th><select class="filter-control" data-column="donViVanChuyen"></select></th>
                        <th><select class="filter-control" data-column="trangThaiThuTien"></select></th>
                    </tr>
                </thead>
                <tbody id="orderTableBody">
                    <tr><td colspan="15" class="loading">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Global variables
        let allOrders = [];
        let currentDisplayedOrders = [];
        let selectedCells = new Set();
        let isMouseDown = false;
        let startCell = null;
        let lastClickedCell = null;

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const idns = urlParams.get('idns');
            if (!idns) return showError('Kh√¥ng t√¨m th·∫•y ID nh√¢n vi√™n trong URL (tham s·ªë idns).');
            setupEventListeners();
            fetchStaffData(idns);
        });

        function setupEventListeners() {
            // Filters
            document.querySelectorAll('.filter-control').forEach(control => {
                const eventType = control.tagName === 'INPUT' ? 'input' : 'change';
                control.addEventListener(eventType, applyFilters);
            });

            // Buttons
            document.getElementById('resetBtn').addEventListener('click', resetFilters);
            document.getElementById('copyAllBtn').addEventListener('click', downloadCSV);
            document.getElementById('copySelectedBtn').addEventListener('click', copySelectedToClipboard);
            
            // Selection Logic
            const tableContainer = document.querySelector('.table-container');
            tableContainer.addEventListener('mousedown', handleMouseDown);
            tableContainer.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
        }

        // --- DATA FETCHING & PROCESSING ---
        function fetchStaffData(idns) {
            const staffApiUrl = 'https://script.google.com/macros/s/AKfycbzwOv7UFwrqzf88QJL1QrxLKcnnnSIQ_PSmF0SO8LboqWI5li3vF3W8_-8s-A8lNGaR/exec';
            fetch(staffApiUrl)
                .then(response => response.ok ? response.json() : Promise.reject(response))
                .then(data => {
                    const staffMember = data.find(staff => String(staff.idnv) === idns);
                    if (!staffMember) return showError(`Kh√¥ng t√¨m th·∫•y nh√¢n vi√™n v·ªõi ID: ${idns}`);
                    document.getElementById('userInfo').textContent = `Nh√¢n vi√™n: ${staffMember.ho_va_ten} - B·ªô ph·∫≠n: ${staffMember.bo_phan}`;
                    fetchOrderData(staffMember.ho_va_ten);
                })
                .catch(() => showError('L·ªói khi t·∫£i d·ªØ li·ªáu nh√¢n vi√™n.'));
        }
        
        function fetchOrderData(staffName) {
            const orderApiUrl = 'https://script.google.com/macros/s/AKfycbx8f3epIsFEhxwB-IbyXA36JIkE55Bj181y4vam-D93I0MLZL-iMxwFJNDT9TNU4vBV/exec';
            fetch(orderApiUrl)
                .then(response => response.ok ? response.json() : Promise.reject(response))
                .then(data => {
                    const staffNameTrimmed = staffName.trim();
                    allOrders = data.filter(order => order.nvVanDon && order.nvVanDon.trim() === staffNameTrimmed);
                    
                    if (allOrders.length === 0) return showNoOrders();

                    populateFilterDropdowns(allOrders);
                    displayOrders(allOrders);
                })
                .catch(() => showError('L·ªói khi t·∫£i d·ªØ li·ªáu ƒë∆°n h√†ng.'));
        }

        // --- FILTERING LOGIC ---
        function populateFilterDropdowns(orders) {
            const dropdownColumns = ['city', 'state', 'hinhThucThanhToan', 'trangThaiGiaoHangNB', 'donViVanChuyen', 'trangThaiThuTien'];
            const uniqueValues = {};
            dropdownColumns.forEach(col => uniqueValues[col] = new Set());

            orders.forEach(order => {
                dropdownColumns.forEach(col => {
                    if (order[col]) uniqueValues[col].add(String(order[col]).trim());
                });
            });

            dropdownColumns.forEach(col => {
                const selectEl = document.querySelector(`.filter-control[data-column="${col}"]`);
                if (!selectEl) return;

                const sortedValues = Array.from(uniqueValues[col]).sort();
                selectEl.innerHTML = '<option value="">-- T·∫•t c·∫£ --</option>';
                sortedValues.forEach(value => {
                    if (value) selectEl.innerHTML += `<option value="${value}">${value}</option>`;
                });
            });
        }

        function applyFilters() {
            clearSelection();
            const filters = {};
            document.querySelectorAll('.filter-control').forEach(control => {
                if (control.value) {
                    filters[control.dataset.column] = control.value.toLowerCase().trim();
                }
            });

            const filteredData = allOrders.filter(order => {
                return Object.keys(filters).every(key => {
                    if (order[key] === null || order[key] === undefined) return false;
                    
                    let orderValueStr = String(order[key]).toLowerCase();
                    if (key === 'ngayLenDon' && order.ngayLenDon) {
                        orderValueStr = new Date(order.ngayLenDon).toLocaleDateString('vi-VN');
                    }
                    
                    // Dropdowns need exact match, inputs need partial match (includes)
                    const control = document.querySelector(`.filter-control[data-column="${key}"]`);
                    if (control && control.tagName === 'SELECT') {
                        return orderValueStr === filters[key];
                    }
                    return orderValueStr.includes(filters[key]);
                });
            });
            displayOrders(filteredData);
        }

        function resetFilters() {
            clearSelection();
            document.querySelectorAll('.filter-control').forEach(control => control.value = '');
            applyFilters();
        }

        // --- DISPLAY & UI ---
        function displayOrders(orders) {
            currentDisplayedOrders = orders;
            clearSelection();
            const tableBody = document.getElementById('orderTableBody');
            tableBody.innerHTML = '';
            document.getElementById('rowCount').textContent = `Hi·ªÉn th·ªã ${orders.length} / ${allOrders.length} ƒë∆°n h√†ng`;

            if (orders.length === 0) {
                 tableBody.innerHTML = `<tr><td colspan="15" class="no-results">Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng n√†o.</td></tr>`;
                 return;
            }
            
            orders.forEach(order => {
                const row = document.createElement('tr');
                const totalAmount = order.tongTienVND ? parseInt(order.tongTienVND).toLocaleString('vi-VN') : '0';
                const formattedDate = order.ngayLenDon ? new Date(order.ngayLenDon).toLocaleDateString('vi-VN') : 'N/A';
                
                const createBadge = (text) => {
                    if (!text) return 'N/A';
                    const classMap = { 'ƒê√£ giao': 'status status-completed', 'ƒêang giao': 'status status-shipping', 'Ch·ªù x·ª≠ l√Ω': 'status status-pending', 'ƒê√£ thu': 'badge badge-success', 'Ch·ªù thu': 'badge badge-warning', 'Kh√¥ng thu': 'badge badge-danger' };
                    return `<span class="${classMap[text] || ''}">${text}</span>`;
                };

                row.innerHTML = `
                    <td class="frozen col-1">üìã</td>
                    <td class="frozen col-2">${order.maDonHang || 'N/A'}</td>
                    <td class="frozen col-3">${formattedDate}</td>
                    <td>${order.name || 'N/A'}</td> <td>${order.phone || 'N/A'}</td>
                    <td>${order.address || 'N/A'}</td> <td>${order.city || 'N/A'}</td>
                    <td>${order.state || 'N/A'}</td> <td>${order.matHang || 'N/A'}</td>
                    <td>${totalAmount} VNƒê</td> <td>${order.hinhThucThanhToan || 'N/A'}</td>
                    <td>${order.ghiChu || ''}</td>
                    <td>${createBadge(order.trangThaiGiaoHangNB)}</td>
                    <td>${order.donViVanChuyen || 'N/A'}</td>
                    <td>${createBadge(order.trangThaiThuTien)}</td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // --- SELECTION & COPY/PASTE LOGIC (Largely unchanged) ---
        function handleMouseDown(e) {
            const cell = e.target.closest('td');
            if (!cell) return;
            isMouseDown = true; startCell = cell;
            if (e.shiftKey && lastClickedCell) { clearSelection(); selectCellsInRectangle(lastClickedCell, cell); } 
            else if (e.ctrlKey) { toggleCellSelection(cell); } 
            else { clearSelection(); selectCell(cell); }
            lastClickedCell = cell; e.preventDefault();
        }
        function handleMouseMove(e) { if (!isMouseDown || !startCell) return; const endCell = e.target.closest('td'); if (endCell) { clearSelection(); selectCellsInRectangle(startCell, endCell); } }
        function handleMouseUp() { isMouseDown = false; }
        function selectCell(cell) { cell.classList.add('cell-selected'); selectedCells.add(cell); }
        function toggleCellSelection(cell) { if (selectedCells.has(cell)) { cell.classList.remove('cell-selected'); selectedCells.delete(cell); } else { selectCell(cell); } }
        function selectCellsInRectangle(start, end) {
            const tableBody = document.getElementById('orderTableBody');
            const allRows = Array.from(tableBody.rows);
            const startCoords = { row: allRows.indexOf(start.parentElement), col: start.cellIndex };
            const endCoords = { row: allRows.indexOf(end.parentElement), col: end.cellIndex };
            const rowStart = Math.min(startCoords.row, endCoords.row);
            const rowEnd = Math.max(startCoords.row, endCoords.row);
            const colStart = Math.min(startCoords.col, endCoords.col);
            const colEnd = Math.max(startCoords.col, endCoords.col);
            for (let i = rowStart; i <= rowEnd; i++) {
                for (let j = colStart; j <= colEnd; j++) {
                   if(allRows[i] && allRows[i].cells[j]) selectCell(allRows[i].cells[j]);
                }
            }
        }
        function copySelectedToClipboard() {
            if (selectedCells.size === 0) return alert("Ch∆∞a c√≥ √¥ n√†o ƒë∆∞·ª£c ch·ªçn.");
            const sortedCells = Array.from(selectedCells).sort((a, b) => (a.parentElement.rowIndex - b.parentElement.rowIndex) || (a.cellIndex - b.cellIndex));
            let clipboardText = '', lastRowIndex = -1;
            sortedCells.forEach(cell => {
                const rowIndex = cell.parentElement.rowIndex;
                if (lastRowIndex !== -1 && rowIndex !== lastRowIndex) clipboardText += '\n';
                else if (lastRowIndex !== -1) clipboardText += '\t';
                clipboardText += cell.innerText.trim();
                lastRowIndex = rowIndex;
            });
            navigator.clipboard.writeText(clipboardText).then(() => alert(`ƒê√£ sao ch√©p ${selectedCells.size} √¥.`)).catch(err => console.error(err));
        }
        function downloadCSV() {
            if (currentDisplayedOrders.length === 0) return alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ t·∫£i v·ªÅ.");
            const headers = ["M√£ ƒë∆°n h√†ng", "Ng√†y l√™n ƒë∆°n", "T√™n KH", "SƒêT", "ƒê·ªãa ch·ªâ", "Th√†nh ph·ªë", "T·ªânh", "M·∫∑t h√†ng", "T·ªïng ti·ªÅn", "H√¨nh th·ª©c TT", "Ghi ch√∫", "Tr·∫°ng th√°i giao", "ƒê∆°n v·ªã VC", "Tr·∫°ng th√°i thu ti·ªÅn"];
            let csvContent = headers.join(',') + '\n';
            currentDisplayedOrders.forEach(order => {
                const rowData = [order.maDonHang, order.ngayLenDon ? new Date(order.ngayLenDon).toLocaleDateString('vi-VN') : '', order.name, order.phone, order.address, order.city, order.state, order.matHang, order.tongTienVND, order.hinhThucThanhToan, order.ghiChu, order.trangThaiGiaoHangNB, order.donViVanChuyen, order.trangThaiThuTien];
                csvContent += rowData.map(field => `"${String(field || '').replace(/"/g, '""')}"`).join(',') + '\n';
            });
            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "don_hang_da_loc.csv";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        function showError(message) { document.getElementById('userInfo').textContent = 'L·ªói'; document.getElementById('orderTableBody').innerHTML = `<tr><td colspan="15" class="error">${message}</td></tr>`; }
        function showNoOrders() { document.getElementById('rowCount').textContent = "Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o."; document.getElementById('orderTableBody').innerHTML = `<tr><td colspan="15" class="no-results">Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o ƒë∆∞·ª£c g√°n cho nh√¢n vi√™n n√†y.</td></tr>`; }
    </script>
</body>
</html>

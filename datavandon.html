<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <title>QUẢN LÝ VẬN ĐƠN LumiGlobal</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    :root {
      --font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      --primary-color: #1D2F5F;
      --primary-color-dark: #16254A;
      --primary-color-light: #E8EAF6;
      --accent-color: #F37021;
      --accent-color-dark: #D85B0A;
      --success-color: #28a745;
      --warning-color: #ffc107;
      --danger-color: #dc3545;
      --text-color: #212529;
      --text-color-muted: #6c757d;
      --bg-body: #f8f9fa;
      --bg-card: #ffffff;
      --border-color: #dee2e6;
      --border-radius: 6px;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --transition-speed: 0.2s;
    }

    html {
      font-size: 16px;
    }

    body {
      font-family: var(--font-family);
      padding: 20px;
      background-color: var(--bg-body);
      color: var(--text-color);
      margin: 0;
      line-height: 1.5;
    }

    .page-header {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 16px;
      margin-bottom: 2rem;
    }

    .header-logo {
      height: 50px;
      width: auto;
      mix-blend-mode: darken;
    }

    h2 {
      margin: 0;
      color: var(--accent-color);
      font-weight: 700;
      text-transform: uppercase;
      font-size: 1.75rem;
    }

    #loader-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.3s ease;
    }

    #loader-overlay img {
      max-width: 200px;
      animation: pulse 1.5s infinite ease-in-out;
    }

    @keyframes pulse {
      0% {
        transform: scale(1);
        opacity: 1;
      }

      50% {
        transform: scale(1.05);
        opacity: 0.8;
      }

      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--bg-card);
      padding: 1rem 1.5rem;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-md);
      position: sticky;
      top: 0;
      z-index: 100;
      flex-wrap: wrap;
      gap: 1rem;
      border: 1px solid var(--border-color);
      margin-bottom: 1.5rem;
    }

    .controls .left-controls,
    .controls .right-controls {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    button,
    .btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: var(--border-radius);
      font-size: 0.9rem;
      font-weight: 500;
      color: white;
      transition: all var(--transition-speed) ease-in-out;
      cursor: pointer;
      box-shadow: var(--shadow-sm);
    }

    button:hover,
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    button:focus-visible,
    .btn:focus-visible {
      outline: 2px solid var(--primary-color);
      outline-offset: 2px;
    }

    .refresh-btn {
      background-color: var(--success-color);
    }

    .update-btn {
      background-color: var(--primary-color);
    }

    .clear-filter-btn {
      background-color: var(--warning-color);
      color: var(--text-color);
    }

    .refresh-btn:hover {
      background-color: #218838;
    }

    .update-btn:hover {
      background-color: var(--primary-color-dark);
    }

    .clear-filter-btn:hover {
      background-color: #e0a800;
    }

    input[type="text"],
    input[type="date"],
    input[type="number"],
    select,
    .filter-select {
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      font-size: 0.9rem;
      background-color: var(--bg-card);
      transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(29, 47, 95, 0.25);
    }

    .tab-controls {
      display: flex;
      border-bottom: 2px solid var(--border-color);
      margin-bottom: 1.5rem;
      margin-left: 0;
      padding: 0;
      border-radius: 0;
      overflow: visible;
    }

    .tab-btn {
      background-color: transparent;
      border: none;
      border-bottom: 3px solid transparent;
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-color-muted);
      border-radius: 0;
      margin-bottom: -2px;
      box-shadow: none;
    }

    .tab-btn:hover {
      color: var(--accent-color);
      background-color: #fef0e8;
      transform: none;
      box-shadow: none;
    }

    .tab-btn.active {
      color: var(--accent-color);
      background-color: transparent;
      border-color: var(--accent-color);
      box-shadow: none;
    }

    .content-tab {
      display: none;
    }

    .content-tab.active {
      display: block;
    }

    .main-table-wrapper {
      overflow: auto;
      max-height: calc(100vh - 250px);
      background: var(--bg-card);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border-color);
    }

    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 2200px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    th,
    td {
      border: none;
      border-bottom: 1px solid var(--border-color);
      padding: 0.75rem 1rem;
      white-space: nowrap;
      background-color: var(--bg-card);
      text-align: left;
    }

    th {
      background-color: #f8f9fa;
      color: var(--text-color);
      font-weight: 600;
      vertical-align: top;
      position: sticky;
      top: 0;
      z-index: 20;
      border-bottom-width: 2px;
    }

    #tableBody tr:hover td,
    #japanTableBody tr:hover td,
    #allRegionsTableBody tr:hover td,
    #leaderTableBody tr:hover td,
    #mentionedTableBody tr:hover td,
    #hcmTableBody tr:hover td,
    #hanoiTableBody tr:hover td {
      /* Thêm ID mới */
      background-color: var(--primary-color-light) !important;
      cursor: pointer;
    }

    th .filter-input,
    th .filter-select {
      width: 100%;
      box-sizing: border-box;
      margin-top: 0.5rem;
      padding: 0.3rem 0.5rem;
      font-size: 0.75rem;
    }

    th .tracking-filter-container {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 0.5rem;
    }

    th .tracking-filter-container input {
      width: 100%;
      box-sizing: border-box;
    }

    .multi-select-container {
      position: relative;
      display: inline-block;
      width: 100%;
      margin-top: 0.5rem;
    }

    .multi-select-container .multi-select-button {
      background-color: var(--bg-card);
      color: var(--text-color);
      border: 1px solid var(--border-color);
      font-size: 0.75rem;
      padding: 0.3rem 0.5rem;
      text-align: left;
      width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      border-radius: var(--border-radius);
      cursor: pointer;
    }

    .multi-select-container .multi-select-button:hover {
      border-color: var(--secondary-color);
    }

    .checkbox-dropdown {
      display: none;
      position: absolute;
      background-color: var(--bg-card);
      min-width: 220px;
      box-shadow: var(--shadow-lg);
      z-index: 101;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      max-height: 250px;
      overflow-y: auto;
      padding: 0.5rem;
      margin-top: 4px;
    }

    .checkbox-dropdown.show {
      display: block;
    }

    .checkbox-dropdown label {
      display: flex;
      align-items: center;
      padding: 0.4rem 0.6rem;
      cursor: pointer;
      border-radius: 4px;
      transition: background-color var(--transition-speed);
      white-space: nowrap;
      font-size: 0.8rem;
      color: var(--text-color);
      font-weight: 400;
    }

    .checkbox-dropdown label:hover {
      background-color: #e9ecef;
    }

    .checkbox-dropdown label input {
      margin-right: 0.5rem;
    }

    .controls .checkbox-dropdown {
      font-size: 1rem;
    }

    .controls .checkbox-dropdown label {
      font-size: 0.9rem;
    }

    .fixed-column {
      position: sticky;
      z-index: 5;
    }

    th.fixed-column {
      z-index: 30;
      background-color: #f1f3f5;
    }

    td.fixed-column {
      background-color: #f8f9fa;
      border-right: 1px solid var(--border-color);
    }

    td.editable {
      background-color: #e8f5e9;
      border-left: 3px solid #66bb6a;
    }

    .summary-info {
      background: var(--primary-color-light);
      padding: 0.5rem 1rem;
      border-radius: var(--border-radius);
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--primary-color-dark);
      border: 1px solid #c9d1e9;
    }

    .cell-selected {
      background-color: #a7ffeb !important;
      outline: 2px solid #00bfa5;
      outline-offset: -2px;
    }

    .cell-ok {
      background-color: #d4edda !important;
    }

    .cell-cancel {
      background-color: #f8d7da !important;
    }

    .cell-xl {
      background-color: #fff3cd !important;
    }

    ::-webkit-scrollbar {
      width: 12px;
      height: 12px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    ::-webkit-scrollbar-thumb {
      background-color: var(--primary-color);
      border-radius: 10px;
      border: 3px solid #f1f1f1;
    }

    ::-webkit-scrollbar-thumb:hover {
      background-color: var(--primary-color-dark);
    }

    .controls .multi-select-container button {
      background-color: white;
      color: #333;
      border: 1px solid #ccc;
      font-size: 0.9rem;
      padding: 0.5rem 0.75rem;
      text-align: left;
      width: 250px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .controls .checkbox-dropdown {
      min-width: 250px;
      max-height: 300px;
      padding: 10px;
    }

    .controls .checkbox-dropdown label {
      padding: 8px 12px;
      font-size: 16px;
      font-weight: normal;
      color: #333;
    }

    .controls .checkbox-dropdown label input {
      margin-right: 10px;
    }

    .status {
      font-size: 0.85em;
      margin-left: 8px;
      color: var(--success-color);
    }

    .error-status {
      color: var(--danger-color);
    }

    td.highlight {
      background-color: #ffeb3b !important;
    }
  </style>
</head>

<body>

  <div id="loader-overlay">
    <img
      src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Ff930e667.%E1%BA%A2nh.025539.jpg"
      alt="Loading Logo">
  </div>

  <div class="page-header">
    <img class="header-logo"
      src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Ff930e667.%E1%BA%A2nh.025539.jpg"
      alt="LumiGlobal Logo">
    <h2>QUẢN LÝ VẬN ĐƠN LumiGlobal</h2>
  </div>

  <div class="tab-controls">
    <button id="tabData" class="tab-btn active">Dữ liệu đơn hàng</button>
    <button id="tabLeader" class="tab-btn" style="display: none;">Đơn của Leader</button>
    <button id="tabAllRegions" class="tab-btn" style="display: none;">Tổng đơn 2 miền</button>
    <button id="tabJapan" class="tab-btn">Đơn Nhật</button>
    <button id="tabMentioned" class="tab-btn" style="display: none;">Người được nhắc hộ</button>
    <!-- NEW TABS -->
    <button id="tabHCM" class="tab-btn" style="display: none;">Đơn HCM</button>
    <button id="tabHanoi" class="tab-btn" style="display: none;">Đơn Hà Nội</button>
  </div>

  <div id="contentData" class="content-tab active">
    <div class="controls">
      <div class="left-controls">
        <span id="userInfo"></span>
        <button id="refreshData" class="refresh-btn"><span class="refresh-icon">↻</span> Load</button>
        <button id="updateAll" class="update-btn">Cập nhật</button>
        <div class="fixed-col-control">
          <span>Cột cố định:</span>
          <input type="number" id="fixedColumnCountInput" value="1" min="0" style="width: 70px;">
        </div>
        <div id="summaryInfo" class="summary-info"></div>
        <div id="selectionSummary" class="summary-info" style="background-color: #e8f5e9; border: 1px solid #a5d6a7;">
        </div>
      </div>
      <div class="right-controls">
        <div class="date-filter">
          <span>Từ:</span><input type="date" id="startDateFilter" />
          <span>Đến:</span><input type="date" id="endDateFilter" />
        </div>
        <select id="productFilter" class="filter-select">
          <option value="">Tất cả sản phẩm</option>
        </select>
        <select id="marketFilter" class="filter-select">
          <option value="">Tất cả khu vực</option>
        </select>
        <button id="clearFilters" class="clear-filter-btn">Xóa lọc</button>
      </div>
    </div>
    <div class="main-table-wrapper" id="tableContainer">
      <table>
        <thead id="tableHead"></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- NỘI DUNG TAB LEADER -->
  <div id="contentLeader" class="content-tab">
    <div class="controls">
      <div class="left-controls">
        <span class="tab-info-text">Đơn hàng do bạn xử lý</span>
        <button id="leaderRefreshData" class="refresh-btn"><span class="refresh-icon">↻</span> Load</button>
        <button id="leaderUpdateAll" class="update-btn">Cập nhật</button>
        <div id="leaderSummaryInfo" class="summary-info"></div>
      </div>
      <div class="right-controls">
        <div class="date-filter">
          <span>Từ:</span><input type="date" id="leaderStartDateFilter" />
          <span>Đến:</span><input type="date" id="leaderEndDateFilter" />
        </div>
        <select id="leaderProductFilter" class="filter-select">
          <option value="">Sản phẩm</option>
        </select>
        <button id="leaderClearFilters" class="clear-filter-btn">Xóa lọc</button>
      </div>
    </div>
    <div class="main-table-wrapper" id="leaderTableContainer">
      <table>
        <thead id="leaderTableHead"></thead>
        <tbody id="leaderTableBody"></tbody>
      </table>
    </div>
  </div>

  <div id="contentAllRegions" class="content-tab">
    <div class="controls">
      <div class="left-controls">
        <span class="tab-info-text">Toàn bộ đơn hàng</span>
        <button id="allRegionsRefreshData" class="refresh-btn"><span class="refresh-icon">↻</span> Load</button>
        <button id="allRegionsUpdateAll" class="update-btn">Cập nhật</button>
        <div id="allRegionsSummaryInfo" class="summary-info"></div>
      </div>
      <div class="right-controls">
        <div class="date-filter">
          <span>Từ:</span><input type="date" id="allRegionsStartDateFilter" />
          <span>Đến:</span><input type="date" id="allRegionsEndDateFilter" />
        </div>
        <select id="allRegionsProductFilter" class="filter-select">
          <option value="">Sản phẩm</option>
        </select>
        <select id="allRegionsMarketFilter" class="filter-select">
          <option value="">Khu vực</option>
        </select>
        <select id="allRegionsStaffFilter" class="filter-select">
          <option value="">NV Vận đơn</option>
        </select>
        <button id="allRegionsClearFilters" class="clear-filter-btn">Xóa lọc</button>
      </div>
    </div>
    <div class="main-table-wrapper" id="allRegionsTableContainer">
      <table>
        <thead id="allRegionsTableHead"></thead>
        <tbody id="allRegionsTableBody"></tbody>
      </table>
    </div>
  </div>

  <div id="contentJapan" class="content-tab">
    <div class="controls">
      <div class="left-controls">
        <span class="tab-info-text">Đơn hàng khu vực: Nhật Bản</span>
        <button id="japanRefreshData" class="refresh-btn"><span class="refresh-icon">↻</span> Load</button>
        <button id="japanUpdateAll" class="update-btn">Cập nhật</button>
        <div id="japanSummaryInfo" class="summary-info"></div>
      </div>
      <div class="right-controls">
        <div class="date-filter">
          <span>Từ:</span><input type="date" id="japanStartDateFilter" />
          <span>Đến:</span><input type="date" id="japanEndDateFilter" />
        </div>
        <select id="japanProductFilter" class="filter-select">
          <option value="">Sản phẩm</option>
        </select>
        <select id="japanStaffFilter" class="filter-select">
          <option value="">NV Vận đơn</option>
        </select>
        <button id="japanClearFilters" class="clear-filter-btn">Xóa lọc</button>
      </div>
    </div>
    <div class="main-table-wrapper" id="japanTableContainer">
      <table>
        <thead id="japanTableHead"></thead>
        <tbody id="japanTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- NỘI DUNG TAB NGƯỜI ĐƯỢC NHẮC HỘ MỚI -->
  <div id="contentMentioned" class="content-tab">
    <div class="controls">
      <div class="left-controls">
        <span class="tab-info-text">Đơn hàng của người được nhắc hộ</span>
        <button id="mentionedRefreshData" class="refresh-btn"><span class="refresh-icon">↻</span> Load</button>
        <button id="mentionedUpdateAll" class="update-btn">Cập nhật</button>
        <div id="mentionedSummaryInfo" class="summary-info"></div>
      </div>
      <div class="right-controls">
        <div class="date-filter">
          <span>Từ:</span><input type="date" id="mentionedStartDateFilter" />
          <span>Đến:</span><input type="date" id="mentionedEndDateFilter" />
        </div>
        <select id="mentionedProductFilter" class="filter-select">
          <option value="">Sản phẩm</option>
        </select>
        <button id="mentionedClearFilters" class="clear-filter-btn">Xóa lọc</button>
      </div>
    </div>
    <div class="main-table-wrapper" id="mentionedTableContainer">
      <table>
        <thead id="mentionedTableHead"></thead>
        <tbody id="mentionedTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- NỘI DUNG TAB HCM -->
  <div id="contentHCM" class="content-tab">
    <div class="controls">
      <div class="left-controls">
        <span class="tab-info-text">Đơn hàng khu vực: Hồ Chí Minh</span>
        <button id="hcmRefreshData" class="refresh-btn"><span class="refresh-icon">↻</span> Load</button>
        <button id="hcmUpdateAll" class="update-btn">Cập nhật</button>
        <div id="hcmSummaryInfo" class="summary-info"></div>
      </div>
      <div class="right-controls">
        <div class="date-filter">
          <span>Từ:</span><input type="date" id="hcmStartDateFilter" />
          <span>Đến:</span><input type="date" id="hcmEndDateFilter" />
        </div>
        <select id="hcmProductFilter" class="filter-select">
          <option value="">Sản phẩm</option>
        </select>
        <select id="hcmStaffFilter" class="filter-select">
          <option value="">NV Vận đơn</option>
        </select>
        <button id="hcmClearFilters" class="clear-filter-btn">Xóa lọc</button>
      </div>
    </div>
    <div class="main-table-wrapper" id="hcmTableContainer">
      <table>
        <thead id="hcmTableHead"></thead>
        <tbody id="hcmTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- NỘI DUNG TAB HÀ NỘI -->
  <div id="contentHanoi" class="content-tab">
    <div class="controls">
      <div class="left-controls">
        <span class="tab-info-text">Đơn hàng khu vực: Hà Nội</span>
        <button id="hanoiRefreshData" class="refresh-btn"><span class="refresh-icon">↻</span> Load</button>
        <button id="hanoiUpdateAll" class="update-btn">Cập nhật</button>
        <div id="hanoiSummaryInfo" class="summary-info"></div>
      </div>
      <div class="right-controls">
        <div class="date-filter">
          <span>Từ:</span><input type="date" id="hanoiStartDateFilter" />
          <span>Đến:</span><input type="date" id="hanoiEndDateFilter" />
        </div>
        <select id="hanoiProductFilter" class="filter-select">
          <option value="">Sản phẩm</option>
        </select>
        <select id="hanoiStaffFilter" class="filter-select">
          <option value="">NV Vận đơn</option>
        </select>
        <button id="hanoiClearFilters" class="clear-filter-btn">Xóa lọc</button>
      </div>
    </div>
    <div class="main-table-wrapper" id="hanoiTableContainer">
      <table>
        <thead id="hanoiTableHead"></thead>
        <tbody id="hanoiTableBody"></tbody>
      </table>
    </div>
  </div>


  <script>
    const POST_URL = 'https://script.google.com/macros/s/AKfycbz-RldT6BcffMyv_f0Z5zm_9jCfmsYdOHZxKsjYc6PKu25qbs3kdWbGU8P1UpEb_dXP/exec';
    const IMMEDIATE_UPDATE_URL = 'https://script.google.com/macros/s/AKfycbxZXv36EPfW5K9oT660V9jtm4xgVyaCQo2apk0EfBydggFrX6QLHC8sEnm6Kc0WsfE-/exec';

    // === CẤU HÌNH CỘT ===
    const columnDisplayMapping = {};
    const editableCols = ["Kết quả Check", "Trạng thái giao hàng NB", "Lý do", "Trạng thái thu tiền", "Ghi chú của VĐ"];
    const dropdownCols = {
      "Kết quả Check": ["", "OK", "Huỷ", "Treo", "Vận đơn XL", "Đợi hàng", "Khách hẹn"],
      "Trạng thái giao hàng NB": ["", "Giao Thành Công", "Đang Giao", "Chưa Giao", "Hủy", "Hoàn", "chờ check", "Giao không thành công", "Bom_Thất Lạc"],
      "Trạng thái thu tiền": ["", "Có bill", "Có bill 1 phần", "Bom_bùng_chặn", "Hẹn Thanh Toán", "Hoàn Hàng", "Khó Đòi", "Không nhận được hàng", "Không PH dưới 3N", "Thanh toán phí hoàn", "KPH nhiều ngày"]
    };
    const displayColumns = ["Mã đơn hàng", "Kết quả Check", "Trạng thái giao hàng NB", "Mã Tracking", "Lý do", "Trạng thái thu tiền", "Ghi chú của VĐ", "Ngày lên đơn", "Name*", "Phone*", "Add", "City", "State", "khu vực", "Zipcode", "Mặt hàng", "Tên mặt hàng 1", "Số lượng mặt hàng 1", "Tên mặt hàng 2", "Số lượng mặt hàng 2", "Quà tặng", "Số lượng quà kèm", "Giá bán", "Loại tiền thanh toán", "Tổng tiền VNĐ", "Hình thức thanh toán", "Ghi chú", "Ngày đóng hàng", "Trạng thái giao hàng", "Thời gian giao dự kiến", "Phí ship nội địa Mỹ (usd)", "Phí xử lý đơn đóng hàng-Lưu kho(usd)", "GHI CHÚ", "Nhân viên Sale", "NV Vận đơn", "Đơn vị vận chuyển", "Số tiền của đơn hàng đã về TK Cty", "Kế toán xác nhận thu tiền về", "Ngày Kế toán đối soát với FFM lần 2"];
    const allDateColumns = ["Ngày lên đơn", "Ngày đóng hàng"];
    const columnsToMakeDynamic = ["Kết quả Check", "Trạng thái giao hàng NB", "Trạng thái thu tiền", "khu vực", "Mặt hàng", "Nhân viên Sale", "NV Vận đơn", "Đơn vị vận chuyển"];

    const singleSelectFilterCols = ["Kết quả Check"];
    const datalistFilterCols = ["Mã đơn hàng", "Name*", "Phone*", "Nhân viên Sale"];
    // === KẾT THÚC CẤU HÌNH ===

    let allData = [],
      staffFilteredData = [],
      japanData = [],
      leaderData = [],
      mentionedData = [], // Thêm mentionedData
      hcmData = [], // NEW
      hanoiData = [], // NEW
      changedRows = new Map(),
      japanChangedRows = new Map(),
      allRegionsChangedRows = new Map(),
      leaderChangedRows = new Map(),
      mentionedChangedRows = new Map(), // Thêm mentionedChangedRows
      hcmChangedRows = new Map(), // NEW
      hanoiChangedRows = new Map(), // NEW
      currentStaff = null,
      teamMembers = [],
      selectedCells = new Set(),
      isMouseDown = false,
      startCell = null,
      dynamicFilterOptions = {},
      japanDynamicFilterOptions = {},
      allRegionsDynamicFilterOptions = {},
      leaderDynamicFilterOptions = {},
      mentionedDynamicFilterOptions = {}, // Thêm mentionedDynamicFilterOptions
      hcmDynamicFilterOptions = {}, // NEW
      hanoiDynamicFilterOptions = {}, // NEW
      datalistOptions = {},
      filterDebounceTimer;

    const mainTabConfig = { data: () => staffFilteredData, changedRows, controls: { refreshBtn: 'refreshData', updateBtn: 'updateAll', clearBtn: 'clearFilters', startDate: 'startDateFilter', endDate: 'endDateFilter', product: 'productFilter', market: 'marketFilter', summary: 'summaryInfo' }, table: { head: 'tableHead', body: 'tableBody' }, dynamicOptions: () => dynamicFilterOptions };
    const allRegionsTabConfig = { data: () => allData, changedRows: allRegionsChangedRows, controls: { refreshBtn: 'allRegionsRefreshData', updateBtn: 'allRegionsUpdateAll', clearBtn: 'allRegionsClearFilters', startDate: 'allRegionsStartDateFilter', endDate: 'allRegionsEndDateFilter', product: 'allRegionsProductFilter', market: 'allRegionsMarketFilter', staff: 'allRegionsStaffFilter', summary: 'allRegionsSummaryInfo' }, table: { head: 'allRegionsTableHead', body: 'allRegionsTableBody' }, dynamicOptions: () => allRegionsDynamicFilterOptions };
    const japanTabConfig = { data: () => japanData, changedRows: japanChangedRows, controls: { refreshBtn: 'japanRefreshData', updateBtn: 'japanUpdateAll', clearBtn: 'japanClearFilters', startDate: 'japanStartDateFilter', endDate: 'japanEndDateFilter', product: 'japanProductFilter', staff: 'japanStaffFilter', summary: 'japanSummaryInfo' }, table: { head: 'japanTableHead', body: 'japanTableBody' }, dynamicOptions: () => japanDynamicFilterOptions };
    const leaderTabConfig = { data: () => leaderData, changedRows: leaderChangedRows, controls: { refreshBtn: 'leaderRefreshData', updateBtn: 'leaderUpdateAll', clearBtn: 'leaderClearFilters', startDate: 'leaderStartDateFilter', endDate: 'leaderEndDateFilter', product: 'leaderProductFilter', summary: 'leaderSummaryInfo' }, table: { head: 'leaderTableHead', body: 'leaderTableBody' }, dynamicOptions: () => leaderDynamicFilterOptions };
    // Thêm config cho tab Mentioned
    const mentionedTabConfig = { data: () => mentionedData, changedRows: mentionedChangedRows, controls: { refreshBtn: 'mentionedRefreshData', updateBtn: 'mentionedUpdateAll', clearBtn: 'mentionedClearFilters', startDate: 'mentionedStartDateFilter', endDate: 'mentionedEndDateFilter', product: 'mentionedProductFilter', summary: 'mentionedSummaryInfo' }, table: { head: 'mentionedTableHead', body: 'mentionedTableBody' }, dynamicOptions: () => mentionedDynamicFilterOptions };
    // NEW TAB CONFIGS
    const hcmTabConfig = { data: () => hcmData, changedRows: hcmChangedRows, controls: { refreshBtn: 'hcmRefreshData', updateBtn: 'hcmUpdateAll', clearBtn: 'hcmClearFilters', startDate: 'hcmStartDateFilter', endDate: 'hcmEndDateFilter', product: 'hcmProductFilter', staff: 'hcmStaffFilter', summary: 'hcmSummaryInfo' }, table: { head: 'hcmTableHead', body: 'hcmTableBody' }, dynamicOptions: () => hcmDynamicFilterOptions };
    const hanoiTabConfig = { data: () => hanoiData, changedRows: hanoiChangedRows, controls: { refreshBtn: 'hanoiRefreshData', updateBtn: 'hanoiUpdateAll', clearBtn: 'hanoiClearFilters', startDate: 'hanoiStartDateFilter', endDate: 'hanoiEndDateFilter', product: 'hanoiProductFilter', staff: 'hanoiStaffFilter', summary: 'hanoiSummaryInfo' }, table: { head: 'hanoiTableHead', body: 'hanoiTableBody' }, dynamicOptions: () => hanoiDynamicFilterOptions };


    const allTabConfigs = [mainTabConfig, allRegionsTabConfig, japanTabConfig, leaderTabConfig, mentionedTabConfig, hcmTabConfig, hanoiTabConfig]; // Thêm mentionedTabConfig và các tab mới vào mảng

    function getDateTimeVN(dateInput) {
      let date;

      if (!dateInput) {
        date = new Date(); // nếu không có truyền vào, dùng thời gian hiện tại
      } else {
        date = new Date(dateInput);
        if (isNaN(date.getTime())) {
          console.warn("⚠️ Invalid dateInput:", dateInput);
          return "Ngày không hợp lệ";
        }
      }

      const options = { timeZone: "Asia/Ho_Chi_Minh", hour12: false };
      const vnDate = new Date(date.toLocaleString("en-US", options));

      const dd = String(vnDate.getDate()).padStart(2, "0");
      const mm = String(vnDate.getMonth() + 1).padStart(2, "0");
      const yyyy = vnDate.getFullYear();
      const HH = String(vnDate.getHours()).padStart(2, "0");
      const MM = String(vnDate.getMinutes()).padStart(2, "0");
      const SS = String(vnDate.getSeconds()).padStart(2, "0");

      return `${dd}/${mm}/${yyyy} ${HH}:${MM}:${SS}`;
    }

    function getFixedColumnCount() { const e = document.getElementById("fixedColumnCountInput"), t = parseInt(e.value, 10); return isNaN(t) || t < 0 ? 0 : t }
    function handleFixedColumnCountChange() { const newCount = getFixedColumnCount(); const activeTab = document.querySelector(".content-tab.active"); if (!activeTab) return; const activeConfig = allTabConfigs.find(c => c.table.body === activeTab.querySelector("tbody")?.id); if (!activeConfig) return; const tableHead = document.getElementById(activeConfig.table.head); const tableBody = document.getElementById(activeConfig.table.body); if (!tableHead || !tableBody) return; const allRows = [...tableHead.querySelectorAll("tr"), ...tableBody.querySelectorAll("tr")]; allRows.forEach(row => { for (let i = 0; i < row.cells.length; i++) { const cell = row.cells[i]; if (i < newCount) { cell.classList.add("fixed-column") } else { cell.classList.remove("fixed-column"); cell.style.left = "" } } }); updateStickyColumns(activeConfig) }
    function updateStickyColumns(config) { const fixedCount = getFixedColumnCount(); const tableHead = document.getElementById(config.table.head); const tableBody = document.getElementById(config.table.body);[...tableHead.querySelectorAll(".fixed-column"), ...tableBody.querySelectorAll(".fixed-column")].forEach(c => c.style.left = ""); if (fixedCount <= 0) return; const headerRow = tableHead.querySelector("tr"); if (!headerRow) return; let leftOffset = 0; for (let i = 0; i < fixedCount; i++) { const th = headerRow.cells[i]; if (!th) continue; th.style.left = leftOffset + "px"; const rows = tableBody.querySelectorAll("tr"); rows.forEach(row => { if (row.cells[i]) { row.cells[i].style.left = leftOffset + "px" } }); leftOffset += th.offsetWidth } }
    function getUrlParameter(name) { name = name.replace(/[\[\]]/g, "\\$&"); const regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"), results = regex.exec(window.location.href); if (!results) return null; if (!results[2]) return ""; return decodeURIComponent(results[2].replace(/\+/g, " ")) }
    function parseDateString(dateString) {
      if (!dateString || typeof dateString !== "string") return null; const cleanedDateString = dateString.trim().replace(/[^\d\/\-\s]/g, ""); if (/^\d{4}-\d{2}-\d{2}/.test(cleanedDateString)) { const d = new Date(cleanedDateString); if (!isNaN(d.getTime())) return d }
      const parts = cleanedDateString.match(/^(\d{1,2})[/\-](\d{1,2})[/\-](\d{4})/); if (parts) { const month = parseInt(parts[1], 10), day = parseInt(parts[2], 10), year = parseInt(parts[3], 10); if (year > 1e3 && month > 0 && month <= 12 && day > 0 && day <= 31) { const d = new Date(Date.UTC(year, month - 1, day)); if (d.getUTCFullYear() === year && d.getUTCMonth() === month - 1) return d } }
      return null
    }
    function formatDate(dateString) {
      const originalValue = typeof dateString === "string" ? dateString.trim() : ""; if (!originalValue) return { display: "", original: "" }; const dateObj = parseDateString(originalValue); if (dateObj) { const day = String(dateObj.getUTCDate()).padStart(2, "0"), month = String(dateObj.getUTCMonth() + 1).padStart(2, "0"), year = dateObj.getUTCFullYear(); return { display: `${day}/${month}/${year}`, original: originalValue } }
      return { display: originalValue, original: originalValue }
    }
    async function fetchStaffInfo(idns) {
      try {
        const staffApiUrl = "https://script.google.com/macros/s/AKfycbzwOv7UFwrqzf88QJL1QrxLKcnnnSIQ_PSmF0SO8LboqWI5li3vF3W8_-8s-A8lNGaR/exec";
        const response = await fetch(staffApiUrl, { cache: "no-store" });
        if (!response.ok) throw new Error("Lỗi mạng khi tải data nhân viên");
        const data = await response.json();
        let staffMember = data.find(staff => String(staff.idnv) === idns);
        if (!staffMember) {
          throw new Error(`Không tìm thấy nhân viên với ID: ${idns}`);
        }
        const memberNames = new Set();
        if (staffMember) {
          if (staffMember.ho_va_ten) memberNames.add(staffMember.ho_va_ten);
          if (staffMember.vi_tri === "Leader" && staffMember.team) {
            const teamName = staffMember.team;
            data.forEach(member => {
              if (member.team === teamName && member.ho_va_ten) memberNames.add(member.ho_va_ten);
            });
          }
        }
        teamMembers = Array.from(memberNames);
        return staffMember;
      } catch (error) {
        showError(error.message);
        throw error;
      }
    }
    async function fetchMultipleStaffInfo(idArray) {
      if (!idArray || idArray.length === 0) return [];
      try {
        const staffApiUrl = "https://script.google.com/macros/s/AKfycbzwOv7UFwrqzf88QJL1QrxLKcnnnSIQ_PSmF0SO8LboqWI5li3vF3W8_-8s-A8lNGaR/exec";
        const response = await fetch(staffApiUrl, { cache: "no-store" });
        if (!response.ok) throw new Error("Lỗi mạng khi tải data nhân viên cho tab nhắc hộ");
        const allStaffData = await response.json();
        const staffNames = new Set();
        idArray.forEach(id => {
          const staffMember = allStaffData.find(staff => String(staff.idnv) === id.trim());
          if (staffMember && staffMember.ho_va_ten) {
            staffNames.add(staffMember.ho_va_ten);
          }
        });
        if (staffNames.size === 0) {
          console.warn("Không tìm thấy nhân viên nào hợp lệ cho các ID trong id1:", idArray);
        }
        return Array.from(staffNames);
      } catch (error) {
        showError(error.message, 'mentionedTableBody');
        throw error;
      }
    }

    function showError(message, containerId = "tableBody") { const container = document.getElementById(containerId), colCount = displayColumns.length; container.innerHTML = `<tr><td colspan="${colCount}" class="no-data" style="text-align: center;">${message}</td></tr>` }

    function updateSummaryInfo(config) {
      const tableBody = document.getElementById(config.table.body);
      const summaryElement = document.getElementById(config.controls.summary);
      const originalData = config.data();
      let visibleCount = 0;
      let totalAmount = 0;

      tableBody.querySelectorAll('tr').forEach(tr => {
        if (tr.style.display !== 'none') {
          visibleCount++;
          const rowIndex = parseInt(tr.dataset.rowIndex, 10);
          if (!isNaN(rowIndex) && originalData[rowIndex]) {
            const row = originalData[rowIndex];
            let amountValue = row["Tổng tiền VNĐ"] || row.Tổng_tiền_VNĐ || 0;
            const numericValue = parseFloat(String(amountValue).replace(/[^\d.-]/g, "")) || 0;
            totalAmount += numericValue;
          }
        }
      });
      const formattedAmount = new Intl.NumberFormat("vi-VN", { style: "currency", currency: "VND" }).format(totalAmount);
      summaryElement.innerHTML = `Tổng đơn: <b>${visibleCount}</b> | Tổng tiền: <b style="color:var(--success-color)">${formattedAmount}</b>`;
    }

    function getDOMCellValue(e) { if (!e) return ""; const t = e.querySelector("select"); if (t) return t.value; const n = e.querySelector("input"); return n ? n.value : e.textContent.trim() }
    function updateSelectionSummary() {
      const summaryEl = document.getElementById("selectionSummary"); if (!summaryEl || !document.getElementById("contentData").classList.contains("active")) { if (summaryEl) summaryEl.innerHTML = ""; return }
      if (selectedCells.size <= 1) { summaryEl.innerHTML = ""; return }
      let totalSum = 0, numericCount = 0, nonBlankCount = 0; selectedCells.forEach(cell => { const value = getDOMCellValue(cell); if (value !== "") nonBlankCount++; const numericValue = parseFloat(String(value).replace(/[^0-9.-]/g, "")); if (!isNaN(numericValue)) { totalSum += numericValue; numericCount++ } }); let summaryParts = [`Count: <b>${nonBlankCount}</b>`]; if (numericCount > 0) summaryParts.push(`Sum: <b>${totalSum.toLocaleString("vi-VN")}</b>`); summaryEl.innerHTML = summaryParts.join(" | ")
    }
    function setupCellSelection(tableBodyId) {
      const tableBody = document.getElementById(tableBodyId); if (!tableBody) return; let lastClickTime = 0, lastClickCell = null; tableBody.addEventListener("mousedown", e => { const td = e.target.closest("td"); if (!td) return; if (e.target.tagName === "SELECT" || e.target.tagName === "INPUT") return; if (!e.ctrlKey && !e.metaKey && !e.shiftKey) { isMouseDown = !0; startCell = td; selectedCells.forEach(cell => cell.classList.remove("cell-selected")); selectedCells.clear(); td.classList.add("cell-selected"); selectedCells.add(td); e.preventDefault() } }); tableBody.addEventListener("click", e => {
        const td = e.target.closest("td"); if (!td) return; if (e.target.tagName === "SELECT" || e.target.tagName === "INPUT") return; const currentTime = (new Date).getTime(), isDoubleClick = currentTime - lastClickTime < 300 && lastClickCell === td; if (isDoubleClick) handleEditCell(td, tableBodyId); else {
          if (e.shiftKey && startCell) selectCellsBetween(startCell, td); else if (e.ctrlKey || e.metaKey) { td.classList.toggle("cell-selected"); if (td.classList.contains("cell-selected")) selectedCells.add(td); else selectedCells.delete(td) } else { selectedCells.forEach(cell => cell.classList.remove("cell-selected")); selectedCells.clear(); td.classList.add("cell-selected"); selectedCells.add(td) }
          startCell = td
        }
        lastClickTime = currentTime; lastClickCell = td; updateSelectionSummary()
      }); tableBody.addEventListener("mouseover", e => { if (isMouseDown) { const td = e.target.closest("td"); if (td) selectCellsBetween(startCell, td) } }); document.addEventListener("mouseup", () => { if (isMouseDown) { isMouseDown = !1; updateSelectionSummary() } })
    }
    function selectCellsBetween(start, end) {
      if (!start || !end || start.closest("tbody") !== end.closest("tbody")) return;
      const tableBody = start.closest("tbody"),
        rows = Array.from(tableBody.rows).filter(r => r.style.display !== "none"),
        startRowIndex = rows.findIndex(row => row.contains(start)),
        endRowIndex = rows.findIndex(row => row.contains(end)),
        startColIndex = start.cellIndex,
        endColIndex = end.cellIndex,
        minRow = Math.min(startRowIndex, endRowIndex),
        maxRow = Math.max(startRowIndex, endRowIndex),
        minCol = Math.min(startColIndex, endColIndex),
        maxCol = Math.max(endColIndex, endColIndex),
        newSelection = new Set;
      for (let i = minRow; i <= maxRow; i++)
        for (let j = minCol; j <= maxCol; j++) {
          const cell = rows[i]?.cells[j];
          if (cell) newSelection.add(cell)
        }
      selectedCells.forEach(cell => {
        if (!newSelection.has(cell)) cell.classList.remove("cell-selected")
      });
      newSelection.forEach(cell => {
        if (!selectedCells.has(cell)) cell.classList.add("cell-selected")
      });
      selectedCells = newSelection
    }

    function updateReconciliationDate(tr, config) {
      if (!tr || !config) return;
      const dateColName = "Ngày Kế toán đối soát với FFM lần 2";
      const dateColIndex = displayColumns.indexOf(dateColName);
      if (dateColIndex === -1) { console.error(`Column "${dateColName}" not found.`); return; }
      const dateCell = tr.cells[dateColIndex];
      if (!dateCell) return;
      const newDateValue = getDateTimeVN();
      // console.log(`Updating date for row ${tr.dataset.rowIndex} to ${newDateValue}`);
      dateCell.textContent = newDateValue;
      dateCell.classList.add('highlight');
      const originalRowIndex = parseInt(tr.dataset.rowIndex);
      if (isNaN(originalRowIndex)) return;
      const currentChanges = config.changedRows.get(originalRowIndex) || {};
      currentChanges[dateColName] = newDateValue;
      config.changedRows.set(originalRowIndex, currentChanges);
    }

    function handleEditCell(td, tableBodyId) {
      if (!td.classList.contains("editable") || td.classList.contains("editing") || td.querySelector("select")) return;
      const dateInput = td.querySelector("input.date-input");
      if (dateInput) { dateInput.focus(); return }
      const originalValue = td.textContent, input = document.createElement("input");
      input.type = "text"; input.value = originalValue; td.textContent = ""; td.appendChild(input);
      td.classList.add("editing"); input.focus();
      const finishEdit = save => {
        const newValue = save ? input.value.trim() : originalValue; td.textContent = newValue;
        td.classList.remove("editing");
        if (save && newValue !== originalValue) {
          td.classList.add("highlight");
          const rowIndex = parseInt(td.closest("tr").dataset.rowIndex);
          const colIndex = td.cellIndex;
          const colName = displayColumns[colIndex];
          const config = allTabConfigs.find(c => c.table.body === tableBodyId);
          if (!isNaN(rowIndex) && config) {
            const currentChanges = config.changedRows.get(rowIndex) || {};
            currentChanges[colName] = newValue; config.changedRows.set(rowIndex, currentChanges);
            if (colName === "Đơn vị vận chuyển") { updateReconciliationDate(td.closest('tr'), config); }
          }
        }
        input.removeEventListener("blur", onBlur); input.removeEventListener("keydown", onKeyDown);
      };
      const onBlur = () => finishEdit(true);
      const onKeyDown = e => {
        if (e.key === "Enter") { e.preventDefault(); finishEdit(true); }
        else if (e.key === "Escape") { e.preventDefault(); finishEdit(false); }
      };
      input.addEventListener("blur", onBlur); input.addEventListener("keydown", onKeyDown);
    }

    function copySelectedCells() {
      if (selectedCells.size === 0) return; const sortedCells = Array.from(selectedCells).sort((a, b) => a.parentNode.rowIndex - b.parentNode.rowIndex || a.cellIndex - b.cellIndex), firstCell = sortedCells[0], minRow = firstCell.parentNode.rowIndex, minCol = sortedCells.reduce((min, cell) => Math.min(min, cell.cellIndex), 1 / 0), grid = new Map; sortedCells.forEach(cell => { const r = cell.parentNode.rowIndex - minRow, c = cell.cellIndex - minCol; if (!grid.has(r)) grid.set(r, new Map); grid.get(r).set(c, getDOMCellValue(cell)) }); let tsv = ""; const maxR = Math.max(...Array.from(grid.keys())), maxC = Math.max(...Array.from(grid.values()).flatMap(row => Array.from(row.keys()))); for (let r = 0; r <= maxR; r++) {
        for (let c = 0; c <= maxC; c++) { tsv += grid.get(r)?.get(c) || ""; if (c < maxC) tsv += "\t" }
        if (r < maxR) tsv += "\n"
      }
      navigator.clipboard.writeText(tsv).then(() => showTempMessage(`Đã sao chép ${selectedCells.size} ô`)).catch(err => console.error("Lỗi sao chép:", err))
    }
    function pasteToSelectedCells(text) { if (selectedCells.size === 0) return; const dataGrid = text.split("\n").map(row => row.split("\t")), sortedCells = Array.from(selectedCells).sort((a, b) => a.parentNode.rowIndex - b.parentNode.rowIndex || a.cellIndex - b.cellIndex), firstCell = sortedCells[0], table = firstCell.closest("table"); if (!table) return; const startRowIndex = Array.from(table.rows).indexOf(firstCell.closest("tr")), startColIndex = firstCell.cellIndex; let pasteCount = 0; if (dataGrid.length === 1 && dataGrid[0].length === 1) { const value = dataGrid[0][0]; sortedCells.forEach(cell => { if (updateCellValue(cell, value)) pasteCount++ }) } else dataGrid.forEach((row, r) => { row.forEach((value, c) => { const targetRow = table.rows[startRowIndex + r]; if (targetRow) { const targetCell = targetRow.cells[startColIndex + c]; if (targetCell && updateCellValue(targetCell, value)) pasteCount++ } }) }); showTempMessage(`Đã dán ${pasteCount} giá trị`); updateSelectionSummary() }
    function clearSelectedCells() { if (selectedCells.size === 0) return; let clearCount = 0; selectedCells.forEach(cell => { if (updateCellValue(cell, "")) clearCount++ }); if (clearCount > 0) showTempMessage(`Đã xóa nội dung ${clearCount} ô`) }

    function updateCellValue(cell, value) {
      if (!cell || !cell.classList.contains("editable")) return false;
      const select = cell.querySelector("select"); const dateInput = cell.querySelector("input.date-input");
      const rowIndex = parseInt(cell.closest("tr").dataset.rowIndex);
      const config = allTabConfigs.find(c => c.table.body === cell.closest("tbody").id); let changed = false;
      if (select) {
        const optionExists = [...select.options].some(opt => opt.value === value); if (optionExists && select.value !== value) { select.value = value; select.dispatchEvent(new Event("change", { bubbles: true })); changed = true; }
      } else if (dateInput) {
        if (dateInput.value !== value) { dateInput.value = value; dateInput.dispatchEvent(new Event("input", { bubbles: true })); changed = true; }
      } else if (cell.textContent !== value) { cell.textContent = value; cell.classList.add("highlight"); changed = true; }
      if (changed && !isNaN(rowIndex) && config) {
        const colIndex = cell.cellIndex; const colName = displayColumns[colIndex];
        const currentChanges = config.changedRows.get(rowIndex) || {}; currentChanges[colName] = value; config.changedRows.set(rowIndex, currentChanges);
        if (colName === "Đơn vị vận chuyển") { updateReconciliationDate(cell.closest('tr'), config); }
      } return changed;
    }

    function showTempMessage(e, t = !1) { document.querySelector(".temp-message")?.remove(); const n = document.createElement("div"); n.textContent = e, Object.assign(n.style, { position: "fixed", bottom: "20px", right: "20px", backgroundColor: t ? "rgba(220, 53, 69, 0.9)" : "rgba(40, 167, 69, 0.9)", color: "white", padding: "12px 20px", borderRadius: "5px", zIndex: "2000", transition: "opacity 0.5s", opacity: "1", boxShadow: "0 4px 10px rgba(0,0,0,0.2)" }), document.body.appendChild(n), setTimeout(() => { n.style.opacity = "0", setTimeout(() => n.remove(), 500) }, 3e3) }
    async function sendImmediateUpdate(e) { try { fetch(IMMEDIATE_UPDATE_URL, { method: "POST", mode: "no-cors", headers: { "Content-Type": "application/x-www-form-urlencoded" }, body: new URLSearchParams({ rows: JSON.stringify([e]) }) }); setTimeout(() => showTempMessage(`Đã cập nhật trạng thái cho đơn: ${e["Mã đơn hàng"]}`), 3e3) } catch (e) { console.error("Lỗi khi cập nhật tức thì:", e), showTempMessage(`Lỗi cập nhật: ${e.message}`, !0) } }

    async function handleData(response) {
      document.getElementById('loader-overlay').style.display = 'none';
      allTabConfigs.forEach(config => { document.getElementById(config.controls.refreshBtn).innerHTML = '<span class="refresh-icon">↻</span> Load' });
      allData = [], staffFilteredData = [], japanData = [], leaderData = [], mentionedData = [], hcmData = [], hanoiData = []; // Reset new data arrays
      changedRows.clear(), japanChangedRows.clear(), allRegionsChangedRows.clear(), leaderChangedRows.clear(), mentionedChangedRows.clear(), hcmChangedRows.clear(), hanoiChangedRows.clear(); // Reset new changedRows maps

      if (response.error || !Array.isArray(response.rows)) {
        const errorMsg = 'Lỗi hoặc không có dữ liệu: ' + (response.error || 'Định dạng dữ liệu không đúng');
        allTabConfigs.forEach(config => showError(errorMsg, config.table.body));
        return;
      }
      
      // THAY ĐỔI 1: Loại bỏ bộ lọc `a["Đơn vị vận chuyển"] == ""` để lấy toàn bộ dữ liệu.
      allData = response.rows.sort((a, b) => (parseDateString(b["Ngày lên đơn"] || b["Thời gian lên đơn"]) || 0) - (parseDateString(a["Ngày lên đơn"] || a["Thời gian lên đơn"]) || 0));
      
      generateDatalistOptions();

      const staffId = getUrlParameter('id');
      const mentionedStaffIds = (getUrlParameter('id1') || '').split(',').filter(id => id.trim() !== '');

      if (!staffId) {
        showError('Thiếu tham số ID nhân viên trong URL', mainTabConfig.table.body);
      } else {
        try {
          currentStaff = await fetchStaffInfo(staffId);
          let staffInfo = `Nhân viên: ${currentStaff.ho_va_ten}`;
          if (currentStaff.vi_tri === "Leader") staffInfo += ` (Leader - Team ${currentStaff.team})`;
          document.getElementById('userInfo').textContent = staffInfo;

          if (currentStaff.vi_tri_van_don === "Lên đơn FFM" && !editableCols.includes("Đơn vị vận chuyển")) {
            editableCols.push("Đơn vị vận chuyển");
          }

          document.getElementById('tabAllRegions').style.display = currentStaff?.vi_tri === "Leader" ? '' : 'none';
          
          if (currentStaff?.vi_tri === "Leader") {
            document.getElementById('tabLeader').style.display = '';
            leaderData = allData.filter(row => (row["NV Vận đơn"] || row["NV_Vận_đơn"]) === currentStaff.ho_va_ten);
            initializeTab(leaderTabConfig, leaderData);
          }

          // THAY ĐỔI 2: Logic hiển thị tab HCM/Hà Nội chỉ dựa vào `vi_tri_van_don`
          if (currentStaff.vi_tri_van_don === "Lên đơn FFM") {
              const staffBranch = currentStaff.chi_nhanh;
              if (staffBranch === "HCM") {
                  document.getElementById('tabHCM').style.display = '';
                  // Giả định dữ liệu đơn hàng có cột 'Team' để lọc
                  hcmData = allData.filter(row => (row.Team || '') === 'HCM'); 
                  initializeTab(hcmTabConfig, hcmData);
              } else if (staffBranch === "Hà Nội") {
                  document.getElementById('tabHanoi').style.display = '';
                  // Giả định dữ liệu đơn hàng có cột 'Team' để lọc
                  hanoiData = allData.filter(row => (row.Team || '') === 'Hà Nội');
                  initializeTab(hanoiTabConfig, hanoiData);
              }
          }


          staffFilteredData = allData.filter(row => {
            const isTeamMemberOrder = teamMembers.includes(row["NV Vận đơn"] || row["NV_Vận_đơn"] || '');
            return currentStaff.vi_tri_van_don === "Lên đơn FFM" ? isTeamMemberOrder || (row["Kết quả Check"] || "") === "OK" : isTeamMemberOrder;
          });
          initializeTab(mainTabConfig, staffFilteredData);
        } catch (error) {
          showError(error.message, mainTabConfig.table.body);
        }
      }

      // *** LOGIC MỚI: XỬ LÝ TAB NGƯỜI ĐƯỢC NHẮC HỘ (id1) ***
      if (mentionedStaffIds.length > 0) {
        document.getElementById('tabMentioned').style.display = ''; // Hiện tab
        try {
          const mentionedStaffNames = await fetchMultipleStaffInfo(mentionedStaffIds);
          if (mentionedStaffNames.length > 0) {
            mentionedData = allData.filter(row => mentionedStaffNames.includes(row["NV Vận đơn"] || row["NV_Vận_đơn"]));
            initializeTab(mentionedTabConfig, mentionedData);
          } else {
            showError('Không tìm thấy nhân viên nào cho các ID được cung cấp trong tham số id1.', 'mentionedTableBody');
          }
        } catch (error) {
          // Lỗi đã được hiển thị bên trong fetchMultipleStaffInfo
        }
      }


      japanData = allData.filter(row => (row['khu vực'] || row['Khu vực']) === 'Nhật Bản');
      initializeTab(allRegionsTabConfig, allData);
      initializeTab(japanTabConfig, japanData);
    }

    function initializeTab(config, data) {
      generateDynamicOptions(config, data);
      populateExternalFilters(config);
      renderHeader(config);
      renderTableBody(config, data);
      applyAllFilters(config);
      setupCellSelection(config.table.body);
    }

    function generateDynamicOptions(config, data) {
      const options = {};
      columnsToMakeDynamic.forEach(colName => {
        if (dropdownCols[colName]) {
          options[colName] = dropdownCols[colName].filter(opt => opt !== "").sort((a, b) => String(a).localeCompare(String(b), 'vi'));
        } else {
          const dataKey = columnDisplayMapping[colName] || colName;
          const valueMapper = row => {
            const val = row[dataKey] || row[dataKey.replace(/ /g, '_')] || (dataKey === 'khu vực' ? row['Khu vực'] || '' : '');
            return typeof val === 'string' ? val.trim() : val;
          };
          const uniqueValues = new Set(data.map(valueMapper).filter(Boolean));
          options[colName] = Array.from(uniqueValues).sort((a, b) => String(a).localeCompare(String(b), 'vi'));
        }
      });
      if (config === mainTabConfig) dynamicFilterOptions = options;
      else if (config === japanTabConfig) japanDynamicFilterOptions = options;
      else if (config === allRegionsTabConfig) allRegionsDynamicFilterOptions = options;
      else if (config === leaderTabConfig) leaderDynamicFilterOptions = options;
      else if (config === mentionedTabConfig) mentionedDynamicFilterOptions = options; // Thêm case cho mentioned
      else if (config === hcmTabConfig) hcmDynamicFilterOptions = options; // NEW
      else if (config === hanoiTabConfig) hanoiDynamicFilterOptions = options; // NEW
    }

    function populateExternalFilters(config) {
      const options = config.dynamicOptions(); const productFilter = document.getElementById(config.controls.product); productFilter.innerHTML = '<option value="">Tất cả sản phẩm</option>'; (options['Mặt hàng'] || []).forEach(opt => productFilter.add(new Option(opt, opt))); if (config.controls.market) { const marketFilter = document.getElementById(config.controls.market); marketFilter.innerHTML = '<option value="">Tất cả khu vực</option>'; (options['khu vực'] || []).forEach(opt => marketFilter.add(new Option(opt, opt))) }
      if (config.controls.staff) { const staffFilter = document.getElementById(config.controls.staff); staffFilter.innerHTML = '<option value="">Tất cả NV Vận đơn</option>'; (options['NV Vận đơn'] || []).forEach(opt => staffFilter.add(new Option(opt, opt))) }
    }
    function generateDatalistOptions() { datalistOptions = {}; datalistFilterCols.forEach(colName => { const dataKey = columnDisplayMapping[colName] || colName; const uniqueValues = new Set(allData.map(row => row[dataKey] || row[dataKey.replace(/ /g, '_')]).filter(Boolean)); datalistOptions[colName] = Array.from(uniqueValues) }) }

    function applyAllFilters(config) {
      const tableHead = document.getElementById(config.table.head);
      const tableBody = document.getElementById(config.table.body);
      if (!tableHead.querySelector('tr') || !tableBody) return;

      const startDateVal = document.getElementById(config.controls.startDate).value;
      const endDateVal = document.getElementById(config.controls.endDate).value;
      const start = startDateVal ? new Date(startDateVal) : null;
      const end = endDateVal ? new Date(endDateVal) : null;
      if (start) start.setHours(0, 0, 0, 0);
      if (end) end.setHours(23, 59, 59, 999);

      const productValue = document.getElementById(config.controls.product).value;
      const marketValue = config.controls.market ? document.getElementById(config.controls.market).value : '';
      const staffValue = config.controls.staff ? document.getElementById(config.controls.staff).value : '';

      const filterValues = {};
      tableHead.querySelectorAll('[data-column]').forEach(filter => {
        const colName = filter.dataset.column;
        if (!filterValues[colName]) filterValues[colName] = {};
        if (filter.dataset.filterType) {
          filterValues[colName][filter.dataset.filterType] = filter.value.toLowerCase();
        } else if (filter.classList.contains('multi-select-container')) {
          const selected = Array.from(filter.querySelectorAll('input:checked:not(.select-all-cb)')).map(cb => cb.value);
          if (selected.length > 0) filterValues[colName].multi = new Set(selected);
        } else if (filter.tagName === 'SELECT') {
          if (filter.value) filterValues[colName].single = filter.value;
        } else if (filter.classList.contains('filter-input')) {
          filterValues[colName].text = filter.value.toLowerCase();
        }
      });

      const originalData = config.data();

      const rows = tableBody.querySelectorAll('tr');
      rows.forEach(tr => {
        const rowIndex = parseInt(tr.dataset.rowIndex, 10);
        if (isNaN(rowIndex)) return;
        const rowData = originalData[rowIndex];
        if (!rowData) return;

        let isVisible = true;

        if (start || end) {
          const orderDate = parseDateString(rowData["Ngày lên đơn"] || rowData["Thời gian lên đơn"]);
          if (!orderDate || (start && orderDate < start) || (end && orderDate > end)) {
            isVisible = false;
          }
        }
        if (isVisible && productValue && (rowData["Mặt hàng"] || '') !== productValue) isVisible = false;
        if (isVisible && marketValue && (rowData["Khu vực"] || rowData["khu vực"] || '') !== marketValue) isVisible = false;
        if (isVisible && staffValue && (rowData["NV Vận đơn"] || rowData["NV_Vận_đơn"] || '') !== staffValue) isVisible = false;

        if (isVisible) {
          for (const colName in filterValues) {
            const dataKey = columnDisplayMapping[colName] || colName;
            let cellValue = rowData[dataKey] ?? (rowData[dataKey.replace(/ /g, '_')] || (dataKey === 'khu vực' ? rowData['Khu vực'] || '' : ''));
            const cellValueLower = String(cellValue).toLowerCase();
            const colFilters = filterValues[colName];

            if (colFilters.text && !cellValueLower.includes(colFilters.text)) { isVisible = false; break; }
            if (colFilters.single && String(cellValue) !== colFilters.single) { isVisible = false; break; }
            if (colFilters.multi) {
              const valueAsString = String(cellValue).trim();
              const isBlank = !valueAsString;
              const isMatch = (colFilters.multi.has('') && isBlank) || colFilters.multi.has(valueAsString);
              if (!isMatch) { isVisible = false; break; }
            }
            if (colFilters.contains && !cellValueLower.includes(colFilters.contains)) { isVisible = false; break; }
            if (colFilters.notcontains && colFilters.notcontains !== '' && cellValueLower.includes(colFilters.notcontains)) { isVisible = false; break; }
          }
        }

        tr.style.display = isVisible ? '' : 'none';
      });

      updateSummaryInfo(config);
    }

    function renderHeader(config) {
      const header = document.getElementById(config.table.head);
      const options = config.dynamicOptions();
      header.innerHTML = '';
      const tr = document.createElement('tr');
      const fixedCount = getFixedColumnCount();
      const debouncedFilter = () => {
        clearTimeout(filterDebounceTimer);
        filterDebounceTimer = setTimeout(() => applyAllFilters(config), 300)
      };
      const immediateFilter = () => applyAllFilters(config);
      displayColumns.forEach((colName, index) => {
        const th = document.createElement('th');
        th.textContent = colName;
        if (index < fixedCount) th.classList.add('fixed-column');
        th.appendChild(document.createElement('br'));
        if (colName === "Mã Tracking") {
          const container = document.createElement('div');
          container.className = 'tracking-filter-container';
          const inputContains = document.createElement('input');
          inputContains.type = 'text'; inputContains.placeholder = 'Chứa ký tự...';
          inputContains.className = 'filter-input'; inputContains.dataset.column = colName;
          inputContains.dataset.filterType = 'contains'; inputContains.addEventListener('input', debouncedFilter);
          const inputNotContains = document.createElement('input');
          inputNotContains.type = 'text'; inputNotContains.placeholder = 'Không chứa...';
          inputNotContains.className = 'filter-input'; inputNotContains.dataset.column = colName;
          inputNotContains.dataset.filterType = 'notcontains'; inputNotContains.addEventListener('input', debouncedFilter);
          container.append(inputContains, inputNotContains);
          th.appendChild(container)
        } else if (singleSelectFilterCols.includes(colName) && options[colName]) {
          const filterElement = document.createElement('select');
          filterElement.className = 'filter-select'; filterElement.dataset.column = colName;
          filterElement.add(new Option(`Tất cả ${colName}`, ''));
          options[colName].forEach(opt => filterElement.add(new Option(opt, opt)));
          filterElement.addEventListener('change', immediateFilter);
          th.appendChild(filterElement)
        } else if (options[colName]) {
          const container = document.createElement('div');
          container.className = 'multi-select-container'; container.dataset.column = colName;
          const button = document.createElement('button');
          button.className = 'multi-select-button'; button.textContent = `Tất cả ${colName}`;
          const dropdown = document.createElement('div');
          dropdown.className = 'checkbox-dropdown';
          const selectAllLabel = document.createElement('label');
          const selectAllCheckbox = document.createElement('input');
          selectAllCheckbox.type = 'checkbox'; selectAllCheckbox.className = 'select-all-cb';
          selectAllLabel.style.fontWeight = 'bold'; selectAllLabel.style.borderBottom = '1px solid #ccc';
          selectAllLabel.style.marginBottom = '4px';
          selectAllLabel.append(selectAllCheckbox, ' (Tất cả)');
          dropdown.appendChild(selectAllLabel);
          const createCheckbox = (value, text) => {
            const label = document.createElement('label'); const checkbox = document.createElement('input');
            checkbox.type = 'checkbox'; checkbox.value = value;
            checkbox.addEventListener('change', () => {
              const allOptionCheckboxes = Array.from(dropdown.querySelectorAll('input[type="checkbox"]:not(.select-all-cb)'));
              selectAllCheckbox.checked = allOptionCheckboxes.every(cb => cb.checked);
              const selectedCount = dropdown.querySelectorAll('input:checked:not(.select-all-cb)').length;
              button.textContent = selectedCount === 0 ? `Tất cả ${colName}` : `${selectedCount} lựa chọn`;
              immediateFilter();
            });
            label.append(checkbox, ` ${text}`); return label;
          };
          dropdown.appendChild(createCheckbox('', '(Trống)'));
          options[colName].forEach(opt => dropdown.appendChild(createCheckbox(opt, opt)));
          selectAllCheckbox.addEventListener('change', (e) => {
            dropdown.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = e.target.checked);
            const selectedCount = e.target.checked ? dropdown.querySelectorAll('input:checked:not(.select-all-cb)').length : 0;
            button.textContent = selectedCount === 0 ? `Tất cả ${colName}` : `${selectedCount} lựa chọn`;
            immediateFilter();
          });
          button.addEventListener('click', e => { e.stopPropagation(); document.querySelectorAll('.checkbox-dropdown.show').forEach(d => { if (d !== dropdown) d.classList.remove('show') }); dropdown.classList.toggle('show') });
          container.append(button, dropdown);
          th.appendChild(container)
        } else if (datalistFilterCols.includes(colName)) {
          const input = document.createElement('input');
          input.type = 'text'; input.className = 'filter-input'; input.placeholder = `Lọc ${colName}...`;
          input.dataset.column = colName;
          const datalistId = `datalist-${colName.replace(/[^a-zA-Z0-9]/g, '-')}`;
          input.setAttribute('list', datalistId);
          const datalist = document.createElement('datalist'); datalist.id = datalistId;
          if (datalistOptions[colName]) { datalistOptions[colName].forEach(opt => { const option = document.createElement('option'); option.value = opt; datalist.appendChild(option) }) }
          input.addEventListener('input', debouncedFilter);
          th.append(input, datalist)
        } else {
          const filterElement = document.createElement('input');
          filterElement.type = 'text'; filterElement.className = 'filter-input';
          filterElement.placeholder = `Lọc ${colName}...`; filterElement.dataset.column = colName;
          filterElement.addEventListener('input', debouncedFilter);
          th.appendChild(filterElement)
        }
        tr.appendChild(th)
      });
      header.appendChild(tr);
      window.addEventListener('click', e => { if (!e.target.closest('.multi-select-container')) { document.querySelectorAll('.checkbox-dropdown.show').forEach(d => d.classList.remove('show')) } })
    }

    function renderTableBody(config, data) {
      const container = document.getElementById(config.table.body);
      container.innerHTML = '';
      if (data.length === 0) {
        showError(`Không có đơn hàng nào.`, config.table.body);
        return;
      }
      const fixedCount = getFixedColumnCount();
      data.forEach((row, originalRowIndex) => {
        const tr = document.createElement('tr');
        tr.dataset.rowIndex = originalRowIndex;
        displayColumns.forEach((col, index) => {
          const td = document.createElement('td');
          if (index < fixedCount) td.classList.add('fixed-column');
          const dataKey = columnDisplayMapping[col] || col;
          let value;
          if (allDateColumns.includes(dataKey)) {
            let dateSource = row[dataKey] || '';
            if (dataKey === "Ngày lên đơn") dateSource = row["Ngày lên đơn"] || row["Thời gian lên đơn"];
            const formattedDate = formatDate(dateSource);
            value = formattedDate.display;
            td.dataset.originalValue = formattedDate.original;
          } else if (dataKey === "Ngày Kế toán đối soát với FFM lần 2") {
            const dateVal = row[dataKey];
            if (dateVal) {
              const dateObj = new Date(dateVal);
              // Check if the date is valid before formatting
              if (!isNaN(dateObj.getTime())) {
                value = getDateTimeVN(dateObj);
              } else {
                value = ''; // If date is invalid, show empty string instead of NaN
              }
            } else {
              value = '';
            }
          } else {
            value = row[dataKey] ?? (row[dataKey.replace(/ /g, '_')] || (dataKey === 'khu vực' ? (row['Khu vực'] || '') : ''));
          }

          if (editableCols.includes(col)) {
            td.classList.add('editable');
            if (dropdownCols[col]) {
              td.classList.add('has-dropdown');
              const select = document.createElement('select');
              const validOptions = dropdownCols[col];
              validOptions.forEach(opt => select.add(new Option(opt, opt)));

              if (validOptions.includes(value)) {
                select.value = value;
              } else {
                select.value = "";
              }

              select.addEventListener('change', (e) => {
                td.classList.add('highlight');
                const newValue = select.value;
                const currentChanges = config.changedRows.get(originalRowIndex) || {};
                currentChanges[col] = newValue;
                config.changedRows.set(originalRowIndex, currentChanges);
                if (col === "Trạng thái giao hàng NB" || col === "Trạng thái thu tiền") {
                  const currentRow = e.target.closest('tr'); if (!currentRow) return;
                  const deliveryStatusCell = currentRow.cells[displayColumns.indexOf("Trạng thái giao hàng NB")];
                  const paymentStatusCell = currentRow.cells[displayColumns.indexOf("Trạng thái thu tiền")];
                  sendImmediateUpdate({ "Mã đơn hàng": row["Mã đơn hàng"] || row["Mã_đơn_hàng"], "Trạng thái giao hàng NB": deliveryStatusCell ? getDOMCellValue(deliveryStatusCell) : '', "Trạng thái thu tiền": paymentStatusCell ? getDOMCellValue(paymentStatusCell) : '' });
                }
              });
              td.appendChild(select);
            } else {
              td.textContent = value;
            }
          } else {
            td.textContent = value;
          }
          if (col === "Kết quả Check") {
            if (value === 'OK') td.classList.add('cell-ok');
            else if (value === 'Vận đơn XL') td.classList.add('cell-xl');
            else if (value === 'Huỷ') td.classList.add('cell-cancel');
          }
          tr.appendChild(td);
        });
        container.appendChild(tr);
      });
      updateStickyColumns(config);
    }

    function setupControls() {
      setupTabs();
      allTabConfigs.forEach(setupTabControls);
      document.getElementById('fixedColumnCountInput').addEventListener('input', handleFixedColumnCountChange);
      document.addEventListener('keydown', e => {
        const activeEl = document.activeElement;
        if (activeEl && ['INPUT', 'SELECT', 'TEXTAREA'].includes(activeEl.tagName) && !activeEl.closest('td')) return;
        if (document.querySelector('td.editing')) return;
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'c' && selectedCells.size > 0) { e.preventDefault(); copySelectedCells() }
        else if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'v' && selectedCells.size > 0) { e.preventDefault(); navigator.clipboard.readText().then(text => pasteToSelectedCells(text)).catch(err => console.error('Lỗi đọc clipboard:', err)) }
        else if ((e.key === 'Delete' || e.key === 'Backspace') && selectedCells.size > 0) { e.preventDefault(); clearSelectedCells() }
      });
      window.addEventListener('resize', () => {
        const activeTab = document.querySelector('.content-tab.active'); if (!activeTab) return;
        const activeConfig = allTabConfigs.find(c => c.table.body === activeTab.querySelector('tbody')?.id);
        if (activeConfig) updateStickyColumns(activeConfig)
      });
    }

    function setupTabControls(config) {
      document.getElementById(config.controls.refreshBtn).addEventListener('click', refreshData);
      document.getElementById(config.controls.updateBtn).addEventListener('click', () => updateAllChangedRows(config));
      const filterFunction = () => applyAllFilters(config);
      document.getElementById(config.controls.startDate).addEventListener('change', filterFunction);
      document.getElementById(config.controls.endDate).addEventListener('change', filterFunction);
      document.getElementById(config.controls.product).addEventListener('change', filterFunction);
      if (config.controls.market) document.getElementById(config.controls.market).addEventListener('change', filterFunction);
      if (config.controls.staff) document.getElementById(config.controls.staff).addEventListener('change', filterFunction);
      document.getElementById(config.controls.clearBtn).addEventListener('click', () => {
        document.getElementById(config.controls.startDate).value = ''; document.getElementById(config.controls.endDate).value = '';
        document.getElementById(config.controls.product).selectedIndex = 0;
        if (config.controls.market) document.getElementById(config.controls.market).selectedIndex = 0;
        if (config.controls.staff) document.getElementById(config.controls.staff).selectedIndex = 0;
        const header = document.getElementById(config.table.head);
        header.querySelectorAll('.filter-input').forEach(f => f.value = '');
        header.querySelectorAll('.filter-select').forEach(f => f.selectedIndex = 0);
        header.querySelectorAll('.multi-select-container').forEach(container => {
          container.querySelectorAll('input:checked').forEach(cb => cb.checked = !1);
          container.querySelector('.multi-select-button').textContent = `Tất cả ${container.dataset.column}`
        });
        applyAllFilters(config)
      })
    }

    function setupTabs() {
      const tabs = document.querySelectorAll('.tab-btn'), contents = document.querySelectorAll('.content-tab');
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          selectedCells.forEach(cell => cell.classList.remove('cell-selected')); selectedCells.clear();
          isMouseDown = !1; startCell = null; tabs.forEach(item => item.classList.remove('active'));
          contents.forEach(content => content.classList.remove('active'));
          tab.classList.add('active');
          const contentId = 'content' + tab.id.substring(3);
          document.getElementById(contentId).classList.add('active');
          setTimeout(() => {
            handleFixedColumnCountChange();
            const summaryEl = document.getElementById('selectionSummary');
            // This part already effectively clears selection summary for non-main tabs
            if (summaryEl) summaryEl.innerHTML = contentId === 'contentData' ? '' : '';
          }, 10)
        })
      })
    }
    function refreshData() { loadData() }
    function updateAllChangedRows(config) {
      if (config.changedRows.size === 0) { alert('Không có thay đổi nào để cập nhật'); return }
      const updateBtn = document.getElementById(config.controls.updateBtn); const statusEl = document.createElement('span'); statusEl.className = 'status'; statusEl.textContent = 'Đang xử lý...'; updateBtn.appendChild(statusEl); updateBtn.disabled = !0; const rowsToSend = []; config.changedRows.forEach((changes, rowIndex) => {
        const originalData = config.data()[rowIndex]; if (!originalData) { console.warn(`Không tìm thấy dữ liệu gốc cho rowIndex: ${rowIndex}. Bỏ qua.`); return }
        const updatedRowData = { ...originalData }; for (const displayName in changes) { const newValue = changes[displayName], dataKey = columnDisplayMapping[displayName] || displayName; updatedRowData[dataKey] = newValue }
        delete updatedRowData["Thời gian lên đơn"]; rowsToSend.push(updatedRowData)
      }); if (rowsToSend.length === 0) { statusEl.textContent = 'Không có dòng nào hợp lệ.'; setTimeout(() => { if (statusEl.parentElement) updateBtn.removeChild(statusEl); updateBtn.disabled = !1 }, 3000); return }
      fetch(POST_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: new URLSearchParams({ rows: JSON.stringify(rowsToSend) }) }).then(() => { statusEl.textContent = `Đã gửi ${rowsToSend.length} thay đổi.`; setTimeout(() => { alert(`Yêu cầu cập nhật ${rowsToSend.length} dòng đã được gửi. Vui lòng nhấn "Load" để xem kết quả.`); config.changedRows.clear(); document.querySelectorAll(`#${config.table.body} .highlight`).forEach(cell => cell.classList.remove('highlight')); if (statusEl.parentElement) updateBtn.removeChild(statusEl); updateBtn.disabled = !1 }, 1500) }).catch(e => { statusEl.textContent = 'Lỗi mạng: ' + e.message; statusEl.classList.add('error-status'); setTimeout(() => { if (statusEl.parentElement) updateBtn.removeChild(statusEl); updateBtn.disabled = !1 }, 4000) })
    }

    function loadData() {
      document.getElementById('loader-overlay').style.display = 'flex';
      allTabConfigs.forEach(config => showError('Đang tải dữ liệu...', config.table.body));
      const script = document.createElement('script'); script.src = `${POST_URL}?callback=handleData&rand=${Math.random()}`;
      document.querySelector('script[src^="https://script.google.com"]')?.remove();
      document.body.appendChild(script)
    }

    document.addEventListener('DOMContentLoaded', () => { setupControls(); loadData() });
  </script>
</body>

</html>

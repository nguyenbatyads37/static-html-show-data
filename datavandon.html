<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>DANH SÁCH ĐƠN HÀNG</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      background-color: #f5f5f5;
      color: #333;
      margin: 0;
    }
    h2 { text-align: center; margin-bottom: 20px; color: #2c3e50; }
    .controls {
      display: flex; justify-content: space-between; margin-bottom: 15px; align-items: center;
      background: #fff; padding: 10px 15px; border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; flex-wrap: wrap;
      gap: 15px;
    }
    .controls .left-controls, .controls .right-controls { display: flex; align-items: center; gap: 10px; flex-wrap: wrap;}
    .date-filter { display: flex; align-items: center; gap: 5px; }
    .date-filter input[type="date"], .controls .filter-input {
      padding: 5px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px;
    }
    .table-wrapper {
      position: relative; overflow: auto; max-height: 75vh;
      background: white; border-radius: 0 0 5px 5px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .main-table-wrapper {
      overflow-x: auto;
      overflow-y: auto;
      max-height: 60vh;
    }
    table {
      border-collapse: collapse; width: 100%; min-width: 2000px; font-size: 14px;
    }
    thead { position: sticky; top: 0; z-index: 10; }
    th, td {
      border: 1px solid #e0e0e0; padding: 8px 12px; text-align: left;
      white-space: nowrap; background-color: white;
    }
    th {
      background-color: #3498db; color: white; font-weight: 500;
      vertical-align: top; position: sticky; top: 0; z-index: 20;
    }
    th .filter-input, th .filter-select {
      width: 100%; margin-top: 5px; padding: 4px;
      font-size: 12px; border: 1px solid #ccc; border-radius: 3px;
    }
    td.editable { background-color: #fffbe8; }
    td select, td input.date-input {
      width: 100%; padding: 6px; border: none;
      background: transparent; font-family: inherit; font-size: inherit;
    }
    button {
      padding: 6px 12px; cursor: pointer; background-color: #3498db; color: white;
      border: none; border-radius: 4px; font-size: 13px;
      transition: background-color 0.3s;
    }
    button:hover { background-color: #2980b9; }
    .status { font-size: 0.85em; margin-left: 8px; color: #27ae60; }
    .error-status { color: #e74c3c; }
    .highlight { background-color: #ffeb3b !important; }
    .no-data {
      text-align: center; padding: 20px;
      color: #7f8c8d; font-style: italic;
    }
    .refresh-btn { background-color: #2ecc71; }
    .refresh-btn:hover { background-color: #27ae60; }
    .clear-filter-btn { background-color: #f39c12; }
    .clear-filter-btn:hover { background-color: #e67e22; }
    .refresh-icon { margin-right: 5px; }
    .fixed-column { position: sticky; left: 0; z-index: 5; }
    th.fixed-column { z-index: 30; background-color: #3498db; }
    td.fixed-column { background-color: #f9f9f9; }
    #userInfo { font-weight: bold; margin-right: 15px; }
    .summary-info {
      background: #e3f2fd; padding: 8px 15px; border-radius: 4px;
      margin-left: 10px; font-weight: bold;
    }
    .cell-selected {
      background-color: #e3f2fd !important;
      outline: 2px solid #3498db;
    }
    .summary-table {
      width: 100%;
      margin-bottom: 20px;
      background: white;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .summary-table th {
      background-color: #2c3e50;
      position: sticky;
      top: 0;
    }
    .summary-table td {
      text-align: center;
    }
    .positive {
      color: #27ae60;
      font-weight: bold;
    }
    .negative {
      color: #e74c3c;
      font-weight: bold;
    }
    .summary-staff-header td {
        background-color: #ecf0f1 !important;
        font-weight: bold;
        text-align: left !important;
        color: #2c3e50;
    }
    .summary-staff-total td {
        background-color: #bdc3c7 !important;
        font-weight: bold;
    }
    .summary-grand-total td {
        background-color: #34495e !important;
        font-weight: bold;
        color: white;
    }
    /* Always show horizontal scrollbar */
    ::-webkit-scrollbar {
      -webkit-appearance: none;
      height: 10px;
      width: 10px;
    }
    ::-webkit-scrollbar-thumb {
      border-radius: 5px;
      background-color: rgba(0,0,0,.2);
    }
  </style>
</head>
<body>
  <h2>QUẢN LÝ VẬN ĐƠN</h2>
  <div class="controls">
    <div class="left-controls">
      <span id="userInfo"></span>
      <button id="refreshData" class="refresh-btn">
        <span class="refresh-icon">↻</span> Load dữ liệu
      </button>
      <button id="updateAll">Cập nhật tất cả</button>
      <div id="summaryInfo" class="summary-info"></div>
    </div>
    <div class="right-controls">
      <div class="date-filter">
        <span>Lọc từ ngày:</span>
        <input type="date" id="startDateFilter" />
        <span>Đến ngày:</span>
        <input type="date" id="endDateFilter" />
      </div>
      <input type="text" id="productFilter" placeholder="Lọc theo sản phẩm..." class="filter-input" />
      <input type="text" id="marketFilter" placeholder="Lọc theo thị trường (City)..." class="filter-input" />
      <button id="clearFilters" class="clear-filter-btn">Xóa bộ lọc</button>
    </div>
  </div>

  <!-- Summary Table -->
  <div class="table-wrapper">
    <table class="summary-table">
      <thead>
        <tr>
          <th rowspan="2">NV Vận đơn</th>
          <th rowspan="2">Đơn vị vận chuyển</th>
          <th colspan="2">Đã Thanh Toán (có bill)</th>
          <th rowspan="2">Bill 1 phần</th>
          <th rowspan="2">Tổng đơn lên nội bộ</th>
          <th rowspan="2">Tổng đơn đủ đkien đẩy vh</th>
          <th rowspan="2">Tổng đơn lên vận hành</th>
          <th rowspan="2">Tỷ lệ đơn lên vận hành</th>
          <th rowspan="2">Giao Thành Công</th>
          <th rowspan="2">Đang Giao</th>
          <th rowspan="2">Chưa Giao</th>
          <th rowspan="2">Hoàn</th>
          <th rowspan="2">chờ check</th>
          <th rowspan="2">Trống trạng thái</th>
          <th rowspan="2">Tỷ lệ thu tiền/giao thành công</th>
          <th rowspan="2">Tỷ lệ đơn tính phí vc</th>
        </tr>
        <tr>
          <th>Số đơn</th>
          <th>Thành Tiền</th>
        </tr>
      </thead>
      <tbody id="summaryTableBody">
        <!-- Summary data will be inserted here -->
      </tbody>
    </table>
  </div>

  <!-- Main Data Table -->
  <div class="main-table-wrapper" id="tableContainer">
    <table>
      <thead id="tableHead"></thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <script>
    const POST_URL = 'https://script.google.com/macros/s/AKfycbzNeQSd_fUNicLT8VyVg90Di9NpAZxCagmBLFboJZ5I64qjqHBHM7uOZalO11mJdAxN/exec';

    const editableCols = [
        "Kết quả Check", "Trạng thái giao hàng NB", "Lý do", "Trạng thái thu tiền",
        "Ngày hẹn đẩy đơn"
    ];

    const dropdownCols = {
        "Kết quả Check": ["", "OK", "Huỷ", "Treo", "Vận đơn XL", "Đợi hàng", "Khách hẹn"],
        "Trạng thái giao hàng NB": ["", "Giao Thành Công", "Đang Giao", "Chưa Giao", "Hủy", "Hoàn", "chờ check", "Giao không thành công", "Bom_Thất Lạc"],
        "Trạng thái thu tiền": ["", "Có bill", "Có bill 1 phần", "Bom_bùng_chặn", "Hẹn Thanh Toán", "Hoàn Hàng", "Khó Đòi", "Không nhận được hàng", "Không PH dưới 3N", "Thanh toán phí hoàn", "KPH nhiều ngày"]
    };

    const displayColumns = [
      "Mã đơn hàng", ...editableCols, "Ngày lên đơn", "Name*", "Phone*", "Add", "City",
      "State", "Zipcode", "Mặt hàng", "Tên mặt hàng 1", "Số lượng mặt hàng 1", "Tên mặt hàng 2",
      "Số lượng mặt hàng 2", "Quà tặng", "Số lượng quà kèm", "Giá bán", "Loại tiền thanh toán",
      "Tổng tiền VNĐ", "Hình thức thanh toán", "Ghi chú", "Mã Tracking", "Ngày đóng hàng",
      "Trạng thái giao hàng", "Thời gian giao dự kiến", "Phí ship nội địa Mỹ (usd)",
      "Phí xử lý đơn đóng hàng-Lưu kho(usd)", "GHI CHÚ", "Nhân viên Sale", "NV Vận đơn", "Đơn vị vận chuyển"
    ];
    
    const allDateColumns = ["Ngày lên đơn", "Ngày đóng hàng", "Ngày hẹn đẩy đơn"];

    let allData = [];
    let staffFilteredData = [];
    let changedRows = new Set();
    let currentStaff = null;
    let teamMembers = [];
    let selectedCells = new Set();
    let isMouseDown = false;
    let startCell = null;
    
    function getUrlParameter(name) {
      name = name.replace(/[\[\]]/g, '\\$&');
      const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
      const results = regex.exec(window.location.href);
      if (!results) return null;
      if (!results[2]) return '';
      return decodeURIComponent(results[2].replace(/\+/g, ' '));
    }

    async function fetchStaffInfo(idns) {
      try {
        const staffApiUrl = 'https://script.google.com/macros/s/AKfycbzwOv7UFwrqzf88QJL1QrxLKcnnnSIQ_PSmF0SO8LboqWI5li3vF3W8_-8s-A8lNGaR/exec';
        const response = await fetch(staffApiUrl, { cache: "no-store" });
        if (!response.ok) throw new Error('Lỗi mạng khi tải data nhân viên');
        const data = await response.json();
        const staffMember = data.find(staff => String(staff.idnv) === idns);
        if (!staffMember) throw new Error(`Không tìm thấy nhân viên với ID: ${idns}`);
        if (staffMember.vi_tri === "Leader") {
          const teamName = staffMember.team;
          teamMembers = data.filter(member => member.team === teamName).map(member => member.ho_va_ten);
        }
        return staffMember;
      } catch (error) {
        showError(error.message);
        throw error;
      }
    }
    
    function showError(message, containerId = 'tableBody') {
      const container = document.getElementById(containerId);
      const colCount = containerId === 'tableBody' ? (displayColumns.length > 0 ? displayColumns.length : 10) : 17;
      container.innerHTML = `<tr><td colspan="${colCount}" class="no-data">${message}</td></tr>`;
    }

    function formatDate(dateString) {
      if (!dateString || typeof dateString !== 'string') {
        return { display: '', original: '' };
      }
      
      const originalValue = dateString;
      let displayValue = dateString;
      
      if (dateString.endsWith('Z')) {
        try {
          const dateObj = new Date(dateString);
          if (!isNaN(dateObj.getTime())) {
            const day = String(dateObj.getDate()).padStart(2, '0');
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const year = dateObj.getFullYear();
            displayValue = `${day}/${month}/${year}`;
          }
        } catch (e) {}
      } else if (/^(\d{4})-(\d{2})-(\d{2})/.test(dateString)) {
        const [, year, month, day] = dateString.match(/^(\d{4})-(\d{2})-(\d{2})/);
        displayValue = `${day}/${month}/${year}`;
      }
      
      return { display: displayValue, original: originalValue };
    }

    function updateSummaryInfo(filteredData) {
      const totalOrders = filteredData.length;
      const totalAmount = filteredData.reduce((sum, row) => {
        let amountValue = row["Tổng tiền VNĐ"] || row["Tổng_tiền_VNĐ"] || 0;
        
        if (typeof amountValue !== 'string') {
          amountValue = amountValue.toString();
        }
        
        const numericValue = amountValue.replace(/[^\d.-]/g, '');
        return sum + (parseFloat(numericValue) || 0);
      }, 0);
      
      const formattedAmount = new Intl.NumberFormat('vi-VN', { 
        style: 'currency', 
        currency: 'VND' 
      }).format(totalAmount);
      
      document.getElementById('summaryInfo').innerHTML = `
        Tổng đơn: <span style="color: #e74c3c;">${totalOrders}</span> | 
        Tổng tiền: <span style="color: #27ae60;">${formattedAmount}</span>
      `;
      
      updateDetailedSummaryTable(filteredData);
    }
    
    function createEmptyStats() {
        return {
            "Đã Thanh Toán (có bill)": { count: 0, amount: 0 },
            "Bill 1 phần": { count: 0, amount: 0 },
            "Tổng đơn lên nội bộ": { count: 0, amount: 0 },
            "Tổng đơn đủ đkien đẩy vh": { count: 0, amount: 0 },
            "Tổng đơn lên vận hành": { count: 0, amount: 0 },
            "Giao Thành Công": { count: 0, amount: 0 },
            "Đang Giao": { count: 0, amount: 0 },
            "Chưa Giao": { count: 0, amount: 0 },
            "Hoàn": { count: 0, amount: 0 },
            "chờ check": { count: 0, amount: 0 },
            "Trống trạng thái": { count: 0, amount: 0 }
        };
    }

    function updateDetailedSummaryTable(filteredData) {
        const summaryTableBody = document.getElementById('summaryTableBody');
        summaryTableBody.innerHTML = '';

        if (filteredData.length === 0) {
            showError('Không có dữ liệu thống kê.', 'summaryTableBody');
            return;
        }

        const staffStats = {};
        const grandTotal = createEmptyStats();

        filteredData.forEach(row => {
            const staffName = row["NV Vận đơn"] || row["NV_Vận_đơn"] || "Chưa có NV";
            const shippingCompany = row["Đơn vị vận chuyển"] || row["Đơn_vị_vận_chuyển"] || "Không xác định";
            
            if (!staffStats[staffName]) {
                staffStats[staffName] = { _total: createEmptyStats() };
            }
            if (!staffStats[staffName][shippingCompany]) {
                staffStats[staffName][shippingCompany] = createEmptyStats();
            }

            const statsToUpdate = [
                staffStats[staffName][shippingCompany],
                staffStats[staffName]._total,
                grandTotal
            ];
            
            const amountValue = row["Tổng tiền VNĐ"] || row["Tổng_tiền_VNĐ"] || 0;
            const numericAmount = parseFloat(String(amountValue).replace(/[^\d.-]/g, '')) || 0;
            const paymentStatus = row["Trạng thái thu tiền"] || "";
            const deliveryStatus = row["Trạng thái giao hàng NB"] || "";

            statsToUpdate.forEach(stats => {
                if (paymentStatus.includes("Có bill")) {
                    stats["Đã Thanh Toán (có bill)"].count++;
                    stats["Đã Thanh Toán (có bill)"].amount += numericAmount;
                } else if (paymentStatus.includes("Có bill 1 phần")) {
                    stats["Bill 1 phần"].count++;
                }
                
                if (deliveryStatus.includes("Giao Thành Công")) stats["Giao Thành Công"].count++;
                else if (deliveryStatus.includes("Đang Giao")) stats["Đang Giao"].count++;
                else if (deliveryStatus.includes("Chưa Giao")) stats["Chưa Giao"].count++;
                else if (deliveryStatus.includes("Hoàn")) stats["Hoàn"].count++;
                else if (deliveryStatus.includes("chờ check")) stats["chờ check"].count++;
                else if (deliveryStatus === "") stats["Trống trạng thái"].count++;
                
                stats["Tổng đơn lên nội bộ"].count++;

                if (paymentStatus.includes("Có bill") || paymentStatus.includes("Có bill 1 phần")) {
                    stats["Tổng đơn đủ đkien đẩy vh"].count++;
                }
                if (deliveryStatus && !deliveryStatus.includes("Chưa Giao") && !deliveryStatus.includes("chờ check")) {
                    stats["Tổng đơn lên vận hành"].count++;
                }
            });
        });

        // Render rows for each staff
        Object.keys(staffStats).sort().forEach(staffName => {
            const staffData = staffStats[staffName];
            
            // Staff Header Row
            const headerRow = summaryTableBody.insertRow();
            headerRow.className = 'summary-staff-header';
            const headerCell = headerRow.insertCell();
            headerCell.colSpan = 17;
            headerCell.textContent = `Nhân viên: ${staffName}`;

            // Render details for each shipping company under this staff
            Object.keys(staffData).filter(key => key !== '_total').sort().forEach(companyName => {
                const companyData = staffData[companyName];
                const tr = renderSummaryRow(staffName, companyName, companyData);
                summaryTableBody.appendChild(tr);
            });
            
            // Staff Total Row
            const totalRow = renderSummaryRow("Tổng cộng", "Tất cả DVVC", staffData._total);
            totalRow.className = 'summary-staff-total';
            summaryTableBody.appendChild(totalRow);
        });
        
        // Grand Total Row
        const grandTotalRow = renderSummaryRow("TỔNG TOÀN BỘ", "Tất cả NV & DVVC", grandTotal);
        grandTotalRow.className = 'summary-grand-total';
        summaryTableBody.appendChild(grandTotalRow);
    }
    
    function renderSummaryRow(staffName, companyName, data) {
        const tr = document.createElement('tr');

        tr.insertCell().textContent = staffName;
        tr.insertCell().textContent = companyName;
        
        tr.insertCell().textContent = data["Đã Thanh Toán (có bill)"].count;
        const paidAmountCell = tr.insertCell();
        paidAmountCell.textContent = new Intl.NumberFormat('vi-VN').format(data["Đã Thanh Toán (có bill)"].amount) + ' ₫';
        
        tr.insertCell().textContent = data["Bill 1 phần"].count;
        tr.insertCell().textContent = data["Tổng đơn lên nội bộ"].count;
        tr.insertCell().textContent = data["Tổng đơn đủ đkien đẩy vh"].count;
        tr.insertCell().textContent = data["Tổng đơn lên vận hành"].count;

        const shippingRate = data["Tổng đơn lên nội bộ"].count > 0 ? (data["Tổng đơn lên vận hành"].count / data["Tổng đơn lên nội bộ"].count * 100) : 0;
        const shippingRateCell = tr.insertCell();
        shippingRateCell.textContent = shippingRate.toFixed(2) + '%';
        shippingRateCell.className = shippingRate > 70 ? 'positive' : 'negative';

        tr.insertCell().textContent = data["Giao Thành Công"].count;
        tr.insertCell().textContent = data["Đang Giao"].count;
        tr.insertCell().textContent = data["Chưa Giao"].count;
        tr.insertCell().textContent = data["Hoàn"].count;
        tr.insertCell().textContent = data["chờ check"].count;
        tr.insertCell().textContent = data["Trống trạng thái"].count;

        const paymentSuccessRate = data["Giao Thành Công"].count > 0 ? (data["Đã Thanh Toán (có bill)"].count / data["Giao Thành Công"].count * 100) : 0;
        const paymentRateCell = tr.insertCell();
        paymentRateCell.textContent = paymentSuccessRate.toFixed(2) + '%';
        paymentRateCell.className = paymentSuccessRate > 80 ? 'positive' : 'negative';

        const feeRate = data["Tổng đơn lên vận hành"].count > 0 ? (data["Giao Thành Công"].count / data["Tổng đơn lên vận hành"].count * 100) : 0;
        const feeRateCell = tr.insertCell();
        feeRateCell.textContent = feeRate.toFixed(2) + '%';
        feeRateCell.className = feeRate > 80 ? 'positive' : 'negative';
        
        return tr;
    }

    function handleCellSelection(cell, addToSelection = true) {
      if (addToSelection) {
        cell.classList.add('cell-selected');
        selectedCells.add(cell);
      } else {
        cell.classList.remove('cell-selected');
        selectedCells.delete(cell);
      }
    }

    function handleCellRangeSelection(startCell, endCell) {
      const startRow = startCell.parentNode.rowIndex;
      const startCol = startCell.cellIndex;
      const endRow = endCell.parentNode.rowIndex;
      const endCol = endCell.cellIndex;

      const minRow = Math.min(startRow, endRow);
      const maxRow = Math.max(startRow, endRow);
      const minCol = Math.min(startCol, endCol);
      const maxCol = Math.max(startCol, endCol);

      const table = document.getElementById('tableBody');
      const rows = table.rows;

      // Clear all selections first
      selectedCells.forEach(cell => cell.classList.remove('cell-selected'));
      selectedCells.clear();

      // Select cells in the range
      for (let i = minRow; i <= maxRow; i++) {
        for (let j = minCol; j <= maxCol; j++) {
          const cell = rows[i].cells[j];
          cell.classList.add('cell-selected');
          selectedCells.add(cell);
        }
      }
    }

    function setupCellSelection() {
      const tableBody = document.getElementById('tableBody');

      tableBody.addEventListener('mousedown', (e) => {
        if (e.target.tagName === 'TD') {
          isMouseDown = true;
          startCell = e.target;
          
          // Clear previous selections if not holding Ctrl
          if (!e.ctrlKey && !e.metaKey) {
            selectedCells.forEach(cell => cell.classList.remove('cell-selected'));
            selectedCells.clear();
          }
          
          handleCellSelection(e.target, !e.target.classList.contains('cell-selected'));
          e.preventDefault(); // Prevent text selection
        }
      });

      tableBody.addEventListener('mouseover', (e) => {
        if (isMouseDown && e.target.tagName === 'TD' && startCell !== e.target) {
          handleCellRangeSelection(startCell, e.target);
        }
      });

      document.addEventListener('mouseup', () => {
        isMouseDown = false;
        startCell = null;
      });

      // Handle Ctrl+C for copying selected cells
      document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'c' && selectedCells.size > 0) {
          e.preventDefault();
          copySelectedCells();
        }
      });
    }

    function copySelectedCells() {
      if (selectedCells.size === 0) return;

      // Find the bounding rectangle of the selection
      let minRow = Infinity, maxRow = -Infinity;
      let minCol = Infinity, maxCol = -Infinity;

      selectedCells.forEach(cell => {
        const row = cell.parentNode.rowIndex;
        const col = cell.cellIndex;
        
        minRow = Math.min(minRow, row);
        maxRow = Math.max(maxRow, row);
        minCol = Math.min(minCol, col);
        maxCol = Math.max(maxCol, col);
      });

      // Create a grid to hold the data
      const rows = maxRow - minRow + 1;
      const cols = maxCol - minCol + 1;
      const grid = Array(rows).fill().map(() => Array(cols).fill(''));

      // Populate the grid with cell values
      selectedCells.forEach(cell => {
        const row = cell.parentNode.rowIndex - minRow;
        const col = cell.cellIndex - minCol;
        
        if (row >= 0 && row < rows && col >= 0 && col < cols) {
          grid[row][col] = cell.textContent.trim();
        }
      });

      // Convert grid to tab-separated values
      const tsv = grid.map(row => row.join('\t')).join('\n');
      
      // Copy to clipboard
      navigator.clipboard.writeText(tsv)
        .then(() => {
          const tempMsg = document.createElement('div');
          tempMsg.textContent = `Đã sao chép ${selectedCells.size} ô vào clipboard`;
          tempMsg.style.position = 'fixed';
          tempMsg.style.bottom = '20px';
          tempMsg.style.right = '20px';
          tempMsg.style.backgroundColor = '#2ecc71';
          tempMsg.style.color = 'white';
          tempMsg.style.padding = '10px';
          tempMsg.style.borderRadius = '4px';
          tempMsg.style.zIndex = '1000';
          document.body.appendChild(tempMsg);
          setTimeout(() => tempMsg.remove(), 2000);
        })
        .catch(err => {
          console.error('Failed to copy:', err);
        });
    }

    async function handleData(response) {
      document.getElementById('refreshData').innerHTML = '<span class="refresh-icon">↻</span> Load dữ liệu';
      allData = []; staffFilteredData = []; changedRows = new Set();

      if (response.error || !Array.isArray(response.rows)) {
        showError('Lỗi hoặc không có dữ liệu: ' + (response.error || 'Định dạng dữ liệu không đúng'));
        return;
      }
      allData = response.rows;

      const staffId = getUrlParameter('id');
      if (!staffId) {
        showError('Thiếu tham số ID nhân viên trong URL');
        return;
      }

      try {
        currentStaff = await fetchStaffInfo(staffId);
        let staffInfo = `Nhân viên: ${currentStaff.ho_va_ten}`;
        staffInfo += (currentStaff.vi_tri === "Leader") ? ` (Leader - Team ${currentStaff.team})` : ` (Nhân viên)`;
        document.getElementById('userInfo').textContent = staffInfo;

        filterDataByStaff();
        renderHeader();
        applyAllFilters();
        setupCellSelection();
      } catch (error) {
        showError(error.message);
      }
    }

    function filterDataByStaff() {
      if (!currentStaff) return;
      staffFilteredData = allData.filter(row => {
        const deliveryStaff = row["NV Vận đơn"] || row["NV_Vận_đơn"] || '';
        if (currentStaff.vi_tri === "Leader") {
          return teamMembers.includes(deliveryStaff);
        } else {
          return deliveryStaff === currentStaff.ho_va_ten;
        }
      });
    }

    function applyAllFilters() {
        let dataToFilter = [...staffFilteredData];
        const tableHead = document.getElementById('tableHead');
        if (!tableHead.querySelector('tr')) return;

        // Date range filter
        const startDate = document.getElementById('startDateFilter').value;
        const endDate = document.getElementById('endDateFilter').value;
        if (startDate || endDate) {
            const start = startDate ? new Date(startDate) : null;
            const end = endDate ? new Date(endDate) : null;
            if(start) start.setHours(0,0,0,0);
            if(end) end.setHours(23,59,59,999);

            dataToFilter = dataToFilter.filter(row => {
                const orderDateStr = row["Ngày lên đơn"] || row["Thời gian lên đơn"];
                if (!orderDateStr) return false;
                
                const dateStr = orderDateStr.endsWith('Z') ? orderDateStr.split('T')[0] : orderDateStr;
                const orderDate = new Date(dateStr);
                if (isNaN(orderDate.getTime())) return false;

                if (start && orderDate < start) return false;
                if (end && orderDate > end) return false;
                return true;
            });
        }

        // Product and Market filters
        const productFilterValue = document.getElementById('productFilter').value.toLowerCase().trim();
        if (productFilterValue) {
            dataToFilter = dataToFilter.filter(row => 
                (row["Mặt hàng"] || '').toLowerCase().includes(productFilterValue)
            );
        }
        
        const marketFilterValue = document.getElementById('marketFilter').value.toLowerCase().trim();
        if (marketFilterValue) {
            dataToFilter = dataToFilter.filter(row => 
                (row["City"] || '').toLowerCase().includes(marketFilterValue)
            );
        }

        // Column-specific filters
        const filters = tableHead.querySelectorAll('.filter-input, .filter-select');
        filters.forEach(filter => {
            const value = filter.value.toLowerCase().trim();
            if (value === '') return;
            const colName = filter.dataset.column;
            dataToFilter = dataToFilter.filter(row => {
                 let cellValue = row[colName] !== undefined ? row[colName] : row[colName.replace(/ /g, '_')] || '';
                 return cellValue.toString().toLowerCase().includes(value);
            });
        });
        
        updateSummaryInfo(dataToFilter);
        renderTableBody(dataToFilter);
    }

    function renderHeader() {
        const header = document.getElementById('tableHead');
        header.innerHTML = '';
        const tr = document.createElement('tr');
        displayColumns.forEach(colName => {
            const th = document.createElement('th');
            th.textContent = colName;
            if (colName === "Mã đơn hàng") th.classList.add('fixed-column');
            
            let filterElement;
            if (dropdownCols[colName]) {
                filterElement = document.createElement('select');
                filterElement.className = 'filter-select';
                dropdownCols[colName].forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt;
                    option.textContent = opt || '(Tất cả)';
                    filterElement.appendChild(option);
                });
                filterElement.addEventListener('change', applyAllFilters);
            } else {
                filterElement = document.createElement('input');
                filterElement.type = 'text';
                filterElement.className = 'filter-input';
                filterElement.placeholder = `Lọc ${colName}...`;
                filterElement.addEventListener('input', applyAllFilters);
            }
            filterElement.dataset.column = colName;
            th.appendChild(document.createElement('br'));
            th.appendChild(filterElement);
            tr.appendChild(th);
        });
        header.appendChild(tr);
    }

    function renderTableBody(data) {
      const container = document.getElementById('tableBody');
      container.innerHTML = '';
      if (data.length === 0) {
        showError(`Không có đơn hàng nào khớp với bộ lọc.`);
        return;
      }
      data.forEach((row) => {
        const originalRowIndex = staffFilteredData.indexOf(row);
        const tr = document.createElement('tr');
        tr.dataset.rowIndex = originalRowIndex;

        displayColumns.forEach(col => {
          const td = document.createElement('td');
          const unifiedColName = col === "Ngày lên đơn" ? "Ngày lên đơn" : col;
          let value = row[unifiedColName] || row[unifiedColName.replace(/ /g, '_')] || '';
          
          if (allDateColumns.includes(col)) {
              const dateSource = col === "Ngày lên đơn" ? (row["Ngày lên đơn"] || row["Thời gian lên đơn"]) : value;
              const formattedDate = formatDate(dateSource);
              value = formattedDate.display;
              td.dataset.originalValue = formattedDate.original;
          }

          if (col === "Mã đơn hàng") td.classList.add('fixed-column');

          if (editableCols.includes(col)) {
            td.classList.add('editable');
            if (dropdownCols[col]) {
              const select = document.createElement('select');
              dropdownCols[col].forEach(opt => select.add(new Option(opt, opt)));
              select.value = value;
              select.addEventListener('change', () => {
                td.classList.add('highlight');
                changedRows.add(originalRowIndex);
              });
              td.appendChild(select);
            } else if (col === "Ngày hẹn đẩy đơn") {
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'date-input';
                input.placeholder = 'dd/mm/yyyy';
                input.value = value;
                input.addEventListener('input', () => {
                    td.classList.add('highlight');
                    changedRows.add(originalRowIndex);
                });
                td.appendChild(input);
            } else {
              td.contentEditable = 'true';
              td.textContent = value;
              td.addEventListener('input', () => {
                td.classList.add('highlight');
                changedRows.add(originalRowIndex);
              });
            }
          } else {
            td.textContent = value;
          }
          tr.appendChild(td);
        });
        container.appendChild(tr);
      });
    }

    function setupControls() {
      document.getElementById('refreshData').addEventListener('click', refreshData);
      document.getElementById('updateAll').addEventListener('click', updateAllChangedRows);
      document.getElementById('startDateFilter').addEventListener('change', applyAllFilters);
      document.getElementById('endDateFilter').addEventListener('change', applyAllFilters);
      document.getElementById('productFilter').addEventListener('input', applyAllFilters);
      document.getElementById('marketFilter').addEventListener('input', applyAllFilters);
      document.getElementById('clearFilters').addEventListener('click', () => {
          document.getElementById('startDateFilter').value = '';
          document.getElementById('endDateFilter').value = '';
          document.getElementById('productFilter').value = '';
          document.getElementById('marketFilter').value = '';
          document.querySelectorAll('#tableHead .filter-input, #tableHead .filter-select').forEach(f => f.value = '');
          applyAllFilters();
      });
    }

    function refreshData() {
      document.getElementById('refreshData').innerHTML = '<span class="loading"></span> Đang tải...';
      document.getElementById('updateAll').disabled = true;
      loadData();
      setTimeout(() => {
          document.getElementById('refreshData').innerHTML = '<span class="refresh-icon">↻</span> Load dữ liệu';
          document.getElementById('updateAll').disabled = false;
      }, 5000);
    }

    function updateAllChangedRows() {
      if (changedRows.size === 0) {
        alert('Không có thay đổi nào để cập nhật');
        return;
      }
      const updateBtn = document.getElementById('updateAll');
      const statusEl = document.createElement('span');
      statusEl.className = 'status';
      statusEl.textContent = 'Đang xử lý...';
      updateBtn.appendChild(statusEl);
      updateBtn.disabled = true;

      const rowsToSend = [];
      const tableBody = document.getElementById('tableBody');
      
      changedRows.forEach(rowIndex => {
        const originalData = staffFilteredData[rowIndex];
        if (!originalData) return;

        const tr = tableBody.querySelector(`tr[data-row-index="${rowIndex}"]`);
        if(!tr) return;
        
        const updatedRowData = { ...originalData };

        editableCols.forEach(colName => {
          const colIndex = displayColumns.indexOf(colName);
          const cell = tr.cells[colIndex];
          let valueFromDOM = cell.querySelector('select, input')?.value ?? cell.textContent.trim();
          
          if (colName === "Ngày hẹn đẩy đơn") {
            valueFromDOM = cell.querySelector('input')?.value || '';
          }
          
          updatedRowData[colName] = valueFromDOM;
        });

        allDateColumns.forEach(colName => {
          if (colName !== "Ngày hẹn đẩy đơn") {
            const colIndex = displayColumns.indexOf(colName);
            const cell = tr.cells[colIndex];
            updatedRowData[colName] = cell.dataset.originalValue || '';
          }
        });
        
        delete updatedRowData["Thời gian lên đơn"];
        
        rowsToSend.push(updatedRowData);
      });

      if (rowsToSend.length === 0) {
        statusEl.textContent = 'Không có dòng nào hợp lệ để gửi.';
        setTimeout(() => { if(statusEl.parentElement) updateBtn.removeChild(statusEl); updateBtn.disabled = false; }, 3000);
        return;
      }

      fetch(POST_URL, {
        method: 'POST', mode: 'no-cors',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ rows: JSON.stringify(rowsToSend) })
      })
      .then(() => {
          statusEl.textContent = `Đã gửi ${rowsToSend.length} thay đổi. Đang chờ xác nhận...`;
          setTimeout(() => {
              alert(`Cập nhật thành công ${rowsToSend.length} dòng. Vui lòng nhấn "Load dữ liệu" để xem thay đổi.`);
              changedRows.clear();
              document.querySelectorAll('.highlight').forEach(cell => cell.classList.remove('highlight'));
              if(statusEl.parentElement) updateBtn.removeChild(statusEl);
              updateBtn.disabled = false;
          }, 2000);
      })
      .catch(e => {
        statusEl.textContent = 'Lỗi mạng: ' + e.message;
        statusEl.classList.add('error-status');
        setTimeout(() => { if(statusEl.parentElement) updateBtn.removeChild(statusEl); updateBtn.disabled = false; }, 4000);
      });
    }

    function loadData() {
      const container = document.getElementById('tableBody');
      const colCount = displayColumns.length > 0 ? displayColumns.length : 10;
      container.innerHTML = `<tr><td colspan="${colCount}" style="text-align: center; padding: 20px;">Đang tải dữ liệu...</td></tr>`;

      const script = document.createElement('script');
      script.src = `${POST_URL}?callback=handleData&rand=${Math.random()}`;

      const oldScript = document.querySelector('script[src^="https://script.google.com"]');
      if (oldScript) oldScript.remove();

      document.body.appendChild(script);
    }

    setupControls();
    loadData();
  </script>
</body>
</html>

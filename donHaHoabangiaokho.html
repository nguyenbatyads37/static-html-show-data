<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PHIẾU BÀN GIAO ĐƠN HÀNG VỚI KHO</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.5;
      font-size: 14px;
      max-width: 210mm;
      color: #000;
      background: #fff;
      text-align: center;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #ddd;
      width: 100%;
    }
    .logo {
      max-width: 240px;
      height: auto;
    }
    .company-info {
      flex: 1;
      text-align: center;
      padding-left: 20px;
    }
    .company-name {
      font-size: 28px;
      font-weight: bold;
      text-transform: uppercase;
      margin: 0;
      line-height: 1.2;
    }
    .company-details {
      font-size: 16px;
      line-height: 1.4;
      font-weight: bold;
      margin-top: 5px;
    }
    .product-list {
      display: block;
      margin: 0 auto;
    }
    h1 {
      margin: 15px 0;
      font-size: 18px;
      font-weight: bold;
      text-transform: uppercase;
    }
    .document-info {
      margin-bottom: 15px;
      font-size: 13px;
    }
    .summary {
      margin-bottom: 15px;
      padding: 8px;
      border: 1px solid #ddd;
      font-weight: bold;
      display: inline-block;
      text-align: center;
    }
    .summary div {
      margin: 3px 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
      font-size: 13px;
    }
    th, td {
      border: 1px solid #000;
      padding: 6px;
    }
    th {
      font-weight: bold;
      text-align: center;
    }
    td {
      text-align: left;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .signature-section {
      display: flex;
      justify-content: space-between;
      margin-top: 40px;
    }
    .signature-box {
      width: 30%;
      text-align: center;
    }
    @media print {
      body {
        padding: 10px;
        font-size: 13px;
      }
      .header {
        border-bottom: 1px solid #000;
      }
      .product-list {
        white-space: nowrap;
      }
      td {
        white-space: nowrap !important;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <img src="https://www.appsheet.com/template/gettablefileurl?appName=B%C3%A1ogi%C3%A1s%E1%BA%A3nph%E1%BA%A9m-325045268&tableName=c%C3%A0i%20%C4%91%E1%BA%B7t%20APP&fileName=C%C3%A0i%20%C4%91%E1%BA%B7t%20APP_Images%2F79ab1bb2.%E1%BA%A2nh.040547.jpg" alt="Logo" class="logo">
    <div class="company-info">
      <div class="company-name">NPP HÀ HÒA</div>
      <div class="company-details">
        Phân phối các mặt hàng đồ dùng 1 lần: Nilon, Cốc nhựa<br>
        <div class="product-list">
          Cốc giấy, Khay xốp các loại, Chai nhựa, Màng bọc thực phẩm, …
        </div>
        ĐC: Tiên Phong, Ba Vì, Hà Nội<br>
        Góp ý chất lượng sản phẩm & dịch vụ: 0973.905.992<br>
        Liên hệ nhà phân phối: 0969.250.323
      </div>
    </div>
  </div>

  <h1>PHIẾU BÀN GIAO ĐƠN HÀNG VỚI KHO</h1>

  <div class="document-info">
    Ngày bàn giao: <span id="delivery-date"></span> | Giờ bàn giao: <span id="delivery-time"></span>
  </div>

  <div class="summary">
    <div>Tổng Đơn: <span id="total-orders">00</span> Đơn</div>
    <div>Tổng tiền hàng phải thu: <span id="total-receivable">0</span> VNĐ</div>
  </div>

  <table>
    <thead>
      <tr>
        <th style="width:15%">Ngày</th>
        <th style="width:35%">Khách hàng</th>
        <th style="width:30%">NV phụ trách kho</th>
        <th style="width:20%">Tổng tiền</th>
      </tr>
    </thead>
    <tbody id="data-container">
      <!-- Dữ liệu sẽ được thêm vào đây bằng JavaScript -->
    </tbody>
  </table>

  <div class="signature-section">
    <div class="signature-box">
      <div>Người bàn giao</div>
      <div>(Ký và ghi rõ họ tên)</div>
    </div>
    <div class="signature-box">
      <div>NV phụ trách kho</div>
      <div>(Ký và ghi rõ họ tên)</div>
    </div>
    <div class="signature-box">
      <div>Thủ kho</div>
      <div>(Ký và ghi rõ họ tên)</div>
    </div>
  </div>

  <script>
  (function() {
    const spreadsheetId = '1WpNbn9DRdRtRwV6uZge-KuzhWw1NVG65FBl2S4eC08Q';
    const sheetIdMain = '449675231';
    let originalData = [];

    function getUrlParameter(name) {
      name = name.replace(/[[\]]/g, '\\$&');
      const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
      const results = regex.exec(window.location.href);
      if (!results) return null;
      return results[2] ? decodeURIComponent(results[2].replace(/\+/g, ' ')) : '';
    }

    function showDateTime() {
      const now = new Date();
      const dd = String(now.getDate()).padStart(2,'0');
      const mm = String(now.getMonth()+1).padStart(2,'0');
      const yyyy = now.getFullYear();
      const hh = String(now.getHours()).padStart(2,'0');
      const min = String(now.getMinutes()).padStart(2,'0');
      document.getElementById('delivery-date').textContent = `${dd}/${mm}/${yyyy}`;
      document.getElementById('delivery-time').textContent = `${hh}:${min}`;
    }

    function formatCurrency(amount) {
      return amount ? parseInt(amount).toLocaleString('vi-VN') : '0';
    }

    function capitalizeFirstLetter(str) {
      if (!str) return '';
      return str.toLowerCase().split(' ').map(word => 
        word.charAt(0).toUpperCase() + word.slice(1)
      ).join(' ');
    }

    function normalizeDate(dateStr) {
      if (!dateStr) return '';
      const parts = dateStr.split('/');
      if (parts.length === 3) {
        return `${parts[0].padStart(2,'0')}/${parts[1].padStart(2,'0')}/${parts[2]}`;
      }
      return dateStr;
    }

    function removeAccents(str) {
      return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    }

    function filterData(data) {
      const ngay = getUrlParameter('ngay');
      const ten = getUrlParameter('ten');

      return data.filter(item => {
        const itemDate = normalizeDate(item.AP);
        const filterDate = normalizeDate(ngay);
        const ngayTrung = ngay ? itemDate === filterDate : true;
        
        let tenTrung = true;
        if (ten) {
          const driverNames = item.AN.split(',').map(name => removeAccents(name.trim().toLowerCase()));
          tenTrung = driverNames.some(name => name.includes(removeAccents(ten.toLowerCase())));
        }
        
        return ngayTrung && tenTrung;
      });
    }

    function loadData() {
      showDateTime();

      fetch(`https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?gid=${sheetIdMain}`)
        .then(res => res.text())
        .then(txt => {
          const rows = JSON.parse(txt.substring(47).slice(0,-2)).table.rows;
          originalData = rows.map(row => {
            const dateText = row.c[4]?.f || row.c[4]?.v; // Cột E (index 4)
            const customer = row.c[3]?.f || row.c[3]?.v || ''; // Cột D (index 3)
            const drivers = row.c[8]?.v || ''; // Cột I (index 8)
            const amount = parseInt(row.c[5]?.v) || 0; // CỘT F (index 5)
            
            return dateText && customer.trim() ? {
              AP: dateText.toString().trim(),
              H: customer.toString().trim(),
              AN: drivers,
              Q: amount
            } : null;
          }).filter(x => x);

          const filtered = filterData(originalData);
          displayData(filtered);
        })
        .catch(err => {
          console.error('Lỗi:', err);
          document.getElementById('data-container').innerHTML = 
            '<tr><td colspan="4" style="color:red">Lỗi tải dữ liệu. Vui lòng kiểm tra console (F12) để biết chi tiết.</td></tr>';
        });
    }

    function displayData(data) {
      const totalOrders = data.length;
      document.getElementById('total-orders').textContent = 
        totalOrders < 10 ? '0' + totalOrders : totalOrders;
      document.getElementById('total-receivable').textContent = 
        formatCurrency(data.reduce((sum, item) => sum + item.Q, 0));

      let html = '';
      if (data.length === 0) {
        html = '<tr><td colspan="4">Không tìm thấy đơn hàng nào phù hợp</td></tr>';
      } else {
        data.forEach(item => {
          html += `
          <tr>
            <td>${item.AP}</td>
            <td style="text-align:left">${capitalizeFirstLetter(item.H)}</td>
            <td style="text-align:left">${item.AN.split(',').map(d => d.trim()).join(', ')}</td>
            <td style="text-align:right">${formatCurrency(item.Q)}</td>
          </tr>`;
        });
      }
      document.getElementById('data-container').innerHTML = html;
    }

    window.addEventListener('load', loadData);
  })();
  </script>
</body>
</html>

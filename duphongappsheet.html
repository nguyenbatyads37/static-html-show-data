<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quét QR - Dự phòng AppSheet</title>
    <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1"></script>
    <style>
        /* Giữ nguyên phần CSS như trước */
    </style>
</head>
<body>
    <!-- Giữ nguyên phần header và container như trước -->

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const codeReader = new ZXing.BrowserQRCodeReader();
            const resultElement = document.getElementById('result');
            const scanInfoElement = document.getElementById('scan-info');
            const restartBtn = document.getElementById('restart-btn');
            const copyBtn = document.getElementById('copy-btn');
            
            // Hiển thị thông báo lỗi
            function showError(message) {
                scanInfoElement.innerHTML = `<span style="color: red;">${message}</span>`;
                resultElement.textContent = "Lỗi truy cập camera";
            }

            // Kiểm tra quyền camera
            async function checkCameraPermission() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    stream.getTracks().forEach(track => track.stop());
                    return true;
                } catch (err) {
                    console.error("Lỗi quyền camera:", err);
                    return false;
                }
            }

            // Bắt đầu quét
            async function startScanning() {
                try {
                    // Kiểm tra quyền trước
                    const hasPermission = await checkCameraPermission();
                    if (!hasPermission) {
                        showError("Vui lòng cấp quyền truy cập camera!");
                        return;
                    }

                    const videoInputDevices = await ZXing.BrowserCodeReader.listVideoInputDevices();
                    
                    // Ưu tiên camera sau
                    let selectedDeviceId = null;
                    const backCamera = videoInputDevices.find(device => 
                        device.label.toLowerCase().includes('back'));
                    
                    selectedDeviceId = backCamera?.deviceId || videoInputDevices[0]?.deviceId;

                    if (!selectedDeviceId) {
                        showError("Không tìm thấy camera!");
                        return;
                    }

                    await codeReader.decodeFromVideoDevice(
                        selectedDeviceId,
                        'scanner',
                        (result, error) => {
                            if (result) {
                                resultElement.textContent = result.text;
                                scanInfoElement.innerHTML = '<span style="color: #4285F4;">✓ Quét thành công!</span>';
                                restartBtn.classList.remove('hidden');
                                copyBtn.classList.remove('hidden');
                            }
                            if (error && !error.message.includes('No QR code found')) {
                                console.error(error);
                            }
                        }
                    );

                    scanInfoElement.textContent = 'Đang quét...';
                } catch (err) {
                    console.error("Lỗi nghiêm trọng:", err);
                    showError(`Lỗi: ${err.message || 'Không thể khởi động camera'}`);
                }
            }

            // Bắt đầu quét khi trang load
            startScanning();

            // Các sự kiện nút như trước
            restartBtn.addEventListener('click', startScanning);
            copyBtn.addEventListener('click', async () => {
                try {
                    await navigator.clipboard.writeText(resultElement.textContent);
                    scanInfoElement.innerHTML = '<span style="color: green;">Đã sao chép!</span>';
                } catch (err) {
                    showError("Lỗi khi sao chép");
                }
            });
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gi·∫•y ƒë·ªÅ ngh·ªã c·∫•p GPVT - H·ªì s∆° xe</title>
    <style>
        /* ===== RESET & BASE STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Times New Roman", Times, serif;
            font-size: 12pt;
            line-height: 1.3;
            background-color: #f5f5f5;
            padding: 20px;
        }

        /* ===== TAB NAVIGATION ===== */
        .tabs-container {
            max-width: 1200px;
            margin: 0 auto 20px;
            background: #fff;
            border: 1px solid #ccc;
            display: flex;
        }

        .tab-link {
            flex: 1;
            padding: 12px 20px;
            background: #f0f0f0;
            border: none;
            border-right: 1px solid #ccc;
            cursor: pointer;
            font-size: 12pt;
            font-weight: bold;
            transition: background 0.3s;
        }

        .tab-link:last-child {
            border-right: none;
        }

        .tab-link:hover {
            background: #e0e0e0;
        }

        .tab-link.active {
            background: #fff;
            color: #000;
        }

        /* ===== CONTENT CONTAINER & A4 PAGE ===== */
        .content-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .page-container {
            width: 210mm;
            min-height: 297mm;
            background: white;
            margin: 0 auto;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 15mm 15mm 15mm 25mm;
            position: relative;
        }

        .print-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 25px;
            font-size: 12pt;
            font-weight: bold;
            cursor: pointer;
            border-radius: 4px;
            margin-bottom: 15px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        .print-button:hover {
            background: #218838;
        }

        /* ===== PAGE 1 STYLES - GI·∫§Y ƒê·ªÄ NGH·ªä ===== */
        .header-section {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 5px;
        }

        .header-left {
            width: 35%;
            font-size: 11pt;
            text-align: center;
        }

        .header-right {
            width: 60%;
            font-size: 11pt;
            text-align: center;
        }

        .header-left .company-name {
            font-weight: bold;
            font-size: 12pt;
            margin: 2px 0;
        }

        .header-right .vietnam {
            font-weight: bold;
            font-size: 12pt;
            white-space: nowrap;
            overflow: hidden;
        }

        .header-right .motto {
            font-weight: bold;
            font-size: 11pt;
            text-decoration: underline;
            text-underline-offset: 2px;
        }

        .document-title {
            text-align: center;
            font-weight: bold;
            font-size: 13pt;
            text-transform: uppercase;
            margin: 12px 0 10px;
            line-height: 1.3;
        }

        .recipient {
            text-align: center;
            font-size: 12pt;
            margin: 10px 0 12px;
        }

        .main-content {
            font-size: 11.5pt;
            text-align: justify;
        }

        .main-content p {
            margin-bottom: 6px;
            text-indent: 30px;
            line-height: 1.35;
        }

        .table-wrapper {
            margin: 10px 0;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 9pt;
            table-layout: fixed;
        }

        th, td {
            border: 1px solid #000;
            padding: 3px;
            text-align: center;
            vertical-align: middle;
            word-wrap: break-word;
        }

        th {
            background-color: #f0f0f0;
            font-weight: bold;
        }

        /* Footer Section */
        .footer-section {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            font-size: 11.5pt;
        }

        .footer-left, .footer-right {
            width: 40%;
        }

        .footer-right {
            text-align: center;
        }

        .footer-right .position {
            font-weight: bold;
            font-size: 12pt;
            text-transform: uppercase;
        }

        .footer-right .sign-note {
            font-style: italic;
            font-size: 10.5pt;
            margin-bottom: 40px;
        }

        .signature-container {
            position: relative;
            height: 80px;
            margin-top: -30px;
        }

        .signature-container img {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            max-width: 140px;
            height: auto;
            opacity: 0.8;
        }

        .footer-right .name {
            font-weight: bold;
            font-size: 12pt;
        }

        #ho-so-info {
            position: absolute;
            bottom: 15mm;
            left: 25mm;
            font-size: 10pt;
        }

        #ho-so-content, #ngay-cap-landau-content {
            font-weight: bold;
        }

        /* ===== TAB 2: ƒêƒÇNG K√ù XE STYLES ===== */
        .dangky-page {
            width: 210mm;
            min-height: 297mm;
            background: white;
            margin: 0 auto 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 20mm 15mm;
            page-break-after: always;
        }

        .dangky-page:last-child {
            page-break-after: auto;
        }

        .dangky-bks {
            text-align: center;
            font-size: 16pt;
            font-weight: bold;
            margin-bottom: 20px;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
        }

        .dangky-image-wrapper {
            border: 1px solid #ddd;
            padding: 10px;
            min-height: 150px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 30px;
        }

        .dangky-image-wrapper img {
            max-width: 100%;
            height: auto;
        }
        
        .dangky-image-label {
             text-align: center;
            font-size: 12pt;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .error-message {
            color: red;
            font-weight: bold;
        }

        /* ===== TAB 3: HOP DONG STYLES ===== */
        #hopdong-content-wrapper {
            background: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        #hopdong-iframe {
            width: 100%;
            height: 85vh;
            border: none;
        }

        .hopdong-error-message {
            color: red;
            font-size: 14pt;
            text-align: center;
            padding: 50px;
            background: white;
            min-height: 297mm;
        }

        /* ===== PRINT STYLES ===== */
        @media print {
            @page {
                size: A4;
                margin: 0;
            }

            body {
                background: white;
                margin: 0;
                padding: 0;
            }
            
            /* ·∫®n t·∫•t c·∫£ nh·ªØng g√¨ kh√¥ng c·∫ßn thi·∫øt */
            .tabs-container,
            .print-button {
                display: none !important;
            }
            
            /* Theo m·∫∑c ƒë·ªãnh, ·∫©n t·∫•t c·∫£ c√°c tab content khi in */
            .tab-content {
                display: none !important;
            }
            
            /* CH·ªà HI·ªÇN TH·ªä tab n√†o c√≥ class 'printing' */
            .tab-content.printing {
                display: block !important;
            }

            .content-container, .page-container, .dangky-page {
                width: 100%;
                min-height: initial;
                margin: 0;
                padding: 0;
                box-shadow: none;
            }

            .page-container {
                padding: 15mm 15mm 15mm 25mm;
            }

            .dangky-page {
                padding: 20mm 15mm;
                 page-break-after: always;
            }
             .dangky-page:last-child {
                page-break-after: auto;
            }

            /* X·ª≠ l√Ω ƒë·∫∑c bi·ªát cho tab h·ª£p ƒë·ªìng khi in */
             #tab3.printing #hopdong-iframe {
               display: none; /* ·∫®n iframe ƒëi */
            }

            #tab3.printing #hopdong-content-wrapper::before {
                content: "N·ªôi dung h·ª£p ƒë·ªìng kh√¥ng th·ªÉ ƒë∆∞·ª£c in tr·ª±c ti·∫øp t·ª´ trang n√†y do h·∫°n ch·∫ø b·∫£o m·∫≠t. Vui l√≤ng m·ªü h·ª£p ƒë·ªìng trong m·ªôt tab m·ªõi v√† in t·ª´ ƒë√≥.";
                display: block;
                text-align: center;
                padding: 50px;
                font-size: 14pt;
                color: #000;
            }
        }
    </style>
</head>
<body>
    <div class="tabs-container">
        <button class="tab-link active" data-tab="tab1">Gi·∫•y ƒë·ªÅ ngh·ªã</button>
        <button class="tab-link" data-tab="tab2">ƒêƒÉng k√Ω xe</button>
        <button class="tab-link" data-tab="tab3">H·ª£p ƒë·ªìng</button>
    </div>

    <div class="content-container">
        <div id="tab1" class="tab-content active">
            <button class="print-button" onclick="printTab('tab1')">üñ®Ô∏è In Gi·∫•y ƒë·ªÅ ngh·ªã</button>
            <div class="page-container">
                 <!-- N·ªôi dung Gi·∫•y ƒë·ªÅ ngh·ªã ·ªü ƒë√¢y -->
                 <div class="header-section">
                    <div class="header-left">
                        <div class="company-name" id="company-name-header">T√äN C√îNG TY</div>
                        S·ªë: <span id="doc-number">...</span>
                    </div>
                    <div class="header-right">
                        <div class="vietnam">C·ªòNG H√íA X√É H·ªòI CH·ª¶ NGHƒ®A VI·ªÜT NAM</div>
                        <div class="motto">ƒê·ªôc l·∫≠p - T·ª± do - H·∫°nh ph√∫c</div>
                        <div class="date-place" id="date-place">L·∫°ng S∆°n, ng√†y ... th√°ng ... nƒÉm 2024</div>
                    </div>
                </div>
                <div class="document-title">
                    GI·∫§Y ƒê·ªÄ NGH·ªä C·∫§P L·∫†I GI·∫§Y PH√âP V·∫¨N T·∫¢I ƒê∆Ø·ªúNG B·ªò QU·ªêC T·∫æ GI·ªÆA VI·ªÜT NAM V√Ä TRUNG QU·ªêC
                </div>
                <div class="recipient">
                    <strong>K√≠nh g·ª≠i: S·ªü Giao th√¥ng v·∫≠n t·∫£i L·∫°ng S∆°n</strong>
                </div>
                <div class="main-content">
                    <p>1. T√™n ƒë∆°n v·ªã v·∫≠n t·∫£i: <strong id="company-name-content">...</strong></p>
                    <p>2. ƒê·ªãa ch·ªâ: <span id="address">...</span></p>
                    <p>3. ƒêi·ªán tho·∫°i: <span id="phone">...</span></p>
                    <p>4. Gi·∫•y ph√©p kinh doanh v·∫≠n t·∫£i b·∫±ng xe √¥ t√¥ s·ªë <span id="dkkd">...</span>, ng√†y c·∫•p: <span
                            id="dkkd-date">...</span>; n∆°i c·∫•p: S·ªü
                        Giao th√¥ng v·∫≠n t·∫£i L·∫°ng S∆°n.</p>
                    <p>5. ƒê·ªÅ ngh·ªã c·∫•p l·∫°i Gi·∫•y ph√©p v·∫≠n t·∫£i lo·∫°i <span id="request-type"
                            style="color: red; font-weight: bold;">...</span> cho c√°c ph∆∞∆°ng ti·ªán sau:</p>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 4%">TT</th>
                                <th style="width: 10%">Bi·ªÉn s·ªë xe</th>
                                <th style="width: 10%">Nh√£n hi·ªáu</th>
                                <th style="width: 7%">NƒÉm SX</th>
                                <th style="width: 8%">Tr·ªçng t·∫£i</th>
                                <th style="width: 15%">Th·ªùi gian<br>ƒë·ªÅ ngh·ªã</th>
                                <th style="width: 10%">H√¨nh th·ª©c<br>Hƒê</th>
                                <th style="width: 16%">Tuy·∫øn Hƒê</th>
                                <th style="width: auto; min-width: 150px;">ƒêi·ªÉm<br>d·ª´ng ngh·ªâ</th>
                            </tr>
                        </thead>
                        <tbody id="table-body">
                        </tbody>
                    </table>
                </div>
                <div class="main-content">
                    <p>6. Ng∆∞·ªùi li√™n h·ªá: <span id="contact-person">...</span>, ƒêi·ªán tho·∫°i: <span
                            id="contact-phone">...</span></p>
                </div>
                <div class="footer-section">
                    <div class="footer-left">
                        <strong>N∆°i nh·∫≠n:</strong><br>
                        - Nh∆∞ tr√™n;<br>
                        - L∆∞u: VT.
                    </div>
                    <div class="footer-right">
                        <div class="position">GI√ÅM ƒê·ªêC</div>
                        <div class="sign-note">(K√Ω t√™n, ƒë√≥ng d·∫•u)</div>
                        <div class="signature-container">
                        </div>
                        <div class="name" id="director-name">L·ª•c Di·ªáu Na</div>
                    </div>
                </div>
                <div id="ho-so-info">
                    M√£ HS: <span id="ho-so-content">...</span>
                    <div id="cap-lan-1-row">
                        C·∫•p l·∫ßn 1 ng√†y: <span id="ngay-cap-landau-content">...</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab2" class="tab-content">
            <button class="print-button" onclick="printTab('tab2')">üñ®Ô∏è In ƒêƒÉng k√Ω xe</button>
            <div id="dangky-container">
            </div>
        </div>

        <div id="tab3" class="tab-content">
            <button class="print-button" onclick="printTab('tab3')">üñ®Ô∏è In H·ª£p ƒë·ªìng</button>
            <div id="hopdong-content-wrapper">
            </div>
        </div>
    </div>

    <script>
        // --- TO√ÄN B·ªò LOGIC KH·ªûI T·∫†O D·ªÆ LI·ªÜU BAN ƒê·∫¶U ---
        document.addEventListener('DOMContentLoaded', function () {
            const urlParams = new URLSearchParams(window.location.search);
            const getParam = (key, defaultValue = '') => urlParams.has(key) ? decodeURIComponent(urlParams.get(key)) : defaultValue;

            // ƒêi·ªÅn d·ªØ li·ªáu chung
            const companyName = getParam('tencongty', 'T√äN C√îNG TY');
            document.getElementById('company-name-header').textContent = companyName.toUpperCase();
            document.getElementById('company-name-content').textContent = companyName;
            
            const fields = {
                'so': 'doc-number', 'diachi': 'address', 'sdt': 'phone', 'dkkd': 'dkkd', 
                'ngaycapdkkd': 'dkkd-date', 'nguoilienhe': 'contact-person', 'sdtlh': 'contact-phone', 
                'loaidenghi': 'request-type', 'giamdoc': 'director-name', 'mahoso': 'ho-so-content', 
                'ngaycaplandau': 'ngay-cap-landau-content'
            };
            Object.entries(fields).forEach(([param, id]) => {
                const el = document.getElementById(id);
                if (el) el.textContent = getParam(param, '...');
            });
            
            // X·ª≠ l√Ω ng√†y th√°ng
            const datePlaceEl = document.getElementById('date-place');
            if (urlParams.has('ngaythang')) {
                datePlaceEl.textContent = getParam('ngaythang');
            } else {
                const today = new Date();
                datePlaceEl.textContent = `L·∫°ng S∆°n, ng√†y ${today.getDate()} th√°ng ${today.getMonth() + 1} nƒÉm ${today.getFullYear()}`;
            }

            // ƒêi·ªÅn b·∫£ng d·ªØ li·ªáu xe
            const dataString = getParam('data');
            if (dataString) {
                const tableBody = document.getElementById('table-body');
                dataString.split('_b_').forEach((rowData, index) => {
                    if (!rowData.trim()) return;
                    const cells = rowData.split('_a_').map(cell => cell.trim());
                    const row = tableBody.insertRow();
                    row.insertCell().textContent = index + 1;
                    cells.forEach(cellData => {
                        row.insertCell().textContent = cellData;
                    });
                });
            }

            // Hi·ªÉn th·ªã con d·∫•u & ch·ªØ k√Ω
            const signatureContainer = document.querySelector('.signature-container');
            const sealUrl = getParam('condau');
            const signatureUrl = getParam('chuki');
            const directorNameEl = document.getElementById('director-name');
            if (getParam('loaichuky', '').toLowerCase() !== 'ch·ªØ k√Ω') {
                 if(directorNameEl) directorNameEl.style.visibility = 'hidden';
            }

            const createImage = (src, alt) => {
                if (!src) return;
                const img = document.createElement('img');
                img.src = src;
                img.alt = alt;
                img.onerror = () => img.style.display = 'none';
                signatureContainer.appendChild(img);
            };
            createImage(sealUrl, 'Con d·∫•u');
            createImage(signatureUrl, 'Ch·ªØ k√Ω');
            
            // Tab 2: T·∫°o c√°c trang ƒëƒÉng k√Ω xe
            const dangkyContainer = document.getElementById('dangky-container');
            const linkAnhData = getParam('linkanh');
            if (linkAnhData.trim()) {
                linkAnhData.split('_b_').forEach(pageData => {
                    if (!pageData.trim()) return;
                    const parts = pageData.split('_a_').map(p => p.trim());
                    const bks = parts.length > 2 ? (parts[1] || 'Kh√¥ng r√µ BKS') : 'Kh√¥ng r√µ BKS';
                    const linkTruoc = parts.length > 2 ? parts[2] : parts[0];
                    const linkSau = parts.length > 2 ? parts[3] : parts[1];
                    createDangKyPage(dangkyContainer, bks, linkTruoc, linkSau);
                });
            } else {
                dangkyContainer.innerHTML = '<div class="error-message" style="text-align:center; padding: 20px;">Kh√¥ng c√≥ d·ªØ li·ªáu ·∫£nh ƒëƒÉng k√Ω xe.</div>';
            }

            // Tab 3: T·∫£i n·ªôi dung h·ª£p ƒë·ªìng
            const hopdongWrapper = document.getElementById('hopdong-content-wrapper');
            // L·∫•y tr·ª±c ti·∫øp t·ª´ URL ƒë·ªÉ gi·ªØ nguy√™n ƒë·ªãnh d·∫°ng encoded (kh√¥ng decode)
            // L·∫•y to√†n b·ªô ph·∫ßn sau hd= (c√≥ th·ªÉ ch·ª©a nhi·ªÅu query params)
            const urlString = window.location.search;
            const hdMatch = urlString.match(/[?&]hd=(.*)/);
            const hdDataRaw = hdMatch ? hdMatch[1] : null;
            
            if (hdDataRaw) {
                // T·∫°o URL ƒë√≠ch b·∫±ng c√°ch gh√©p chu·ªói (gi·ªØ nguy√™n ƒë·ªãnh d·∫°ng encoded)
                const targetUrl = `https://nguyenbatyads37.github.io/static-html-show-data/Hopdongviettrung.html?${hdDataRaw}`;
                const iframe = document.createElement('iframe');
                iframe.id = 'hopdong-iframe';
                iframe.src = targetUrl;
                iframe.title = 'N·ªôi dung h·ª£p ƒë·ªìng';
                iframe.onerror = () => {
                    hopdongWrapper.innerHTML = '<div class="hopdong-error-message">Kh√¥ng th·ªÉ t·∫£i n·ªôi dung h·ª£p ƒë·ªìng.</div>';
                };
                hopdongWrapper.appendChild(iframe);
            } else {
                hopdongWrapper.innerHTML = '<div class="hopdong-error-message">Kh√¥ng c√≥ ƒë∆∞·ªùng d·∫´n h·ª£p ƒë·ªìng.</div>';
            }
        });

        function createImageSection(label, imageUrl, bks) {
            const container = document.createElement('div');
            const labelDiv = document.createElement('div');
            labelDiv.className = 'dangky-image-label';
            labelDiv.textContent = label;
            container.appendChild(labelDiv);
            
            const wrapper = document.createElement('div');
            wrapper.className = 'dangky-image-wrapper';
            
            if (imageUrl && imageUrl.trim().toLowerCase().startsWith('http')) {
                const img = document.createElement('img');
                img.src = imageUrl.trim();
                img.alt = `·∫¢nh ${label} c·ªßa xe ${bks}`;
                img.loading = 'lazy';
                img.onerror = () => wrapper.innerHTML = `<div class="error-message">L·ªói t·∫£i ·∫£nh ${label.toLowerCase()}.</div>`;
                wrapper.appendChild(img);
            } else {
                wrapper.innerHTML = `<div class="error-message">Kh√¥ng c√≥ ·∫£nh ${label.toLowerCase()}.</div>`;
            }
            container.appendChild(wrapper);
            return container;
        }

        function createDangKyPage(container, bks, linkTruoc, linkSau) {
            const pageDiv = document.createElement('div');
            pageDiv.className = 'dangky-page';
            pageDiv.innerHTML = `<div class="dangky-bks">·∫¢nh gi·∫•y ƒëƒÉng k√Ω xe: ${bks}</div>`;
            pageDiv.appendChild(createImageSection('M·∫∂T TR∆Ø·ªöC', linkTruoc, bks));
            pageDiv.appendChild(createImageSection('M·∫∂T SAU', linkSau, bks));
            container.appendChild(pageDiv);
        }

        // --- LOGIC CHUY·ªÇN TAB ---
        document.querySelectorAll('.tab-link').forEach(link => {
            link.addEventListener('click', function () {
                const targetTabId = this.dataset.tab;
                document.querySelectorAll('.tab-link.active, .tab-content.active').forEach(el => el.classList.remove('active'));
                this.classList.add('active');
                document.getElementById(targetTabId).classList.add('active');
            });
        });

        // --- H√ÄM IN ƒê√É S·ª¨A L·∫†I ---
        function printTab(tabId) {
            // Tr∆∞·ªùng h·ª£p ƒë·∫∑c bi·ªát: c·ªë g·∫Øng in tr·ª±c ti·∫øp iframe
            if (tabId === 'tab3') {
                const iframe = document.getElementById('hopdong-iframe');
                if (iframe && iframe.contentWindow) {
                    try {
                        iframe.contentWindow.focus();
                        iframe.contentWindow.print();
                        return; // N·∫øu th√†nh c√¥ng, d·ª´ng h√†m t·∫°i ƒë√¢y
                    } catch (e) {
                        console.warn("Kh√¥ng th·ªÉ in iframe tr·ª±c ti·∫øp do h·∫°n ch·∫ø b·∫£o m·∫≠t. S·∫Ω in trang v·ªõi th√¥ng b√°o.", e);
                    }
                }
            }
            
            const targetTab = document.getElementById(tabId);
            if (!targetTab) return;

            // 1. Th√™m l·ªõp 'printing' v√†o tab c·∫ßn in
            targetTab.classList.add('printing');

            // 2. G·ªçi h√†m in c·ªßa tr√¨nh duy·ªát
            window.print();

            // 3. X√≥a l·ªõp 'printing' sau khi in (tr√¨nh duy·ªát hi·ªán ƒë·∫°i h·ªó tr·ª£ onafterprint)
            // N·∫øu kh√¥ng, b·∫°n c√≥ th·ªÉ x√≥a n√≥ trong setTimeout, nh∆∞ng onafterprint t·ªët h∆°n.
            window.onafterprint = function() {
                targetTab.classList.remove('printing');
            };
            // Fallback cho tr√¨nh duy·ªát c≈© h∆°n
            setTimeout(() => {
                 targetTab.classList.remove('printing');
            }, 1000);
        }
    </script>
</body>
</html>

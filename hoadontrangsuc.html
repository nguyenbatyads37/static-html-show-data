<script>
  document.addEventListener("DOMContentLoaded", function() {
    // ... (phần trước giữ nguyên)
    
    const danhSachSanPham = chitiet ? chitiet.split('_b_').map(item => {
      const parts = item.split('_a_');
      let imageUrl = '';
      try {
        imageUrl = parts[0] ? encodeURI(decodeURIComponent(parts[0])) : '';
        // Kiểm tra hợp lệ URL
        new URL(imageUrl); 
      } catch (e) {
        imageUrl = '';
      }
      
      return {
        imageUrl: imageUrl,
        tenSP: parts[1] || '',
        tenTrung: parts[2] || '',
        soLuong: parseInt(parts[3]) || 0,
        donGia: parts[4] ? parseInt(parts[4]) : 0,
        ghiChu: parts[5] || ''
      };
    }) : [];

    // Render bảng với fallback ảnh
    tableBody.innerHTML = danhSachSanPham.map((item, index) => `
      <tr>
        <td>${index + 1}</td>
        <td class="image-cell">
          ${item.imageUrl ? 
            `<img src="${item.imageUrl}" 
                  onerror="this.src='https://via.placeholder.com/60?text=Ảnh+SP';this.onerror=null" 
                  alt="Ảnh sản phẩm" />` : 
            '<div style="width:60px;height:60px;background:#eee;display:flex;align-items:center;justify-content:center;font-size:10px">No Image</div>'}
        </td>
        <!-- Các cột khác giữ nguyên -->
      </tr>
    `).join('');
    
    // ... (phần sau giữ nguyên)
  });
</script>

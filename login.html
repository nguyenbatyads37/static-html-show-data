<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đăng nhập | Tổng kho Hà Hòa</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4CAF50; --hover-color: #45a049; --text-color: #333;
            --border-color: #e0e0e0; --error-color: #d32f2f; --success-color: #388e3c;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; }
        body, html { height: 100%; }
        .view { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; background-color: #f4f7f6; position: relative; overflow: hidden; }
        .background-shapes span { position: absolute; display: block; width: 20px; height: 20px; background: rgba(76, 175, 80, 0.15); border-radius: 50%; animation: animate-bg 25s linear infinite; bottom: -150px; }
        .background-shapes span:nth-child(1){left:25%;width:80px;height:80px;animation-delay:0s}.background-shapes span:nth-child(2){left:10%;width:20px;height:20px;animation-delay:2s;animation-duration:12s}.background-shapes span:nth-child(3){left:70%;width:20px;height:20px;animation-delay:4s}.background-shapes span:nth-child(4){left:40%;width:60px;height:60px;animation-delay:0s;animation-duration:18s}.background-shapes span:nth-child(5){left:65%;width:20px;height:20px;animation-delay:0s}.background-shapes span:nth-child(6){left:75%;width:110px;height:110px;animation-delay:3s}
        @keyframes animate-bg{0%{transform:translateY(0) rotate(0deg);opacity:1}100%{transform:translateY(-120vh) rotate(720deg);opacity:0}}
        .login-box { position: relative; z-index: 10; width: 100%; max-width: 400px; padding: 40px 35px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(5px); box-shadow: 0 10px 30px rgba(0,0,0,.1); border-radius: 12px; animation: fadeIn .8s ease-in-out; }
        @keyframes fadeIn{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}
        .login-box.shake{animation:shake .5s cubic-bezier(.36,.07,.19,.97) both}
        @keyframes shake{10%,90%{transform:translate3d(-1px,0,0)}20%,80%{transform:translate3d(2px,0,0)}30%,50%,70%{transform:translate3d(-4px,0,0)}40%,60%{transform:translate3d(4px,0,0)}}
        .logo-container { text-align: center; margin-bottom: 25px; }
        .login-logo { max-width: 150px; height: auto; border-radius: 12px; }
        .login-box h2 { text-align: center; margin-bottom: 25px; color: var(--primary-color); }
        .input-group { position: relative; margin-bottom: 20px; }
        .input-group i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #aaa; }
        .input-group input { width: 100%; padding: 12px 15px 12px 45px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 16px; }
        #login-btn { width: 100%; padding: 14px; border: none; border-radius: 6px; background-color: var(--primary-color); color: white; font-size: 16px; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; transition: all .3s; }
        #login-btn:hover { background-color: var(--hover-color); transform: translateY(-2px); }
        #login-btn:disabled { background-color: #9E9E9E; cursor: not-allowed; transform: none; }
        .error-message { color: var(--error-color); text-align: center; margin-top: 15px; font-size: 14px; display: none; }
    </style>
</head>
<body>
    <div class="view">
        <div class="background-shapes"><span></span><span></span><span></span><span></span><span></span><span></span></div>
        <div class="login-box" id="login-box">
            <div class="logo-container">
                <img class="login-logo" alt="Logo" src="data:image/jpeg;base64,...(base64_string_logo)..." />
            </div>
            <h2>Đăng nhập hệ thống</h2>
            <form id="login-form">
                <div class="input-group">
                    <input type="text" id="username" placeholder="Tên đăng nhập" required autocomplete="username">
                    <i class="fas fa-user"></i>
                </div>
                <div class="input-group">
                    <input type="password" id="password" placeholder="Mật khẩu" required autocomplete="current-password">
                    <i class="fas fa-lock"></i>
                </div>
                <button type="submit" id="login-btn">
                    <i class="fas fa-sign-in-alt"></i>
                    <span>Đăng Nhập</span>
                </button>
                <p class="error-message" id="error-message"></p>
            </form>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://script.google.com/macros/s/AKfycbzJTJ9uaaGXhSpzRwCER5bqJVBHseSQpw9DQNaYahV5N0Z-9Xz-ctvvaOJgtap9c78A/exec';

        const loginForm = document.getElementById('login-form');
        const loginBtn = document.getElementById('login-btn');
        const errorMsg = document.getElementById('error-message');
        const loginBox = document.getElementById('login-box');
        
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // Vô hiệu hóa nút bấm và hiển thị spinner
            loginBtn.disabled = true;
            loginBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i><span>Đang xác thực...</span>`;
            errorMsg.style.display = 'none';

            try {
                const payload = {
                    action: 'login',
                    username: username,
                    password: password
                };

                const response = await fetch(API_BASE_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`Lỗi mạng: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    // Đăng nhập thành công, lưu thông tin vào sessionStorage
                    sessionStorage.setItem('userName', result.user.name);
                    sessionStorage.setItem('userPosition', result.user.position);

                    // Hiển thị thông báo thành công và chuyển hướng
                    loginBtn.style.backgroundColor = 'var(--success-color)';
                    loginBtn.innerHTML = `<i class="fas fa-check-circle"></i><span>Thành công!</span>`;
                    
                    // Chuyển hướng tới trang index.html
                    window.location.href = 'congnohahoa.html';

                } else {
                    throw new Error(result.error || "Lỗi không xác định.");
                }

            } catch (error) {
                // Hiển thị lỗi
                errorMsg.textContent = error.message;
                errorMsg.style.display = 'block';
                loginBox.classList.add('shake');
                setTimeout(() => loginBox.classList.remove('shake'), 500);

            } finally {
                // Kích hoạt lại nút bấm
                 if (errorMsg.style.display !== 'none') {
                    loginBtn.disabled = false;
                    loginBtn.style.backgroundColor = '';
                    loginBtn.innerHTML = `<i class="fas fa-sign-in-alt"></i><span>Đăng Nhập</span>`;
                }
            }
        });
    </script>
</body>
</html>

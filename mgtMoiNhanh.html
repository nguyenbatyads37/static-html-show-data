<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>Quản lý đơn hàng SPEEGO</title>
    <style>
        :root {
            --filter-row-height: 38px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
            margin: 0;
            user-select: none;
        }

        h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .main-filters {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            background: #fff;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 5px;
            color: #555;
        }

        .filter-group select,
        .filter-group input {
            padding: 6px 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 14px;
        }

        /* Thêm style cho dropdown trong bảng */
        td select.editable-select {
            width: 100%;
            border: none;
            background: transparent;
            font-family: inherit;
            font-size: inherit;
            padding: 0;
            margin: 0;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            cursor: pointer;
        }

        td.editable-dropdown-cell {
            padding: 0;
            /* Xóa padding của td để select chiếm toàn bộ */
        }

        td.editable-dropdown-cell select.editable-select {
            padding: 8px 12px;
            /* Di chuyển padding vào select */
        }

        .tab-container {
            margin-bottom: 15px;
            padding: 5px;
            background: #fff;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .tab-btn {
            padding: 8px 15px;
            cursor: pointer;
            background-color: #ecf0f1;
            color: #2c3e50;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            background-color: #dfe6e9;
        }

        .tab-btn.active {
            background-color: #3498db;
            color: white;
            border-color: #2980b9;
            font-weight: bold;
        }

        .tab-btn.tracking-tab {
            background-color: #e74c3c;
            color: white;
        }

        .tab-btn.tracking-tab.active {
            background-color: #c0392b;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            align-items: center;
            background: #fff;
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .controls>div {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .table-wrapper {
            position: relative;
            overflow: auto;
            max-height: 65vh;
            background: white;
            border-radius: 0 0 5px 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        table {
            border-collapse: collapse;
            width: 100%;
            min-width: 1900px;
            font-size: 14px;
        }

        thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th,
        td {
            border: 1px solid #e0e0e0;
            padding: 8px 12px;
            text-align: left;
            white-space: nowrap;
            background-color: white;
        }

        th {
            background-color: #3498db;
            color: white;
            top: var(--filter-row-height);
            z-index: 20;
            font-weight: 500;
        }

        #filterRow th {
            top: 0;
            background-color: #f2f6fa;
            padding: 4px 8px;
        }

        .filter-input {
            width: 100%;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 13px;
        }

        .dual-filter-container {
            display: flex;
            gap: 4px;
            align-items: center;
            flex-direction: column;
        }

        .dual-filter-container input {
            flex: 1;
            min-width: 0;
        }

        td.editable {
            background-color: #fffbe8;
        }

        button {
            padding: 6px 12px;
            cursor: pointer;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #2980b9;
            color: white;
        }

        #downloadExcel {
            background-color: #16a085;
        }

        #downloadExcel:hover {
            background-color: #1abc9c;
        }

        #updateAll {
            position: relative;
        }

        .highlight {
            background-color: #ffeb3b !important;
        }

        .no-data {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            font-style: italic;
        }

        .refresh-btn {
            background-color: #2ecc71;
        }

        .refresh-btn:hover {
            background-color: #27ae60;
        }

        .refresh-icon {
            margin-right: 5px;
        }

        .fixed-column {
            position: sticky;
            z-index: 5;
            background-color: #f8f9fa;
            /* slightly different bg for fixed columns */
        }

        th.fixed-column {
            z-index: 30;
            background-color: #3498db;
        }

        #filterRow th.fixed-column {
            z-index: 40;
            background-color: #e9ecef;
            /* slightly different bg for fixed filter columns */
        }

        td.fixed-column {
            background-color: white;
        }

        .date-input {
            border: none;
            background: transparent;
            width: 'fit-content';
            font-family: inherit;
            font-size: inherit;
            user-select: text;
        }

        .note-highlight {
            background-color: #fff2a8;
        }

        .status-ok {
            background-color: #d4edda;
            color: #155724;
            font-weight: bold;
        }

        .status-cancel {
            background-color: #f8d7da;
            color: #721c24;
            font-weight: bold;
        }

        td.cell-selected {
            background-color: rgba(52, 152, 219, 0.4) !important;
        }

        td.paste-anchor {
            outline: 2px solid #e74c3c !important;
            outline-offset: -2px;
        }

        .order-counter {
            margin-left: 15px;
            font-weight: bold;
            font-size: 14px;
            color: #2c3e50;
        }

        .order-counter b {
            color: #e74c3c;
            font-size: 16px;
            padding: 0 4px;
        }

        .selection-summary {
            margin-left: 20px;
            font-size: 14px;
            color: #2980b9;
            font-weight: 500;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .selection-summary .summary-item {
            display: inline-block;
            background-color: #ecf0f1;
            padding: 3px 8px;
            border-radius: 4px;
            border: 1px solid #bdc3c7;
        }

        .selection-summary b {
            color: #c0392b;
            padding-left: 5px;
        }

        /* Thay thế custom alert styles bằng toast styles */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            pointer-events: none;
        }

        .toast {
            background: white;
            padding: 12px 16px;
            margin-bottom: 10px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            max-width: 350px;
            min-width: 200px;
            transform: translateX(400px);
            transition: transform 0.3s ease, opacity 0.3s ease;
            opacity: 0;
            pointer-events: auto;
            border-left: 4px solid #3498db;
            font-size: 14px;
            color: #333;
            position: relative;
            word-wrap: break-word;
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast.info {
            border-left-color: #3498db;
        }

        .toast.success {
            border-left-color: #2ecc71;
            background: #f8fff9;
        }

        .toast.error {
            border-left-color: #e74c3c;
            background: #fff8f8;
        }

        .toast-close {
            position: absolute;
            top: 4px;
            right: 8px;
            background: none;
            border: none;
            font-size: 16px;
            color: #999;
            cursor: pointer;
            padding: 2px 4px;
            line-height: 1;
        }

        .toast-close:hover {
            color: #666;
        }

        /* Xóa các styles cũ của custom alert */
        .custom-alert-overlay,
        .custom-alert-box,
        #customAlertMessage,
        .custom-alert-close-btn {
            display: none !important;
        }

        /* Pagination styles */
        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 15px;
            padding: 10px;
            background: #fff;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            gap: 10px;
        }

        .pagination-controls button {
            padding: 8px 15px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .pagination-controls button:hover:not(:disabled) {
            background-color: #2980b9;
        }

        .pagination-controls button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .pagination-info {
            font-size: 14px;
            color: #555;
            font-weight: 500;
        }

        .pagination-page-size {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .pagination-page-size label {
            font-size: 13px;
            color: #555;
        }

        .pagination-page-size select {
            padding: 5px 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 13px;
        }

        /* --- MỚI: CSS CHO POPOVER ĐỒNG BỘ --- */
        .popover-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1050;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .popover-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .popover-header {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .popover-header h4 {
            margin: 0;
            font-size: 18px;
        }

        .popover-close {
            border: none;
            background: none;
            font-size: 24px;
            cursor: pointer;
            padding: 0 8px;
            line-height: 1;
        }

        .popover-body {
            padding: 20px;
            overflow-y: auto;
        }

        .popover-body h5 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #3498db;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 5px;
        }

        .popover-body .no-changes {
            color: #7f8c8d;
            font-style: italic;
        }

        .popover-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .popover-table th,
        .popover-table td {
            border: 1px solid #ddd;
            padding: 6px 10px;
            text-align: left;
        }

        .popover-table td .old-value {
            text-decoration: line-through;
            color: #e74c3c;
            margin-right: 8px;
        }

        .popover-table td .new-value {
            font-weight: bold;
            color: #27ae60;
        }

        .popover-footer {
            padding: 15px;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        #syncChangesBtn {
            background-color: #f39c12;
            position: relative;
        }
        #syncChangesBtn:hover {
            background-color: #e67e22;
        }
        .changes-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: #e74c3c;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 11px;
            font-weight: bold;
            min-width: 18px;
            text-align: center;
            line-height: 14px;
            display: none; /* Hidden by default */
        }
        
        /* --- MỚI: CSS CHO BỘ LỌC MULTI-SELECT --- */
        .multiselect-filter {
            position: relative;
            width: 100%;
        }

        .multiselect-display {
            width: 100%;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
            background-color: white;
            font-size: 13px;
            cursor: pointer;
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #8b8686;
        }

        .multiselect-dropdown {
            display: none;
            position: absolute;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
            width: 200px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 50; /* Đảm bảo nó nổi lên trên các thành phần khác */
            margin-top: 2px;
        }

        .multiselect-dropdown.show {
            display: block;
        }

        .multiselect-item {
            display: block;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 13px;
            color: #333;
        }

        .multiselect-item:hover {
            background-color: #f0f0f0;
        }

        .multiselect-item input {
            margin-right: 8px;
            vertical-align: middle;
        }
        
        .multiselect-item label {
            vertical-align: middle;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <h2>Quản lý đơn hàng SPEEGO</h2>

    <div id="mainFilters" class="main-filters">
        <div class="filter-group">
            <label for="filterMarket">Thị trường</label>
            <select id="filterMarket">
                <option value="">Tất cả</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="filterProduct">Sản phẩm</label>
            <select id="filterProduct">
                <option value="">Tất cả</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="filterDateFrom">Từ ngày</label>
            <input type="date" id="filterDateFrom">
        </div>
        <div class="filter-group">
            <label for="filterDateTo">Tới ngày</label>
            <input type="date" id="filterDateTo">
        </div>
        <div class="filter-group">
            <label for="fixedColumns">Số cột cố định</label>
            <input type="number" id="fixedColumns" value="1" min="0" style="width: 60px;">
        </div>
    </div>

    <div id="tabContainer" class="tab-container"></div>

    <div class="controls">
        <div>
            <button id="refreshData" class="refresh-btn">
                <span class="refresh-icon">↻</span> Load dữ liệu
            </button>
            <!-- MỚI: Nút đồng bộ -->
            <button id="syncChangesBtn">
                Trạng thái thay đổi
                <span id="changesBadge" class="changes-badge">0</span>
            </button>
            <button id="updateAll">Cập nhật tất cả thay đổi</button>
            <button id="downloadExcel">Tải Excel</button>
            <span id="orderCounter" class="order-counter"></span>
            <span id="selectionSummary" class="selection-summary"></span>
        </div>
        <div>
            <button id="toggleTrackingView" class="tab-btn tracking-tab">Xem đơn có mã Tracking</button>
            <!-- NÚT MỚI -->
            <button id="toggleDuplicateTrackingView" class="tab-btn tracking-tab">Xem đơn trùng Mã tracking</button>
            <button id="transferWarehouseBtn" class="tab-btn" disabled
                style="display: none; background-color: #f39c12; color: white;">Chuyển kho</button>
        </div>
    </div>

    <div class="table-wrapper" id="tableContainer">
        <table>
            <thead>
                <tr id="filterRow"></tr>
                <tr>
                    <th>Mã đơn hàng</th>
                    <th>Ngày lên đơn</th>
                    <th>Name*</th>
                    <th>Phone*</th>
                    <th>Add</th>
                    <th>City</th>
                    <th>State</th>
                    <th>Khu vực</th>
                    <th>Zipcode</th>
                    <th>Mặt hàng</th>
                    <th>Tên mặt hàng 1</th>
                    <th>Số lượng mặt hàng 1</th>
                    <th>Tên mặt hàng 2</th>
                    <th>Số lượng mặt hàng 2</th>
                    <th>Quà tặng</th>
                    <th>Số lượng quà kèm</th>
                    <th>Giá bán</th>
                    <th>Loại tiền thanh toán</th>
                    <th>Tổng tiền VNĐ</th>
                    <th>Hình thức thanh toán</th>
                    <th>Ghi chú</th>
                    <th>Ghi chú vận đơn</th>
                    <th>Kết quả check</th>
                    <th>Mã Tracking</th>
                    <th>Ngày đóng hàng</th>
                    <th>Trạng thái giao hàng</th>
                    <th>Thời gian giao dự kiến</th>
                    <th>Ngày Kế toán đối soát với FFM lần 2</th>
                    <th>Phí ship nội địa Mỹ (usd)</th>
                    <th>Phí xử lý đơn đóng hàng-Lưu kho(usd)</th>
                    <th>GHI CHÚ</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <div id="paginationControls" class="pagination-controls">
        <button id="prevPage">Trang trước</button>
        <span id="pageInfo" class="pagination-info">Trang 1/1</span>
        <button id="nextPage">Trang sau</button>
        <div class="pagination-page-size">
            <label for="rowsPerPageSelect">Số dòng/trang:</label>
            <select id="rowsPerPageSelect">
                <option value="50">50</option>
                <option value="70" selected>70</option>
                <option value="100">100</option>
                <option value="200">200</option>
                <option value="500">500</option>
            </select>
        </div>
    </div>

    <div id="toastContainer" class="toast-container"></div>
    
    <!-- MỚI: HTML CHO POPOVER ĐỒNG BỘ -->
    <div id="syncPopover" class="popover-overlay">
        <div class="popover-container">
            <div class="popover-header">
                <h4>Quản lý các thay đổi đang chờ</h4>
                <button id="closePopoverBtn" class="popover-close">&times;</button>
            </div>
            <div id="popoverBody" class="popover-body">
                <!-- Nội dung sẽ được tạo bởi JavaScript -->
            </div>
            <div class="popover-footer">
                <button id="discardAllChangesBtn" style="background-color: #e74c3c;">Hủy bỏ tất cả</button>
                <button id="applyAllChangesBtn" style="background-color: #2ecc71;">Lưu tất cả</button>
            </div>
        </div>
    </div>


    <script>
        const prod = 'https://n-api-gamma.vercel.app'
        const localhost = 'http://localhost:8081'
        const host = 'prod'
        const mainHost = host === 'prod' ? prod : localhost
        const SHEET_NAME = 'F3';
        const BATCH_UPDATE_API_URL = `${mainHost}/sheet/${SHEET_NAME}/update?verbose=true`;
        const SINGLE_UPDATE_API_URL = `${mainHost}/sheet/${SHEET_NAME}/update-single`;
        const TRANSFER_API_URL = `${mainHost}/sheet/MGT nội bộ/rows/batch`;
        const MGT_NOI_BO_ORDER_API_URL = `${mainHost}/sheet/MGT nội bộ/data`;

        const TEAM_COLUMN_NAME = "Team";
        const PRIMARY_KEY_COLUMN = "Mã đơn hàng";

        const displayColumns = ["Mã đơn hàng", "Ngày lên đơn", "Name*", "Phone*", "Add", "City", "State", "Khu vực", "Zipcode", "Mặt hàng", "Tên mặt hàng 1", "Số lượng mặt hàng 1", "Tên mặt hàng 2", "Số lượng mặt hàng 2", "Quà tặng", "Số lượng quà kèm", "Giá bán", "Loại tiền thanh toán", "Tổng tiền VNĐ", "Hình thức thanh toán", "Ghi chú", "Ghi chú vận đơn", "Kết quả check", "Mã Tracking", "Ngày đóng hàng", "Trạng thái giao hàng", "Thời gian giao dự kiến", "Ngày Kế toán đối soát với FFM lần 2", "Phí ship nội địa Mỹ (usd)", "Phí xử lý đơn đóng hàng-Lưu kho(usd)", "GHI CHÚ"];
        const columnMapping = { "Ghi chú vận đơn": "ngày hẹn đẩy đơn", "Kết quả check": "Kết quả Check" };

        const editableCols = ["Kết quả check", "Mã Tracking", "Ngày đóng hàng", "Trạng thái giao hàng", "Thời gian giao dự kiến", "Phí ship nội địa Mỹ (usd)", "Phí xử lý đơn đóng hàng-Lưu kho(usd)", "GHI CHÚ"];
        const checkStatusOptions = ["", "OK", "Huỷ", "Chờ check lại", "Sai SĐT", "Sai địa chỉ", "Khác"];


        // ===== STATE MANAGEMENT REFACTORED =====
        let state = {
            allData: [],
            // SỬA ĐỔI: Tách thành 2 loại thay đổi
            legacyChanges: new Map(),      // Thay đổi từ phiên trước, đọc từ localStorage
            pendingChanges: new Map(),     // Thay đổi trong phiên làm việc hiện tại
            activeTeam: 'all',
            showTrackingOrders: false,
            showDuplicateTrackingOrders: false, // <-- STATE MỚI
            filterValues: {},
            mgtNoiBoOrder: [],
            isMgtNoiBoOrderLoading: false,
            currentPage: 1,
            rowsPerPage: 70,
            totalFilteredOrders: 0
        };
        let pasteAnchorCell = null;
        let isUpdatingSingleCell = false;
        let isPasting = false;


        // --- HÀM THÔNG BÁO TOAST ---
        function showCustomAlert(message, type = 'info', duration = 3000) { const container = document.getElementById('toastContainer'); const toast = document.createElement('div'); toast.className = `toast ${type}`; const messageSpan = document.createElement('span'); messageSpan.textContent = message; const closeBtn = document.createElement('button'); closeBtn.className = 'toast-close'; closeBtn.innerHTML = '×'; closeBtn.onclick = () => removeToast(toast); toast.appendChild(messageSpan); toast.appendChild(closeBtn); container.appendChild(toast); setTimeout(() => { toast.classList.add('show'); }, 10); if (duration > 0) { setTimeout(() => { removeToast(toast); }, duration); } return toast; }
        function removeToast(toast) { if (!toast || !toast.parentNode) return; toast.classList.remove('show'); setTimeout(() => { if (toast.parentNode) { toast.parentNode.removeChild(toast); } }, 300); }
        function clearAllToasts() { const container = document.getElementById('toastContainer'); const toasts = container.querySelectorAll('.toast'); toasts.forEach(toast => removeToast(toast)); }

        // --- CÁC HÀM UTILITY ---
        function formatDate(dateString) { if (!dateString) return ''; try { const date = new Date(dateString.includes('Z') ? dateString : dateString + 'Z'); if (isNaN(date.getTime())) return dateString; const day = String(date.getDate()).padStart(2, '0'); const month = String(date.getMonth() + 1).padStart(2, '0'); const year = date.getFullYear(); return `${day}/${month}/${year}`; } catch (e) { return dateString; } }
        function parseDateToISO(dateString) { if (!dateString || dateString.length === 0) return ''; const parts = dateString.split('/'); if (parts.length === 3) { const day = parseInt(parts[0], 10); const month = parseInt(parts[1], 10) - 1; const year = parseInt(parts[2], 10); const date = new Date(year, month, day); if (!isNaN(date.getTime())) { return date.toISOString().split('T')[0]; } } return dateString; }
        function updateOrderCounter(count) { const counterElement = document.getElementById('orderCounter'); if (counterElement) { counterElement.innerHTML = `Tổng số đơn: <b>${count}</b>`; } }


        // --- LOCAL STORAGE HANDLING ---
        function savePendingChangesToLocalStorage() {
            const serializableChanges = {};
            // SỬA ĐỔI: Gộp cả 2 loại thay đổi vào localStorage
            const allChanges = new Map([...state.legacyChanges, ...state.pendingChanges]);
            allChanges.forEach((colChanges, orderId) => {
                serializableChanges[orderId] = {};
                colChanges.forEach((changeInfo, colName) => {
                    serializableChanges[orderId][colName] = {
                        newValue: changeInfo.newValue,
                        originalValue: changeInfo.originalValue,
                    };
                });
            });
            localStorage.setItem('speegoPendingChanges', JSON.stringify(serializableChanges));
            updateSyncButtonBadge(); // MỚI: Cập nhật badge mỗi khi lưu
        }

        function loadPendingChangesFromLocalStorage() {
            const storedChanges = localStorage.getItem('speegoPendingChanges');
            if (storedChanges) {
                try {
                    const parsedChanges = JSON.parse(storedChanges);
                    // SỬA ĐỔI: Chỉ load vào legacyChanges, không động đến pendingChanges
                    state.legacyChanges.clear();
                    for (const orderId in parsedChanges) {
                        const colChangesMap = new Map();
                        for (const colName in parsedChanges[orderId]) {
                            colChangesMap.set(colName, {
                                newValue: parsedChanges[orderId][colName].newValue,
                                originalValue: parsedChanges[orderId][colName].originalValue,
                                cellElement: null
                            });
                        }
                        state.legacyChanges.set(orderId, colChangesMap);
                    }
                    updateSyncButtonBadge(); // MỚI: Cập nhật badge sau khi load
                } catch (e) {
                    console.error("Lỗi khi đọc lịch sử thay đổi từ localStorage:", e);
                    localStorage.removeItem('speegoPendingChanges');
                }
            }
        }

        // --- XỬ LÝ DỮ LIỆU VÀ LỌC ---
        function handleData(response) {
            document.getElementById('refreshData').disabled = false;
            document.getElementById('refreshData').innerHTML = '<span class="refresh-icon">↻</span> Load dữ liệu';
            state.allData = [];
            if (response.error) { showCustomAlert(`Lỗi tải dữ liệu: ${response.error}`, 'error'); return; }
            const data = response.rows || response.data || response;
            if (!Array.isArray(data)) { showCustomAlert('Dữ liệu trả về không hợp lệ.', 'error'); return; }
            state.allData = data;
            
            // SỬA ĐỔI: Không tự động áp dụng thay đổi từ localStorage vào bảng nữa.
            // Chỉ cần load và hiển thị badge.
            loadPendingChangesFromLocalStorage();

            const initialDataForFilters = filterByCarrier(state.allData);
            populateMainFilters(initialDataForFilters);
            createTabs(initialDataForFilters);
            setupColumnFilters();
            if (state.activeTeam === 'mgt_noi_bo' && state.mgtNoiBoOrder.length === 0 && !state.isMgtNoiBoOrderLoading) {
                fetchMGTNoiBoOrder().then(render);
            } else {
                render();
            }
        }

        function filterByCarrier(data) { /* ... Giữ nguyên ... */ return data.filter(row => { const carrier = row["Đơn vị vận chuyển"] || row["Đơn_vị_vận_chuyển"]; return carrier?.toString().toUpperCase() === "MGT"; }); }
        async function fetchMGTNoiBoOrder() { /* ... Giữ nguyên ... */ if (state.isMgtNoiBoOrderLoading) return; state.isMgtNoiBoOrderLoading = true; const loadingToast = showCustomAlert('Đang tải danh sách đơn hàng nội bộ...', 'info', 0); try { const response = await fetch(MGT_NOI_BO_ORDER_API_URL); if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); } const json = await response.json(); if (json.data && Array.isArray(json.data)) { state.mgtNoiBoOrder = json.data.map(row => row[PRIMARY_KEY_COLUMN]).filter(Boolean); removeToast(loadingToast); showCustomAlert('Đã tải danh sách đơn hàng nội bộ.', 'success', 2000); } else { state.mgtNoiBoOrder = []; removeToast(loadingToast); showCustomAlert('Không thể tải danh sách đơn hàng nội bộ hoặc dữ liệu không hợp lệ.', 'error'); } } catch (e) { console.error('Lỗi khi tải dữ liệu MGT Nội Bộ:', e); removeToast(loadingToast); showCustomAlert(`Lỗi kết nối khi tải danh sách đơn hàng nội bộ: ${e.message}`, 'error'); state.mgtNoiBoOrder = []; } finally { state.isMgtNoiBoOrderLoading = false; } }
        function populateMainFilters(data) { /* ... Giữ nguyên ... */ const marketFilter = document.getElementById('filterMarket'); const productFilter = document.getElementById('filterProduct'); const markets = [...new Set(data.map(row => row["Khu vực"]).filter(Boolean))].sort(); const products = [...new Set(data.map(row => row["Mặt hàng"]).filter(Boolean))].sort(); marketFilter.innerHTML = '<option value="">Tất cả Thị trường</option>'; productFilter.innerHTML = '<option value="">Tất cả Sản phẩm</option>'; markets.forEach(market => marketFilter.innerHTML += `<option value="${market}">${market}</option>`); products.forEach(product => productFilter.innerHTML += `<option value="${product}">${product}</option>`); }

        function getFilteredData() {
            const dataToFilter = [...state.allData];
            const mgtData = filterByCarrier(dataToFilter);
            
            let dataToRender = mgtData;

            // Áp dụng các bộ lọc chính và bộ lọc cột trước
            const market = document.getElementById('filterMarket').value; 
            const product = document.getElementById('filterProduct').value; 
            const dateFrom = document.getElementById('filterDateFrom').value; 
            const dateTo = document.getElementById('filterDateTo').value;
            if (market) { dataToRender = dataToRender.filter(row => row["Khu vực"] === market); }
            if (product) { dataToRender = dataToRender.filter(row => row["Mặt hàng"] === product); }
            if (dateFrom) { const from = new Date(dateFrom); from.setHours(0, 0, 0, 0); dataToRender = dataToRender.filter(row => row["Ngày lên đơn"] && new Date(row["Ngày lên đơn"]) >= from); }
            if (dateTo) { const to = new Date(dateTo); to.setHours(23, 59, 59, 999); dataToRender = dataToRender.filter(row => row["Ngày lên đơn"] && new Date(row["Ngày lên đơn"]) <= to); }
            if (state.activeTeam === 'mgt_noi_bo') { if (state.mgtNoiBoOrder.length === 0 && !state.isMgtNoiBoOrderLoading) { state.totalFilteredOrders = 0; return []; } const orderedIds = new Set(state.mgtNoiBoOrder); dataToRender = dataToRender.filter(row => orderedIds.has(row["Mã đơn hàng"])); const orderIndexMap = new Map(state.mgtNoiBoOrder.map((id, index) => [id, index])); dataToRender.sort((a, b) => { const indexA = orderIndexMap.get(a[PRIMARY_KEY_COLUMN]); const indexB = orderIndexMap.get(b[PRIMARY_KEY_COLUMN]); return indexA - indexB; }); } else if (state.activeTeam !== 'all') { dataToRender = dataToRender.filter(row => row[TEAM_COLUMN_NAME] === state.activeTeam); }
            
            const trackingIncludeRaw = state.filterValues['tracking_include'] || ''; 
            const trackingExcludeRaw = state.filterValues['tracking_exclude'] || ''; 
            
            // --- SỬA ĐỔI PHẦN LỌC CỘT ---
            const otherColumnFilters = Object.entries(state.filterValues)
                .filter(([key, val]) => !key.startsWith('tracking_') && ( (Array.isArray(val) && val.length > 0) || (typeof val === 'string' && val.trim() !== '') ));

            if (otherColumnFilters.length > 0) {
                dataToRender = dataToRender.filter(row => {
                    return otherColumnFilters.every(([col, filterValue]) => {
                        const dataKey = columnMapping[col] || col;
                        const cellValue = (row[dataKey] ?? row[col] ?? row[dataKey.replace(/ /g, '_')] ?? '').toString().trim();

                        if (dataKey === "Trạng thái giao hàng") { // Logic lọc đặc biệt cho cột này
                            const EMPTY_OPTION_VALUE = '__EMPTY__';
                            const selectedStatuses = filterValue; // Đây là một mảng

                            if (selectedStatuses.length === 0) return true; // Nếu mảng rỗng thì không lọc

                            const hasEmptyFilter = selectedStatuses.includes(EMPTY_OPTION_VALUE);
                            
                            // Nếu ô trống và người dùng chọn "(Trống)"
                            if (cellValue === '' && hasEmptyFilter) {
                                return true;
                            }
                            
                            // Nếu giá trị của ô có trong danh sách được chọn
                            if (selectedStatuses.includes(cellValue)) {
                                return true;
                            }

                            return false; // Không khớp điều kiện nào
                        } else { // Logic lọc cũ cho các cột khác
                            return cellValue.toLowerCase().includes(filterValue.toLowerCase());
                        }
                    });
                });
            }
            // --- KẾT THÚC SỬA ĐỔI ---

            if (trackingIncludeRaw || trackingExcludeRaw) { const lowerInclude = trackingIncludeRaw.toLowerCase(); const lowerExclude = trackingExcludeRaw.toLowerCase(); dataToRender = dataToRender.filter(row => { const cellValue = String(row['Mã Tracking'] || ''); const lowerCellValue = cellValue.toLowerCase(); if (lowerExclude && lowerCellValue.includes(lowerExclude)) { return false; } if (lowerInclude) { if (lowerInclude.includes('\n')) { const codes = new Set(trackingIncludeRaw.split('\n').map(t => t.trim()).filter(Boolean)); if (!codes.has(cellValue.trim())) return false; } else { if (!lowerCellValue.includes(lowerInclude)) return false; } } return true; }); }
            
            // <-- LOGIC MỚI: Xử lý các chế độ xem tracking -->
            if (state.showDuplicateTrackingOrders) {
                const trackingCounts = new Map();
                dataToRender.forEach(row => {
                    const trackingCode = String(row["Mã Tracking"] || '').trim();
                    if (trackingCode) {
                        trackingCounts.set(trackingCode, (trackingCounts.get(trackingCode) || 0) + 1);
                    }
                });
                const duplicateTrackings = new Set();
                for (const [code, count] of trackingCounts.entries()) {
                    if (count > 1) {
                        duplicateTrackings.add(code);
                    }
                }
                dataToRender = dataToRender.filter(row => {
                    const trackingCode = String(row["Mã Tracking"] || '').trim();
                    return duplicateTrackings.has(trackingCode);
                });
            } else { // Chỉ áp dụng bộ lọc có/không có tracking khi không ở chế độ xem trùng
                 dataToRender = dataToRender.filter(row => {
                    const trackingCode = String(row["Mã Tracking"] || row["Mã_Tracking"] || '');
                    return state.showTrackingOrders ? trackingCode.trim() !== '' : !trackingCode.trim();
                });
            }
            // <-- KẾT THÚC LOGIC MỚI -->

            if (state.activeTeam !== 'mgt_noi_bo') { const primarySortKey = 'Ngày Kế toán đối soát với FFM lần 2'; const secondarySortKey = PRIMARY_KEY_COLUMN; dataToRender.sort((a, b) => { const parseDate = (val) => { if (!val) return null; const date = new Date(val); return isNaN(date.getTime()) ? null : date; }; const dateA = parseDate(a[primarySortKey]); const dateB = parseDate(b[primarySortKey]); if (dateA === null && dateB === null) { } else if (dateA === null) { return 1; } else if (dateB === null) { return -1; } else { const dateComparison = dateA.getTime() - dateB.getTime(); if (dateComparison !== 0) { return dateComparison; } } const orderIdA = a[secondarySortKey] || ''; const orderIdB = b[secondarySortKey] || ''; return orderIdA.localeCompare(orderIdB); }); }
            
            state.totalFilteredOrders = dataToRender.length;
            const startIndex = (state.currentPage - 1) * state.rowsPerPage;
            const endIndex = startIndex + state.rowsPerPage;
            return dataToRender.slice(startIndex, endIndex);
        }

        // --- HÀM CỐ ĐỊNH CỘT ĐỘNG ---
        function updateFixedColumns() { /* ... Giữ nguyên ... */ const numFixed = parseInt(document.getElementById('fixedColumns').value, 10); const table = document.querySelector('.table-wrapper table'); if (!table) return; const rows = Array.from(table.rows); rows.forEach(row => { Array.from(row.cells).forEach(cell => { cell.classList.remove('fixed-column'); cell.style.left = ''; }); }); if (numFixed <= 0 || rows.length < 2) return; const headerCells = rows[1].cells; const offsets = [0]; for (let i = 1; i < numFixed; i++) { if (headerCells[i - 1]) { offsets[i] = offsets[i - 1] + headerCells[i - 1].offsetWidth; } } rows.forEach(row => { for (let i = 0; i < numFixed; i++) { const cell = row.cells[i]; if (cell) { cell.classList.add('fixed-column'); cell.style.left = `${offsets[i] || 0}px`; } } }); }

        // --- RENDER GIAO DIỆN ---
        function render() {
            const paginatedData = getFilteredData();
            const container = document.getElementById('tableBody');
            container.innerHTML = '';
            if (paginatedData.length === 0) { /* ... Giữ nguyên ... */ let message = 'Không có dữ liệu phù hợp'; if (state.activeTeam === 'mgt_noi_bo' && state.isMgtNoiBoOrderLoading) { message = 'Đang tải danh sách đơn hàng nội bộ...'; } container.innerHTML = `<tr><td colspan="${displayColumns.length}" class="no-data">${message}</td></tr>`; updateOrderCounter(state.totalFilteredOrders); updatePaginationControls(); return; }
            updateOrderCounter(state.totalFilteredOrders);
            
            paginatedData.forEach((row) => {
                const tr = document.createElement('tr');
                const orderId = row[PRIMARY_KEY_COLUMN];
                tr.dataset.orderId = orderId;

                displayColumns.forEach(col => {
                    const td = document.createElement('td');
                    const dataKey = columnMapping[col] || col;
                    const originalValue = String(row[dataKey] ?? row[col] ?? row[col.replace(/ /g, '_')] ?? '');

                    // SỬA ĐỔI: Kiểm tra xem có giá trị mới trong pendingChanges hoặc legacyChanges không
                    const pendingChange = state.pendingChanges.get(orderId)?.get(dataKey) || state.legacyChanges.get(orderId)?.get(dataKey);
                    let displayValue = pendingChange ? pendingChange.newValue : originalValue;

                    if (["Ngày lên đơn", "Ngày đóng hàng"].includes(col)) {
                        displayValue = formatDate(displayValue);
                    }

                    if (col === "Ghi chú vận đơn" && displayValue) { td.classList.add('note-highlight'); }
                    const checkValue = String(displayValue).trim().toLowerCase();
                    td.classList.remove('status-ok', 'status-cancel');
                    if (col === "Kết quả check") { if (checkValue === 'ok') td.classList.add('status-ok'); else if (checkValue.includes('huỷ')) td.classList.add('status-cancel'); }
                    
                    if (editableCols.includes(col)) {
                        td.classList.add('editable');
                        if (pendingChange) {
                            td.classList.add('highlight');
                            pendingChange.cellElement = td;
                        } else {
                            td.classList.remove('highlight');
                        }

                        // SỬA ĐỔI: Toàn bộ logic `handleCellChange` đã được cải tiến
                        const handleCellChange = (newValue, element) => {
                            if (isUpdatingSingleCell) return;
                            
                            let finalValueForState = newValue;
                            if (col === "Ngày đóng hàng" && newValue) {
                                // Giá trị từ input type date là 'YYYY-MM-DD', chuyển đổi nếu cần
                                finalValueForState = new Date(newValue).toLocaleDateString('en-US'); 
                            } else {
                                finalValueForState = String(newValue);
                            }

                            // SỬA ĐỔI CỐT LÕI: Luôn tìm và so sánh với dữ liệu gốc từ state.allData
                            const originalRowData = state.allData.find(r => r[PRIMARY_KEY_COLUMN] === orderId);
                            const trueOriginalValue = originalRowData ? String(originalRowData[dataKey] ?? '') : '';

                            const isChanged = finalValueForState !== trueOriginalValue;

                            if (isChanged) {
                                if (!state.pendingChanges.has(orderId)) {
                                    state.pendingChanges.set(orderId, new Map());
                                }
                                const changeInfo = {
                                    newValue: finalValueForState,
                                    originalValue: trueOriginalValue,
                                    cellElement: td
                                };
                                state.pendingChanges.get(orderId).set(dataKey, changeInfo);
                                td.classList.add('highlight');
                                savePendingChangesToLocalStorage();
                                
                                // THAY ĐỔI: Kiểm tra nếu là cột "Mã Tracking" thì không tự động cập nhật
                                const isTrackingColumn = col === "Mã Tracking" || dataKey === "Mã Tracking";
                                if (!isPasting && !isTrackingColumn) {
                                    handleSingleCellUpdate(orderId, dataKey, finalValueForState, td);
                                } else if (isTrackingColumn) {
                                    showCustomAlert('Thay đổi Mã Tracking đã được lưu. Vui lòng bấm "Cập nhật tất cả" để gửi dữ liệu.', 'info', 4000);
                                }
                            } else {
                                // Nếu giá trị quay về gốc, xóa khỏi pending changes
                                const orderChanges = state.pendingChanges.get(orderId);
                                if (orderChanges) {
                                    orderChanges.delete(dataKey);
                                    if (orderChanges.size === 0) state.pendingChanges.delete(orderId);
                                }
                                // Cũng có thể nó nằm trong legacy, cần xóa cả ở đó
                                const legacyOrderChanges = state.legacyChanges.get(orderId);
                                if (legacyOrderChanges) {
                                    legacyOrderChanges.delete(dataKey);
                                    if (legacyOrderChanges.size === 0) state.legacyChanges.delete(orderId);
                                }
                                td.classList.remove('highlight');
                                savePendingChangesToLocalStorage();
                            }
                            updateSelectionSummary();
                        };

                        // ... phần render select/input giữ nguyên ...
                        if (col === "Kết quả check") {
                            td.classList.add('editable-dropdown-cell');
                            const select = document.createElement('select');
                            select.className = 'editable-select';
                            const currentVal = String(displayValue);
                            const optionsToAdd = new Set(checkStatusOptions);
                            if (currentVal && !optionsToAdd.has(currentVal)) {
                                optionsToAdd.add(currentVal);
                            }
                            Array.from(optionsToAdd).sort().forEach(opt => {
                                const option = document.createElement('option');
                                option.value = opt; option.textContent = opt;
                                if (opt.toLowerCase() === currentVal.toLowerCase()) { option.selected = true; }
                                select.appendChild(option);
                            });
                            select.addEventListener('change', () => {
                                handleCellChange(select.value, select);
                                const selectedVal = select.value.toLowerCase();
                                td.classList.remove('status-ok', 'status-cancel');
                                if (selectedVal === 'ok') td.classList.add('status-ok');
                                else if (selectedVal.includes('huỷ')) td.classList.add('status-cancel');
                            });
                            td.innerHTML = '';
                            td.appendChild(select);
                        } else if (col === "Ngày đóng hàng") {
                            const input = document.createElement('input');
                            input.type = 'date';
                            input.className = 'date-input';
                            // Giá trị cho input date phải là YYYY-MM-DD
                            try {
                                if (displayValue) {
                                    const dateParts = displayValue.split('/');
                                    if (dateParts.length === 3) {
                                       input.value = `${dateParts[2]}-${dateParts[1].padStart(2, '0')}-${dateParts[0].padStart(2, '0')}`;
                                    } else if (new Date(displayValue) != "Invalid Date") {
                                       input.value = new Date(displayValue).toISOString().split('T')[0];
                                    }
                                }
                            } catch (e) { /* ignore invalid date */ }
                            td.style.padding = '0';
                            input.style.padding = '8px 12px';
                            input.addEventListener('change', () => handleCellChange(input.value, input));
                            input.addEventListener('blur', () => handleCellChange(input.value, input));
                            td.innerHTML = '';
                            td.appendChild(input);
                        } else {
                            td.contentEditable = 'true';
                            td.textContent = displayValue;
                            td.addEventListener('blur', () => handleCellChange(td.textContent, td));
                        }
                    } else {
                        td.textContent = displayValue;
                    }
                    tr.appendChild(td);
                });
                container.appendChild(tr);
            });
            updateFixedColumns();
            updatePaginationControls();
        }

        // --- Cập nhật và phân trang ---
        function updatePaginationControls() { /* ... Giữ nguyên ... */ const prevBtn = document.getElementById('prevPage'); const nextPage = document.getElementById('nextPage'); const pageInfo = document.getElementById('pageInfo'); const rowsPerPageSelect = document.getElementById('rowsPerPageSelect'); const totalPages = Math.ceil(state.totalFilteredOrders / state.rowsPerPage); pageInfo.textContent = `Trang ${state.currentPage}/${totalPages || 1}`; prevBtn.disabled = state.currentPage <= 1; nextPage.disabled = state.currentPage >= totalPages; rowsPerPageSelect.value = state.rowsPerPage; }
        async function handleSingleCellUpdate(orderId, columnKey, newValue, cellElement) { /* ... Giữ nguyên ... */ if (isUpdatingSingleCell) return; isUpdatingSingleCell = true; document.getElementById('updateAll').disabled = true; const loadingToast = showCustomAlert('Đang cập nhật...', 'info', 0); try { const payload = { [PRIMARY_KEY_COLUMN]: orderId, [columnKey]: newValue }; const response = await fetch(SINGLE_UPDATE_API_URL, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); if (!response.ok) { const errorResponse = await response.json(); throw new Error(errorResponse.message || `Lỗi HTTP! status: ${response.status}`); } const result = await response.json(); if (result.success) { const originalRowIndex = state.allData.findIndex(r => r[PRIMARY_KEY_COLUMN] === orderId); if (originalRowIndex !== -1) { state.allData[originalRowIndex] = { ...state.allData[originalRowIndex], [columnKey]: newValue }; } const orderChanges = state.pendingChanges.get(orderId); if (orderChanges) { orderChanges.delete(columnKey); if (orderChanges.size === 0) { state.pendingChanges.delete(orderId); } } cellElement.classList.remove('highlight'); savePendingChangesToLocalStorage(); removeToast(loadingToast); showCustomAlert('Cập nhật thành công!', 'success', 2000); } else { removeToast(loadingToast); showCustomAlert(`Lỗi cập nhật: ${result.message || 'Lỗi không xác định.'}`, 'error'); } } catch (error) { console.error('Lỗi khi cập nhật đơn lẻ:', error); removeToast(loadingToast); showCustomAlert(`Lỗi kết nối: ${error.message}`, 'error'); } finally { isUpdatingSingleCell = false; document.getElementById('updateAll').disabled = false; } }
        
        // --- Tabs và Filters ---
        function createTabs(data) { /* ... Giữ nguyên ... */ const tabContainer = document.getElementById('tabContainer'); tabContainer.innerHTML = ''; const teams = [...new Set(data.map(row => row[TEAM_COLUMN_NAME]).filter(Boolean))].sort(); const createTab = (name, value) => { const button = document.createElement('button'); button.className = 'tab-btn'; button.textContent = name; button.dataset.team = value; if (value === state.activeTeam) { button.classList.add('active'); } button.addEventListener('click', async () => { state.activeTeam = value; state.currentPage = 1; document.querySelectorAll('#tabContainer .tab-btn').forEach(btn => btn.classList.remove('active')); button.classList.add('active'); if (value === 'mgt_noi_bo' && state.mgtNoiBoOrder.length === 0 && !state.isMgtNoiBoOrderLoading) { await fetchMGTNoiBoOrder(); } render(); }); return button; }; tabContainer.appendChild(createTab('Tất cả', 'all')); tabContainer.appendChild(createTab('MGT nội bộ', 'mgt_noi_bo')); teams.forEach(team => tabContainer.appendChild(createTab(team, team))); }
        
        function setupColumnFilters() {
            const filterRow = document.getElementById('filterRow');
            filterRow.innerHTML = '';
            const storedFilterValues = localStorage.getItem('speegoColumnFilters');
            if (storedFilterValues) {
                try {
                    state.filterValues = JSON.parse(storedFilterValues);
                } catch (e) {
                    console.error("Lỗi khi đọc filterValues từ localStorage:", e);
                    state.filterValues = {};
                }
            } else {
                state.filterValues = {};
            }
            displayColumns.forEach((col) => {
                const th = document.createElement('th');

                if (col === "Mã Tracking") {
                    const container = document.createElement('div');
                    container.className = 'dual-filter-container';
                    const includeInput = document.createElement('input');
                    includeInput.type = 'text';
                    includeInput.className = 'filter-input';
                    includeInput.placeholder = 'Bao gồm...';
                    includeInput.value = state.filterValues['tracking_include'] || '';
                    includeInput.addEventListener('input', () => {
                        state.filterValues['tracking_include'] = includeInput.value;
                        localStorage.setItem('speegoColumnFilters', JSON.stringify(state.filterValues));
                        state.currentPage = 1;
                        render();
                    });
                    const excludeInput = document.createElement('input');
                    excludeInput.type = 'text';
                    excludeInput.className = 'filter-input';
                    excludeInput.placeholder = 'Loại trừ...';
                    excludeInput.value = state.filterValues['tracking_exclude'] || '';
                    excludeInput.addEventListener('input', () => {
                        state.filterValues['tracking_exclude'] = excludeInput.value;
                        localStorage.setItem('speegoColumnFilters', JSON.stringify(state.filterValues));
                        state.currentPage = 1;
                        render();
                    });
                    container.appendChild(includeInput);
                    container.appendChild(excludeInput);
                    th.appendChild(container);
                } else if (col === "Trạng thái giao hàng") {
                    // --- BẮT ĐẦU PHẦN THÊM MỚI ---
                    const dataKey = columnMapping[col] || col;
                    const ALL_OPTION_TEXT = 'Tất cả';
                    const EMPTY_OPTION_TEXT = '(Trống)';
                    const EMPTY_OPTION_VALUE = '__EMPTY__'; // Giá trị đặc biệt để đại diện cho ô trống

                    const container = document.createElement('div');
                    container.className = 'multiselect-filter';

                    const display = document.createElement('button');
                    display.className = 'multiselect-display';
                    
                    const dropdown = document.createElement('div');
                    dropdown.className = 'multiselect-dropdown';

                    // Lấy các giá trị duy nhất từ dữ liệu
                    const uniqueStatuses = [...new Set(state.allData.map(row => (row[dataKey] || '').trim()).filter(Boolean))].sort();
                    const options = [ALL_OPTION_TEXT, EMPTY_OPTION_TEXT, ...uniqueStatuses];
                    
                    let selectedValues = state.filterValues[dataKey] || [];

                    const updateDisplay = () => {
                        if (selectedValues.length === 0 || selectedValues.length === (uniqueStatuses.length + 1) ) { // +1 cho lựa chọn (Trống)
                             display.textContent = 'Lọc ' + col;
                             if(selectedValues.length === (uniqueStatuses.length + 1)){
                                 //Nếu tất cả được chọn (trừ "Tất cả"), coi như không lọc
                                 state.filterValues[dataKey] = [];
                             }
                        } else if (selectedValues.length === 1) {
                            if (selectedValues[0] === EMPTY_OPTION_VALUE) {
                                display.textContent = EMPTY_OPTION_TEXT;
                            } else {
                                display.textContent = selectedValues[0];
                            }
                        } else {
                            display.textContent = `${selectedValues.length} đã chọn`;
                        }
                    };
                    
                    options.forEach(optionText => {
                        const item = document.createElement('div');
                        item.className = 'multiselect-item';
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        const label = document.createElement('label');

                        checkbox.id = `filter-${dataKey}-${optionText}`;
                        label.htmlFor = `filter-${dataKey}-${optionText}`;
                        label.textContent = optionText;
                        
                        let optionValue = optionText;
                        if(optionText === EMPTY_OPTION_TEXT) optionValue = EMPTY_OPTION_VALUE;

                        if (optionText === ALL_OPTION_TEXT) {
                            checkbox.checked = selectedValues.length === (uniqueStatuses.length + 1);
                        } else {
                            checkbox.checked = selectedValues.includes(optionValue);
                        }
                        
                        item.appendChild(checkbox);
                        item.appendChild(label);
                        dropdown.appendChild(item);
                    });

                    dropdown.addEventListener('change', (e) => {
                        const targetCheckbox = e.target;
                        const optionText = targetCheckbox.parentElement.textContent;
                        let optionValue = optionText;
                        if(optionText === EMPTY_OPTION_TEXT) optionValue = EMPTY_OPTION_VALUE;

                        if (optionText === ALL_OPTION_TEXT) {
                            const allCheckboxes = dropdown.querySelectorAll('input[type="checkbox"]');
                            selectedValues = [];
                            if (targetCheckbox.checked) {
                                allCheckboxes.forEach(cb => {
                                    cb.checked = true;
                                    const text = cb.parentElement.textContent;
                                    if(text !== ALL_OPTION_TEXT) {
                                        selectedValues.push(text === EMPTY_OPTION_TEXT ? EMPTY_OPTION_VALUE : text);
                                    }
                                });
                            } else {
                                allCheckboxes.forEach(cb => cb.checked = false);
                            }
                        } else {
                            if (targetCheckbox.checked) {
                                if (!selectedValues.includes(optionValue)) {
                                    selectedValues.push(optionValue);
                                }
                            } else {
                                selectedValues = selectedValues.filter(v => v !== optionValue);
                            }
                            // Cập nhật checkbox "Tất cả"
                            const allCheckbox = dropdown.querySelector(`input[id="filter-${dataKey}-${ALL_OPTION_TEXT}"]`);
                            allCheckbox.checked = selectedValues.length === uniqueStatuses.length + 1;
                        }
                        
                        state.filterValues[dataKey] = selectedValues;
                        localStorage.setItem('speegoColumnFilters', JSON.stringify(state.filterValues));
                        updateDisplay();
                        state.currentPage = 1;
                        render();
                    });

                    display.addEventListener('click', (e) => {
                        e.stopPropagation();
                        dropdown.classList.toggle('show');
                    });
                    
                    container.appendChild(display);
                    container.appendChild(dropdown);
                    th.appendChild(container);
                    updateDisplay();
                    // --- KẾT THÚC PHẦN THÊM MỚI ---
                } else {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'filter-input';
                    input.placeholder = `Lọc ${col}`;
                    input.dataset.column = col;
                    input.value = state.filterValues[col] || '';
                    input.addEventListener('input', () => {
                        state.filterValues[col] = input.value;
                        localStorage.setItem('speegoColumnFilters', JSON.stringify(state.filterValues));
                        state.currentPage = 1;
                        render();
                    });
                    th.appendChild(input);
                }
                filterRow.appendChild(th);
            });

            // Thêm event listener để đóng dropdown khi click ra ngoài
            document.addEventListener('click', (e) => {
                document.querySelectorAll('.multiselect-dropdown.show').forEach(dropdown => {
                    if (!dropdown.parentElement.contains(e.target)) {
                        dropdown.classList.remove('show');
                    }
                });
            });
        }
        
        // MỚI: Cập nhật số lượng trên badge của nút đồng bộ
        function updateSyncButtonBadge() {
            const badge = document.getElementById('changesBadge');
            const totalChanges = state.legacyChanges.size + state.pendingChanges.size;
            if (totalChanges > 0) {
                badge.textContent = totalChanges;
                badge.style.display = 'block';
            } else {
                badge.style.display = 'none';
            }
        }

        // --- CÁC HÀM ĐIỀU KHIỂN ---
        function setupControls() {
            document.getElementById('refreshData').addEventListener('click', refreshData);
            document.getElementById('updateAll').addEventListener('click', updateAllChangedRows);
            document.getElementById('toggleTrackingView').addEventListener('click', () => { toggleTrackingView(); state.currentPage = 1; });
            // <-- EVENT LISTENER MỚI -->
            document.getElementById('toggleDuplicateTrackingView').addEventListener('click', () => { toggleDuplicateTrackingView(); state.currentPage = 1; });

            document.getElementById('filterMarket').addEventListener('change', () => { state.currentPage = 1; render(); });
            document.getElementById('filterProduct').addEventListener('change', () => { state.currentPage = 1; render(); });
            document.getElementById('filterDateFrom').addEventListener('change', () => { state.currentPage = 1; render(); });
            document.getElementById('filterDateTo').addEventListener('change', () => { state.currentPage = 1; render(); });
            document.getElementById('downloadExcel').addEventListener('click', downloadAsExcel);
            document.getElementById('fixedColumns').addEventListener('change', updateFixedColumns);
            document.getElementById('transferWarehouseBtn').addEventListener('click', transferSelectedOrders);
            document.getElementById('prevPage').addEventListener('click', () => { if (state.currentPage > 1) { state.currentPage--; render(); } });
            document.getElementById('nextPage').addEventListener('click', () => { const totalPages = Math.ceil(state.totalFilteredOrders / state.rowsPerPage); if (state.currentPage < totalPages) { state.currentPage++; render(); } });
            document.getElementById('rowsPerPageSelect').addEventListener('change', (e) => { state.rowsPerPage = parseInt(e.target.value, 10); state.currentPage = 1; render(); });
            
            // MỚI: Event listeners cho popover
            const popover = document.getElementById('syncPopover');
            document.getElementById('syncChangesBtn').addEventListener('click', showSyncPopover);
            document.getElementById('closePopoverBtn').addEventListener('click', () => popover.style.display = 'none');
            document.getElementById('applyAllChangesBtn').addEventListener('click', () => {
                updateAllChangedRows();
                popover.style.display = 'none';
            });
            document.getElementById('discardAllChangesBtn').addEventListener('click', () => {
                if (confirm('Bạn có chắc chắn muốn hủy bỏ TẤT CẢ các thay đổi chưa được lưu? Hành động này không thể hoàn tác.')) {
                    state.pendingChanges.clear();
                    state.legacyChanges.clear();
                    localStorage.removeItem('speegoPendingChanges');
                    updateSyncButtonBadge();
                    render();
                    popover.style.display = 'none';
                    showCustomAlert('Đã hủy bỏ tất cả thay đổi.', 'info');
                }
            });
            popover.addEventListener('click', (e) => {
                if (e.target === popover) {
                    popover.style.display = 'none';
                }
            });
        }

        async function loadData() { /* ... Giữ nguyên ... */ document.getElementById('tableBody').innerHTML = `<tr><td colspan="${displayColumns.length}" style="text-align: center;">Đang tải...</td></tr>`; try { const response = await fetch(`${mainHost}/sheet/${SHEET_NAME}/data`, { method: 'GET', headers: { 'Content-Type': 'application/json' } }); if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); } const data = await response.json(); handleData(data); } catch (error) { console.error('Lỗi khi tải dữ liệu:', error); showCustomAlert(`Lỗi kết nối: ${error.message}`, 'error'); document.getElementById('refreshData').disabled = false; document.getElementById('refreshData').innerHTML = '<span class="refresh-icon">↻</span> Load dữ liệu'; } }

        async function refreshData() {
            if (isUpdatingSingleCell) { showCustomAlert('Đang có thao tác cập nhật đơn lẻ, vui lòng đợi.', 'info'); return; }
            const btn = document.getElementById('refreshData');
            btn.disabled = true;
            btn.innerHTML = '<span class="refresh-icon">↻</span> Đang tải...';

            state.activeTeam = 'all';
            state.filterValues = {};
            localStorage.removeItem('speegoColumnFilters');
            state.mgtNoiBoOrder = [];
            state.currentPage = 1;

            // SỬA ĐỔI: Không xóa pendingChanges khi refresh, chỉ load lại data nền
            state.pendingChanges.clear(); 
            // state.legacyChanges vẫn giữ nguyên

            document.getElementById('tabContainer').innerHTML = '';
            document.getElementById('filterRow').innerHTML = '';
            document.getElementById('mainFilters').querySelectorAll('input, select').forEach(el => { if (el.id !== 'fixedColumns') el.value = ''; });
            updateOrderCounter(0);
            await loadData(); // loadData sẽ tự gọi loadPendingChangesFromLocalStorage
        }

        async function updateAllChangedRows() {
            if (isUpdatingSingleCell) { showCustomAlert('Đang có thao tác cập nhật đơn lẻ, vui lòng đợi.', 'info'); return; }
            
            // SỬA ĐỔI: Gộp 2 loại thay đổi lại để gửi đi
            const allChanges = new Map([...state.legacyChanges, ...state.pendingChanges]);

            if (allChanges.size === 0) {
                showCustomAlert('Không có thay đổi cần cập nhật.', 'info');
                return;
            }

            const updateBtn = document.getElementById('updateAll');
            updateBtn.disabled = true;
            updateBtn.textContent = 'Đang gửi...';
            const loadingToast = showCustomAlert('Đang cập nhật tất cả thay đổi...', 'info', 0);
            
            const rowsToSend = [];
            allChanges.forEach((changes, orderId) => {
                const changeObject = { [PRIMARY_KEY_COLUMN]: orderId };
                changes.forEach((changeInfo, colName) => {
                    changeObject[colName] = changeInfo.newValue;
                });
                rowsToSend.push(changeObject);
            });

            try {
                const response = await fetch(BATCH_UPDATE_API_URL, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(rowsToSend) });
                if (!response.ok) { const errorResponse = await response.json(); throw new Error(errorResponse.message || `Lỗi HTTP! status: ${response.status}`); }
                const json = await response.json();

                if (json.success) {
                    removeToast(loadingToast);
                    showCustomAlert(`Cập nhật thành công ${json.summary.updated} đơn hàng!`, 'success');
                    json.details.forEach(detail => {
                        if (detail.status === 'updated') {
                            const updatedRowData = rowsToSend.find(r => r[PRIMARY_KEY_COLUMN] === detail.primaryKey);
                            if (updatedRowData) {
                                const index = state.allData.findIndex(r => r[PRIMARY_KEY_COLUMN] === updatedRowData[PRIMARY_KEY_COLUMN]);
                                if (index !== -1) { state.allData[index] = { ...state.allData[index], ...updatedRowData }; }
                            }
                        }
                    });

                    // SỬA ĐỔI: Xóa cả 2 loại thay đổi
                    state.pendingChanges.clear();
                    state.legacyChanges.clear();
                    savePendingChangesToLocalStorage();
                    render();
                } else { removeToast(loadingToast); showCustomAlert(`Lỗi: ${json.message || 'Lỗi không xác định.'}`, 'error'); }
            } catch (error) { console.error('Lỗi khi cập nhật hàng loạt:', error); removeToast(loadingToast); showCustomAlert(`Lỗi kết nối: ${error.message}`, 'error'); } finally { updateBtn.disabled = false; updateBtn.textContent = 'Cập nhật tất cả thay đổi'; }
        }

        // THÊM MỚI: Function kiểm tra có thay đổi Mã Tracking không
        function hasTrackingChanges(rowsToSend) {
            return rowsToSend.some(row => {
                return Object.keys(row).some(key => 
                    key === "Mã Tracking" || key === "Mã_Tracking"
                );
            });
        }

        async function batchUpdatePastedData(rowsToSend) {
            if (rowsToSend.length === 0) { return; }
            
            // THÊM MỚI: Kiểm tra nếu có thay đổi Mã Tracking
            const hasTracking = hasTrackingChanges(rowsToSend);
            
            if (hasTracking) {
                // Nếu có thay đổi Mã Tracking, chỉ lưu vào pending changes, không gửi API
                rowsToSend.forEach(rowData => {
                    const orderId = rowData[PRIMARY_KEY_COLUMN];
                    if (!orderId) return;
                    
                    if (!state.pendingChanges.has(orderId)) {
                        state.pendingChanges.set(orderId, new Map());
                    }
                    
                    Object.keys(rowData).forEach(colName => {
                        if (colName !== PRIMARY_KEY_COLUMN) {
                            const originalRowData = state.allData.find(r => r[PRIMARY_KEY_COLUMN] === orderId);
                            const originalValue = originalRowData ? String(originalRowData[colName] ?? '') : '';
                            
                            state.pendingChanges.get(orderId).set(colName, {
                                newValue: rowData[colName],
                                originalValue: originalValue,
                                cellElement: null
                            });
                        }
                    });
                });
                
                savePendingChangesToLocalStorage();
                showCustomAlert(`Đã lưu ${rowsToSend.length} thay đổi có chứa Mã Tracking. Vui lòng bấm "Cập nhật tất cả" để gửi dữ liệu.`, 'info', 5000);
                render(); // Refresh để hiển thị highlight
                return;
            }
            
            // Logic cũ cho các thay đổi không có Mã Tracking
            const updateBtn = document.getElementById('updateAll');
            updateBtn.disabled = true;
            const loadingToast = showCustomAlert(`Đang cập nhật ${rowsToSend.length} thay đổi đã dán...`, 'info', 0);
            
            try {
                const response = await fetch(BATCH_UPDATE_API_URL, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(rowsToSend)
                });
                
                if (!response.ok) {
                    const errorResponse = await response.json();
                    throw new Error(errorResponse.message || `Lỗi HTTP! status: ${response.status}`);
                }
                
                const json = await response.json();
                
                if (json.success) {
                    removeToast(loadingToast);
                    showCustomAlert(`Cập nhật thành công ${json.summary?.updated || rowsToSend.length} đơn hàng từ dữ liệu đã dán!`, 'success');
                    
                    json.details?.forEach(detail => {
                        if (detail.status === 'updated') {
                            const updatedRowData = rowsToSend.find(r => r[PRIMARY_KEY_COLUMN] === detail.primaryKey);
                            if (updatedRowData) {
                                const index = state.allData.findIndex(r => r[PRIMARY_KEY_COLUMN] === updatedRowData[PRIMARY_KEY_COLUMN]);
                                if (index !== -1) {
                                    state.allData[index] = { ...state.allData[index], ...updatedRowData };
                                }
                                
                                const orderChanges = state.pendingChanges.get(updatedRowData[PRIMARY_KEY_COLUMN]);
                                if (orderChanges) {
                                    Object.keys(updatedRowData).forEach(colName => {
                                        if (colName !== PRIMARY_KEY_COLUMN) {
                                            orderChanges.delete(colName);
                                        }
                                    });
                                    if (orderChanges.size === 0) {
                                        state.pendingChanges.delete(updatedRowData[PRIMARY_KEY_COLUMN]);
                                    }
                                }
                            }
                        }
                    });
                    
                    savePendingChangesToLocalStorage();
                    render();
                } else {
                    removeToast(loadingToast);
                    showCustomAlert(`Lỗi cập nhật hàng loạt: ${json.message || 'Lỗi không xác định.'}`, 'error');
                }
            } catch (error) {
                console.error('Lỗi khi cập nhật hàng loạt từ paste:', error);
                removeToast(loadingToast);
                showCustomAlert(`Lỗi kết nối: ${error.message}`, 'error');
            } finally {
                updateBtn.disabled = false;
            }
        }
        
        // HÀM ĐƯỢC CẬP NHẬT
        function toggleTrackingView() {
            state.showTrackingOrders = !state.showTrackingOrders;
            // Nếu bật chế độ này, tắt chế độ xem trùng
            if (state.showTrackingOrders) {
                state.showDuplicateTrackingOrders = false;
            }
            updateTrackingButtonsUI();
            render();
        }

        // HÀM MỚI
        function toggleDuplicateTrackingView() {
            state.showDuplicateTrackingOrders = !state.showDuplicateTrackingOrders;
            // Nếu bật chế độ này, tắt chế độ xem có/không có tracking
            if (state.showDuplicateTrackingOrders) {
                state.showTrackingOrders = false;
            }
            updateTrackingButtonsUI();
            render();
        }

        // HÀM MỚI: Đồng bộ giao diện các nút tracking
        function updateTrackingButtonsUI() {
            const trackingBtn = document.getElementById('toggleTrackingView');
            const duplicateBtn = document.getElementById('toggleDuplicateTrackingView');

            // Cập nhật nút xem đơn có/không có tracking
            if (state.showTrackingOrders) {
                trackingBtn.textContent = 'Xem đơn không có mã Tracking';
                trackingBtn.classList.add('active');
            } else {
                trackingBtn.textContent = 'Xem đơn có mã Tracking';
                trackingBtn.classList.remove('active');
            }

            // Cập nhật nút xem đơn trùng
            if (state.showDuplicateTrackingOrders) {
                duplicateBtn.textContent = 'Xem tất cả đơn';
                duplicateBtn.classList.add('active');
            } else {
                duplicateBtn.textContent = 'Xem đơn trùng Mã tracking';
                duplicateBtn.classList.remove('active');
            }
        }

        function getCellValue(cell) { /* ... Giữ nguyên ... */ if (!cell) return ''; const select = cell.querySelector('select'); if (select) return select.value; const input = cell.querySelector('input'); return input ? input.value : cell.textContent; }
        function setCellValue(cell, value) { /* ... Giữ nguyên ... */ if (!cell) return; const select = cell.querySelector('select'); if (select) { select.value = value; select.dispatchEvent(new Event('change', { bubbles: true })); return; } const input = cell.querySelector('input'); if (input) { input.value = value; input.dispatchEvent(new Event('blur', { bubbles: true })); return; } if (cell.isContentEditable) { cell.textContent = value; cell.dispatchEvent(new Event('blur', { bubbles: true })); } }
        function clearAllSelections() { /* ... Giữ nguyên ... */ document.querySelectorAll('td.cell-selected').forEach(c => c.classList.remove('cell-selected')); if (pasteAnchorCell) { pasteAnchorCell.classList.remove('paste-anchor'); pasteAnchorCell = null; } updateSelectionSummary(); }
        function updateSelectionSummary() { /* ... Giữ nguyên ... */ const summaryEl = document.getElementById('selectionSummary'); const transferBtn = document.getElementById('transferWarehouseBtn'); const selectedCells = document.querySelectorAll('td.cell-selected'); summaryEl.innerHTML = ''; const selectedOrderIds = new Set(); const orderIdColIndex = displayColumns.indexOf(PRIMARY_KEY_COLUMN); if (selectedCells.length === 0) { transferBtn.style.display = 'none'; transferBtn.disabled = true; return; } const numericKeywords = ["số lượng", "giá", "tiền", "phí", "zipcode"]; const columns = new Map(); selectedCells.forEach(cell => { const colIndex = cell.cellIndex; if (colIndex === orderIdColIndex) { const orderId = getCellValue(cell).trim(); if (orderId) { selectedOrderIds.add(orderId); } } if (!columns.has(colIndex)) { columns.set(colIndex, []); } columns.get(colIndex).push(cell); }); const summaryParts = []; columns.forEach((cells, colIndex) => { const headerText = displayColumns[colIndex].toLowerCase(); const isNumeric = numericKeywords.some(kw => headerText.includes(kw)); if (isNumeric) { let sum = 0; let count = 0; cells.forEach(cell => { const value = getCellValue(cell); const num = parseFloat(String(value).replace(/[^\d.-]/g, '')); if (!isNaN(num)) { sum += num; count++; } }); if (count > 0) { summaryParts.push(`<span class="summary-item">${displayColumns[colIndex]} | Sum: <b>${sum.toLocaleString('vi-VN')}</b></span>`); } } else { let count = 0; cells.forEach(cell => { if (getCellValue(cell).trim() !== '') { count++; } }); if (count > 0) { summaryParts.push(`<span class="summary-item">${displayColumns[colIndex]} | Count: <b>${count}</b></span>`); } } }); summaryEl.innerHTML = summaryParts.join(''); if (selectedOrderIds.size > 0) { transferBtn.style.display = 'block'; transferBtn.disabled = false; } else { transferBtn.style.display = 'none'; transferBtn.disabled = true; } }
        async function transferSelectedOrders() { /* ... Giữ nguyên ... */ const transferBtn = document.getElementById('transferWarehouseBtn'); const originalText = transferBtn.textContent; transferBtn.disabled = true; transferBtn.textContent = 'Đang chuyển...'; const loadingToast = showCustomAlert('Đang chuyển kho...', 'info', 0); const selectedOrderIds = new Set(); const orderIdColIndex = displayColumns.indexOf(PRIMARY_KEY_COLUMN); document.querySelectorAll('td.cell-selected').forEach(cell => { if (cell.cellIndex === orderIdColIndex) { const orderId = getCellValue(cell).trim(); if (orderId) { selectedOrderIds.add({ "Mã đơn hàng": orderId }); } } }); if (selectedOrderIds.size === 0) { removeToast(loadingToast); showCustomAlert('Vui lòng chọn ít nhất một "Mã đơn hàng" để chuyển kho.', 'info'); transferBtn.disabled = false; transferBtn.textContent = originalText; return; } const maDonList = Array.from(selectedOrderIds); try { const response = await fetch(TRANSFER_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ rows: maDonList }) }); if (!response.ok) { const errorResponse = await response.json(); throw new Error(errorResponse.message || `Lỗi HTTP! status: ${response.status}`); } const result = await response.json(); if (result && result.success) { clearAllSelections(); removeToast(loadingToast); showCustomAlert('Chuyển kho thành công!', 'success', 2000); await fetchMGTNoiBoOrder(); render(); } else { removeToast(loadingToast); showCustomAlert(`Chuyển kho không thành công: ${result.message || 'Lỗi không xác định.'}`, 'error'); } } catch (e) { console.error('Lỗi khi chuyển kho:', e); removeToast(loadingToast); showCustomAlert(`Lỗi kết nối hoặc xử lý: ${e.message}`, 'error'); } finally { transferBtn.disabled = false; transferBtn.textContent = originalText; } }
        function setupInteractionHandlers() {
            const tableBody = document.getElementById('tableBody');
            if (!tableBody) return;
            let isSelecting = false, startCell = null;
            
            const selectCells = (start, end) => {
                clearAllSelections();
                const tableRows = tableBody.rows;
                const minRow = Math.min(start.parentElement.rowIndex, end.parentElement.rowIndex);
                const maxRow = Math.max(start.parentElement.rowIndex, end.parentElement.rowIndex);
                const minCol = Math.min(start.cellIndex, end.cellIndex);
                const maxCol = Math.max(start.cellIndex, end.cellIndex);
                
                for (let i = 0; i < tableRows.length; i++) {
                    const row = tableRows[i];
                    if (row.rowIndex >= minRow && row.rowIndex <= maxRow) {
                        for (let j = minCol; j <= maxCol; j++) {
                            if (row.cells[j]) row.cells[j].classList.add('cell-selected');
                        }
                    }
                }
                
                if (start) {
                    pasteAnchorCell = start;
                    start.classList.add('paste-anchor');
                }
            };

            tableBody.addEventListener('mousedown', e => {
                if (e.button !== 0) return;
                const cell = e.target.closest('td');
                if (!cell) return;
                e.preventDefault();
                
                if (e.shiftKey && pasteAnchorCell) {
                    selectCells(pasteAnchorCell, cell);
                    updateSelectionSummary();
                } else {
                    isSelecting = true;
                    clearAllSelections();
                    startCell = cell;
                    pasteAnchorCell = cell;
                    cell.classList.add('cell-selected');
                    cell.classList.add('paste-anchor');
                    updateSelectionSummary();
                }
            });

            tableBody.addEventListener('mousemove', e => {
                if (!isSelecting || !startCell) return;
                const currentCell = e.target.closest('td');
                if (currentCell && currentCell !== startCell) {
                    selectCells(startCell, currentCell);
                }
            });

            document.addEventListener('mouseup', () => {
                if (isSelecting) {
                    isSelecting = false;
                    updateSelectionSummary();
                }
            });

            tableBody.addEventListener('dblclick', e => {
                const cell = e.target.closest('td.editable');
                if (!cell) return;
                
                const input = cell.querySelector('input, select');
                if (input) {
                    input.focus();
                } else if (cell.isContentEditable) {
                    cell.focus();
                    document.execCommand('selectAll', false, null);
                    document.getSelection().collapseToEnd();
                }
            });

            document.addEventListener('copy', e => {
                const selectedCells = document.querySelectorAll('td.cell-selected');
                if (selectedCells.length === 0) return;
                
                e.preventDefault();
                const rows = new Map();
                
                selectedCells.forEach(cell => {
                    const rowIndex = cell.parentElement.rowIndex;
                    if (!rows.has(rowIndex)) rows.set(rowIndex, []);
                    rows.get(rowIndex).push({ colIndex: cell.cellIndex, text: getCellValue(cell) });
                });
                
                const sortedRows = [...rows.entries()].sort((a, b) => a[0] - b[0]);
                const copyText = sortedRows.map(([, cells]) => 
                    cells.sort((a, b) => a.colIndex - b.colIndex).map(cell => cell.text).join('\t')
                ).join('\n');
                
                e.clipboardData.setData('text/plain', copyText);
                showCustomAlert(`Đã sao chép ${selectedCells.length} ô.`, 'info', 2000);
            });

            document.addEventListener('paste', e => {
                const activeEl = document.activeElement;
                if (activeEl && (['INPUT', 'SELECT', 'TEXTAREA'].includes(activeEl.tagName) || activeEl.isContentEditable)) {
                    return;
                }
                if (!pasteAnchorCell) return;
                
                e.preventDefault();
                const pasteData = e.clipboardData.getData('text/plain');
                if (!pasteData) return;
                
                const pastedRows = pasteData.split(/[\r\n]+/)
                    .map(row => row.split('\t'))
                    .filter(row => row.length > 0 && !(row.length === 1 && row[0] === ''));
                
                if (pastedRows.length === 0) return;

                // Xử lý paste giá trị đơn vào nhiều ô được chọn
                if (pastedRows.length === 1 && pastedRows[0].length === 1) {
                    const singleValue = pastedRows[0][0];
                    const editableSelected = document.querySelectorAll('td.cell-selected.editable');
                    
                    if (editableSelected.length > 0) {
                        // Thu thập tất cả thông tin từ selected cells và map đúng Mã đơn hàng
                        const changesForBatchUpdate = new Map();
                        isPasting = true;
                        
                        editableSelected.forEach(cell => {
                            const targetRow = cell.parentElement;
                            const orderId = targetRow.dataset.orderId;
                            if (!orderId) return;
                            
                            const colIndex = cell.cellIndex;
                            const colName = displayColumns[colIndex];
                            const dataKey = columnMapping[colName] || colName;
                            
                            // Đảm bảo đây là cột có thể chỉnh sửa
                            if (!editableCols.includes(colName)) return;
                            
                            // Cập nhật giá trị trong UI
                            setCellValue(cell, singleValue);
                            
                            // Chuẩn bị dữ liệu cho API với Mã đơn hàng làm khóa chính
                            if (!changesForBatchUpdate.has(orderId)) {
                                changesForBatchUpdate.set(orderId, { [PRIMARY_KEY_COLUMN]: orderId });
                            }
                            
                            let valueForApi = singleValue;
                            if (colName === "Ngày đóng hàng") {
                                valueForApi = parseDateToISO(singleValue);
                            }
                            changesForBatchUpdate.get(orderId)[dataKey] = valueForApi;
                        });
                        
                        isPasting = false;
                        
                        // Gửi batch update cho tất cả thay đổi
                        const rowsToSend = Array.from(changesForBatchUpdate.values());
                        if (rowsToSend.length > 0) {
                            const hasTracking = hasTrackingChanges(rowsToSend);
                            batchUpdatePastedData(rowsToSend);
                            
                            if (!hasTracking) {
                                showCustomAlert(`Đã dán giá trị vào ${editableSelected.length} ô và cập nhật ${rowsToSend.length} đơn hàng.`, 'success', 3000);
                            }
                        }
                        updateSelectionSummary();
                        return;
                    }
                }

                // Xử lý paste dữ liệu bảng (nhiều dòng, nhiều cột)
                const tableRows = Array.from(document.getElementById('tableBody').rows);
                let startRowIndex = tableRows.findIndex(row => row.rowIndex === pasteAnchorCell.parentElement.rowIndex);
                let startColIndex = pasteAnchorCell.cellIndex;
                
                if (startRowIndex < 0 || startColIndex < 0) return;
                
                const changesForBatchUpdate = new Map();
                isPasting = true;
                
                pastedRows.forEach((rowData, i) => {
                    const targetRow = tableRows[startRowIndex + i];
                    if (!targetRow) return;
                    
                    const orderId = targetRow.dataset.orderId;
                    if (!orderId) return;
                    
                    // Khởi tạo object cho đơn hàng này với Mã đơn hàng làm khóa chính
                    if (!changesForBatchUpdate.has(orderId)) {
                        changesForBatchUpdate.set(orderId, { [PRIMARY_KEY_COLUMN]: orderId });
                    }
                    
                    rowData.forEach((cellData, j) => {
                        const targetCell = targetRow.cells[startColIndex + j];
                        if (targetCell && targetCell.classList.contains('editable')) {
                            const colName = displayColumns[startColIndex + j];
                            const dataKey = columnMapping[colName] || colName;
                            
                            // Cập nhật UI
                            setCellValue(targetCell, cellData);
                            
                            // Chuẩn bị dữ liệu cho API
                            let valueForApi = cellData;
                            if (colName === "Ngày đóng hàng") {
                                valueForApi = parseDateToISO(cellData);
                            }
                            changesForBatchUpdate.get(orderId)[dataKey] = valueForApi;
                        }
                    });
                });
                
                isPasting = false;
                
                // Gửi tất cả thay đổi qua batch update với mapping đúng Mã đơn hàng
                const rowsToSend = Array.from(changesForBatchUpdate.values());
                if (rowsToSend.length > 0) {
                    const hasTracking = hasTrackingChanges(rowsToSend);
                    batchUpdatePastedData(rowsToSend);
                    
                    if (!hasTracking) {
                        showCustomAlert(`Đã dán ${pastedRows.length} dòng dữ liệu và cập nhật ${rowsToSend.length} đơn hàng.`, 'success', 3000);
                    }
                }
                updateSelectionSummary();
            });

            document.addEventListener('keydown', e => {
                const activeEl = document.activeElement;
                if (activeEl && (['INPUT', 'SELECT', 'TEXTAREA'].includes(activeEl.tagName) || activeEl.isContentEditable)) {
                    return;
                }
                
                if (e.key === 'Delete' || e.key === 'Backspace') {
                    const editableSelected = document.querySelectorAll('td.cell-selected.editable');
                    if (editableSelected.length > 0) {
                        e.preventDefault();
                        
                        // Thu thập tất cả thông tin để xóa và map đúng Mã đơn hàng
                        const changesForBatchUpdate = new Map();
                        
                        editableSelected.forEach(cell => {
                            const targetRow = cell.parentElement;
                            const orderId = targetRow.dataset.orderId;
                            if (!orderId) return;
                            
                            const colIndex = cell.cellIndex;
                            const colName = displayColumns[colIndex];
                            const dataKey = columnMapping[colName] || colName;
                            
                            if (!editableCols.includes(colName)) return;
                            
                            // Cập nhật UI
                            setCellValue(cell, '');
                            
                            // Chuẩn bị dữ liệu cho API
                            if (!changesForBatchUpdate.has(orderId)) {
                                changesForBatchUpdate.set(orderId, { [PRIMARY_KEY_COLUMN]: orderId });
                            }
                            changesForBatchUpdate.get(orderId)[dataKey] = '';
                        });
                        
                        // Gửi batch update cho việc xóa
                        const rowsToSend = Array.from(changesForBatchUpdate.values());
                        if (rowsToSend.length > 0) {
                            const hasTracking = hasTrackingChanges(rowsToSend);
                            batchUpdatePastedData(rowsToSend);
                            
                            if (!hasTracking && editableSelected.length > 1) {
                                showCustomAlert(`Đã xóa nội dung của ${editableSelected.length} ô và cập nhật ${rowsToSend.length} đơn hàng.`, 'success', 2000);
                            }
                        }
                        updateSelectionSummary();
                    }
                }
            });
        }
        
        // MỚI: Hàm hiển thị popover
        function showSyncPopover() {
            const popover = document.getElementById('syncPopover');
            const body = document.getElementById('popoverBody');
            body.innerHTML = ''; // Xóa nội dung cũ

            const createTableHTML = (changesMap) => {
                let html = '<table class="popover-table"><thead><tr><th>Mã Đơn Hàng</th><th>Cột Thay Đổi</th><th>Giá Trị</th></tr></thead><tbody>';
                changesMap.forEach((colChanges, orderId) => {
                    colChanges.forEach((changeInfo, colName) => {
                        html += `<tr>
                            <td>${orderId}</td>
                            <td>${colName}</td>
                            <td>
                                <span class="old-value">${changeInfo.originalValue || '(trống)'}</span>
                                <span class="new-value">${changeInfo.newValue || '(trống)'}</span>
                            </td>
                        </tr>`;
                    });
                });
                html += '</tbody></table>';
                return html;
            };

            // Hiển thị thay đổi từ phiên trước
            body.innerHTML += '<h5>Dữ liệu từ phiên trước (chưa được đồng bộ)</h5>';
            if (state.legacyChanges.size > 0) {
                body.innerHTML += createTableHTML(state.legacyChanges);
            } else {
                body.innerHTML += '<p class="no-changes">Không có.</p>';
            }

            // Hiển thị thay đổi trong phiên này
            body.innerHTML += '<h5 style="margin-top: 20px;">Thay đổi trong phiên này</h5>';
            if (state.pendingChanges.size > 0) {
                body.innerHTML += createTableHTML(state.pendingChanges);
            } else {
                body.innerHTML += '<p class="no-changes">Không có.</p>';
            }

            popover.style.display = 'flex';
        }
        
        function downloadAsExcel() { /* ... Giữ nguyên ... */ const allFilteredData = (function () { const mergedData = state.allData.map(originalRow => { const orderId = originalRow[PRIMARY_KEY_COLUMN]; const changes = state.pendingChanges.get(orderId) || state.legacyChanges.get(orderId); if (changes) { const changeObject = {}; changes.forEach((changeInfo, key) => { changeObject[key] = changeInfo.newValue; }); return { ...originalRow, ...changeObject }; } return originalRow; }); const mgtData = filterByCarrier(mergedData); let dataToExport = mgtData.filter(row => { const trackingCode = String(row["Mã Tracking"] || row["Mã_Tracking"] || ''); return state.showTrackingOrders ? trackingCode.trim() !== '' : !trackingCode.trim(); }); const market = document.getElementById('filterMarket').value; const product = document.getElementById('filterProduct').value; const dateFrom = document.getElementById('filterDateFrom').value; const dateTo = document.getElementById('filterDateTo').value; if (market) { dataToExport = dataToExport.filter(row => row["Khu vực"] === market); } if (product) { dataToExport = dataToExport.filter(row => row["Mặt hàng"] === product); } if (dateFrom) { const from = new Date(dateFrom); from.setHours(0, 0, 0, 0); dataToExport = dataToExport.filter(row => row["Ngày lên đơn"] && new Date(row["Ngày lên đơn"]) >= from); } if (dateTo) { const to = new Date(dateTo); to.setHours(23, 59, 59, 999); dataToExport = dataToExport.filter(row => row["Ngày lên đơn"] && new Date(row["Ngày lên đơn"]) <= to); } if (state.activeTeam === 'mgt_noi_bo') { if (state.mgtNoiBoOrder.length > 0) { const orderedIds = new Set(state.mgtNoiBoOrder); dataToExport = dataToExport.filter(row => orderedIds.has(row["Mã đơn hàng"])); const orderIndexMap = new Map(state.mgtNoiBoOrder.map((id, index) => [id, index])); dataToExport.sort((a, b) => { const indexA = orderIndexMap.get(a[PRIMARY_KEY_COLUMN]); const indexB = orderIndexMap.get(b[PRIMARY_KEY_COLUMN]); return indexA - indexB; }); } } else if (state.activeTeam !== 'all') { dataToExport = dataToExport.filter(row => row[TEAM_COLUMN_NAME] === state.activeTeam); } const trackingIncludeRaw = state.filterValues['tracking_include'] || ''; const trackingExcludeRaw = state.filterValues['tracking_exclude'] || ''; const otherColumnFilters = Object.entries(state.filterValues).filter(([key, val]) => val.trim() !== '' && !key.startsWith('tracking_')); if (otherColumnFilters.length > 0) { dataToExport = dataToExport.filter(row => { return otherColumnFilters.every(([col, filterValue]) => { const dataKey = columnMapping[col] || col; const cellValue = row[dataKey] ?? row[col] ?? row[dataKey.replace(/ /g, '_')] ?? ''; return String(cellValue).toLowerCase().includes(filterValue.toLowerCase()); }); }); } if (trackingIncludeRaw || trackingExcludeRaw) { const lowerInclude = trackingIncludeRaw.toLowerCase(); const lowerExclude = trackingExcludeRaw.toLowerCase(); dataToExport = dataToExport.filter(row => { const cellValue = String(row['Mã Tracking'] || ''); const lowerCellValue = cellValue.toLowerCase(); if (lowerExclude && lowerCellValue.includes(lowerExclude)) { return false; } if (lowerInclude) { if (lowerInclude.includes('\n')) { const codes = new Set(trackingIncludeRaw.split('\n').map(t => t.trim()).filter(Boolean)); if (!codes.has(cellValue.trim())) return false; } else { if (!lowerCellValue.includes(lowerInclude)) return false; } } return true; }); } if (state.activeTeam !== 'mgt_noi_bo') { const primarySortKey = 'Ngày Kế toán đối soát với FFM lần 2'; const secondarySortKey = PRIMARY_KEY_COLUMN; dataToExport.sort((a, b) => { const parseDate = (val) => { if (!val) return null; const date = new Date(val); return isNaN(date.getTime()) ? null : date; }; const dateA = parseDate(a[primarySortKey]); const dateB = parseDate(b[primarySortKey]); if (dateA === null && dateB === null) { } else if (dateA === null) { return 1; } else if (dateB === null) { return -1; } else { const dateComparison = dateA.getTime() - dateB.getTime(); if (dateComparison !== 0) { return dateComparison; } } const orderIdA = a[secondarySortKey] || ''; const orderIdB = b[secondarySortKey] || ''; return orderIdA.localeCompare(orderIdB); }); } return dataToExport; })(); if (allFilteredData.length === 0) { showCustomAlert("Không có dữ liệu để tải về.", 'info'); return; } const sanitizeCsvCell = (cell, colName) => { if (cell === null || cell === undefined) return ''; let str = String(cell); if ((colName === "Mã Tracking" || colName === "Phone*") && str) { return `="${str.replace(/"/g, '""')}"`; } if (str.includes(',') || str.includes('"') || str.includes('\n')) { str = str.replace(/"/g, '""'); return `"${str}"`; } return str; }; const headers = displayColumns.map(col => sanitizeCsvCell(col, col)).join(','); const rows = allFilteredData.map(row => { return displayColumns.map(col => { const dataKey = columnMapping[col] || col; let value = row[dataKey] ?? row[col] ?? row[col.replace(/ /g, '_')] ?? ''; if (["Ngày lên đơn", "Ngày đóng hàng"].includes(col)) { value = formatDate(value); } return sanitizeCsvCell(value, col); }).join(','); }).join('\n'); const BOM = '\uFEFF'; const csvContent = BOM + headers + '\n' + rows; const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement("a"); if (link.download !== undefined) { const url = URL.createObjectURL(blob); const today = new Date(); const dateStr = `${today.getFullYear()}${(today.getMonth() + 1).toString().padStart(2, '0')}${today.getDate().toString().padStart(2, '0')}`; link.setAttribute("href", url); link.setAttribute("download", `BaoCaoDonHang_MGT_${dateStr}.csv`); link.style.visibility = 'hidden'; document.body.appendChild(link); link.click(); document.body.removeChild(link); } }

        // --- KHỞI TẠO ---
        document.addEventListener('DOMContentLoaded', () => {
            // SỬA ĐỔI: Không gọi loadPendingChangesFromLocalStorage ở đây nữa
            // Nó sẽ được gọi sau khi loadData() thành công
            setupControls();
            setupInteractionHandlers();
            const rowsPerPageSelect = document.getElementById('rowsPerPageSelect');
            state.rowsPerPage = parseInt(rowsPerPageSelect.value, 10);
            loadData(); // Tải dữ liệu lần đầu
        });
    </script>
</body>

</html>

<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <title>Báo cáo chi phí tổng hợp</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    /* --- CÀI ĐẶT CHUNG & TABS --- */
    body {
      font-family: 'Roboto', Arial, sans-serif;
      padding: 20px;
      background-color: #f4f4f4;
      color: #333;
      font-size: 16px;
    }

    .tab-container {
      overflow: hidden;
      border-bottom: 2px solid #ccc;
      margin-bottom: 20px;
    }

    .tab-container button {
      background-color: #f1f1f1;
      float: left;
      border: none;
      outline: none;
      cursor: pointer;
      padding: 14px 20px;
      transition: 0.3s;
      font-size: 17px;
      font-weight: 500;
      border-radius: 8px 8px 0 0;
      margin-right: 5px;
    }

    .tab-container button:hover {
      background-color: #ddd;
    }

    .tab-container button.active {
      background-color: #2d7c2d;
      color: white;
    }

    .tab-content {
      display: none;
      padding: 6px 12px;
      border-top: none;
      animation: fadeIn 0.5s;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* --- STYLES CHUNG CHO BẢNG & CĂN LỀ --- */
    .table-responsive-container {
      overflow-x: auto;
      margin-bottom: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: auto;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    th, td {
      border: 1px solid #e0e0e0;
      padding: 12px 14px;
      white-space: nowrap;
      vertical-align: middle;
      transition: background-color 0.2s;
      font-size: 15px;
    }

    th { text-align: center !important; font-size: 16px; }
    td { text-align: right !important; }
    .text-left { text-align: left !important; }
    .text-center { text-align: center !important; }

    tbody tr:nth-child(even) { background-color: #f9f9f9; }
    tbody tr:not(.team-header-row):not(.total-row):not(.highlight):hover { background-color: #eff5fb; }

    th.green-header, th.blue-header {
      background: #4CAF50;
      color: white;
      font-weight: 700;
    }

    th.yellow-header {
      background: #FFC107;
      color: #424242;
      font-weight: 700;
    }

    tr.total-row, tr.total-row:hover {
      background: #2d7c2d;
      color: white;
      font-weight: 700;
      font-size: 1.2em;
      border-bottom: 3px solid #FFC107;
    }

    .total-row .total-label { text-transform: uppercase; text-align: left !important; }
    .bg-green { background-color: #4CAF50 !important; color: white; }
    .bg-yellow { background-color: #FFEB3B !important; color: #424242; }
    .bg-lightred { background-color: #F44336 !important; color: white; }

    /* --- SIDEBAR & LAYOUT --- */
    .report-container { display: flex; gap: 20px; }
    .sidebar { width: 260px; flex-shrink: 0; background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); }
    .sidebar h3 { background: #2d7c2d; color: #fff; padding: 10px; margin-top: 10px; font-size: 18px; border-radius: 4px; font-weight: 700; }
    .sidebar label { display: block; margin: 8px 0; font-size: 15px; cursor: pointer; }
    .sidebar .indent { margin-left: 16px; }
    .sidebar input[type="date"], .sidebar select { width: 100%; padding: 8px; margin: 4px 0 10px; border: 1px solid #ccc; border-radius: 4px; }
    .main-content-area { flex-grow: 1; }
    .header { display: flex; align-items: center; margin-bottom: 10px; }
    .header img { height: 60px; margin-right: 15px; border-radius: 50%; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); }
    .header h2 { margin: 0; color: #2d7c2d; font-weight: 700; font-size: 28px; }

    /* --- LOADING OVERLAY --- */
    #loading-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255, 255, 255, 0.7); display: flex; justify-content: center; align-items: center;
      z-index: 9999; font-size: 1.5em; font-weight: bold; color: #2d7c2d;
      visibility: hidden; opacity: 0; transition: 0.3s;
    }
    #loading-overlay.visible { visibility: visible; opacity: 1; }

    .sort-icon { opacity: 0.4; font-size: 0.8em; }
    .sorted .sort-icon { opacity: 1; }
    .sort-icon.asc::after { content: " ▲"; }
    .sort-icon.desc::after { content: " ▼"; }

    /* --- MARKET REPORT EXTRA --- */
    #MarketReport .report-header { text-align: center; margin-bottom: 20px; padding: 20px; background: #fff; border-radius: 8px; }
    #MarketReport .filter-container { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; padding: 15px; background: #fff; border-radius: 8px; align-items: center; }
    #MarketReport .section-title { font-size: 20px; font-weight: 600; color: #1b4b1b; margin: 25px 0 15px; padding-bottom: 8px; border-bottom: 2px solid #2d7c2d; }
    #MarketReport .mkt-charts-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-top: 30px; }
    #MarketReport .chart-wrapper { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 6px 12px rgba(0,0,0,0.1); }
    #MarketReport .chart-wrapper canvas { width: 100% !important; height: 350px !important; }
    #MarketReport button#apply-filter-mkt { background: #2d7c2d; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: 600; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
</head>

<body>
  <div id="loading-overlay">Đang tải dữ liệu...</div>
  <div class="tab-container">
    <button class="tablinks" onclick="openTab(event, 'DetailedReport')" id="defaultOpen">Báo cáo chi tiết</button>
    <button class="tablinks" onclick="openTab(event, 'KpiReport')">Báo cáo KPI</button>
    <button class="tablinks" onclick="openTab(event, 'MarketReport')">Hiệu quả MKT</button>
    <button class="tablinks" onclick="openTab(event, 'ManualReport')" id="manual-report-tab-btn" style="display: none;">Báo cáo thủ công</button>
  </div>

  <!-- TAB 1: CHI TIẾT -->
  <div id="DetailedReport" class="tab-content">
    <div class="report-container">
      <div class="sidebar">
        <h3>Bộ lọc</h3>
        <label>Chọn nhanh:</label>
        <select id="quick-date-select-tab1">
          <option value="">-- Chọn nhanh --</option>
          <option value="today">Hôm nay</option>
          <option value="yesterday">Hôm qua</option>
          <option value="thisWeek">Tuần này</option>
          <option value="thisMonth">Tháng này</option>
        </select>
        <label>Từ ngày:</label><input type="date" id="start-date-tab1">
        <label>Đến ngày:</label><input type="date" id="end-date-tab1">
        <h3>Sản phẩm</h3>
        <label><input type="checkbox" id="product-all-tab1" checked> Tất cả</label>
        <div id="product-options-tab1" class="indent"></div>
        <h3>Ca</h3>
        <label><input type="checkbox" id="ca-all-tab1" checked> Tất cả</label>
        <div id="ca-options-tab1" class="indent"></div>
        <h3>Team</h3>
        <label><input type="checkbox" id="team-all-tab1" checked> Tất cả</label>
        <div id="team-options-tab1" class="indent"></div>
        <h3>Thị trường</h3>
        <label><input type="checkbox" id="market-all-tab1" checked> Tất cả</label>
        <div id="market-options-tab1"></div>
      </div>
      <div class="main-content-area">
        <div class="header">
          <img src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Ff930e667.%E1%BA%A2nh.025539.jpg" alt="Logo">
          <h2 id="report-title-tab1">DỮ LIỆU CHI PHÍ ADS</h2>
        </div>
        <div class="table-responsive-container">
          <table id="summary-table" class="sortable-table">
            <thead>
              <tr>
                <th class="green-header">STT</th>
                <th class="green-header">Team</th>
                <th class="green-header">Marketing</th>
                <th class="green-header">Số Mess</th>
                <th class="green-header">CPQC</th>
                <th class="green-header">Số Đơn</th>
                <th class="blue-header">Số Đơn (TT)</th>
                <th class="green-header">DS Chốt</th>
                <th class="blue-header">DS Chốt (TT)</th>
                <th class="yellow-header">Tỉ lệ chốt</th>
                <th class="yellow-header">Tỉ lệ chốt (TT)</th>
                <th class="yellow-header">Giá Mess</th>
                <th class="yellow-header">CPS</th>
                <th class="yellow-header">%CP/DS</th>
                <th class="yellow-header">Giá TB Đơn</th>
              </tr>
            </thead>
            <tbody id="summary-body"></tbody>
          </table>
        </div>
        <div id="daily-breakdown"></div>
      </div>
    </div>
  </div>

  <!-- TAB 2: KPI -->
  <div id="KpiReport" class="tab-content">
    <div class="report-container">
      <div class="sidebar">
        <h3>Bộ lọc</h3>
        <label>Từ ngày:</label><input type="date" id="start-date-tab3">
        <label>Đến ngày:</label><input type="date" id="end-date-tab3">
        <h3>Sản phẩm</h3>
        <label><input type="checkbox" id="product-all-tab3" checked> Tất cả</label>
        <div id="product-options-tab3" class="indent"></div>
        <h3>Ca</h3>
        <label><input type="checkbox" id="ca-all-tab3" checked> Tất cả</label>
        <div id="ca-options-tab3" class="indent"></div>
        <h3>Team</h3>
        <label><input type="checkbox" id="team-all-tab3" checked> Tất cả</label>
        <div id="team-options-tab3" class="indent"></div>
        <h3>Thị trường</h3>
        <label><input type="checkbox" id="market-all-tab3" checked> Tất cả</label>
        <div id="market-options-tab3"></div>
      </div>
      <div class="main-content-area">
        <div class="header">
          <img src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Ff930e667.%E1%BA%A2nh.025539.jpg" alt="Logo">
          <h2>BÁO CÁO HIỆU SUẤT KPI</h2>
        </div>
        <div class="table-responsive-container">
          <table id="kpi-summary-table" class="sortable-table">
            <thead>
              <tr>
                <th class="green-header">STT</th>
                <th class="green-header">Team</th>
                <th class="green-header">Marketing</th>
                <th class="green-header">CPQC</th>
                <th class="green-header">DS Chốt</th>
                <th class="blue-header">DS Chốt (TT)</th>
                <th class="blue-header">Số đơn hủy (TT)</th>
                <th class="blue-header">Doanh số Hủy (TT)</th>
                <th class="blue-header">DS Thành Công (TT)</th>
                <th class="yellow-header">%CP/DS</th>
                <th class="yellow-header">% KPI</th>
              </tr>
            </thead>
            <tbody id="kpi-summary-body"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- TAB 3: HIỆU QUẢ MKT -->
  <div id="MarketReport" class="tab-content">
    <div class="report-header">
      <div class="report-title">THỐNG KÊ HIỆU QUẢ MARKETING THEO SẢN PHẨM & THỊ TRƯỜNG</div>
      <div id="report-date-mkt"></div>
    </div>
    <div class="filter-container">
      <div class="filter-group"><label>Từ:</label><input type="date" id="start-date-mkt"></div>
      <div class="filter-group"><label>Đến:</label><input type="date" id="end-date-mkt"></div>
      <div class="filter-group"><label>Team:</label><select id="team-filter-mkt" multiple></select></div>
      <div class="filter-group"><label>Thị trường:</label><select id="market-filter-mkt" multiple></select></div>
      <div class="filter-group"><label>Sản phẩm:</label><select id="product-filter-mkt" multiple></select></div>
      <button id="apply-filter-mkt">Áp dụng</button>
    </div>

    <div id="non-asia-market-mkt" style="display: none;">
      <div class="section-title">THỊ TRƯỜNG NGOÀI CHÂU Á</div>
      <div class="table-responsive-container"><table id="non-asia-table-mkt"><thead><tr><th>Sản phẩm</th><th>Thị trường</th><th>CPQC</th><th>Số đơn</th><th>Số đơn (TT)</th><th>Số mess</th><th>DS Chốt</th><th>DS Chốt (TT)</th><th>DS Hoàn Hủy</th><th>DS Sau HH (TT)</th><th>%CP/DS</th><th>CPS</th><th>Giá đơn TB</th><th>Tỉ lệ chốt</th><th>Tỉ lệ chốt (TT)</th></tr></thead><tbody id="non-asia-body-mkt"></tbody></table></div>
    </div>
    <div id="asia-market-mkt" style="display: none;">
      <div class="section-title">THỊ TRƯỜNG CHÂU Á</div>
      <div class="table-responsive-container"><table id="asia-table-mkt"><thead><tr><th>Sản phẩm</th><th>Thị trường</th><th>CPQC</th><th>Số đơn</th><th>Số đơn (TT)</th><th>Số mess</th><th>DS Chốt</th><th>DS Chốt (TT)</th><th>DS Hoàn Hủy</th><th>DS Sau HH (TT)</th><th>%CP/DS</th><th>CPS</th><th>Giá đơn TB</th><th>Tỉ lệ chốt</th><th>Tỉ lệ chốt (TT)</th></tr></thead><tbody id="asia-body-mkt"></tbody></table></div>
    </div>
    <div id="summary-market-mkt" style="display: none;">
      <div class="section-title">TỔNG HỢP TẤT CẢ THỊ TRƯỜNG</div>
      <div class="table-responsive-container"><table id="summary-table-mkt"><thead><tr><th>Sản phẩm</th><th></th><th>CPQC</th><th>Số đơn</th><th>Số đơn (TT)</th><th>Số mess</th><th>DS Chốt</th><th>DS Chốt (TT)</th><th>DS Hoàn Hủy</th><th>DS Sau HH (TT)</th><th>%CP/DS</th><th>CPS</th><th>Giá đơn TB</th><th>Tỉ lệ chốt</th><th>Tỉ lệ chốt (TT)</th></tr></thead><tbody id="summary-body-mkt"></tbody></table></div>
    </div>

    <div id="mkt-charts-section" style="display: none;">
      <div class="section-title">BIỂU ĐỒ TRỰC QUAN</div>
      <div class="mkt-charts-container">
        <div class="chart-wrapper"><canvas id="mktProductSalesChart"></canvas></div>
        <div class="chart-wrapper"><canvas id="mktProductDsChotChart"></canvas></div>
        <div class="chart-wrapper"><canvas id="mktProductCpqcChart"></canvas></div>
        <div class="chart-wrapper"><canvas id="mktProductCpsChart"></canvas></div>
        <div class="chart-wrapper"><canvas id="mktProductClosingRateChart"></canvas></div>
      </div>
    </div>
  </div>

  <div id="ManualReport" class="tab-content">
    <iframe id="manual-report-iframe" style="width: 100%; height: 85vh; border: none;" src=""></iframe>
  </div>

  <script>
    // --- CONFIG & CONSTANTS ---
    const API_URL = `https://n-api-gamma.vercel.app/report/generate?tableName=Báo cáo MKT`;
    const CHART_COLORS = ['#4CAF50', '#2196F3', '#FFC107', '#F44336', '#9C27B0', '#009688', '#FF9800', '#795548', '#607D8B'];
    
    // Nhóm Nhật Bản vào Châu Á
    const MARKET_GROUPS = {
      'Châu Á': ['Hàn Quốc', 'Nhật Bản', 'VN'],
      'Ngoài Châu Á': ['Úc', 'US', 'Canada']
    };

    let masterData = [];
    let employeeData = [];
    let baseDataForReport = [];
    const charts = {};

    // --- INIT ---
    document.addEventListener('DOMContentLoaded', () => {
      Chart.register(ChartDataLabels);
      setDefaultDates();
      fetchAndProcessData();
      initMarketReportCharts();
      document.getElementById("defaultOpen").click();
      setupEventListeners();
    });

    function setDefaultDates() {
      const today = new Date();
      const first = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
      const last = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];
      ['tab1', 'tab3', 'mkt'].forEach(p => {
        document.getElementById(`start-date-${p}`).value = first;
        document.getElementById(`end-date-${p}`).value = last;
      });
    }

    async function fetchAndProcessData() {
      showLoader();
      try {
        const res = await fetch(API_URL);
        const result = await res.json();
        
        employeeData = (result.employeeData || []).filter(r => r["Họ Và Tên"]).map(r => ({
          idnv: (r["id"] || '').trim(),
          ten: (r["Họ Và Tên"] || '').trim(),
          email: (r["Email"] || '').trim(),
          team: (r["Team"] || '').trim(),
          chucVu: (r["Vị trí"] || '').trim().toLowerCase()
        }));

        masterData = result.data.filter(r => r["Tên"]).map(r => {
          let thiTruongRaw = (r["Thị_trường"] || '').trim();
          if (thiTruongRaw === 'Nhật' || thiTruongRaw === 'CĐ Nhật Bản') thiTruongRaw = 'Nhật Bản';

          const dsChot = Number(r["Doanh số"]) || 0;
          const dsSauHh = Number(r["DS sau hoàn hủy"]) || 0;
          
          return {
            idnv: (r["id_NS"] || '').trim(),
            ten: (r["Tên"] || '').trim(),
            ngay: new Date(r["Ngày"]),
            ca: (r["ca"] || '').trim(),
            sanPham: (r["Sản_phẩm"] || '').trim(),
            thiTruong: thiTruongRaw,
            team: (r["Team"] || 'Khác').trim(),
            cpqc: Number(r["CPQC"]) || 0,
            soMessCmt: Number(r["Số_Mess_Cmt"]) || 0,
            soDon: Number(r["Số đơn"]) || 0,
            dsChot: dsChot,
            soDonHuy: Number(r["Số đơn hoàn hủy"]) || 0,
            doanhSoHuy: dsChot - dsSauHh,
            dsSauShip: Number(r["Doanh số sau ship"]) || 0,
            kpiValue: Number(r["KPIs"]) || 0,
            soDonThucTe: Number(r["Số đơn thực tế"]) || 0,
            dsChotThucTe: Number(r["Doanh thu chốt thực tế"]) || 0,
            dsHoanHuyThucTe: Number(r["Doanh số hoàn hủy thực tế"]) || 0,
            soDonHuyThucTe: Number(r["Số đơn hoàn hủy thực tế"]) || 0,
            dsThanhCongThucTe: Number(r["Doanh số đi thực tế"]) || 0
          };
        });

        setupView();
        populateFilters();
        applyAllFilters();
      } catch (e) { console.error(e); } finally { hideLoader(); }
    }

    function populateFilters() {
      const blacklist = ['N/A', 'Khác', '', 'undefined'];
      const getUnique = (key) => [...new Set(masterData.map(r => r[key]))].filter(v => v && !blacklist.includes(v)).sort();

      const products = getUnique('sanPham');
      const cas = getUnique('ca');
      const teams = getUnique('team');
      const markets = getUnique('thiTruong');

      const createCbs = (items, cls) => items.map(it => `<label class='indent'><input type='checkbox' class='${cls}' value='${it}' checked> ${it}</label>`).join('');
      
      const createMktCbs = (cls) => {
        let h = '';
        Object.keys(MARKET_GROUPS).forEach(g => {
          h += `<label><input type='checkbox' class='${cls} filter-market-group' value='${g}' checked> <b>${g}</b></label>`;
          h += MARKET_GROUPS[g].map(c => `<label class='indent'><input type='checkbox' class='${cls}' value='${c}' checked> ${c}</label>`).join('');
        });
        const flatGrouped = Object.values(MARKET_GROUPS).flat().map(v => v.toLowerCase());
        const others = markets.filter(m => !flatGrouped.includes(m.toLowerCase()));
        h += createCbs(others, cls);
        return h;
      };

      ['tab1', 'tab3'].forEach(p => {
        document.getElementById(`product-options-${p}`).innerHTML = createCbs(products, `filter-product-${p}`);
        document.getElementById(`ca-options-${p}`).innerHTML = createCbs(cas, `filter-ca-${p}`);
        document.getElementById(`team-options-${p}`).innerHTML = createCbs(teams, `filter-team-${p}`);
        document.getElementById(`market-options-${p}`).innerHTML = createMktCbs(`filter-market-${p}`);
      });

      const opts = (items) => items.map(it => `<option value="${it}">${it}</option>`).join('');
      document.getElementById('product-filter-mkt').innerHTML = opts(products);
      document.getElementById('market-filter-mkt').innerHTML = opts(markets);
      document.getElementById('team-filter-mkt').innerHTML = opts(teams);
    }

    // --- LOGIC BỘ LỌC CẢI TIẾN ---
    function setupEventListeners() {
      document.getElementById('apply-filter-mkt').addEventListener('click', applyTab4);
      
      document.body.addEventListener('change', (e) => {
        const target = e.target;
        if (target.closest('.sidebar')) {
          
          // 1. LOGIC CLICK CHECKBOX TẤT CẢ VÀ CÁC MỤC CON
          ['tab1', 'tab3'].forEach(tab => {
            ['product', 'ca', 'team', 'market'].forEach(type => {
              const allId = `${type}-all-${tab}`;
              const childClass = `filter-${type}-${tab}`;
              
              if (target.id === allId) {
                // Click vào Tất cả -> Đồng bộ tất cả mục con
                document.querySelectorAll(`.${childClass}`).forEach(cb => cb.checked = target.checked);
              } else if (target.classList.contains(childClass)) {
                // Click vào mục con -> Kiểm tra Tất cả
                const allCheckbox = document.getElementById(allId);
                const allChildren = document.querySelectorAll(`.${childClass}`);
                if (allCheckbox) allCheckbox.checked = [...allChildren].every(cb => cb.checked);
              }
            });
          });

          // 2. CHẠY LẠI BỘ LỌC
          if (target.id.includes('tab1') || target.classList.contains('filter-product-tab1') || target.classList.contains('filter-ca-tab1') || target.classList.contains('filter-team-tab1') || target.classList.contains('filter-market-tab1')) applyTab1();
          if (target.id.includes('tab3') || target.classList.contains('filter-product-tab3') || target.classList.contains('filter-ca-tab3') || target.classList.contains('filter-team-tab3') || target.classList.contains('filter-market-tab3')) applyTab3();
        }
      });
    }

    function getFiltered(prefix) {
      const start = new Date(document.getElementById(`start-date-${prefix}`).value);
      const end = new Date(document.getElementById(`end-date-${prefix}`).value);
      start.setHours(0,0,0,0); end.setHours(23,59,59,999);

      let isAllP = true, isAllM = true, isAllT = true, isAllC = true;
      let selP = [], selM = [], selT = [], selC = [];

      if (prefix === 'mkt') {
        selP = Array.from(document.getElementById('product-filter-mkt').selectedOptions).map(o => o.value);
        selM = Array.from(document.getElementById('market-filter-mkt').selectedOptions).map(o => o.value);
        selT = Array.from(document.getElementById('team-filter-mkt').selectedOptions).map(o => o.value);
        isAllP = selP.length === 0; isAllM = selM.length === 0; isAllT = selT.length === 0;
      } else {
        const getInfo = (t) => {
          const isAll = document.getElementById(`${t}-all-${prefix}`).checked;
          const selected = Array.from(document.querySelectorAll(`.filter-${t}-${prefix}:checked`)).map(c => c.value);
          return { isAll, selected };
        };
        const pInfo = getInfo('product'); isAllP = pInfo.isAll; selP = pInfo.selected;
        const mInfo = getInfo('market');  isAllM = mInfo.isAll; selM = mInfo.selected;
        const tInfo = getInfo('team');    isAllT = tInfo.isAll; selT = tInfo.selected;
        const cInfo = getInfo('ca');      isAllC = cInfo.isAll; selC = cInfo.selected;
      }

      // NẾU KHÔNG CHỌN TẤT CẢ VÀ CŨNG KHÔNG CHỌN MỤC NÀO => KHÔNG HIỆN GÌ
      if (!isAllP && selP.length === 0) return [];
      if (!isAllM && selM.length === 0) return [];
      if (!isAllT && selT.length === 0) return [];
      if (!isAllC && selC.length === 0) return [];

      return baseDataForReport.filter(r => {
        if (r.ngay < start || r.ngay > end) return false;
        if (!isAllP && !selP.includes(r.sanPham)) return false;
        if (!isAllT && !selT.includes(r.team)) return false;
        if (!isAllC && !selC.includes(r.ca)) return false;
        if (!isAllM) {
          const group = getGroup(r.thiTruong);
          if (!selM.includes(r.thiTruong) && !selM.includes(group)) return false;
        }
        return true;
      });
    }

    // --- RENDER TABLES ---
    function applyAllFilters() { applyTab1(); applyTab3(); applyTab4(); }

    function applyTab1() {
      const data = getFiltered('tab1');
      const stats = groupStats(data);
      renderSummary(stats, 'summary-body', 'tab1');
      renderDaily(data);
    }

    function applyTab3() {
      const data = getFiltered('tab3');
      const stats = groupStats(data);
      let h = '';
      stats.forEach((s, i) => {
        const cpds = s.dsSauShip ? s.cpqc / s.dsSauShip : 0;
        h += `<tr><td>${i+1}</td><td class='text-left'>${s.team}</td><td class='text-left'>${s.name}</td><td>${fC(s.cpqc)}</td><td>${fC(s.dsChot)}</td><td>${fC(s.dsChotThucTe)}</td><td>${fN(s.soDonHuyThucTe)}</td><td>${fC(s.dsHoanHuyThucTe)}</td><td>${fC(s.dsThanhCongThucTe)}</td><td>${fP(cpds)}</td><td>${fP(s.kpiValue ? s.dsSauShip/s.kpiValue : 0)}</td></tr>`;
      });
      document.getElementById('kpi-summary-body').innerHTML = h;
    }

    function applyTab4() {
      const data = getFiltered('mkt');
      document.getElementById('report-date-mkt').innerText = `Từ ${document.getElementById('start-date-mkt').value} đến ${document.getElementById('end-date-mkt').value}`;
      
      const asia = [], nonAsia = [];
      const asiaMarkets = MARKET_GROUPS['Châu Á'].map(m => m.toLowerCase());
      data.forEach(r => asiaMarkets.includes(r.thiTruong.toLowerCase()) ? asia.push(r) : nonAsia.push(r));

      renderMktTable(asia, 'asia-body-mkt', 'asia-market-mkt');
      renderMktTable(nonAsia, 'non-asia-body-mkt', 'non-asia-market-mkt');
      renderMktTable(data, 'summary-body-mkt', 'summary-market-mkt', false);
      renderCharts(data);
    }

    function renderMktTable(data, bodyId, containerId, showMarket = true) {
      const cont = document.getElementById(containerId);
      if (!data.length) { cont.style.display = 'none'; return; }
      cont.style.display = 'block';

      const groups = {};
      data.forEach(r => {
        const k = `${r.sanPham}|${showMarket ? r.thiTruong : ''}`;
        if (!groups[k]) groups[k] = { sp: r.sanPham, m: r.thiTruong, cp: 0, d: 0, dtt: 0, dh: 0, ms: 0, ds: 0, dstt: 0, dsh: 0 };
        const g = groups[k];
        g.cp += r.cpqc; g.d += r.soDon; g.dtt += r.soDonThucTe; g.dh += r.soDonHuyThucTe; g.ms += r.soMessCmt; g.ds += r.dsChot; g.dstt += r.dsChotThucTe; g.dsh += r.dsHoanHuyThucTe;
      });

      let h = '';
      Object.values(groups).forEach(g => {
        const d_sau_h = g.dstt - g.dsh;
        const d_thuc_te = g.dtt - g.dh;
        h += `<tr><td class='text-left'>${g.sp}</td>${showMarket ? `<td class='text-left'>${g.m}</td>` : '<td></td>'}<td>${fC(g.cp)}</td><td>${fN(g.d)}</td><td>${fN(d_thuc_te)}</td><td>${fN(g.ms)}</td><td>${fC(g.ds)}</td><td>${fC(g.dstt)}</td><td>${fC(g.dsh)}</td><td>${fC(d_sau_h)}</td><td>${fP(d_sau_h ? g.cp/d_sau_h : 0)}</td><td>${fC(g.d ? g.cp/g.d : 0)}</td><td>${fC(g.d ? d_sau_h/g.d : 0)}</td><td>${fP(g.ms ? g.d/g.ms : 0)}</td><td>${fP(g.ms ? d_thuc_te/g.ms : 0)}</td></tr>`;
      });
      document.getElementById(bodyId).innerHTML = h;
    }

    // --- UTILS ---
    function groupStats(data) {
      const s = {};
      data.forEach(r => {
        if (!s[r.ten]) s[r.ten] = { name: r.ten, team: r.team, mess: 0, cpqc: 0, don: 0, donTT: 0, ds: 0, dsTT: 0, donHuy: 0, dsHuy: 0, dsSauShip: 0, kpiValue: 0, soDonHuyThucTe: 0, dsHoanHuyThucTe: 0, dsThanhCongThucTe: 0 };
        const g = s[r.ten];
        g.mess += r.soMessCmt; g.cpqc += r.cpqc; g.don += r.soDon; g.donTT += r.soDonThucTe; g.ds += r.dsChot; g.dsTT += r.dsChotThucTe; g.donHuy += r.soDonHuy; g.dsHuy += r.doanhSoHuy; g.dsSauShip += r.dsSauShip; g.kpiValue += r.kpiValue; g.soDonHuyThucTe += r.soDonHuyThucTe; g.dsHoanHuyThucTe += r.dsHoanHuyThucTe; g.dsThanhCongThucTe += r.dsThanhCongThucTe;
      });
      return Object.values(s);
    }

    function renderSummary(stats, bodyId, prefix) {
      let h = '';
      const selM = Array.from(document.querySelectorAll(`.filter-market-${prefix}:checked`)).map(c => c.value);
      stats.forEach((s, i) => {
        const d_tt = s.donTT - s.soDonHuyThucTe;
        const ds_tt = s.dsTT - s.dsHoanHuyThucTe;
        const rate = s.mess ? s.don / s.mess : 0;
        const rateTT = s.mess ? d_tt / s.mess : 0;
        const cps = d_tt ? s.cpqc / d_tt : 0;
        h += `<tr><td>${i+1}</td><td class='text-left'>${s.team}</td><td class='text-left'>${s.name}</td><td>${fN(s.mess)}</td><td>${fC(s.cpqc)}</td><td>${fN(s.don)}</td><td>${fN(d_tt)}</td><td>${fC(s.ds)}</td><td>${fC(ds_tt)}</td><td class='${rate > 0.1 ? 'bg-green' : 'bg-yellow'}'>${fP(rate)}</td><td>${fP(rateTT)}</td><td>${fC(s.mess ? s.cpqc/s.mess : 0)}</td><td class='${getCpsStyle(cps, selM)}'>${fC(cps)}</td><td>${fP(ds_tt ? s.cpqc/ds_tt : 0)}</td><td>${fC(d_tt ? ds_tt/d_tt : 0)}</td></tr>`;
      });
      document.getElementById(bodyId).innerHTML = h;
    }

    function renderDaily(data) {
      const g = {};
      data.forEach(r => { const d = formatDate(r.ngay); if (!g[d]) g[d] = []; g[d].push(r); });
      const sorted = Object.keys(g).sort((a,b) => new Date(b.split('/').reverse().join('-')) - new Date(a.split('/').reverse().join('-')));
      document.getElementById('daily-breakdown').innerHTML = sorted.map(d => `<h3>${d}</h3><div class='table-responsive-container'><table><thead><tr class='green-header'><th>STT</th><th>Team</th><th>MKT</th><th>Mess</th><th>CPQC</th><th>Đơn</th><th>Đơn (TT)</th><th>DS Chốt</th><th>DS (TT)</th><th>Tỉ lệ</th><th>Tỉ lệ (TT)</th><th>Giá Mess</th><th>CPS</th><th>%CP/DS</th><th>Giá TB Đơn</th></tr></thead><tbody>${groupDailyRows(g[d])}</tbody></table></div>`).join('');
    }

    function groupDailyRows(data) {
      const stats = groupStats(data);
      let h = '';
      stats.forEach((s, i) => {
        const d_tt = s.donTT - s.soDonHuyThucTe;
        const ds_tt = s.dsTT - s.dsHoanHuyThucTe;
        h += `<tr><td>${i+1}</td><td class='text-left'>${s.team}</td><td class='text-left'>${s.name}</td><td>${fN(s.mess)}</td><td>${fC(s.cpqc)}</td><td>${fN(s.don)}</td><td>${fN(d_tt)}</td><td>${fC(s.ds)}</td><td>${fC(ds_tt)}</td><td>${fP(s.mess ? s.don/s.mess : 0)}</td><td>${fP(s.mess ? d_tt/s.mess : 0)}</td><td>${fC(s.mess ? s.cpqc/s.mess : 0)}</td><td>${fC(d_tt ? s.cpqc/d_tt : 0)}</td><td>${fP(ds_tt ? s.cpqc/ds_tt : 0)}</td><td>${fC(d_tt ? ds_tt/d_tt : 0)}</td></tr>`;
      });
      return h;
    }

    // --- HELPERS ---
    const fC = (v) => Number(v||0).toLocaleString('vi-VN', { style:'currency', currency:'VND'});
    const fN = (v) => Number(v||0).toLocaleString('vi-VN');
    const fP = (v) => (Number(v||0)*100).toFixed(2) + '%';
    const formatDate = (d) => `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
    const showLoader = () => document.getElementById('loading-overlay').classList.add('visible');
    const hideLoader = () => document.getElementById('loading-overlay').classList.remove('visible');
    const getGroup = (m) => { for(let g in MARKET_GROUPS) if(MARKET_GROUPS[g].includes(m)) return g; return 'Khác'; };

    function getCpsStyle(cps, selM) {
      const isAsia = selM.some(m => m === 'Châu Á' || MARKET_GROUPS['Châu Á'].includes(m));
      if (isAsia) return cps > 1000000 ? 'bg-lightred' : (cps > 700000 ? 'bg-yellow' : '');
      return cps > 1500000 ? 'bg-lightred' : (cps > 1000000 ? 'bg-yellow' : '');
    }

    function setupView() {
      const id = new URLSearchParams(window.location.search).get('id');
      if (!id) { baseDataForReport = masterData; return; }
      const user = employeeData.find(e => e.idnv === id);
      if (user) {
        if (user.chucVu === 'leader') {
          document.getElementById('report-title-tab1').innerText = `TEAM ${user.team}`;
          baseDataForReport = masterData.filter(r => r.team === user.team);
        } else {
          document.getElementById('report-title-tab1').innerText = `CÁ NHÂN: ${user.ten}`;
          baseDataForReport = masterData.filter(r => r.ten === user.ten);
        }
        document.getElementById('manual-report-tab-btn').style.display = 'block';
        document.getElementById('manual-report-iframe').src = `https://nguyenbatyads37.github.io/static-html-show-data/baoCaoThuCong.html?hoten=${encodeURIComponent(user.ten)}&email=${user.email}&tableName=Báo cáo MKT&hideColumns=Page`;
      }
    }

    function openTab(evt, name) {
      document.querySelectorAll(".tab-content").forEach(c => c.style.display = "none");
      document.querySelectorAll(".tablinks").forEach(l => l.classList.remove("active"));
      document.getElementById(name).style.display = "block";
      evt.currentTarget.classList.add("active");
    }

    function initMarketReportCharts() {
      const opt = (title) => ({ responsive: true, plugins: { title: { display: true, text: title }, legend: { display: false }, datalabels: { anchor: 'end', align: 'right' } }, indexAxis: 'y' });
      charts.s = new Chart(document.getElementById('mktProductSalesChart'), { type: 'bar', data: { labels: [], datasets: [{ backgroundColor: CHART_COLORS, data: [] }] }, options: opt('DS Sau HH (TT)') });
      charts.c = new Chart(document.getElementById('mktProductCpqcChart'), { type: 'bar', data: { labels: [], datasets: [{ backgroundColor: CHART_COLORS, data: [] }] }, options: opt('Chi phí Quảng cáo') });
      charts.ds = new Chart(document.getElementById('mktProductDsChotChart'), { type: 'bar', data: { labels: [], datasets: [{ backgroundColor: CHART_COLORS, data: [] }] }, options: opt('DS Chốt (TT)') });
      charts.cps = new Chart(document.getElementById('mktProductCpsChart'), { type: 'bar', data: { labels: [], datasets: [{ backgroundColor: CHART_COLORS, data: [] }] }, options: opt('CPS (Chi phí/Đơn)') });
      charts.rate = new Chart(document.getElementById('mktProductClosingRateChart'), { type: 'doughnut', data: { labels: [], datasets: [{ data: [] }] }, options: { plugins: { title: { display: true, text: 'Tỉ lệ chốt' } } } });
    }

    function renderCharts(data) {
      const p = {};
      data.forEach(r => {
        if (!p[r.sanPham]) p[r.sanPham] = { cp: 0, dtt: 0, dh: 0, dstt: 0, dsh: 0, ms: 0 };
        const g = p[r.sanPham]; g.cp += r.cpqc; g.dtt += r.soDonThucTe; g.dh += r.soDonHuyThucTe; g.dstt += r.dsChotThucTe; g.dsh += r.dsHoanHuyThucTe; g.ms += r.soMessCmt;
      });
      const labels = Object.keys(p);
      const update = (chart, vals) => { chart.data.labels = labels; chart.data.datasets[0].data = vals; chart.update(); };
      update(charts.s, labels.map(l => p[l].dstt - p[l].dsh));
      update(charts.c, labels.map(l => p[l].cp));
      update(charts.ds, labels.map(l => p[l].dstt));
      update(charts.cps, labels.map(l => (p[l].dtt - p[l].dh) ? p[l].cp / (p[l].dtt - p[l].dh) : 0));
      update(charts.rate, labels.map(l => p[l].ms ? (p[l].dtt - p[l].dh) / p[l].ms : 0));
      document.getElementById('mkt-charts-section').style.display = 'block';
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="vi">
<head>
    <!-- Phần head giữ nguyên như trước -->
    <!-- ... -->
</head>
<body>
    <!-- Phần body giữ nguyên cho đến phần script -->
    <!-- ... -->

    <script>
        // ... (phần trước giữ nguyên)

        // Hàm tải dữ liệu từ Google Sheets
        async function loadReportData(studentId) {
            const spreadsheetId = '17vWieOZewahahS757ph6w4rzMs7DPDHYnUj40P4bY44';
            const gid = '1842364838';
            const url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?tqx=out:json&gid=${gid}`;
            
            try {
                const response = await fetch(url);
                const text = await response.text();
                const jsonText = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]+)\)/)[1];
                const data = JSON.parse(jsonText);
                
                const rows = data.table.rows;
                const studentData = rows.filter(row => row.c[1]?.v === studentId).map(row => ({
                    subject: row.c[2]?.v || '',
                    question: row.c[3]?.v || '',
                    total: row.c[4]?.v || 0,
                    deducted: row.c[5]?.v || 0,
                    achieved: row.c[6]?.v || 0,
                    errors: row.c[7]?.v || '',
                    improvementContent: row.c[9]?.v || ''  // Cột J - Nội dung cần cải thiện (cho Văn và Anh)
                }));
                
                if (studentData.length === 0) {
                    document.getElementById('report-content').innerHTML = `
                        <div class="error-container">
                            <div class="error-title">KHÔNG TÌM THẤY DỮ LIỆU</div>
                            <p class="error-text">Không có kết quả nào cho thí sinh <strong>${studentId}</strong></p>
                            <p class="error-text">Vui lòng kiểm tra lại mã thí sinh</p>
                        </div>
                    `;
                    return;
                }
                
                generateReport(studentData);
            } catch (error) {
                console.error('Lỗi khi tải dữ liệu:', error);
                document.getElementById('report-content').innerHTML = `
                    <div class="error-container">
                        <div class="error-title">LỖI KHI TẢI DỮ LIỆU</div>
                        <p class="error-text">${error.message}</p>
                        <p class="error-text">Vui lòng kiểm tra lại kết nối hoặc quyền truy cập</p>
                    </div>
                `;
            }
        }
        
        // Hàm tạo báo cáo
        function generateReport(data) {
            const subjects = {};
            data.forEach(item => {
                if (!subjects[item.subject]) {
                    subjects[item.subject] = [];
                }
                subjects[item.subject].push(item);
            });
            
            let reportHTML = '';
            
            for (const subject in subjects) {
                const subjectData = subjects[subject];
                let totalScore = subjectData.reduce((sum, item) => sum + item.total, 0);
                let achievedScore = subjectData.reduce((sum, item) => sum + item.achieved, 0);
                
                // Scale scores for Literature (Văn) and English (Anh) to max 10
                if (subject.toLowerCase() === 'văn' || subject.toLowerCase() === 'anh') {
                    const maxPossibleScore = subjectData.length * 10;
                    totalScore = maxPossibleScore;
                    achievedScore = (achievedScore / subjectData.reduce((sum, item) => sum + item.total, 0)) * maxPossibleScore;
                    achievedScore = Math.round(achievedScore * 10) / 10;
                }
                
                const percentage = Math.round((achievedScore / totalScore) * 100);
                
                const strengths = subjectData.filter(item => item.deducted === 0);
                const weaknesses = subjectData.filter(item => item.deducted > 0);
                
                reportHTML += `
                    <div class="subject-panel">
                        <div class="subject-header" onclick="toggleSubject(this)">
                            <h3 class="subject-title">Môn: ${subject}</h3>
                            <div class="subject-score">${achievedScore.toFixed(1)}/${totalScore.toFixed(1)} (${percentage}%)</div>
                        </div>
                        
                        <div class="subject-content active">
                            <table class="score-table">
                                <thead>
                                    <tr>
                                        <th>Câu hỏi</th>
                                        <th>Tổng điểm</th>
                                        <th>Điểm đạt</th>
                                        <th>Điểm trừ</th>
                                        <th>Lỗi sai</th>
                                        ${subject.toLowerCase() === 'văn' || subject.toLowerCase() === 'anh' ? '<th>Nội dung cần cải thiện</th>' : ''}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${subjectData.map(item => {
                                        let displayTotal = item.total;
                                        let displayAchieved = item.achieved;
                                        if (subject.toLowerCase() === 'văn' || subject.toLowerCase() === 'anh') {
                                            displayTotal = 10;
                                            displayAchieved = (item.achieved / item.total) * 10;
                                            displayAchieved = Math.round(displayAchieved * 10) / 10;
                                        }
                                        return `
                                            <tr>
                                                <td>${item.question}</td>
                                                <td>${displayTotal}</td>
                                                <td class="${item.deducted === 0 ? 'perfect' : 'lost'}">${displayAchieved.toFixed(1)}</td>
                                                <td>${item.deducted}</td>
                                                <td>${item.errors || '-'}</td>
                                                ${subject.toLowerCase() === 'văn' || subject.toLowerCase() === 'anh' ? `<td>${item.improvementContent || '-'}</td>` : ''}
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                            
                            ${strengths.length > 0 ? `
                                <div class="analysis-box strengths-box">
                                    <h4 class="analysis-title">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2">
                                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                        </svg>
                                        Điểm Mạnh
                                    </h4>
                                    <ul class="analysis-list">
                                        <li>Hoàn thành tốt ${strengths.length}/${subjectData.length} câu hỏi</li>
                                        <li>Các câu làm tốt: ${strengths.map(item => item.question).join(', ')}</li>
                                    </ul>
                                </div>
                            ` : ''}
                            
                            ${weaknesses.length > 0 ? `
                                <div class="analysis-box weaknesses-box">
                                    <h4 class="analysis-title">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <line x1="12" y1="8" x2="12" y2="12"></line>
                                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                                        </svg>
                                        Điểm Cần Cải Thiện
                                    </h4>
                                    <ul class="analysis-list">
                                        ${weaknesses.map(item => {
                                            // Sử dụng improvementContent (cột J) cho Văn và Anh, errors cho các môn khác
                                            const improvementText = 
                                                subject.toLowerCase() === 'văn' || subject.toLowerCase() === 'anh' 
                                                ? item.improvementContent || 'Không xác định' 
                                                : item.errors || 'Không xác định';
                                            
                                            return `<li>Câu ${item.question}: ${improvementText} (-${item.deducted} điểm)</li>`;
                                        }).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            
                            <div class="progress-container">
                                <div class="progress-header">
                                    <span class="progress-title">Mức độ hoàn thành</span>
                                    <span class="progress-value">${percentage}%</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${percentage}%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('report-content').innerHTML = reportHTML;
        }

        // ... (phần sau giữ nguyên)
    </script>
</body>
</html>


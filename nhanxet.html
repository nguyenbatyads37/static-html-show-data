<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Báo cáo kết quả học tập</title>
  <style>
    :root{--primary:#0047AB;--border:#e2e8f0;--dark:#0f172a;--gray:#6b7280;}
    *{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:'Inter',sans-serif;background:#f8fafc;color:var(--dark);}
    .container{max-width:800px;margin:20px auto;padding:20px;background:#fff;border:3px solid var(--primary);border-radius:8px;}
    header{text-align:center;margin-bottom:20px;}
    header h1{color:var(--primary);font-size:24px;}
    header p{font-size:14px;color:var(--gray);}
    .info{display:flex;justify-content:space-between;margin-bottom:20px;font-size:14px;}
    .info div{flex:1;text-align:center;}
    .summary{display:flex;justify-content:space-between;flex-wrap:wrap;margin-bottom:20px;}
    .card{flex:1;min-width:150px;margin:5px;padding:10px;border:1px solid var(--border);border-radius:4px;text-align:center;}
    .card p{margin-bottom:8px;font-weight:500;}
    .card h3{margin:0;font-size:18px;color:var(--primary);}
    .scores{display:flex;flex-wrap:wrap;margin-bottom:20px;}
    .subject{flex:1;min-width:100%;margin-bottom:10px;}
    .score-table{width:100%;border-collapse:collapse;font-size:12px;}
    .score-table th,.score-table td{border:1px solid var(--border);padding:6px;}
    .footer{font-size:12px;color:var(--gray);text-align:center;}
    @media print{ @page{size:A4;margin:10mm;}body,.container{background:#fff!important;color:#000!important;width:100%!important;} }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>BÁO CÁO KẾT QUẢ HỌC TẬP</h1>
      <p>Công ty TNHH Giáo Dục Nhất Đạo EDU</p>
    </header>
    <div class="info" id="student-info">
      <div><strong>Mã HS:</strong> <span id="stu-id"></span></div>
      <div><strong>Họ và tên:</strong> <span id="stu-name"></span></div>
      <div><strong>Ngày:</strong> <span id="report-date"></span></div>
    </div>
    <div class="summary">
      <div class="card"><p>Tổng điểm</p><h3 id="total-score"></h3></div>
      <div class="card"><p>Tỷ lệ</p><h3 id="percentage"></h3></div>
      <div class="card"><p>Số môn</p><h3 id="subject-count"></h3></div>
    </div>
    <div class="scores" id="report-content"></div>
    <div id="wish-comment"></div>
    <footer class="footer">
      Báo cáo tạo ngày <span id="report-date-footer"></span>
    </footer>
  </div>
  <script>
    // Hiển thị ngày
    const today=new Date().toLocaleDateString('vi-VN');
    document.getElementById('report-date').textContent=today;
    document.getElementById('report-date-footer').textContent=today;
    // Lấy param
    const params=new URLSearchParams(window.location.search);
    const studentId=params.get('id');
    const studentName=params.get('ten')||'Không có thông tin';
    if(!studentId){
      document.querySelector('#student-info').innerHTML='<div style="color:red;">Thiếu mã HS</div>';
    }else{
      renderStudentInfo(studentId,studentName);
      loadReportData(studentId);
      loadStudentComment(studentId);
    }
    function renderStudentInfo(id,name){
      document.getElementById('stu-id').textContent=id;
      document.getElementById('stu-name').textContent=name;
    }
    async function loadReportData(id){
      const url=`https://docs.google.com/spreadsheets/d/17vWieOZewahahS757ph6w4rzMs7DPDHYnUj40P4bY44/gviz/tq?tqx=out:json&gid=1842364838`;
      try{
        const res=await fetch(url);const text=await res.text();
        const data=JSON.parse(text.match(/setResponse\((.*)\)/)[1]);
        const rows=data.table.rows.filter(r=>r.c[1]?.v===id);
        if(!rows.length){document.getElementById('report-content').innerHTML='<p>Không có dữ liệu</p>';return;}
        const subjects={},ach=0,tot=0;
        rows.forEach(r=>{
          const s=r.c;
          const subj=s[2]?.v;subjects[subj]=subjects[subj]||[];
          subjects[subj].push({question:s[3]?.v,total:s[4]?.v,achieved:s[6]?.v,deducted:s[5]?.v,errors:s[7]?.v});
          ach+=s[6]?.v;tot+=s[4]?.v;
        });
        document.getElementById('total-score').textContent=`${ach}/${tot}`;
        document.getElementById('percentage').textContent=Math.round((ach/tot)*100)+'%';
        document.getElementById('subject-count').textContent=Object.keys(subjects).length;
        renderSubjects(subjects);
      }catch(e){console.error(e);}    }
    function renderSubjects(subjects){
      const container=document.getElementById('report-content');container.innerHTML='';
      for(const sub in subjects){const items=subjects[sub];
        let table='<table class="score-table"><tr><th>Môn</th><th>Câu</th><th>Tổng</th><th>Đạt</th><th>Trừ</th><th>Lỗi</th></tr>';
        items.forEach(i=>table+=`<tr><td>${sub}</td><td>${i.question}</td><td>${i.total}</td><td>${i.achieved}</td><td>${i.deducted}</td><td>${i.errors||'-'}</td></tr>`);
        table+='</table>';
        container.innerHTML+=`<div class="subject">${table}</div>`;
      }
    }
    async function loadStudentComment(id){
      const url=`https://docs.google.com/spreadsheets/d/17vWieOZewahahS757ph6w4rzMs7DPDHYnUj40P4bY44/gviz/tq?tqx=out:json&gid=0`;
      try{
        const res=await fetch(url);const text=await res.text();
        const data=JSON.parse(text.match(/setResponse\((.*)\)/)[1]);
        const row=data.table.rows.find(r=>r.c[0]?.v===id);
        const comment=row?.c[8]?.v||'';
        renderWishComment(comment);
      }catch(e){console.error(e);}    }
    function renderWishComment(comment){
      const div=document.getElementById('wish-comment');
      div.innerHTML=`<h3 style="color:var(--primary)">Lời nhắn</h3><p>Chúc em tiếp tục phát huy điểm mạnh.</p>`;
      if(comment)div.innerHTML+=`<h3 style="color:var(--primary)">Nhận xét GV</h3><p>${comment.replace(/\n/g,'<br>')}</p>`;
    }
  </script>
</body>
</html>

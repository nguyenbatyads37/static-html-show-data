<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Báo cáo kết quả học tập</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
    <style>
        /* [Giữ nguyên toàn bộ phần CSS như cũ] */
        /* ... */
    </style>
</head>
<body>
    <div class="report-container" id="report-card">
        <div class="report-header">
            <div class="header-content">
                <div class="logo-container">
                    <img src="https://www.appsheet.com/template/gettablefileurl?appName=B%C3%A1ogi%C3%A1s%E1%BA%A3nph%E1%BA%A9m-325045268&tableName=c%C3%A0i%20%C4%91%E1%BA%B7t%20APP&fileName=C%C3%A0i%20%C4%91%E1%BA%B7t%20APP_Images%2F3a2368ed.%E1%BA%A2nh.011317.png" class="logo-img" alt="Nhất Đạo EDU Logo">
                </div>
                <div class="title-container">
                    <h1>BÁO CÁO KẾT QUẢ HỌC TẬP</h1>
                    <div class="center-name">Công ty TNHH Giáo Dục Nhất Đạo EDU</div>
                </div>
            </div>
            
            <div class="student-info-container" id="student-info">
                <div class="loading-spinner"></div>
            </div>
        </div>
        
        <div id="report-content">
            <div class="loading-container">
                <div class="loading-spinner"></div>
                <p class="loading-text">Đang tải dữ liệu...</p>
            </div>
        </div>
        
        <div class="report-footer">
            <p>Báo cáo được tạo tự động vào <span id="report-date"></span></p>
            <p class="footer-contact">Công ty TNHH Giáo Dục Nhất Đạo EDU | Email: contact@nhatdao.edu | Hotline: 0123 456 789</p>
        </div>
    </div>

    <script>
        // Hiển thị ngày báo cáo
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('report-date').textContent = new Date().toLocaleDateString('vi-VN', options);
        
        // Lấy tham số từ URL (chỉ lấy id và tên)
        const urlParams = new URLSearchParams(window.location.search);
        const studentId = urlParams.get('id');
        const studentName = decodeURIComponent(urlParams.get('ten') || 'Không có thông tin');
        
        // Kiểm tra nếu không có ID
        if (!studentId) {
            document.getElementById('student-info').innerHTML = `
                <div class="error-container">
                    <div class="error-title">THIẾU MÃ THÍ SINH</div>
                    <p class="error-text">Vui lòng truyền mã thí sinh qua URL (ví dụ: ?id=ND134&ten=NguyenVanA)</p>
                </div>
            `;
            
            document.getElementById('report-content').innerHTML = `
                <div class="error-container">
                    <div class="error-title">KHÔNG THỂ TẢI BÁO CÁO</div>
                    <p class="error-text">Thiếu thông tin mã thí sinh trong URL</p>
                </div>
            `;
        } else {
            renderStudentInfo(studentId, studentName);
            loadReportData(studentId);
        }
        
        // Hiển thị thông tin học sinh (đơn giản)
        function renderStudentInfo(id, name) {
            document.getElementById('student-info').innerHTML = `
                <div class="student-info-card">
                    <div class="info-label">Mã Thí Sinh</div>
                    <div class="info-value student-id">${id}</div>
                </div>
                <div class="student-info-card">
                    <div class="info-label">Họ và Tên</div>
                    <div class="info-value">${name}</div>
                </div>
                <div class="student-info-card">
                    <div class="info-label">Ngày Báo Cáo</div>
                    <div class="info-value">${new Date().toLocaleDateString('vi-VN')}</div>
                </div>
            `;
        }
        
        // Hàm tải dữ liệu từ Google Sheets
        async function loadReportData(studentId) {
            const spreadsheetId = '17vWieOZewahahS757ph6w4rzMs7DPDHYnUj40P4bY44';
            const gid = '1842364838';
            const url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?tqx=out:json&gid=${gid}`;
            
            try {
                const response = await fetch(url);
                const text = await response.text();
                const jsonText = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]+)\)/)[1];
                const data = JSON.parse(jsonText);
                
                const rows = data.table.rows;
                const studentData = rows.filter(row => row.c[1]?.v === studentId).map(row => ({
                    subject: row.c[2]?.v || '',
                    question: row.c[3]?.v || '',
                    total: row.c[4]?.v || 0,
                    deducted: row.c[5]?.v || 0,
                    achieved: row.c[6]?.v || 0,
                    errors: row.c[7]?.v || ''
                }));
                
                if (studentData.length === 0) {
                    document.getElementById('report-content').innerHTML = `
                        <div class="error-container">
                            <div class="error-title">KHÔNG TÌM THẤY DỮ LIỆU</div>
                            <p class="error-text">Không có kết quả nào cho thí sinh <strong>${studentId}</strong></p>
                            <p class="error-text">Vui lòng kiểm tra lại mã thí sinh</p>
                        </div>
                    `;
                    return;
                }
                
                generateReport(studentData);
            } catch (error) {
                console.error('Lỗi khi tải dữ liệu:', error);
                document.getElementById('report-content').innerHTML = `
                    <div class="error-container">
                        <div class="error-title">LỖI KHI TẢI DỮ LIỆU</div>
                        <p class="error-text">${error.message}</p>
                        <p class="error-text">Vui lòng kiểm tra lại kết nối hoặc quyền truy cập</p>
                    </div>
                `;
            }
        }
        
        // Hàm tạo báo cáo (không có phần điểm Văn/Anh)
        function generateReport(data) {
            const subjects = {};
            data.forEach(item => {
                if (!subjects[item.subject]) {
                    subjects[item.subject] = [];
                }
                subjects[item.subject].push(item);
            });
            
            let reportHTML = '';
            
            for (const subject in subjects) {
                const subjectData = subjects[subject];
                let totalScore = 10;
                let achievedScore = subjectData.reduce((sum, item) => sum + item.achieved, 0);
                
                const rawTotal = subjectData.reduce((sum, item) => sum + item.total, 0);
                if (rawTotal > 0) {
                    achievedScore = (achievedScore / rawTotal) * 10;
                    achievedScore = Math.round(achievedScore * 10) / 10;
                } else {
                    achievedScore = 0;
                }
                
                const strengths = subjectData.filter(item => item.deducted === 0);
                const weaknesses = subjectData.filter(item => item.deducted > 0);
                
                reportHTML += `
                    <div class="subject-panel">
                        <div class="subject-header" onclick="toggleSubject(this)">
                            <h3 class="subject-title">Môn: ${subject}</h3>
                            <div class="subject-score">${achievedScore.toFixed(1)}/10</div>
                        </div>
                        
                        <div class="subject-content">
                            <table class="score-table">
                                <thead>
                                    <tr>
                                        <th>Câu hỏi</th>
                                        <th>Tổng điểm</th>
                                        <th>Điểm đạt</th>
                                        <th>Điểm trừ</th>
                                        <th>Lỗi sai</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${subjectData.map(item => {
                                        let displayTotal = item.total;
                                        let displayAchieved = item.achieved;
                                        if (item.total > 0) {
                                            displayTotal = 10;
                                            displayAchieved = (item.achieved / item.total) * 10;
                                            displayAchieved = Math.round(displayAchieved * 10) / 10;
                                        } else {
                                            displayTotal = 10;
                                            displayAchieved = 0;
                                        }
                                        return `
                                            <tr>
                                                <td>${item.question}</td>
                                                <td>${displayTotal}</td>
                                                <td class="${item.deducted === 0 ? 'perfect' : 'lost'}">${displayAchieved.toFixed(1)}</td>
                                                <td>${item.deducted}</td>
                                                <td>${item.errors || '-'}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                            
                            ${strengths.length > 0 ? `
                                <div class="analysis-box strengths-box">
                                    <h4 class="analysis-title">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2">
                                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                        </svg>
                                        Điểm Mạnh
                                    </h4>
                                    <ul class="analysis-list">
                                        <li>Hoàn thành tốt ${strengths.length}/${subjectData.length} câu hỏi</li>
                                        <li>Các câu làm tốt: ${strengths.map(item => item.question).join(', ')}</li>
                                    </ul>
                                </div>
                            ` : ''}
                            
                            ${weaknesses.length > 0 ? `
                                <div class="analysis-box weaknesses-box">
                                    <h4 class="analysis-title">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <line x1="12" y1="8" x2="12" y2="12"></line>
                                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                                        </svg>
                                        Điểm Cần Cải Thiện
                                    </h4>
                                    <ul class="analysis-list">
                                        ${weaknesses.map(item => `
                                            <li>Câu ${item.question}: ${item.errors || 'Không xác định'} (-${item.deducted} điểm)</li>
                                        `).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('report-content').innerHTML = reportHTML;
        }

        // Hàm toggle hiển thị nội dung môn học
        function toggleSubject(header) {
            const content = header.nextElementSibling;
            header.classList.toggle('collapsed');
            content.classList.toggle('active');
        }
    </script>
</body>
</html>


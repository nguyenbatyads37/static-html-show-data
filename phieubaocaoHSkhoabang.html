<!DOCTYPE html>
<html lang='vi'>
<head>
  <meta charset='UTF-8'>
  <title>Báo cáo học tập</title>
  <style>
    /* [Giữ nguyên phần CSS như trước] */
  </style>
</head>
<body>

<div class='trf-container'>
  <!-- [Giữ nguyên phần HTML như trước] -->
</div>

<script>
  // Hàm lấy tham số từ URL
  function getUrlParameter(name) {
    name = name.replace(/[\[\]]/g, '\\$&');
    var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
        results = regex.exec(window.location.search);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, ' '));
  }

  // Lấy các tham số từ URL
  const ten = getUrlParameter('ten');
  const lop = getUrlParameter('lop');
  const id = getUrlParameter('id');
  const diem = getUrlParameter('diem');
  const btvn = getUrlParameter('btvn');
  const sao = getUrlParameter('sao');
  const nhanxet = getUrlParameter('nhanxet');
  const data = getUrlParameter('data');

  // Cập nhật thông tin học viên
  document.getElementById('student-name').textContent = ten || '[Tên học sinh]';
  document.getElementById('student-class').textContent = lop || '[Tên lớp]';
  document.getElementById('student-id').textContent = id || '[Mã học sinh]';
  
  // Cập nhật ngày báo cáo
  const today = new Date();
  document.getElementById('report-date').textContent = 
    today.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });
  
  // Cập nhật điểm số
  document.getElementById('attendance').textContent = '[Chuyên cần]';
  document.getElementById('test-score').textContent = diem || '[Điểm kiểm tra]';
  document.getElementById('homework').textContent = btvn || '[Điểm BTVN]';
  document.getElementById('stars').textContent = sao ? sao + ' ⭐' : '[Số sao]';
  
  // Cập nhật nhận xét
  document.getElementById('comment').innerHTML = nhanxet || '[Nhận xét buổi học]';

  // Xử lý dữ liệu bảng chi tiết
  if (data) {
    const danhSachHocTap = data.split('_b_').map((item, index) => {
      const parts = item.split('_a_');
      return {
        stt: index + 1,
        ngay: parts[0] || 'N/A',
        chuyenCan: parts[1] ? parseInt(parts[1]) : 0,
        hoanThanhBT: parts[2] ? parseInt(parts[2]) : 0,
        diemKiemTra: parts[3] ? parseInt(parts[3]) : 0,
        diemManh: parts[4] || 'Không có',
        diemYeu: parts[5] || 'Không có'
      };
    });

    // Render bảng
    const tableBody = document.getElementById('tableBody');
    tableBody.innerHTML = danhSachHocTap.map(item => `
      <tr>
        <td class="center-text">${item.stt}</td>
        <td>${item.ngay}</td>
        <td class="center-text">${item.chuyenCan}%</td>
        <td class="center-text">${item.hoanThanhBT}%</td>
        <td class="center-text">${item.diemKiemTra}%</td>
        <td>${item.diemManh}</td>
        <td>${item.diemYeu}</td>
      </tr>
    `).join('');

    // Tính toán tổng hợp
    if (danhSachHocTap.length > 0) {
      const totalAttendance = Math.round(danhSachHocTap.reduce((sum, item) => sum + item.chuyenCan, 0) / danhSachHocTap.length;
      const totalHomework = Math.round(danhSachHocTap.reduce((sum, item) => sum + item.hoanThanhBT, 0) / danhSachHocTap.length;
      const totalTest = Math.round(danhSachHocTap.reduce((sum, item) => sum + item.diemKiemTra, 0) / danhSachHocTap.length);
      
      document.getElementById('total-attendance').textContent = `${totalAttendance}%`;
      document.getElementById('total-homework').textContent = `${totalHomework}%`;
      document.getElementById('total-test').textContent = `${totalTest}%`;
      document.getElementById('total-sessions').textContent = danhSachHocTap.length;
    }
  } else {
    document.getElementById('tableBody').innerHTML = `
      <tr>
        <td colspan="7" class="center-text">Không có dữ liệu học tập</td>
      </tr>
    `;
  }
</script>

</body>
</html>

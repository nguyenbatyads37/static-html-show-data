<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Báo cáo học tập</title>
  <style>
    /* Các style CSS ở đây */
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="trf-container">
  <div class="header">
    <div class="header-left">
      <h1>BÁO CÁO KẾT QUẢ HỌC TẬP</h1>
      <p><strong>Trung tâm khoa bảng - Lớp thầy DR.Henry Đàm trân trọng thông báo!</strong></p>
    </div>
    <div class="logo-group">
      <img src="https://github.com/nguyenbatyads37/static-html-show-data/blob/main/KHOA%20B%E1%BA%A2NG%201-01.jpg?raw=true" alt="Logo">
    </div>
  </div>

  <div class="section-title">THÔNG TIN HỌC VIÊN</div>
  <table class="candidate-details">
    <tr>
      <td rowspan="4" style="width: 150px; text-align:center;">
        <div class="candidate-photo"></div>
      </td>
      <th>Họ và tên</th>
      <td id="student-name">[Tên học sinh]</td>
    </tr>
    <tr>
      <th>Lớp</th>
      <td id="student-class">[Tên lớp]</td>
    </tr>
    <tr>
      <th>Xếp hạng</th>
      <td id="student-id">[Mã học sinh]</td>
    </tr>
    <tr>
      <th>Ngày báo cáo</th>
      <td id="report-date">[Ngày báo cáo]</td>
    </tr>
  </table>

  <table class="score-table">
    <tr>
      <th>Chuyên cần</th>
      <th>Điểm kiểm tra</th>
      <th>Điểm BTVN</th>
      <th>% Tích lũy</th>
    </tr>
    <tr>
      <td id="attendance">[Chuyên cần]</td>
      <td id="test-score">[Điểm kiểm tra]</td>
      <td id="homework">[Điểm BTVN]</td>
      <td id="stars">[Số sao]</td>
    </tr>
  </table>

  <div class="section-title">CHI TIẾT HỌC TẬP</div>
  <table class="data-table">
    <thead>
      <tr>
        <th style="width: 50px;">STT</th>
        <th>Ngày</th>
        <th>Chuyên cần</th>
        <th>% Hoàn thành bài tập</th>
        <th>% Điểm kiểm tra</th>
      </tr>
    </thead>
    <tbody id="tableBody">
      <tr class="no-data-row">
        <td colspan="5" class="no-data">Không có dữ liệu học tập</td>
      </tr>
    </tbody>
  </table>

  <div class="section-title">ĐIỂM KIỂM TRA CÁC NGÀY</div>
  <table class="data-table">
    <thead>
      <tr>
        <th style="width: 50px;">STT</th>
        <th>Ngày kiểm tra</th>
        <th>Tên Bài Kiểm Tra</th>
        <th>Điểm</th>
      </tr>
    </thead>
    <tbody id="testScoreBody">
      <tr class="no-data-row">
        <td colspan="4" class="no-data">Không có dữ liệu điểm kiểm tra</td>
      </tr>
    </tbody>
  </table>

  <div class="section-title">BIỂU ĐỒ TIẾN BỘ HỌC TẬP</div>
  <canvas id="progressChart" width="800" height="400"></canvas>

  <div class="report-section">
    <h2>BÁO CÁO TỔNG KẾT</h2>
    <div id="comment">
      <p><span class="item-title">1. Tiến bộ học tập</span>: Học sinh đã có sự cải thiện đáng kể trong các bài kiểm tra gần đây.</p>
      <p><span class="item-title">2. Tham gia lớp học</span>: Thường xuyên tham gia và tích cực trong các buổi học.</p>
      <p><span class="item-title">3. Đề xuất cải thiện</span>: Cần tập trung hơn vào việc hoàn thành bài tập về nhà đúng hạn.</p>
    </div>
  </div>

  <div class="comment-stamp" id="commentStamp">
    <img src="https://www.appsheet.com/template/gettablefileurl?appName=B%C3%A1ogi%C3%A1s%E1%BA%A3nph%E1%BA%A9m-325045268&tableName=c%C3%A0i%20%C4%91%E1%BA%B7t%20APP&fileName=C%C3%A0i%20%C4%91%E1%BA%B7t%20APP_Images%2Fae184aa6.%E1%BA%A2nh.054008.png" alt="Con dấu">
  </div>

  <div class="stamp-signature">
    <div class="stamp">CON DẤU</div>
    <div class="signature">NGƯỜI LẬP BÁO CÁO</div>
  </div>
</div>

<script>
  // Hàm decode URL an toàn
  function safeDecode(encoded) {
    if (!encoded) return '';
    try {
      return decodeURIComponent(encoded.replace(/\+/g, ' '));
    } catch (e) {
      return encoded;
    }
  }

  // Hàm xử lý dữ liệu học tập và sắp xếp theo ngày
  function processLearningData(dataStr) {
    if (!dataStr || dataStr.trim() === '') return [];
    
    try {
      const data = dataStr.split('_b_').map(item => {
        const parts = item.split('_a_');
        return {
          ngay: safeDecode(parts[0]) || '',
          chuyenCan: safeDecode(parts[1]) || '',
          hoanThanhBT: parts[2] ? parseInt(parts[2]) : null,
          diemKiemTra: parts[3] ? parseInt(parts[3]) : null
        };
      }).filter(item => item.ngay.trim() !== '');

      // Sắp xếp dữ liệu theo ngày (từ thấp đến cao)
      return data.sort((a, b) => new Date(a.ngay) - new Date(b.ngay));
    } catch (e) {
      console.error('Lỗi xử lý dữ liệu học tập:', e);
      return [];
    }
  }

  // Hàm xử lý dữ liệu điểm kiểm tra và sắp xếp theo ngày
  function processTestData(testStr) {
    if (!testStr || testStr.trim() === '') return [];
    
    try {
      const data = testStr.split('_b_').map(item => {
        const parts = item.split('_a_');
        return {
          ngay: safeDecode(parts[0]) || '',
          tenBaiKiemTra: safeDecode(parts[1]) || '',
          diem: parts[2] ? parseFloat(parts[2]) : null
        };
      }).filter(item => item.ngay.trim() !== '');

      // Sắp xếp dữ liệu theo ngày (từ thấp đến cao)
      return data.sort((a, b) => new Date(a.ngay) - new Date(b.ngay));
    } catch (e) {
      console.error('Lỗi xử lý dữ liệu điểm kiểm tra:', e);
      return [];
    }
  }

  // Hàm hiển thị dữ liệu học tập đã sắp xếp
  function displayLearningData(data) {
    const tableBody = document.getElementById('tableBody');
    const noDataRow = tableBody.querySelector('.no-data-row');
    
    if (data.length > 0) {
      noDataRow.style.display = 'none';
      
      tableBody.innerHTML = data.map((item, index) => {
        const getScoreClass = (score) => {
          if (score === null) return '';
          if (score >= 90) return 'score-excellent';
          if (score >= 70) return 'score-good';
          if (score >= 50) return 'score-average';
          return 'score-poor';
        };
        
        return `  
          <tr>
            <td class="center-text">${index + 1}</td>
            <td>${item.ngay || 'N/A'}</td>
            <td>${item.chuyenCan || 'Không có'}</td>
            <td class="center-text ${getScoreClass(item.hoanThanhBT)}">
              ${item.hoanThanhBT !== null ? item.hoanThanhBT + '%' : 'N/A'}
            </td>
            <td class="center-text ${getScoreClass(item.diemKiemTra)}">
              ${item.diemKiemTra !== null ? item.diemKiemTra + '%' : 'N/A'}
            </td>
          </tr>
        `;
      }).join('');
    }
  }

  // Hàm hiển thị điểm kiểm tra đã sắp xếp
  function displayTestData(data) {
    const testScoreBody = document.getElementById('testScoreBody');
    const noTestDataRow = testScoreBody.querySelector('.no-data-row');
    
    if (data.length > 0) {
      noTestDataRow.style.display = 'none';
      
      testScoreBody.innerHTML = data.map((item, index) => {
        const getScoreClass = (score) => {
          if (score === null) return '';
          if (score >= 90) return 'score-excellent';
          if (score >= 70) return 'score-good';
          if (score >= 50) return 'score-average';
          return 'score-poor';
        };
        
        return `  
          <tr>
            <td class="center-text">${index + 1}</td>
            <td>${item.ngay || 'N/A'}</td>
            <td>${item.tenBaiKiemTra || 'Không có tên'}</td>
            <td class="center-text ${getScoreClass(item.diem)}">
              ${item.diem !== null ? item.diem : 'N/A'}
            </td>
          </tr>
        `;
      }).join('');
    }
  }

  // Hàm vẽ biểu đồ tiến bộ học tập đã sắp xếp
  function drawChart(data) {
    if (data.length === 0) {
      document.getElementById('progressChart').style.display = 'none';
      return;
    }
    
    const validData = data.filter(item => item.diem !== null);
    if (validData.length === 0) {
      document.getElementById('progressChart').style.display = 'none';
      return;
    }
    
    const labels = validData.map(item => [item.ngay, item.tenBaiKiemTra]);
    const scores = validData.map(item => item.diem);
    
    try {
      const ctx = document.getElementById('progressChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Điểm bài kiểm tra',
            data: scores,
            backgroundColor: 'rgba(214, 40, 40, 0.1)',
            borderColor: 'rgba(214, 40, 40, 1)',
            borderWidth: 2,
            pointBackgroundColor: 'rgba(214, 40, 40, 1)',
            pointRadius: 5,
            pointHoverRadius: 7,
            tension: 0.3,
            fill: true
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'top',
              labels: {
                font: {
                  size: 14
                }
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0,0,0,0.7)',
              titleFont: {
                size: 16
              },
              bodyFont: {
                size: 14
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              title: {
                display: true,
                text: 'Điểm số',
                font: {
                  size: 14,
                  weight: 'bold'
                }
              },
              grid: {
                color: 'rgba(0,0,0,0.05)'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Ngày kiểm tra',
                font: {
                  size: 14,
                  weight: 'bold'
                }
              },
              grid: {
                display: false
              }
            }
          }
        }
      });
    } catch (e) {
      console.error('Lỗi khi vẽ biểu đồ:', e);
      document.getElementById('progressChart').style.display = 'none';
    }
  }

  // Hàm chính khi trang được tải
  function init() {
    const params = new URLSearchParams(window.location.search);
    
    // Hiển thị thông tin cơ bản
    document.getElementById('student-name').textContent = safeDecode(params.get('ten')) || '[Tên học sinh]';
    document.getElementById('student-class').textContent = safeDecode(params.get('lop')) || '[Tên lớp]';
    document.getElementById('student-id').textContent = params.get('id') || '[Mã học sinh]';
    
    // Xử lý ngày báo cáo
    const today = new Date();
    document.getElementById('report-date').textContent = params.get('ngay') || 
      today.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });
    
    // Xử lý các điểm số
    document.getElementById('attendance').textContent = params.get('chuyencan') || '[Chuyên cần]';
    document.getElementById('test-score').textContent = params.get('diem') || '[Điểm kiểm tra]';
    document.getElementById('homework').textContent = params.get('btvn') || '[Điểm BTVN]';
    document.getElementById('stars').textContent = params.get('sao') ? params.get('sao') + ' %' : '[Số sao]';
    
    // Xử lý nhận xét
    const nhanxet = params.get('nhanxet');
    if (nhanxet) {
      document.getElementById('comment').innerHTML = safeDecode(nhanxet)
        .replace(/###/g, '<h3>')
        .replace(/<\/br>/g, '<br>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    }
    
    // Xử lý con dấu
    const condau = params.get('condau');
    const commentStamp = document.getElementById('commentStamp');
    if (condau && condau !== '0' && condau !== 'false') {
      commentStamp.querySelector('img').src = safeDecode(condau);
    } else {
      commentStamp.style.display = 'none';
    }
    
    // Xử lý dữ liệu học tập
    const learningData = processLearningData(params.get('data'));
    displayLearningData(learningData);
    
    // Xử lý điểm kiểm tra
    const testData = processTestData(params.get('idktra'));
    displayTestData(testData);
    drawChart(testData);
  }

  // Khởi chạy khi trang được tải
  document.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>





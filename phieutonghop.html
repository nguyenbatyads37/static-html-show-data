<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B·∫£ng K√™ H·ªì S∆°</title>
    <style>
        /* === STYLE CHO M√ÄN H√åNH (HI·ªÇN TH·ªä WEB) === */
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            /* Thay ƒë·ªïi: B·ªè flex ƒë·ªÉ n√∫t in ·ªü tr√™n c√πng */
            padding: 20px;
        }

        /* Th√™m: N√∫t In */
        .print-button-container {
            text-align: center;
            margin-bottom: 20px;
            /* Th√™m: S·∫Øp x·∫øp c√°c n√∫t */
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .print-button {
            font-size: 16px;
            font-weight: bold;
            color: #fff;
            background-color: #007bff;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .print-button:hover {
            background-color: #0056b3;
        }
        
        /* X√≥a N√∫t G·ª≠i D·ªØ Li·ªáu */

        table {
            width: 100%;
            max-width: 1200px;
            border-collapse: collapse;
            border: 1px solid #aaa; /* Vi·ªÅn ngo√†i ƒë·∫≠m h∆°n */
            background-color: #fff;
            font-size: 14px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            border-radius: 4px;
            overflow: hidden;
            /* Th√™m: CƒÉn gi·ªØa b·∫£ng */
            margin: 0 auto; 
        }

        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
            vertical-align: top;
        }

        caption {
            caption-side: top;
            font-weight: bold;
            padding: 15px;
            text-align: center;
        }
        caption h2, caption h3 {
            margin: 0;
            color: #333;
        }
        caption h2 {
            font-size: 1.5em;
        }
        caption h3 {
            font-size: 1.1em;
            font-weight: normal;
            color: #555;
        }
        
        thead tr.main-header th {
            background-color: #f5f5f5;
            text-align: center;
            font-weight: bold;
            color: #333;
            border-bottom: 2px solid #ccc;
        }
        
        thead tr.info-header th {
            background-color: #fafafa;
            font-weight: bold;
            border: 1px solid #ddd; 
        }

        /* Thay ƒë·ªïi: D√πng class cho h√†ng ch·∫µn thay v√¨ :nth-child */
        tbody tr.even-row {
            background-color: #f9f9f9;
        }

        tbody tr:hover {
            background-color: #f0f0f0;
        }

        /* Thay ƒë·ªïi: D√πng class cho cƒÉn ch·ªânh */
        .cell-center {
            text-align: center;
            color: #555;
        }
        .cell-right-mono {
            text-align: right;
            font-family: 'Courier New', Courier, monospace;
        }
        .cell-no-data {
            text-align: center;
            padding: 20px;
            color: #777;
        }


        /* === STYLE CHO IN ·∫§N (PRINT VIEW) === */
        @media print {
            /* Th√™m: ·∫®n n√∫t in khi in */
            .print-button-container {
                display: none;
            }

            /* ƒê·ªãnh d·∫°ng trang A4, l·ªÅ 1cm */
            @page {
                size: A4;
                margin: 1cm;
            }

            body {
                /* Reset body v·ªÅ n·ªÅn tr·∫Øng, kh√¥ng l·ªÅ, kh√¥ng ƒë·ªám */
                background-color: #fff;
                padding: 0;
                margin: 0;
                font-family: Arial, sans-serif; /* ƒê·∫£m b·∫£o font nh·∫•t qu√°n */
            }

            table {
                /* B·∫£ng chi·∫øm 100% chi·ªÅu r·ªông c·ªßa trang in */
                width: 100%;
                max-width: 100%;
                /* Reset c√°c hi·ªáu ·ª©ng cho m√†n h√¨nh */
                box-shadow: none;
                border-radius: 0;
                /* Vi·ªÅn ngo√†i m√†u ƒëen */
                border: 1px solid #000; 
                /* C·ª° ch·ªØ nh·ªè h∆°n m·ªôt ch√∫t cho v·ª´a trang */
                font-size: 10pt; 
                border-collapse: collapse; 
            }
            
            caption {
                text-align: center;
                font-weight: bold;
                padding: 10px 0;
                font-size: 12pt;
                color: #000;
            }
            caption h2 {
                font-size: 1.2em;
            }
            caption h3 {
                font-size: 1.0em;
                font-weight: normal;
            }

            th, td {
                /* Vi·ªÅn ƒëen cho t·∫•t c·∫£ c√°c √¥ */
                border: 1px solid #000 !important; 
                /* Gi·∫£m padding cho v·ª´a trang */
                padding: 5px;
                /* ƒê·∫£m b·∫£o n·ªÅn tr·∫Øng v√† ch·ªØ ƒëen */
                background-color: #fff !important;
                color: #000 !important;
                vertical-align: top;
            }

            /* ƒê·∫£m b·∫£o header c·ªßa b·∫£ng in r√µ r√†ng */
            thead tr.main-header th {
                border-bottom: 2px solid #000 !important; /* Vi·ªÅn d∆∞·ªõi ƒëen ƒë·∫≠m */
                font-weight: bold;
            }
            
            /* B·ªè c√°c hi·ªáu ·ª©ng hover v√† n·ªÅn xen k·∫Ω */
            tbody tr:hover,
            tbody tr.even-row {
                background-color: #fff !important;
            }
            
            /* Gi·ªØ nguy√™n cƒÉn ch·ªânh */
            .cell-center {
                text-align: center;
            }
            .cell-right-mono {
                text-align: right;
                font-family: 'Courier New', Courier, monospace;
            }
            .cell-no-data {
                text-align: center;
            }
        }
    </style>
</head>
<body>

    <!-- Th√™m: N√∫t In (N√∫t g·ª≠i ƒë√£ b·ªã x√≥a) -->
    <div class="print-button-container">
        <button onclick="window.print()" class="print-button">üñ®Ô∏è In B·∫£ng K√™</button>
    </div>

    <!-- Th√™m: Khu v·ª±c th√¥ng b√°o l·ªói (gi·ªØ l·∫°i) -->
    <div id="error-message" style="color: red; text-align: center; margin-bottom: 10px; font-weight: bold; display: none;"></div>

    <table>
        <caption>
            <h2>B·∫¢NG K√ä S·ªê L∆Ø·ª¢NG H·ªí S∆† TH√ÅNG</h2>
            <!-- Th√™m ID ƒë·ªÉ JS c·∫≠p nh·∫≠t -->
            <h3 id="ngay-thang-phu">(T·ª´ ng√†y ... ƒë·∫øn ng√†y ...)</h3>
        </caption>
        
        <thead>
            <tr class="info-header">
                <th colspan="2">K√≠nh g·ª≠i Qu√Ω kh√°ch h√†ng:</th>
                <!-- Th√™m ID v√† Colspan ƒë·ªÉ JS c·∫≠p nh·∫≠t -->
                <th colspan="6" id="khach-hang-ten">(Ch∆∞a c√≥ d·ªØ li·ªáu)</th>
            </tr>
            <tr class="info-header">
                <th>T·ªïng HS:</th>
                <!-- Th√™m ID ƒë·ªÉ JS c·∫≠p nh·∫≠t -->
                <th id="tong-hs-value">0</th>
                <th colspan="6"></th>
            </tr>
            <tr class="info-header">
                <th>Trong ƒë√≥:</th>
                <th>H·ªØu Ngh·ªã:</th>
                <!-- Th√™m ID ƒë·ªÉ JS c·∫≠p nh·∫≠t -->
                <th id="huu-nghi-value">0</th>
                <th>C·ªëc Nam:</th>
                <!-- Th√™m ID ƒë·ªÉ JS c·∫≠p nh·∫≠t -->
                <th id="coc-nam-value">0</th>
                <th colspan="3"></th>
            </tr>
            <tr class="info-header">
                <th></th>
                <th>T√¢n Thanh:</th>
                <!-- Th√™m ID ƒë·ªÉ JS c·∫≠p nh·∫≠t -->
                <th id="tan-thanh-value">0</th>
                <th>Chi Ma:</th>
                <!-- Th√™m ID ƒë·ªÉ JS c·∫≠p nh·∫≠t -->
                <th id="chi-ma-value">0</th>
                <th colspan="3"></th>
            </tr>
            <tr class="main-header">
                <th>TT</th>
                <th>Ng√†y</th>
                <th>MHS</th>
                <th>BS xe</th>
                <th>BS mo√≥c</th>
                <th>Time</th>
                <th>C·ª≠a kh·∫©u</th>
                <th>Ghi ch√∫</th>
            </tr>
        </thead>
        
        <!-- Th√¢n b·∫£ng tr·ªëng, s·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn b·ªüi JS -->
        <tbody id="table-body">
            <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c ch√®n v√†o ƒë√¢y -->
        </tbody>
    </table>

    <!-- Th√™m: JavaScript ƒë·ªÉ ƒëi·ªÅn d·ªØ li·ªáu t·ª´ URL -->
    <script>
        // Ch·∫°y k·ªãch b·∫£n khi trang ƒë∆∞·ª£c t·∫£i xong
        window.onload = function() {
            try {
                // 1. L·∫•y c√°c tham s·ªë t·ª´ URL
                const params = new URLSearchParams(window.location.search);
                
                const kh = params.get('kh') || '(Ch∆∞a c√≥ d·ªØ li·ªáu)';
                const tungay = params.get('tungay') || '...';
                const toingay = params.get('toingay') || '...';
                const tableData = params.get('table');

                // 2. C·∫≠p nh·∫≠t th√¥ng tin header
                document.getElementById('khach-hang-ten').innerText = kh;
                document.getElementById('ngay-thang-phu').innerText = `(T·ª´ ng√†y ${tungay} ƒë·∫øn ng√†y ${toingay})`;

                // 3. X·ª≠ l√Ω v√† ƒëi·ªÅn d·ªØ li·ªáu b·∫£ng
                const tbody = document.getElementById('table-body');
                tbody.innerHTML = ''; // X√≥a b·∫•t k·ª≥ n·ªôi dung tƒ©nh n√†o

                if (!tableData) {
                    const tr = document.createElement('tr');
                    const td = document.createElement('td');
                    td.colSpan = 8; // B·∫£ng c√≥ 8 c·ªôt
                    td.innerText = 'Kh√¥ng c√≥ d·ªØ li·ªáu b√†n k√™ ƒë·ªÉ hi·ªÉn th·ªã.';
                    td.className = 'cell-no-data';
                    tr.appendChild(td);
                    tbody.appendChild(tr);
                    
                    // C·∫≠p nh·∫≠t t·ªïng HS l√† 0
                    document.getElementById('tong-hs-value').innerText = 0;
                    return; // D·ª´ng l·∫°i ·ªü ƒë√¢y
                }

                // Kh·ªüi t·∫°o bi·∫øn ƒë·∫øm
                let totalRows = 0;
                let countHuuNghi = 0;
                let countCocNam = 0;
                let countTanThanh = 0;
                let countChiMa = 0;
                
                const rows = tableData.split('_b_');

                rows.forEach((rowString) => {
                    if (!rowString) return; // B·ªè qua h√†ng tr·ªëng
                    
                    // L·ªçc ra c√°c h√†ng t√≥m t·∫Øt
                    // THAY ƒê·ªîI: ƒê√£ B·ªé ki·ªÉm tra (cols.length < 8)
                    if (rowString.startsWith('T·ªïng HS:') || rowString.includes('H·ªØu Ngh·ªã:')) {
                        return; // ƒê√¢y l√† h√†ng t√≥m t·∫Øt ho·∫∑c h√†ng kh√¥ng h·ª£p l·ªá, b·ªè qua
                    }
                    
                    const cols = rowString.split('_a_'); // L·∫•y c√°c c·ªôt d·ªØ li·ªáu

                    totalRows++; // ƒê·∫øm h√†ng d·ªØ li·ªáu h·ª£p l·ªá
                    
                    const tr = document.createElement('tr');
                    
                    // Th√™m l·ªõp cho h√†ng ch·∫µn (zebra striping)
                    if (totalRows % 2 === 0) {
                        tr.classList.add('even-row');
                    }
                    
                    // THAY ƒê·ªîI: ƒê·∫øm linh ho·∫°t
                    // Qu√©t to√†n b·ªô chu·ªói h√†ng ƒë·ªÉ t√¨m t√™n c·ª≠a kh·∫©u, b·∫•t k·ªÉ n√≥ ·ªü c·ªôt n√†o
                    const lowerCaseRow = rowString.toLowerCase();
                    if (lowerCaseRow.includes("h·ªØu ngh·ªã")) {
                        countHuuNghi++;
                    } else if (lowerCaseRow.includes("c·ªëc nam")) {
                        countCocNam++;
                    } else if (lowerCaseRow.includes("t√¢n thanh")) {
                        countTanThanh++;
                    } else if (lowerCaseRow.includes("chi ma")) {
                        countChiMa++;
                    }
                    
                    const totalColumnsInTable = 8; // B·∫£ng lu√¥n c√≥ 8 c·ªôt

                    // THAY ƒê·ªîI: Hi·ªÉn th·ªã linh ho·∫°t
                    // Lu√¥n l·∫∑p 8 l·∫ßn (ƒë·ªÉ t·∫°o 8 c·ªôt), ngay c·∫£ khi d·ªØ li·ªáu v√†o ch·ªâ c√≥ 7
                    for (let i = 0; i < totalColumnsInTable; i++) {
                        const td = document.createElement('td');
                        
                        // L·∫•y d·ªØ li·ªáu n·∫øu c√≥, ho·∫∑c tr·∫£ v·ªÅ r·ªóng n·∫øu kh√¥ng c√≥ (v√≠ d·ª•: cols[7] khi ch·ªâ c√≥ 7 c·ªôt)
                        const cellText = cols[i] || ''; 
                        
                        td.innerText = cellText;
                        
                        // √Åp d·ª•ng style cƒÉn ch·ªânh (v·∫´n d·ª±a tr√™n v·ªã tr√≠ c·ªôt mong mu·ªën)
                        if (i === 0) { // C·ªôt STT
                            td.classList.add('cell-center');
                        } else if (i === 2) { // C·ªôt MHS
                            td.classList.add('cell-right-mono');
                        }
                        // Kh√¥ng c·∫ßn ki·ªÉm tra c·ª≠a kh·∫©u ·ªü ƒë√¢y n·ªØa
                        
                        tr.appendChild(td);
                    }
                    
                    tbody.appendChild(tr);

                    // Logic ƒë·∫øm ƒë√£ ƒë∆∞·ª£c chuy·ªÉn l√™n tr√™n
                });
                
                // N·∫øu sau khi l·∫∑p, kh√¥ng c√≥ h√†ng n√†o, hi·ªÉn th·ªã "Kh√¥ng c√≥ d·ªØ li·ªáu"
                if (totalRows === 0) {
                     const tr = document.createElement('tr');
                    const td = document.createElement('td');
                    td.colSpan = 8;
                    td.innerText = 'D·ªØ li·ªáu ƒë∆∞·ª£c truy·ªÅn v√†o kh√¥ng ch·ª©a h√†ng h·ª£p l·ªá.';
                    td.className = 'cell-no-data';
                    tr.appendChild(td);
                    tbody.appendChild(tr);
                }

                // 4. C·∫≠p nh·∫≠t c√°c s·ªë li·ªáu th·ªëng k√™
                document.getElementById('tong-hs-value').innerText = totalRows;
                document.getElementById('huu-nghi-value').innerText = countHuuNghi;
                document.getElementById('coc-nam-value').innerText = countCocNam;
                document.getElementById('tan-thanh-value').innerText = countTanThanh;
                document.getElementById('chi-ma-value').innerText = countChiMa;

            } catch (error) {
                console.error("L·ªói khi ƒëi·ªÅn d·ªØ li·ªáu t·ª´ URL:", error);
                const tbody = document.getElementById('table-body');
                tbody.innerHTML = `<tr><td colspan="8" style="text-align: center; color: red; padding: 20px;">ƒê√£ x·∫£y ra l·ªói khi t·∫£i d·ªØ li·ªáu: ${error.message}</td></tr>`;
                document.getElementById("error-message").innerText = `L·ªói khi t·∫£i d·ªØ li·ªáu: ${error.message}`;
                document.getElementById("error-message").style.display = 'block';
            }
        };
    </script>

</body>
</html>

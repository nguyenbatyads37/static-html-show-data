<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B·∫£ng K√™ H·ªì S∆°</title>
    <!-- TH√äM: Th∆∞ vi·ªán SheetJS ƒë·ªÉ x·ª≠ l√Ω Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

    <style>
        /* === STYLE CHO M√ÄN H√åNH (HI·ªÇN TH·ªä WEB) === */
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            padding: 20px;
        }

        .print-button-container {
            text-align: center;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            gap: 15px; /* TƒÉng kho·∫£ng c√°ch gi·ªØa c√°c n√∫t */
        }

        .print-button {
            font-size: 16px;
            font-weight: bold;
            color: #fff;
            background-color: #007bff;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .print-button:hover {
            background-color: #0056b3;
        }

        /* TH√äM: Style ri√™ng cho n√∫t Excel */
        .excel-button {
            background-color: #28a745; /* M√†u xanh l√° */
        }

        .excel-button:hover {
            background-color: #218838;
        }

        table {
            width: 100%;
            max-width: 1200px;
            border-collapse: collapse;
            border: 1px solid #aaa;
            background-color: #fff;
            font-size: 14px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            border-radius: 4px;
            overflow: hidden;
            margin: 0 auto; 
        }

        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
            vertical-align: top;
        }

        caption {
            caption-side: top;
            font-weight: bold;
            padding: 15px;
            text-align: center;
        }
        caption h2, caption h3 {
            margin: 0;
            color: #333;
        }
        caption h2 {
            font-size: 1.5em;
        }
        caption h3 {
            font-size: 1.1em;
            font-weight: normal;
            color: #555;
        }
        
        thead tr.main-header th {
            background-color: #f5f5f5;
            text-align: center;
            font-weight: bold;
            color: #333;
            border-bottom: 2px solid #ccc;
        }
        
        thead tr.info-header th {
            background-color: #fafafa;
            font-weight: bold;
            border: 1px solid #ddd; 
        }

        tbody tr.even-row {
            background-color: #f9f9f9;
        }

        tbody tr:hover {
            background-color: #f0f0f0;
        }

        .cell-center {
            text-align: center;
            color: #555;
        }
        .cell-right-mono {
            text-align: right;
            font-family: 'Courier New', Courier, monospace;
        }
        .cell-no-data {
            text-align: center;
            padding: 20px;
            color: #777;
        }


        /* === STYLE CHO IN ·∫§N (PRINT VIEW) === */
        @media print {
            .print-button-container {
                display: none;
            }

            @page {
                size: A4;
                margin: 1cm;
            }

            body {
                background-color: #fff;
                padding: 0;
                margin: 0;
            }

            table {
                width: 100%;
                max-width: 100%;
                box-shadow: none;
                border-radius: 0;
                border: 1px solid #000; 
                font-size: 10pt; 
                border-collapse: collapse; 
            }
            
            caption {
                color: #000;
            }

            th, td {
                border: 1px solid #000 !important; 
                padding: 5px;
                background-color: #fff !important;
                color: #000 !important;
            }

            thead tr.main-header th {
                border-bottom: 2px solid #000 !important;
            }
            
            tbody tr:hover,
            tbody tr.even-row {
                background-color: #fff !important;
            }
        }
    </style>
</head>
<body>

    <!-- N√∫t Ch·ª©c NƒÉng -->
    <div class="print-button-container">
        <button onclick="window.print()" class="print-button">üñ®Ô∏è In B·∫£ng K√™</button>
        
        <!-- TH√äM: N√∫t T·∫£i Excel -->
        <button onclick="exportToExcel()" class="print-button excel-button">üìä T·∫£i Excel</button>
    </div>

    <div id="error-message" style="color: red; text-align: center; margin-bottom: 10px; font-weight: bold; display: none;"></div>

    <!-- Th√™m ID cho b·∫£ng ƒë·ªÉ d·ªÖ truy xu·∫•t -->
    <table id="bang-ke-ho-so">
        <caption>
            <h2>B·∫¢NG K√ä S·ªê L∆Ø·ª¢NG H·ªí S∆† TH√ÅNG</h2>
            <h3 id="ngay-thang-phu">(T·ª´ ng√†y ... ƒë·∫øn ng√†y ...)</h3>
        </caption>
        
        <thead>
            <tr class="info-header">
                <th colspan="2">K√≠nh g·ª≠i Qu√Ω kh√°ch h√†ng:</th>
                <th colspan="6" id="khach-hang-ten">(Ch∆∞a c√≥ d·ªØ li·ªáu)</th>
            </tr>
            <tr class="info-header">
                <th>T·ªïng HS:</th>
                <th id="tong-hs-value">0</th>
                <th colspan="6"></th>
            </tr>
            <tr class="info-header">
                <th>Trong ƒë√≥:</th>
                <th>H·ªØu Ngh·ªã:</th>
                <th id="huu-nghi-value">0</th>
                <th>C·ªëc Nam:</th>
                <th id="coc-nam-value">0</th>
                <th colspan="3"></th>
            </tr>
            <tr class="info-header">
                <th></th>
                <th>T√¢n Thanh:</th>
                <th id="tan-thanh-value">0</th>
                <th>Chi Ma:</th>
                <th id="chi-ma-value">0</th>
                <th colspan="3"></th>
            </tr>
            <tr class="main-header">
                <th>TT</th>
                <th>Ng√†y</th>
                <th>MHS</th>
                <th>BS xe</th>
                <th>BS mo√≥c</th>
                <th>Time</th>
                <th>C·ª≠a kh·∫©u</th>
                <th>Ghi ch√∫</th>
            </tr>
        </thead>
        
        <tbody id="table-body">
            <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c ch√®n v√†o ƒë√¢y -->
        </tbody>
    </table>

    <script>
        // Ch·∫°y k·ªãch b·∫£n khi trang ƒë∆∞·ª£c t·∫£i xong
        window.onload = function() {
            try {
                const params = new URLSearchParams(window.location.search);
                
                const kh = params.get('kh') || '(Ch∆∞a c√≥ d·ªØ li·ªáu)';
                const tungay = params.get('tungay') || '...';
                const toingay = params.get('toingay') || '...';
                const tableData = params.get('table');

                document.getElementById('khach-hang-ten').innerText = kh;
                document.getElementById('ngay-thang-phu').innerText = `(T·ª´ ng√†y ${tungay} ƒë·∫øn ng√†y ${toingay})`;

                const tbody = document.getElementById('table-body');
                tbody.innerHTML = ''; 

                if (!tableData) {
                    const tr = document.createElement('tr');
                    const td = document.createElement('td');
                    td.colSpan = 8;
                    td.innerText = 'Kh√¥ng c√≥ d·ªØ li·ªáu b√†n k√™ ƒë·ªÉ hi·ªÉn th·ªã.';
                    td.className = 'cell-no-data';
                    tr.appendChild(td);
                    tbody.appendChild(tr);
                    document.getElementById('tong-hs-value').innerText = 0;
                    return; 
                }

                let totalRows = 0;
                let countHuuNghi = 0;
                let countCocNam = 0;
                let countTanThanh = 0;
                let countChiMa = 0;
                
                const rows = tableData.split('_b_');

                rows.forEach((rowString) => {
                    if (!rowString) return; 
                    if (rowString.startsWith('T·ªïng HS:') || rowString.includes('H·ªØu Ngh·ªã:')) {
                        return; 
                    }
                    
                    const cols = rowString.split('_a_'); 
                    totalRows++; 
                    
                    const tr = document.createElement('tr');
                    if (totalRows % 2 === 0) {
                        tr.classList.add('even-row');
                    }
                    
                    const lowerCaseRow = rowString.toLowerCase();
                    if (lowerCaseRow.includes("h·ªØu ngh·ªã")) {
                        countHuuNghi++;
                    } else if (lowerCaseRow.includes("c·ªëc nam")) {
                        countCocNam++;
                    } else if (lowerCaseRow.includes("t√¢n thanh")) {
                        countTanThanh++;
                    } else if (lowerCaseRow.includes("chi ma")) {
                        countChiMa++;
                    }
                    
                    const totalColumnsInTable = 8; 

                    for (let i = 0; i < totalColumnsInTable; i++) {
                        const td = document.createElement('td');
                        let cellText = '';

                        if (i === 0) {
                            cellText = totalRows;
                            td.classList.add('cell-center');
                        } else {
                            cellText = cols[i - 1] || ''; 
                            if (i === 2) { 
                                td.classList.add('cell-right-mono');
                            }
                        }
                        
                        td.innerText = cellText;
                        tr.appendChild(td);
                    }
                    tbody.appendChild(tr);
                });
                
                if (totalRows === 0) {
                     const tr = document.createElement('tr');
                    const td = document.createElement('td');
                    td.colSpan = 8;
                    td.innerText = 'D·ªØ li·ªáu ƒë∆∞·ª£c truy·ªÅn v√†o kh√¥ng ch·ª©a h√†ng h·ª£p l·ªá.';
                    td.className = 'cell-no-data';
                    tr.appendChild(td);
                    tbody.appendChild(tr);
                }

                document.getElementById('tong-hs-value').innerText = totalRows;
                document.getElementById('huu-nghi-value').innerText = countHuuNghi;
                document.getElementById('coc-nam-value').innerText = countCocNam;
                document.getElementById('tan-thanh-value').innerText = countTanThanh;
                document.getElementById('chi-ma-value').innerText = countChiMa;

            } catch (error) {
                console.error("L·ªói:", error);
                document.getElementById("error-message").innerText = `L·ªói: ${error.message}`;
                document.getElementById("error-message").style.display = 'block';
            }
        };

        // === TH√äM: H√ÄM XU·∫§T EXCEL ===
        function exportToExcel() {
            try {
                // 1. L·∫•y ph·∫ßn t·ª≠ b·∫£ng
                var elt = document.getElementById('bang-ke-ho-so');
                
                // 2. Chuy·ªÉn b·∫£ng HTML th√†nh Sheet Excel
                // raw: true gi√∫p gi·ªØ nguy√™n ƒë·ªãnh d·∫°ng s·ªë/chu·ªói, tr√°nh t·ª± ƒë·ªông parse ng√†y th√°ng sai
                var wb = XLSX.utils.table_to_book(elt, {sheet: "B·∫£ng K√™", raw: true});

                // 3. T·∫°o t√™n file d·ª±a tr√™n t√™n kh√°ch h√†ng v√† th·ªùi gian
                var khName = document.getElementById('khach-hang-ten').innerText.trim();
                // Lo·∫°i b·ªè c√°c k√Ω t·ª± ƒë·∫∑c bi·ªát ƒë·ªÉ l√†m t√™n file an to√†n
                var safeName = khName.replace(/[^a-zA-Z0-9\u00C0-\u1EF9 ]/g, "").replace(/\s+/g, "_");
                if (!safeName || safeName === "Ch∆∞a c√≥ d·ªØ li·ªáu") safeName = "KhachHang";
                
                var fileName = "BangKe_" + safeName + ".xlsx";

                // 4. T·∫£i file xu·ªëng
                XLSX.writeFile(wb, fileName);
            } catch (e) {
                alert("C√≥ l·ªói khi xu·∫•t Excel: " + e.message);
            }
        }
    </script>

</body>
</html>

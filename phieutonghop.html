<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B·∫£ng K√™ H·ªì S∆°</title>
    
    <!-- 1. Th∆∞ vi·ªán SheetJS ƒë·ªÉ x·ª≠ l√Ω Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <!-- 2. Th∆∞ vi·ªán html2pdf ƒë·ªÉ x·ª≠ l√Ω PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* === STYLE CHO M√ÄN H√åNH === */
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            padding: 20px;
        }

        .print-button-container {
            text-align: center;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .print-button {
            font-size: 15px;
            font-weight: bold;
            color: #fff;
            background-color: #007bff; /* M√†u xanh d∆∞∆°ng (In) */
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .print-button:active {
            transform: scale(0.98);
        }

        .print-button:hover {
            background-color: #0056b3;
        }

        /* Style n√∫t Excel (Xanh l√°) */
        .excel-button {
            background-color: #28a745; 
        }
        .excel-button:hover {
            background-color: #218838;
        }

        /* Style n√∫t PDF (ƒê·ªè) */
        .pdf-button {
            background-color: #dc3545;
        }
        .pdf-button:hover {
            background-color: #c82333;
        }

        /* Container bao quanh b·∫£ng ƒë·ªÉ PDF ch·ª•p ch√≠nh x√°c */
        .table-container {
            background-color: #fff;
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px;
            border-radius: 4px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #aaa;
            background-color: #fff;
            font-size: 14px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            border-radius: 4px;
            overflow: hidden;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
            vertical-align: top;
        }

        caption {
            caption-side: top;
            font-weight: bold;
            padding: 15px;
            text-align: center;
        }
        caption h2 {
            margin: 0;
            font-size: 1.5em;
            color: #333;
        }
        caption h3 {
            margin: 5px 0 0 0;
            font-size: 1.1em;
            font-weight: normal;
            color: #555;
        }
        
        thead tr.main-header th {
            background-color: #f5f5f5;
            text-align: center;
            font-weight: bold;
            color: #333;
            border-bottom: 2px solid #ccc;
        }
        
        thead tr.info-header th {
            background-color: #fafafa;
            font-weight: bold;
            border: 1px solid #ddd; 
        }

        tbody tr.even-row {
            background-color: #f9f9f9;
        }
        tbody tr:hover {
            background-color: #f0f0f0;
        }

        .cell-center { text-align: center; color: #555; }
        .cell-right-mono { text-align: right; font-family: 'Courier New', Courier, monospace; }
        .cell-no-data { text-align: center; padding: 20px; color: #777; }

        /* === STYLE CHO IN ·∫§N (PRINT VIEW) === */
        @media print {
            .print-button-container { display: none; }
            @page { size: A4; margin: 1cm; }
            body { background-color: #fff; padding: 0; margin: 0; }
            .table-container { box-shadow: none; padding: 0; width: 100%; }
            table { width: 100%; border: 1px solid #000; font-size: 10pt; }
            th, td { border: 1px solid #000 !important; padding: 5px; color: #000 !important; }
            thead tr.main-header th { border-bottom: 2px solid #000 !important; }
        }
    </style>
</head>
<body>

    <!-- Khu v·ª±c c√°c n√∫t ch·ª©c nƒÉng -->
    <div class="print-button-container">
        <button onclick="window.print()" class="print-button">üñ®Ô∏è In</button>
        <button onclick="exportToExcel()" class="print-button excel-button">üìä T·∫£i Excel</button>
        <button onclick="exportToPDF()" class="print-button pdf-button">üìÑ T·∫£i PDF</button>
    </div>

    <div id="error-message" style="color: red; text-align: center; margin-bottom: 10px; font-weight: bold; display: none;"></div>

    <!-- Bao b·∫£ng trong div container ƒë·ªÉ html2pdf x·ª≠ l√Ω t·ªët h∆°n -->
    <div class="table-container" id="content-to-export">
        <table id="bang-ke-ho-so">
            <caption>
                <h2>B·∫¢NG K√ä S·ªê L∆Ø·ª¢NG H·ªí S∆† TH√ÅNG</h2>
                <h3 id="ngay-thang-phu">(T·ª´ ng√†y ... ƒë·∫øn ng√†y ...)</h3>
            </caption>
            
            <thead>
                <!-- ƒê√£ ch·ªânh s·ª≠a colspan ƒë·ªÉ ph√π h·ª£p v·ªõi 7 c·ªôt -->
                <tr class="info-header">
                    <th colspan="2">K√≠nh g·ª≠i Qu√Ω kh√°ch h√†ng:</th>
                    <th colspan="5" id="khach-hang-ten">(Ch∆∞a c√≥ d·ªØ li·ªáu)</th>
                </tr>
                <tr class="info-header">
                    <th>T·ªïng HS:</th>
                    <th id="tong-hs-value">0</th>
                    <th colspan="5"></th>
                </tr>
                <tr class="info-header">
                    <th>Trong ƒë√≥:</th>
                    <th>H·ªØu Ngh·ªã:</th>
                    <th id="huu-nghi-value">0</th>
                    <th>C·ªëc Nam:</th>
                    <th id="coc-nam-value">0</th>
                    <th colspan="2"></th>
                </tr>
                <tr class="info-header">
                    <th></th>
                    <th>T√¢n Thanh:</th>
                    <th id="tan-thanh-value">0</th>
                    <th>Chi Ma:</th>
                    <th id="chi-ma-value">0</th>
                    <th colspan="2"></th>
                </tr>
                <tr class="main-header">
                    <th>TT</th>
                    <th>Ng√†y</th>
                    <th>MHS</th>
                    <th>BS xe</th>
                    <!-- ƒê√£ X√ìA c·ªôt BS mo√≥c -->
                    <th>Time</th>
                    <th>C·ª≠a kh·∫©u</th>
                    <th>Ghi ch√∫</th>
                </tr>
            </thead>
            
            <tbody id="table-body">
                <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c ch√®n v√†o ƒë√¢y -->
            </tbody>
        </table>
    </div>

    <script>
        // H√†m ti·ªán √≠ch l·∫•y t√™n file an to√†n
        function getSafeFileName() {
            var khName = document.getElementById('khach-hang-ten').innerText.trim();
            var safeName = khName.replace(/[^a-zA-Z0-9\u00C0-\u1EF9 ]/g, "").replace(/\s+/g, "_");
            if (!safeName || safeName === "Ch∆∞a c√≥ d·ªØ li·ªáu") safeName = "KhachHang";
            return "BangKe_" + safeName;
        }

        window.onload = function() {
            try {
                const params = new URLSearchParams(window.location.search);
                
                const kh = params.get('kh') || '(Ch∆∞a c√≥ d·ªØ li·ªáu)';
                const tungay = params.get('tungay') || '...';
                const toingay = params.get('toingay') || '...';
                const tableData = params.get('table');

                document.getElementById('khach-hang-ten').innerText = kh;
                document.getElementById('ngay-thang-phu').innerText = `(T·ª´ ng√†y ${tungay} ƒë·∫øn ng√†y ${toingay})`;

                const tbody = document.getElementById('table-body');
                tbody.innerHTML = ''; 

                // T·ªïng s·ªë c·ªôt m·ªõi l√† 7 (ƒê√£ b·ªè BS mo√≥c)
                const totalColumnsInTable = 7; 

                if (!tableData) {
                    const tr = document.createElement('tr');
                    const td = document.createElement('td');
                    td.colSpan = totalColumnsInTable;
                    td.innerText = 'Kh√¥ng c√≥ d·ªØ li·ªáu b√†n k√™ ƒë·ªÉ hi·ªÉn th·ªã.';
                    td.className = 'cell-no-data';
                    tr.appendChild(td);
                    tbody.appendChild(tr);
                    return; 
                }

                let totalRows = 0;
                let countHuuNghi = 0;
                let countCocNam = 0;
                let countTanThanh = 0;
                let countChiMa = 0;
                
                const rows = tableData.split('_b_');

                rows.forEach((rowString) => {
                    if (!rowString) return; 
                    if (rowString.startsWith('T·ªïng HS:') || rowString.includes('H·ªØu Ngh·ªã:')) {
                        return; 
                    }
                    
                    const cols = rowString.split('_a_'); 
                    totalRows++; 
                    
                    const tr = document.createElement('tr');
                    if (totalRows % 2 === 0) {
                        tr.classList.add('even-row');
                    }
                    
                    const lowerCaseRow = rowString.toLowerCase();
                    if (lowerCaseRow.includes("h·ªØu ngh·ªã")) {
                        countHuuNghi++;
                    } else if (lowerCaseRow.includes("c·ªëc nam")) {
                        countCocNam++;
                    } else if (lowerCaseRow.includes("t√¢n thanh")) {
                        countTanThanh++;
                    } else if (lowerCaseRow.includes("chi ma")) {
                        countChiMa++;
                    }
                    
                    for (let i = 0; i < totalColumnsInTable; i++) {
                        const td = document.createElement('td');
                        let cellText = '';

                        if (i === 0) {
                            // C·ªôt STT
                            cellText = totalRows;
                            td.classList.add('cell-center');
                        } else {
                            // T√≠nh to√°n ch·ªâ s·ªë d·ªØ li·ªáu l·∫•y t·ª´ m·∫£ng cols
                            // C·∫•u tr√∫c cols g·ªëc: [0:Ng√†y, 1:MHS, 2:BSXe, 3:BSMooc, 4:Time, 5:Gate, 6:Note]
                            
                            // i=1 (Ng√†y) -> l·∫•y cols[0]
                            // i=2 (MHS) -> l·∫•y cols[1]
                            // i=3 (BS Xe) -> l·∫•y cols[2]
                            // i=4 (Time) -> C·∫ßn l·∫•y cols[4], B·ªé QUA cols[3] (BS Mooc)
                            
                            let dataIndex = i - 1;
                            if (dataIndex >= 3) { 
                                dataIndex = dataIndex + 1; // Nh·∫£y qua c·ªôt BS Mooc (index 3)
                            }

                            cellText = cols[dataIndex] || ''; 
                            
                            if (i === 2) { // C·ªôt MHS
                                td.classList.add('cell-right-mono');
                            }
                        }
                        
                        td.innerText = cellText;
                        tr.appendChild(td);
                    }
                    tbody.appendChild(tr);
                });
                
                if (totalRows === 0) {
                    const tr = document.createElement('tr');
                    const td = document.createElement('td');
                    td.colSpan = totalColumnsInTable;
                    td.innerText = 'D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá.';
                    td.className = 'cell-no-data';
                    tr.appendChild(td);
                    tbody.appendChild(tr);
                }

                document.getElementById('tong-hs-value').innerText = totalRows;
                document.getElementById('huu-nghi-value').innerText = countHuuNghi;
                document.getElementById('coc-nam-value').innerText = countCocNam;
                document.getElementById('tan-thanh-value').innerText = countTanThanh;
                document.getElementById('chi-ma-value').innerText = countChiMa;

            } catch (error) {
                console.error("L·ªói:", error);
                document.getElementById("error-message").innerText = `L·ªói: ${error.message}`;
                document.getElementById("error-message").style.display = 'block';
            }
        };

        // === 1. H√ÄM XU·∫§T EXCEL ===
        function exportToExcel() {
            try {
                var elt = document.getElementById('bang-ke-ho-so');
                var wb = XLSX.utils.table_to_book(elt, {sheet: "B·∫£ng K√™", raw: true});
                XLSX.writeFile(wb, getSafeFileName() + ".xlsx");
            } catch (e) {
                alert("C√≥ l·ªói khi xu·∫•t Excel: " + e.message);
            }
        }

        // === 2. H√ÄM XU·∫§T PDF ===
        function exportToPDF() {
            var element = document.getElementById('content-to-export');
            var opt = {
                margin:       [10, 10, 10, 10], 
                filename:     getSafeFileName() + '.pdf',
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, useCORS: true },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
                pagebreak:    { mode: ['css', 'legacy'] }
            };

            var btn = document.querySelector('.pdf-button');
            var oldText = btn.innerText;
            btn.innerText = "‚è≥ ƒêang t·∫°o...";
            btn.disabled = true;

            html2pdf().set(opt).from(element).save().then(function(){
                btn.innerText = oldText;
                btn.disabled = false;
            }).catch(function(err){
                alert("L·ªói t·∫°o PDF: " + err);
                btn.innerText = oldText;
                btn.disabled = false;
            });
        }
    </script>

</body>
</html>

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Đơn Hàng</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 20px;
            font-size: 14px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
        }
        .editable {
            background-color: #ffffcc;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            border-radius: 5px;
            color: white;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            opacity: 0;
            transition: opacity 0.5s;
        }
        .success {
            background-color: #4CAF50;
        }
        .error {
            background-color: #f44336;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        button {
            padding: 6px 12px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <h1>Quản Lý Đơn Hàng</h1>
    <div id="notification" class="notification" style="display: none;"></div>
    
    <table id="ordersTable">
        <!-- Dữ liệu sẽ được thêm vào bằng JS -->
    </table>

    <script>
        // ĐÃ CẬP NHẬT URL MỚI CỦA BẠN
        const GAS_URL = "https://script.google.com/macros/s/AKfycbwMSGRIxZfRA9Y8mWtDn0VJmGI8jA9dCst8dl-m61nwC5dQgt8N_vfGSIAK10WakXoeEA/exec";
        let ordersData = [];

        // Hiển thị thông báo
        function showNotification(message, isSuccess) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${isSuccess ? 'success' : 'error'}`;
            notification.style.display = 'block';
            notification.style.opacity = '1';
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 500);
            }, 3000);
        }

        // Hiển thị loading
        function showLoading(button) {
            const loading = document.createElement('span');
            loading.className = 'loading';
            button.innerHTML = '';
            button.appendChild(loading);
            button.disabled = true;
            return button;
        }

        // Reset button về trạng thái ban đầu
        function resetButton(button, originalText) {
            button.innerHTML = originalText;
            button.disabled = false;
        }

        async function fetchOrders() {
            try {
                const response = await axios.get(GAS_URL);
                ordersData = response.data;
                renderOrders(ordersData);
            } catch (error) {
                console.error('Lỗi khi tải dữ liệu:', error);
                showNotification('Lỗi khi tải dữ liệu: ' + error.message, false);
            }
        }

        function renderOrders(orders) {
            const table = document.getElementById('ordersTable');
            table.innerHTML = '';
            
            if (!orders || orders.length === 0) {
                table.innerHTML = '<tr><td colspan="100">Không có dữ liệu đơn hàng</td></tr>';
                return;
            }

            // Tạo header
            const headers = Object.keys(orders[0]);
            const headerRow = document.createElement('tr');
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            // Thêm cột hành động
            const actionTh = document.createElement('th');
            actionTh.textContent = 'Hành động';
            headerRow.appendChild(actionTh);
            table.appendChild(headerRow);

            // Thêm dữ liệu
            orders.forEach((order, index) => {
                const row = document.createElement('tr');
                row.dataset.orderCode = order['Mã đơn hàng'];
                
                headers.forEach(header => {
                    const td = document.createElement('td');
                    
                    // Cho phép chỉnh sửa Tracking và Ngày giao hàng
                    if (header === 'Mã Tracking' || header === 'Ngày giao hàng') {
                        td.className = 'editable';
                        td.contentEditable = true;
                        td.dataset.column = header;
                    }
                    
                    td.textContent = order[header] || '';
                    row.appendChild(td);
                });
                
                // Thêm nút cập nhật
                const actionTd = document.createElement('td');
                const updateBtn = document.createElement('button');
                updateBtn.textContent = 'Cập nhật';
                updateBtn.dataset.originalText = 'Cập nhật';
                updateBtn.onclick = () => updateOrder(row, updateBtn);
                actionTd.appendChild(updateBtn);
                row.appendChild(actionTd);
                
                table.appendChild(row);
            });
        }

        async function updateOrder(row, button) {
            const orderCode = row.dataset.orderCode;
            const originalButtonText = button.dataset.originalText;
            showLoading(button);
            
            // Lấy dữ liệu đã chỉnh sửa
            const updatedData = {
                "Mã đơn hàng": orderCode,
                "Mã Tracking": row.querySelector('[data-column="Mã Tracking"]').textContent,
                "Ngày giao hàng": row.querySelector('[data-column="Ngày giao hàng"]').textContent
            };
            
            try {
                // Thêm timestamp để tránh cache
                const apiUrl = `${GAS_URL}?timestamp=${new Date().getTime()}`;
                
                const response = await axios.post(apiUrl, updatedData, {
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log("Response:", response.data);
                
                if (response.data.success) {
                    showNotification('Đã cập nhật thành công đơn hàng ' + orderCode, true);
                    // Highlight dòng vừa cập nhật
                    row.style.backgroundColor = '#e6ffe6';
                    setTimeout(() => {
                        row.style.backgroundColor = '';
                        fetchOrders(); // Làm mới dữ liệu
                    }, 2000);
                } else {
                    showNotification('Lỗi: ' + (response.data.error || 'Không rõ lỗi'), false);
                    console.error("Server error:", response.data);
                }
            } catch (error) {
                console.error('Lỗi khi cập nhật:', error);
                let errorMsg = error.message;
                
                if (error.response) {
                    errorMsg = error.response.data.error || JSON.stringify(error.response.data);
                }
                
                showNotification('Lỗi khi cập nhật: ' + errorMsg, false);
            } finally {
                resetButton(button, originalButtonText);
            }
        }

        // Tải dữ liệu khi trang được mở
        document.addEventListener('DOMContentLoaded', fetchOrders);
    </script>
</body>
</html>

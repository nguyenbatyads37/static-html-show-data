<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H√≥a ƒê∆°n V·∫≠n T·∫£i Eco (A5 Tr√†n Trang)</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script>
        // L·ªõp ƒë·ªÉ l·∫•y v√† x·ª≠ l√Ω d·ªØ li·ªáu t·ª´ Google Sheets
        class BillDataFiller {
            constructor() {
                this.sheetId = '1SbK_vKUJV7dTzDPmxmlEM-7MXBoh6guGRKU4dWvAiw4';
                this.sheetName = 'Bill';
            }

            // H√†m l·∫•y d·ªØ li·ªáu t·ª´ Google Sheets public qua CSV
            async fetchSheetData() {
                try {
                    const url = `https://docs.google.com/spreadsheets/d/${this.sheetId}/gviz/tq?tqx=out:csv&sheet=${this.sheetName}`;
                    const response = await fetch(url);
                    const csvText = await response.text();
                    return this.parseCSV(csvText);
                } catch (error) {
                    console.error('L·ªói khi l·∫•y d·ªØ li·ªáu t·ª´ Google Sheets:', error);
                    return null;
                }
            }

            // H√†m parse CSV th√†nh m·∫£ng c√°c ƒë·ªëi t∆∞·ª£ng
            parseCSV(csvText) {
                const lines = csvText.split('\n');
                const result = [];
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim()) {
                        const row = this.parseCSVLine(lines[i]);
                        result.push(row);
                    }
                }
                return result;
            }

            // H√†m parse m·ªôt d√≤ng CSV (x·ª≠ l√Ω d·∫•u ph·∫©y trong ngo·∫∑c k√©p)
            parseCSVLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current.trim().replace(/^"|"$/g, ''));
                        current = '';
                    } else {
                        current += char;
                    }
                }
                result.push(current.trim().replace(/^"|"$/g, ''));
                return result;
            }

            // H√†m t√¨m d·ªØ li·ªáu theo s·ªë Bill
            findBillByNumber(sheetData, billNumber) {
                if (!sheetData) return null;
                for (let row of sheetData) {
                    // C·ªôt "s≈ë Bill" l√† c·ªôt th·ª© 2 (index 1)
                    if (row[1] && row[1].toString().trim() === billNumber.toString().trim()) {
                        return this.parseRowToBillData(row);
                    }
                }
                return null; // Kh√¥ng t√¨m th·∫•y
            }

            // H√†m chuy·ªÉn ƒë·ªïi m·ªôt d√≤ng th√†nh object bill data
            parseRowToBillData(row) {
                 const billData = {
                    maDonHang: row[1] || '',       // "s≈ë Bill"
                    ngayGioGui: row[2] || '',      // "Ng√†y b·ªëc"
                    tenNguoiGui: row[4] || '',      // "T√™n kh√°ch g·ª≠i"
                    tinhTPGui: row[5] || '',        // "T·ªânh"
                    xaPhuongGui: row[6] || '',      // "x√£"
                    diaChiNguoiGui: row[7] || '',   // "ƒê·ªãa ch·ªâ"
                    sdtNguoiGui: row[8] || '',      // "ƒê·ªãa ch·ªâ ƒë√£ l∆∞u" (Gi·∫£ ƒë·ªãnh l√† SƒêT)
                    tenNguoiNhan: row[9] || '',     // "T√™n kh√°ch nh·∫≠n"
                    diaChiNguoiNhan: row[10] || '', // "ƒê·ªãa ch·ªâ nh·∫≠n"
                    tinhTPNhan: row[11] || '',      // "T·ªânh nh·∫≠n"
                    xaPhuongNhan: row[12] || '',    // "X√£ nh·∫≠n"
                    sdtNguoiNhan: row[13] || '',    // "SƒêT kh√°ch nh·∫≠n"
                    dichVuTrongBang: row[14] || '', // "D·ªãch v·ª• GTGT"
                    noiDungHangHoa: row[15] || '',  // "N·ªôi dung h√†ng h√≥a"
                    soKien: row[16] || '',          // "S·ªë ki·ªán"
                    tlThuc: row[17] || '',          // "Tr·ªçng l∆∞·ª£ng th∆∞"
                    thetich: row[18] || '',         // "Th·ªÉ t√≠ch"
                    cuocChinh: row[20] || '',       // "ƒê∆°n gi√°"
                    dichVuThem: row[21] || '',      // "Ph·ª• ph√≠"
                    tongCuoc: row[23] || '',        // "Th√†nh ti·ªÅn"
                    thuHo: row[25] || '',           // "COD"
                    ghiChu: row[27] || '',          // "Ghi ch√∫"
                    thanhToan: 'Ng∆∞·ªùi g·ª≠i'          // M·∫∑c ƒë·ªãnh
                };
                billData.tongPhaiThu = this.calculateTotal(billData.tongCuoc, billData.thuHo);
                return billData;
            }

            // H√†m t√≠nh t·ªïng ph·∫£i thu
            calculateTotal(tongCuoc, thuHo) {
                const cuoc = this.parseNumber(tongCuoc);
                const cod = this.parseNumber(thuHo);
                return (cuoc + cod).toString();
            }

            // H√†m chuy·ªÉn ƒë·ªïi chu·ªói th√†nh s·ªë
            parseNumber(str) {
                if (!str) return 0;
                return parseInt(str.toString().replace(/[^\d]/g, '')) || 0;
            }

             // H√†m ƒë·ªãnh d·∫°ng ti·ªÅn t·ªá
            formatCurrency(amount) {
                const cleanedAmount = String(amount).replace(/\D/g, '');
                if (!cleanedAmount) return '0';
                return parseInt(cleanedAmount, 10).toLocaleString('vi-VN');
            }
        }

        // Class ƒë·ªÉ qu·∫£n l√Ω vi·ªác hi·ªÉn th·ªã c√°c h√≥a ƒë∆°n
        class BillListManager {
            constructor(containerId) {
                this.container = document.getElementById(containerId);
                this.billFiller = new BillDataFiller();
            }

            // H√†m load v√† render c√°c h√≥a ƒë∆°n c·ª• th·ªÉ t·ª´ danh s√°ch ID
            async loadAndRenderSpecificBills(billIds) {
                if (!this.container) return;
                this.container.innerHTML = '<h1>ƒêang t·∫£i d·ªØ li·ªáu h√≥a ƒë∆°n...</h1>';

                try {
                    const sheetData = await this.billFiller.fetchSheetData();
                    if (!sheetData) {
                        this.container.innerHTML = '<h1>L·ªói: Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu t·ª´ Google Sheets.</h1>';
                        return;
                    }

                    this.container.innerHTML = '';
                    let foundCount = 0;

                    billIds.forEach((billId, index) => {
                        const billData = this.billFiller.findBillByNumber(sheetData, billId.trim());
                        if (billData) {
                            const billItem = this.createBillItem(billData, index);
                            this.container.appendChild(billItem);
                            this.fillBillData(billData);
                            foundCount++;
                        }
                    });

                    if (foundCount === 0) {
                        this.container.innerHTML = `<h1>Kh√¥ng t√¨m th·∫•y h√≥a ƒë∆°n n√†o v·ªõi c√°c m√£ ƒë√£ cung c·∫•p.</h1>`;
                    }

                } catch (error) {
                    console.error('L·ªói khi render h√≥a ƒë∆°n:', error);
                    this.container.innerHTML = '<h1>ƒê√£ x·∫£y ra l·ªói khi x·ª≠ l√Ω y√™u c·∫ßu.</h1>';
                }
            }
            
            // T·∫°o c·∫•u tr√∫c HTML cho m·ªôt h√≥a ƒë∆°n
            createBillItem(billData, index) {
                const billNumber = billData.maDonHang;
                const billItem = document.createElement('div');
                billItem.className = 'bill-item';
                billItem.id = `bill-${billNumber}`;
                billItem.innerHTML = `
                    <div class="bill-item-header">
                        <h2>H√ìA ƒê∆†N ${index + 1} - S·ªê BILL: ${billNumber}</h2>
                    </div>
                    <div class="bill-content">
                        <div class="header">
                            <div class="header-left">
                                <img class="logo" src="https://tuducdat2001-cyber.github.io/bill/z6887164537636_0c445e9b4d6e1687482f51f307b359e5.jpg" alt="Logo C√¥ng ty">
                                <div class="company-info">
                                    <h1>V·∫¨N T·∫¢I ECO</h1>
                                    <h2>V·∫¨N CHUY·ªÇN H√ÄNG HO√Å B·∫ÆC - NAM</h2>
                                    <p>Express & Exacting</p>
                                    <p class="hotline">Hotline 0946 936 999-0888.805.625</p>
                                </div>
                            </div>
                            <div class="header-right">
                                <svg class="barcode-svg" id="barcode-${billNumber}"></svg>
                            </div>
                        </div>
                        
                        <div class="info-section">
                            <div class="info-panel border-right">
                                <div class="item"><span class="label">T√™n kh√°ch g·ª≠i:</span><span class="value" id="tenNguoiGui-${billNumber}"></span></div>
                                <div class="item"><span class="label">ƒê·ªãa ch·ªâ:</span><span class="value" id="diaChiNguoiGui-${billNumber}"></span></div>
                                <div class="item"><span class="label">X√£, Ph∆∞·ªùng:</span><span class="value" id="xaPhuongGui-${billNumber}"></span></div>
                                <div class="item"><span class="label">T·ªânh/ TP:</span><span class="value" id="tinhTPGui-${billNumber}"></span></div>
                                <div class="item"><span class="label">S·ªë ƒëi·ªán tho·∫°i:</span><span class="value" id="sdtNguoiGui-${billNumber}"></span></div>
                            </div>
                            <div class="info-panel">
                                <div class="item"><span class="label">T√™n kh√°ch nh·∫≠n:</span><span class="value" id="tenNguoiNhan-${billNumber}"></span></div>
                                <div class="item"><span class="label">ƒê·ªãa ch·ªâ:</span><span class="value" id="diaChiNguoiNhan-${billNumber}"></span></div>
                                <div class="item"><span class="label">X√£, Ph∆∞·ªùng:</span><span class="value" id="xaPhuongNhan-${billNumber}"></span></div>
                                <div class="item"><span class="label">T·ªânh/ TP:</span><span class="value" id="tinhTPNhan-${billNumber}"></span></div>
                                <div class="item"><span class="label">S·ªë ƒëi·ªán tho·∫°i:</span><span class="value" id="sdtNguoiNhan-${billNumber}"></span></div>
                            </div>
                        </div>
                        
                        <div class="content-section">
                            <div class="main-content">
                                <div class="content-table">
                                    <table>
                                        <thead><tr><th>D·ªãch v·ª•</th><th>S·ªë ki·ªán</th><th>Tr·ªçng l∆∞·ª£ng</th><th>Th·ªÉ t√≠ch</th></tr></thead>
                                        <tbody><tr><td id="dichVuTrongBang-${billNumber}"></td><td id="soKien-${billNumber}"></td><td id="tlThuc-${billNumber}"></td><td id="thetich-${billNumber}"></td></tr></tbody>
                                    </table>
                                </div>
                                <div class="notes-table">
                                    <table>
                                        <thead><tr><th>N·ªôi dung h√†ng ho√°</th><th>Ghi ch√∫</th></tr></thead>
                                        <tbody><tr><td id="noiDungHangHoa-${billNumber}"></td><td id="ghiChu-${billNumber}"></td></tr></tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="side-content">
                                <div class="item"><span class="label">H√¨nh th·ª©c thanh to√°n:</span><span class="value" id="thanhToan-${billNumber}"></span></div>
                                <div class="item-separator"></div>
                                <div class="item"><span class="label">C∆∞·ªõc ch√≠nh:</span><span class="value-money" id="cuocChinh-${billNumber}"></span></div>
                                <div class="item"><span class="label">D·ªãch v·ª• c·ªông th√™m:</span><span class="value-money" id="dichVuThem-${billNumber}"></span></div>
                                <div class="item"><span class="label">T·ªïng c∆∞·ªõc:</span><span class="value-money" id="tongCuoc-${billNumber}"></span></div>
                                <div class="total-cost"><span class="label">Thu h·ªô:</span><span class="value-money" id="thuHo-${billNumber}"></span></div>
                                <div class="total-cost"><span class="label">T·ªïng ph·∫£i thu:</span><span class="value-money" id="tongPhaiThu-${billNumber}"></span></div>
                            </div>
                        </div>
                        
                        <div class="signature-section">
                            <div class="signature-box border-right"><p class="date-time">Ng√†y gi·ªù g·ª≠i: <span id="ngayGioGui-${billNumber}"></span></p><p>H·ªç t√™n v√† ch·ªØ k√Ω ng∆∞·ªùi g·ª≠i</p></div>
                            <div class="signature-box border-right"><p class="date-time">Ng√†y gi·ªù nh·∫≠n . . . . . . . . . . . . . . . . . . . .</p><p>Nh√¢n vi√™n nh·∫≠n k√Ω</p></div>
                            <div class="signature-box"><p class="date-time">Ng√†y gi·ªù nh·∫≠n . . . . . . . . . . . . . . . . . .  . .</p><p>H·ªç t√™n v√† ch·ªØ k√Ω ng∆∞·ªùi nh·∫≠n</p></div>
                        </div>

                        <div class="footer">
                            <div class="qr-note-container">
                                <img class="qr-code" src="https://tuducdat2001-cyber.github.io/bill/z6886848621829_aea68d7f33a412bd56c8271a3a15fe26.jpg" alt="M√£ QR">
                                <p class="qr-note">Qu√Ω kh√°ch vui l√≤ng qu√©t m√£ QR ƒë·ªÉ xem<br>Ch√≠nh s√°ch ƒë·ªÅn b√π v√† ƒëi·ªÅu ki·ªán chuy·ªÉn ph√°t</p>
                            </div>
                            <div class="footer-right"><button class="print-button" onclick="window.print()">üñ® In t·∫•t c·∫£ h√≥a ƒë∆°n</button></div>
                        </div>
                    </div>`;
                return billItem;
            }

            // Fill d·ªØ li·ªáu v√†o c·∫•u tr√∫c HTML c·ªßa h√≥a ƒë∆°n
            fillBillData(billData) {
                const billNumber = billData.maDonHang;
                const setText = (id, value) => {
                    const el = document.getElementById(`${id}-${billNumber}`);
                    if (el) el.textContent = value || '';
                };

                setText('tenNguoiGui', billData.tenNguoiGui);
                setText('diaChiNguoiGui', billData.diaChiNguoiGui);
                setText('xaPhuongGui', billData.xaPhuongGui);
                setText('tinhTPGui', billData.tinhTPGui);
                setText('sdtNguoiGui', billData.sdtNguoiGui);
                setText('tenNguoiNhan', billData.tenNguoiNhan);
                setText('diaChiNguoiNhan', billData.diaChiNguoiNhan);
                setText('xaPhuongNhan', billData.xaPhuongNhan);
                setText('tinhTPNhan', billData.tinhTPNhan);
                setText('sdtNguoiNhan', billData.sdtNguoiNhan);
                setText('ngayGioGui', billData.ngayGioGui);
                setText('soKien', billData.soKien);
                setText('tlThuc', billData.tlThuc ? `${billData.tlThuc} kg` : '');
                setText('thetich', billData.thetich ? `${billData.thetich} m¬≥` : '');
                setText('dichVuTrongBang', billData.dichVuTrongBang);
                setText('ghiChu', billData.ghiChu);
                setText('noiDungHangHoa', billData.noiDungHangHoa);
                setText('thanhToan', billData.thanhToan);
                setText('cuocChinh', this.billFiller.formatCurrency(billData.cuocChinh));
                setText('dichVuThem', this.billFiller.formatCurrency(billData.dichVuThem));
                setText('tongCuoc', this.billFiller.formatCurrency(billData.tongCuoc));
                setText('thuHo', this.billFiller.formatCurrency(billData.thuHo));
                setText('tongPhaiThu', this.billFiller.formatCurrency(billData.tongPhaiThu));

                if (billNumber) {
                    JsBarcode(`#barcode-${billNumber}`, billNumber, {
                        format: "CODE128", displayValue: true, fontSize: 18,
                        width: 2, height: 50, textAlign: "center"
                    });
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Arial', sans-serif; margin: 0; padding: 20px;
            background-color: #f0f2f5;
        }
        #bill-list-container {
            width: 100%; max-width: 950px; margin: 0 auto;
        }
        .bill-item {
            margin-bottom: 40px; page-break-inside: avoid; break-inside: avoid;
        }
        .bill-item-header {
            background-color: #e74c3c; color: white; padding: 10px 20px;
            margin-bottom: 0; border-radius: 5px 5px 0 0; text-align: center;
        }
        .bill-item-header h2 {
            margin: 0; font-size: 1.2rem; font-weight: bold;
        }
        .bill-content {
            background-color: white; border: 1px solid #000;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); padding: 10px;
            display: flex; flex-direction: column; gap: 5px; box-sizing: border-box;
        }
        .header {
            display: flex; justify-content: space-between; align-items: flex-start;
            padding-bottom: 5px; border-bottom: 2px solid #000;
        }
        .header-left {
            display: flex; align-items: center; flex: 1;
        }
        .header-left .logo {
            width: 50px; height: 50px; margin-right: 10px;
        }
        .company-info h1 {
            font-size: 1.5rem; font-weight: bold; margin: 0;
        }
        .company-info h2, .company-info p {
            font-size: 0.8rem; margin: 2px 0;
        }
        .hotline {
            color: #e74c3c; font-weight: bold;
        }
        .header-right .barcode-svg {
            display: block; width: 220px; height: 60px;
        }
        .info-section {
            display: grid; grid-template-columns: 1fr 1fr; border: 1px solid #000;
        }
        .info-panel { padding: 5px 10px; }
        .info-panel.border-right { border-right: 1px solid #000; }
        .info-panel .item { display: flex; font-size: 0.85rem; margin-bottom: 4px; }
        .info-panel .item .label { font-weight: bold; min-width: 95px; white-space: nowrap; }
        .info-panel .item .value { word-break: break-word; }
        .content-section {
            display: grid; grid-template-columns: 2fr 1fr; border: 1px solid #000; border-top: none;
        }
        .main-content { border-right: 1px solid #000; }
        .content-table table, .notes-table table {
            width: 100%; border-collapse: collapse; font-size: 0.85rem;
        }
        .content-table th, .content-table td, .notes-table th, .notes-table td {
            border: 1px solid #000; padding: 4px; text-align: center;
        }
        .content-table th, .notes-table th { background-color: #f2f2f2; }
        .notes-table { border-top: 1px solid #000; }
        .side-content { padding: 5px 10px; display: flex; flex-direction: column; }
        .side-content .item { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 5px; }
        .side-content .item .label { font-weight: bold; }
        .item-separator { border-bottom: 1px solid #000; margin: 5px 0; }
        .side-content .value-money { font-weight: bold; }
        .side-content .total-cost { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; padding-top: 8px; border-top: 1px solid #000; }
        .side-content .total-cost .label { font-weight: bold; font-size: 1rem; }
        .side-content .total-cost .value-money { font-size: 1.2rem; color: #e74c3c; }
        .signature-section { 
            display: grid; grid-template-columns: 1fr 1fr 1fr; text-align: center; 
            font-size: 0.8rem; border: 1px solid #000; border-top: none;
        }
        .signature-box { 
            padding: 10px 5px; min-height: 80px; 
            display: flex; flex-direction: column; justify-content: space-between; 
        }
        .signature-box.border-right { border-right: 1px solid #000; }
        .signature-box p { margin: 0; }
        .footer { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-top: auto; 
            padding-top: 5px; 
        }
        .qr-note-container { display: flex; align-items: center; }
        .qr-code { width: 50px; height: 50px; margin-right: 10px; }
        .qr-note { margin: 0; line-height: 1.3; font-size: 0.75rem; }
        .print-button { background-color: #007bff; color: white; border: none; padding: 10px 15px; cursor: pointer; border-radius: 5px; font-size: 1rem; }
        
        /* ======== CSS CHO VI·ªÜC IN TR√ÄN TRANG A5 ======== */
        @media print {
            @page {
                size: A5;
                margin: 0; /* B·ªè ho√†n to√†n l·ªÅ trang in */
            }

            html, body {
                width: 148mm;
                height: 210mm;
                margin: 0 !important;
                padding: 0 !important;
                background-color: #fff;
                font-size: 10pt; 
            }

            #bill-list-container {
                width: 100%;
                height: 100%;
                max-width: none;
                box-shadow: none;
                margin: 0;
                padding: 0;
            }

            .bill-item {
                width: 148mm; /* R·ªông b·∫±ng A5 */
                height: 210mm; /* Cao b·∫±ng A5 */
                box-shadow: none;
                border: none;
                margin: 0;
                display: flex;
                flex-direction: column;
                page-break-after: always;
                box-sizing: border-box; /* Quan tr·ªçng ƒë·ªÉ padding kh√¥ng l√†m tƒÉng k√≠ch th∆∞·ªõc */
            }
            
            .bill-content {
                box-shadow: none;
                border-radius: 0;
                flex-grow: 1;
                display: flex;
                flex-direction: column;
                border: none; /* B·ªè vi·ªÅn c·ªßa content ƒë·ªÉ kh√¥ng b·ªã vi·ªÅn k√©p */
            }

            .bill-item-header {
                border-radius: 0;
                background-color: #e74c3c !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .header-right .barcode-svg {
                 width: 180px; height: 50px;
            }

            .print-button {
                display: none !important;
            }
        }
        /* ======== K·∫æT TH√öC CSS IN ·∫§N ======== */
    </style>
</head>
<body>

<div id="bill-list-container">
    </div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const billManager = new BillListManager('bill-list-container');
        const urlParams = new URLSearchParams(window.location.search);
        const billIdsString = urlParams.get('id');

        if (billIdsString) {
            const billIds = billIdsString.split(',');
            billManager.loadAndRenderSpecificBills(billIds);
        } else {
            const container = document.getElementById('bill-list-container');
            if(container) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; border: 2px dashed #ccc; border-radius: 10px; margin-top: 50px;">
                        <h1>Ch√†o m·ª´ng ƒë·∫øn v·ªõi trang H√≥a ƒê∆°n V·∫≠n T·∫£i Eco</h1>
                        <p>ƒê·ªÉ xem h√≥a ƒë∆°n, vui l√≤ng th√™m m√£ s·ªë bill v√†o thanh ƒë·ªãa ch·ªâ URL.</p>
                        <p>V√≠ d·ª•: <strong>.../ten_file.html?id=ECO001</strong></p>
                        <p>ƒê·ªÉ xem nhi·ªÅu h√≥a ƒë∆°n, h√£y ngƒÉn c√°ch c√°c m√£ b·∫±ng d·∫•u ph·∫©y:</p>
                        <p>V√≠ d·ª•: <strong>.../ten_file.html?id=ECO001,ECO002</strong></p>
                    </div>`;
            }
        }
    });
</script>

</body>
</html>

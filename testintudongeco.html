<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hóa Đơn Vận Tải Eco (A5 Tràn Trang)</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script>
        // Lớp để lấy và xử lý dữ liệu từ Google Sheets
        class BillDataFiller {
            constructor() {
                this.sheetId = '1SbK_vKUJV7dTzDPmxmlEM-7MXBoh6guGRKU4dWvAiw4';
                this.sheetName = 'Bill';
            }

            // Hàm lấy dữ liệu từ Google Sheets public qua CSV
            async fetchSheetData() {
                try {
                    const url = `https://docs.google.com/spreadsheets/d/${this.sheetId}/gviz/tq?tqx=out:csv&sheet=${this.sheetName}`;
                    const response = await fetch(url);
                    const csvText = await response.text();
                    return this.parseCSV(csvText);
                } catch (error) {
                    console.error('Lỗi khi lấy dữ liệu từ Google Sheets:', error);
                    return null;
                }
            }

            // Hàm parse CSV thành mảng các đối tượng
            parseCSV(csvText) {
                const lines = csvText.split('\n');
                const result = [];
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim()) {
                        const row = this.parseCSVLine(lines[i]);
                        result.push(row);
                    }
                }
                return result;
            }

            // Hàm parse một dòng CSV (xử lý dấu phẩy trong ngoặc kép)
            parseCSVLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current.trim().replace(/^"|"$/g, ''));
                        current = '';
                    } else {
                        current += char;
                    }
                }
                result.push(current.trim().replace(/^"|"$/g, ''));
                return result;
            }

            // Hàm tìm dữ liệu theo số Bill
            findBillByNumber(sheetData, billNumber) {
                if (!sheetData) return null;
                for (let row of sheetData) {
                    // Cột "ső Bill" là cột thứ 2 (index 1)
                    if (row[1] && row[1].toString().trim() === billNumber.toString().trim()) {
                        return this.parseRowToBillData(row);
                    }
                }
                return null; // Không tìm thấy
            }

            // Hàm chuyển đổi một dòng thành object bill data
            parseRowToBillData(row) {
                 const billData = {
                    maDonHang: row[1] || '',       // "ső Bill"
                    ngayGioGui: row[2] || '',      // "Ngày bốc"
                    tenNguoiGui: row[4] || '',      // "Tên khách gửi"
                    tinhTPGui: row[5] || '',        // "Tỉnh"
                    xaPhuongGui: row[6] || '',      // "xã"
                    diaChiNguoiGui: row[7] || '',   // "Địa chỉ"
                    sdtNguoiGui: row[8] || '',      // "Địa chỉ đã lưu" (Giả định là SĐT)
                    tenNguoiNhan: row[9] || '',     // "Tên khách nhận"
                    diaChiNguoiNhan: row[10] || '', // "Địa chỉ nhận"
                    tinhTPNhan: row[11] || '',      // "Tỉnh nhận"
                    xaPhuongNhan: row[12] || '',    // "Xã nhận"
                    sdtNguoiNhan: row[13] || '',    // "SĐT khách nhận"
                    dichVuTrongBang: row[14] || '', // "Dịch vụ GTGT"
                    noiDungHangHoa: row[15] || '',  // "Nội dung hàng hóa"
                    soKien: row[16] || '',          // "Số kiện"
                    tlThuc: row[17] || '',          // "Trọng lượng thư"
                    thetich: row[18] || '',         // "Thể tích"
                    cuocChinh: row[20] || '',       // "Đơn giá"
                    dichVuThem: row[21] || '',      // "Phụ phí"
                    tongCuoc: row[23] || '',        // "Thành tiền"
                    thuHo: row[25] || '',           // "COD"
                    ghiChu: row[27] || '',          // "Ghi chú"
                    thanhToan: 'Người gửi'          // Mặc định
                };
                billData.tongPhaiThu = this.calculateTotal(billData.tongCuoc, billData.thuHo);
                return billData;
            }

            // Hàm tính tổng phải thu
            calculateTotal(tongCuoc, thuHo) {
                const cuoc = this.parseNumber(tongCuoc);
                const cod = this.parseNumber(thuHo);
                return (cuoc + cod).toString();
            }

            // Hàm chuyển đổi chuỗi thành số
            parseNumber(str) {
                if (!str) return 0;
                return parseInt(str.toString().replace(/[^\d]/g, '')) || 0;
            }

             // Hàm định dạng tiền tệ
            formatCurrency(amount) {
                const cleanedAmount = String(amount).replace(/\D/g, '');
                if (!cleanedAmount) return '0';
                return parseInt(cleanedAmount, 10).toLocaleString('vi-VN');
            }
        }

        // Class để quản lý việc hiển thị các hóa đơn
        class BillListManager {
            constructor(containerId) {
                this.container = document.getElementById(containerId);
                this.billFiller = new BillDataFiller();
            }

            // Hàm load và render các hóa đơn cụ thể từ danh sách ID
            async loadAndRenderSpecificBills(billIds) {
                if (!this.container) return;
                this.container.innerHTML = '<h1>Đang tải dữ liệu hóa đơn...</h1>';

                try {
                    const sheetData = await this.billFiller.fetchSheetData();
                    if (!sheetData) {
                        this.container.innerHTML = '<h1>Lỗi: Không thể tải dữ liệu từ Google Sheets.</h1>';
                        return;
                    }

                    this.container.innerHTML = '';
                    let foundCount = 0;

                    billIds.forEach((billId, index) => {
                        const billData = this.billFiller.findBillByNumber(sheetData, billId.trim());
                        if (billData) {
                            const billItem = this.createBillItem(billData, index);
                            this.container.appendChild(billItem);
                            this.fillBillData(billData);
                            foundCount++;
                        }
                    });

                    if (foundCount === 0) {
                        this.container.innerHTML = `<h1>Không tìm thấy hóa đơn nào với các mã đã cung cấp.</h1>`;
                    }

                } catch (error) {
                    console.error('Lỗi khi render hóa đơn:', error);
                    this.container.innerHTML = '<h1>Đã xảy ra lỗi khi xử lý yêu cầu.</h1>';
                }
            }
            
            // Tạo cấu trúc HTML cho một hóa đơn
            createBillItem(billData, index) {
                const billNumber = billData.maDonHang;
                const billItem = document.createElement('div');
                billItem.className = 'bill-item';
                billItem.id = `bill-${billNumber}`;
                billItem.innerHTML = `
                    <div class="bill-item-header">
                        <h2>HÓA ĐƠN ${index + 1} - SỐ BILL: ${billNumber}</h2>
                    </div>
                    <div class="bill-content">
                        <div class="header">
                            <div class="header-left">
                                <img class="logo" src="https://tuducdat2001-cyber.github.io/bill/z6887164537636_0c445e9b4d6e1687482f51f307b359e5.jpg" alt="Logo Công ty">
                                <div class="company-info">
                                    <h1>VẬN TẢI ECO</h1>
                                    <h2>VẬN CHUYỂN HÀNG HOÁ BẮC - NAM</h2>
                                    <p>Express & Exacting</p>
                                    <p class="hotline">Hotline 0946 936 999-0888.805.625</p>
                                </div>
                            </div>
                            <div class="header-right">
                                <svg class="barcode-svg" id="barcode-${billNumber}"></svg>
                            </div>
                        </div>
                        
                        <div class="info-section">
                            <div class="info-panel border-right">
                                <div class="item"><span class="label">Tên khách gửi:</span><span class="value" id="tenNguoiGui-${billNumber}"></span></div>
                                <div class="item"><span class="label">Địa chỉ:</span><span class="value" id="diaChiNguoiGui-${billNumber}"></span></div>
                                <div class="item"><span class="label">Xã, Phường:</span><span class="value" id="xaPhuongGui-${billNumber}"></span></div>
                                <div class="item"><span class="label">Tỉnh/ TP:</span><span class="value" id="tinhTPGui-${billNumber}"></span></div>
                                <div class="item"><span class="label">Số điện thoại:</span><span class="value" id="sdtNguoiGui-${billNumber}"></span></div>
                            </div>
                            <div class="info-panel">
                                <div class="item"><span class="label">Tên khách nhận:</span><span class="value" id="tenNguoiNhan-${billNumber}"></span></div>
                                <div class="item"><span class="label">Địa chỉ:</span><span class="value" id="diaChiNguoiNhan-${billNumber}"></span></div>
                                <div class="item"><span class="label">Xã, Phường:</span><span class="value" id="xaPhuongNhan-${billNumber}"></span></div>
                                <div class="item"><span class="label">Tỉnh/ TP:</span><span class="value" id="tinhTPNhan-${billNumber}"></span></div>
                                <div class="item"><span class="label">Số điện thoại:</span><span class="value" id="sdtNguoiNhan-${billNumber}"></span></div>
                            </div>
                        </div>
                        
                        <div class="content-section">
                            <div class="main-content">
                                <div class="content-table">
                                    <table>
                                        <thead><tr><th>Dịch vụ</th><th>Số kiện</th><th>Trọng lượng</th><th>Thể tích</th></tr></thead>
                                        <tbody><tr><td id="dichVuTrongBang-${billNumber}"></td><td id="soKien-${billNumber}"></td><td id="tlThuc-${billNumber}"></td><td id="thetich-${billNumber}"></td></tr></tbody>
                                    </table>
                                </div>
                                <div class="notes-table">
                                    <table>
                                        <thead><tr><th>Nội dung hàng hoá</th><th>Ghi chú</th></tr></thead>
                                        <tbody><tr><td id="noiDungHangHoa-${billNumber}"></td><td id="ghiChu-${billNumber}"></td></tr></tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="side-content">
                                <div class="item"><span class="label">Hình thức thanh toán:</span><span class="value" id="thanhToan-${billNumber}"></span></div>
                                <div class="item-separator"></div>
                                <div class="item"><span class="label">Cước chính:</span><span class="value-money" id="cuocChinh-${billNumber}"></span></div>
                                <div class="item"><span class="label">Dịch vụ cộng thêm:</span><span class="value-money" id="dichVuThem-${billNumber}"></span></div>
                                <div class="item"><span class="label">Tổng cước:</span><span class="value-money" id="tongCuoc-${billNumber}"></span></div>
                                <div class="total-cost"><span class="label">Thu hộ:</span><span class="value-money" id="thuHo-${billNumber}"></span></div>
                                <div class="total-cost"><span class="label">Tổng phải thu:</span><span class="value-money" id="tongPhaiThu-${billNumber}"></span></div>
                            </div>
                        </div>
                        
                        <div class="signature-section">
                            <div class="signature-box border-right"><p class="date-time">Ngày giờ gửi: <span id="ngayGioGui-${billNumber}"></span></p><p>Họ tên và chữ ký người gửi</p></div>
                            <div class="signature-box border-right"><p class="date-time">Ngày giờ nhận . . . . . . . . . . . . . . . . . . . .</p><p>Nhân viên nhận ký</p></div>
                            <div class="signature-box"><p class="date-time">Ngày giờ nhận . . . . . . . . . . . . . . . . . .  . .</p><p>Họ tên và chữ ký người nhận</p></div>
                        </div>

                        <div class="footer">
                            <div class="qr-note-container">
                                <img class="qr-code" src="https://tuducdat2001-cyber.github.io/bill/z6886848621829_aea68d7f33a412bd56c8271a3a15fe26.jpg" alt="Mã QR">
                                <p class="qr-note">Quý khách vui lòng quét mã QR để xem<br>Chính sách đền bù và điều kiện chuyển phát</p>
                            </div>
                            <div class="footer-right"><button class="print-button" onclick="window.print()">🖨 In tất cả hóa đơn</button></div>
                        </div>
                    </div>`;
                return billItem;
            }

            // Fill dữ liệu vào cấu trúc HTML của hóa đơn
            fillBillData(billData) {
                const billNumber = billData.maDonHang;
                const setText = (id, value) => {
                    const el = document.getElementById(`${id}-${billNumber}`);
                    if (el) el.textContent = value || '';
                };

                setText('tenNguoiGui', billData.tenNguoiGui);
                setText('diaChiNguoiGui', billData.diaChiNguoiGui);
                setText('xaPhuongGui', billData.xaPhuongGui);
                setText('tinhTPGui', billData.tinhTPGui);
                setText('sdtNguoiGui', billData.sdtNguoiGui);
                setText('tenNguoiNhan', billData.tenNguoiNhan);
                setText('diaChiNguoiNhan', billData.diaChiNguoiNhan);
                setText('xaPhuongNhan', billData.xaPhuongNhan);
                setText('tinhTPNhan', billData.tinhTPNhan);
                setText('sdtNguoiNhan', billData.sdtNguoiNhan);
                setText('ngayGioGui', billData.ngayGioGui);
                setText('soKien', billData.soKien);
                setText('tlThuc', billData.tlThuc ? `${billData.tlThuc} kg` : '');
                setText('thetich', billData.thetich ? `${billData.thetich} m³` : '');
                setText('dichVuTrongBang', billData.dichVuTrongBang);
                setText('ghiChu', billData.ghiChu);
                setText('noiDungHangHoa', billData.noiDungHangHoa);
                setText('thanhToan', billData.thanhToan);
                setText('cuocChinh', this.billFiller.formatCurrency(billData.cuocChinh));
                setText('dichVuThem', this.billFiller.formatCurrency(billData.dichVuThem));
                setText('tongCuoc', this.billFiller.formatCurrency(billData.tongCuoc));
                setText('thuHo', this.billFiller.formatCurrency(billData.thuHo));
                setText('tongPhaiThu', this.billFiller.formatCurrency(billData.tongPhaiThu));

                if (billNumber) {
                    JsBarcode(`#barcode-${billNumber}`, billNumber, {
                        format: "CODE128", displayValue: true, fontSize: 18,
                        width: 2, height: 50, textAlign: "center"
                    });
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Arial', sans-serif; margin: 0; padding: 20px;
            background-color: #f0f2f5;
        }
        #bill-list-container {
            width: 100%; max-width: 950px; margin: 0 auto;
        }
        .bill-item {
            margin-bottom: 40px; page-break-inside: avoid; break-inside: avoid;
        }
        .bill-item-header {
            background-color: #e74c3c; color: white; padding: 10px 20px;
            margin-bottom: 0; border-radius: 5px 5px 0 0; text-align: center;
        }
        .bill-item-header h2 {
            margin: 0; font-size: 1.2rem; font-weight: bold;
        }
        .bill-content {
            background-color: white; border: 1px solid #000;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); padding: 10px;
            display: flex; flex-direction: column; gap: 5px; box-sizing: border-box;
        }
        .header {
            display: flex; justify-content: space-between; align-items: flex-start;
            padding-bottom: 5px; border-bottom: 2px solid #000;
        }
        .header-left {
            display: flex; align-items: center; flex: 1;
        }
        .header-left .logo {
            width: 50px; height: 50px; margin-right: 10px;
        }
        .company-info h1 {
            font-size: 1.5rem; font-weight: bold; margin: 0;
        }
        .company-info h2, .company-info p {
            font-size: 0.8rem; margin: 2px 0;
        }
        .hotline {
            color: #e74c3c; font-weight: bold;
        }
        .header-right .barcode-svg {
            display: block; width: 220px; height: 60px;
        }
        .info-section {
            display: grid; grid-template-columns: 1fr 1fr; border: 1px solid #000;
        }
        .info-panel { padding: 5px 10px; }
        .info-panel.border-right { border-right: 1px solid #000; }
        .info-panel .item { display: flex; font-size: 0.85rem; margin-bottom: 4px; }
        .info-panel .item .label { font-weight: bold; min-width: 95px; white-space: nowrap; }
        .info-panel .item .value { word-break: break-word; }
        .content-section {
            display: grid; grid-template-columns: 2fr 1fr; border: 1px solid #000; border-top: none;
        }
        .main-content { border-right: 1px solid #000; }
        .content-table table, .notes-table table {
            width: 100%; border-collapse: collapse; font-size: 0.85rem;
        }
        .content-table th, .content-table td, .notes-table th, .notes-table td {
            border: 1px solid #000; padding: 4px; text-align: center;
        }
        .content-table th, .notes-table th { background-color: #f2f2f2; }
        .notes-table { border-top: 1px solid #000; }
        .side-content { padding: 5px 10px; display: flex; flex-direction: column; }
        .side-content .item { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 5px; }
        .side-content .item .label { font-weight: bold; }
        .item-separator { border-bottom: 1px solid #000; margin: 5px 0; }
        .side-content .value-money { font-weight: bold; }
        .side-content .total-cost { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; padding-top: 8px; border-top: 1px solid #000; }
        .side-content .total-cost .label { font-weight: bold; font-size: 1rem; }
        .side-content .total-cost .value-money { font-size: 1.2rem; color: #e74c3c; }
        .signature-section { 
            display: grid; grid-template-columns: 1fr 1fr 1fr; text-align: center; 
            font-size: 0.8rem; border: 1px solid #000; border-top: none;
        }
        .signature-box { 
            padding: 10px 5px; min-height: 80px; 
            display: flex; flex-direction: column; justify-content: space-between; 
        }
        .signature-box.border-right { border-right: 1px solid #000; }
        .signature-box p { margin: 0; }
        .footer { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-top: auto; 
            padding-top: 5px; 
        }
        .qr-note-container { display: flex; align-items: center; }
        .qr-code { width: 50px; height: 50px; margin-right: 10px; }
        .qr-note { margin: 0; line-height: 1.3; font-size: 0.75rem; }
        .print-button { background-color: #007bff; color: white; border: none; padding: 10px 15px; cursor: pointer; border-radius: 5px; font-size: 1rem; }
        
        /* ======== CSS CHO VIỆC IN TRÀN TRANG A5 ======== */
        @media print {
            @page {
                size: A5;
                margin: 0; /* Bỏ hoàn toàn lề trang in */
            }

            html, body {
                width: 148mm;
                height: 210mm;
                margin: 0 !important;
                padding: 0 !important;
                background-color: #fff;
                font-size: 10pt; 
            }

            #bill-list-container {
                width: 100%;
                height: 100%;
                max-width: none;
                box-shadow: none;
                margin: 0;
                padding: 0;
            }

            .bill-item {
                width: 148mm; /* Rộng bằng A5 */
                height: 210mm; /* Cao bằng A5 */
                box-shadow: none;
                border: none;
                margin: 0;
                display: flex;
                flex-direction: column;
                page-break-after: always;
                box-sizing: border-box; /* Quan trọng để padding không làm tăng kích thước */
            }
            
            .bill-content {
                box-shadow: none;
                border-radius: 0;
                flex-grow: 1;
                display: flex;
                flex-direction: column;
                border: none; /* Bỏ viền của content để không bị viền kép */
            }

            .bill-item-header {
                border-radius: 0;
                background-color: #e74c3c !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .header-right .barcode-svg {
                 width: 180px; height: 50px;
            }

            .print-button {
                display: none !important;
            }
        }
        /* ======== KẾT THÚC CSS IN ẤN ======== */
    </style>
</head>
<body>

<div id="bill-list-container">
    </div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const billManager = new BillListManager('bill-list-container');
        const urlParams = new URLSearchParams(window.location.search);
        const billIdsString = urlParams.get('id');

        if (billIdsString) {
            const billIds = billIdsString.split(',');
            billManager.loadAndRenderSpecificBills(billIds);
        } else {
            const container = document.getElementById('bill-list-container');
            if(container) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; border: 2px dashed #ccc; border-radius: 10px; margin-top: 50px;">
                        <h1>Chào mừng đến với trang Hóa Đơn Vận Tải Eco</h1>
                        <p>Để xem hóa đơn, vui lòng thêm mã số bill vào thanh địa chỉ URL.</p>
                        <p>Ví dụ: <strong>.../ten_file.html?id=ECO001</strong></p>
                        <p>Để xem nhiều hóa đơn, hãy ngăn cách các mã bằng dấu phẩy:</p>
                        <p>Ví dụ: <strong>.../ten_file.html?id=ECO001,ECO002</strong></p>
                    </div>`;
            }
        }
    });
</script>

</body>
</html>

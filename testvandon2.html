<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>BÁO CÁO TỔNG KẾT VẬN ĐƠN</title>
  <!-- Thêm thư viện Chart.js để vẽ biểu đồ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      background-color: #f5f5f5;
      color: #333;
      margin: 0;
    }
    h2 { text-align: center; margin-bottom: 20px; color: #2c3e50; }
    .controls {
      display: flex; justify-content: space-between; margin-bottom: 15px; align-items: center;
      background: #fff; padding: 15px; border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; flex-wrap: wrap;
      gap: 15px;
      transition: box-shadow 0.3s ease;
    }
    .controls .left-controls, .controls .right-controls { display: flex; align-items: center; gap: 15px; flex-wrap: wrap;}
    .controls .date-filter { display: flex; align-items: center; gap: 8px; }
    
    .controls button:not(.tab-btn) {
      padding: 10px 15px; border: none; border-radius: 5px; font-size: 16px; color: white;
      background-color: #27ae60; transition: all 0.2s ease-in-out;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer;
    }
    .controls button:not(.tab-btn):hover {
        background-color: #229954; transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .clear-filter-btn { background-color: #f39c12 !important; }
    .clear-filter-btn:hover { background-color: #e67e22 !important; }

    .controls .filter-select, .controls input[type="date"] {
      padding: 10px 15px; border: 1px solid #ccc; border-radius: 5px; font-size: 16px;
      background-color: white;
    }
    
    .table-wrapper {
      position: relative; overflow: auto; max-height: 75vh;
      background: white; border-radius: 5px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-top: 20px;
    }
    table {
      border-collapse: collapse; width: 100%; min-width: 1800px;
      font-size: 11px; font-weight: bold;
    }
    th, td {
      border: 1px solid #e0e0e0; padding: 6px 10px;
      white-space: nowrap; background-color: white; text-align: left;
    }
    th {
      background-color: #2c3e50; color: white; font-weight: 500;
      vertical-align: middle; position: sticky; top: 0; z-index: 20;
    }
    .no-data {
      text-align: center; padding: 20px;
      color: #7f8c8d; font-style: italic; font-size: 16px;
    }

    /* Chart Styles */
    #charts-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }
    .chart-wrapper {
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .chart-wrapper h3 {
        text-align: center;
        margin-top: 0;
        margin-bottom: 15px;
        color: #34495e;
    }

    .summary-table {
      width: 100%; margin-bottom: 20px; background: white;
      border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      overflow: hidden; font-size: 13px; 
    }
    .summary-table th { background-color: #2c3e50; position: sticky; top: 0; }
    .summary-table td { text-align: center; }
    .positive { color: #27ae60; font-weight: bold; }
    .negative { color: #e74c3c; font-weight: bold; }
    .summary-staff-header td { background-color: #ecf0f1 !important; font-weight: bold; text-align: left !important; color: #2c3e50; }
    .summary-staff-total td { background-color: #fff9c4 !important; font-weight: bold; color: #5d4037; }
    .summary-grand-total td { background-color: #ffeb3b !important; font-weight: bold; color: #3e2723; }
    
    ::-webkit-scrollbar { -webkit-appearance: none; height: 12px; width: 12px; }
    ::-webkit-scrollbar-thumb { border-radius: 5px; background-color: #27ae60; border: 2px solid #f5f5f5; }
    ::-webkit-scrollbar-thumb:hover { background-color: #229954; }
    
    /* MULTI-SELECT DROPDOWN STYLES */
    .multi-select-container { position: relative; display: inline-block; }
    .multi-select-container button {
        background-color: white; color: #333;
        border: 1px solid #ccc; font-size: 16px;
        padding: 10px 15px; text-align: left;
        width: 250px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; border-radius: 5px;
    }
    .checkbox-dropdown {
        display: none; position: absolute; background-color: #f9f9f9;
        min-width: 250px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
        z-index: 101; border: 1px solid #ddd; border-radius: 5px;
        max-height: 300px; overflow-y: auto; padding: 10px;
    }
    .checkbox-dropdown.show { display: block; }
    .checkbox-dropdown label {
        display: block; padding: 8px 12px;
        cursor: pointer; border-radius: 4px;
        transition: background-color 0.2s;
    }
    .checkbox-dropdown label:hover { background-color: #f1f1f1; }
    .checkbox-dropdown label input { margin-right: 10px; }
  </style>
</head>
<body>
  <h2>BÁO CÁO TỔNG KẾT VẬN ĐƠN</h2>
  
  <div id="contentReport">
    <div class="controls">
        <div class="left-controls">
            <span style="font-weight: bold; font-size: 18px;">Tùy chọn Báo cáo</span>
        </div>
        <div class="right-controls">
             <div class="date-filter">
                <span>Từ:</span><input type="date" id="reportStartDateFilter" />
                <span>Đến:</span><input type="date" id="reportEndDateFilter" />
            </div>
            <div class="multi-select-container">
                <button id="reportStaffFilterBtn">Tất cả NV Vận đơn</button>
                <div id="reportStaffDropdown" class="checkbox-dropdown">
                    <!-- Checkboxes will be populated by JS -->
                </div>
            </div>
            <select id="reportProductFilter" class="filter-select"><option value="">Tất cả sản phẩm</option></select>
            <select id="reportMarketFilter" class="filter-select"><option value="">Tất cả khu vực</option></select>
            <button id="reportClearFilters" class="clear-filter-btn">Xóa lọc</button>
        </div>
    </div>

    <!-- Chart Container -->
    <div id="charts-container">
        <div class="chart-wrapper">
            <h3>Phân tích Trạng thái Giao hàng</h3>
            <canvas id="statusBreakdownChart"></canvas>
        </div>
        <div class="chart-wrapper">
            <h3>Phân tích Kênh Vận hành</h3>
            <canvas id="funnelChart"></canvas>
        </div>
        <div class="chart-wrapper">
            <h3>Hiệu suất theo NV Vận đơn</h3>
            <canvas id="staffPerformanceChart"></canvas>
        </div>
         <div class="chart-wrapper">
            <h3>Hiệu suất theo Đơn vị Vận chuyển</h3>
            <canvas id="carrierPerformanceChart"></canvas>
        </div>
    </div>
    
    <!-- Summary Table Container -->
    <div class="table-wrapper">
      <h3 style="text-align: center; color: #2c3e50;">Báo cáo chi tiết</h3>
      <table class="summary-table">
        <thead>
          <tr>
            <th rowspan="2">NV Vận đơn</th><th rowspan="2">Đơn vị vận chuyển</th><th colspan="2">Đã Thanh Toán (có bill)</th><th rowspan="2">Bill 1 phần</th><th rowspan="2">Tổng đơn lên nội bộ</th><th rowspan="2">Tổng đơn đủ đkien đẩy vh</th><th rowspan="2">Tổng đơn lên vận hành</th><th rowspan="2">Tỷ lệ đơn lên vận hành</th><th rowspan="2">Giao Thành Công</th><th rowspan="2">Đang Giao</th><th rowspan="2">Chưa Giao</th><th rowspan="2">Hoàn</th><th rowspan="2">chờ check</th><th rowspan="2">Trống trạng thái</th><th rowspan="2">Tỷ lệ thu tiền/giao thành công</th><th rowspan="2">Tỷ lệ đơn tính phí vc</th>
          </tr>
          <tr>
            <th>Số đơn</th><th>Thành Tiền</th>
          </tr>
        </thead>
        <tbody id="summaryTableBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    const POST_URL = 'https://script.google.com/macros/s/AKfycbyGW5O47Y0TwPEqRzta72wwNSUN3jA1IPzSr1N72eOxVcqH4G8sgyelQROtDk9aVq75/exec';
    
    let allData = [];
    let chartInstances = {}; // Store chart instances to destroy them before redrawing

    // --- UTILITY FUNCTIONS ---
    function parseDateString(dateString) { if (!dateString || typeof dateString !== 'string') return null; const cleanedDateString = dateString.trim().replace(/[^\d\/\-\s]/g, ''); if (/^\d{4}-\d{2}-\d{2}/.test(cleanedDateString)) { const d = new Date(cleanedDateString); if (!isNaN(d.getTime())) return d; } const parts = cleanedDateString.match(/^(\d{1,2})[/\-](\d{1,2})[/\-](\d{4})/); if (parts) { const month = parseInt(parts[1], 10); const day = parseInt(parts[2], 10); const year = parseInt(parts[3], 10); if (year > 1000 && month > 0 && month <= 12 && day > 0 && day <= 31) { const d = new Date(Date.UTC(year, month - 1, day)); if (d.getUTCFullYear() === year && d.getUTCMonth() === month - 1) return d; } } return null; }
    function showError(message, containerId = 'summaryTableBody') { const container = document.getElementById(containerId); container.innerHTML = `<tr><td colspan="17" class="no-data">${message}</td></tr>`; }

    // --- DATA HANDLING AND RENDERING ---
    function handleData(response) { 
        if (response.error || !Array.isArray(response.rows)) { 
            showError('Lỗi hoặc không có dữ liệu: ' + (response.error || 'Định dạng dữ liệu không đúng')); 
            return; 
        } 
        
        allData = response.rows; 
        populateReportFilters();
        applyAllFilters();
    }

    // --- REPORTING AND SUMMARY TABLE LOGIC ---
    function createEmptyStats() { return { "Đã Thanh Toán (có bill)": { count: 0, amount: 0 }, "Bill 1 phần": { count: 0 }, "Tổng đơn lên nội bộ": { count: 0 }, "Tổng đơn đủ đkien đẩy vh": { count: 0 }, "Tổng đơn lên vận hành": { count: 0 }, "Giao Thành Công": { count: 0 }, "Đang Giao": { count: 0 }, "Chưa Giao": { count: 0 }, "Hoàn": { count: 0 }, "chờ check": { count: 0 }, "Trống trạng thái": { count: 0 } }; }
    
    function updateDetailedSummaryTable(filteredData) {
        const summaryTableBody = document.getElementById('summaryTableBody');
        summaryTableBody.innerHTML = ''; 
        if (filteredData.length === 0) { 
            showError('Không có dữ liệu báo cáo khớp với bộ lọc.'); 
            return; 
        } 

        const staffStats = {}; 
        const grandTotal = createEmptyStats(); 
        
        filteredData.forEach(row => { 
            const staffName = row["NV Vận đơn"] || row["NV_Vận_đơn"] || "Chưa có NV"; 
            const shippingCompany = row["Đơn vị vận chuyển"] || row["Đơn_vị_vận_chuyển"] || "Không xác định"; 
            if (!staffStats[staffName]) { 
                staffStats[staffName] = { _total: createEmptyStats() }; 
            } 
            if (!staffStats[staffName][shippingCompany]) { 
                staffStats[staffName][shippingCompany] = createEmptyStats(); 
            } 
            
            const statsToUpdate = [ staffStats[staffName][shippingCompany], staffStats[staffName]._total, grandTotal ]; 
            const amountValue = row["Tổng tiền VNĐ"] || row["Tổng_tiền_VNĐ"] || 0; 
            const numericAmount = parseFloat(String(amountValue).replace(/[^\d.-]/g, '')) || 0; 
            const paymentStatus = row["Trạng thái thu tiền"] || ""; 
            const deliveryStatus = row["Trạng thái giao hàng NB"] || ""; 
            
            statsToUpdate.forEach(stats => { 
                if (paymentStatus.includes("Có bill")) { 
                    stats["Đã Thanh Toán (có bill)"].count++; 
                    stats["Đã Thanh Toán (có bill)"].amount += numericAmount; 
                } else if (paymentStatus.includes("Có bill 1 phần")) { 
                    stats["Bill 1 phần"].count++; 
                } 
                
                if (deliveryStatus.includes("Giao Thành Công")) stats["Giao Thành Công"].count++; 
                else if (deliveryStatus.includes("Đang Giao")) stats["Đang Giao"].count++; 
                else if (deliveryStatus.includes("Chưa Giao")) stats["Chưa Giao"].count++; 
                else if (deliveryStatus.includes("Hoàn")) stats["Hoàn"].count++; 
                else if (deliveryStatus.includes("chờ check")) stats["chờ check"].count++; 
                else if (deliveryStatus === "") stats["Trống trạng thái"].count++; 
                
                stats["Tổng đơn lên nội bộ"].count++; 
                if (paymentStatus.includes("Có bill") || paymentStatus.includes("Có bill 1 phần")) { 
                    stats["Tổng đơn đủ đkien đẩy vh"].count++; 
                } 
                if (deliveryStatus && !deliveryStatus.includes("Chưa Giao") && !deliveryStatus.includes("chờ check")) { 
                    stats["Tổng đơn lên vận hành"].count++; 
                } 
            }); 
        }); 
        
        Object.keys(staffStats).sort().forEach(staffName => { 
            const staffData = staffStats[staffName]; 
            const headerRow = summaryTableBody.insertRow(); 
            headerRow.className = 'summary-staff-header'; 
            const headerCell = headerRow.insertCell(); 
            headerCell.colSpan = 17; 
            headerCell.textContent = `Nhân viên: ${staffName}`; 
            
            Object.keys(staffData).filter(key => key !== '_total').sort().forEach(companyName => { 
                summaryTableBody.appendChild(renderSummaryRow(staffName, companyName, staffData[companyName])); 
            }); 
            const totalRow = renderSummaryRow("Tổng cộng", "Tất cả DVVC", staffData._total); 
            totalRow.className = 'summary-staff-total'; 
            summaryTableBody.appendChild(totalRow); 
        }); 
        
        const grandTotalRow = renderSummaryRow("TỔNG TOÀN BỘ", "Tất cả NV & DVVC", grandTotal); 
        grandTotalRow.className = 'summary-grand-total'; 
        summaryTableBody.appendChild(grandTotalRow); 
    }
    
    function renderSummaryRow(staffName, companyName, data) { 
        const tr = document.createElement('tr'); 
        tr.insertCell().textContent = staffName; 
        tr.insertCell().textContent = companyName; 
        tr.insertCell().textContent = data["Đã Thanh Toán (có bill)"].count; 
        tr.insertCell().textContent = new Intl.NumberFormat('vi-VN').format(data["Đã Thanh Toán (có bill)"].amount) + ' ₫';
        tr.insertCell().textContent = data["Bill 1 phần"].count; 
        tr.insertCell().textContent = data["Tổng đơn lên nội bộ"].count; 
        tr.insertCell().textContent = data["Tổng đơn đủ đkien đẩy vh"].count; 
        tr.insertCell().textContent = data["Tổng đơn lên vận hành"].count; 
        const shippingRateCell = tr.insertCell();
        const shippingRate = data["Tổng đơn lên nội bộ"].count > 0 ? (data["Tổng đơn lên vận hành"].count / data["Tổng đơn lên nội bộ"].count * 100) : 0; 
        shippingRateCell.textContent = shippingRate.toFixed(1) + '%';
        shippingRateCell.className = shippingRate > 70 ? 'positive' : 'negative';
        tr.insertCell().textContent = data["Giao Thành Công"].count; 
        tr.insertCell().textContent = data["Đang Giao"].count; 
        tr.insertCell().textContent = data["Chưa Giao"].count; 
        tr.insertCell().textContent = data["Hoàn"].count; 
        tr.insertCell().textContent = data["chờ check"].count; 
        tr.insertCell().textContent = data["Trống trạng thái"].count; 
        const paymentRateCell = tr.insertCell();
        const paymentSuccessRate = data["Giao Thành Công"].count > 0 ? (data["Đã Thanh Toán (có bill)"].count / data["Giao Thành Công"].count * 100) : 0; 
        paymentRateCell.textContent = paymentSuccessRate.toFixed(1) + '%';
        paymentRateCell.className = paymentSuccessRate > 80 ? 'positive' : 'negative';
        const feeRateCell = tr.insertCell();
        const feeRate = data["Tổng đơn lên vận hành"].count > 0 ? (data["Giao Thành Công"].count / data["Tổng đơn lên vận hành"].count * 100) : 0; 
        feeRateCell.textContent = feeRate.toFixed(1) + '%';
        feeRateCell.className = feeRate > 80 ? 'positive' : 'negative';
        return tr; 
    }

    // --- CHARTING LOGIC ---
    function updateCharts(filteredData) {
        // Destroy existing charts to prevent memory leaks and rendering issues
        Object.keys(chartInstances).forEach(key => {
            if(chartInstances[key]) {
                chartInstances[key].destroy();
            }
        });

        if (filteredData.length === 0) {
            // Optional: Show a "no data" message in chart areas
            return;
        }

        // 1. Status Breakdown Chart (Doughnut)
        const statusCounts = { 'Giao Thành Công': 0, 'Hoàn': 0, 'Đang Giao': 0, 'chờ check': 0, 'Khác': 0 };
        filteredData.forEach(row => {
            const status = row["Trạng thái giao hàng NB"] || "";
            if (status.includes("Giao Thành Công")) statusCounts['Giao Thành Công']++;
            else if (status.includes("Hoàn")) statusCounts['Hoàn']++;
            else if (status.includes("Đang Giao")) statusCounts['Đang Giao']++;
            else if (status.includes("chờ check")) statusCounts['chờ check']++;
            else if (status) statusCounts['Khác']++;
        });

        const statusCtx = document.getElementById('statusBreakdownChart').getContext('2d');
        chartInstances.status = new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(statusCounts),
                datasets: [{
                    label: 'Số lượng đơn',
                    data: Object.values(statusCounts),
                    backgroundColor: ['#2ecc71', '#e74c3c', '#3498db', '#f1c40f', '#95a5a6'],
                    hoverOffset: 4
                }]
            },
            options: { responsive: true, maintainAspectRatio: true }
        });

        // 2. Funnel Chart (Bar)
        const funnelStats = createEmptyStats();
        filteredData.forEach(row => {
            const paymentStatus = row["Trạng thái thu tiền"] || ""; 
            const deliveryStatus = row["Trạng thái giao hàng NB"] || "";
            funnelStats["Tổng đơn lên nội bộ"].count++;
            if (deliveryStatus && !deliveryStatus.includes("Chưa Giao") && !deliveryStatus.includes("chờ check")) { 
                funnelStats["Tổng đơn lên vận hành"].count++; 
            } 
            if (deliveryStatus.includes("Giao Thành Công")) funnelStats["Giao Thành Công"].count++;
        });

        const funnelCtx = document.getElementById('funnelChart').getContext('2d');
        chartInstances.funnel = new Chart(funnelCtx, {
            type: 'bar',
            data: {
                labels: ['Tổng đơn nội bộ', 'Đơn lên vận hành', 'Giao thành công'],
                datasets: [{
                    label: 'Số lượng đơn',
                    data: [
                        funnelStats["Tổng đơn lên nội bộ"].count,
                        funnelStats["Tổng đơn lên vận hành"].count,
                        funnelStats["Giao Thành Công"].count
                    ],
                    backgroundColor: ['#3498db', '#f39c12', '#27ae60']
                }]
            },
            options: { indexAxis: 'y', responsive: true, maintainAspectRatio: true, plugins: { legend: { display: false } } }
        });

        // 3. Staff Performance Chart (Bar)
        const staffPerformance = {};
        filteredData.forEach(row => {
            const staff = row["NV Vận đơn"] || "Chưa có NV";
            if (!staffPerformance[staff]) {
                staffPerformance[staff] = { success: 0, returned: 0 };
            }
            const status = row["Trạng thái giao hàng NB"] || "";
            if (status.includes("Giao Thành Công")) staffPerformance[staff].success++;
            else if (status.includes("Hoàn")) staffPerformance[staff].returned++;
        });

        const staffCtx = document.getElementById('staffPerformanceChart').getContext('2d');
        chartInstances.staff = new Chart(staffCtx, {
            type: 'bar',
            data: {
                labels: Object.keys(staffPerformance),
                datasets: [
                    { label: 'Thành Công', data: Object.values(staffPerformance).map(d => d.success), backgroundColor: '#2ecc71' },
                    { label: 'Hoàn', data: Object.values(staffPerformance).map(d => d.returned), backgroundColor: '#e74c3c' }
                ]
            },
            options: { responsive: true, maintainAspectRatio: true, scales: { x: { stacked: true }, y: { stacked: true } } }
        });

        // 4. Carrier Performance Chart (Bar)
        const carrierPerformance = {};
        filteredData.forEach(row => {
            const carrier = row["Đơn vị vận chuyển"] || "Không xác định";
            if (!carrierPerformance[carrier]) {
                carrierPerformance[carrier] = { success: 0, returned: 0 };
            }
            const status = row["Trạng thái giao hàng NB"] || "";
            if (status.includes("Giao Thành Công")) carrierPerformance[carrier].success++;
            else if (status.includes("Hoàn")) carrierPerformance[carrier].returned++;
        });

        const carrierCtx = document.getElementById('carrierPerformanceChart').getContext('2d');
        chartInstances.carrier = new Chart(carrierCtx, {
            type: 'bar',
            data: {
                labels: Object.keys(carrierPerformance),
                datasets: [
                    { label: 'Thành Công', data: Object.values(carrierPerformance).map(d => d.success), backgroundColor: '#2ecc71' },
                    { label: 'Hoàn', data: Object.values(carrierPerformance).map(d => d.returned), backgroundColor: '#e74c3c' }
                ]
            },
            options: { responsive: true, maintainAspectRatio: true, scales: { x: { stacked: true }, y: { stacked: true } } }
        });
    }

    // --- FILTERING LOGIC ---
    function setupControls() {
        const staffBtn = document.getElementById('reportStaffFilterBtn');
        const staffDropdown = document.getElementById('reportStaffDropdown');

        document.getElementById('reportStartDateFilter').addEventListener('change', applyAllFilters);
        document.getElementById('reportEndDateFilter').addEventListener('change', applyAllFilters);
        document.getElementById('reportProductFilter').addEventListener('change', applyAllFilters);
        document.getElementById('reportMarketFilter').addEventListener('change', applyAllFilters);
        document.getElementById('reportClearFilters').addEventListener('click', () => {
            document.getElementById('reportStartDateFilter').value = '';
            document.getElementById('reportEndDateFilter').value = '';
            document.getElementById('reportProductFilter').selectedIndex = 0;
            document.getElementById('reportMarketFilter').selectedIndex = 0;
            staffDropdown.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            updateStaffFilterButtonText();
            applyAllFilters();
        });

        staffBtn.addEventListener('click', () => staffDropdown.classList.toggle('show'));
        staffDropdown.addEventListener('click', e => e.stopPropagation());
        window.addEventListener('click', (e) => {
            if (!staffBtn.contains(e.target)) {
                staffDropdown.classList.remove('show');
            }
        });
    }
    
    function populateReportFilters() {
        const productFilter = document.getElementById('reportProductFilter');
        const marketFilter = document.getElementById('reportMarketFilter');
        const staffDropdown = document.getElementById('reportStaffDropdown');

        const allProducts = [...new Set(allData.map(r => r["Mặt hàng"]).filter(Boolean))].sort();
        const allMarkets = [...new Set(allData.map(r => r["khu vực"] || r["Khu vực"]).filter(Boolean))].sort();
        const allStaff = [...new Set(allData.map(r => r["NV Vận đơn"] || r["NV_Vận_đơn"]).filter(Boolean))].sort();

        productFilter.innerHTML = '<option value="">Tất cả sản phẩm</option>';
        allProducts.forEach(opt => productFilter.add(new Option(opt, opt)));
        
        marketFilter.innerHTML = '<option value="">Tất cả khu vực</option>';
        allMarkets.forEach(opt => marketFilter.add(new Option(opt, opt)));

        staffDropdown.innerHTML = '';
        const allLabel = document.createElement('label');
        allLabel.innerHTML = `<input type="checkbox" id="reportStaffSelectAll"> <b>Chọn tất cả</b>`;
        staffDropdown.appendChild(allLabel);

        allStaff.forEach(staffName => {
            const label = document.createElement('label');
            label.innerHTML = `<input type="checkbox" value="${staffName}"> ${staffName}`;
            label.querySelector('input').addEventListener('change', () => {
                updateStaffFilterButtonText();
                applyAllFilters();
            });
            staffDropdown.appendChild(label);
        });

        document.getElementById('reportStaffSelectAll').addEventListener('change', (e) => {
            staffDropdown.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = e.target.checked);
            updateStaffFilterButtonText();
            applyAllFilters();
        });
    }
    
    function updateStaffFilterButtonText() {
        const staffBtn = document.getElementById('reportStaffFilterBtn');
        const dropdown = document.getElementById('reportStaffDropdown');
        const selectedCount = dropdown.querySelectorAll('input:checked:not(#reportStaffSelectAll)').length;
        
        if (selectedCount === 0) staffBtn.textContent = 'Tất cả NV Vận đơn';
        else if (selectedCount === 1) staffBtn.textContent = '1 NV đã chọn';
        else staffBtn.textContent = `${selectedCount} NV đã chọn`;
    }

    function applyAllFilters() {
        let filteredData = [...allData];

        const startDate = document.getElementById('reportStartDateFilter').value;
        const endDate = document.getElementById('reportEndDateFilter').value;
        const product = document.getElementById('reportProductFilter').value;
        const market = document.getElementById('reportMarketFilter').value;
        
        const selectedStaff = Array.from(document.querySelectorAll('#reportStaffDropdown input:checked:not(#reportStaffSelectAll)'))
                                   .map(cb => cb.value);

        if (startDate || endDate) {
            const start = startDate ? new Date(startDate) : null;
            const end = endDate ? new Date(endDate) : null;
            if(start) start.setHours(0,0,0,0);
            if(end) end.setHours(23,59,59,999);
            filteredData = filteredData.filter(row => {
                const orderDate = parseDateString(row["Ngày lên đơn"] || row["Thời gian lên đơn"]);
                return orderDate && (!start || orderDate >= start) && (!end || orderDate <= end);
            });
        }
        if (product) {
            filteredData = filteredData.filter(row => row["Mặt hàng"] === product);
        }
        if (market) {
            filteredData = filteredData.filter(row => (row["khu vực"] || row["Khu vực"]) === market);
        }
        if (selectedStaff.length > 0) {
            const staffSet = new Set(selectedStaff);
            filteredData = filteredData.filter(row => staffSet.has(row["NV Vận đơn"] || row["NV_Vận_đơn"]));
        }
        
        // Update both the table and the charts with the filtered data
        updateDetailedSummaryTable(filteredData);
        updateCharts(filteredData);
    }
    
    // --- INITIALIZATION ---
    function loadData() { 
        showError('Đang tải dữ liệu, vui lòng chờ...'); 
        updateCharts([]); // Clear charts
        const script = document.createElement('script'); 
        script.src = `${POST_URL}?callback=handleData&rand=${Math.random()}`; 
        document.body.appendChild(script); 
        script.onload = () => script.remove();
        script.onerror = () => showError('Tải dữ liệu thất bại. Vui lòng kiểm tra kết nối mạng và thử lại.');
    }

    // --- START THE APP ---
    document.addEventListener('DOMContentLoaded', () => {
        setupControls();
        loadData();
    });

  </script>
</body>
</html>

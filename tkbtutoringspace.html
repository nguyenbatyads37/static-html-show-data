<!doctype html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lịch học, lịch thi theo tuần</title>

<style>
  /* ==========================================================================
   *  Palette & Professional Theme
   * ========================================================================== */
  :root {
    --bg: #f8f9fa;
    --paper: #ffffff;
    --ink: #212529;
    --muted: #6c757d;
    --line: #dee2e6;
    
    /* Brand Color: Claret Red (Đỏ mận) */
    --brand: #9B2226; 
    --brand-dark: #800F2F;
    --brand-light: #F8E6E7;

    /* Study/Exam Colors */
    --study: #3A86FF; 
    --study-light: #eff6ff;
    --study-border: #dbeafe;
    
    --exam-light: var(--brand-light);
    --exam-border: #f5d4d6;

    /* Shadows & Radius */
    --shadow-soft: 0 2px 4px rgba(0,0,0,0.06);
    --shadow-medium: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
    --shadow-large: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
    --radius: 10px;
  }

  /* ==========================================================================
   *  Animations
   * ========================================================================== */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  @keyframes modal-fade-in {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  @keyframes modal-content-slide-in {
    from { transform: translateY(-20px) scale(0.98); opacity: 0; }
    to { transform: translateY(0) scale(1); opacity: 1; }
  }

  /* ==========================================================================
   *  Base & Typography
   * ========================================================================== */
  * { box-sizing: border-box; }
  html, body { height: 100%; }
  body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
    color: var(--ink);
    background: var(--bg);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  /* ==========================================================================
   *  Layout Shell
   * ========================================================================== */
  .app {
    max-width: 1500px;
    margin: 32px auto;
    padding: 16px;
  }
  .frame {
    background: var(--paper);
    border: 1px solid var(--line);
    border-radius: 16px;
    box-shadow: var(--shadow-medium);
    overflow: hidden;
  }

  /* ==========================================================================
   *  Header
   * ========================================================================== */
  .header {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 20px 24px;
    border-bottom: 1px solid var(--line);
    flex-wrap: wrap;
    background: #fff;
  }
  .title {
    font-size: 26px;
    font-weight: 700;
    margin-right: auto;
    display: flex;
    align-items: center;
    gap: 16px;
  }
  .title img {
    height: 80px;
    width: auto;
  }
  .chipset {
    display: flex;
    align-items: center;
    gap: 8px;
    background: #f1f3f5;
    padding: 6px;
    border-radius: 999px;
  }
  .chip {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    border-radius: 999px;
    background: transparent;
    border: none;
    cursor: pointer;
    user-select: none;
    font-size: 14px;
    font-weight: 600;
    color: var(--muted);
    transition: all 0.2s ease;
  }
  .chip input { appearance: none; width: 0; height: 0; margin: 0; }
  .chip .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: currentColor;
    opacity: 0.5;
    transition: all 0.2s ease;
  }
  .chip:hover { 
    color: var(--ink);
    background-color: #e9ecef;
  }
  .chip.active {
    color: var(--brand);
    background: white;
    box-shadow: var(--shadow-soft);
  }
  .chip.active .dot {
    opacity: 1;
    background-color: var(--brand);
  }
  .chip[data-filter="study"].active { color: var(--study); }
  .chip[data-filter="study"].active .dot { background-color: var(--study); }
  
  /* Controls */
  .controls { display: flex; align-items: center; gap: 8px; }
  .btn {
    height: 40px;
    padding: 0 16px;
    border: 1px solid var(--line);
    background: white;
    border-radius: var(--radius);
    display: inline-flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    transition: all 0.2s ease;
  }
  .btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
    border-color: #ced4da;
  }
  .btn:active {
    transform: translateY(0);
    box-shadow: var(--shadow-soft);
  }
  .btn.primary {
    background: var(--brand);
    border-color: var(--brand);
    color: white;
  }
  .btn.primary:hover {
    background: var(--brand-dark);
    border-color: var(--brand-dark);
  }
  .modal-content .btn-group {
    display: flex;
    gap: 12px;
    margin-top: 24px;
  }

  .datebar { display: flex; align-items: center; gap: 10px; margin-left: 6px; }
  .datebar input[type="date"] {
    height: 40px;
    padding: 0 12px;
    border-radius: var(--radius);
    border: 1px solid var(--line);
    background: white;
    font-weight: 600;
  }

  /* ==========================================================================
   *  Calendar Grid - WITH WATERMARK
   * ========================================================================== */
  .grid-container {
    position: relative;
  }
  .grid {
    display: grid;
    grid-template-columns: 120px repeat(7, 1fr);
    grid-auto-rows: minmax(90px, auto);
  }
  
  .grid-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: url('https://www.appsheet.com/template/gettablefileurl?appName=Upcode-325045268&tableName=D%E1%BB%B1%20%C3%A1n&fileName=D%E1%BB%B1%20%C3%A1n_Images%2F305fbfb4.%E1%BA%A2nh%20Logo.025506.png');
    background-repeat: no-repeat;
    background-position: center center;
    background-size: 500px;
    opacity: 0.1;
    z-index: 0;
    pointer-events: none;
  }
  
  .grid > * {
    border-bottom: 1px solid var(--line);
    position: relative;
    z-index: 1;
  }
  .day-head {
    padding: 16px 12px;
    font-weight: 700;
    text-align: center;
    border-left: 1px solid var(--line);
    background: rgba(252, 253, 255, 0.8);
    position: sticky;
    top: 0;
    z-index: 10;
  }
  .day-head.today {
    background-color: var(--brand-light);
    color: var(--brand-dark);
    border-bottom: 3px solid var(--brand);
  }
  .day-head.today small { color: var(--brand); }
  .day-head small { display: block; font-weight: 500; color: var(--muted); margin-top: 4px; font-size: 13px; }
  .time-col {
    padding: 16px;
    background: rgba(249, 250, 251, 0.8);
    color: var(--muted);
    font-weight: 600;
    font-size: 14px;
    text-align: right;
  }
  .slot {
    position: relative;
    border-left: 1px solid var(--line);
    padding: 16px;
    min-height: 100px;
    transition: background-color 0.2s ease;
    background-color: transparent;
  }
  .slot:hover {
    background-color: rgba(252, 253, 255, 0.5);
  }

  /* ==========================================================================
   *  Cards - COMPACT & EXPAND ON HOVER
   * ========================================================================== */
  .card {
    background: var(--study-light);
    border: 1px solid var(--study-border);
    border-left: 5px solid var(--study);
    border-radius: var(--radius);
    width: 100%;
    box-shadow: var(--shadow-soft);
    font-size: 14px;
    cursor: pointer;
    overflow: hidden;
    
    transition: transform 0.2s ease, box-shadow 0.2s ease, padding 0.35s ease, z-index 0s 0.35s; 
    animation: fadeIn 0.4s ease-out;

    padding: 8px 12px;
    z-index: 1;
  }
  
  .card + .card { margin-top: 8px; }

  .card .name {
    font-weight: 600;
    line-height: 1.3;
    font-size: 14px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .card .sub, .card .row, .card .gv {
    max-height: 0;
    opacity: 0;
    margin-top: 0;
    transition: max-height 0.35s ease, opacity 0.3s ease, margin-top 0.35s ease;
  }
  
  .card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-large);
    padding: 14px 16px;
    z-index: 20;
    transition: transform 0.2s ease, box-shadow 0.2s ease, padding 0.35s ease, z-index 0s;
  }

  .card:hover .name {
      font-weight: 700;
      white-space: normal;
  }

  .card:hover .sub, .card:hover .row, .card:hover .gv {
    max-height: 40px;
    opacity: 1;
  }
  
  .card:hover .sub { margin-top: 6px; }
  .card:hover .gv { margin-top: 10px; }


  .card.exam {
    background: var(--exam-light);
    border-color: var(--exam-border);
    border-left-color: var(--brand);
  }
  
  .card.today-task {
    border-color: var(--brand);
    box-shadow: 0 0 0 1px var(--brand), var(--shadow-medium);
  }
  .card.today-task:hover {
    box-shadow: 0 0 0 1px var(--brand-dark), var(--shadow-large);
  }

  /* ==========================================================================
   *  Modals - With Backdrop Blur
   * ========================================================================== */
  .modal-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(33, 37, 41, 0.5);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 16px;
    visibility: hidden;
    opacity: 0;
    transition: opacity 0.3s ease, visibility 0.3s ease;
  }
  .modal-backdrop.active {
    visibility: visible;
    opacity: 1;
    animation: modal-fade-in 0.3s ease;
  }
  .modal-content {
    background: white;
    padding: 28px 32px;
    border-radius: var(--radius);
    box-shadow: var(--shadow-large);
    width: 100%;
    max-width: 550px;
    position: relative;
    animation: modal-content-slide-in 0.4s cubic-bezier(0.25, 1, 0.5, 1);
  }
  .modal-close-btn {
    position: absolute;
    top: 12px;
    right: 12px;
    background: transparent;
    border: none;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    font-size: 24px;
    line-height: 1;
    cursor: pointer;
    color: var(--muted);
    transition: all 0.2s ease;
  }
  .modal-close-btn:hover {
    background: #f1f3f5;
    color: var(--ink);
    transform: rotate(90deg);
  }
  .modal-content h2 {
    margin-top: 0;
    font-size: 24px;
    border-left: 4px solid var(--brand);
    padding-left: 16px;
    margin-bottom: 24px;
  }
  .modal-content p {
    margin: 10px 0;
    font-size: 16px;
    display: flex;
    align-items: center;
    gap: 12px;
    color: #495057;
  }

  /* ==========================================================================
   *  Kanban Board & Add Task FAB - UPGRADED
   * ========================================================================== */
  .kanban-modal .modal-content { max-width: 90vw; width: 1200px; }
  .kanban-board { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 20px; }
  .kanban-column {
    background-color: #f1f3f5;
    padding: 15px;
    border-radius: var(--radius);
    transition: background-color 0.2s ease;
    min-height: 400px;
  }
  .kanban-column.drag-over {
    background-color: var(--brand-light);
  }
  .kanban-column h3 {
    margin-top: 0;
    font-size: 16px;
    padding-bottom: 12px;
    margin-bottom: 16px;
    border-bottom: 2px solid var(--line);
    font-weight: 700;
  }
  .kanban-card {
    background-color: white;
    padding: 12px;
    border-radius: 8px;
    box-shadow: var(--shadow-soft);
    margin-bottom: 12px;
    font-size: 14px;
    border-left: 4px solid var(--brand);
    cursor: grab;
  }
  .kanban-card.dragging {
    opacity: 0.5;
    box-shadow: var(--shadow-large);
    cursor: grabbing;
  }
  .kanban-card.study { border-left-color: var(--study); }
  .kanban-card .kanban-title { font-size: 15px; font-weight: 600; margin: 0; }
  .kanban-card .kanban-subtitle { color: var(--muted); margin-top: 4px; display: block; }
  
  .kanban-attachment { margin-top: 12px; }
  .kanban-attachment img { max-width: 100%; border-radius: 8px; }
  .kanban-attachment a.file-link {
    display: block; padding: 8px 12px; background: #f8f9fa; border: 1px solid var(--line);
    border-radius: 8px; text-decoration: none; color: var(--ink); font-weight: 500; word-break: break-all;
  }
  .kanban-attachment a.file-link:hover { background: #e9ecef; }
  .youtube-embed { position: relative; width: 100%; padding-bottom: 56.25%; height: 0; }
  .youtube-embed iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; border-radius: 8px; }

  /* Styles for Inline Editing */
  .kanban-card.is-editing {
    box-shadow: var(--shadow-large), 0 0 0 2px var(--study);
    cursor: default;
  }
  .kanban-card.is-editing .kanban-title,
  .kanban-card.is-editing .kanban-subtitle {
    display: none;
  }
  .kanban-edit-title, .kanban-edit-subtitle {
    width: 100%;
    border: 1px solid var(--line);
    border-radius: 6px;
    padding: 6px 8px;
    font-family: inherit;
    margin-bottom: 6px;
  }
  .kanban-edit-title { font-size: 15px; font-weight: 600; }
  .kanban-edit-subtitle { font-size: 14px; color: var(--muted); }
  .kanban-edit-controls {
    display: flex;
    gap: 8px;
    margin-top: 10px;
  }
  .kanban-edit-btn {
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
  }
  .kanban-edit-btn.save { background-color: #28a745; color: white; }
  .kanban-edit-btn.cancel { background-color: #f1f3f5; color: var(--ink); }


  .fab {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 60px;
    height: 60px;
    background-color: var(--brand);
    border-radius: 50%;
    box-shadow: var(--shadow-large);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 32px;
    line-height: 1;
    cursor: pointer;
    z-index: 999;
    transition: all 0.2s ease;
  }
  .fab:hover {
    transform: scale(1.1) rotate(15deg);
    background-color: var(--brand-dark);
  }

  .form-group { margin-bottom: 16px; }
  .form-group label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 14px; }
  .form-group input, .form-group select {
    width: 100%;
    padding: 12px;
    border-radius: var(--radius);
    border: 1px solid var(--line);
    font-size: 16px;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .form-group input:focus, .form-group select:focus {
    outline: none;
    border-color: var(--brand);
    box-shadow: 0 0 0 3px rgba(155, 34, 38, 0.2);
  }
  
  /* ==========================================================================
   *  NEW: Custom Scroll Picker Styles
   * ========================================================================== */
  
  /* NEW: Wrapper for the display box and the picker itself */
  .time-picker-wrapper {
      position: relative;
  }
  
  /* NEW: The clickable box that shows the time */
  .time-display-box {
    width: 100%;
    padding: 12px;
    border-radius: var(--radius);
    border: 1px solid var(--line);
    font-size: 18px; /* Larger font for time */
    font-weight: 600;
    background: #fff;
    cursor: pointer;
    user-select: none;
    transition: border-color 0.2s, box-shadow 0.2s;
    text-align: center;
    position: relative;
    padding-left: 40px; /* Space for icon */
  }
  .time-display-box:hover {
    border-color: #adb5bd;
  }
  /* NEW: Clock icon */
  .time-display-box::before {
    content: '🕒';
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 18px;
  }
  
  .picker-container {
    display: flex;
    gap: 10px;
    justify-content: center;
    align-items: center;
    
    /* NEW: Hide/Show animation */
    max-height: 0;
    opacity: 0;
    overflow: hidden;
    transition: max-height 0.4s ease-in-out, opacity 0.3s ease-in-out, margin-top 0.4s ease-in-out;
    margin-top: 0;
  }
  /* NEW: Class to show the picker */
  .picker-container.visible {
    max-height: 300px; /* A safe large value */
    opacity: 1;
    margin-top: 10px;
  }

  .picker {
    width: 100px;
    height: 240px; 
    position: relative;
    overflow: hidden;
    background: #f1f3f5; 
    border-radius: 12px;
  }

  .picker-scroll {
    position: absolute;
    width: 100%;
    transition: transform 0.3s ease-out;
  }

  .picker-item {
    height: 50px; 
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 26px; 
    color: var(--muted); 
    transition: all 0.3s;
    cursor: pointer;
    user-select: none;
  }

  .picker-item.active {
    color: var(--brand); 
    font-size: 32px; 
    font-weight: 600;
  }

  .picker-highlight {
    position: absolute;
    top: 50%;
    left: 4px;
    right: 4px;
    height: 50px; 
    transform: translateY(-50%);
    background: rgba(0, 0, 0, 0.05);
    border-top: 1px solid var(--line);
    border-bottom: 1px solid var(--line);
    pointer-events: none;
    border-radius: 8px;
  }

  .separator {
    font-size: 32px;
    font-weight: 600;
    color: var(--ink);
  }


  /* ==========================================================================
   *  Responsive
   * ========================================================================== */
  @media (max-width: 1200px) {
    .grid { grid-template-columns: 100px repeat(7, minmax(150px, 1fr)); }
  }
  @media (max-width: 992px) {
    .app { margin: 16px auto; padding: 8px; }
    .header { gap: 12px; }
    .title { width: 100%; margin-bottom: 8px; }
    .datebar { flex-wrap: wrap; gap: 8px; }
    .grid-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  }
</style>
</head>
<body>
<div class="app">
  <div class="frame">
    <!-- Header -->
    <div class="header">
      <div class="title">
        <img src="https://www.appsheet.com/template/gettablefileurl?appName=Upcode-325045268&tableName=D%E1%BB%B1%20%C3%A1n&fileName=D%E1%BB%B1%20%C3%A1n_Images%2F305fbfb4.%E1%BA%A2nh%20Logo.025506.png" alt="logo">
        Lịch học, lịch thi theo tuần
      </div>

      <div class="chipset" id="filterGroup">
        <label class="chip active" data-filter="all">
          <input type="radio" name="filter" checked>
          <span class="dot"></span> Tất cả
        </label>
        <label class="chip" data-filter="study">
          <input type="radio" name="filter">
          <span class="dot"></span> Lịch học
        </label>
        <label class="chip" data-filter="exam">
          <input type="radio" name="filter">
          <span class="dot"></span> Lịch thi
        </label>
      </div>

      <div class="datebar">
        <input id="weekPicker" type="date" value="2025-10-18" />
        <button class="btn primary" id="todayBtn">Hiện tại</button>
        <button class="btn" id="printBtn">🖨️ In lịch</button>
        <button class="btn" id="prevBtn">‹ Trở về</button>
        <button class="btn" id="nextBtn">Tiếp ›</button>
      </div>
    </div>

    <!-- Grid Container for horizontal scrolling on mobile -->
    <div class="grid-container">
      <div class="grid" id="grid">
        <!-- Column heads -->
        <div class="time-col"></div>
        <div class="day-head" data-day="2">Thứ 2<small>13/10/2025</small></div>
        <div class="day-head" data-day="3">Thứ 3<small>14/10/2025</small></div>
        <div class="day-head" data-day="4">Thứ 4<small>15/10/2025</small></div>
        <div class="day-head" data-day="5">Thứ 5<small>16/10/2025</small></div>
        <div class="day-head" data-day="6">Thứ 6<small>17/10/2025</small></div>
        <div class="day-head" data-day="7">Thứ 7<small>18/10/2025</small></div>
        <div class="day-head" data-day="cn">Chủ nhật<small>19/10/2025</small></div>

        <!-- Sáng row -->
        <div class="time-col label">Sáng</div>
        <div class="slot" data-col="2">
            <div class="card" data-type="study">
                <div class="name">Toán cao cấp A2</div>
                <div class="sub">7:00 - 9:00</div>
                <div class="row">📍 Phòng A1-203</div>
                <div class="gv">GV: Nguyễn Văn A</div>
            </div>
             <div class="card" data-type="study">
                <div class="name">Triết học Mác-Lênin</div>
                <div class="sub">9:15 - 11:15</div>
                <div class="row">📍 Hội trường B</div>
                <div class="gv">GV: Nguyễn Thị E</div>
            </div>
        </div>
        <div class="slot" data-col="3"></div>
        <div class="slot" data-col="4">
             <div class="card" data-type="study">
                <div class="name">Lập trình Web</div>
                <div class="sub">9:15 - 11:15</div>
                <div class="row">📍 Phòng B2-101</div>
                <div class="gv">GV: Trần Thị B</div>
            </div>
        </div>
        <div class="slot" data-col="5"></div>
        <div class="slot" data-col="6">
            <div class="card exam" data-type="exam">
                <div class="name">Thi cuối kỳ: Vật lý 1</div>
                <div class="sub">8:00 - 9:30</div>
                <div class="row">📍 Giảng đường 1</div>
                <div class="gv">Ca thi: 1</div>
            </div>
        </div>
        <div class="slot" data-col="7"></div>
        <div class="slot" data-col="cn"></div>

        <!-- Chiều row -->
        <div class="time-col label">Chiều</div>
        <div class="slot" data-col="2"></div>
        <div class="slot" data-col="3">
            <div class="card" data-type="study">
                <div class="name">Cấu trúc dữ liệu và giải thuật</div>
                <div class="sub">13:30 - 15:30</div>
                <div class="row">📍 Phòng C1-405</div>
                <div class="gv">GV: Lê Văn C</div>
            </div>
        </div>
        <div class="slot" data-col="4"></div>
        <div class="slot" data-col="5">
            <div class="card" data-type="study">
                <div class="name">Kinh tế vi mô</div>
                <div class="sub">15:00 - 17:00</div>
                <div class="row">📍 Phòng A2-307</div>
                <div class="gv">GV: Phạm Thị D</div>
            </div>
        </div>
        <div class="slot" data-col="6"></div>
        <div class="slot" data-col="7"></div>
        <div class="slot" data-col="cn"></div>

        <!-- Tối row -->
        <div class="time-col label">Tối</div>
        <div class="slot" data-col="2"></div>
        <div class="slot" data-col="3"></div>
        <div class="slot" data-col="4"></div>
        <div class="slot" data-col="5"></div>
        <div class="slot" data-col="6"></div>
        <div class="slot" data-col="7"></div>
        <div class="slot" data-col="cn"></div>
      </div>
    </div>
  </div>
</div>

<!-- Add Task FAB -->
<div id="addTaskBtn" class="fab">+</div>

<!-- Task Detail Modal -->
<div id="taskModal" class="modal-backdrop">
    <div class="modal-content">
        <button id="modalCloseBtn" class="modal-close-btn">&times;</button>
        <h2 id="modalTaskName">Task Name</h2>
        <p id="modalTaskTime">🕒 7:00 - 9:00</p>
        <p id="modalTaskRoom">📍 Phòng A1-203</p>
        <p id="modalTaskGv">🧑‍🏫 GV: Nguyễn Văn A</p>
        <div class="btn-group">
            <button class="btn" id="viewKanbanBtn">Xem ở dạng Kanban</button>
        </div>
    </div>
</div>

<!-- Kanban Modal -->
<div id="kanbanModal" class="modal-backdrop kanban-modal">
    <div class="modal-content">
        <button id="kanbanModalCloseBtn" class="modal-close-btn">&times;</button>
        <h2 id="kanbanTaskName">Kanban Board</h2>
        <div class="kanban-board">
            <div class="kanban-column">
                <h3>Cần làm</h3>
                <!-- Card with YouTube Video -->
                <div id="k-card-1" class="kanban-card study" draggable="true">
                    <p class="kanban-title">Xem lại bài giảng video</p>
                    <small class="kanban-subtitle">Môn: Lập trình Web</small>
                    <div class="kanban-attachment">
                        <div class="youtube-embed">
                            <iframe src="https://www.youtube.com/embed/dQw4w9WgXcQ" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                        </div>
                    </div>
                </div>
                <!-- Card with File Link -->
                <div id="k-card-2" class="kanban-card exam" draggable="true">
                    <p class="kanban-title">Tải và đọc đề cương ôn tập</p>
                    <small class="kanban-subtitle">Thi: Vật lý 1</small>
                     <div class="kanban-attachment">
                        <a href="#" class="file-link">🔗 de-cuong-vat-ly-1.pdf</a>
                    </div>
                </div>
            </div>
            <div class="kanban-column">
                <h3>Đang thực hiện</h3>
                <!-- Card with Image -->
                <div id="k-card-3" class="kanban-card study" draggable="true">
                    <p class="kanban-title">Làm bài tập lớn</p>
                    <small class="kanban-subtitle">Môn: Toán cao cấp A2</small>
                    <div class="kanban-attachment">
                        <img src="https://images.unsplash.com/photo-1581291518857-4e27b48ff24e?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=60" alt="Code on screen">
                    </div>
                </div>
            </div>
            <div class="kanban-column">
                <h3>Hoàn thành</h3>
                <!-- Simple Card -->
                <div id="k-card-4" class="kanban-card study" draggable="true">
                    <p class="kanban-title">Đọc giáo trình chương 1</p>
                    <small class="kanban-subtitle">Môn: Kinh tế vi mô</small>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Add Task Modal -->
<div id="addTaskModal" class="modal-backdrop">
    <div class="modal-content">
        <button id="addTaskModalCloseBtn" class="modal-close-btn">&times;</button>
        <h2>Thêm công việc mới</h2>
        <form id="addTaskForm">
            <div class="form-group">
                <label for="taskName">Tên công việc</label>
                <input type="text" id="taskName" required>
            </div>
             <div class="form-group">
                <label for="taskType">Loại</label>
                <select id="taskType">
                    <option value="study">Lịch học</option>
                    <option value="exam">Lịch thi</option>
                </select>
            </div>
            <div class="form-group">
                <label for="taskDate">Ngày</label>
                <input type="date" id="taskDate" required>
            </div>

            <!-- START TIME PICKER -->
            <div class="form-group">
                <label>Giờ bắt đầu</label>
                <div class="time-picker-wrapper">
                    <div class="time-display-box" id="startTimeDisplay">00:00</div>
                    <div class="picker-container" id="startPickerContainer">
                        <div class="picker" id="startHourPicker">
                            <div class="picker-highlight"></div>
                            <div class="picker-scroll" id="startHourScroll"></div>
                        </div>
                        <div class="separator">:</div>
                        <div class="picker" id="startMinutePicker">
                            <div class="picker-highlight"></div>
                            <div class="picker-scroll" id="startMinuteScroll"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- END TIME PICKER -->
            <div class="form-group">
                <label>Giờ kết thúc</label>
                 <div class="time-picker-wrapper">
                    <div class="time-display-box" id="endTimeDisplay">00:00</div>
                    <div class="picker-container" id="endPickerContainer">
                        <div class="picker" id="endHourPicker">
                            <div class="picker-highlight"></div>
                            <div class="picker-scroll" id="endHourScroll"></div>
                        </div>
                        <div class="separator">:</div>
                        <div class="picker" id="endMinutePicker">
                            <div class="picker-highlight"></div>
                            <div class="picker-scroll" id="endMinuteScroll"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- DURATION DISPLAY -->
            <div class="form-group">
                <label>Tổng số giờ</label>
                <div id="timeDurationDisplay" style="font-size: 18px; font-weight: 600; color: var(--brand); padding: 10px; background: var(--brand-light); border-radius: 8px; text-align: center;">
                    Vui lòng chọn thời gian
                </div>
            </div>
            
            <div class="form-group">
                <label for="taskLocation">Địa điểm</label>
                <input type="text" id="taskLocation" placeholder="VD: Phòng A1-203">
            </div>
             <div class="form-group">
                <label for="taskLecturer">Giảng viên/Ghi chú</label>
                <input type="text" id="taskLecturer" placeholder="VD: GV: Nguyễn Văn A">
            </div>
            <div class="btn-group">
                 <button type="submit" class="btn primary">Thêm công việc</button>
            </div>
        </form>
    </div>
</div>

<script>
// ==========================================================================
// Custom Scroll Picker Class
// ==========================================================================
class ScrollPicker {
    constructor(containerId, scrollId, items, defaultIndex = 0, onUpdateCallback = () => {}) {
        this.container = document.getElementById(containerId);
        this.scroll = document.getElementById(scrollId);
        this.items = items;
        this.currentIndex = defaultIndex;
        this.itemHeight = 50; // Match CSS
        this.isDragging = false;
        this.startY = 0;
        this.startTranslate = 0;
        this.onUpdate = onUpdateCallback;
        
        this.init();
    }
    
    init() {
        this.renderItems();
        this.updatePosition(false);
        this.attachEvents();
    }
    
    renderItems() {
        this.scroll.innerHTML = ''; // Clear existing items
        for (let i = 0; i < 2; i++) {
            const div = document.createElement('div');
            div.className = 'picker-item';
            this.scroll.appendChild(div);
        }
        
        this.items.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'picker-item';
            div.textContent = item;
            div.dataset.index = index;
            this.scroll.appendChild(div);
        });
        
        for (let i = 0; i < 2; i++) {
            const div = document.createElement('div');
            div.className = 'picker-item';
            this.scroll.appendChild(div);
        }
    }
    
    attachEvents() {
        this.container.addEventListener('mousedown', this.onStart.bind(this));
        this.container.addEventListener('touchstart', this.onStart.bind(this), { passive: false });
        document.addEventListener('mousemove', this.onMove.bind(this));
        document.addEventListener('touchmove', this.onMove.bind(this), { passive: false });
        document.addEventListener('mouseup', this.onEnd.bind(this));
        document.addEventListener('touchend', this.onEnd.bind(this));
        this.container.addEventListener('wheel', this.onWheel.bind(this));
    }
    
    onStart(e) {
        this.isDragging = true;
        this.startY = e.type === 'mousedown' ? e.clientY : e.touches[0].clientY;
        this.startTranslate = this.currentIndex * this.itemHeight;
    }
    
    onMove(e) {
        if (!this.isDragging) return;
        e.preventDefault();
        const currentY = e.type === 'mousemove' ? e.clientY : e.touches[0].clientY;
        const diff = currentY - this.startY;
        const newTranslate = this.startTranslate - diff;
        const newIndex = Math.round(newTranslate / this.itemHeight);
        this.currentIndex = Math.max(0, Math.min(this.items.length - 1, newIndex));
        this.updatePosition(true);
    }
    
    onEnd() {
        if (!this.isDragging) return;
        this.isDragging = false;
        this.updatePosition(true);
        setTimeout(() => this.onUpdate(), 50);
    }
    
    onWheel(e) {
        e.preventDefault();
        const delta = e.deltaY > 0 ? 1 : -1;
        this.currentIndex = Math.max(0, Math.min(this.items.length - 1, this.currentIndex + delta));
        this.updatePosition(true);
         setTimeout(() => this.onUpdate(), 50);
    }
    
    updatePosition(animate) {
        const centerOffset = 95;
        const translateY = centerOffset - ((this.currentIndex + 2) * this.itemHeight);
        
        this.scroll.style.transition = animate ? 'transform 0.3s ease-out' : 'none';
        this.scroll.style.transform = `translateY(${translateY}px)`;
        
        const items = this.scroll.querySelectorAll('.picker-item');
        items.forEach((item) => {
            const realIndex = parseInt(item.dataset.index);
            item.classList.toggle('active', realIndex === this.currentIndex);
        });
    }
    
    getValue() {
        return this.items[this.currentIndex];
    }
}

document.addEventListener('DOMContentLoaded', () => {
    
    // --- TIME PICKER AND DURATION LOGIC ---
    const durationDisplay = document.getElementById('timeDurationDisplay');
    const startTimeDisplay = document.getElementById('startTimeDisplay');
    const endTimeDisplay = document.getElementById('endTimeDisplay');
    const startPickerContainer = document.getElementById('startPickerContainer');
    const endPickerContainer = document.getElementById('endPickerContainer');

    let startHourPicker, startMinutePicker, endHourPicker, endMinutePicker;

    function updateDisplayTime(type) {
        if (type === 'start') {
            startTimeDisplay.textContent = `${startHourPicker.getValue()}:${startMinutePicker.getValue()}`;
        } else if (type === 'end') {
            endTimeDisplay.textContent = `${endHourPicker.getValue()}:${endMinutePicker.getValue()}`;
        }
    }

    function updateDuration() {
        if (!startHourPicker || !endHourPicker) return; 

        const startHour = parseInt(startHourPicker.getValue());
        const startMinute = parseInt(startMinutePicker.getValue());
        const endHour = parseInt(endHourPicker.getValue());
        const endMinute = parseInt(endMinutePicker.getValue());

        const startTimeInMinutes = startHour * 60 + startMinute;
        const endTimeInMinutes = endHour * 60 + endMinute;

        if (endTimeInMinutes <= startTimeInMinutes) {
            durationDisplay.textContent = 'Giờ kết thúc không hợp lệ';
            durationDisplay.style.color = '#dc3545'; 
            return;
        }

        const durationInMinutes = endTimeInMinutes - startTimeInMinutes;
        const durationHours = Math.floor(durationInMinutes / 60);
        const durationMinutes = durationInMinutes % 60;

        let durationText = 'Tổng: ';
        if (durationHours > 0) durationText += `${durationHours} giờ `;
        if (durationMinutes > 0) durationText += `${durationMinutes} phút`;
        
        durationDisplay.textContent = durationText.trim();
        durationDisplay.style.color = 'var(--brand)';
    }
    
    const now = new Date();
    const hours = Array.from({length: 24}, (_, i) => String(i).padStart(2, '0'));
    const minutes = Array.from({length: 60}, (_, i) => String(i).padStart(2, '0'));
    
    let endHourDefault = now.getHours() + 1;
    let endMinuteDefault = now.getMinutes();
    if (endHourDefault > 23) {
        endHourDefault = 23;
        endMinuteDefault = 59;
    }

    const onStartUpdate = () => { updateDisplayTime('start'); updateDuration(); };
    const onEndUpdate = () => { updateDisplayTime('end'); updateDuration(); };

    startHourPicker = new ScrollPicker('startHourPicker', 'startHourScroll', hours, now.getHours(), onStartUpdate);
    startMinutePicker = new ScrollPicker('startMinutePicker', 'startMinuteScroll', minutes, now.getMinutes(), onStartUpdate);
    endHourPicker = new ScrollPicker('endHourPicker', 'endHourScroll', hours, endHourDefault, onEndUpdate);
    endMinutePicker = new ScrollPicker('endMinutePicker', 'endMinuteScroll', minutes, endMinuteDefault, onEndUpdate);

    // Set initial display values
    updateDisplayTime('start');
    updateDisplayTime('end');
    
    // Event listeners to toggle pickers
    startTimeDisplay.addEventListener('click', (e) => {
        e.stopPropagation();
        startPickerContainer.classList.toggle('visible');
        endPickerContainer.classList.remove('visible');
    });

    endTimeDisplay.addEventListener('click', (e) => {
        e.stopPropagation();
        endPickerContainer.classList.toggle('visible');
        startPickerContainer.classList.remove('visible');
    });

    // Click outside to close pickers
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.time-picker-wrapper')) {
            startPickerContainer.classList.remove('visible');
            endPickerContainer.classList.remove('visible');
        }
    });


    // --- Filter: Tất cả / Lịch học / Lịch thi ---
    const filterGroup = document.getElementById('filterGroup');
    const chips = [...filterGroup.querySelectorAll('.chip')];
    
    function applyFilter() {
        const cards = [...document.querySelectorAll('.card')];
        const activeChip = filterGroup.querySelector('.chip.active');
        const mode = activeChip ? activeChip.dataset.filter : 'all';
        
        cards.forEach(card => {
            const type = card.dataset.type;
            card.style.display =
                (mode === 'all') ||
                (mode === 'study' && type === 'study') ||
                (mode === 'exam' && type === 'exam')
                ? '' : 'none';
        });
    }

    chips.forEach(ch => {
        ch.addEventListener('click', () => {
            chips.forEach(c => c.classList.remove('active'));
            ch.classList.add('active');
            applyFilter();
        });
    });

    // --- Date controls ---
    const weekPicker = document.getElementById('weekPicker');
    const todayBtn = document.getElementById('todayBtn');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const headers = document.querySelectorAll('.day-head');
    const grid = document.getElementById('grid');

    function formatDate(d) {
        const dd = String(d.getDate()).padStart(2, '0');
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const yyyy = d.getFullYear();
        return `${dd}/${mm}/${yyyy}`;
    }

    function setWeekFrom(dateStr) {
        const d = dateStr ? new Date(dateStr) : new Date();
        const dayOfWeek = d.getDay();
        const diffToMonday = (dayOfWeek === 0) ? -6 : 1 - dayOfWeek;
        const monday = new Date(d);
        monday.setDate(d.getDate() + diffToMonday);

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        document.querySelectorAll('.card.today-task').forEach(card => card.classList.remove('today-task'));
        document.querySelectorAll('.day-head.today').forEach(head => head.classList.remove('today'));

        headers.forEach((el, i) => {
            const currentDay = new Date(monday);
            currentDay.setDate(monday.getDate() + i);
            currentDay.setHours(0, 0, 0, 0);
            
            const small = el.querySelector('small');
            if (small) small.textContent = formatDate(currentDay);

            if (currentDay.getTime() === today.getTime()) {
                el.classList.add('today');
                const dayKey = el.dataset.day;
                const todaySlots = document.querySelectorAll(`.slot[data-col="${dayKey}"]`);
                todaySlots.forEach(slot => {
                    slot.querySelectorAll('.card').forEach(card => card.classList.add('today-task'));
                });
            }
        });
    }

    function updateDate(offset) {
        const d = new Date(weekPicker.value || new Date());
        d.setDate(d.getDate() + offset);
        const iso = d.toISOString().slice(0, 10);
        weekPicker.value = iso;
        setWeekFrom(iso);
    }
    
    todayBtn.addEventListener('click', () => {
        const today = new Date();
        const iso = today.toISOString().slice(0, 10);
        weekPicker.value = iso;
        setWeekFrom(iso);
    });

    prevBtn.addEventListener('click', () => updateDate(-7));
    nextBtn.addEventListener('click', () => updateDate(7));
    weekPicker.addEventListener('change', e => setWeekFrom(e.target.value));

    // --- Modal Logic ---
    const taskModal = document.getElementById('taskModal');
    const modalCloseBtn = document.getElementById('modalCloseBtn');
    const modalTaskName = document.getElementById('modalTaskName');
    const modalTaskTime = document.getElementById('modalTaskTime');
    const modalTaskRoom = document.getElementById('modalTaskRoom');
    const modalTaskGv = document.getElementById('modalTaskGv');

    const kanbanModal = document.getElementById('kanbanModal');
    const kanbanModalCloseBtn = document.getElementById('kanbanModalCloseBtn');
    const kanbanTaskName = document.getElementById('kanbanTaskName');
    const viewKanbanBtn = document.getElementById('viewKanbanBtn');

    const addTaskModal = document.getElementById('addTaskModal');
    const addTaskBtn = document.getElementById('addTaskBtn');
    const addTaskModalCloseBtn = document.getElementById('addTaskModalCloseBtn');
    const addTaskForm = document.getElementById('addTaskForm');


    function showTaskModal(card) {
        const name = card.querySelector('.name')?.textContent || '';
        const time = card.querySelector('.sub')?.textContent || '';
        const room = card.querySelector('.row')?.textContent || '';
        const gv = card.querySelector('.gv')?.textContent || '';

        modalTaskName.textContent = name;
        modalTaskTime.innerHTML = `🕒 ${time}`;
        modalTaskRoom.innerHTML = `📍 ${room.trim().replace('📍', '')}`;
        modalTaskGv.innerHTML = `🧑‍🏫 ${gv.trim()}`;
        
        kanbanTaskName.textContent = `Kanban: ${name}`;
        
        if (card.classList.contains('exam')) {
             modalTaskName.style.borderColor = 'var(--brand)';
        } else {
             modalTaskName.style.borderColor = 'var(--study)';
        }

        taskModal.classList.add('active');
    }

    function hideModal(modal) {
        modal.classList.remove('active');
    }
    
    grid.addEventListener('click', (e) => {
        const card = e.target.closest('.card');
        if (card) {
            showTaskModal(card);
        }
    });

    viewKanbanBtn.addEventListener('click', () => {
        hideModal(taskModal);
        kanbanModal.classList.add('active');
    });

    addTaskBtn.addEventListener('click', () => {
        addTaskModal.classList.add('active');
        updateDuration();
    });

    modalCloseBtn.addEventListener('click', () => hideModal(taskModal));
    kanbanModalCloseBtn.addEventListener('click', () => hideModal(kanbanModal));
    addTaskModalCloseBtn.addEventListener('click', () => hideModal(addTaskModal));

    [taskModal, kanbanModal, addTaskModal].forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                hideModal(modal);
            }
        });
    });

    addTaskForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const startTime = `${startHourPicker.getValue()}:${startMinutePicker.getValue()}`;
        const endTime = `${endHourPicker.getValue()}:${endMinutePicker.getValue()}`;
        alert(`Chức năng đang phát triển!\n\nThời gian: ${startTime} - ${endTime}\n${durationDisplay.textContent}`);
        hideModal(addTaskModal);
        addTaskForm.reset();
    });
    
    // --- KANBAN DRAG AND DROP LOGIC ---
    function initializeKanbanDragAndDrop() {
        const draggableCards = document.querySelectorAll('.kanban-card[draggable="true"]');
        const columns = document.querySelectorAll('.kanban-column');

        draggableCards.forEach(card => {
            card.addEventListener('dragstart', () => {
                setTimeout(() => card.classList.add('dragging'), 0);
            });

            card.addEventListener('dragend', () => {
                card.classList.remove('dragging');
            });
        });

        columns.forEach(column => {
            column.addEventListener('dragover', e => {
                e.preventDefault();
                const afterElement = getDragAfterElement(column, e.clientY);
                const dragging = document.querySelector('.dragging');
                if (dragging) {
                    if (afterElement == null) {
                        column.appendChild(dragging);
                    } else {
                        column.insertBefore(dragging, afterElement);
                    }
                }
            });
        });
    }
    
    function getDragAfterElement(column, y) {
        const draggableElements = [...column.querySelectorAll('.kanban-card:not(.dragging)')];
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }
    
    // --- KANBAN INLINE EDITING LOGIC ---
    function initializeKanbanEditing() {
        const kanbanBoard = document.querySelector('.kanban-board');

        kanbanBoard.addEventListener('dblclick', e => {
            const card = e.target.closest('.kanban-card');
            if (!card || e.target.closest('a, iframe, .kanban-edit-controls, input, .kanban-attachment')) {
                return;
            }
            if (kanbanBoard.querySelector('.is-editing')) return;
            enterEditMode(card);
        });
    }

    function enterEditMode(card) {
        card.classList.add('is-editing');
        card.setAttribute('draggable', 'false');

        const titleEl = card.querySelector('.kanban-title');
        const subtitleEl = card.querySelector('.kanban-subtitle');

        const titleInput = document.createElement('input');
        titleInput.type = 'text';
        titleInput.className = 'kanban-edit-title';
        titleInput.value = titleEl.textContent;

        const subtitleInput = document.createElement('input');
        subtitleInput.type = 'text';
        subtitleInput.className = 'kanban-edit-subtitle';
        subtitleInput.value = subtitleEl.textContent;
        
        const controls = document.createElement('div');
        controls.className = 'kanban-edit-controls';
        const saveBtn = document.createElement('button');
        saveBtn.className = 'kanban-edit-btn save';
        saveBtn.textContent = 'Lưu';
        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'kanban-edit-btn cancel';
        cancelBtn.textContent = 'Hủy';
        controls.append(saveBtn, cancelBtn);

        card.prepend(controls);
        card.prepend(subtitleInput);
        card.prepend(titleInput);
        titleInput.focus();

        saveBtn.addEventListener('click', () => saveEdit(card));
        cancelBtn.addEventListener('click', () => exitEditMode(card));
    }

    function saveEdit(card) {
        const titleInput = card.querySelector('.kanban-edit-title');
        const subtitleInput = card.querySelector('.kanban-edit-subtitle');

        if (titleInput && subtitleInput) {
            card.querySelector('.kanban-title').textContent = titleInput.value;
            card.querySelector('.kanban-subtitle').textContent = subtitleInput.value;
        }
        exitEditMode(card);
    }
    
    function exitEditMode(card) {
        card.classList.remove('is-editing');
        card.setAttribute('draggable', 'true');
        card.querySelector('.kanban-edit-title')?.remove();
        card.querySelector('.kanban-edit-subtitle')?.remove();
        card.querySelector('.kanban-edit-controls')?.remove();
    }

    document.addEventListener('click', (e) => {
        const currentlyEditing = document.querySelector('.kanban-card.is-editing');
        if (currentlyEditing && !e.target.closest('.is-editing')) {
            saveEdit(currentlyEditing);
        }
    });

    // --- Initial Load ---
    setWeekFrom(weekPicker.value);
    applyFilter();
    initializeKanbanDragAndDrop();
    initializeKanbanEditing();

    // Print
    document.getElementById('printBtn').addEventListener('click', () => window.print());
});
</script>
</body>
</html>

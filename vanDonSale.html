<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <title>QUẢN LÝ VẬN ĐƠN LumiGlobal (Chế độ chỉ xem)</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    :root {
      --font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      --primary-color: #1D2F5F;
      --primary-color-dark: #16254A;
      --primary-color-light: #E8EAF6;
      --accent-color: #F37021;
      --accent-color-dark: #D85B0A;
      --success-color: #28a745;
      --warning-color: #ffc107;
      --danger-color: #dc3545;
      --text-color: #212529;
      --text-color-muted: #6c757d;
      --bg-body: #f8f9fa;
      --bg-card: #ffffff;
      --border-color: #dee2e6;
      --border-radius: 6px;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --transition-speed: 0.2s;
    }

    html {
      font-size: 16px;
    }

    body {
      font-family: var(--font-family);
      padding: 20px;
      background-color: var(--bg-body);
      color: var(--text-color);
      margin: 0;
      line-height: 1.5;
    }

    .page-header {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 16px;
      margin-bottom: 2rem;
    }

    .header-logo {
      height: 50px;
      width: auto;
      mix-blend-mode: darken;
    }

    h2 {
      margin: 0;
      color: var(--accent-color);
      font-weight: 700;
      text-transform: uppercase;
      font-size: 1.75rem;
    }

    #loader-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.3s ease;
    }

    #loader-overlay img {
      max-width: 200px;
    }

    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--bg-card);
      padding: 1rem 1.5rem;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-md);
      position: sticky;
      top: 0;
      z-index: 100;
      flex-wrap: wrap;
      gap: 1rem;
      border: 1px solid var(--border-color);
      margin-bottom: 1.5rem;
    }

    .controls .left-controls,
    .controls .right-controls {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    button,
    .btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: var(--border-radius);
      font-size: 0.9rem;
      font-weight: 500;
      color: white;
      transition: all var(--transition-speed) ease-in-out;
      cursor: pointer;
      box-shadow: var(--shadow-sm);
    }

    button:hover,
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    button:focus-visible,
    .btn:focus-visible {
      outline: 2px solid var(--primary-color);
      outline-offset: 2px;
    }

    .refresh-btn {
      background-color: var(--success-color);
    }

    .clear-filter-btn {
      background-color: var(--warning-color);
      color: var(--text-color);
    }

    .refresh-btn:hover {
      background-color: #218838;
    }

    .clear-filter-btn:hover {
      background-color: #e0a800;
    }

    input[type="text"],
    input[type="date"],
    input[type="number"],
    select,
    .filter-select {
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      font-size: 0.9rem;
      background-color: var(--bg-card);
      transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(29, 47, 95, 0.25);
    }

    .tab-controls {
      display: flex;
      border-bottom: 2px solid var(--border-color);
      margin-bottom: 1.5rem;
    }

    .tab-btn {
      background-color: transparent;
      border: none;
      border-bottom: 3px solid transparent;
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-color-muted);
      border-radius: 0;
      margin-bottom: -2px;
      box-shadow: none;
    }

    .tab-btn:hover {
      color: var(--accent-color);
      background-color: #fef0e8;
      transform: none;
      box-shadow: none;
    }

    .tab-btn.active {
      color: var(--accent-color);
      background-color: transparent;
      border-color: var(--accent-color);
      box-shadow: none;
    }

    .content-tab {
      display: none;
    }

    .content-tab.active {
      display: block;
    }

    .main-table-wrapper {
      overflow: auto;
      max-height: calc(100vh - 250px);
      background: var(--bg-card);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border-color);
    }

    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 2200px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    th,
    td {
      border: none;
      border-bottom: 1px solid var(--border-color);
      padding: 0.75rem 1rem;
      white-space: nowrap;
      background-color: var(--bg-card);
      text-align: left;
    }

    th {
      background-color: #f8f9fa;
      color: var(--text-color);
      font-weight: 600;
      vertical-align: top;
      position: sticky;
      top: 0;
      z-index: 20;
      border-bottom-width: 2px;
    }
    
    #tableBody tr:hover td,
    #leaderTableBody tr:hover td {
      background-color: var(--primary-color-light) !important;
    }

    th .filter-input,
    th .filter-select {
      width: 100%;
      box-sizing: border-box;
      margin-top: 0.5rem;
      padding: 0.3rem 0.5rem;
      font-size: 0.75rem;
    }

    th .tracking-filter-container {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 0.5rem;
    }

    th .tracking-filter-container input {
      width: 100%;
      box-sizing: border-box;
    }

    .multi-select-container {
      position: relative;
      display: inline-block;
      width: 100%;
      margin-top: 0.5rem;
    }

    .multi-select-container .multi-select-button {
      background-color: var(--bg-card);
      color: var(--text-color);
      border: 1px solid var(--border-color);
      font-size: 0.75rem;
      padding: 0.3rem 0.5rem;
      text-align: left;
      width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      border-radius: var(--border-radius);
      cursor: pointer;
    }

    .multi-select-container .multi-select-button:hover {
      border-color: var(--secondary-color);
    }

    .checkbox-dropdown {
      display: none;
      position: absolute;
      background-color: var(--bg-card);
      min-width: 220px;
      box-shadow: var(--shadow-lg);
      z-index: 101;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      max-height: 250px;
      overflow-y: auto;
      padding: 0.5rem;
      margin-top: 4px;
    }

    .checkbox-dropdown.show {
      display: block;
    }

    .checkbox-dropdown label {
      display: flex;
      align-items: center;
      padding: 0.4rem 0.6rem;
      cursor: pointer;
      border-radius: 4px;
      transition: background-color var(--transition-speed);
      white-space: nowrap;
      font-size: 0.8rem;
      color: var(--text-color);
      font-weight: 400;
    }

    .checkbox-dropdown label:hover {
      background-color: #e9ecef;
    }

    .checkbox-dropdown label input {
      margin-right: 0.5rem;
    }

    .fixed-column {
      position: sticky;
      z-index: 5;
    }

    th.fixed-column {
      z-index: 30;
      background-color: #f1f3f5;
    }

    td.fixed-column {
      background-color: #f8f9fa;
      border-right: 1px solid var(--border-color);
    }
    
    .summary-info {
      background: var(--primary-color-light);
      padding: 0.5rem 1rem;
      border-radius: var(--border-radius);
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--primary-color-dark);
      border: 1px solid #c9d1e9;
    }

    .cell-ok {
      background-color: #d4edda !important;
    }

    .cell-cancel {
      background-color: #f8d7da !important;
    }

    .cell-xl {
      background-color: #fff3cd !important;
    }

    ::-webkit-scrollbar {
      width: 12px;
      height: 12px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    ::-webkit-scrollbar-thumb {
      background-color: var(--primary-color);
      border-radius: 10px;
      border: 3px solid #f1f1f1;
    }

    ::-webkit-scrollbar-thumb:hover {
      background-color: var(--primary-color-dark);
    }
  </style>
</head>

<body>

  <div id="loader-overlay">
    <img
      src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Ff930e667.%E1%BA%A2nh.025539.jpg"
      alt="Loading Logo">
  </div>

  <div class="page-header">
    <img class="header-logo"
      src="https://www.appsheet.com/template/gettablefileurl?appName=Appsheet-325045268&tableName=Kho%20%E1%BA%A3nh&fileName=Kho%20%E1%BA%A3nh_Images%2Ff930e667.%E1%BA%A2nh.025539.jpg"
      alt="LumiGlobal Logo">
    <h2>QUẢN LÝ VẬN ĐƠN LumiGlobal</h2>
  </div>

  <div class="tab-controls">
    <button id="tabData" class="tab-btn active">Dữ liệu đơn hàng</button>
    <button id="tabLeader" class="tab-btn" style="display: none;">Đơn của Leader</button>
  </div>

  <div id="contentData" class="content-tab active">
    <div class="controls">
      <div class="left-controls">
        <span id="userInfo"></span>
        <button id="refreshData" class="refresh-btn"><span class="refresh-icon">↻</span> Load</button>
        <div class="fixed-col-control">
          <span>Cột cố định:</span>
          <input type="number" id="fixedColumnCountInput" value="1" min="0" style="width: 70px;">
        </div>
        <div id="summaryInfo" class="summary-info"></div>
      </div>
      <div class="right-controls">
        <div class="date-filter">
          <span>Từ:</span><input type="date" id="startDateFilter" />
          <span>Đến:</span><input type="date" id="endDateFilter" />
        </div>
        <select id="productFilter" class="filter-select">
          <option value="">Tất cả sản phẩm</option>
        </select>
        <select id="marketFilter" class="filter-select">
          <option value="">Tất cả khu vực</option>
        </select>
        <button id="clearFilters" class="clear-filter-btn">Xóa lọc</button>
      </div>
    </div>
    <div class="main-table-wrapper" id="tableContainer">
      <table>
        <thead id="tableHead"></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>

  <div id="contentLeader" class="content-tab">
    <div class="controls">
      <div class="left-controls">
        <span class="tab-info-text">Đơn hàng do bạn xử lý</span>
        <button id="leaderRefreshData" class="refresh-btn"><span class="refresh-icon">↻</span> Load</button>
        <div id="leaderSummaryInfo" class="summary-info"></div>
      </div>
      <div class="right-controls">
        <div class="date-filter">
          <span>Từ:</span><input type="date" id="leaderStartDateFilter" />
          <span>Đến:</span><input type="date" id="leaderEndDateFilter" />
        </div>
        <select id="leaderProductFilter" class="filter-select">
          <option value="">Sản phẩm</option>
        </select>
        <button id="leaderClearFilters" class="clear-filter-btn">Xóa lọc</button>
      </div>
    </div>
    <div class="main-table-wrapper" id="leaderTableContainer">
      <table>
        <thead id="leaderTableHead"></thead>
        <tbody id="leaderTableBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    // === CẤU HÌNH CỘT ===
    const columnDisplayMapping = {};
    // Danh sách các cột sẽ được hiển thị trên bảng
    const displayColumns = ["Mã đơn hàng", "Kết quả Check", "Trạng thái giao hàng NB", "Mã Tracking", "Lý do", "Trạng thái thu tiền", "Ghi chú của VĐ", "Ngày lên đơn", "Name*", "Phone*", "Add", "City", "State", "khu vực", "Zipcode", "Mặt hàng", "Tên mặt hàng 1", "Số lượng mặt hàng 1", "Tên mặt hàng 2", "Số lượng mặt hàng 2", "Quà tặng", "Số lượng quà kèm", "Giá bán", "Loại tiền thanh toán", "Tổng tiền VNĐ", "Hình thức thanh toán", "Ghi chú", "Ngày đóng hàng", "Trạng thái giao hàng", "Thời gian giao dự kiến", "Phí ship nội địa Mỹ (usd)", "Phí xử lý đơn đóng hàng-Lưu kho(usd)", "GHI CHÚ", "Nhân viên Sale", "NV Vận đơn", "Đơn vị vận chuyển", "Số tiền của đơn hàng đã về TK Cty", "Kế toán xác nhận thu tiền về", "Ngày Kế toán đối soát với FFM lần 2"];
    const allDateColumns = ["Ngày lên đơn", "Ngày đóng hàng"];
    const columnsToMakeDynamic = ["Kết quả Check", "Trạng thái giao hàng NB", "Trạng thái thu tiền", "khu vực", "Mặt hàng", "Nhân viên Sale", "NV Vận đơn", "Đơn vị vận chuyển"];
    
    // Cấu hình các cột có bộ lọc dạng dropdown (thay vì multi-select checkbox)
    const singleSelectFilterCols = [""];
    // Cấu hình các cột có gợi ý khi lọc (datalist)
    const datalistFilterCols = ["Mã đơn hàng", "Name*", "Phone*", "Nhân viên Sale"];
    // === KẾT THÚC CẤU HÌNH ===

    let allData = [],
      allStaffData = [],
      staffFilteredData = [],
      leaderData = [],
      currentStaff = null,
      teamMembers = [],
      dynamicFilterOptions = {},
      leaderDynamicFilterOptions = {},
      datalistOptions = {},
      filterDebounceTimer;

    // Cấu hình cho từng tab
    const mainTabConfig = { data: () => staffFilteredData, controls: { refreshBtn: 'refreshData', clearBtn: 'clearFilters', startDate: 'startDateFilter', endDate: 'endDateFilter', product: 'productFilter', market: 'marketFilter', summary: 'summaryInfo' }, table: { head: 'tableHead', body: 'tableBody' }, dynamicOptions: () => dynamicFilterOptions };
    const leaderTabConfig = { data: () => leaderData, controls: { refreshBtn: 'leaderRefreshData', clearBtn: 'leaderClearFilters', startDate: 'leaderStartDateFilter', endDate: 'leaderEndDateFilter', product: 'leaderProductFilter', summary: 'leaderSummaryInfo' }, table: { head: 'leaderTableHead', body: 'leaderTableBody' }, dynamicOptions: () => leaderDynamicFilterOptions };
    
    const allTabConfigs = [mainTabConfig, leaderTabConfig];

    // --- CÁC HÀM TIỆN ÍCH ---
    function getFixedColumnCount() { const e = document.getElementById("fixedColumnCountInput"), t = parseInt(e.value, 10); return isNaN(t) || t < 0 ? 0 : t }
    function handleFixedColumnCountChange() { const newCount = getFixedColumnCount(); const activeTab = document.querySelector(".content-tab.active"); if (!activeTab) return; const activeConfig = allTabConfigs.find(c => c.table.body === activeTab.querySelector("tbody")?.id); if (!activeConfig) return; const tableHead = document.getElementById(activeConfig.table.head); const tableBody = document.getElementById(activeConfig.table.body); if (!tableHead || !tableBody) return; const allRows = [...tableHead.querySelectorAll("tr"), ...tableBody.querySelectorAll("tr")]; allRows.forEach(row => { for (let i = 0; i < row.cells.length; i++) { const cell = row.cells[i]; if (i < newCount) { cell.classList.add("fixed-column") } else { cell.classList.remove("fixed-column"); cell.style.left = "" } } }); updateStickyColumns(activeConfig) }
    function updateStickyColumns(config) { const fixedCount = getFixedColumnCount(); const tableHead = document.getElementById(config.table.head); const tableBody = document.getElementById(config.table.body);[...tableHead.querySelectorAll(".fixed-column"), ...tableBody.querySelectorAll(".fixed-column")].forEach(c => c.style.left = ""); if (fixedCount <= 0) return; const headerRow = tableHead.querySelector("tr"); if (!headerRow) return; let leftOffset = 0; for (let i = 0; i < fixedCount; i++) { const th = headerRow.cells[i]; if (!th) continue; th.style.left = leftOffset + "px"; const rows = tableBody.querySelectorAll("tr"); rows.forEach(row => { if (row.cells[i]) { row.cells[i].style.left = leftOffset + "px" } }); leftOffset += th.offsetWidth } }
    function getUrlParameter(name) { name = name.replace(/[\[\]]/g, "\\$&"); const regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"), results = regex.exec(window.location.href); if (!results) return null; if (!results[2]) return ""; return decodeURIComponent(results[2].replace(/\+/g, " ")) }
    function parseDateString(dateString) { if (!dateString || typeof dateString !== "string") return null; const cleanedDateString = dateString.trim().replace(/[^\d\/\-\s]/g, ""); if (/^\d{4}-\d{2}-\d{2}/.test(cleanedDateString)) { const d = new Date(cleanedDateString); if (!isNaN(d.getTime())) return d } const parts = cleanedDateString.match(/^(\d{1,2})[/\-](\d{1,2})[/\-](\d{4})/); if (parts) { const month = parseInt(parts[1], 10), day = parseInt(parts[2], 10), year = parseInt(parts[3], 10); if (year > 1e3 && month > 0 && month <= 12 && day > 0 && day <= 31) { const d = new Date(Date.UTC(year, month - 1, day)); if (d.getUTCFullYear() === year && d.getUTCMonth() === month - 1) return d } } return null }
    function formatDate(dateString) { const originalValue = typeof dateString === "string" ? dateString.trim() : ""; if (!originalValue) return { display: "", original: "" }; const dateObj = parseDateString(originalValue); if (dateObj) { const day = String(dateObj.getUTCDate()).padStart(2, "0"), month = String(dateObj.getUTCMonth() + 1).padStart(2, "0"), year = dateObj.getUTCFullYear(); return { display: `${day}/${month}/${year}`, original: originalValue } } return { display: originalValue, original: originalValue } }
    
    // --- LẤY DỮ LIỆU NHÂN VIÊN ---
    async function fetchAllStaffData() {
      if (allStaffData.length > 0) return allStaffData;
      try {
        const staffApiUrl = `https://n-api-rouge.vercel.app/sheet/getSheets?rangeSheet=A:K&sheetName=Nh%C3%A2n%20s%E1%BB%B1&spreadsheetId=1Cl-56By1eYFB4G7ITuG0IQhH39ITwo0AkZPFvsLfo54`;
        const response = await fetch(staffApiUrl, { cache: "no-store" });
        if (!response.ok) throw new Error("Lỗi mạng khi tải data nhân viên");
        const results = await response.json();
        allStaffData = results?.rows?.map(item => ({
          idnv: item['id'], ho_va_ten: item['Họ Và Tên'], bo_phan: item['Bộ phận'], vi_tri: item['Vị trí'], email: item['email'], sdt: item['SĐT'], team: item['Team'], chi_nhanh: item['chi nhánh'], ca: item['Ca'], vi_tri_van_don: item['Vị trí vận đơn'], link_van_don: item['link vận đơn']
        })) || [];
        return allStaffData;
      } catch (error) {
        showError(error.message);
        throw error;
      }
    }

    async function fetchStaffInfo(idns) {
      const data = await fetchAllStaffData();
      let staffMember = data.find(staff => String(staff.idnv) === idns);
      if (!staffMember) throw new Error(`Không tìm thấy nhân viên với ID: ${idns}`);

      const memberNames = new Set();
      if (staffMember) {
        if (staffMember.ho_va_ten) memberNames.add(staffMember.ho_va_ten);
        if (staffMember.vi_tri === "Leader" && staffMember.team) {
          const teamName = staffMember.team;
          data.forEach(member => {
            if (member.team === teamName && member.ho_va_ten) memberNames.add(member.ho_va_ten);
          });
        }
      }
      teamMembers = Array.from(memberNames);
      return staffMember;
    }

    // --- HIỂN THỊ VÀ CẬP NHẬT GIAO DIỆN ---
    function showError(message, containerId = "tableBody") { const container = document.getElementById(containerId), colCount = displayColumns.length; container.innerHTML = `<tr><td colspan="${colCount}" class="no-data" style="text-align: center;">${message}</td></tr>` }
    function updateSummaryInfo(config) { const tableBody = document.getElementById(config.table.body); const summaryElement = document.getElementById(config.controls.summary); const originalData = config.data(); let visibleCount = 0; let totalAmount = 0; tableBody.querySelectorAll('tr').forEach(tr => { if (tr.style.display !== 'none') { visibleCount++; const rowIndex = parseInt(tr.dataset.rowIndex, 10); if (!isNaN(rowIndex) && originalData[rowIndex]) { const row = originalData[rowIndex]; let amountValue = row["Tổng tiền VNĐ"] || row.Tổng_tiền_VNĐ || 0; const numericValue = parseFloat(String(amountValue).replace(/[^\d.-]/g, "")) || 0; totalAmount += numericValue; } } }); const formattedAmount = new Intl.NumberFormat("vi-VN", { style: "currency", currency: "VND" }).format(totalAmount); summaryElement.innerHTML = `Tổng đơn: <b>${visibleCount}</b> | Tổng tiền: <b style="color:var(--success-color)">${formattedAmount}</b>`; }
    function showTempMessage(e, t = !1) { document.querySelector(".temp-message")?.remove(); const n = document.createElement("div"); n.textContent = e, Object.assign(n.style, { position: "fixed", bottom: "20px", right: "20px", backgroundColor: t ? "rgba(220, 53, 69, 0.9)" : "rgba(40, 167, 69, 0.9)", color: "white", padding: "12px 20px", borderRadius: "5px", zIndex: "2000", transition: "opacity 0.5s", opacity: "1", boxShadow: "0 4px 10px rgba(0,0,0,0.2)" }), document.body.appendChild(n), setTimeout(() => { n.style.opacity = "0", setTimeout(() => n.remove(), 500) }, 3e3) }

    // --- XỬ LÝ DỮ LIỆU CHÍNH ---
    async function handleData(response) {
      document.getElementById('loader-overlay').style.display = 'none';
      allTabConfigs.forEach(config => { document.getElementById(config.controls.refreshBtn).innerHTML = '<span class="refresh-icon">↻</span> Load' });
      allData = [], staffFilteredData = [], leaderData = [];

      if (response.error || !Array.isArray(response.rows)) {
        const errorMsg = 'Lỗi hoặc không có dữ liệu: ' + (response.error || 'Định dạng dữ liệu không đúng');
        allTabConfigs.forEach(config => showError(errorMsg, config.table.body));
        return;
      }
      allData = response.rows.sort((a, b) => (parseDateString(b["Ngày lên đơn"] || b["Thời gian lên đơn"]) || 0) - (parseDateString(a["Ngày lên đơn"] || a["Thời gian lên đơn"]) || 0));
      generateDatalistOptions();
      const staffId = getUrlParameter('id');

      if (!staffId) {
        showError('Thiếu tham số ID nhân viên trong URL', mainTabConfig.table.body);
      } else {
        try {
          currentStaff = await fetchStaffInfo(staffId);
          let staffInfo = `Nhân viên: ${currentStaff.ho_va_ten}`;
          if (currentStaff.vi_tri === "Leader") staffInfo += ` (Leader - Team ${currentStaff.team})`;
          document.getElementById('userInfo').textContent = staffInfo;
          
          if (currentStaff?.vi_tri === "Leader") {
            document.getElementById('tabLeader').style.display = '';
            leaderData = allData.filter(row => (row["Nhân viên Sale"] || row["NV_Vận_đơn"]) === currentStaff.ho_va_ten);
            initializeTab(leaderTabConfig, leaderData);
          }
          
          if (currentStaff?.vi_tri == 'Leader') {
            staffFilteredData = allData.filter(row => {
              const isTeamMemberOrder = teamMembers.includes(row["Nhân viên Sale"] || row["NV_Vận_đơn"] || '');
              return isTeamMemberOrder && row["Nhân viên Sale"] !== currentStaff.ho_va_ten;
            });
          } else {
            staffFilteredData = allData.filter(row => {
              return row["Nhân viên Sale"] === currentStaff.ho_va_ten
            });
          }

          initializeTab(mainTabConfig, staffFilteredData);
        } catch (error) {
          showError(error.message, mainTabConfig.table.body);
        }
      }
    }

    function initializeTab(config, data) { generateDynamicOptions(config, data); populateExternalFilters(config); renderHeader(config); renderTableBody(config, data); applyAllFilters(config); }
    
    // --- BỘ LỌC ---
    function generateDynamicOptions(config, data) { const options = {}; columnsToMakeDynamic.forEach(colName => { const dataKey = columnDisplayMapping[colName] || colName; const valueMapper = row => { const val = row[dataKey] || row[dataKey.replace(/ /g, '_')] || (dataKey === 'khu vực' ? row['Khu vực'] || '' : ''); return typeof val === 'string' ? val.trim() : val; }; const uniqueValues = new Set(data.map(valueMapper).filter(Boolean)); options[colName] = Array.from(uniqueValues).sort((a, b) => String(a).localeCompare(String(b), 'vi')); }); if (config === mainTabConfig) dynamicFilterOptions = options; else if (config === leaderTabConfig) leaderDynamicFilterOptions = options; }
    function populateExternalFilters(config) { const options = config.dynamicOptions(); const productFilter = document.getElementById(config.controls.product); productFilter.innerHTML = '<option value="">Tất cả sản phẩm</option>'; (options['Mặt hàng'] || []).forEach(opt => productFilter.add(new Option(opt, opt))); if (config.controls.market) { const marketFilter = document.getElementById(config.controls.market); marketFilter.innerHTML = '<option value="">Tất cả khu vực</option>'; (options['khu vực'] || []).forEach(opt => marketFilter.add(new Option(opt, opt))) } if (config.controls.staff) { const staffFilter = document.getElementById(config.controls.staff); staffFilter.innerHTML = '<option value="">Tất cả NV Vận đơn</option>'; (options['NV Vận đơn'] || []).forEach(opt => staffFilter.add(new Option(opt, opt))) } }
    function generateDatalistOptions() { datalistOptions = {}; datalistFilterCols.forEach(colName => { const dataKey = columnDisplayMapping[colName] || colName; const uniqueValues = new Set(allData.map(row => row[dataKey] || row[dataKey.replace(/ /g, '_')]).filter(Boolean)); datalistOptions[colName] = Array.from(uniqueValues) }) }
   function parseDateStringFilter(dateString) {
      const parts = dateString.split('/');
      // Lưu ý: tháng trong JavaScript bắt đầu từ 0 (0 là tháng 1, 1 là tháng 2,...)
      // Vì vậy, chúng ta cần trừ đi 1 từ giá trị tháng.
      const day = parseInt(parts[0], 10);
      const month = parseInt(parts[1], 10) - 1;
      const year = parseInt(parts[2], 10);
      return new Date(year, month, day);
    }
    function applyAllFilters(config) {
      const tableHead = document.getElementById(config.table.head);
      const tableBody = document.getElementById(config.table.body);
      if (!tableHead.querySelector('tr') || !tableBody) return;
      const startDateVal = document.getElementById(config.controls.startDate).value;
      const endDateVal = document.getElementById(config.controls.endDate).value;
      const start = startDateVal ? new Date(startDateVal) : null;
      const end = endDateVal ? new Date(endDateVal) : null;
      if (start) start.setHours(0, 0, 0, 0);
      if (end) end.setHours(23, 59, 59, 999);
      const productValue = document.getElementById(config.controls.product).value;
      const marketValue = config.controls.market ? document.getElementById(config.controls.market).value : '';
      const staffValue = config.controls.staff ? document.getElementById(config.controls.staff).value : '';
      const filterValues = {};
      tableHead.querySelectorAll('[data-column]').forEach(filter => {
        const colName = filter.dataset.column;
        if (!filterValues[colName]) filterValues[colName] = {};
        if (filter.dataset.filterType) {
          filterValues[colName][filter.dataset.filterType] = filter.value.toLowerCase();
        } else if (filter.classList.contains('multi-select-container')) {
          const selected = Array.from(filter.querySelectorAll('input:checked:not(.select-all-cb)')).map(cb => cb.value);
          if (selected.length > 0) filterValues[colName].multi = new Set(selected);
        } else if (filter.tagName === 'SELECT') {
          if (filter.value) filterValues[colName].single = filter.value;
        } else if (filter.classList.contains('filter-input')) {
          filterValues[colName].text = filter.value.toLowerCase();
        }
      });
      const originalData = config.data();
      const rows = tableBody.querySelectorAll('tr');
      rows.forEach(tr => {
        const rowIndex = parseInt(tr.dataset.rowIndex, 10);
        if (isNaN(rowIndex)) return;
        const rowData = originalData[rowIndex];
        if (!rowData) return;
        let isVisible = true;
        if (start || end) {
          const orderDate = parseDateStringFilter(rowData["Ngày lên đơn"] || rowData["Thời gian lên đơn"]);
          if (!orderDate || (start && orderDate < start) || (end && orderDate > end)) {
            isVisible = false;
          }
        }
        if (isVisible && productValue && (rowData["Mặt hàng"] || '') !== productValue) isVisible = false;
        if (isVisible && marketValue && (rowData["Khu vực"] || rowData["khu vực"] || '') !== marketValue) isVisible = false;
        if (isVisible && staffValue && (rowData["NV Vận đơn"] || rowData["NV_Vận_đơn"] || '') !== staffValue) isVisible = false;
        if (isVisible) {
          for (const colName in filterValues) {
            const dataKey = columnDisplayMapping[colName] || colName;
            let cellValue = rowData[dataKey] ?? (rowData[dataKey.replace(/ /g, '_')] || (dataKey === 'khu vực' ? (rowData['Khu vực'] || '') : ''));
            const cellValueLower = String(cellValue).toLowerCase();
            const colFilters = filterValues[colName];
            if (colFilters.text && !cellValueLower.includes(colFilters.text)) {
              isVisible = false;
              break;
            }
            if (colFilters.single && String(cellValue) !== colFilters.single) {
              isVisible = false;
              break;
            }
            if (colFilters.multi) {
              const valueAsString = String(cellValue).trim();
              const isBlank = !valueAsString;
              const isMatch = (colFilters.multi.has('') && isBlank) || colFilters.multi.has(valueAsString);
              if (!isMatch) {
                isVisible = false;
                break;
              }
            }
            if (colFilters.contains && !cellValueLower.includes(colFilters.contains)) {
              isVisible = false;
              break;
            }
            if (colFilters.notcontains && colFilters.notcontains !== '' && cellValueLower.includes(colFilters.notcontains)) {
              isVisible = false;
              break;
            }
          }
        }
        tr.style.display = isVisible ? '' : 'none';
      });
      updateSummaryInfo(config);
    }
    
    // --- VẼ BẢNG ---
    function renderHeader(config) { const header = document.getElementById(config.table.head); const options = config.dynamicOptions(); header.innerHTML = ''; const tr = document.createElement('tr'); const fixedCount = getFixedColumnCount(); const debouncedFilter = () => { clearTimeout(filterDebounceTimer); filterDebounceTimer = setTimeout(() => applyAllFilters(config), 300) }; const immediateFilter = () => applyAllFilters(config); displayColumns.forEach((colName, index) => { const th = document.createElement('th'); th.textContent = colName; if (index < fixedCount) th.classList.add('fixed-column'); th.appendChild(document.createElement('br')); if (colName === "Mã Tracking") { const container = document.createElement('div'); container.className = 'tracking-filter-container'; const inputContains = document.createElement('input'); inputContains.type = 'text'; inputContains.placeholder = 'Chứa ký tự...'; inputContains.className = 'filter-input'; inputContains.dataset.column = colName; inputContains.dataset.filterType = 'contains'; inputContains.addEventListener('input', debouncedFilter); const inputNotContains = document.createElement('input'); inputNotContains.type = 'text'; inputNotContains.placeholder = 'Không chứa...'; inputNotContains.className = 'filter-input'; inputNotContains.dataset.column = colName; inputNotContains.dataset.filterType = 'notcontains'; inputNotContains.addEventListener('input', debouncedFilter); container.append(inputContains, inputNotContains); th.appendChild(container) } else if (singleSelectFilterCols.includes(colName) && options[colName]) { const filterElement = document.createElement('select'); filterElement.className = 'filter-select'; filterElement.dataset.column = colName; filterElement.add(new Option(`Tất cả ${colName}`, '')); options[colName].forEach(opt => filterElement.add(new Option(opt, opt))); filterElement.addEventListener('change', immediateFilter); th.appendChild(filterElement) } else if (options[colName]) { const container = document.createElement('div'); container.className = 'multi-select-container'; container.dataset.column = colName; const button = document.createElement('button'); button.className = 'multi-select-button'; button.textContent = `Tất cả ${colName}`; const dropdown = document.createElement('div'); dropdown.className = 'checkbox-dropdown'; const selectAllLabel = document.createElement('label'); const selectAllCheckbox = document.createElement('input'); selectAllCheckbox.type = 'checkbox'; selectAllCheckbox.className = 'select-all-cb'; selectAllLabel.style.fontWeight = 'bold'; selectAllLabel.style.borderBottom = '1px solid #ccc'; selectAllLabel.style.marginBottom = '4px'; selectAllLabel.append(selectAllCheckbox, ' (Tất cả)'); dropdown.appendChild(selectAllLabel); const createCheckbox = (value, text) => { const label = document.createElement('label'); const checkbox = document.createElement('input'); checkbox.type = 'checkbox'; checkbox.value = value; checkbox.addEventListener('change', () => { const allOptionCheckboxes = Array.from(dropdown.querySelectorAll('input[type="checkbox"]:not(.select-all-cb)')); selectAllCheckbox.checked = allOptionCheckboxes.every(cb => cb.checked); const selectedCount = dropdown.querySelectorAll('input:checked:not(.select-all-cb)').length; button.textContent = selectedCount === 0 ? `Tất cả ${colName}` : `${selectedCount} lựa chọn`; immediateFilter(); }); label.append(checkbox, ` ${text}`); return label; }; dropdown.appendChild(createCheckbox('', '(Trống)')); options[colName].forEach(opt => dropdown.appendChild(createCheckbox(opt, opt))); selectAllCheckbox.addEventListener('change', (e) => { dropdown.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = e.target.checked); const selectedCount = e.target.checked ? dropdown.querySelectorAll('input:checked:not(.select-all-cb)').length : 0; button.textContent = selectedCount === 0 ? `Tất cả ${colName}` : `${selectedCount} lựa chọn`; immediateFilter(); }); button.addEventListener('click', e => { e.stopPropagation(); document.querySelectorAll('.checkbox-dropdown.show').forEach(d => { if (d !== dropdown) d.classList.remove('show') }); dropdown.classList.toggle('show') }); container.append(button, dropdown); th.appendChild(container) } else if (datalistFilterCols.includes(colName)) { const input = document.createElement('input'); input.type = 'text'; input.className = 'filter-input'; input.placeholder = `Lọc ${colName}...`; input.dataset.column = colName; const datalistId = `datalist-${colName.replace(/[^a-zA-Z0-9]/g, '-')}`; input.setAttribute('list', datalistId); const datalist = document.createElement('datalist'); datalist.id = datalistId; if (datalistOptions[colName]) { datalistOptions[colName].forEach(opt => { const option = document.createElement('option'); option.value = opt; datalist.appendChild(option) }) } input.addEventListener('input', debouncedFilter); th.append(input, datalist) } else { const filterElement = document.createElement('input'); filterElement.type = 'text'; filterElement.className = 'filter-input'; filterElement.placeholder = `Lọc ${colName}...`; filterElement.dataset.column = colName; filterElement.addEventListener('input', debouncedFilter); th.appendChild(filterElement) } tr.appendChild(th) }); header.appendChild(tr); window.addEventListener('click', e => { if (!e.target.closest('.multi-select-container')) { document.querySelectorAll('.checkbox-dropdown.show').forEach(d => d.classList.remove('show')) } }) }
    function renderTableBody(config, data) {
      const container = document.getElementById(config.table.body);
      container.innerHTML = '';
      if (data.length === 0) {
        showError(`Không có đơn hàng nào.`, config.table.body);
        return;
      }
      const fixedCount = getFixedColumnCount();
      data.forEach((row, originalRowIndex) => {
        const tr = document.createElement('tr');
        tr.dataset.rowIndex = originalRowIndex;
        displayColumns.forEach((col, index) => {
          const td = document.createElement('td');
          if (index < fixedCount) td.classList.add('fixed-column');
          const dataKey = columnDisplayMapping[col] || col;
          let value;
          if (allDateColumns.includes(dataKey)) {
            let dateSource = row[dataKey] || '';
            if (dataKey === "Ngày lên đơn") dateSource = row["Ngày lên đơn"] || row["Thời gian lên đơn"];
            const formattedDate = formatDate(dateSource);
            value = formattedDate.display;
            td.dataset.originalValue = formattedDate.original;
          } else {
            value = row[dataKey] ?? (row[dataKey.replace(/ /g, '_')] || (dataKey === 'khu vực' ? (row['Khu vực'] || '') : ''));
          }

          td.textContent = value;
          
          if (col === "Kết quả Check") {
            if (value === 'OK') td.classList.add('cell-ok');
            else if (value === 'Vận đơn XL') td.classList.add('cell-xl');
            else if (value === 'Huỷ') td.classList.add('cell-cancel');
          }
          tr.appendChild(td);
        });
        container.appendChild(tr);
      });
      updateStickyColumns(config);
    }
    
    // --- KHỞI TẠO VÀ GẮN SỰ KIỆN ---
    function setupControls() {
      setupTabs();
      allTabConfigs.forEach(setupTabControls);
      document.getElementById('fixedColumnCountInput').addEventListener('input', handleFixedColumnCountChange);
      window.addEventListener('resize', () => {
        const activeTab = document.querySelector('.content-tab.active'); if (!activeTab) return;
        const activeConfig = allTabConfigs.find(c => c.table.body === activeTab.querySelector('tbody')?.id);
        if (activeConfig) updateStickyColumns(activeConfig)
      });
    }
    function setupTabControls(config) { document.getElementById(config.controls.refreshBtn).addEventListener('click', refreshData); const filterFunction = () => applyAllFilters(config); document.getElementById(config.controls.startDate).addEventListener('change', filterFunction); document.getElementById(config.controls.endDate).addEventListener('change', filterFunction); document.getElementById(config.controls.product).addEventListener('change', filterFunction); if (config.controls.market) document.getElementById(config.controls.market).addEventListener('change', filterFunction); if (config.controls.staff) document.getElementById(config.controls.staff).addEventListener('change', filterFunction); document.getElementById(config.controls.clearBtn).addEventListener('click', () => { document.getElementById(config.controls.startDate).value = ''; document.getElementById(config.controls.endDate).value = ''; document.getElementById(config.controls.product).selectedIndex = 0; if (config.controls.market) document.getElementById(config.controls.market).selectedIndex = 0; if (config.controls.staff) document.getElementById(config.controls.staff).selectedIndex = 0; const header = document.getElementById(config.table.head); header.querySelectorAll('.filter-input').forEach(f => f.value = ''); header.querySelectorAll('.filter-select').forEach(f => f.selectedIndex = 0); header.querySelectorAll('.multi-select-container').forEach(container => { container.querySelectorAll('input:checked').forEach(cb => cb.checked = !1); container.querySelector('.multi-select-button').textContent = `Tất cả ${container.dataset.column}` }); applyAllFilters(config) }) }
    function setupTabs() { const tabs = document.querySelectorAll('.tab-btn'), contents = document.querySelectorAll('.content-tab'); tabs.forEach(tab => { tab.addEventListener('click', () => { tabs.forEach(item => item.classList.remove('active')); contents.forEach(content => content.classList.remove('active')); tab.classList.add('active'); const contentId = 'content' + tab.id.substring(3); document.getElementById(contentId).classList.add('active'); setTimeout(() => { handleFixedColumnCountChange(); }, 10) }) }) }

    function refreshData() { loadData() }

    async function loadData() {
      const { email, tuNgay, denNgay, tableName } = Object.fromEntries(new URLSearchParams(window.location.search));
      document.getElementById('loader-overlay').style.display = 'flex';
      allTabConfigs.forEach(config => showError('Đang tải dữ liệu...', config.table.body));
      try {
        await fetchAllStaffData();
        const url = `https://n-api-rouge.vercel.app/sheet/getAll?email=${email}&${tuNgay ? `tuNgay=${tuNgay}&` : ''}${denNgay ? `denNgay=${denNgay}&` : ''}${tableName ? `tableName=${tableName}` : ''}`;
        const response = await fetch(url);
        const data = await response.json();
        handleData(data);
      } catch (error)
      {
        console.error('Error loading data:', error);
        document.getElementById('loader-overlay').style.display = 'none';
        allTabConfigs.forEach(config => showError('Lỗi khi tải dữ liệu: ' + error.message, config.table.body));
      }
    }

    document.addEventListener('DOMContentLoaded', () => { setupControls(); loadData() });
  </script>
</body>

</html>

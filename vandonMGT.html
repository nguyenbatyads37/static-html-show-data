<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Quản lý đơn hàng MGT</title>
  <style>
    :root {
      --filter-row-height: 38px;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      background-color: #f5f5f5;
      color: #333;
      margin: 0;
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #2c3e50;
    }
    .tab-container {
      margin-bottom: 15px;
      padding: 5px;
      background: #fff;
      border-radius: 5px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .tab-btn {
      padding: 8px 15px;
      cursor: pointer;
      background-color: #ecf0f1;
      color: #2c3e50;
      border: 1px solid #bdc3c7;
      border-radius: 4px;
      font-size: 14px;
      transition: all 0.3s;
    }
    .tab-btn:hover {
      background-color: #dfe6e9;
    }
    .tab-btn.active {
      background-color: #3498db;
      color: white;
      border-color: #2980b9;
      font-weight: bold;
    }
    .controls {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      align-items: center;
      background: #fff;
      padding: 10px 15px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .table-wrapper {
      position: relative;
      overflow: auto;
      max-height: 70vh;
      background: white;
      border-radius: 0 0 5px 5px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 1600px;
      font-size: 14px;
    }
    thead {
      position: sticky;
      top: 0;
      z-index: 10;
    }
    th, td {
      border: 1px solid #e0e0e0;
      padding: 8px 12px;
      text-align: left;
      white-space: nowrap;
      background-color: white;
    }
    th {
      background-color: #3498db;
      color: white;
      position: sticky;
      top: var(--filter-row-height);
      z-index: 20;
      font-weight: 500;
    }
    #filterRow th {
        top: 0;
        background-color: #f2f6fa;
        padding: 4px 8px;
    }
    .filter-input {
      width: 100%;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 3px;
      font-size: 13px;
    }
    td.editable {
      background-color: #fffbe8;
    }
    button {
      padding: 6px 12px;
      cursor: pointer;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 13px;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #2980b9;
    }
    .status {
      font-size: 0.85em;
      margin-left: 8px;
      color: #27ae60;
    }
    .error-status {
      color: #e74c3c;
    }
    .highlight {
      background-color: #ffeb3b !important;
    }
    .no-data {
      text-align: center;
      padding: 20px;
      color: #7f8c8d;
      font-style: italic;
    }
    .refresh-btn {
      background-color: #2ecc71;
    }
    .refresh-btn:hover {
      background-color: #27ae60;
    }
    .refresh-icon {
      margin-right: 5px;
    }
    .fixed-column {
      position: sticky;
      left: 0;
      z-index: 5;
      background-color: white;
    }
    th.fixed-column {
      z-index: 30;
      background-color: #3498db;
    }
    #filterRow th.fixed-column {
        z-index: 40;
        background-color: #f2f6fa;
    }
    .date-input {
      border: none;
      background: transparent;
      width: 100%;
      font-family: inherit;
      font-size: inherit;
      color: inherit;
    }
  </style>
</head>
<body>
  <h2>QUẢN LÝ ĐƠN HÀNG MGT</h2>

  <div id="tabContainer" class="tab-container"></div>
  
  <div class="controls">
    <div>
      <button id="refreshData" class="refresh-btn">
        <span class="refresh-icon">↻</span> Load dữ liệu
      </button>
      <button id="updateAll">Cập nhật tất cả thay đổi</button>
    </div>
  </div>
  
  <div class="table-wrapper" id="tableContainer">
    <table>
      <thead>
        <tr id="filterRow"></tr>
        <tr>
          <th class="fixed-column">Mã đơn hàng</th>
          <th>Ngày lên đơn</th>
          <th>Name*</th>
          <th>Phone*</th>
          <th>Add</th>
          <th>City</th>
          <th>State</th>
          <th>Khu vực</th>
          <th>Zipcode</th>
          <th>Mặt hàng</th>
          <th>Tên mặt hàng 1</th>
          <th>Số lượng mặt hàng 1</th>
          <th>Tên mặt hàng 2</th>
          <th>Số lượng mặt hàng 2</th>
          <th>Quà tặng</th>
          <th>Số lượng quà kèm</th>
          <th>Giá bán</th>
          <th>Loại tiền thanh toán</th>
          <th>Tổng tiền VNĐ</th>
          <th>Hình thức thanh toán</th>
          <th>Ghi chú</th>
          <th>Mã Tracking</th>
          <th>Ngày đóng hàng</th>
          <th>Trạng thái giao hàng</th>
          <th>Thời gian giao dự kiến</th>
          <th>Phí ship nội địa Mỹ (usd)</th>
          <th>Phí xử lý đơn đóng hàng-Lưu kho(usd)</th>
          <th>GHI CHÚ</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <script>
    const POST_URL = 'https://script.google.com/macros/s/AKfycbx2sX3QXh2ltziVv2jXwjN4VnQxBGhLNALK2QjT6PSuq7RSuwzWa2MuHsbOe6dd9DnW/exec';
    
    const displayColumns = [
      "Mã đơn hàng", "Ngày lên đơn", "Name*", "Phone*", "Add", "City", "State", "Khu vực", "Zipcode", 
      "Mặt hàng", "Tên mặt hàng 1", "Số lượng mặt hàng 1", "Tên mặt hàng 2", "Số lượng mặt hàng 2", 
      "Quà tặng", "Số lượng quà kèm", "Giá bán", "Loại tiền thanh toán", "Tổng tiền VNĐ", 
      "Hình thức thanh toán", "Ghi chú", "Mã Tracking", "Ngày đóng hàng", "Trạng thái giao hàng", 
      "Thời gian giao dự kiến", "Phí ship nội địa Mỹ (usd)", "Phí xử lý đơn đóng hàng-Lưu kho(usd)", "GHI CHÚ"
    ];
    
    const editableCols = [
      "Mã Tracking", "Ngày đóng hàng", "Trạng thái giao hàng", 
      "Thời gian giao dự kiến", "Phí ship nội địa Mỹ (usd)", 
      "Phí xử lý đơn đóng hàng-Lưu kho(usd)", "GHI CHÚ"
    ];
    
    let allData = [];
    let initialFilteredData = []; 
    let filteredData = []; 
    let changedRows = new Set();
    let activeRegion = 'all';
    let filterValues = {}; 

    function formatDate(dateString) {
      if (!dateString) return '';
      try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return dateString;
        const day = String(date.getUTCDate()).padStart(2, '0');
        const month = String(date.getUTCMonth() + 1).padStart(2, '0');
        const year = date.getUTCFullYear();
        return `${day}/${month}/${year}`;
      } catch (e) {
        return dateString;
      }
    }

    function parseDateToISO(dateString) {
      if (!dateString) return '';
      const parts = dateString.split('/');
      if (parts.length !== 3) return dateString; 
      try {
        const day = parseInt(parts[0], 10);
        const month = parseInt(parts[1], 10) - 1;
        const year = parseInt(parts[2], 10);
        const date = new Date(Date.UTC(year, month, day));
        if (isNaN(date.getTime())) return dateString;
        return date.toISOString();
      } catch (e) {
        return dateString;
      }
    }

    function handleData(response) {
      document.getElementById('refreshData').innerHTML = '<span class="refresh-icon">↻</span> Load dữ liệu';
      allData = [];
      changedRows = new Set();
      
      if (response.error) {
        document.getElementById('tableBody').innerHTML = `<tr><td colspan="${displayColumns.length}" class="error-status">Lỗi: ${response.error}</td></tr>`;
        return;
      }
      
      const data = response.rows || response.data || response;
      if (!Array.isArray(data) || data.length === 0) {
        document.getElementById('tableBody').innerHTML = `<tr><td colspan="${displayColumns.length}" class="no-data">Không có dữ liệu đơn hàng nào</td></tr>`;
        return;
      }
      
      allData = data;
      filterInitialData();
      createTabs(initialFilteredData);
      setupColumnFilters();
      applyAllFilters();
    }
    
    function filterInitialData() {
        initialFilteredData = allData.filter(row => {
            const carrier = row["Đơn vị vận chuyển"] || row["Đơn_vị_vận_chuyển"];
            const trackingCode = row["Mã Tracking"] || row["Mã_Tracking"] || '';
            return carrier && carrier.toString().toUpperCase() === "MGT" && (!trackingCode || trackingCode.toString().trim() === '');
        });
    }

    function createTabs(data) {
        const tabContainer = document.getElementById('tabContainer');
        tabContainer.innerHTML = '';
        
        const regions = [...new Set(data.map(row => row["Khu vực"]).filter(Boolean))].sort();

        const createTab = (name, value) => {
            const button = document.createElement('button');
            button.className = 'tab-btn';
            button.textContent = name;
            button.dataset.region = value;
            if (value === activeRegion) {
                button.classList.add('active');
            }
            button.addEventListener('click', () => {
                activeRegion = value;
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                applyAllFilters();
            });
            return button;
        };

        tabContainer.appendChild(createTab('Tất cả', 'all'));
        regions.forEach(region => tabContainer.appendChild(createTab(region, region)));
    }
    
    function setupColumnFilters() {
        const filterRow = document.getElementById('filterRow');
        filterRow.innerHTML = '';
        filterValues = {};

        displayColumns.forEach((col, index) => {
            const th = document.createElement('th');
            if (index === 0) th.classList.add('fixed-column');
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'filter-input';
            input.placeholder = `Lọc ${col}`;
            input.dataset.column = col;
            
            input.addEventListener('input', () => {
                filterValues[col] = input.value;
                applyAllFilters();
            });

            th.appendChild(input);
            filterRow.appendChild(th);
        });
    }

    function applyAllFilters() {
        let dataToRender = [...initialFilteredData];

        if (activeRegion !== 'all') {
            dataToRender = dataToRender.filter(row => row["Khu vực"] === activeRegion);
        }

        const activeFilters = Object.entries(filterValues).filter(([col, val]) => val.trim() !== '');
        
        if (activeFilters.length > 0) {
            dataToRender = dataToRender.filter(row => {
                return activeFilters.every(([col, filterValue]) => {
                    const cellValue = row[col] !== undefined ? row[col] :
                                      row[col.replace(/ /g, '_')] !== undefined ? row[col.replace(/ /g, '_')] : '';
                    return String(cellValue).toLowerCase().includes(filterValue.toLowerCase());
                });
            });
        }
        
        filteredData = dataToRender;
        renderTable(filteredData);
    }

    function renderTable(data) {
      const container = document.getElementById('tableBody');
      container.innerHTML = '';

      if (data.length === 0) {
        container.innerHTML = `<tr><td colspan="${displayColumns.length}" class="no-data">Không có dữ liệu phù hợp với bộ lọc</td></tr>`;
        return;
      }

      data.forEach((row, rowIndex) => {
        const tr = document.createElement('tr');
        
        displayColumns.forEach(col => {
          const td = document.createElement('td');
          const colKey = col.replace(/ /g, '_');
          let value = row[col] !== undefined ? row[col] : (row[colKey] !== undefined ? row[colKey] : '');
          
          const isDateColumn = col.toLowerCase().includes('ngày') || col.toLowerCase().includes('thời gian');

          if (isDateColumn) {
            value = formatDate(value);
          }
          
          td.textContent = value;
          if (col === "Mã đơn hàng") td.classList.add('fixed-column');
          
          if (editableCols.includes(col)) {
            td.classList.add('editable');
            
            if (isDateColumn) {
              const input = document.createElement('input');
              input.type = 'text';
              input.className = 'date-input';
              input.value = value;
              input.placeholder = 'dd/mm/yyyy';
              
              input.addEventListener('input', () => {
                td.classList.add('highlight');
                changedRows.add(rowIndex);
              });
              
              input.addEventListener('blur', () => {
                if (!/^\d{2}\/\d{2}\/\d{4}$/.test(input.value) && input.value !== '') {
                  alert('Vui lòng nhập ngày theo định dạng dd/mm/yyyy');
                  input.focus();
                }
              });
              
              td.innerHTML = '';
              td.appendChild(input);
            } else {
              td.contentEditable = 'true';
              td.addEventListener('input', () => {
                td.classList.add('highlight');
                changedRows.add(rowIndex);
              });
            }
          }
          tr.appendChild(td);
        });
        container.appendChild(tr);
      });
      setupPasteHandler();
    }

    function setupControls() {
      document.getElementById('refreshData').addEventListener('click', refreshData);
      document.getElementById('updateAll').addEventListener('click', updateAllChangedRows);
    }

    function refreshData() {
      const btn = document.getElementById('refreshData');
      btn.innerHTML = '<span class="loading"></span> Đang tải...';
      activeRegion = 'all';
      filterValues = {};
      document.getElementById('tabContainer').innerHTML = '';
      document.getElementById('filterRow').innerHTML = '';
      loadData();
    }

    function loadData() {
      const container = document.getElementById('tableBody');
      container.innerHTML = `<tr><td colspan="${displayColumns.length}" style="text-align: center; padding: 20px;">Đang tải dữ liệu...</td></tr>`;
      
      const script = document.createElement('script');
      script.src = `${POST_URL}?callback=handleData&rand=${Math.random()}`;
      
      const oldScript = document.querySelector('script[src^="https://script.google.com"]');
      if (oldScript) document.body.removeChild(oldScript);
      
      document.body.appendChild(script);
    }

    function updateAllChangedRows() {
      if (changedRows.size === 0) {
        alert('Không có thay đổi nào để cập nhật');
        return;
      }
      
      const statusEl = document.createElement('span');
      statusEl.className = 'status';
      document.getElementById('updateAll').appendChild(statusEl);
      
      sendRows(Array.from(changedRows), statusEl);
    }

    /**
     * CẢI TIẾN: Chỉ gửi các trường đã thực sự thay đổi (được highlight).
     * Điều này ngăn việc ghi đè dữ liệu không cần thiết lên các cột khác.
     */
    function sendRows(rowIndexes, statusEl) {
      statusEl.innerHTML = '<span class="loading"></span> Đang gửi...';
      const rowsToSend = [];
      const tableBody = document.querySelector('tbody');
      
      rowIndexes.forEach(rowIndex => {
        const originalRowData = filteredData[rowIndex];
        if (!originalRowData) return;
        const domRow = tableBody.rows[rowIndex];
        if (!domRow) return;

        // Bắt đầu với một payload chỉ chứa mã định danh.
        const payloadForRow = {
            "Mã đơn hàng": originalRowData["Mã đơn hàng"]
        };
        let hasActualChanges = false;

        // Lặp qua các ô trong hàng để tìm các ô đã được thay đổi (có class 'highlight').
        Array.from(domRow.cells).forEach((cell, colIndex) => {
            if (cell.classList.contains('highlight')) {
                const colName = displayColumns[colIndex];
                let value;
                const isDateColumn = colName.toLowerCase().includes('ngày') || colName.toLowerCase().includes('thời gian');

                if (isDateColumn && cell.querySelector('input')) {
                    value = cell.querySelector('input').value.trim();
                    // Chỉ chuyển đổi nếu có giá trị, nếu không gửi chuỗi rỗng.
                    value = value ? parseDateToISO(value) : '';
                } else {
                    value = cell.textContent.trim();
                }

                // Chỉ thêm trường đã thay đổi vào payload.
                payloadForRow[colName] = value;
                hasActualChanges = true;
            }
        });

        // Chỉ thêm vào danh sách gửi nếu có ít nhất một thay đổi thực sự.
        if (hasActualChanges) {
            rowsToSend.push(payloadForRow);
        }
      });

      // Nếu không có thay đổi thực tế nào (ví dụ: người dùng sửa rồi xóa), không gửi request.
      if (rowsToSend.length === 0) {
        statusEl.textContent = 'Không có thay đổi để gửi.';
        setTimeout(() => { statusEl.remove(); }, 3000);
        // Xóa highlight khỏi giao diện và xóa tập hợp hàng đã thay đổi.
        document.querySelectorAll('td.highlight').forEach(td => td.classList.remove('highlight'));
        changedRows.clear();
        return;
      }
      
      fetch(POST_URL, {
        method: 'POST', 
        mode: 'cors', 
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ rows: JSON.stringify(rowsToSend) })
      })
      .then(r => r.json())
      .then(json => {
        if (json.message) {
          statusEl.textContent = `Thành công: ${json.message}`;
          // Xóa highlight khỏi các hàng đã được cập nhật thành công.
          rowIndexes.forEach(rowIndex => {
              const domRow = tableBody.rows[rowIndex];
              if (domRow) {
                  domRow.querySelectorAll('.highlight').forEach(cell => cell.classList.remove('highlight'));
              }
          });
          changedRows.clear(); // Xóa tất cả sau khi gửi thành công.
        } else {
          statusEl.textContent = json.error || 'Cập nhật không thành công';
          statusEl.classList.add('error-status');
        }
        setTimeout(() => { statusEl.remove(); }, 4000);
      })
      .catch(e => {
        statusEl.textContent = 'Lỗi: ' + e.message;
        statusEl.classList.add('error-status');
        setTimeout(() => { statusEl.remove(); }, 4000);
      });
    }

    function setupPasteHandler() {
      document.addEventListener('paste', (e) => {
        const activeElement = document.activeElement;
        const isEditableCell = activeElement.classList.contains('editable') || (activeElement.tagName === 'INPUT' && activeElement.parentElement.classList.contains('editable'));
        if (!isEditableCell) return;

        e.preventDefault();
        const pasteData = e.clipboardData.getData('text/plain');
        if (!pasteData) return;

        const rows = pasteData.split('\n').map(row => row.split('\t'));
        const tableBody = document.querySelector('tbody');
        if (!tableBody) return;

        let startCell = activeElement;
        if (activeElement.tagName === 'INPUT') {
            startCell = activeElement.parentElement;
        }

        // rowIndex trong tbody, không tính thead.
        const startRowIndex = Array.from(tableBody.rows).findIndex(row => row.contains(startCell));
        const startColIndex = startCell.cellIndex;

        for (let i = 0; i < rows.length; i++) {
          const rowIndex = startRowIndex + i;
          if (rowIndex >= tableBody.rows.length) break;
          const rowData = rows[i];

          for (let j = 0; j < rowData.length; j++) {
            const colIndex = startColIndex + j;
            if (colIndex >= tableBody.rows[rowIndex].cells.length) break;
            const cell = tableBody.rows[rowIndex].cells[colIndex];

            if (cell.classList.contains('editable')) {
              const input = cell.querySelector('input.date-input');
              if (input) {
                input.value = rowData[j];
              } else {
                cell.textContent = rowData[j];
              }
              cell.classList.add('highlight');
              changedRows.add(rowIndex);
            }
          }
        }
      });
    }

    setupControls();
  </script>

  <script src="https://script.google.com/macros/s/AKfycbx2sX3QXh2ltziVv2jXwjN4VnQxBGhLNALK2QjT6PSuq7RSuwzWa2MuHsbOe6dd9DnW/exec?callback=handleData"></script>
</body>
</html>

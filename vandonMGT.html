<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Quản lý đơn hàng MGT</title>
  <!-- Thêm thư viện MGT -->
  <script src="https://unpkg.com/@microsoft/mgt@2/dist/bundle/mgt-loader.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      background-color: #f5f5f5;
      color: #333;
      margin: 0;
    }
    
    h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #2c3e50;
    }
    
    .container {
      max-width: 95%;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 20px;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #e1e1e1;
    }
    
    .controls {
      display: flex;
      gap: 10px;
    }
    
    .tab-container {
      display: flex;
      gap: 8px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    
    .highlight {
      background-color: #ffeb3b;
    }
    
    .no-data {
      text-align: center;
      padding: 20px;
      color: #7f8c8d;
      font-style: italic;
    }
    
    .error-status {
      color: #e74c3c;
    }
    
    .status {
      font-size: 0.85em;
      margin-left: 8px;
      color: #27ae60;
    }
    
    .editable {
      background-color: #fffbe8;
    }
    
    .refresh-icon {
      margin-right: 5px;
    }
  </style>
</head>
<body>
  <h2>QUẢN LÝ ĐƠN HÀNG BEE</h2>

  <div class="container">
    <div class="header">
      <mgt-tabs class="tab-container" id="tabContainer">
        <!-- Các tab sẽ được tạo động -->
      </mgt-tabs>
      
      <div class="controls">
        <mgt-button id="refreshData" class="refresh-btn">
          <span class="refresh-icon">↻</span> Load dữ liệu
        </mgt-button>
        <mgt-button id="updateAll">Cập nhật tất cả thay đổi</mgt-button>
      </div>
    </div>
    
    <mgt-agenda id="orderGrid" group-by-day="false" show-max="1000" style="--agenda-header-font-size: 14px;">
      <template data-type="event">
        <!-- Template tùy chỉnh cho mỗi đơn hàng -->
      </template>
      <template data-type="no-data">
        <div class="no-data">Không có dữ liệu đơn hàng nào</div>
      </template>
    </mgt-agenda>
  </div>

  <script>
    const POST_URL = 'https://script.google.com/macros/s/AKfycbzNeQSd_fUNicLT8VyVg90Di9NpAZxCagmBLFboJZ5I64qjqHBHM7uOZalO11mJdAxN/exec';
    
    const displayColumns = [
      "Mã đơn hàng", "Ngày lên đơn", "Name*", "Phone*", "Add", "City", "State", "Khu vực", "Zipcode", 
      "Mặt hàng", "Tên mặt hàng 1", "Số lượng mặt hàng 1", "Tên mặt hàng 2", "Số lượng mặt hàng 2", 
      "Quà tặng", "Số lượng quà kèm", "Giá bán", "Loại tiền thanh toán", "Tổng tiền VNĐ", 
      "Hình thức thanh toán", "Ghi chú", "Mã Tracking", "Ngày đóng hàng", "Trạng thái giao hàng", 
      "Thời gian giao dự kiến", "Phí ship nội địa Mỹ (usd)", "Phí xử lý đơn đóng hàng-Lưu kho(usd)", "GHI CHÚ"
    ];
    
    const editableCols = [
      "Mã Tracking", "Ngày đóng hàng", "Trạng thái giao hàng", 
      "Thời gian giao dự kiến", "Phí ship nội địa Mỹ (usd)", 
      "Phí xử lý đơn đóng hàng-Lưu kho(usd)", "GHI CHÚ"
    ];
    
    let allData = [];
    let initialFilteredData = []; 
    let filteredData = []; 
    let changedRows = new Set();
    let activeRegion = 'all';
    let filterValues = {};

    function formatDate(dateString) {
      if (!dateString) return '';
      try {
        const date = new Date(dateString.includes('Z') ? dateString : dateString + 'Z');
        if (isNaN(date.getTime())) return dateString;
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
      } catch (e) {
        return dateString;
      }
    }

    function parseDateToISO(dateString) {
      if (!dateString) return '';
      const parts = dateString.split('/');
      if (parts.length !== 3) return dateString;
      try {
        const day = parseInt(parts[0], 10);
        const month = parseInt(parts[1], 10) - 1;
        const year = parseInt(parts[2], 10);
        const date = new Date(year, month, day);
        if (isNaN(date.getTime())) return dateString;
        return date.toISOString();
      } catch (e) {
        return dateString;
      }
    }

    function handleData(response) {
      document.getElementById('refreshData').innerText = '↻ Load dữ liệu';
      allData = [];
      changedRows = new Set();
      
      if (response.error) {
        document.getElementById('orderGrid').innerHTML = `<div class="error-status">Lỗi: ${response.error}</div>`;
        return;
      }
      
      const data = response.rows || response.data || response;
      if (!Array.isArray(data) || data.length === 0) {
        document.getElementById('orderGrid').innerHTML = `<div class="no-data">Không có dữ liệu đơn hàng nào</div>`;
        return;
      }
      
      allData = data;
      filterInitialData();
      createTabs(initialFilteredData);
      renderGrid(filteredData);
    }
    
    function filterInitialData() {
        initialFilteredData = allData.filter(row => {
            const carrier = row["Đơn vị vận chuyển"] || row["Đơn_vị_vận_chuyển"];
            const trackingCode = row["Mã Tracking"] || row["Mã_Tracking"] || '';
            return carrier && carrier.toString().toUpperCase() === "BEE" && (!trackingCode || trackingCode.toString().trim() === '');
        });
        filteredData = [...initialFilteredData];
    }

    function createTabs(data) {
        const tabContainer = document.getElementById('tabContainer');
        tabContainer.innerHTML = '';
        
        const regions = [...new Set(data.map(row => row["Khu vực"]).filter(Boolean))].sort();

        const allTab = document.createElement('mgt-tab');
        allTab.innerText = 'Tất cả';
        allTab.value = 'all';
        allTab.addEventListener('click', () => {
            activeRegion = 'all';
            applyAllFilters();
        });
        tabContainer.appendChild(allTab);

        regions.forEach(region => {
            const tab = document.createElement('mgt-tab');
            tab.innerText = region;
            tab.value = region;
            tab.addEventListener('click', () => {
                activeRegion = region;
                applyAllFilters();
            });
            tabContainer.appendChild(tab);
        });
    }
    
    function renderGrid(data) {
      const grid = document.getElementById('orderGrid');
      grid.templateContext = { orders: data, displayColumns, editableCols };
      
      grid.templates.event = `
        <div class="order-item" style="padding: 15px; border-bottom: 1px solid #eee;">
          <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
            ${displayColumns.map(col => `
              <div>
                <strong>${col}:</strong>
                ${editableCols.includes(col) ? 
                  `<div contenteditable="true" class="editable" data-column="${col}" style="padding: 5px; border: 1px solid #ddd; border-radius: 4px; min-height: 20px;">{{order['${col}'] || ''}}</div>` : 
                  `<div>${col === 'Ngày lên đơn' || col === 'Ngày đóng hàng' ? '{{formatDate(order["' + col + '"])}}' : '{{order["' + col + '"] || ""}}'}</div>`
                }
              </div>
            `).join('')}
          </div>
        </div>
      `;
      
      // Thêm sự kiện cho các ô editable
      setTimeout(() => {
        document.querySelectorAll('.editable').forEach(el => {
          el.addEventListener('input', () => {
            const rowIndex = Array.from(el.closest('.order-item').parentElement.children).indexOf(el.closest('.order-item'));
            el.classList.add('highlight');
            changedRows.add(rowIndex);
          });
        });
      }, 500);
    }

    function applyAllFilters() {
        let dataToRender = [...initialFilteredData];

        if (activeRegion !== 'all') {
            dataToRender = dataToRender.filter(row => row["Khu vực"] === activeRegion);
        }

        const activeFilters = Object.entries(filterValues).filter(([col, val]) => val.trim() !== '');
        
        if (activeFilters.length > 0) {
            dataToRender = dataToRender.filter(row => {
                return activeFilters.every(([col, filterValue]) => {
                    const cellValue = row[col] !== undefined ? row[col] :
                                      row[col.replace(/ /g, '_')] !== undefined ? row[col.replace(/ /g, '_')] :
                                      '';
                    return String(cellValue).toLowerCase().includes(filterValue.toLowerCase());
                });
            });
        }
        
        filteredData = dataToRender;
        renderGrid(filteredData);
    }

    function setupControls() {
      document.getElementById('refreshData').addEventListener('click', refreshData);
      document.getElementById('updateAll').addEventListener('click', updateAllChangedRows);
    }

    function refreshData() {
      const btn = document.getElementById('refreshData');
      btn.innerHTML = '<span class="loading"></span> Đang tải...';
      activeRegion = 'all';
      filterValues = {};
      document.getElementById('tabContainer').innerHTML = '';
      loadData();
    }

    function loadData() {
      const container = document.getElementById('orderGrid');
      container.innerHTML = `<div style="text-align: center; padding: 20px;">Đang tải dữ liệu...</div>`;
      
      const script = document.createElement('script');
      script.src = 'https://script.google.com/macros/s/AKfycbwEd7eA6NAUMtbEpcEPJQWeX-zsJRE1mnTVVBD23NoKrnXYwOLvuNef2mIbJ7-NMNbe/exec?callback=handleData&rand=' + Math.random();
      
      const oldScript = document.querySelector('script[src^="https://script.google.com"]');
      if (oldScript) document.body.removeChild(oldScript);
      
      document.body.appendChild(script);
    }

    function updateAllChangedRows() {
      if (changedRows.size === 0) {
        alert('Không có thay đổi nào để cập nhật');
        return;
      }
      
      const statusEl = document.createElement('span');
      statusEl.className = 'status';
      document.getElementById('updateAll').appendChild(statusEl);
      
      sendRows(Array.from(changedRows), statusEl);
    }

    function sendRows(rowIndexes, statusEl) {
      statusEl.innerHTML = '<span class="loading"></span> Đang gửi...';
      const rowsToSend = [];
      const orderItems = document.querySelectorAll('.order-item');
      
      rowIndexes.forEach(rowIndex => {
        const originalRowData = filteredData[rowIndex];
        if (!originalRowData) return;
        const domRow = orderItems[rowIndex];
        if (!domRow) return;

        const updatedRowData = { ...originalRowData };
        displayColumns.forEach((col, colIndex) => {
            if (editableCols.includes(col)) {
                 const cell = domRow.querySelector(`[data-column="${col}"]`);
                 if (cell) {
                     updatedRowData[col] = cell.textContent.trim();
                     if (cell.classList.contains('highlight')) {
                        cell.classList.remove('highlight');
                     }
                 }
            }
        });
        rowsToSend.push(updatedRowData);
      });
      
      fetch(POST_URL, {
        method: 'POST', 
        mode: 'cors', 
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ rows: JSON.stringify(rowsToSend) })
      })
      .then(r => r.json())
      .then(json => {
        if (json.message) {
          statusEl.textContent = `Thành công: ${json.message}`;
          changedRows.clear();
        } else {
          statusEl.textContent = json.error || 'Cập nhật không thành công';
          statusEl.classList.add('error-status');
        }
        setTimeout(() => { statusEl.remove(); }, 4000);
      })
      .catch(e => {
        statusEl.textContent = 'Lỗi: ' + e.message;
        statusEl.classList.add('error-status');
        setTimeout(() => { statusEl.remove(); }, 4000);
      });
    }

    // Khởi tạo
    setupControls();
  </script>

  <script src="https://script.google.com/macros/s/AKfycbzNeQSd_fUNicLT8VyVg90Di9NpAZxCagmBLFboJZ5I64qjqHBHM7uOZalO11mJdAxN/exec?callback=handleData"></script>
</body>
</html>

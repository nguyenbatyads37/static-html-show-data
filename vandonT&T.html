<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Quản lý đơn hàng T&T</title>
  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --accent-color: #e74c3c;
      --light-color: #ecf0f1;
      --dark-color: #2c3e50;
      --success-color: #27ae60;
      --warning-color: #f39c12;
    }
    
    body {
      font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      background-color: #f9f9f9;
      color: var(--dark-color);
      margin: 0;
    }
    
    .tt-container {
      max-width: 95%;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 15px rgba(0,0,0,0.1);
      padding: 20px;
    }
    
    .tt-header {
      text-align: center;
      margin-bottom: 25px;
      color: var(--primary-color);
      position: relative;
    }
    
    .tt-header h2 {
      font-size: 24px;
      font-weight: 600;
      margin: 0;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--secondary-color);
      display: inline-block;
    }
    
    .tt-tab-container {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .tt-tab {
      padding: 8px 20px;
      cursor: pointer;
      background-color: var(--light-color);
      color: var(--dark-color);
      border: 1px solid #ddd;
      border-radius: 20px;
      font-size: 14px;
      transition: all 0.3s;
      font-weight: 500;
    }
    
    .tt-tab:hover {
      background-color: #e0e0e0;
    }
    
    .tt-tab.active {
      background-color: var(--secondary-color);
      color: white;
      border-color: var(--secondary-color);
      box-shadow: 0 2px 5px rgba(52, 152, 219, 0.3);
    }
    
    .tt-controls {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
      gap: 15px;
      flex-wrap: wrap;
    }
    
    .tt-btn {
      padding: 8px 20px;
      cursor: pointer;
      background-color: var(--secondary-color);
      color: white;
      border: none;
      border-radius: 20px;
      font-size: 14px;
      transition: all 0.3s;
      font-weight: 500;
      min-width: 120px;
      text-align: center;
    }
    
    .tt-btn:hover {
      background-color: #2980b9;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .tt-btn:active {
      transform: translateY(0);
    }
    
    .tt-btn.refresh {
      background-color: var(--success-color);
    }
    
    .tt-btn.refresh:hover {
      background-color: #219653;
    }
    
    .tt-table-container {
      overflow-x: auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-top: 20px;
    }
    
    .tt-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 1600px;
    }
    
    .tt-table th {
      background-color: var(--primary-color);
      color: white;
      padding: 12px 15px;
      text-align: left;
      position: sticky;
      top: 0;
      font-weight: 500;
    }
    
    .tt-table td {
      padding: 10px 15px;
      border-bottom: 1px solid #eee;
      vertical-align: middle;
    }
    
    .tt-table tr:hover td {
      background-color: #f5f5f5;
    }
    
    .tt-editable {
      background-color: #fff8e1;
      border: 1px solid #ffe0b2;
      border-radius: 4px;
      padding: 5px 8px;
    }
    
    .tt-editable:focus {
      outline: none;
      border-color: var(--secondary-color);
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    }
    
    .tt-highlight {
      background-color: #fff3bf;
    }
    
    .tt-status {
      font-size: 13px;
      margin-left: 10px;
      color: var(--success-color);
    }
    
    .tt-error {
      color: var(--accent-color);
    }
    
    .tt-no-data {
      text-align: center;
      padding: 30px;
      color: #7f8c8d;
      font-style: italic;
    }
    
    .tt-fixed-col {
      position: sticky;
      left: 0;
      z-index: 2;
      background-color: white;
      box-shadow: 2px 0 5px rgba(0,0,0,0.05);
    }
    
    .tt-date-input {
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 5px 8px;
      width: 100px;
      font-family: inherit;
    }
    
    .tt-refresh-icon {
      margin-right: 5px;
      display: inline-block;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .tt-loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
      margin-right: 5px;
    }
  </style>
</head>
<body>
  <div class="tt-container">
    <div class="tt-header">
      <h2>QUẢN LÝ ĐƠN HÀNG T&T</h2>
    </div>

    <div id="tabContainer" class="tt-tab-container">
      <!-- Các tab sẽ được tạo động -->
    </div>
    
    <div class="tt-controls">
      <button id="refreshData" class="tt-btn refresh">
        <span class="tt-refresh-icon">↻</span> Load dữ liệu
      </button>
      <button id="updateAll" class="tt-btn">Cập nhật thay đổi</button>
    </div>
    
    <div class="tt-table-container">
      <table class="tt-table">
        <thead>
          <tr id="filterRow">
            <!-- Các ô lọc sẽ được tạo động -->
          </tr>
          <tr>
            <th class="tt-fixed-col">Mã đơn hàng</th>
            <th>Ngày lên đơn</th>
            <th>Name*</th>
            <th>Phone*</th>
            <th>Add</th>
            <th>City</th>
            <th>State</th>
            <th>Khu vực</th>
            <th>Zipcode</th>
            <th>Mặt hàng</th>
            <th>Tên mặt hàng 1</th>
            <th>Số lượng mặt hàng 1</th>
            <th>Tên mặt hàng 2</th>
            <th>Số lượng mặt hàng 2</th>
            <th>Quà tặng</th>
            <th>Số lượng quà kèm</th>
            <th>Giá bán</th>
            <th>Loại tiền thanh toán</th>
            <th>Tổng tiền VNĐ</th>
            <th>Hình thức thanh toán</th>
            <th>Ghi chú</th>
            <th>Mã Tracking</th>
            <th>Ngày đóng hàng</th>
            <th>Trạng thái giao hàng</th>
            <th>Thời gian giao dự kiến</th>
            <th>Phí ship nội địa Mỹ (usd)</th>
            <th>Phí xử lý đơn đóng hàng-Lưu kho(usd)</th>
            <th>GHI CHÚ</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <!-- Dữ liệu sẽ được thêm vào đây -->
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const POST_URL = 'https://script.google.com/macros/s/AKfycbzNeQSd_fUNicLT8VyVg90Di9NpAZxCagmBLFboJZ5I64qjqHBHM7uOZalO11mJdAxN/exec';
    
    const displayColumns = [
      "Mã đơn hàng", "Ngày lên đơn", "Name*", "Phone*", "Add", "City", "State", "Khu vực", "Zipcode", 
      "Mặt hàng", "Tên mặt hàng 1", "Số lượng mặt hàng 1", "Tên mặt hàng 2", "Số lượng mặt hàng 2", 
      "Quà tặng", "Số lượng quà kèm", "Giá bán", "Loại tiền thanh toán", "Tổng tiền VNĐ", 
      "Hình thức thanh toán", "Ghi chú", "Mã Tracking", "Ngày đóng hàng", "Trạng thái giao hàng", 
      "Thời gian giao dự kiến", "Phí ship nội địa Mỹ (usd)", "Phí xử lý đơn đóng hàng-Lưu kho(usd)", "GHI CHÚ"
    ];
    
    const editableCols = [
      "Mã Tracking", "Ngày đóng hàng", "Trạng thái giao hàng", 
      "Thời gian giao dự kiến", "Phí ship nội địa Mỹ (usd)", 
      "Phí xử lý đơn đóng hàng-Lưu kho(usd)", "GHI CHÚ"
    ];
    
    let allData = [];
    let initialFilteredData = []; 
    let filteredData = []; 
    let changedRows = new Set();
    let activeRegion = 'all';
    let filterValues = {};

    function formatDate(dateString) {
      if (!dateString) return '';
      try {
        const date = new Date(dateString.includes('Z') ? dateString : dateString + 'Z');
        if (isNaN(date.getTime())) return dateString;
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
      } catch (e) {
        return dateString;
      }
    }

    function parseDateToISO(dateString) {
      if (!dateString) return '';
      const parts = dateString.split('/');
      if (parts.length !== 3) return dateString;
      try {
        const day = parseInt(parts[0], 10);
        const month = parseInt(parts[1], 10) - 1;
        const year = parseInt(parts[2], 10);
        const date = new Date(year, month, day);
        if (isNaN(date.getTime())) return dateString;
        return date.toISOString();
      } catch (e) {
        return dateString;
      }
    }

    function handleData(response) {
      document.getElementById('refreshData').innerHTML = '<span class="tt-refresh-icon">↻</span> Load dữ liệu';
      allData = [];
      changedRows = new Set();
      
      if (response.error) {
        document.getElementById('tableBody').innerHTML = `<tr><td colspan="${displayColumns.length}" class="tt-error">Lỗi: ${response.error}</td></tr>`;
        return;
      }
      
      const data = response.rows || response.data || response;
      if (!Array.isArray(data) || data.length === 0) {
        document.getElementById('tableBody').innerHTML = `<tr><td colspan="${displayColumns.length}" class="tt-no-data">Không có dữ liệu đơn hàng nào</td></tr>`;
        return;
      }
      
      allData = data;
      filterInitialData();
      createTabs(initialFilteredData);
      setupColumnFilters();
      applyAllFilters();
    }
    
    function filterInitialData() {
        initialFilteredData = allData.filter(row => {
            const carrier = row["Đơn vị vận chuyển"] || row["Đơn_vị_vận_chuyển"];
            const trackingCode = row["Mã Tracking"] || row["Mã_Tracking"] || '';
            return carrier && carrier.toString().toUpperCase() === "BEE" && (!trackingCode || trackingCode.toString().trim() === '');
        });
    }

    function createTabs(data) {
        const tabContainer = document.getElementById('tabContainer');
        tabContainer.innerHTML = '';
        
        const regions = [...new Set(data.map(row => row["Khu vực"]).filter(Boolean))].sort();

        const createTab = (name, value) => {
            const button = document.createElement('button');
            button.className = 'tt-tab';
            button.textContent = name;
            button.dataset.region = value;
            if (value === activeRegion) {
                button.classList.add('active');
            }
            button.addEventListener('click', () => {
                activeRegion = value;
                document.querySelectorAll('.tt-tab').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                applyAllFilters();
            });
            return button;
        };

        tabContainer.appendChild(createTab('Tất cả', 'all'));
        regions.forEach(region => tabContainer.appendChild(createTab(region, region)));
    }
    
    function setupColumnFilters() {
        const filterRow = document.getElementById('filterRow');
        filterRow.innerHTML = '';
        filterValues = {};

        displayColumns.forEach((col, index) => {
            const th = document.createElement('th');
            if (index === 0) {
                th.classList.add('tt-fixed-col');
            }
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'tt-editable';
            input.placeholder = `Lọc ${col}`;
            input.dataset.column = col;
            
            input.addEventListener('input', () => {
                filterValues[col] = input.value;
                applyAllFilters();
            });

            th.appendChild(input);
            filterRow.appendChild(th);
        });
    }

    function applyAllFilters() {
        let dataToRender = [...initialFilteredData];

        if (activeRegion !== 'all') {
            dataToRender = dataToRender.filter(row => row["Khu vực"] === activeRegion);
        }

        const activeFilters = Object.entries(filterValues).filter(([col, val]) => val.trim() !== '');
        
        if (activeFilters.length > 0) {
            dataToRender = dataToRender.filter(row => {
                return activeFilters.every(([col, filterValue]) => {
                    const cellValue = row[col] !== undefined ? row[col] :
                                      row[col.replace(/ /g, '_')] !== undefined ? row[col.replace(/ /g, '_')] :
                                      '';
                    return String(cellValue).toLowerCase().includes(filterValue.toLowerCase());
                });
            });
        }
        
        filteredData = dataToRender;
        renderTable(filteredData);
    }

    function renderTable(data) {
      const container = document.getElementById('tableBody');
      container.innerHTML = '';

      if (data.length === 0) {
        container.innerHTML = `<tr><td colspan="${displayColumns.length}" class="tt-no-data">Không có dữ liệu phù hợp với bộ lọc</td></tr>`;
        return;
      }

      data.forEach((row, rowIndex) => {
        const tr = document.createElement('tr');
        
        displayColumns.forEach((col, colIndex) => {
          const td = document.createElement('td');
          if (colIndex === 0) {
            td.classList.add('tt-fixed-col');
          }
          
          let value = row[col] !== undefined ? row[col] : row[col.replace(/ /g, '_')] !== undefined ? row[col.replace(/ /g, '_')] : '';
          
          if (col === "Ngày lên đơn" || col === "Ngày đóng hàng") {
            value = formatDate(value);
          }
          
          if (editableCols.includes(col)) {
            if (col === "Ngày đóng hàng") {
              const input = document.createElement('input');
              input.type = 'text';
              input.className = 'tt-date-input';
              input.value = value;
              input.placeholder = 'dd/mm/yyyy';
              
              input.addEventListener('input', () => {
                td.classList.add('tt-highlight');
                changedRows.add(rowIndex);
              });
              
              input.addEventListener('blur', () => {
                if (!/^\d{2}\/\d{2}\/\d{4}$/.test(input.value) && input.value !== '') {
                  alert('Vui lòng nhập ngày theo định dạng dd/mm/yyyy');
                  input.focus();
                }
              });
              
              td.appendChild(input);
            } else {
              td.textContent = value !== null && value !== undefined ? value : '';
              td.contentEditable = 'true';
              td.classList.add('tt-editable');
              
              td.addEventListener('input', () => {
                td.classList.add('tt-highlight');
                changedRows.add(rowIndex);
              });
            }
          } else {
            td.textContent = value !== null && value !== undefined ? value : '';
          }
          
          tr.appendChild(td);
        });
        container.appendChild(tr);
      });
      setupPasteHandler();
    }

    function setupControls() {
      document.getElementById('refreshData').addEventListener('click', refreshData);
      document.getElementById('updateAll').addEventListener('click', updateAllChangedRows);
    }

    function refreshData() {
      const btn = document.getElementById('refreshData');
      btn.innerHTML = '<span class="tt-loading"></span> Đang tải...';
      activeRegion = 'all';
      filterValues = {};
      document.getElementById('tabContainer').innerHTML = '';
      document.getElementById('filterRow').innerHTML = '';
      loadData();
    }

    function loadData() {
      const container = document.getElementById('tableBody');
      container.innerHTML = `<tr><td colspan="${displayColumns.length}" style="text-align: center; padding: 20px;">Đang tải dữ liệu...</td></tr>`;
      
      const script = document.createElement('script');
      script.src = 'https://script.google.com/macros/s/AKfycbwEd7eA6NAUMtbEpcEPJQWeX-zsJRE1mnTVVBD23NoKrnXYwOLvuNef2mIbJ7-NMNbe/exec?callback=handleData&rand=' + Math.random();
      
      const oldScript = document.querySelector('script[src^="https://script.google.com"]');
      if (oldScript) document.body.removeChild(oldScript);
      
      document.body.appendChild(script);
    }

    function updateAllChangedRows() {
      if (changedRows.size === 0) {
        alert('Không có thay đổi nào để cập nhật');
        return;
      }
      
      const statusEl = document.createElement('span');
      statusEl.className = 'tt-status';
      document.getElementById('updateAll').appendChild(statusEl);
      
      sendRows(Array.from(changedRows), statusEl);
    }

    function sendRows(rowIndexes, statusEl) {
      statusEl.innerHTML = '<span class="tt-loading"></span> Đang gửi...';
      const rowsToSend = [];
      const tableBody = document.querySelector('tbody');
      
      rowIndexes.forEach(rowIndex => {
        const originalRowData = filteredData[rowIndex];
        if (!originalRowData) return;
        const domRow = tableBody.rows[rowIndex];
        if (!domRow) return;

        const updatedRowData = { ...originalRowData };
        displayColumns.forEach((col, colIndex) => {
            if (editableCols.includes(col)) {
                 const cell = domRow.cells[colIndex];
                 let value;
                 if (col === "Ngày đóng hàng" && cell.querySelector('input')) {
                     value = cell.querySelector('input').value.trim();
                     value = parseDateToISO(value);
                 } else {
                     value = cell.textContent.trim();
                 }
                 updatedRowData[col] = value;
            }
        });
        rowsToSend.push(updatedRowData);
        Array.from(domRow.cells).forEach(cell => {
             if (cell.classList.contains('tt-highlight')) {
                cell.classList.remove('tt-highlight');
             }
        });
      });
      
      fetch(POST_URL, {
        method: 'POST', 
        mode: 'cors', 
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ rows: JSON.stringify(rowsToSend) })
      })
      .then(r => r.json())
      .then(json => {
        if (json.message) {
          statusEl.textContent = `Thành công: ${json.message}`;
          changedRows.clear();
        } else {
          statusEl.textContent = json.error || 'Cập nhật không thành công';
          statusEl.classList.add('tt-error');
        }
        setTimeout(() => { statusEl.remove(); }, 4000);
      })
      .catch(e => {
        statusEl.textContent = 'Lỗi: ' + e.message;
        statusEl.classList.add('tt-error');
        setTimeout(() => { statusEl.remove(); }, 4000);
      });
    }

    function setupPasteHandler() {
      document.addEventListener('paste', (e) => {
        const activeElement = document.activeElement;
        const isEditableCell = activeElement.classList.contains('tt-editable') || 
                              (activeElement.tagName === 'INPUT' && activeElement.parentElement.classList.contains('tt-editable'));
        if (!isEditableCell) return;

        e.preventDefault();
        const pasteData = e.clipboardData.getData('text/plain');
        if (!pasteData) return;

        const rows = pasteData.split('\n').map(row => row.split('\t'));
        const tableBody = document.querySelector('tbody');
        if (!tableBody) return;

        let startRow = Array.from(tableBody.rows).findIndex(row => 
          Array.from(row.cells).some(cell => cell === activeElement || cell.contains(activeElement))
        );
        let startCol = -1;
        if (startRow >= 0) {
          const cells = Array.from(tableBody.rows[startRow].cells);
          startCol = cells.findIndex(cell => cell === activeElement || cell.contains(activeElement));
        }
        if (startRow < 0 || startCol < 0) return;

        for (let i = 0; i < rows.length; i++) {
          const rowIndex = startRow + i;
          if (rowIndex >= tableBody.rows.length) break;
          const rowData = rows[i];
          for (let j = 0; j < rowData.length; j++) {
            const colIndex = startCol + j;
            if (colIndex >= tableBody.rows[rowIndex].cells.length) break;
            const cell = tableBody.rows[rowIndex].cells[colIndex];
            if (cell.classList.contains('tt-editable')) {
              if (displayColumns[colIndex] === "Ngày đóng hàng" && cell.querySelector('input')) {
                cell.querySelector('input').value = rowData[j];
              } else {
                cell.textContent = rowData[j];
              }
              cell.classList.add('tt-highlight');
              changedRows.add(rowIndex);
            }
          }
        }
      });
    }

    setupControls();
    loadData();
  </script>
</body>
</html>
